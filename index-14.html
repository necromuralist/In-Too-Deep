<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Studies in Deep Learning." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Neurotic Networking (old posts, page 14) | Neurotic Networking</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/index-14.html" rel="canonical">
<link href="index-15.html" rel="prev" type="text/html">
<link href="index-13.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="."><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/pos-tagging-accuracy-of-model/">POS Tagging: Accuracy of Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/pos-tagging-accuracy-of-model/" rel="bookmark"><time class="published dt-published" datetime="2020-11-30T20:18:45-08:00" itemprop="datePublished" title="2020-11-30 20:18">2020-11-30 20:18</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#org2618170">Predicting on a data set</a>
<ul>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#org86829b9">Imports</a></li>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#org89aee9e">Set Up</a>
<ul>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#org8956284">The Timer</a></li>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#org088047b">The Matrices</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#org65954c8">Middle</a>
<ul>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#org5c14def">Aliases</a></li>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#orge6c69b2">Redo Y</a></li>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#orgb437d31">Compute Accuraty</a></li>
</ul>
</li>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#org4410117">End</a>
<ul>
<li><a href="posts/nlp/pos-tagging-accuracy-of-model/#org57460dd">References</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org2618170">
<h2 id="org2618170">Predicting on a data set</h2>
<div class="outline-text-2" id="text-org2618170">
<p>Compute the accuracy of your prediction by comparing it with the true `y` labels.</p>
<ul class="org-ul">
<li>`pred` is a list of predicted POS tags corresponding to the words of the `test_corpus`.</li>
</ul>
</div>
<div class="outline-3" id="outline-container-org86829b9">
<h3 id="org86829b9">Imports</h3>
<div class="outline-text-3" id="text-org86829b9">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="c1"># this stuff</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.parts_of_speech</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">HiddenMarkov</span><span class="p">,</span> <span class="n">Matrices</span><span class="p">,</span> <span class="n">TheTrainer</span>

<span class="c1"># some other stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org89aee9e">
<h3 id="org89aee9e">Set Up</h3>
<div class="outline-text-3" id="text-org89aee9e"></div>
<div class="outline-4" id="outline-container-org8956284">
<h4 id="org8956284">The Timer</h4>
<div class="outline-text-4" id="text-org8956284">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org088047b">
<h4 id="org088047b">The Matrices</h4>
<div class="outline-text-4" id="text-org088047b">
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">TheTrainer</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">processed_training</span><span class="p">)</span>
    <span class="n">matrices</span> <span class="o">=</span> <span class="n">Matrices</span><span class="p">(</span><span class="n">transition_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">transition_counts</span><span class="p">,</span>
                        <span class="n">emission_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">emission_counts</span><span class="p">,</span>
                        <span class="n">words</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary_words</span><span class="p">,</span>
                        <span class="n">tag_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">HiddenMarkov</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">matrices</span><span class="p">)</span>
    <span class="n">model</span><span class="p">()</span>
</pre></div>
<pre class="example">
2020-11-30 20:41:51,497 graeae.timers.timer start: Started: 2020-11-30 20:41:51.497226
2020-11-30 20:43:32,311 graeae.timers.timer end: Ended: 2020-11-30 20:43:32.311608
2020-11-30 20:43:32,312 graeae.timers.timer end: Elapsed: 0:01:40.814382
</pre>
<p>These classes were defined in other posts:</p>
<ul class="org-ul">
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/">DataLoader</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/">TheTrainer</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/">Matrices</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/">Hidden Markov Model</a></li>
</ul>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org65954c8">
<h2 id="org65954c8">Middle</h2>
<div class="outline-text-2" id="text-org65954c8"></div>
<div class="outline-3" id="outline-container-org5c14def">
<h3 id="org5c14def">Aliases</h3>
<div class="outline-text-3" id="text-org5c14def">
<p>The original notebooks use a naming scheme that I don't really like so have to be aliased to make my stuff work with theirs.</p>
<div class="highlight">
<pre><span></span><span class="n">prep</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">test_words</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predictions</span>

<span class="n">raw</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">test_data_tuples</span>
<span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pair</span><span class="p">]</span>
<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
    <span class="n">raw</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"--n--"</span><span class="p">))</span>

<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'The third word is:'</span><span class="p">,</span> <span class="n">prep</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Your prediction is:'</span><span class="p">,</span> <span class="n">pred</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Your corresponding label y is: '</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">prep</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
</pre></div>
<pre class="example">
The third word is: temperature
Your prediction is: NN
Your corresponding label y is:  NN
</pre></div>
</div>
<div class="outline-3" id="outline-container-orge6c69b2">
<h3 id="orge6c69b2">Redo Y</h3>
<div class="outline-text-3" id="text-orge6c69b2">
<p>Now that I look at their code, they expect the "y" list to be the un-split strings. Ugh.</p>
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">test_data_raw</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Your corresponding label y is: '</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
<pre class="example">
Your corresponding label y is:  temperature     NN
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgb437d31">
<h3 id="orgb437d31">Compute Accuraty</h3>
<div class="outline-text-3" id="text-orgb437d31">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">compute_accuracy</span><span class="p">(</span><span class="n">predlist</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Calculate the accuracy of our model's predictions</span>

<span class="sd">    Args: </span>
<span class="sd">      pred: a list of the predicted parts-of-speech </span>
<span class="sd">      y: a list of lines where each word is separated by a '\t' (i.e. word \t tag)</span>
<span class="sd">    Returns: </span>
<span class="sd">      accuracy of the predictions</span>
<span class="sd">    """</span>
    <span class="n">num_correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Zip together the prediction and the labels</span>
    <span class="k">for</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>
        <span class="c1"># Split the label into the word and the POS tag</span>
        <span class="n">word_tag_tuple</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1"># Check that there is actually a word and a tag</span>
        <span class="c1"># no more and no less than 2 items</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_tag_tuple</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># complete this line</span>
            <span class="k">continue</span> 

        <span class="c1"># store the word and tag separately</span>
        <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">word_tag_tuple</span>

        <span class="c1"># Check if the POS tag label matches the prediction</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">prediction</span><span class="p">:</span> <span class="c1"># complete this line</span>

            <span class="c1"># count the number of times that the prediction</span>
            <span class="c1"># and label match</span>
            <span class="n">num_correct</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># keep track of the total number of examples (that have valid labels)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1">### END CODE HERE ###</span>
    <span class="k">return</span> <span class="n">num_correct</span><span class="o">/</span><span class="n">total</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">compute_accuracy</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Accuracy of the Viterbi algorithm is </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">accuracy</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
</pre></div>
<pre class="example">
Accuracy of the Viterbi algorithm is 0.9545
</pre>
<p><b>Note:</b> The original notebook accuracy was 0.9531. I don't really know what caused the difference - I suspect their preprocessing - but since this is better I'll keep it.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org4410117">
<h2 id="org4410117">End</h2>
<div class="outline-text-2" id="text-org4410117">
<p>So, there you go, parts-of-speech tagging.</p>
</div>
<div class="outline-3" id="outline-container-org57460dd">
<h3 id="org57460dd">References</h3>
<div class="outline-text-3" id="text-org57460dd">
<ul class="org-ul">
<li><a href="https://web.stanford.edu/~jurafsky/slp3/">"Speech and Language Processing", Dan Jurafsky and James H. Martin</a></li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/parts-of-speech-viterbi-algorithm/">Parts-of-Speech: Viterbi Algorithm</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/parts-of-speech-viterbi-algorithm/" rel="bookmark"><time class="published dt-published" datetime="2020-11-21T18:21:58-08:00" itemprop="datePublished" title="2020-11-21 18:21">2020-11-21 18:21</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org7ba4893">Beginning</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orga0cc9c0">Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org628b5ba">Set Up</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org74769b3">The Timer</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org8b3c4a3">The Matrices</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org917b6f8">Middle</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orgd9fd747">Initialization</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org1ec4357">Viterby Forward</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org7b30acf">Viterbi Backward</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org4eef1f1">End</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orga5ec293">Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orge715a3d">An Exception</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org4afc603">The Model Class</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org5890049">The States List</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orge6d1ef8">The Tag Counts</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org2b70cc3">Tag Count</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org403f065">Transition Matrix (A)</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org10c627e">Emission Matrix (B)</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orgcf942ed">Test Words</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org2ea023d">Test Word Count</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orgb789061">Vocabulary</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orgfc24a19">Start Token Index</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org439c123">Negative Infinity</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orgfb18472">Initialize the Matrices</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orgb33a566">Virterbi Forward</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org5b864e7">Viterbi Backward</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#orga3ad0da">Call It</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org90f79db">Test it out</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/#org9d3d154">Run The Methods In the correct order with a call</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org7ba4893">
<h2 id="org7ba4893">Beginning</h2>
<div class="outline-text-2" id="text-org7ba4893"></div>
<div class="outline-3" id="outline-container-orga0cc9c0">
<h3 id="orga0cc9c0">Imports</h3>
<div class="outline-text-3" id="text-orga0cc9c0">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">call</span><span class="p">,</span> <span class="n">MagicMock</span>

<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span><span class="n">equal</span><span class="p">,</span> <span class="n">expect</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="n">np</span> <span class="o">=</span> <span class="n">numpy</span>

<span class="c1"># this stuff</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.parts_of_speech</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Matrices</span><span class="p">,</span> <span class="n">TheTrainer</span>

<span class="c1"># my other stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org628b5ba">
<h3 id="org628b5ba">Set Up</h3>
<div class="outline-text-3" id="text-org628b5ba"></div>
<div class="outline-4" id="outline-container-org74769b3">
<h4 id="org74769b3">The Timer</h4>
<div class="outline-text-4" id="text-org74769b3">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8b3c4a3">
<h4 id="org8b3c4a3">The Matrices</h4>
<div class="outline-text-4" id="text-org8b3c4a3">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">TheTrainer</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">processed_training</span><span class="p">)</span>
<span class="n">matrices</span> <span class="o">=</span> <span class="n">Matrices</span><span class="p">(</span><span class="n">transition_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">transition_counts</span><span class="p">,</span>
                    <span class="n">emission_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">emission_counts</span><span class="p">,</span>
                    <span class="n">words</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary_words</span><span class="p">,</span>
                    <span class="n">tag_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>
<p>These classes were defined in other posts:</p>
<ul class="org-ul">
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/">DataLoader</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/">TheTrainer</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/">Matrices</a></li>
</ul>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org917b6f8">
<h2 id="org917b6f8">Middle</h2>
<div class="outline-text-2" id="text-org917b6f8"></div>
<div class="outline-3" id="outline-container-orgd9fd747">
<h3 id="orgd9fd747">Initialization</h3>
<div class="outline-text-3" id="text-orgd9fd747">
<p>Write a program below that initializes the <code>best_probs</code> and the <code>best_paths</code> matrix.</p>
<p>Both matrices will be initialized to zero except for column zero of <code>best_probs</code>.</p>
<ul class="org-ul">
<li>Column zero of <code>best_probs</code> is initialized with the assumption that the first word of the corpus was preceded by a start token ("–s–").</li>
<li>This allows you to reference the <b>A</b> matrix for the transition probability</li>
</ul>
<p>Here is how to initialize column 0 of <code>best_probs</code>:</p>
<ul class="org-ul">
<li>The probability of the best path going from the start index to a given POS tag indexed by integer <i>i</i> is denoted by \(\textrm{best_probs}[s_{idx}, i]\).</li>
<li>This is estimated as the probability that the start tag transitions to the POS denoted by index <i>i</i>: \(\mathbf{A}[s_{idx}, i]\) AND that the POS tag denoted by <i>i</i> emits the first word of the given corpus, which is \(\mathbf{B}[i, vocab[corpus[0]]]\).</li>
<li>Note that vocab[corpus[0]] refers to the first word of the corpus (the word at position 0 of the corpus).</li>
<li><b>vocab</b> is a dictionary that returns the unique integer that refers to that particular word.</li>
</ul>
<p>Conceptually, it looks like this:</p>
<p>\[ \textrm{best_probs}[s_{idx}, i] = \mathbf{A}[s_{idx}, i] \times \mathbf{B}[i, corpus[0] ] \]</p>
<p>In order to avoid multiplying and storing small values on the computer, we'll take the log of the product, which becomes the sum of two logs:</p>
<p>\[ best\_probs[i,0] = log(A[s_{idx}, i]) + log(B[i, vocab[corpus[0]] \]</p>
<p>Also, to avoid taking the log of 0 (which is defined as negative infinity), the code itself will just set \(best\_probs[i,0] = float('-inf')\) when \(A[s_{idx}, i] == 0\).</p>
<p>So the implementation to initialize <code>best_probs</code> looks like this:</p>
<p>\[ if A[s_{idx}, i] &lt;&gt; 0 : best\_probs[i,0] = log(A[s_{idx}, i]) + log(B[i, vocab[corpus[0]]]) \]</p>
<p>\[ if A[s_{idx}, i] == 0 : best\_probs[i,0] = float('-inf') \]</p>
<p>Please use <a href="https://docs.python.org/3/library/math.html">math.log</a> to compute the natural logarithm.</p>
<p>Represent infinity and negative infinity like this:</p>
<pre class="example">
float('inf')
float('-inf')
</pre>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">tag_counts</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">corpus</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
    <span class="sd">"""Initializes the ``best_probs`` and ``best_paths`` matrices</span>

<span class="sd">    Args: </span>
<span class="sd">       states: a list of all possible parts-of-speech</span>
<span class="sd">       tag_counts: a dictionary mapping each tag to its respective count</span>
<span class="sd">       A: Transition Matrix of dimension (num_tags, num_tags)</span>
<span class="sd">       B: Emission Matrix of dimension (num_tags, len(vocab))</span>
<span class="sd">       corpus: a sequence of words whose POS is to be identified in a list </span>
<span class="sd">       vocab: a dictionary where keys are words in vocabulary and value is an index</span>

<span class="sd">    Returns:</span>
<span class="sd">       best_probs: matrix of dimension (num_tags, len(corpus)) of floats</span>
<span class="sd">       best_paths: matrix of dimension (num_tags, len(corpus)) of integers</span>
<span class="sd">    """</span>
    <span class="c1"># Get the total number of unique POS tags</span>
    <span class="n">num_tags</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_counts</span><span class="p">)</span>

    <span class="c1"># Initialize best_probs matrix </span>
    <span class="c1"># POS tags in the rows, number of words in the corpus as the columns</span>
    <span class="n">best_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_tags</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)))</span>

    <span class="c1"># Initialize best_paths matrix</span>
    <span class="c1"># POS tags in the rows, number of words in the corpus as columns</span>
    <span class="n">best_paths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_tags</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Define the start token</span>
    <span class="n">s_idx</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">"--s--"</span><span class="p">)</span>
    <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>

    <span class="c1"># Go through each of the POS tags</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)):</span> <span class="c1"># complete this line</span>
        <span class="c1"># Handle the special case when the transition from start token to POS tag i is zero</span>
        <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">s_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># complete this line</span>

            <span class="c1"># Initialize best_probs at POS tag 'i', column 0, to negative infinity</span>
            <span class="n">best_probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"-inf"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: negitive infinity"</span><span class="p">)</span>

        <span class="c1"># For all other cases when transition from start token to POS tag i is non-zero:</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Initialize best_probs at POS tag 'i', column 0</span>
            <span class="c1"># Check the formula in the instructions above</span>
            <span class="n">best_probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">s_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">vocab</span><span class="p">[</span><span class="n">corpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="c1">### END CODE HERE ### </span>
    <span class="k">return</span> <span class="n">best_probs</span><span class="p">,</span> <span class="n">best_paths</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">states</span> <span class="o">=</span> <span class="n">matrices</span><span class="o">.</span><span class="n">tags</span>
<span class="n">tag_counts</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">matrices</span><span class="o">.</span><span class="n">transition</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">matrices</span><span class="o">.</span><span class="n">emission</span>
<span class="n">prep</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">test_words</span>
<span class="n">vocab</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span>
<span class="n">best_probs</span><span class="p">,</span> <span class="n">best_paths</span> <span class="o">=</span> <span class="n">initialize</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">tag_counts</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">prep</span><span class="p">,</span> <span class="n">vocab</span><span class="p">)</span>
</pre></div>
<p>Test the function</p>
<div class="highlight">
<pre><span></span><span class="n">actual</span> <span class="o">=</span> <span class="n">best_probs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="o">-</span><span class="mf">22.6098</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"best_probs[0,0]: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">),</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">best_paths</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.0000</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"best_paths[2,3]: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</pre></div>
<pre class="example">
best_probs[0,0]: -22.6099
best_paths[2,3]: 0.0000
</pre></div>
</div>
<div class="outline-3" id="outline-container-org1ec4357">
<h3 id="org1ec4357">Viterby Forward</h3>
<div class="outline-text-3" id="text-org1ec4357">
<p>In this part of the assignment, you will implement the <code>viterbi_forward</code> segment. In other words, you will populate your <code>best_probs</code> and <code>best_paths</code> matrices.</p>
<ul class="org-ul">
<li>Walk forward through the corpus.</li>
<li>For each word, compute a probability for each possible tag.</li>
<li>Unlike the previous algorithm <code>predict_pos</code> (the 'warm-up' exercise), this will include the path up to that (word,tag) combination.</li>
</ul>
<p>Here is an example with a three-word corpus "Loss tracks upward":</p>
<ul class="org-ul">
<li>Note, in this example, only a subset of states (POS tags) are shown in the diagram below, for easier reading.</li>
<li>In the diagram below, the first word "Loss" is already initialized.</li>
<li>The algorithm will compute a probability for each of the potential tags in the second and future words.</li>
</ul>
<p>Compute the probability that the tag of the second work ('tracks') is a verb, 3rd person singular present (VBZ).</p>
<ul class="org-ul">
<li>In the <code>best_probs</code> matrix, go to the column of the second word ('tracks'), and row 40 (VBZ), this cell is highlighted in light orange in the diagram below.</li>
<li>Examine each of the paths from the tags of the first word ('Loss') and choose the most likely path.</li>
<li>An example of the calculation for <b>one</b> of those paths is the path from ('Loss', NN) to ('tracks', VBZ).</li>
<li>The log of the probability of the path up to and including the first word 'Loss' having POS tag NN is <i>-14.32</i>. The <code>best_probs</code> matrix contains this value -14.32 in the column for 'Loss' and row for 'NN'.</li>
<li>Find the probability that NN transitions to VBZ. To find this probability, go to the <code>A</code> transition matrix, and go to the row for 'NN' and the column for 'VBZ'. The value is <i>4.37e-02</i>, which is circled in the diagram, so add \(-14.32 + \log(4.37e-02)\).</li>
<li>Find the log of the probability that the tag VBS would 'emit' the word 'tracks'. To find this, look at the 'B' emission matrix in row 'VBZ' and the column for the word 'tracks'. The value <i>4.61e-04</i> is circled in the diagram below. So add \(-14.32 + \log(4.37e-02) + \log(4.61e-04)\).</li>
<li>The sum of \(-14.32 + \log(4.37e-02) + \log(4.61e-04)\) is <i>-25.13</i>. Store <i>-25.13</i> in the <code>best_probs</code> matrix at row 'VBZ' and column 'tracks' (as seen in the cell that is highlighted in light orange in the diagram).</li>
<li>All other paths in best_probs are calculated. Notice that <i>-25.13</i> is greater than all of the other values in column 'tracks' of matrix <code>best_probs</code>, and so the most likely path to 'VBZ' is from 'NN'. 'NN' is in row 20 of the <code>best_probs</code> matrix, so <i>20</i> is the most likely path.</li>
<li>Store the most likely path <i>20</i> in the <code>best_paths</code> table. This is highlighted in light orange in the diagram below.</li>
</ul>
<p>The formula to compute the probability and path for the \(i^{th}\) word in the <i>corpus</i>, the prior word <i>i-1</i> in the corpus, current POS tag <i>j</i>, and previous POS tag <i>k</i> is:</p>
<p>\[ \mathrm{prob} = \mathbf{best\_prob}_{k, i-1} + \mathrm{log}(\mathbf{A}_{k, j}) + \mathrm{log}(\mathbf{B}_{j, vocab(corpus_{i})}) \]</p>
<p>where \(corpus_{i}\) is the word in the corpus at index <i>i</i>, and <i>vocab</i> is the dictionary that gets the unique integer that represents a given word.</p>
<p>\[ \mathrm{path} = k \]</p>
<p>where <i>k</i> is the integer representing the previous POS tag.</p>
<p>Implement the `viterbi_forward` algorithm and store the best_path and best_prob for every possible tag for each word in the matrices `best_probs` and `best_tags` using the pseudo code below.</p>
<pre class="example">

for each word in the corpus

    for each POS tag type that this word may be

        for POS tag type that the previous word could be

            compute the probability that the previous word had a given POS tag, that the current word has a given POS tag, and that the POS tag would emit this current word.

            retain the highest probability computed for the current word

            set best_probs to this highest probability

            set best_paths to the index 'k', representing the POS tag of the previous word which produced the highest probability `

</pre>
<p>Please use <a href="https://docs.python.org/3/library/math.html">math.log</a> to compute the natural logarithm.</p>
<ul class="org-ul">
<li>Remember that when accessing emission matrix B, the column index is the unique integer ID associated with the word. It can be accessed by using the 'vocab' dictionary, where the key is the word, and the value is the unique integer ID for that word.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">viterbi_forward</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">test_corpus</span><span class="p">,</span> <span class="n">best_probs</span><span class="p">,</span> <span class="n">best_paths</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
    <span class="sd">"""The forward training pass</span>

<span class="sd">    Args: </span>
<span class="sd">       A, B: The transition and emission matrices respectively</span>
<span class="sd">       test_corpus: a list containing a preprocessed corpus</span>
<span class="sd">       best_probs: an initilized matrix of dimension (num_tags, len(corpus))</span>
<span class="sd">       best_paths: an initilized matrix of dimension (num_tags, len(corpus))</span>
<span class="sd">       vocab: a dictionary where keys are words in vocabulary and value is an index </span>
<span class="sd">    Returns: </span>
<span class="sd">       best_probs: a completed matrix of dimension (num_tags, len(corpus))</span>
<span class="sd">       best_paths: a completed matrix of dimension (num_tags, len(corpus))</span>
<span class="sd">    """</span>
    <span class="c1"># Get the number of unique POS tags (which is the num of rows in best_probs)</span>
    <span class="n">num_tags</span> <span class="o">=</span> <span class="n">best_probs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Go through every word in the corpus starting from word 1</span>
    <span class="c1"># Recall that word 0 was initialized in `initialize()`</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_corpus</span><span class="p">)):</span> 

        <span class="c1"># Print number of words processed, every 5000 words</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">5000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Words processed: </span><span class="si">{:&gt;8}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="c1">### START CODE HERE (Replace instances of 'None' with your code EXCEPT the first 'best_path_i = None') ###</span>
        <span class="c1"># For each unique POS tag that the current word can be</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tags</span><span class="p">):</span> <span class="c1"># complete this line</span>

            <span class="c1"># Initialize best_prob for word i to negative infinity</span>
            <span class="n">best_prob_i</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"-inf"</span><span class="p">)</span>

            <span class="c1"># Initialize best_path for current word i to None</span>
            <span class="n">best_path_i</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># For each POS tag that the previous word can be:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tags</span><span class="p">):</span> <span class="c1"># complete this line</span>

                <span class="c1"># Calculate the probability = </span>
                <span class="c1"># best probs of POS tag k, previous word i-1 + </span>
                <span class="c1"># log(prob of transition from POS k to POS j) + </span>
                <span class="c1"># log(prob that emission of POS j is word i)</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="n">best_probs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">vocab</span><span class="p">[</span><span class="n">test_corpus</span><span class="p">[</span><span class="n">i</span><span class="p">]]])</span>

                <span class="c1"># check if this path's probability is greater than</span>
                <span class="c1"># the best probability up to and before this point</span>
                <span class="k">if</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="n">best_prob_i</span><span class="p">:</span> <span class="c1"># complete this line</span>

                    <span class="c1"># Keep track of the best probability</span>
                    <span class="n">best_prob_i</span> <span class="o">=</span> <span class="n">prob</span>

                    <span class="c1"># keep track of the POS tag of the previous word</span>
                    <span class="c1"># that is part of the best path.  </span>
                    <span class="c1"># Save the index (integer) associated with </span>
                    <span class="c1"># that previous word's POS tag</span>
                    <span class="n">best_path_i</span> <span class="o">=</span> <span class="n">k</span>

            <span class="c1"># Save the best probability for the </span>
            <span class="c1"># given current word's POS tag</span>
            <span class="c1"># and the position of the current word inside the corpus</span>
            <span class="n">best_probs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_prob_i</span>

            <span class="c1"># Save the unique integer ID of the previous POS tag</span>
            <span class="c1"># into best_paths matrix, for the POS tag of the current word</span>
            <span class="c1"># and the position of the current word inside the corpus.</span>
            <span class="n">best_paths</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_path_i</span>

        <span class="c1">### END CODE HERE ###</span>
    <span class="k">return</span> <span class="n">best_probs</span><span class="p">,</span> <span class="n">best_paths</span>
</pre></div>
<p>Run the <code>viterbi_forward</code> function to fill in the <code>best_probs</code> and <code>best_paths</code> matrices.</p>
<p><b>Note</b> that this will take a few minutes to run. There are about 30,000 words to process.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">best_probs</span><span class="p">,</span> <span class="n">best_paths</span> <span class="o">=</span> <span class="n">viterbi_forward</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span>
                                             <span class="n">prep</span><span class="p">,</span>
                                             <span class="n">best_probs</span><span class="p">,</span>
                                             <span class="n">best_paths</span><span class="p">,</span>
                                             <span class="n">vocab</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-11-30 19:35:42,383 graeae.timers.timer start: Started: 2020-11-30 19:35:42.383922
Words processed:     5000
Words processed:    10000
Words processed:    15000
Words processed:    20000
Words processed:    25000
Words processed:    30000
2020-11-30 19:37:56,143 graeae.timers.timer end: Ended: 2020-11-30 19:37:56.143551
2020-11-30 19:37:56,144 graeae.timers.timer end: Elapsed: 0:02:13.759629
</pre>
<div class="highlight">
<pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="o">-</span><span class="mf">24.7822</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">best_probs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"best_probs[0,1]: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">best_probs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="o">-</span><span class="mf">49.5601</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"best_probs[0,4]: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
<pre class="example">
best_probs[0,1]: -24.7822
best_probs[0,4]: -49.5602
</pre></div>
</div>
<div class="outline-3" id="outline-container-org7b30acf">
<h3 id="org7b30acf">Viterbi Backward</h3>
<div class="outline-text-3" id="text-org7b30acf">
<p>Now you will implement the Viterbi backward algorithm.</p>
<ul class="org-ul">
<li>The Viterbi backward algorithm gets the predictions of the POS tags for each word in the corpus using the <code>best_paths</code> and the <code>best_probs</code> matrices.</li>
</ul>
<p>The example below shows how to walk backwards through the best_paths matrix to get the POS tags of each word in the corpus. Recall that this example corpus has three words: "Loss tracks upward".</p>
<p>POS tag for 'upward' is <code>RB</code></p>
<ul class="org-ul">
<li>Select the the most likely POS tag for the last word in the corpus, 'upward' in the <code>best_prob</code> table.</li>
<li>Look for the row in the column for 'upward' that has the largest probability.</li>
<li>Notice that in row 28 of <code>best_probs</code>, the estimated probability is -34.99, which is larger than the other values in the column. So the most likely POS tag for 'upward' is <code>RB</code> an adverb, at row 28 of <code>best_prob</code>.</li>
<li>The variable <code>z</code> is an array that stores the unique integer ID of the predicted POS tags for each word in the corpus. In array z, at position 2, store the value 28 to indicate that the word 'upward' (at index 2 in the corpus), most likely has the POS tag associated with unique ID 28 (which is <code>RB</code>).</li>
<li>The variable <code>pred</code> contains the POS tags in string form. So <code>pred</code> at index 2 stores the string <code>RB</code>.</li>
</ul>
<p>POS tag for 'tracks' is <code>VBZ</code></p>
<ul class="org-ul">
<li>The next step is to go backward one word in the corpus ('tracks'). Since the most likely POS tag for 'upward' is <code>RB</code>, which is uniquely identified by integer ID 28, go to the <code>best_paths</code> matrix in column 2, row 28. The value stored in <code>best_paths</code>, column 2, row 28 indicates the unique ID of the POS tag of the previous word. In this case, the value stored here is 40, which is the unique ID for POS tag <code>VBZ</code> (verb, 3rd person singular present).</li>
<li>So the previous word at index 1 of the corpus ('tracks'), most likely has the POS tag with unique ID 40, which is <code>VBZ</code>.</li>
<li>In array <code>z</code>, store the value 40 at position 1, and for array <code>pred</code>, store the string <code>VBZ</code> to indicate that the word 'tracks' most likely has POS tag <code>VBZ</code>.</li>
</ul>
<p>POS tag for 'Loss' is <code>NN</code></p>
<ul class="org-ul">
<li>In <code>best_paths</code> at column 1, the unique ID stored at row 40 is 20. 20 is the unique ID for POS tag <code>NN</code>.</li>
<li>In array <code>z</code> at position 0, store 20. In array <code>pred</code> at position 0, store <code>NN</code>.</li>
</ul>
<p>Implement the <code>viterbi_backward</code> algorithm, which returns a list of predicted POS tags for each word in the corpus.</p>
<ul class="org-ul">
<li>Note that the numbering of the index positions starts at 0 and not 1.</li>
<li><code>m</code> is the number of words in the corpus.
<ul class="org-ul">
<li>So the indexing into the corpus goes from <code>0</code> to <code>m - 1</code>.</li>
<li>Also, the columns in <code>best_probs</code> and <code>best_paths</code> are indexed from <code>0</code> to <code>m - 1</code></li>
</ul>
</li>
</ul>
<p><b>In Step 1:</b> Loop through all the rows (POS tags) in the last entry of `best_probs` and find the row (POS tag) with the maximum value. Convert the unique integer ID to a tag (a string representation) using the list `states`.</p>
<p>Referring to the three-word corpus described above:</p>
<ul class="org-ul">
<li>`z[2] = 28`: For the word 'upward' at position 2 in the corpus, the POS tag ID is 28. Store 28 in `z` at position 2.</li>
<li>`states[28]` is 'RB': The POS tag ID 28 refers to the POS tag 'RB'.</li>
<li>`pred[2] = 'RB'`: In array `pred`, store the POS tag for the word 'upward'.</li>
</ul>
<p><b>In Step 2:</b></p>
<ul class="org-ul">
<li>Starting at the last column of best_paths, use `best_probs` to find the most likely POS tag for the last word in the corpus.</li>
<li>Then use `best_paths` to find the most likely POS tag for the previous word.</li>
<li>Update the POS tag for each word in `z` and in `preds`.</li>
</ul>
<p>Referring to the three-word example from above, read best_paths at column 2 and fill in z at position 1. `z[1] = best_paths[z[2],2]`</p>
<p>The small test following the routine prints the last few words of the corpus and their states to aid in debug.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">viterbi_backward</span><span class="p">(</span><span class="n">best_probs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">best_paths</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">corpus</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                     <span class="n">states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    This function returns the best path.</span>
<span class="sd">    """</span>
    <span class="c1"># Get the number of words in the corpus</span>
    <span class="c1"># which is also the number of columns in best_probs, best_paths</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">best_paths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 

    <span class="c1"># Initialize array z, same length as the corpus</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span>

    <span class="c1"># Get the number of unique POS tags</span>
    <span class="n">num_tags</span> <span class="o">=</span> <span class="n">best_probs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Initialize the best probability for the last word</span>
    <span class="n">best_prob_for_last_word</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'-inf'</span><span class="p">)</span>

    <span class="c1"># Initialize pred array, same length as corpus</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span>

    <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>
    <span class="c1">## Step 1 ##</span>

    <span class="c1"># Go through each POS tag for the last word (last column of best_probs)</span>
    <span class="c1"># in order to find the row (POS tag integer ID) </span>
    <span class="c1"># with highest probability for the last word</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tags</span><span class="p">):</span> <span class="c1"># complete this line</span>

        <span class="c1"># If the probability of POS tag at row k </span>
        <span class="c1"># is better than the previously best probability for the last word:</span>
        <span class="k">if</span> <span class="n">best_probs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_prob_for_last_word</span><span class="p">:</span> <span class="c1"># complete this line</span>

            <span class="c1"># Store the new best probability for the lsat word</span>
            <span class="n">best_prob_for_last_word</span> <span class="o">=</span> <span class="n">best_probs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Store the unique integer ID of the POS tag</span>
            <span class="c1"># which is also the row number in best_probs</span>
            <span class="n">z</span><span class="p">[</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>

    <span class="c1"># Convert the last word's predicted POS tag</span>
    <span class="c1"># from its unique integer ID into the string representation</span>
    <span class="c1"># using the 'states' dictionary</span>
    <span class="c1"># store this in the 'pred' array for the last word</span>
    <span class="n">pred</span><span class="p">[</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>

    <span class="c1">## Step 2 ##</span>
    <span class="c1"># Find the best POS tags by walking backward through the best_paths</span>
    <span class="c1"># From the last word in the corpus to the 0th word in the corpus</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># complete this line</span>

        <span class="c1"># Retrieve the unique integer ID of</span>
        <span class="c1"># the POS tag for the word at position 'i' in the corpus</span>
        <span class="n">pos_tag_for_word_i</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># In best_paths, go to the row representing the POS tag of word i</span>
        <span class="c1"># and the column representing the word's position in the corpus</span>
        <span class="c1"># to retrieve the predicted POS for the word at position i-1 in the corpus</span>
        <span class="n">z</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_paths</span><span class="p">[</span><span class="n">pos_tag_for_word_i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

        <span class="c1"># Get the previous word's POS tag in string form</span>
        <span class="c1"># Use the 'states' dictionary, </span>
        <span class="c1"># where the key is the unique integer ID of the POS tag,</span>
        <span class="c1"># and the value is the string representation of that POS tag</span>
        <span class="n">pred</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>

     <span class="c1">### END CODE HERE ###</span>
    <span class="k">return</span> <span class="n">pred</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">states</span> <span class="o">=</span> <span class="n">matrices</span><span class="o">.</span><span class="n">tags</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">viterbi_backward</span><span class="p">(</span><span class="n">best_probs</span><span class="p">,</span> <span class="n">best_paths</span><span class="p">,</span> <span class="n">corpus</span><span class="o">=</span><span class="n">prep</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
<span class="n">m</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
<span class="n">actual_prep</span> <span class="o">=</span> <span class="n">prep</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">:</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">actual_pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">:</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">expected_prep</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">'see'</span><span class="p">,</span> <span class="s1">'them'</span><span class="p">,</span> <span class="s1">'here'</span><span class="p">,</span> <span class="s1">'with'</span><span class="p">,</span> <span class="s1">'us'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">]</span>  
<span class="nb">print</span><span class="p">(</span><span class="s1">'The prediction for pred[-7:m-1] is: </span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="n">actual_prep</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">actual_pred</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'The prediction for pred[0:7] is: </span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">prep</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
</pre></div>
<pre class="example">
The prediction for pred[-7:m-1] is: 
 ['them', 'here', 'with', 'us', '.', '--n--'] 
 ['PRP', 'RB', 'IN', 'PRP', '.', '--s--'] 

The prediction for pred[0:8] is: 
 ['DT', 'NN', 'POS', 'NN', 'MD', 'VB', 'VBN'] 
 ['The', 'economy', "'s", 'temperature', 'will', 'be', 'taken']
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org4eef1f1">
<h2 id="org4eef1f1">End</h2>
<div class="outline-text-2" id="text-org4eef1f1">
<p>Bundle it up.</p>
<div class="highlight">
<pre><span></span><span class="o">&lt;&lt;</span><span class="n">hidden</span><span class="o">-</span><span class="n">markov</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">exception</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">hidden</span><span class="o">-</span><span class="n">markov</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">states</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">tag</span><span class="o">-</span><span class="n">counts</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">tag</span><span class="o">-</span><span class="n">count</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">transition</span><span class="o">-</span><span class="n">matrix</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">emission</span><span class="o">-</span><span class="n">matrix</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">words</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">word</span><span class="o">-</span><span class="n">count</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">vocabulary</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">start</span><span class="o">-</span><span class="n">token</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">negative</span><span class="o">-</span><span class="n">infinity</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">initialize</span><span class="o">-</span><span class="n">matrices</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">viterbi</span><span class="o">-</span><span class="n">forward</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">viterbi</span><span class="o">-</span><span class="n">backward</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">call</span><span class="o">-</span><span class="n">it</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orga5ec293">
<h3 id="orga5ec293">Imports</h3>
<div class="outline-text-3" id="text-orga5ec293">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">.preprocessing</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">.training</span> <span class="kn">import</span> <span class="n">TheTrainer</span>
<span class="kn">from</span> <span class="nn">.matrices</span> <span class="kn">import</span> <span class="n">Matrices</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orge715a3d">
<h3 id="orge715a3d">An Exception</h3>
<div class="outline-text-3" id="text-orge715a3d">
<p>This is so that if the viterbi is called out of order things will break.</p>
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">AlgorithmError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">"""Called when the methods are called out of order"""</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org4afc603">
<h3 id="org4afc603">The Model Class</h3>
<div class="outline-text-3" id="text-org4afc603">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HiddenMarkov</span><span class="p">:</span>
    <span class="sd">"""A Hidden Markov Model Class</span>

<span class="sd">    Args:</span>
<span class="sd">     loader: a DataLoader</span>
<span class="sd">     trainer: A TheTrainer object</span>
<span class="sd">     matrices: A Matrices object</span>
<span class="sd">    """</span>
    <span class="n">loader</span><span class="p">:</span> <span class="n">DataLoader</span>
    <span class="n">trainer</span><span class="p">:</span> <span class="n">TheTrainer</span>
    <span class="n">matrices</span><span class="p">:</span> <span class="n">Matrices</span>
    <span class="n">best_probabilities</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">best_paths</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_states</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tag_counts</span><span class="p">:</span> <span class="n">Counter</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tag_count</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_transition_matrix</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_emission_matrix</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_test_words</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_test_word_count</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_start_token_index</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negative_infinity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org5890049">
<h4 id="org5890049">The States List</h4>
<div class="outline-text-4" id="text-org5890049">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""POS Tags representing nodes in the HMM graph</span>

<span class="sd">    Returns:</span>
<span class="sd">     list of POS tags found in the training set</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="o">.</span><span class="n">tags</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge6d1ef8">
<h4 id="orge6d1ef8">The Tag Counts</h4>
<div class="outline-text-4" id="text-orge6d1ef8">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tag_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Counter</span><span class="p">:</span>
    <span class="sd">"""The number of times a POS tag was in the training set</span>

<span class="sd">    Returns:</span>
<span class="sd">     dict-like of POS: Count</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag_counts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag_counts</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2b70cc3">
<h4 id="org2b70cc3">Tag Count</h4>
<div class="outline-text-4" id="text-org2b70cc3">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tag_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""The Number of tags in the corpus"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag_count</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org403f065">
<h4 id="org403f065">Transition Matrix (A)</h4>
<div class="outline-text-4" id="text-org403f065">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">transition_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""The 'A' Matrix with the transitions"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transition_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transition_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="o">.</span><span class="n">transition</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transition_matrix</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org10c627e">
<h4 id="org10c627e">Emission Matrix (B)</h4>
<div class="outline-text-4" id="text-org10c627e">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">emission_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""The Emission matrix (B)"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emission_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="o">.</span><span class="n">emission</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission_matrix</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgcf942ed">
<h4 id="orgcf942ed">Test Words</h4>
<div class="outline-text-4" id="text-orgcf942ed">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">test_words</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The preprocessed test-words"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_words</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">test_words</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_words</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2ea023d">
<h4 id="org2ea023d">Test Word Count</h4>
<div class="outline-text-4" id="text-org2ea023d">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">test_word_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Number of words in the test set"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_word_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_word_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_words</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_word_count</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb789061">
<h4 id="orgb789061">Vocabulary</h4>
<div class="outline-text-4" id="text-orgb789061">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""Training tokens mapped to index in the training corpus"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgfc24a19">
<h4 id="orgfc24a19">Start Token Index</h4>
<div class="outline-text-4" id="text-orgfc24a19">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">start_token_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""The index of the start token in the graph states"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_token_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_token_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">Empty</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_token_index</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org439c123">
<h4 id="org439c123">Negative Infinity</h4>
<div class="outline-text-4" id="text-org439c123">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negative_infinity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""a value for no probability"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_infinity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negative_infinity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"-inf"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_infinity</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgfb18472">
<h4 id="orgfb18472">Initialize the Matrices</h4>
<div class="outline-text-4" id="text-orgfb18472">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">initialize_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Initializes the ``best_probs`` and ``best_paths`` matrices</span>

<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">best_probabilities</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_word_count</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">best_paths</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_word_count</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pos_tag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transition_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start_token_index</span><span class="p">,</span> <span class="n">pos_tag</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_probabilities</span><span class="p">[</span><span class="n">pos_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_infinity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_probabilities</span><span class="p">[</span><span class="n">pos_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transition_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start_token_index</span><span class="p">,</span> <span class="n">pos_tag</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_matrix</span><span class="p">[</span>
                    <span class="n">pos_tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">test_words</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb33a566">
<h4 id="orgb33a566">Virterbi Forward</h4>
<div class="outline-text-4" id="text-orgb33a566">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">viterbi_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""The forward training pass</span>

<span class="sd">    Raises:</span>
<span class="sd">      AlgorithmError: initalize_matrices wasn't run before this method</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_probabilities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AlgorithmError</span><span class="p">(</span><span class="s2">"initialize_matrices must be called before viterbi_forward"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_word_count</span><span class="p">):</span> 
        <span class="k">for</span> <span class="n">pos_tag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">):</span>
            <span class="n">best_probability_for_this_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_infinity</span>
            <span class="n">best_path_for_this_tag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">previous_possible_tag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">):</span>

                <span class="n">probability</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">best_probabilities</span><span class="p">[</span><span class="n">previous_possible_tag</span><span class="p">,</span> <span class="n">word</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transition_matrix</span><span class="p">[</span><span class="n">previous_possible_tag</span><span class="p">,</span> <span class="n">pos_tag</span><span class="p">])</span>
                    <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_matrix</span><span class="p">[</span>
                        <span class="n">pos_tag</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">test_words</span><span class="p">[</span><span class="n">word</span><span class="p">]]]))</span>

                <span class="k">if</span> <span class="n">probability</span> <span class="o">&gt;</span> <span class="n">best_probability_for_this_tag</span><span class="p">:</span>
                    <span class="n">best_probability_for_this_tag</span> <span class="o">=</span> <span class="n">probability</span>
                    <span class="n">best_path_for_this_tag</span> <span class="o">=</span> <span class="n">previous_possible_tag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_probabilities</span><span class="p">[</span><span class="n">pos_tag</span><span class="p">,</span> <span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_probability_for_this_tag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_paths</span><span class="p">[</span><span class="n">pos_tag</span><span class="p">,</span> <span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_path_for_this_tag</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5b864e7">
<h4 id="org5b864e7">Viterbi Backward</h4>
<div class="outline-text-4" id="text-org5b864e7">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">viterbi_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    This function creates the best path.</span>

<span class="sd">    Raises:</span>
<span class="sd">     AlgorithmError: initialize or forward-pass not done</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_probabilities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AlgorithmError</span><span class="p">(</span><span class="s2">"initialize and forward-pass not run"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_probabilities</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AlgorithmError</span><span class="p">(</span><span class="s2">"forward-pass not run"</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_word_count</span>

    <span class="n">best_probability_for_last_word</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_infinity</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_word_count</span>
    <span class="n">last_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_word_count</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">pos_tag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_probabilities</span><span class="p">[</span><span class="n">pos_tag</span><span class="p">,</span> <span class="n">last_column</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_probability_for_last_word</span><span class="p">:</span>
            <span class="n">best_probability_for_last_word</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_probabilities</span><span class="p">[</span><span class="n">pos_tag</span><span class="p">,</span> <span class="n">last_column</span><span class="p">]</span>
            <span class="n">z</span><span class="p">[</span><span class="n">last_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_tag</span>
    <span class="n">prediction</span><span class="p">[</span><span class="n">last_column</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">last_column</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last_column</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">previous_word</span> <span class="o">=</span> <span class="n">word</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">pos_tag_for_word</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
        <span class="n">z</span><span class="p">[</span><span class="n">previous_word</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_paths</span><span class="p">[</span><span class="n">pos_tag_for_word</span><span class="p">,</span> <span class="n">word</span><span class="p">]</span>
        <span class="n">prediction</span><span class="p">[</span><span class="n">previous_word</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">previous_word</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span> <span class="o">=</span> <span class="n">prediction</span>    
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga3ad0da">
<h4 id="orga3ad0da">Call It</h4>
<div class="outline-text-4" id="text-orga3ad0da">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Calls the methods in order"""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initialize_matrices</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">viterbi_forward</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">viterbi_backward</span><span class="p">()</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org90f79db">
<h3 id="org90f79db">Test it out</h3>
<div class="outline-text-3" id="text-org90f79db">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.parts_of_speech</span> <span class="kn">import</span> <span class="n">HiddenMarkov</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">HiddenMarkov</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">matrices</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">original</span> <span class="o">==</span> <span class="n">other</span> <span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">other</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">states</span><span class="p">))</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tag_counts</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">transition_matrix</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">emission_matrix</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">original</span> <span class="o">==</span> <span class="n">new</span> <span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">test_words</span><span class="p">))</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">vocab</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

<span class="n">model</span><span class="o">.</span><span class="n">initialize_matrices</span><span class="p">()</span>

<span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">best_probabilities</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">best_probs</span><span class="o">.</span><span class="n">shape</span>
<span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">best_paths</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">best_paths</span><span class="o">.</span><span class="n">shape</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">best_probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="o">-</span><span class="mf">22.6098</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">),</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">best_paths</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.0000</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">viterbi_forward</span><span class="p">()</span>
<span class="n">expected</span> <span class="o">=</span> <span class="o">-</span><span class="mf">24.7822</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">best_probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">best_probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="o">-</span><span class="mf">49.5601</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">viterbi_backward</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">actual</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'DT'</span><span class="p">,</span> <span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'POS'</span><span class="p">,</span> <span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'MD'</span><span class="p">,</span> <span class="s1">'VB'</span><span class="p">,</span> <span class="s1">'VBN'</span><span class="p">]</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">((</span><span class="n">a</span><span class="o">==</span><span class="n">e</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)))</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org9d3d154">
<h4 id="org9d3d154">Run The Methods In the correct order with a call</h4>
<div class="outline-text-4" id="text-org9d3d154">
<div class="highlight">
<pre><span></span><span class="n">mock</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="n">step_1</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="n">step_2</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="n">step_3</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>

<span class="n">mock</span><span class="o">.</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">step_1</span>
<span class="n">mock</span><span class="o">.</span><span class="n">viterbi_forward</span> <span class="o">=</span> <span class="n">step_2</span>
<span class="n">mock</span><span class="o">.</span><span class="n">viterbi_backward</span> <span class="o">=</span> <span class="n">step_3</span>

<span class="n">HiddenMarkov</span><span class="o">.</span><span class="n">initialize_matrices</span> <span class="o">=</span> <span class="n">step_1</span>
<span class="n">HiddenMarkov</span><span class="o">.</span><span class="n">viterbi_forward</span> <span class="o">=</span> <span class="n">step_2</span>
<span class="n">HiddenMarkov</span><span class="o">.</span><span class="n">viterbi_backward</span> <span class="o">=</span> <span class="n">step_3</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">HiddenMarkov</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">matrices</span><span class="p">)</span>
<span class="n">model</span><span class="p">()</span>
<span class="n">expect</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">mock_calls</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">([</span><span class="n">call</span><span class="o">.</span><span class="n">initialize</span><span class="p">(),</span>
                                  <span class="n">call</span><span class="o">.</span><span class="n">viterbi_forward</span><span class="p">(),</span>
                                  <span class="n">call</span><span class="o">.</span><span class="n">viterbi_backward</span><span class="p">()]))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/">Parts-of-Speech Tagging: Hidden Markov Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/" rel="bookmark"><time class="published dt-published" datetime="2020-11-19T17:26:36-08:00" itemprop="datePublished" title="2020-11-19 17:26">2020-11-19 17:26</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org2b31834">Beginning</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org4da83e4">Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#orge9b4c60">Set Up</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org6a47695">The Data</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org17b3c47">Plotting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#orgb9acb91">Middle</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org58cc916">Generating Matrices</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#orgdfaaaf8">Creating the 'A' transition probabilities matrix</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org735101a">Create the 'B' emission probabilities matrix</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org341fc58">Create Emission Matrix</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#orgbe72f8f">End</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org0ca5889">Bundle It Up</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#orgdc720b8">The Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#orgc6d0f48">The Matrices</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org27456da">The Tags</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#orgba72823">The Tag Count</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org2ce7bb3">The Word Count</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org1545d18">The Transition Matrix</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org6255af7">The Emission Matrix</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#org0034a89">Test It Out</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#orgf14cd9b">The Transition Matrix</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/#orged17297">The Emission Matrix</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org2b31834">
<h2 id="org2b31834">Beginning</h2>
<div class="outline-text-2" id="text-org2b31834">
<p>Now you will build something more context specific. Concretely, you will be implementing a Hidden Markov Model (HMM) with a Viterbi decoder</p>
<ul class="org-ul">
<li>The HMM is one of the most commonly used algorithms in Natural Language Processing, and is a foundation to many deep learning techniques you will see in this specialization.</li>
<li>In addition to parts-of-speech tagging, HMM is used in speech recognition, speech synthesis, etc.</li>
<li>By completing this part of the assignment you will get a 95% accuracy on the same dataset you used in Part 1.</li>
</ul>
<p>The Markov Model contains a number of states and the probability of transition between those states.</p>
<ul class="org-ul">
<li>In this case, the states are the parts-of-speech.</li>
<li>A Markov Model utilizes a transition matrix, <code>A</code>.</li>
<li>A Hidden Markov Model adds an observation or emission matrix <code>B</code> which describes the probability of a visible observation when we are in a particular state.</li>
<li>In this case, the emissions are the words in the corpus</li>
<li>The state, which is hidden, is the POS tag of that word.</li>
</ul>
</div>
<div class="outline-3" id="outline-container-org4da83e4">
<h3 id="org4da83e4">Imports</h3>
<div class="outline-text-3" id="text-org4da83e4">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># this repository</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.parts_of_speech</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">TheTrainer</span>

<span class="c1"># my other stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orge9b4c60">
<h3 id="orge9b4c60">Set Up</h3>
<div class="outline-text-3" id="text-orge9b4c60"></div>
<div class="outline-4" id="outline-container-org6a47695">
<h4 id="org6a47695">The Data</h4>
<div class="outline-text-4" id="text-org6a47695">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">TheTrainer</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">processed_training</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org17b3c47">
<h4 id="org17b3c47">Plotting</h4>
<div class="outline-text-4" id="text-org17b3c47">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"parts-of-speech-tagging-hidden-markov-model"</span>
<span class="n">FOLDER</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">/"</span> 
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">FOLDER</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
    <span class="n">color_map</span><span class="o">=</span><span class="s2">"OrRd"</span><span class="p">,</span>
    <span class="n">path_color_map</span><span class="o">=</span><span class="s2">"blues"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgb9acb91">
<h2 id="orgb9acb91">Middle</h2>
<div class="outline-text-2" id="text-orgb9acb91"></div>
<div class="outline-3" id="outline-container-org58cc916">
<h3 id="org58cc916">Generating Matrices</h3>
<div class="outline-text-3" id="text-org58cc916"></div>
<div class="outline-4" id="outline-container-orgdfaaaf8">
<h4 id="orgdfaaaf8">Creating the 'A' transition probabilities matrix</h4>
<div class="outline-text-4" id="text-orgdfaaaf8">
<p>Now that you have your `emission_counts`, `transition_counts`, and `tag_counts`, you will start implementing the Hidden Markov Model.</p>
<p>This will allow you to quickly construct the</p>
<ul class="org-ul">
<li><code>A</code> transition probabilities matrix.</li>
<li>and the <code>B</code> emission probabilities matrix.</li>
</ul>
<p>You will also use some smoothing when computing these matrices.</p>
<p>Here is an example of what the <code>A</code> transition matrix would look like (it is simplified to 5 tags for viewing. It is a 46x46 matrix in this assignment.</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col"><b>A</b></th>
<th class="org-left" scope="col">…</th>
<th class="org-right" scope="col">RBS</th>
<th class="org-right" scope="col">RP</th>
<th class="org-right" scope="col">SYM</th>
<th class="org-right" scope="col">TO</th>
<th class="org-right" scope="col">UH</th>
<th class="org-left" scope="col">…</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><b>RBS</b></td>
<td class="org-left">…</td>
<td class="org-right">2.217069e-06</td>
<td class="org-right">2.217069e-06</td>
<td class="org-right">2.217069e-06</td>
<td class="org-right">0.008870</td>
<td class="org-right">2.217069e-06</td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left"><b>RP</b></td>
<td class="org-left">…</td>
<td class="org-right">3.756509e-07</td>
<td class="org-right">7.516775e-04</td>
<td class="org-right">3.756509e-07</td>
<td class="org-right">0.051089</td>
<td class="org-right">3.756509e-07</td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left"><b>SYM</b></td>
<td class="org-left">…</td>
<td class="org-right">1.722772e-05</td>
<td class="org-right">1.722772e-05</td>
<td class="org-right">1.722772e-05</td>
<td class="org-right">0.000017</td>
<td class="org-right">1.722772e-05</td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left"><b>TO</b></td>
<td class="org-left">…</td>
<td class="org-right">4.477336e-05</td>
<td class="org-right">4.472863e-08</td>
<td class="org-right">4.472863e-08</td>
<td class="org-right">0.000090</td>
<td class="org-right">4.477336e-05</td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left"><b>UH</b></td>
<td class="org-left">…</td>
<td class="org-right">1.030439e-05</td>
<td class="org-right">1.030439e-05</td>
<td class="org-right">1.030439e-05</td>
<td class="org-right">0.061837</td>
<td class="org-right">3.092348e-02</td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left">…</td>
<td class="org-left">…</td>
<td class="org-right">…</td>
<td class="org-right">…</td>
<td class="org-right">…</td>
<td class="org-right">…</td>
<td class="org-right">…</td>
<td class="org-left">…</td>
</tr>
</tbody>
</table>
<p>Note that the matrix above was computed with smoothing.</p>
<p>Each cell gives you the probability to go from one part of speech to another.</p>
<ul class="org-ul">
<li>In other words, there is a 4.47e-8 chance of going from parts-of-speech <code>TO</code> to <code>RP</code>.</li>
<li>The sum of each row has to equal 1, because we assume that the next POS tag must be one of the available columns in the table.</li>
</ul>
<p>The smoothing was done as follows:</p>
<p>\[ P(t_i | t_{i-1}) = \frac{C(t_{i-1}, t_{i}) + \alpha }{C(t_{i-1}) +\alpha * N}\tag{3} \]</p>
<ul class="org-ul">
<li>\(N\) is the total number of tags</li>
<li>\(C(t_{i-1}, t_{i})\) is the count of the tuple (previous POS, current POS) in `transition_counts` dictionary.</li>
<li>\(C(t_{i-1})\) is the count of the previous POS in the `tag_counts` dictionary.</li>
<li>\(\alpha\) is a smoothing parameter.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">create_transition_matrix</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tag_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                             <span class="n">transition_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""Transition Matrix for the Hidden Markov Model</span>

<span class="sd">    Args: </span>
<span class="sd">      ``alpha``: number used for smoothing</span>
<span class="sd">      ``tag_counts``: a dictionary mapping each tag to its respective count</span>
<span class="sd">      ``transition_counts``: transition count for the previous word and tag</span>

<span class="sd">    Returns:</span>
<span class="sd">      ``A``: matrix of dimension (``num_tags``,``num_tags``)</span>
<span class="sd">    """</span>
    <span class="c1"># Get a sorted list of unique POS tags</span>
    <span class="n">all_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tag_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Count the number of unique POS tags</span>
    <span class="n">num_tags</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_tags</span><span class="p">)</span>

    <span class="c1"># Initialize the transition matrix 'A'</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_tags</span><span class="p">,</span><span class="n">num_tags</span><span class="p">))</span>

    <span class="c1"># Get the unique transition tuples (previous POS, current POS)</span>
    <span class="n">trans_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">transition_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Go through each row of the transition matrix A</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tags</span><span class="p">):</span>

        <span class="c1"># Go through each column of the transition matrix A</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tags</span><span class="p">):</span>

            <span class="c1"># Initialize the count of the (prev POS, current POS) to zero</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Define the tuple (prev POS, current POS)</span>
            <span class="c1"># Get the tag at position i and tag at position j (from the all_tags list)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_tags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">all_tags</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="c1"># Check if the (prev POS, current POS) tuple </span>
            <span class="c1"># exists in the transition counts dictionary</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">transition_counts</span><span class="p">:</span> <span class="c1">#complete this line</span>

                <span class="c1"># Get count from the transition_counts dictionary </span>
                <span class="c1"># for the (prev POS, current POS) tuple</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">transition_counts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="c1"># Get the count of the previous tag (index position i) from tag_counts</span>
            <span class="n">count_prev_tag</span> <span class="o">=</span> <span class="n">tag_counts</span><span class="p">[</span><span class="n">all_tags</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

            <span class="c1"># Apply smoothing using count of the tuple, alpha, </span>
            <span class="c1"># count of previous tag, alpha, and total number of tags</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">count_prev_tag</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">num_tags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># setup some values</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">states</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">create_transition_matrix</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span>
                             <span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">,</span>
                             <span class="n">trainer</span><span class="o">.</span><span class="n">transition_counts</span><span class="p">)</span>
<span class="c1"># Testing your function</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.000007040</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"A at row 0, col 0: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.9f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">),</span> <span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.1691</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"A at row 3, col 1: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"View a subset of transition matrix A"</span><span class="p">)</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">35</span><span class="p">,</span><span class="mi">30</span><span class="p">:</span><span class="mi">35</span><span class="p">]</span>
<span class="n">A_sub</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">35</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">35</span><span class="p">]</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">A_sub</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
 <span class="p">[</span><span class="mf">2.217069e-06</span><span class="p">,</span> <span class="mf">2.217069e-06</span><span class="p">,</span> <span class="mf">2.217069e-06</span><span class="p">,</span> <span class="mf">0.008870</span><span class="p">,</span> <span class="mf">2.217069e-06</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">3.756509e-07</span><span class="p">,</span> <span class="mf">7.516775e-04</span><span class="p">,</span> <span class="mf">3.756509e-07</span><span class="p">,</span> <span class="mf">0.051089</span><span class="p">,</span> <span class="mf">3.756509e-07</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">1.722772e-05</span><span class="p">,</span> <span class="mf">1.722772e-05</span><span class="p">,</span> <span class="mf">1.722772e-05</span><span class="p">,</span> <span class="mf">0.000017</span><span class="p">,</span> <span class="mf">1.722772e-05</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">4.477336e-05</span><span class="p">,</span> <span class="mf">4.472863e-08</span><span class="p">,</span> <span class="mf">4.472863e-08</span><span class="p">,</span> <span class="mf">0.000090</span><span class="p">,</span> <span class="mf">4.477336e-05</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">1.030439e-05</span><span class="p">,</span> <span class="mf">1.030439e-05</span><span class="p">,</span> <span class="mf">1.030439e-05</span><span class="p">,</span> <span class="mf">0.061837</span><span class="p">,</span> <span class="mf">3.092348e-02</span><span class="p">],</span>
<span class="p">])</span>

<span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</pre></div>
<pre class="example">
A at row 0, col 0: 0.000007040
A at row 3, col 1: 0.1691
View a subset of transition matrix A
              RBS            RP           SYM        TO            UH
RBS  2.217069e-06  2.217069e-06  2.217069e-06  0.008870  2.217069e-06
RP   3.756509e-07  7.516775e-04  3.756509e-07  0.051089  3.756509e-07
SYM  1.722772e-05  1.722772e-05  1.722772e-05  0.000017  1.722772e-05
TO   4.477336e-05  4.472863e-08  4.472863e-08  0.000090  4.477336e-05
UH   1.030439e-05  1.030439e-05  1.030439e-05  0.061837  3.092348e-02
</pre>
<div class="highlight">
<pre><span></span><span class="n">plotter</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">states</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">states</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_map</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Emission Matrix A"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
    <span class="n">xrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1">#plot *= holoviews.Labels(plot)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"emission_matrix_a"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/parts-of-speech-tagging-hidden-markov-model/emission_matrix_a.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Looking at the plot you can see that there are a few transitions that are very likely. Maybe we can look at them to see if they're helpful.</p>
<div class="highlight">
<pre><span></span><span class="n">URL</span> <span class="o">=</span> <span class="s2">"https://www.ling.upenn.edu/courses/Fall_2003/ling001/penn_treebank_pos.html"</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">TRANSLATOR</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="o">.</span><span class="n">Tag</span><span class="p">:</span><span class="n">row</span><span class="o">.</span><span class="n">Description</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()}</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"|Tag| Description|"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"|-+-|"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">TRANSLATOR</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s1">'unknown'</span><span class="p">)</span><span class="si">}</span><span class="s2">|"</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Tag</th>
<th class="org-left" scope="col">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">#</td>
<td class="org-left">unknown</td>
</tr>
<tr>
<td class="org-left">$</td>
<td class="org-left">unknown</td>
</tr>
<tr>
<td class="org-left">''</td>
<td class="org-left">unknown</td>
</tr>
<tr>
<td class="org-left">(</td>
<td class="org-left">unknown</td>
</tr>
<tr>
<td class="org-left">)</td>
<td class="org-left">unknown</td>
</tr>
<tr>
<td class="org-left">,</td>
<td class="org-left">unknown</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">.</td>
<td class="org-left">unknown</td>
</tr>
<tr>
<td class="org-left">:</td>
<td class="org-left">unknown</td>
</tr>
<tr>
<td class="org-left">CC</td>
<td class="org-left">Coordinating conjunction</td>
</tr>
<tr>
<td class="org-left">CD</td>
<td class="org-left">Cardinal number</td>
</tr>
<tr>
<td class="org-left">DT</td>
<td class="org-left">Determiner</td>
</tr>
<tr>
<td class="org-left">EX</td>
<td class="org-left">Existential there</td>
</tr>
<tr>
<td class="org-left">FW</td>
<td class="org-left">Foreign word</td>
</tr>
<tr>
<td class="org-left">IN</td>
<td class="org-left">Preposition or subordinating conjunction</td>
</tr>
<tr>
<td class="org-left">JJ</td>
<td class="org-left">Adjective</td>
</tr>
<tr>
<td class="org-left">JJR</td>
<td class="org-left">Adjective, comparative</td>
</tr>
<tr>
<td class="org-left">JJS</td>
<td class="org-left">Adjective, superlative</td>
</tr>
<tr>
<td class="org-left">LS</td>
<td class="org-left">List item marker</td>
</tr>
<tr>
<td class="org-left">MD</td>
<td class="org-left">Modal</td>
</tr>
<tr>
<td class="org-left">NN</td>
<td class="org-left">Noun, singular or mass</td>
</tr>
<tr>
<td class="org-left">NNP</td>
<td class="org-left">Proper noun, singular</td>
</tr>
<tr>
<td class="org-left">NNPS</td>
<td class="org-left">Proper noun, plural</td>
</tr>
<tr>
<td class="org-left">NNS</td>
<td class="org-left">Noun, plural</td>
</tr>
<tr>
<td class="org-left">PDT</td>
<td class="org-left">Predeterminer</td>
</tr>
<tr>
<td class="org-left">POS</td>
<td class="org-left">Possessive ending</td>
</tr>
<tr>
<td class="org-left">PRP</td>
<td class="org-left">Personal pronoun</td>
</tr>
<tr>
<td class="org-left">PRP$</td>
<td class="org-left">Possessive pronoun</td>
</tr>
<tr>
<td class="org-left">RB</td>
<td class="org-left">Adverb</td>
</tr>
<tr>
<td class="org-left">RBR</td>
<td class="org-left">Adverb, comparative</td>
</tr>
<tr>
<td class="org-left">RBS</td>
<td class="org-left">Adverb, superlative</td>
</tr>
<tr>
<td class="org-left">RP</td>
<td class="org-left">Particle</td>
</tr>
<tr>
<td class="org-left">SYM</td>
<td class="org-left">Symbol</td>
</tr>
<tr>
<td class="org-left">TO</td>
<td class="org-left">to</td>
</tr>
<tr>
<td class="org-left">UH</td>
<td class="org-left">Interjection</td>
</tr>
<tr>
<td class="org-left">VB</td>
<td class="org-left">Verb, base form</td>
</tr>
<tr>
<td class="org-left">VBD</td>
<td class="org-left">Verb, past tense</td>
</tr>
<tr>
<td class="org-left">VBG</td>
<td class="org-left">Verb, gerund or present participle</td>
</tr>
<tr>
<td class="org-left">VBN</td>
<td class="org-left">Verb, past participle</td>
</tr>
<tr>
<td class="org-left">VBP</td>
<td class="org-left">Verb, non-3rd person singular present</td>
</tr>
<tr>
<td class="org-left">VBZ</td>
<td class="org-left">Verb, 3rd person singular present</td>
</tr>
<tr>
<td class="org-left">WDT</td>
<td class="org-left">Wh-determiner</td>
</tr>
<tr>
<td class="org-left">WP</td>
<td class="org-left">Wh-pronoun</td>
</tr>
<tr>
<td class="org-left">WP$</td>
<td class="org-left">Possessive wh-pronoun</td>
</tr>
<tr>
<td class="org-left">WRB</td>
<td class="org-left">Wh-adverb</td>
</tr>
<tr>
<td class="org-left">``</td>
<td class="org-left">unknown</td>
</tr>
</tbody>
</table>
<p>The highest probabilities are at the bottom of the table (the red blocks) where it show that there's a 99% probability that a <code>$</code> or a <code>#</code> will be followed by a Cardinal Number, which seems to make sense, especially since the original source was the Wall Street Journal, and you might expect there to be references to dollars. The next highest probability is that a <i>Predeterminer</i> will be followed by a <i>Determiner</i>, which makes sense based on the names, although I have no idea what those things are. And then the notion that a <code>.</code> will be followed by a <code>--s---</code> (a period will be followed by the start of a new statement). So, at least for the most common cases it looks fairly intuitive.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org735101a">
<h3 id="org735101a">Create the 'B' emission probabilities matrix</h3>
<div class="outline-text-3" id="text-org735101a">
<p>Now you will create the <code>B</code> transition matrix which computes the emission probability.</p>
<p>You will use smoothing as defined below:</p>
<p>\[ P(w_i | t_i) = \frac{C(t_i, word_i)+ \alpha}{C(t_{i}) +\alpha * N} \]</p>
<ul class="org-ul">
<li>\(C(t_i, word_i)\) is the number of times\$word_i\) was associated with \(tag_i\) in the training data (stored in <code>emission_counts</code> dictionary).</li>
<li>\(C(t_i)\) is the number of times \(tag_i\) was in the training data (stored in <code>tag_counts</code> dictionary).</li>
<li>\(N\) is the number of words in the vocabulary</li>
<li>\(\alpha\) is a smoothing parameter.</li>
</ul>
<p>The matrix <code>B</code> is of dimension (num_tags, N), where num_tags is the number of possible parts-of-speech tags.</p>
<p>Here is an example of the matrix, only a subset of tags and words are shown:</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col"><b>B</b></th>
<th class="org-left" scope="col">…</th>
<th class="org-right" scope="col">725</th>
<th class="org-right" scope="col">adroitly</th>
<th class="org-right" scope="col">engineers</th>
<th class="org-right" scope="col">promoted</th>
<th class="org-right" scope="col">synergy</th>
<th class="org-left" scope="col">…</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">&nbsp;</td>
<td class="org-left">…</td>
<td class="org-right"><b>8.201296e-05</b></td>
<td class="org-right">2.732854e-08</td>
<td class="org-right">2.732854e-08</td>
<td class="org-right">2.732854e-08</td>
<td class="org-right">2.732854e-08</td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left"><b>NN</b></td>
<td class="org-left">…</td>
<td class="org-right">7.521128e-09</td>
<td class="org-right">7.521128e-09</td>
<td class="org-right">7.521128e-09</td>
<td class="org-right">7.521128e-09</td>
<td class="org-right"><b>2.257091e-05</b></td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left"><b>NNS</b></td>
<td class="org-left">…</td>
<td class="org-right">1.670013e-08</td>
<td class="org-right">1.670013e-08</td>
<td class="org-right"><b>4.676203e-04</b></td>
<td class="org-right">1.670013e-08</td>
<td class="org-right">1.670013e-08</td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left"><b>VB</b></td>
<td class="org-left">…</td>
<td class="org-right">3.779036e-08</td>
<td class="org-right">3.779036e-08</td>
<td class="org-right">3.779036e-08</td>
<td class="org-right">3.779036e-08</td>
<td class="org-right">3.779036e-08</td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left"><b>RB</b></td>
<td class="org-left">…</td>
<td class="org-right">3.226454e-08</td>
<td class="org-right"><b>6.456135e-05</b></td>
<td class="org-right">3.226454e-08</td>
<td class="org-right">3.226454e-08</td>
<td class="org-right">3.226454e-08</td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left"><b>RP</b></td>
<td class="org-left">…</td>
<td class="org-right">3.723317e-07</td>
<td class="org-right">3.723317e-07</td>
<td class="org-right">3.723317e-07</td>
<td class="org-right"><b>3.723317e-07</b></td>
<td class="org-right">3.723317e-07</td>
<td class="org-left">…</td>
</tr>
<tr>
<td class="org-left">…</td>
<td class="org-left">…</td>
<td class="org-right">…</td>
<td class="org-right">…</td>
<td class="org-right">…</td>
<td class="org-right">…</td>
<td class="org-right">…</td>
<td class="org-left">…</td>
</tr>
</tbody>
</table>
<p>We're now going to implement the <code>create_emission_matrix</code> that computes the <code>B</code> emission probabilities matrix. Your function takes in \(\alpha\), the smoothing parameter, <code>tag_counts</code>, which is a dictionary mapping each tag to its respective count, the <code>emission_counts</code> dictionary where the keys are (tag, word) and the values are the counts. Your task is to output a matrix that computes equation 4 for each cell in matrix <code>B</code>.</p>
</div>
<div class="outline-4" id="outline-container-org341fc58">
<h4 id="org341fc58">Create Emission Matrix</h4>
<div class="outline-text-4" id="text-org341fc58">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">create_emission_matrix</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                           <span class="n">tag_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                           <span class="n">emission_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                           <span class="n">vocab</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""Create Matrix B</span>

<span class="sd">    Args: </span>
<span class="sd">       ``alpha``: tuning parameter used in smoothing </span>
<span class="sd">       ``tag_counts``: a dictionary mapping each tag to its respective count</span>
<span class="sd">       ``emission_counts``: a dictionary where the keys are (tag, word) and the values are the counts</span>
<span class="sd">       ``vocab``: a dictionary where keys are words in vocabulary and value is an index.</span>
<span class="sd">              within the function it'll be treated as a list</span>
<span class="sd">    Returns:</span>
<span class="sd">       ``B``: a matrix of dimension ``(num_tags, len(vocab))``</span>
<span class="sd">    """</span>

    <span class="c1"># get the number of POS tag</span>
    <span class="n">num_tags</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_counts</span><span class="p">)</span>

    <span class="c1"># Get a list of all POS tags</span>
    <span class="n">all_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tag_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Get the total number of unique words in the vocabulary</span>
    <span class="n">num_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>

    <span class="c1"># Initialize the emission matrix B with places for</span>
    <span class="c1"># tags in the rows and words in the columns</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_tags</span><span class="p">,</span> <span class="n">num_words</span><span class="p">))</span>

    <span class="c1"># Get a set of all (POS, word) tuples </span>
    <span class="c1"># from the keys of the emission_counts dictionary</span>
    <span class="n">emis_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">emission_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>

    <span class="c1"># Go through each row (POS tags)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tags</span><span class="p">):</span> <span class="c1"># complete this line</span>

        <span class="c1"># Go through each column (words)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_words</span><span class="p">):</span> <span class="c1"># complete this line</span>

            <span class="c1"># Initialize the emission count for the (POS tag, word) to zero</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Define the (POS tag, word) tuple for this row and column</span>
            <span class="n">key</span> <span class="o">=</span>  <span class="p">(</span><span class="n">all_tags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vocab</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="c1"># check if the (POS tag, word) tuple exists as a key in emission counts</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">emission_counts</span><span class="p">:</span> <span class="c1"># complete this line</span>

                <span class="c1"># Get the count of (POS tag, word) from the emission_counts d</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">emission_counts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="c1"># Get the count of the POS tag</span>
            <span class="n">count_tag</span> <span class="o">=</span> <span class="n">tag_counts</span><span class="p">[</span><span class="n">all_tags</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

            <span class="c1"># Apply smoothing and store the smoothed value </span>
            <span class="c1"># into the emission matrix B for this row and column</span>
            <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">count_tag</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">num_words</span><span class="p">)</span>

    <span class="c1">### END CODE HERE ###</span>
    <span class="k">return</span> <span class="n">B</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># creating your emission probability matrix. this takes a few minutes to run.</span>
<span class="n">vocab</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">create_emission_matrix</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span>
                           <span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">,</span>
                           <span class="n">trainer</span><span class="o">.</span><span class="n">emission_counts</span><span class="p">,</span>
                           <span class="nb">list</span><span class="p">(</span><span class="n">vocab</span><span class="p">))</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.000006032</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"View Matrix position at row 0, column 0: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.9f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.000000720</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"View Matrix position at row 3, column 1: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.9f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>

<span class="c1"># Try viewing emissions for a few words in a sample dataframe</span>
<span class="n">cidx</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">'725'</span><span class="p">,</span><span class="s1">'adroitly'</span><span class="p">,</span><span class="s1">'engineers'</span><span class="p">,</span> <span class="s1">'promoted'</span><span class="p">,</span> <span class="s1">'synergy'</span><span class="p">]</span>

<span class="c1"># Get the integer ID for each word</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">vocab</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cidx</span><span class="p">]</span>

<span class="c1"># Choose POS tags to show in a sample dataframe</span>
<span class="n">rvals</span> <span class="o">=</span><span class="p">[</span><span class="s1">'CD'</span><span class="p">,</span><span class="s1">'NN'</span><span class="p">,</span><span class="s1">'NNS'</span><span class="p">,</span> <span class="s1">'VB'</span><span class="p">,</span><span class="s1">'RB'</span><span class="p">,</span><span class="s1">'RP'</span><span class="p">]</span>

<span class="c1"># For each POS tag, get the row number from the 'states' list</span>
<span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">states</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rvals</span><span class="p">]</span>

<span class="c1"># Get the emissions for the sample of words, and the sample of POS tags</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">)]</span>
<span class="n">B_sub</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">rvals</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">cidx</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">B_sub</span><span class="p">)</span>
<span class="n">expected</span> <span class="o">=</span> <span class="p">([</span>
 <span class="p">[</span><span class="mf">8.201296e-05</span><span class="p">,</span> <span class="mf">2.732854e-08</span><span class="p">,</span> <span class="mf">2.732854e-08</span><span class="p">,</span> <span class="mf">2.732854e-08</span><span class="p">,</span> <span class="mf">2.732854e-08</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">7.521128e-09</span><span class="p">,</span> <span class="mf">7.521128e-09</span><span class="p">,</span> <span class="mf">7.521128e-09</span><span class="p">,</span> <span class="mf">7.521128e-09</span><span class="p">,</span> <span class="mf">2.257091e-05</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">1.670013e-08</span><span class="p">,</span> <span class="mf">1.670013e-08</span><span class="p">,</span> <span class="mf">4.676203e-04</span><span class="p">,</span> <span class="mf">1.670013e-08</span><span class="p">,</span> <span class="mf">1.670013e-08</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">3.779036e-08</span><span class="p">,</span> <span class="mf">3.779036e-08</span><span class="p">,</span> <span class="mf">3.779036e-08</span><span class="p">,</span> <span class="mf">3.779036e-08</span><span class="p">,</span> <span class="mf">3.779036e-08</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">3.226454e-08</span><span class="p">,</span> <span class="mf">6.456135e-05</span><span class="p">,</span> <span class="mf">3.226454e-08</span><span class="p">,</span> <span class="mf">3.226454e-08</span><span class="p">,</span> <span class="mf">3.226454e-08</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">3.723317e-07</span><span class="p">,</span> <span class="mf">3.723317e-07</span><span class="p">,</span> <span class="mf">3.723317e-07</span><span class="p">,</span> <span class="mf">3.723317e-07</span><span class="p">,</span> <span class="mf">3.723317e-07</span><span class="p">],</span>
<span class="p">])</span>

<span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</pre></div>
<pre class="example">
View Matrix position at row 0, column 0: 0.000006032
View Matrix position at row 3, column 1: 0.000000720
              725      adroitly     engineers      promoted       synergy
CD   8.201296e-05  2.732854e-08  2.732854e-08  2.732854e-08  2.732854e-08
NN   7.521128e-09  7.521128e-09  7.521128e-09  7.521128e-09  2.257091e-05
NNS  1.670013e-08  1.670013e-08  4.676203e-04  1.670013e-08  1.670013e-08
VB   3.779036e-08  3.779036e-08  3.779036e-08  3.779036e-08  3.779036e-08
RB   3.226454e-08  6.456135e-05  3.226454e-08  3.226454e-08  3.226454e-08
RP   3.723317e-07  3.723317e-07  3.723317e-07  3.723317e-07  3.723317e-07
</pre>
<div class="highlight">
<pre><span></span><span class="n">plotter</span> <span class="o">=</span> <span class="n">B_sub</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_map</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Emission Matrix B"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
    <span class="n">xrotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"emission_matrix_b"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/parts-of-speech-tagging-hidden-markov-model/emission_matrix_b.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>There's 23,777 words in the vocabulary so I'm not plotting the whole thing.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgbe72f8f">
<h2 id="orgbe72f8f">End</h2>
<div class="outline-text-2" id="text-orgbe72f8f"></div>
<div class="outline-3" id="outline-container-org0ca5889">
<h3 id="org0ca5889">Bundle It Up</h3>
<div class="outline-text-3" id="text-org0ca5889"></div>
<div class="outline-4" id="outline-container-orgdc720b8">
<h4 id="orgdc720b8">The Imports</h4>
<div class="outline-text-4" id="text-orgdc720b8">
<div class="highlight">
<pre><span></span><span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc6d0f48">
<h4 id="orgc6d0f48">The Matrices</h4>
<div class="outline-text-4" id="text-orgc6d0f48">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Matrices</span><span class="p">:</span>
    <span class="sd">"""The matrices for the hidden markov model</span>

<span class="sd">    Args:</span>
<span class="sd">     ``transition_counts``: dictionary of counts of adjacent POS tags</span>
<span class="sd">     ``emission_counts``: dictionary of (word, POS) counts</span>
<span class="sd">     ``tag_counts``: dictionary of POS tag-counts</span>
<span class="sd">     ``words``: list of words in the vocabulary</span>
<span class="sd">     ``alpha``: The smoothing value</span>
<span class="sd">    """</span>
    <span class="n">transition_counts</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">emission_counts</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">tag_counts</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="c1"># all the lists have to be sorted for the matrices to match</span>
    <span class="n">words</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">converter</span><span class="o">=</span><span class="nb">sorted</span><span class="p">)</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.001</span>
    <span class="n">_tags</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tag_count</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_word_count</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_transition</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_emission</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org27456da">
<h4 id="org27456da">The Tags</h4>
<div class="outline-text-4" id="text-org27456da">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Sorted list of the POS tags"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgba72823">
<h4 id="orgba72823">The Tag Count</h4>
<div class="outline-text-4" id="text-orgba72823">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tag_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Number of tags"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag_count</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2ce7bb3">
<h4 id="org2ce7bb3">The Word Count</h4>
<div class="outline-text-4" id="text-org2ce7bb3">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">word_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Number of words in the vocabulary"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_word_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_word_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">words</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_word_count</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1545d18">
<h4 id="org1545d18">The Transition Matrix</h4>
<div class="outline-text-4" id="text-org1545d18">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">transition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""The Transition Matrix"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transition</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
                <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transition_counts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transition_counts</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">previous_tag_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">row</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_transition</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="o">/</span><span class="p">(</span><span class="n">previous_tag_count</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transition</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6255af7">
<h4 id="org6255af7">The Emission Matrix</h4>
<div class="outline-text-4" id="text-org6255af7">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">emission</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""The Emission Matrix"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emission</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_count</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word_count</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">words</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
                <span class="n">emission_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_counts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_counts</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">tag_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">row</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_emission</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">emission_count</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="o">/</span><span class="p">(</span><span class="n">tag_count</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_count</span><span class="p">)</span>                
                <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org0034a89">
<h3 id="org0034a89">Test It Out</h3>
<div class="outline-text-3" id="text-org0034a89">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.parts_of_speech.matrices</span> <span class="kn">import</span> <span class="n">Matrices</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">TheTrainer</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">processed_training</span><span class="p">)</span>

<span class="n">matrices</span> <span class="o">=</span> <span class="n">Matrices</span><span class="p">(</span><span class="n">transition_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">transition_counts</span><span class="p">,</span>
                    <span class="n">emission_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">emission_counts</span><span class="p">,</span>
                    <span class="n">tag_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">,</span>
                    <span class="n">words</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary_words</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgf14cd9b">
<h4 id="orgf14cd9b">The Transition Matrix</h4>
<div class="outline-text-4" id="text-orgf14cd9b">
<div class="highlight">
<pre><span></span><span class="n">transition</span> <span class="o">=</span> <span class="n">matrices</span><span class="o">.</span><span class="n">transition</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.000007040</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">transition_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Transition Matrix at row 0, col 0: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.9f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">),</span> <span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.1691</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">transition_matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Transition Matrix at row 3, col 1: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"View a subset of the transition matrix"</span><span class="p">)</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">transition_matrix</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">35</span><span class="p">,</span><span class="mi">30</span><span class="p">:</span><span class="mi">35</span><span class="p">]</span>
<span class="n">A_sub</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">35</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">35</span><span class="p">]</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">A_sub</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
 <span class="p">[</span><span class="mf">2.217069e-06</span><span class="p">,</span> <span class="mf">2.217069e-06</span><span class="p">,</span> <span class="mf">2.217069e-06</span><span class="p">,</span> <span class="mf">0.008870</span><span class="p">,</span> <span class="mf">2.217069e-06</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">3.756509e-07</span><span class="p">,</span> <span class="mf">7.516775e-04</span><span class="p">,</span> <span class="mf">3.756509e-07</span><span class="p">,</span> <span class="mf">0.051089</span><span class="p">,</span> <span class="mf">3.756509e-07</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">1.722772e-05</span><span class="p">,</span> <span class="mf">1.722772e-05</span><span class="p">,</span> <span class="mf">1.722772e-05</span><span class="p">,</span> <span class="mf">0.000017</span><span class="p">,</span> <span class="mf">1.722772e-05</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">4.477336e-05</span><span class="p">,</span> <span class="mf">4.472863e-08</span><span class="p">,</span> <span class="mf">4.472863e-08</span><span class="p">,</span> <span class="mf">0.000090</span><span class="p">,</span> <span class="mf">4.477336e-05</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">1.030439e-05</span><span class="p">,</span> <span class="mf">1.030439e-05</span><span class="p">,</span> <span class="mf">1.030439e-05</span><span class="p">,</span> <span class="mf">0.061837</span><span class="p">,</span> <span class="mf">3.092348e-02</span><span class="p">],</span>
<span class="p">])</span>

<span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</pre></div>
<pre class="example">
Transition Matrix at row 0, col 0: 0.000007040
Transition Matrix at row 3, col 1: 0.1691
View a subset of the transition matrix
              RBS            RP           SYM        TO            UH
RBS  2.217069e-06  2.217069e-06  2.217069e-06  0.008870  2.217069e-06
RP   3.756509e-07  7.516775e-04  3.756509e-07  0.051089  3.756509e-07
SYM  1.722772e-05  1.722772e-05  1.722772e-05  0.000017  1.722772e-05
TO   4.477336e-05  4.472863e-08  4.472863e-08  0.000090  4.477336e-05
UH   1.030439e-05  1.030439e-05  1.030439e-05  0.061837  3.092348e-02
</pre></div>
</div>
<div class="outline-4" id="outline-container-orged17297">
<h4 id="orged17297">The Emission Matrix</h4>
<div class="outline-text-4" id="text-orged17297">
<div class="highlight">
<pre><span></span><span class="n">matrices</span> <span class="o">=</span> <span class="n">Matrices</span><span class="p">(</span><span class="n">transition_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">transition_counts</span><span class="p">,</span>
                    <span class="n">emission_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">emission_counts</span><span class="p">,</span>
                    <span class="n">words</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary_words</span><span class="p">,</span>
                    <span class="n">tag_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">emission</span> <span class="o">=</span> <span class="n">matrices</span><span class="o">.</span><span class="n">emission</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">emission</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.000006032</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Emission Matrix position at row 0, column 0: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.9f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">emission</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.000000720</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Emission Matrix position at row 3, column 1: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.9f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>

<span class="c1"># Try viewing emissions for a few words in a sample dataframe</span>
<span class="n">columns</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">'725'</span><span class="p">,</span><span class="s1">'adroitly'</span><span class="p">,</span><span class="s1">'engineers'</span><span class="p">,</span> <span class="s1">'promoted'</span><span class="p">,</span> <span class="s1">'synergy'</span><span class="p">]</span>

<span class="c1"># Get the integer ID for each word</span>
<span class="n">column_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>

<span class="c1"># Choose POS tags to show in a sample dataframe</span>
<span class="n">rows</span> <span class="o">=</span><span class="p">[</span><span class="s1">'CD'</span><span class="p">,</span><span class="s1">'NN'</span><span class="p">,</span><span class="s1">'NNS'</span><span class="p">,</span> <span class="s1">'VB'</span><span class="p">,</span><span class="s1">'RB'</span><span class="p">,</span><span class="s1">'RP'</span><span class="p">]</span>

<span class="c1"># For each POS tag, get the row number from the 'states' list</span>
<span class="n">row_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">matrices</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

<span class="c1"># Get the emissions for the sample of words, and the sample of POS tags</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">emission</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">row_numbers</span><span class="p">,</span><span class="n">column_ids</span><span class="p">)]</span>
<span class="n">B_sub</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">B_sub</span><span class="p">)</span>
<span class="n">expected</span> <span class="o">=</span> <span class="p">([</span>
 <span class="p">[</span><span class="mf">8.201296e-05</span><span class="p">,</span> <span class="mf">2.732854e-08</span><span class="p">,</span> <span class="mf">2.732854e-08</span><span class="p">,</span> <span class="mf">2.732854e-08</span><span class="p">,</span> <span class="mf">2.732854e-08</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">7.521128e-09</span><span class="p">,</span> <span class="mf">7.521128e-09</span><span class="p">,</span> <span class="mf">7.521128e-09</span><span class="p">,</span> <span class="mf">7.521128e-09</span><span class="p">,</span> <span class="mf">2.257091e-05</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">1.670013e-08</span><span class="p">,</span> <span class="mf">1.670013e-08</span><span class="p">,</span> <span class="mf">4.676203e-04</span><span class="p">,</span> <span class="mf">1.670013e-08</span><span class="p">,</span> <span class="mf">1.670013e-08</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">3.779036e-08</span><span class="p">,</span> <span class="mf">3.779036e-08</span><span class="p">,</span> <span class="mf">3.779036e-08</span><span class="p">,</span> <span class="mf">3.779036e-08</span><span class="p">,</span> <span class="mf">3.779036e-08</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">3.226454e-08</span><span class="p">,</span> <span class="mf">6.456135e-05</span><span class="p">,</span> <span class="mf">3.226454e-08</span><span class="p">,</span> <span class="mf">3.226454e-08</span><span class="p">,</span> <span class="mf">3.226454e-08</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">3.723317e-07</span><span class="p">,</span> <span class="mf">3.723317e-07</span><span class="p">,</span> <span class="mf">3.723317e-07</span><span class="p">,</span> <span class="mf">3.723317e-07</span><span class="p">,</span> <span class="mf">3.723317e-07</span><span class="p">],</span>
<span class="p">])</span>

<span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</pre></div>
<pre class="example">
Emission Matrix position at row 0, column 0: 0.000006032
Emission Matrix position at row 3, column 1: 0.000000720
              725      adroitly     engineers      promoted       synergy
CD   8.201296e-05  2.732854e-08  2.732854e-08  2.732854e-08  2.732854e-08
NN   7.521128e-09  7.521128e-09  7.521128e-09  7.521128e-09  2.257091e-05
NNS  1.670013e-08  1.670013e-08  4.676203e-04  1.670013e-08  1.670013e-08
VB   3.779036e-08  3.779036e-08  3.779036e-08  3.779036e-08  3.779036e-08
RB   3.226454e-08  6.456135e-05  3.226454e-08  3.226454e-08  3.226454e-08
RP   3.723317e-07  3.723317e-07  3.723317e-07  3.723317e-07  3.723317e-07
</pre>
<p><b>Note:</b> I was getting the wrong values because I switched to the <code>DataLoader.vocabulary_words</code> list, which isn't sorted (because I was trying to follow the example). The <code>vocabulary</code> is sorted, but it's a dict so then you have to convert it to a list… in the future just sort everything.</p>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/">Parts-of-Speech Tagging: Most Frequent Class Baseline</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/" rel="bookmark"><time class="published dt-published" datetime="2020-11-17T18:23:32-08:00" itemprop="datePublished" title="2020-11-17 18:23">2020-11-17 18:23</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#orgf313441">Begin</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#org89086a8">Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#orgd1d7a5b">Set Up</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#orge3dfff7">The Environment</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#orge16f85f">The Data</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#org5a6b6d7">The Trained Model</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#org80eaa4a">Middle</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#orge10aed1">Most Frequent Class Baseline</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#orgc1bbe8f">Processed vs Vocabulary</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#org36d8652">The Baseline Implementation</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/#org8163616">Take Two</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgf313441">
<h2 id="orgf313441">Begin</h2>
<div class="outline-text-2" id="text-orgf313441"></div>
<div class="outline-3" id="outline-container-org89086a8">
<h3 id="org89086a8">Imports</h3>
<div class="outline-text-3" id="text-org89086a8">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="c1"># this repo</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.parts_of_speech.preprocessing</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.parts_of_speech.training</span> <span class="kn">import</span> <span class="n">TheTrainer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd1d7a5b">
<h3 id="orgd1d7a5b">Set Up</h3>
<div class="outline-text-3" id="text-orgd1d7a5b"></div>
<div class="outline-4" id="outline-container-orge3dfff7">
<h4 id="orge3dfff7">The Environment</h4>
<div class="outline-text-4" id="text-orge3dfff7">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge16f85f">
<h4 id="orge16f85f">The Data</h4>
<div class="outline-text-4" id="text-orge16f85f">
<div class="highlight">
<pre><span></span><span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5a6b6d7">
<h4 id="org5a6b6d7">The Trained Model</h4>
<div class="outline-text-4" id="text-org5a6b6d7">
<div class="highlight">
<pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">TheTrainer</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">processed_training</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org80eaa4a">
<h2 id="org80eaa4a">Middle</h2>
<div class="outline-text-2" id="text-org80eaa4a"></div>
<div class="outline-3" id="outline-container-orge10aed1">
<h3 id="orge10aed1">Most Frequent Class Baseline</h3>
<div class="outline-text-3" id="text-orge10aed1">
<p>The main purpose of part-of-speech tagging is to disambiguate words (Jurasky) - most words only have one part-of-speech tag, but the most commonly used words have more than one. To decide what the correct part-of-speech tag is for a word, you have to know its context and how to interpret it based on the context. Another way to choose a tag is to give each word the tag that it is most commonly associated with. This will then serve as a baseline for any more sophisticated algorithm. That's what we're going to do here.</p>
</div>
<div class="outline-4" id="outline-container-orgc1bbe8f">
<h4 id="orgc1bbe8f">Processed vs Vocabulary</h4>
<div class="outline-text-4" id="text-orgc1bbe8f">
<p>Our <code>preprocessed</code> data is the words in the testing data and our <code>vocabulary</code> data is the words in the training set. We can't predict anything for the words in the testing set that aren't in the training set so let's see how much of an overlap there is.</p>
<div class="highlight">
<pre><span></span><span class="n">preprocessed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">test_words</span><span class="p">)</span>
<span class="n">vocabulary</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>

<span class="n">in_common</span> <span class="o">=</span> <span class="n">preprocessed</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y in x: </span><span class="si">{</span><span class="mi">100</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_common</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">preprocessed</span><span class="p">)</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> %"</span><span class="p">)</span>
</pre></div>
<pre class="example">
y in x: 100.000 %
</pre>
<p>So, we shouldn't lose any words just because we never saw them during training.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">processed_training</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
<pre class="example">
[('In', 'IN'), ('an', 'DT')]
</pre>
<p>Our <code>processed_training</code> attribute is a list of <code>&lt;word&gt;, &lt;tag&gt;</code> tuples from the training set.</p>
<div class="highlight">
<pre><span></span><span class="n">words_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">processed_training</span><span class="p">)</span>
<span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">words_tags</span><span class="p">]</span>
<span class="n">word_tag_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
</pre></div>
<p><code>word_tag_counts</code> is the count of the number of tags each word had.</p>
<div class="highlight">
<pre><span></span><span class="n">unambiguous</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span><span class="n">count</span> <span class="ow">in</span> <span class="n">word_tag_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Percent of unambiguous training words: "</span>
      <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="mi">100</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unambiguous</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">word_tag_counts</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Percent of unambiguous training words: 75.11 %
</pre>
<p>And now for the subset that is in both the training and testing set.</p>
<div class="highlight">
<pre><span></span><span class="n">common_unambiguous</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unambiguous</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">in_common</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"percent of words in common that are unambiguous:"</span>
      <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">common_unambiguous</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">in_common</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2"> .2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
percent of words in common that are unambiguous: 58.19
</pre>
<p>Sort of low.</p>
<p>This means that if we just labeled the unambiguous words we'd be right about 58% of the time. Let's just double-check.</p>
<div class="highlight">
<pre><span></span><span class="n">guesses</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">tag</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">test_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">unambiguous</span><span class="p">}</span>

<span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">preprocessed</span><span class="p">)</span>
<span class="n">correct_guess</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">preprocessed</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">guesses</span><span class="p">:</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">guesses</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
        <span class="n">correct_guess</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">loader</span><span class="o">.</span><span class="n">test_data</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">continue</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Correct: </span><span class="si">{</span><span class="mi">100</span> <span class="o">*</span> <span class="n">correct_guess</span><span class="o">/</span><span class="n">total</span><span class="si">:</span><span class="s2"> 0.2f</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Correct:  58.17%
</pre>
<p>So this is the amount we get if we just use the unambiguous words. Our baseline should be even better.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org36d8652">
<h3 id="org36d8652">The Baseline Implementation</h3>
<div class="outline-text-3" id="text-org36d8652">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict_pos</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">emission_counts</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Input: </span>
<span class="sd">       prep: a preprocessed version of 'y'. A list with the 'word' component of the tuples.</span>
<span class="sd">       y: a corpus composed of a list of tuples where each tuple consists of (word, POS)</span>
<span class="sd">       emission_counts: a dictionary where the keys are (tag,word) tuples and the value is the count</span>
<span class="sd">       vocab: a dictionary where keys are words in vocabulary and value is an index</span>
<span class="sd">       states: a sorted list of all possible tags for this assignment</span>
<span class="sd">    Output: </span>
<span class="sd">       accuracy: Number of times you classified a word correctly</span>
<span class="sd">    '''</span>

    <span class="c1"># Initialize the number of correct predictions to zero</span>
    <span class="n">num_correct</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Get the (tag, word) tuples, stored as a set</span>
    <span class="n">all_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">emission_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Get the number of (word, POS) tuples in the corpus 'y'</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">y_tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> 

        <span class="c1"># Split the (word, POS) string into a list of two items</span>
        <span class="n">y_tup_l</span> <span class="o">=</span> <span class="n">y_tup</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1"># Verify that y_tup contain both word and POS</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_tup_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>

            <span class="c1"># Set the true POS label for this word</span>
            <span class="n">true_label</span> <span class="o">=</span> <span class="n">y_tup_l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the y_tup didn't contain word and POS, go to next word</span>
            <span class="k">continue</span>

        <span class="n">count_final</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pos_final</span> <span class="o">=</span> <span class="s1">''</span>

        <span class="c1"># If the word is in the vocabulary...</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>

            <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>

                <span class="c1"># define the key as the tuple containing the POS and word</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

                <span class="c1"># check if the (pos, word) key exists in the emission_counts dictionary</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">emission_counts</span><span class="p">:</span> <span class="c1"># complete this line</span>
                <span class="c1"># get the emission count of the (pos,word) tuple </span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">emission_counts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="c1"># keep track of the POS with the largest count</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">count_final</span><span class="p">:</span> <span class="c1"># complete this line</span>
                        <span class="c1"># update the final count (largest count)</span>
                        <span class="n">count_final</span> <span class="o">=</span> <span class="n">count</span>

                        <span class="c1"># update the final POS</span>
                        <span class="n">pos_final</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="c1"># If the final POS (with the largest count) matches the true POS:</span>
            <span class="k">if</span> <span class="n">true_label</span> <span class="o">==</span> <span class="n">pos_final</span><span class="p">:</span> <span class="c1"># complete this line</span>
                <span class="c1"># Update the number of correct predictions</span>
                <span class="n">num_correct</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1">### END CODE HERE ###</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">num_correct</span> <span class="o">/</span> <span class="n">total</span>

    <span class="k">return</span> <span class="n">accuracy</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">states</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">accuracy_predict_pos</span> <span class="o">=</span> <span class="n">predict_pos</span><span class="p">(</span><span class="n">prep</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">test_words</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">test_data_raw</span><span class="p">,</span>
                                   <span class="n">emission_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">emission_counts</span><span class="p">,</span>
                                   <span class="n">vocab</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Accuracy of prediction using predict_pos is </span><span class="si">{</span><span class="n">accuracy_predict_pos</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Accuracy of prediction using predict_pos is 0.8913
</pre>
<p>So our baseline prediction is 89% - any algorithm we create should do as well or better (but probably better for it to be worth doing).</p>
</div>
</div>
<div class="outline-3" id="outline-container-org8163616">
<h3 id="org8163616">Take Two</h3>
<div class="outline-text-3" id="text-org8163616">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">preprocessed</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">emission_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">"""Calculate the baseline accuracy</span>
<span class="sd">    Args: </span>
<span class="sd">       preprocessed: a preprocessed version of 'y'. A list with the 'word' component of the tuples.</span>
<span class="sd">       y: a corpus composed of a list of tuples where each tuple consists of (word, POS)</span>
<span class="sd">       emission_counts: a dictionary where the keys are (tag,word) tuples and the value is the count</span>
<span class="sd">       vocabulary: a dictionary where keys are words in vocabulary and value is an index</span>
<span class="sd">       states: a sorted list of all possible tags for this assignment</span>

<span class="sd">    Returns: </span>
<span class="sd">       accuracy: Number of times you classified a word correctly</span>
<span class="sd">    """</span>
    <span class="c1"># filter (``preprocessed`` has unknown words replaced by special tags so we</span>
    <span class="c1"># need to use it to filter separately from the words in ``y``)</span>
    <span class="c1"># because using the raw word instead of the special tag will throw away</span>
    <span class="c1"># the row but we tagged it specifically to keep it</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">preprocessed</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
              <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">)]</span>

    <span class="c1"># our final data sets    </span>
    <span class="n">true_tags</span> <span class="o">=</span> <span class="p">(</span><span class="n">tag</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">)</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">)</span>

    <span class="c1"># each guess is the POS tag for the word with the highest occurrence in the training data</span>
    <span class="n">guesses</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">max</span><span class="p">((</span><span class="n">emission_counts</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">pos</span><span class="p">,</span> <span class="n">word</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">states</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>

    <span class="c1"># accuracy is sum of correct guesses/total rows in y</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
        <span class="n">actual</span> <span class="o">==</span> <span class="n">guess</span> <span class="k">for</span> <span class="n">actual</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">guess</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">true_tags</span><span class="p">,</span> <span class="n">guesses</span><span class="p">))</span>
            <span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">states</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">preprocessed</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">test_words</span><span class="p">,</span>
                   <span class="n">y</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">test_data_tuples</span><span class="p">,</span>
                   <span class="n">emission_counts</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">emission_counts</span><span class="p">,</span>
                   <span class="n">vocabulary</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">,</span>
                   <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Accuracy of prediction using predict_pos is </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Accuracy of prediction using predict_pos is 0.8921
</pre></div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/parts-of-speech-tagging-training/">Parts-of-Speech Tagging: Training</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/parts-of-speech-tagging-training/" rel="bookmark"><time class="published dt-published" datetime="2020-11-16T21:23:21-08:00" itemprop="datePublished" title="2020-11-16 21:23">2020-11-16 21:23</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgd48acca">Beginning</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#org9b1d338">Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgee12f56">Set Up</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#org69f14d2">The Environment</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgaa57bed">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#org0540c2c">Training</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#org96c9b49">Preprocessing</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgd68557e">Transition counts</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#org022ac99">Emission counts</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgc90a375">Tag counts</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#org2f808ad">Bundle It Up</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#org9d1521f">Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#org8971f4b">The Trainer</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgec040a7">Transition Counts</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgb9c9c33">Emission Counts</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orga7f58fc">Tag Counts</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgfbf33cd">Test It Out</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgaee9400">Tag Counts</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgebe8ecf">Transition Counts</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#org8de01e5">Emission Counts</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/#orgde1c8f1">Ambiuguous Word Emission Counts</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgd48acca">
<h2 id="orgd48acca">Beginning</h2>
<div class="outline-text-2" id="text-orgd48acca"></div>
<div class="outline-3" id="outline-container-org9b1d338">
<h3 id="org9b1d338">Imports</h3>
<div class="outline-text-3" id="text-org9b1d338">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="c1"># this repository</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.parts_of_speech.preprocessing</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">DataLoader</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgee12f56">
<h3 id="orgee12f56">Set Up</h3>
<div class="outline-text-3" id="text-orgee12f56"></div>
<div class="outline-4" id="outline-container-org69f14d2">
<h4 id="org69f14d2">The Environment</h4>
<div class="outline-text-4" id="text-org69f14d2">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgaa57bed">
<h4 id="orgaa57bed">The Data</h4>
<div class="outline-text-4" id="text-orgaa57bed">
<div class="highlight">
<pre><span></span><span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0540c2c">
<h2 id="org0540c2c">Training</h2>
<div class="outline-text-2" id="text-org0540c2c">
<p>In this section, you will find the words that are not ambiguous.</p>
<ul class="org-ul">
<li>For example, the word <code>is</code> is a verb and it is not ambiguous.</li>
<li>In the <code>WSJ</code> corpus, <i>86%</i> of the tokens are unambiguous (meaning they have only one tag)</li>
<li>About <i>14%</i> <i>are</i> ambiguous (meaning that they have more than one tag)</li>
</ul>
<p>Before you start predicting the tags of each word, you will need to compute a few dictionaries that will help you to generate the tables.</p>
</div>
<div class="outline-3" id="outline-container-org96c9b49">
<h3 id="org96c9b49">Preprocessing</h3>
<div class="outline-text-3" id="text-org96c9b49">
<p>For some idiotic reason instead of pre-processing the training corpus with the rest of the data they make a call on each entry in the first graded function. Since the grader checks literal code rather than the output of the code I'll have to make those calls here too (until I pass and get rid of it).</p>
<div class="highlight">
<pre><span></span><span class="c1"># replace the next three code blocks once the assignment is done</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="n">punct</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>
<span class="n">noun_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"action"</span><span class="p">,</span> <span class="s2">"age"</span><span class="p">,</span> <span class="s2">"ance"</span><span class="p">,</span> <span class="s2">"cy"</span><span class="p">,</span> <span class="s2">"dom"</span><span class="p">,</span> <span class="s2">"ee"</span><span class="p">,</span> <span class="s2">"ence"</span><span class="p">,</span> <span class="s2">"er"</span><span class="p">,</span> <span class="s2">"hood"</span><span class="p">,</span> <span class="s2">"ion"</span><span class="p">,</span> <span class="s2">"ism"</span><span class="p">,</span> <span class="s2">"ist"</span><span class="p">,</span> <span class="s2">"ity"</span><span class="p">,</span> <span class="s2">"ling"</span><span class="p">,</span> <span class="s2">"ment"</span><span class="p">,</span> <span class="s2">"ness"</span><span class="p">,</span> <span class="s2">"or"</span><span class="p">,</span> <span class="s2">"ry"</span><span class="p">,</span> <span class="s2">"scape"</span><span class="p">,</span> <span class="s2">"ship"</span><span class="p">,</span> <span class="s2">"ty"</span><span class="p">]</span>
<span class="n">verb_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ate"</span><span class="p">,</span> <span class="s2">"ify"</span><span class="p">,</span> <span class="s2">"ise"</span><span class="p">,</span> <span class="s2">"ize"</span><span class="p">]</span>
<span class="n">adj_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"able"</span><span class="p">,</span> <span class="s2">"ese"</span><span class="p">,</span> <span class="s2">"ful"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"ian"</span><span class="p">,</span> <span class="s2">"ible"</span><span class="p">,</span> <span class="s2">"ic"</span><span class="p">,</span> <span class="s2">"ish"</span><span class="p">,</span> <span class="s2">"ive"</span><span class="p">,</span> <span class="s2">"less"</span><span class="p">,</span> <span class="s2">"ly"</span><span class="p">,</span> <span class="s2">"ous"</span><span class="p">]</span>
<span class="n">adv_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ward"</span><span class="p">,</span> <span class="s2">"wards"</span><span class="p">,</span> <span class="s2">"wise"</span><span class="p">]</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_word_tag</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vocab</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">"""splits line and handles unknowns and empty lines</span>


<span class="sd">    Args:</span>
<span class="sd">     line: whitespace separated string with word and tag</span>
<span class="sd">     vocab: hashable that holds the known words</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="n">word</span> <span class="o">=</span> <span class="s2">"--n--"</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s2">"--s--"</span>
        <span class="k">return</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">:</span> 
            <span class="c1"># Handle unknown words</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">assign_unk</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span>
    <span class="k">return</span> <span class="kc">None</span> 
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">assign_unk</span><span class="p">(</span><span class="n">tok</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Assign unknown word tokens</span>
<span class="sd">    """</span>
    <span class="c1"># Digits</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_digit--"</span>

    <span class="c1"># Punctuation</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span> <span class="ow">in</span> <span class="n">punct</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_punct--"</span>

    <span class="c1"># Upper-case</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_upper--"</span>

    <span class="c1"># Nouns</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">noun_suffix</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_noun--"</span>

    <span class="c1"># Verbs</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">verb_suffix</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_verb--"</span>

    <span class="c1"># Adjectives</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">adj_suffix</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_adj--"</span>

    <span class="c1"># Adverbs</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">adv_suffix</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_adv--"</span>

    <span class="k">return</span> <span class="s2">"--unk--"</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd68557e">
<h3 id="orgd68557e">Transition counts</h3>
<div class="outline-text-3" id="text-orgd68557e">
<ul class="org-ul">
<li>The first dictionary is the <code>transition_counts</code> dictionary which computes the number of times each tag happened next to another tag.</li>
</ul>
<p>This dictionary will be used to compute: \[ P(t_i |t_{i-1}) \]</p>
<p>This is the probability of a tag at position <i>i</i> given the tag at position <i>i-1</i>.</p>
<p>In order for you to compute equation 1, you will create a <code>transition_counts</code> dictionary where</p>
<ul class="org-ul">
<li>The keys are <code>(prev_tag, tag)</code></li>
<li>The values are the number of times those two tags appeared in that order.</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org022ac99">
<h3 id="org022ac99">Emission counts</h3>
<div class="outline-text-3" id="text-org022ac99">
<p>The second dictionary you will compute is the <code>emission_counts</code> dictionary. This dictionary will be used to compute:</p>
<p>\[ P(w_i|t_i) \]</p>
<p>In other words, you will use it to compute the probability of a word given its tag.</p>
<p>In order for you to compute equation 2, you will create an <code>emission_counts</code> dictionary where</p>
<ul class="org-ul">
<li>The keys are <code>(tag, word)</code></li>
<li>The values are the number of times that pair showed up in your training set.</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgc90a375">
<h3 id="orgc90a375">Tag counts</h3>
<div class="outline-text-3" id="text-orgc90a375">
<p>The last dictionary you will compute is the <code>tag_counts</code> dictionary.</p>
<ul class="org-ul">
<li>The key is the tag</li>
<li>The value is the number of times each tag appeared.</li>
</ul>
<div class="highlight">
<pre><span></span> <span class="k">def</span> <span class="nf">create_dictionaries</span><span class="p">(</span><span class="n">training_corpus</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">vocab</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
     <span class="sd">"""Creat the three training dictionaries</span>

<span class="sd">     Args: </span>
<span class="sd">        ``training_corpus``: a corpus where each line has a word followed by its tag.</span>
<span class="sd">        ``vocab``: a dictionary where keys are words in vocabulary and value is an index</span>
<span class="sd">     Returns: </span>
<span class="sd">        ``emission_counts``: a dictionary where the keys are (tag, word) and the values are the counts</span>
<span class="sd">        ``transition_counts``: a dictionary where the keys are (prev_tag, tag) and the values are the counts</span>
<span class="sd">        ``tag_counts``: a dictionary where the keys are the tags and the values are the counts</span>
<span class="sd">     """</span>

     <span class="c1"># initialize the dictionaries using defaultdict</span>
     <span class="n">emission_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
     <span class="n">transition_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
     <span class="n">tag_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

     <span class="c1"># Initialize "prev_tag" (previous tag) with the start state, denoted by '--s--'</span>
     <span class="n">prev_tag</span> <span class="o">=</span> <span class="s1">'--s--'</span> 

     <span class="c1"># use 'i' to track the line number in the corpus</span>
     <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> 

     <span class="c1"># Each item in the training corpus contains a word and its POS tag</span>
     <span class="c1"># Go through each word and its tag in the training corpus</span>
     <span class="k">for</span> <span class="n">word_tag</span> <span class="ow">in</span> <span class="n">training_corpus</span><span class="p">:</span>

         <span class="c1"># Increment the word_tag count</span>
         <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

         <span class="c1"># Every 50,000 words, print the word count</span>
         <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">50000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"word count = </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

         <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>
         <span class="c1"># get the word and tag using the get_word_tag helper function (imported from utils_pos.py)</span>
         <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">get_word_tag</span><span class="p">(</span><span class="n">word_tag</span><span class="p">,</span> <span class="n">vocab</span><span class="p">)</span>

         <span class="c1"># Increment the transition count for the previous word and tag</span>
         <span class="n">transition_counts</span><span class="p">[(</span><span class="n">prev_tag</span><span class="p">,</span> <span class="n">tag</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

         <span class="c1"># Increment the emission count for the tag and word</span>
         <span class="n">emission_counts</span><span class="p">[(</span><span class="n">tag</span><span class="p">,</span> <span class="n">word</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

         <span class="c1"># Increment the tag count</span>
         <span class="n">tag_counts</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

         <span class="c1"># Set the previous tag to this tag (for the next iteration of the loop)</span>
         <span class="n">prev_tag</span> <span class="o">=</span> <span class="n">tag</span>

         <span class="c1">### END CODE HERE ###</span>

     <span class="k">return</span> <span class="n">emission_counts</span><span class="p">,</span> <span class="n">transition_counts</span><span class="p">,</span> <span class="n">tag_counts</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">emission_counts</span><span class="p">,</span> <span class="n">transition_counts</span><span class="p">,</span> <span class="n">tag_counts</span> <span class="o">=</span> <span class="n">create_dictionaries</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">training_corpus</span><span class="p">,</span> <span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
</pre></div>
<p>Get all the POS states.</p>
<div class="highlight">
<pre><span></span><span class="n">states</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tag_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of POS tags (number of 'states'): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"View these POS tags (states)"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>

<span class="n">expected_states</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'#'</span><span class="p">,</span> <span class="s1">'$'</span><span class="p">,</span> <span class="s2">"''"</span><span class="p">,</span> <span class="s1">'('</span><span class="p">,</span> <span class="s1">')'</span><span class="p">,</span> <span class="s1">','</span><span class="p">,</span> <span class="s1">'--s--'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">':'</span><span class="p">,</span> <span class="s1">'CC'</span><span class="p">,</span> <span class="s1">'CD'</span><span class="p">,</span> <span class="s1">'DT'</span><span class="p">,</span> <span class="s1">'EX'</span><span class="p">,</span> <span class="s1">'FW'</span><span class="p">,</span> <span class="s1">'IN'</span><span class="p">,</span> <span class="s1">'JJ'</span><span class="p">,</span> <span class="s1">'JJR'</span><span class="p">,</span> <span class="s1">'JJS'</span><span class="p">,</span> <span class="s1">'LS'</span><span class="p">,</span> <span class="s1">'MD'</span><span class="p">,</span> <span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'NNP'</span><span class="p">,</span> <span class="s1">'NNPS'</span><span class="p">,</span> <span class="s1">'NNS'</span><span class="p">,</span> <span class="s1">'PDT'</span><span class="p">,</span> <span class="s1">'POS'</span><span class="p">,</span> <span class="s1">'PRP'</span><span class="p">,</span> <span class="s1">'PRP$'</span><span class="p">,</span> <span class="s1">'RB'</span><span class="p">,</span> <span class="s1">'RBR'</span><span class="p">,</span> <span class="s1">'RBS'</span><span class="p">,</span> <span class="s1">'RP'</span><span class="p">,</span> <span class="s1">'SYM'</span><span class="p">,</span> <span class="s1">'TO'</span><span class="p">,</span> <span class="s1">'UH'</span><span class="p">,</span> <span class="s1">'VB'</span><span class="p">,</span> <span class="s1">'VBD'</span><span class="p">,</span> <span class="s1">'VBG'</span><span class="p">,</span> <span class="s1">'VBN'</span><span class="p">,</span> <span class="s1">'VBP'</span><span class="p">,</span> <span class="s1">'VBZ'</span><span class="p">,</span> <span class="s1">'WDT'</span><span class="p">,</span> <span class="s1">'WP'</span><span class="p">,</span> <span class="s1">'WP$'</span><span class="p">,</span> <span class="s1">'WRB'</span><span class="p">,</span> <span class="s1">'``'</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">expected_states</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">states</span><span class="p">))</span>
<span class="k">for</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected_states</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">expected</span> <span class="o">==</span> <span class="n">actual</span><span class="p">,</span> <span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">46</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>    
</pre></div>
<pre class="example">
Number of POS tags (number of 'states'): 45
View these POS tags (states)
['#', '$', "''", '(', ')', ',', '.', ':', 'CC', 'CD', 'DT', 'EX', 'FW', 'IN', 'JJ', 'JJR', 'JJS', 'LS', 'MD', 'NN', 'NNP', 'NNPS', 'NNS', 'PDT', 'POS', 'PRP', 'PRP$', 'RB', 'RBR', 'RBS', 'RP', 'SYM', 'TO', 'UH', 'VB', 'VBD', 'VBG', 'VBN', 'VBP', 'VBZ', 'WDT', 'WP', 'WP$', 'WRB', '``']
{'--s--'}
</pre>
<pre class="example">
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
&lt;ipython-input-29-299deb6488d2&gt; in &lt;module&gt;
      8 print(set(expected_states) - set(states))
      9 for expected, actual in zip(expected_states, states):
---&gt; 10     assert expected == actual, (expected, actual)
     11 assert len(states) == 46, len(states)

AssertionError: ('--s--', '.')
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"transition examples: "</span><span class="p">)</span>
<span class="n">expected</span> <span class="o">=</span> <span class="p">(((</span><span class="s1">'--s--'</span><span class="p">,</span> <span class="s1">'IN'</span><span class="p">),</span> <span class="mi">5050</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'IN'</span><span class="p">,</span> <span class="s1">'DT'</span><span class="p">),</span> <span class="mi">32364</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'DT'</span><span class="p">,</span> <span class="s1">'NNP'</span><span class="p">),</span> <span class="mi">9044</span><span class="p">))</span>

<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">transition_counts</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="mi">3</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">example</span> <span class="o">==</span> <span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></div>
<pre class="example">
transition examples: 
(('--s--', 'IN'), 5050)
(('IN', 'DT'), 32364)
(('DT', 'NNP'), 9044)
</pre>
<div class="highlight">
<pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="p">(((</span><span class="s1">'DT'</span><span class="p">,</span> <span class="s1">'any'</span><span class="p">),</span> <span class="mi">721</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'decrease'</span><span class="p">),</span> <span class="mi">7</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'insider-trading'</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"emission examples: "</span><span class="p">)</span>
<span class="k">for</span> <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">emission_counts</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">200</span><span class="p">:</span><span class="mi">203</span><span class="p">],</span> <span class="n">expected</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">actual</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span>
</pre></div>
<pre class="example">
emission examples: 
(('DT', 'any'), 721)
(('NN', 'decrease'), 7)
(('NN', 'insider-trading'), 5)
</pre>
<div class="highlight">
<pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="p">(((</span><span class="s1">'RB'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">304</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'VB'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">20</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'RP'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">84</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'JJ'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">25</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">29</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'VBP'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"ambiguous word example: "</span><span class="p">)</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">tup</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">emission_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'back'</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tup</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">expected</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">tup</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
<pre class="example">
ambiguous word example: 
('RB', 'back') 304
('VB', 'back') 20
('RP', 'back') 84
('JJ', 'back') 25
('NN', 'back') 29
('VBP', 'back') 4
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org2f808ad">
<h2 id="org2f808ad">Bundle It Up</h2>
<div class="outline-text-2" id="text-org2f808ad">
<div class="highlight">
<pre><span></span><span class="o">&lt;&lt;</span><span class="n">imports</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">trainer</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">transition</span><span class="o">-</span><span class="n">counts</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">emission</span><span class="o">-</span><span class="n">counts</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">tag</span><span class="o">-</span><span class="n">counts</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-org9d1521f">
<h3 id="org9d1521f">Imports</h3>
<div class="outline-text-3" id="text-org9d1521f">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org8971f4b">
<h3 id="org8971f4b">The Trainer</h3>
<div class="outline-text-3" id="text-org8971f4b">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TheTrainer</span><span class="p">:</span>
    <span class="sd">"""Trains the POS model</span>

<span class="sd">    Args:</span>
<span class="sd">     corpus: iterable of word, tag tuples</span>
<span class="sd">    """</span>
    <span class="n">corpus</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">_transition_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_emission_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tag_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgec040a7">
<h4 id="orgec040a7">Transition Counts</h4>
<div class="outline-text-4" id="text-orgec040a7">
<p>This dictionary will be used to compute: \[ P(t_i |t_{i-1}) \]</p>
<p>This is the probability of a tag at position <i>i</i> given the tag at position <i>i-1</i>.</p>
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">transition_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""maps previous, next tags to counts"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transition_counts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transition_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">previous_tag</span> <span class="o">=</span> <span class="s2">"--s--"</span>
        <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">corpus</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transition_counts</span><span class="p">[(</span><span class="n">previous_tag</span><span class="p">,</span> <span class="n">tag</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">previous_tag</span> <span class="o">=</span> <span class="n">tag</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transition_counts</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb9c9c33">
<h4 id="orgb9c9c33">Emission Counts</h4>
<div class="outline-text-4" id="text-orgb9c9c33">
<p>The second dictionary you will compute is the <code>emission_counts</code> dictionary. This dictionary will be used to compute:</p>
<p>\[ P(w_i|t_i) \]</p>
<p>In other words, you will use it to compute the probability of a word given its tag.</p>
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">emission_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""Maps tag, word pairs to counts"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission_counts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emission_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
            <span class="p">((</span><span class="n">tag</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">corpus</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission_counts</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga7f58fc">
<h4 id="orga7f58fc">Tag Counts</h4>
<div class="outline-text-4" id="text-orga7f58fc">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tag_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""Count of tags"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag_counts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">((</span><span class="n">tag</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">corpus</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag_counts</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgfbf33cd">
<h3 id="orgfbf33cd">Test It Out</h3>
<div class="outline-text-3" id="text-orgfbf33cd">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.parts_of_speech.training</span> <span class="kn">import</span> <span class="n">TheTrainer</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">TheTrainer</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">processed_training</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgaee9400">
<h4 id="orgaee9400">Tag Counts</h4>
<div class="outline-text-4" id="text-orgaee9400">
<div class="highlight">
<pre><span></span><span class="n">states</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">tag_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of POS tags (number of 'states'): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"View these POS tags (states)"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">46</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
<span class="n">expected_states</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'#'</span><span class="p">,</span> <span class="s1">'$'</span><span class="p">,</span> <span class="s2">"''"</span><span class="p">,</span> <span class="s1">'('</span><span class="p">,</span> <span class="s1">')'</span><span class="p">,</span> <span class="s1">','</span><span class="p">,</span> <span class="s1">'--s--'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">':'</span><span class="p">,</span> <span class="s1">'CC'</span><span class="p">,</span> <span class="s1">'CD'</span><span class="p">,</span> <span class="s1">'DT'</span><span class="p">,</span> <span class="s1">'EX'</span><span class="p">,</span> <span class="s1">'FW'</span><span class="p">,</span> <span class="s1">'IN'</span><span class="p">,</span> <span class="s1">'JJ'</span><span class="p">,</span> <span class="s1">'JJR'</span><span class="p">,</span> <span class="s1">'JJS'</span><span class="p">,</span> <span class="s1">'LS'</span><span class="p">,</span> <span class="s1">'MD'</span><span class="p">,</span> <span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'NNP'</span><span class="p">,</span> <span class="s1">'NNPS'</span><span class="p">,</span> <span class="s1">'NNS'</span><span class="p">,</span> <span class="s1">'PDT'</span><span class="p">,</span> <span class="s1">'POS'</span><span class="p">,</span> <span class="s1">'PRP'</span><span class="p">,</span> <span class="s1">'PRP$'</span><span class="p">,</span> <span class="s1">'RB'</span><span class="p">,</span> <span class="s1">'RBR'</span><span class="p">,</span> <span class="s1">'RBS'</span><span class="p">,</span> <span class="s1">'RP'</span><span class="p">,</span> <span class="s1">'SYM'</span><span class="p">,</span> <span class="s1">'TO'</span><span class="p">,</span> <span class="s1">'UH'</span><span class="p">,</span> <span class="s1">'VB'</span><span class="p">,</span> <span class="s1">'VBD'</span><span class="p">,</span> <span class="s1">'VBG'</span><span class="p">,</span> <span class="s1">'VBN'</span><span class="p">,</span> <span class="s1">'VBP'</span><span class="p">,</span> <span class="s1">'VBZ'</span><span class="p">,</span> <span class="s1">'WDT'</span><span class="p">,</span> <span class="s1">'WP'</span><span class="p">,</span> <span class="s1">'WP$'</span><span class="p">,</span> <span class="s1">'WRB'</span><span class="p">,</span> <span class="s1">'``'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected_states</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">expected</span> <span class="o">==</span> <span class="n">actual</span>
</pre></div>
<pre class="example">
Number of POS tags (number of 'states'): 46
View these POS tags (states)
['#', '$', "''", '(', ')', ',', '--s--', '.', ':', 'CC', 'CD', 'DT', 'EX', 'FW', 'IN', 'JJ', 'JJR', 'JJS', 'LS', 'MD', 'NN', 'NNP', 'NNPS', 'NNS', 'PDT', 'POS', 'PRP', 'PRP$', 'RB', 'RBR', 'RBS', 'RP', 'SYM', 'TO', 'UH', 'VB', 'VBD', 'VBG', 'VBN', 'VBP', 'VBZ', 'WDT', 'WP', 'WP$', 'WRB', '``']
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgebe8ecf">
<h4 id="orgebe8ecf">Transition Counts</h4>
<div class="outline-text-4" id="text-orgebe8ecf">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"transition examples: "</span><span class="p">)</span>
<span class="n">expected</span> <span class="o">=</span> <span class="p">(((</span><span class="s1">'--s--'</span><span class="p">,</span> <span class="s1">'IN'</span><span class="p">),</span> <span class="mi">5050</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'IN'</span><span class="p">,</span> <span class="s1">'DT'</span><span class="p">),</span> <span class="mi">32364</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'DT'</span><span class="p">,</span> <span class="s1">'NNP'</span><span class="p">),</span> <span class="mi">9044</span><span class="p">))</span>

<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">transition_counts</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="mi">3</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">example</span> <span class="o">==</span> <span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></div>
<pre class="example">
transition examples: 
(('--s--', 'IN'), 5050)
(('IN', 'DT'), 32364)
(('DT', 'NNP'), 9044)
</pre></div>
</div>
<div class="outline-4" id="outline-container-org8de01e5">
<h4 id="org8de01e5">Emission Counts</h4>
<div class="outline-text-4" id="text-org8de01e5">
<div class="highlight">
<pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="p">(((</span><span class="s1">'DT'</span><span class="p">,</span> <span class="s1">'any'</span><span class="p">),</span> <span class="mi">721</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'decrease'</span><span class="p">),</span> <span class="mi">7</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'insider-trading'</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"emission examples: "</span><span class="p">)</span>
<span class="k">for</span> <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">emission_counts</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">200</span><span class="p">:</span><span class="mi">203</span><span class="p">],</span> <span class="n">expected</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">actual</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span>
</pre></div>
<pre class="example">
emission examples: 
(('DT', 'any'), 721)
(('NN', 'decrease'), 7)
(('NN', 'insider-trading'), 5)
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgde1c8f1">
<h4 id="orgde1c8f1">Ambiuguous Word Emission Counts</h4>
<div class="outline-text-4" id="text-orgde1c8f1">
<div class="highlight">
<pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="p">(((</span><span class="s1">'RB'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">304</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'VB'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">20</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'RP'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">84</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'JJ'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">25</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">29</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">'VBP'</span><span class="p">,</span> <span class="s1">'back'</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"ambiguous word example: "</span><span class="p">)</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">tag_word</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">trainer</span><span class="o">.</span><span class="n">emission_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">tag_word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'back'</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tag_word</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">expected</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">tag_word</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
<pre class="example">
ambiguous word example: 
('RB', 'back') 304
('VB', 'back') 20
('RP', 'back') 84
('JJ', 'back') 25
('NN', 'back') 29
('VBP', 'back') 4
</pre></div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/parts-of-speech-tagging-the-data/">Parts-of-Speech Tagging: The Data</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/parts-of-speech-tagging-the-data/" rel="bookmark"><time class="published dt-published" datetime="2020-11-15T16:18:03-08:00" itemprop="datePublished" title="2020-11-15 16:18">2020-11-15 16:18</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orga5cd035">Beginning</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orge2d0ac6">Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgaf6ef08">Set Up</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org25d8696">The Environment</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgd7387b0">Middle</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org9adbb23">The Training Corpus</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org129caff">The Vocabulary</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org9ed861a">The Test Corpus</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org4785708">The Test Vocabulary</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org5258261">Handle Empty</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgddc6826">Labeling Unknowns</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org236f967">The Pre-Processor</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgd97af93">Load the Test Words</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org51d07f7">End</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgcc1d215">The Code</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgddd657e">Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgdb85a26">The Environment</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org7eb812b">The Suffixes</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orge24d914">The Label</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org625e945">Theirs To Ours</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgf680cc4">The Unknown</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orge407e0a">The Empty</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org968aa69">The Corpus Pre-Processor</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgd14f7d4">The Data Pre-Processor</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orge348ceb">The Data Loader</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org707f6a4">The Preprocessor</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org39f9cbc">The Vocabulary Words</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org920b277">The Vocabulary</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org3c8f1e9">The Training Corpus</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org0fe6a50">The Training Data</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org737b526">Processed Training</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org1fde5a1">The Raw Test Corpus</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgf41aa70">The Raw Test Tuples</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org21f102a">Test Words</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org7376aeb">Load Method</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orge5aff28">Test it Out</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgb1e0ed1">Re-Test</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org73f2a4a">The Vocabulary</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#orgeedd577">Vocabulary Word</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/#org5173c1b">The Preprocessed Test Words</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orga5cd035">
<h2 id="orga5cd035">Beginning</h2>
<div class="outline-text-2" id="text-orga5cd035"></div>
<div class="outline-3" id="outline-container-orge2d0ac6">
<h3 id="orge2d0ac6">Imports</h3>
<div class="outline-text-3" id="text-orge2d0ac6">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgaf6ef08">
<h3 id="orgaf6ef08">Set Up</h3>
<div class="outline-text-3" id="text-orgaf6ef08"></div>
<div class="outline-4" id="outline-container-org25d8696">
<h4 id="org25d8696">The Environment</h4>
<div class="outline-text-4" id="text-org25d8696">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">Environment</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">training_corpus</span><span class="o">=</span><span class="s2">"WALL_STREET_JOURNAL_POS"</span><span class="p">,</span>
    <span class="n">vocabulary</span><span class="o">=</span><span class="s2">"WALL_STREET_JOURNAL_VOCABULARY"</span><span class="p">,</span>
    <span class="n">test_corpus</span><span class="o">=</span> <span class="s2">"WALL_STREET_JOURNAL_TEST_POS"</span><span class="p">,</span>
    <span class="n">test_words</span><span class="o">=</span><span class="s2">"WALL_STREET_JOURNAL_TEST_WORDS"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgd7387b0">
<h2 id="orgd7387b0">Middle</h2>
<div class="outline-text-2" id="text-orgd7387b0"></div>
<div class="outline-3" id="outline-container-org9adbb23">
<h3 id="org9adbb23">The Training Corpus</h3>
<div class="outline-text-3" id="text-org9adbb23">
<p>The training corpus is made up of words and parts-of-speech tags from the Wall Street Journal (previously looked at in <a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/">this post</a>).</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">Environment</span><span class="o">.</span><span class="n">training_corpus</span><span class="p">])</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">training_corpus</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">training_corpus</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
- In    IN
- an    DT
- Oct.  NNP
- 19    CD
- review        NN
</pre></div>
</div>
<div class="outline-3" id="outline-container-org129caff">
<h3 id="org129caff">The Vocabulary</h3>
<div class="outline-text-3" id="text-org129caff">
<p>There is also a pre-processed version of that same file that has only the words without the parts-of-speech tags that we can load. It has been altered slightly as well:</p>
<ul class="org-ul">
<li>Words that appear only once have been removed</li>
<li>Words that don't exist in the original have been added so that there are some unknown words to handle.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">Environment</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">])</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">vocabulary_words</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">vocabulary_words</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
- !
- #
- $
- %
- &
</pre>
<p>Odd.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">vocabulary_words</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
- cabinet
- Byrd
- done
- Fueling
- investments
</pre>
<p>Our actual vocabulary is going to be a dictionary mapping each word to its index in the list we just loaded.</p>
<div class="highlight">
<pre><span></span><span class="n">vocabulary_words</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vocabulary_words</span><span class="p">)</span>
<span class="n">vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocabulary_words</span><span class="p">)}</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary_words</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">training_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">training_corpus</span><span class="p">])</span>
<span class="n">filtered</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">training_counter</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">extra</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span> <span class="o">-</span> <span class="n">filtered</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
9
 - --unk_adj--
 - --n--
 - --unk--
 - --unk_noun--
 - --unk_adv--
</pre>
<p>So, it looks like the "unknowns" are pre-process tags.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org9ed861a">
<h3 id="org9ed861a">The Test Corpus</h3>
<div class="outline-text-3" id="text-org9ed861a">
<p>This is another list of words taken from the Wall Street Journal with parts-of-speech tags added that we'll use as the test-set.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">Environment</span><span class="o">.</span><span class="n">test_corpus</span><span class="p">])</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">test_corpus</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org4785708">
<h3 id="org4785708">The Test Vocabulary</h3>
<div class="outline-text-3" id="text-org4785708">
<p>There is also a set of words that we're going to try and tag. These need to be pre-processed.</p>
</div>
<div class="outline-4" id="outline-container-org5258261">
<h4 id="org5258261">Handle Empty</h4>
<div class="outline-text-4" id="text-org5258261">
<p>We are going to replace empty lines with a special token.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">handle_empty</span><span class="p">(</span><span class="n">words</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">empty_token</span><span class="o">=</span><span class="s2">"--n--"</span><span class="p">):</span>
    <span class="sd">"""replace empty strings withh empty_token</span>

<span class="sd">    Args:</span>
<span class="sd">     words: list to process</span>
<span class="sd">     empty_token: what to replace empty strings with</span>

<span class="sd">    Yields:</span>
<span class="sd">     processed words</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">empty_token</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">word</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgddc6826">
<h4 id="orgddc6826">Labeling Unknowns</h4>
<div class="outline-text-4" id="text-orgddc6826"></div>
<ul class="org-ul">
<li><a id="org97e2863"></a>Suffixes<br>
<div class="outline-text-5" id="text-org97e2863">
<div class="highlight">
<pre><span></span><span class="n">Suffixes</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">noun</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"action"</span><span class="p">,</span> <span class="s2">"age"</span><span class="p">,</span> <span class="s2">"ance"</span><span class="p">,</span> <span class="s2">"cy"</span><span class="p">,</span> <span class="s2">"dom"</span><span class="p">,</span> <span class="s2">"ee"</span><span class="p">,</span> <span class="s2">"ence"</span><span class="p">,</span> <span class="s2">"er"</span><span class="p">,</span> <span class="s2">"hood"</span><span class="p">,</span>
            <span class="s2">"ion"</span><span class="p">,</span> <span class="s2">"ism"</span><span class="p">,</span> <span class="s2">"ist"</span><span class="p">,</span> <span class="s2">"ity"</span><span class="p">,</span> <span class="s2">"ling"</span><span class="p">,</span> <span class="s2">"ment"</span><span class="p">,</span> <span class="s2">"ness"</span><span class="p">,</span> <span class="s2">"or"</span><span class="p">,</span> <span class="s2">"ry"</span><span class="p">,</span>
            <span class="s2">"scape"</span><span class="p">,</span> <span class="s2">"ship"</span><span class="p">,</span> <span class="s2">"ty"</span><span class="p">],</span>
    <span class="n">verb</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ate"</span><span class="p">,</span> <span class="s2">"ify"</span><span class="p">,</span> <span class="s2">"ise"</span><span class="p">,</span> <span class="s2">"ize"</span><span class="p">],</span>
    <span class="n">adjective</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"able"</span><span class="p">,</span> <span class="s2">"ese"</span><span class="p">,</span> <span class="s2">"ful"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"ian"</span><span class="p">,</span> <span class="s2">"ible"</span><span class="p">,</span> <span class="s2">"ic"</span><span class="p">,</span> <span class="s2">"ish"</span><span class="p">,</span> <span class="s2">"ive"</span><span class="p">,</span>
                 <span class="s2">"less"</span><span class="p">,</span> <span class="s2">"ly"</span><span class="p">,</span> <span class="s2">"ous"</span><span class="p">],</span>
    <span class="n">adverb</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ward"</span><span class="p">,</span> <span class="s2">"wards"</span><span class="p">,</span> <span class="s2">"wise"</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="orgcfede0d"></a>Labels for the Unknowns<br>
<div class="outline-text-5" id="text-orgcfede0d">
<div class="highlight">
<pre><span></span><span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">"--unknown-</span><span class="si">{}</span><span class="s2">--"</span>
<span class="n">Label</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">digit</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"digit"</span><span class="p">),</span>
    <span class="n">punctuation</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"punctuation"</span><span class="p">),</span>
    <span class="n">uppercase</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"uppercase"</span><span class="p">),</span>
    <span class="n">noun</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"noun"</span><span class="p">),</span>    
    <span class="n">verb</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"verb"</span><span class="p">),</span>
    <span class="n">adjective</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adjective"</span><span class="p">),</span>
    <span class="n">adverb</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adverb"</span><span class="p">),</span>
    <span class="n">unknown</span><span class="o">=</span><span class="s2">"--unknown--"</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="org371c071"></a>Bundle Them Up<br>
<div class="outline-text-5" id="text-org371c071">
<div class="highlight">
<pre><span></span><span class="n">Unknown</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">punctuation</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">),</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">Suffixes</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="n">Label</span><span class="p">,</span>
    <span class="n">has_digit</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\d"</span><span class="p">),</span>
    <span class="n">has_uppercase</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">"[A-Z]"</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">label_unknowns</span><span class="p">(</span><span class="n">words</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">set</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Assign tokens to unknown words</span>

<span class="sd">    Args:</span>
<span class="sd">     word: word not in our vocabulary</span>
<span class="sd">     vocabulary: something to check if it is a known word</span>

<span class="sd">    Yields:</span>
<span class="sd">     word or label for the word if unknown</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">word</span>

        <span class="k">elif</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">has_digit</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">digit</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">punctuation</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">word</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">punctuation</span>

        <span class="k">elif</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">has_uppercase</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">uppercase</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">noun</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">noun</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">verb</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">verb</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">adjective</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">adjective</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">adverb</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">adverb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unknown</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org236f967">
<h4 id="org236f967">The Pre-Processor</h4>
<div class="outline-text-4" id="text-org236f967">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">words</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">set</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Preprocess words</span>

<span class="sd">    Args:</span>
<span class="sd">     words: words to pre-process</span>

<span class="sd">    Returns:</span>
<span class="sd">     words with empty lines and unknown words labeled</span>
<span class="sd">    """</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="n">handle_empty</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">label_unknowns</span><span class="p">(</span><span class="n">processed</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">processed</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd97af93">
<h4 id="orgd97af93">Load the Test Words</h4>
<div class="outline-text-4" id="text-orgd97af93">
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">Environment</span><span class="o">.</span><span class="n">test_words</span><span class="p">])</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">test_words</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_words</span><span class="p">)</span>
<span class="n">test_words</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">test_words</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_words</span><span class="p">)</span> <span class="o">==</span> <span class="n">before</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_words</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">test_words</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
180,264
 - --unknown--
 - --n--
 - e
 - r
 - --unknown--
</pre>
<p>Weird that the letters "e" and "r" are known words…</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org51d07f7">
<h2 id="org51d07f7">End</h2>
<div class="outline-text-2" id="text-org51d07f7">
<p>So, that's our data. To make it replicable for the next section I'm going to tangle it out.</p>
<div class="highlight">
<pre><span></span><span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">environment</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">suffixes</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">label</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">theirs</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">mine</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">unknown</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">empty</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">corpus</span><span class="o">-</span><span class="n">processor</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">corpus</span><span class="o">-</span><span class="n">split</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">corpus</span><span class="o">-</span><span class="n">handle</span><span class="o">-</span><span class="n">empty</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">corpus</span><span class="o">-</span><span class="n">unknowns</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">corpus</span><span class="o">-</span><span class="n">call</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">preprocessor</span><span class="o">-</span><span class="n">class</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">handle</span><span class="o">-</span><span class="n">empty</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">label</span><span class="o">-</span><span class="n">unknowns</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">preprocessor</span><span class="o">-</span><span class="n">call</span><span class="o">&gt;&gt;</span>



<span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">loader</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">preprocessor</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">vocabulary</span><span class="o">-</span><span class="n">words</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">training</span><span class="o">-</span><span class="n">corpus</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">training</span><span class="o">-</span><span class="n">data</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">processed</span><span class="o">-</span><span class="n">training</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">vocabulary</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">raw</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">tuples</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">data</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">words</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">load</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgcc1d215">
<h3 id="orgcc1d215">The Code</h3>
<div class="outline-text-3" id="text-orgcc1d215"></div>
<div class="outline-4" id="outline-container-orgddd657e">
<h4 id="orgddd657e">Imports</h4>
<div class="outline-text-4" id="text-orgddd657e">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdb85a26">
<h4 id="orgdb85a26">The Environment</h4>
<div class="outline-text-4" id="text-orgdb85a26">
<p>I don't really know that I should save these keys, but I don't really want to cut and paste all the time…</p>
<div class="highlight">
<pre><span></span><span class="n">Environment</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">training_corpus</span><span class="o">=</span><span class="s2">"WALL_STREET_JOURNAL_POS"</span><span class="p">,</span>
    <span class="n">vocabulary</span><span class="o">=</span><span class="s2">"WALL_STREET_JOURNAL_VOCABULARY"</span><span class="p">,</span>
    <span class="n">test_corpus</span><span class="o">=</span> <span class="s2">"WALL_STREET_JOURNAL_TEST_POS"</span><span class="p">,</span>
    <span class="n">test_words</span><span class="o">=</span><span class="s2">"WALL_STREET_JOURNAL_TEST_WORDS"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7eb812b">
<h4 id="org7eb812b">The Suffixes</h4>
<div class="outline-text-4" id="text-org7eb812b">
<div class="highlight">
<pre><span></span><span class="n">Suffixes</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">noun</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"action"</span><span class="p">,</span> <span class="s2">"age"</span><span class="p">,</span> <span class="s2">"ance"</span><span class="p">,</span> <span class="s2">"cy"</span><span class="p">,</span> <span class="s2">"dom"</span><span class="p">,</span> <span class="s2">"ee"</span><span class="p">,</span> <span class="s2">"ence"</span><span class="p">,</span> <span class="s2">"er"</span><span class="p">,</span> <span class="s2">"hood"</span><span class="p">,</span>
            <span class="s2">"ion"</span><span class="p">,</span> <span class="s2">"ism"</span><span class="p">,</span> <span class="s2">"ist"</span><span class="p">,</span> <span class="s2">"ity"</span><span class="p">,</span> <span class="s2">"ling"</span><span class="p">,</span> <span class="s2">"ment"</span><span class="p">,</span> <span class="s2">"ness"</span><span class="p">,</span> <span class="s2">"or"</span><span class="p">,</span> <span class="s2">"ry"</span><span class="p">,</span>
            <span class="s2">"scape"</span><span class="p">,</span> <span class="s2">"ship"</span><span class="p">,</span> <span class="s2">"ty"</span><span class="p">],</span>
    <span class="n">verb</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ate"</span><span class="p">,</span> <span class="s2">"ify"</span><span class="p">,</span> <span class="s2">"ise"</span><span class="p">,</span> <span class="s2">"ize"</span><span class="p">],</span>
    <span class="n">adjective</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"able"</span><span class="p">,</span> <span class="s2">"ese"</span><span class="p">,</span> <span class="s2">"ful"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"ian"</span><span class="p">,</span> <span class="s2">"ible"</span><span class="p">,</span> <span class="s2">"ic"</span><span class="p">,</span> <span class="s2">"ish"</span><span class="p">,</span> <span class="s2">"ive"</span><span class="p">,</span>
                 <span class="s2">"less"</span><span class="p">,</span> <span class="s2">"ly"</span><span class="p">,</span> <span class="s2">"ous"</span><span class="p">],</span>
    <span class="n">adverb</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ward"</span><span class="p">,</span> <span class="s2">"wards"</span><span class="p">,</span> <span class="s2">"wise"</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge24d914">
<h4 id="orge24d914">The Label</h4>
<div class="outline-text-4" id="text-orge24d914">
<div class="highlight">
<pre><span></span><span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">"--unknown-</span><span class="si">{}</span><span class="s2">--"</span>
<span class="n">Label</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">digit</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"digit"</span><span class="p">),</span>
    <span class="n">punctuation</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"punctuation"</span><span class="p">),</span>
    <span class="n">uppercase</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"uppercase"</span><span class="p">),</span>
    <span class="n">noun</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"noun"</span><span class="p">),</span>    
    <span class="n">verb</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"verb"</span><span class="p">),</span>
    <span class="n">adjective</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adjective"</span><span class="p">),</span>
    <span class="n">adverb</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adverb"</span><span class="p">),</span>
    <span class="n">unknown</span><span class="o">=</span><span class="s2">"--unknown--"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org625e945">
<h4 id="org625e945">Theirs To Ours</h4>
<div class="outline-text-4" id="text-org625e945">
<p>The vocabulary file has their unknown tags alreads inserted which don't matnch mine so, rather than redoing everything I'm going to translate theirs to match mine.</p>
<div class="highlight">
<pre><span></span><span class="n">THEIR_UNKNOWN</span> <span class="o">=</span> <span class="s2">"--unk_</span><span class="si">{}</span><span class="s2">--"</span>

<span class="n">THEIRS_TO_MINE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"--unk--"</span><span class="p">:</span> <span class="s2">"--unknown--"</span><span class="p">,</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"digit"</span><span class="p">):</span> <span class="n">Label</span><span class="o">.</span><span class="n">digit</span><span class="p">,</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"punct"</span><span class="p">):</span> <span class="n">Label</span><span class="o">.</span><span class="n">punctuation</span><span class="p">,</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"upper"</span><span class="p">):</span> <span class="n">Label</span><span class="o">.</span><span class="n">uppercase</span><span class="p">,</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"noun"</span><span class="p">):</span> <span class="n">Label</span><span class="o">.</span><span class="n">noun</span><span class="p">,</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"verb"</span><span class="p">):</span> <span class="n">Label</span><span class="o">.</span><span class="n">verb</span><span class="p">,</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adj"</span><span class="p">):</span> <span class="n">Label</span><span class="o">.</span><span class="n">adjective</span><span class="p">,</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adv"</span><span class="p">):</span> <span class="n">Label</span><span class="o">.</span><span class="n">adverb</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf680cc4">
<h4 id="orgf680cc4">The Unknown</h4>
<div class="outline-text-4" id="text-orgf680cc4">
<div class="highlight">
<pre><span></span><span class="n">Unknown</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">punctuation</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">),</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">Suffixes</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="n">Label</span><span class="p">,</span>
    <span class="n">has_digit</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\d"</span><span class="p">),</span>
    <span class="n">has_uppercase</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">"[A-Z]"</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge407e0a">
<h4 id="orge407e0a">The Empty</h4>
<div class="outline-text-4" id="text-orge407e0a">
<div class="highlight">
<pre><span></span><span class="n">Empty</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">word</span><span class="o">=</span><span class="s2">"--n--"</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">"--s--"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org968aa69">
<h4 id="org968aa69">The Corpus Pre-Processor</h4>
<div class="outline-text-4" id="text-org968aa69">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CorpusProcessor</span><span class="p">:</span>
    <span class="sd">"""Pre-processes the corpus</span>

<span class="sd">    Args:</span>
<span class="sd">     vocabulary: holder of our known words</span>
<span class="sd">    """</span>
    <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">dict</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org1fb5b60"></a>Split Tuples<br>
<div class="outline-text-5" id="text-org1fb5b60">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">split_tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">"""Generates tuples</span>

<span class="sd">    Args:</span>
<span class="sd">     lines: iterable of lines from the corpus</span>

<span class="sd">    Yields:</span>
<span class="sd">     whitespace split of line</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org11c0d22"></a>Handle Empty Lines<br>
<div class="outline-text-5" id="text-org11c0d22">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">handle_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuples</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">"""checks for empty strings</span>

<span class="sd">    Args:</span>
<span class="sd">     tuples: tuples of corpus lines</span>

<span class="sd">    Yields:</span>
<span class="sd">     line with empty string marked</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Empty</span><span class="o">.</span><span class="n">word</span><span class="p">,</span> <span class="n">Empty</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">line</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org721d054"></a>Handle Unknowns<br>
<div class="outline-text-5" id="text-org721d054">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">label_unknowns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuples</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Assign tokens to unknown words</span>

<span class="sd">    Args:</span>
<span class="sd">     tuples: word, tag tuples</span>

<span class="sd">    Yields:</span>
<span class="sd">     (word (or label for the word if unknown), tag) tuple</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span>

        <span class="k">elif</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">has_digit</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">digit</span><span class="p">,</span> <span class="n">tag</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">punctuation</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">word</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">punctuation</span><span class="p">,</span> <span class="n">tag</span>

        <span class="k">elif</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">has_uppercase</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">uppercase</span><span class="p">,</span> <span class="n">tag</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">noun</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">noun</span><span class="p">,</span> <span class="n">tag</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">verb</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">verb</span><span class="p">,</span> <span class="n">tag</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">adjective</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">adjective</span><span class="p">,</span> <span class="n">tag</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">adverb</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">adverb</span><span class="p">,</span> <span class="n">tag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unknown</span><span class="p">,</span> <span class="n">tag</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="orgdc491fa"></a>The Call<br>
<div class="outline-text-5" id="text-orgdc491fa">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuples</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""preprocesses the words and tags</span>

<span class="sd">    Args:</span>
<span class="sd">     tuples: list of words and tags to process</span>

<span class="sd">    Returns:</span>
<span class="sd">     preprocessed version of words, tags</span>
<span class="sd">    """</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_tuples</span><span class="p">(</span><span class="n">tuples</span><span class="p">)</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_empty</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_unknowns</span><span class="p">(</span><span class="n">processed</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">processed</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orgd14f7d4">
<h4 id="orgd14f7d4">The Data Pre-Processor</h4>
<div class="outline-text-4" id="text-orgd14f7d4">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataPreprocessor</span><span class="p">:</span>
    <span class="sd">"""A pre-processor for the data</span>

<span class="sd">    Args:</span>
<span class="sd">     vocabulary: holder of our known words</span>
<span class="sd">     empty_token: what to use if a line is an empty string</span>
<span class="sd">    """</span>
    <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">dict</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org5ce6756"></a>Handle Empty Lines<br>
<div class="outline-text-5" id="text-org5ce6756">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">handle_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">"""replace empty strings withh empty_token</span>

<span class="sd">    Args:</span>
<span class="sd">     words: list to process</span>
<span class="sd">     empty_token: what to replace empty strings with</span>

<span class="sd">    Yields:</span>
<span class="sd">     processed words</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">Empty</span><span class="o">.</span><span class="n">word</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">word</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org9af0bcc"></a>Label Unknowns<br>
<div class="outline-text-5" id="text-org9af0bcc">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">label_unknowns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Assign tokens to unknown words</span>

<span class="sd">    Args:</span>
<span class="sd">     words: iterable of words to check</span>

<span class="sd">    Yields:</span>
<span class="sd">     word or label for the word if unknown</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">word</span>

        <span class="k">elif</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">has_digit</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">digit</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">punctuation</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">word</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">punctuation</span>

        <span class="k">elif</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">has_uppercase</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">uppercase</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">noun</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">noun</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">verb</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">verb</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">adjective</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">adjective</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">adverb</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">adverb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unknown</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="orgcc2e8b9"></a>The Call<br>
<div class="outline-text-5" id="text-orgcc2e8b9">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""preprocesses the words</span>

<span class="sd">    Args:</span>
<span class="sd">     words: list of words to process</span>

<span class="sd">    Returns:</span>
<span class="sd">     preprocessed version of words</span>
<span class="sd">    """</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_empty</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_unknowns</span><span class="p">(</span><span class="n">processed</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">processed</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orge348ceb">
<h4 id="orge348ceb">The Data Loader</h4>
<div class="outline-text-4" id="text-orge348ceb">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataLoader</span><span class="p">:</span>
    <span class="sd">"""Loads the training and test data</span>

<span class="sd">    Args:</span>
<span class="sd">     environment: namespace with keys for the environment to load paths</span>
<span class="sd">    """</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">Namespace</span><span class="o">=</span><span class="n">Environment</span>
    <span class="n">_preprocess</span><span class="p">:</span> <span class="n">DataPreprocessor</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vocabulary_words</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_training_corpus</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_training_data</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_processed_training</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_test_data_raw</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_test_data_tuples</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_test_data</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_test_words</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org707f6a4">
<h4 id="org707f6a4">The Preprocessor</h4>
<div class="outline-text-4" id="text-org707f6a4">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataPreprocessor</span><span class="p">:</span>
    <span class="sd">"""The Preprocessor for the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span> <span class="o">=</span> <span class="n">DataPreprocessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org39f9cbc">
<h4 id="org39f9cbc">The Vocabulary Words</h4>
<div class="outline-text-4" id="text-org39f9cbc">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary_words</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The list of vocabulary words for training</span>

<span class="sd">    Note:</span>
<span class="sd">     This is ``hmm_vocab.txt``</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary_words</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">THEIRS_TO_MINE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary_words</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org920b277">
<h4 id="org920b277">The Vocabulary</h4>
<div class="outline-text-4" id="text-org920b277">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""Converts the vocabulary list of words to a dict</span>

<span class="sd">    Returns:</span>
<span class="sd">     word : index of word in vocabulary words&gt; dictionary</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">word</span><span class="p">:</span> <span class="n">index</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary_words</span><span class="p">))}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3c8f1e9">
<h4 id="org3c8f1e9">The Training Corpus</h4>
<div class="outline-text-4" id="text-org3c8f1e9">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">training_corpus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The corpus for training</span>

<span class="sd">    Note:</span>
<span class="sd">     ``WSJ_02_20.pos`` lines (&lt;word&gt;&lt;tab&gt;&lt;pos&gt; all as one string)</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_corpus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_corpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">training_corpus</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_corpus</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0fe6a50">
<h4 id="org0fe6a50">The Training Data</h4>
<div class="outline-text-4" id="text-org0fe6a50">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""The word-tag training data</span>

<span class="sd">    Note:</span>
<span class="sd">     this is the ``training_corpus`` converted to a &lt;word&gt;:&lt;pos&gt; dictionary</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">words_tags</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_corpus</span><span class="p">)</span>
        <span class="n">words_tags</span> <span class="o">=</span> <span class="p">(</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">words_tags</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">tag</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">words_tags</span><span class="p">}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_data</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org737b526">
<h4 id="org737b526">Processed Training</h4>
<div class="outline-text-4" id="text-org737b526">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">processed_training</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Pre-processes the training corpus</span>

<span class="sd">    Note:</span>
<span class="sd">     ``training_corpus`` converted to (word, tag) tuples with unknown tags added</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processed_training</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">processor</span> <span class="o">=</span> <span class="n">CorpusProcessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processed_training</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_corpus</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processed_training</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1fde5a1">
<h4 id="org1fde5a1">The Raw Test Corpus</h4>
<div class="outline-text-4" id="text-org1fde5a1">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">test_data_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The lines for testing</span>

<span class="sd">    Note:</span>
<span class="sd">     The assignment expects the lines to be un-processed so this is just the</span>
<span class="sd">    raw lines from ``WSJ_24.pos``</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_data_raw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_data_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">test_corpus</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_data_raw</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf41aa70">
<h4 id="orgf41aa70">The Raw Test Tuples</h4>
<div class="outline-text-4" id="text-orgf41aa70">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">test_data_tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The test data lines split into tuples</span>

<span class="sd">    Note:</span>
<span class="sd">     this is the test_data_raw with the lines split</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_data_tuples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_data_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_raw</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_data_tuples</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org21f102a">
<h4 id="org21f102a">Test Words</h4>
<div class="outline-text-4" id="text-org21f102a">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">test_words</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The pre-processed test words</span>

<span class="sd">    Note:</span>
<span class="sd">     ``test.words`` with some pre-processing done</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_words</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">test_words</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_words</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_words</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7376aeb">
<h4 id="org7376aeb">Load Method</h4>
<div class="outline-text-4" id="text-org7376aeb">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">keep_empty</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Loads the strings from the file</span>

<span class="sd">    Args:</span>
<span class="sd">     path: path to the text file</span>
<span class="sd">     keep_empty: keep empty lines if true</span>

<span class="sd">    Returns:</span>
<span class="sd">     list of lines from the file</span>
<span class="sd">    """</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">keep_empty</span> <span class="ow">or</span> <span class="n">line</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">lines</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orge5aff28">
<h3 id="orge5aff28">Test it Out</h3>
<div class="outline-text-3" id="text-orge5aff28">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.parts_of_speech.preprocessing</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">theirs</span><span class="p">,</span> <span class="n">mine</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vocabulary_words</span><span class="p">,</span> <span class="n">loader</span><span class="o">.</span><span class="n">vocabulary_words</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">theirs</span> <span class="o">==</span> <span class="n">mine</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">theirs</span><span class="p">,</span> <span class="n">mine</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">,</span> <span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">vocabulary</span><span class="p">[</span><span class="n">theirs</span><span class="p">]</span> <span class="o">==</span> <span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">mine</span><span class="p">]</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">Environment</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary_words</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary_words</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary_words</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary_words</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">training_corpus</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">training_corpus</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_corpus</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">training_corpus</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">test_corpus</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">test_corpus</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_corpus</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">test_corpus</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">test_words</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">test_words</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
<pre class="example">
23,777
['Island', 'Gibbons']

989,861
['nine\tCD', 'in\tIN']

23,777

34,200
['at\tIN', 'to\tTO']

34,200
['the', ';']
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgb1e0ed1">
<h3 id="orgb1e0ed1">Re-Test</h3>
<div class="outline-text-3" id="text-orgb1e0ed1">
<p>I'm trying to troubleshoot differences between my output and the original notebook.</p>
<div class="highlight">
<pre><span></span><span class="n">punct</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>

<span class="n">noun_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"action"</span><span class="p">,</span> <span class="s2">"age"</span><span class="p">,</span> <span class="s2">"ance"</span><span class="p">,</span> <span class="s2">"cy"</span><span class="p">,</span> <span class="s2">"dom"</span><span class="p">,</span> <span class="s2">"ee"</span><span class="p">,</span> <span class="s2">"ence"</span><span class="p">,</span> <span class="s2">"er"</span><span class="p">,</span> <span class="s2">"hood"</span><span class="p">,</span> <span class="s2">"ion"</span><span class="p">,</span> <span class="s2">"ism"</span><span class="p">,</span> <span class="s2">"ist"</span><span class="p">,</span> <span class="s2">"ity"</span><span class="p">,</span> <span class="s2">"ling"</span><span class="p">,</span> <span class="s2">"ment"</span><span class="p">,</span> <span class="s2">"ness"</span><span class="p">,</span> <span class="s2">"or"</span><span class="p">,</span> <span class="s2">"ry"</span><span class="p">,</span> <span class="s2">"scape"</span><span class="p">,</span> <span class="s2">"ship"</span><span class="p">,</span> <span class="s2">"ty"</span><span class="p">]</span>
<span class="n">verb_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ate"</span><span class="p">,</span> <span class="s2">"ify"</span><span class="p">,</span> <span class="s2">"ise"</span><span class="p">,</span> <span class="s2">"ize"</span><span class="p">]</span>
<span class="n">adj_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"able"</span><span class="p">,</span> <span class="s2">"ese"</span><span class="p">,</span> <span class="s2">"ful"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"ian"</span><span class="p">,</span> <span class="s2">"ible"</span><span class="p">,</span> <span class="s2">"ic"</span><span class="p">,</span> <span class="s2">"ish"</span><span class="p">,</span> <span class="s2">"ive"</span><span class="p">,</span> <span class="s2">"less"</span><span class="p">,</span> <span class="s2">"ly"</span><span class="p">,</span> <span class="s2">"ous"</span><span class="p">]</span>
<span class="n">adv_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ward"</span><span class="p">,</span> <span class="s2">"wards"</span><span class="p">,</span> <span class="s2">"wise"</span><span class="p">]</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">data_fp</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Preprocess data</span>
<span class="sd">    """</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prep</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Read data</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_fp</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_file</span><span class="p">):</span>

            <span class="c1"># End of sentence</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">word</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="n">orig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">word</span> <span class="o">=</span> <span class="s2">"--n--"</span>
                <span class="n">prep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Handle unknown words</span>
            <span class="k">elif</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">:</span>
                <span class="n">orig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="c1"># this seems like a bug</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">assign_unk</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

                <span class="c1"># this makes it work better, but isn't in their code</span>
                <span class="c1"># word = assign_unk(word.strip())</span>
                <span class="n">prep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">orig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">prep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">data_fp</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()))</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prep</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">data_fp</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">orig</span><span class="p">,</span> <span class="n">prep</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">assign_unk</span><span class="p">(</span><span class="n">tok</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Assign unknown word tokens</span>
<span class="sd">    """</span>
    <span class="c1"># Digits</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_digit--"</span>

    <span class="c1"># Punctuation</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span> <span class="ow">in</span> <span class="n">punct</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_punct--"</span>

    <span class="c1"># Upper-case</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_upper--"</span>

    <span class="c1"># Nouns</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">noun_suffix</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_noun--"</span>

    <span class="c1"># Verbs</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">verb_suffix</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_verb--"</span>

    <span class="c1"># Adjectives</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">adj_suffix</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_adj--"</span>

    <span class="c1"># Adverbs</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">adv_suffix</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"--unk_adv--"</span>

    <span class="k">return</span> <span class="s2">"--unk--"</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">Environment</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org73f2a4a">
<h4 id="org73f2a4a">The Vocabulary</h4>
<div class="outline-text-4" id="text-org73f2a4a">
<div class="highlight">
<pre><span></span><span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">"--unknown-</span><span class="si">{}</span><span class="s2">--"</span>
<span class="n">THEIR_UNKNOWN</span> <span class="o">=</span> <span class="s2">"--unk_</span><span class="si">{}</span><span class="s2">--"</span>

<span class="n">THEIRS_TO_MINE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"--unk--"</span><span class="p">:</span> <span class="s2">"--unknown--"</span><span class="p">,</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"digit"</span><span class="p">):</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"digit"</span><span class="p">),</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"punct"</span><span class="p">):</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"punctuation"</span><span class="p">),</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"upper"</span><span class="p">):</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"uppercase"</span><span class="p">),</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"noun"</span><span class="p">):</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"noun"</span><span class="p">),</span>    
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"verb"</span><span class="p">):</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"verb"</span><span class="p">),</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adj"</span><span class="p">):</span> <span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adjective"</span><span class="p">),</span>
    <span class="n">THEIR_UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adv"</span><span class="p">):</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adverb"</span><span class="p">),</span>    
<span class="p">}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">Environment</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">])</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">voc_l</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">theirs</span><span class="p">,</span> <span class="n">mine</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">voc_l</span><span class="p">,</span> <span class="n">loader</span><span class="o">.</span><span class="n">vocabulary_words</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">THEIRS_TO_MINE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">theirs</span><span class="p">,</span> <span class="n">theirs</span><span class="p">)</span><span class="o">==</span><span class="n">mine</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">theirs</span><span class="p">,</span> <span class="n">mine</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgeedd577">
<h4 id="orgeedd577">Vocabulary Word</h4>
<div class="outline-text-4" id="text-orgeedd577">
<p>They include empty strings so the dictionaries won't match exactly.</p>
<div class="highlight">
<pre><span></span><span class="n">vocab</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">voc_l</span><span class="p">)):</span>
    <span class="n">vocab</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>

<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">THEIRS_TO_MINE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5173c1b">
<h4 id="org5173c1b">The Preprocessed Test Words</h4>
<div class="outline-text-4" id="text-org5173c1b">
<div class="highlight">
<pre><span></span><span class="n">original</span><span class="p">,</span> <span class="n">prep</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">Environment</span><span class="o">.</span><span class="n">test_words</span><span class="p">])</span>

<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">theirs</span><span class="p">,</span> <span class="n">mine</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="n">loader</span><span class="o">.</span><span class="n">test_words</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">THEIRS_TO_MINE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">theirs</span><span class="p">,</span> <span class="n">theirs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mine</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">original</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">theirs</span><span class="p">,</span> <span class="n">mine</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">assign_unk</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
<pre class="example">
9 --unk-- --unknown-noun-- vantage --unk_noun--
228 --unk-- --unknown-verb-- exacerbate --unk_verb--
845 --unk-- --unknown-adjective-- relentless --unk_adj--
896 --unk-- --unknown-adjective-- slickly --unk_adj--
906 --unk-- --unknown-adjective-- cognoscenti --unk_adj--
919 --unk-- --unknown-noun-- depiction --unk_noun--
1076 --unk-- --unknown-adjective-- perfidious --unk_adj--
1160 --unk-- --unknown-adjective-- innocently --unk_adj--
1196 --unk-- --unknown-adjective-- loutish --unk_adj--
1244 --unk-- --unknown-verb-- premise --unk_verb--
1268 --unk-- --unknown-adjective-- conspicuously --unk_adj--
1331 --unk-- --unknown-noun-- ignition --unk_noun--
1347 --unk-- --unknown-noun-- obligatory --unk_noun--
1448 --unk-- --unknown-adjective-- lavishly --unk_adj--
1468 --unk-- --unknown-adjective-- palatable --unk_adj--
1564 --unk-- --unknown-adjective-- inconsiderable --unk_adj--
1678 --unk-- --unknown-adjective-- discreetly --unk_adj--
1774 --unk-- --unknown-adjective-- marvelously --unk_adj--
1855 --unk-- --unknown-adjective-- passable --unk_adj--
1970 --unk-- --unknown-noun-- diaper --unk_noun--
3248 --unk-- --unknown-adjective-- comparably --unk_adj--
3672 --unk-- --unknown-noun-- imperialism --unk_noun--
3791 --unk-- --unknown-noun-- livelier --unk_noun--
3793 --unk-- --unknown-noun-- bolder --unk_noun--
4132 --unk-- --unknown-noun-- intimidation --unk_noun--
4648 --unk-- --unknown-adjective-- politic --unk_adj--
4661 --unk-- --unknown-verb-- mutate --unk_verb--
4682 --unk-- --unknown-noun-- aspersion --unk_noun--
4777 --unk-- --unknown-adjective-- utopian --unk_adj--
4802 --unk-- --unknown-adjective-- psychic --unk_adj--
4892 --unk-- --unknown-noun-- coercion --unk_noun--
5043 --unk-- --unknown-noun-- centrist --unk_noun--
5090 --unk-- --unknown-noun-- schooling --unk_noun--
5131 --unk-- --unknown-noun-- voucher --unk_noun--
5270 --unk-- --unknown-noun-- recruitment --unk_noun--
5316 --unk-- --unknown-noun-- expansionism --unk_noun--
5429 --unk-- --unknown-verb-- palate --unk_verb--
5440 --unk-- --unknown-noun-- engorgement --unk_noun--
5557 --unk-- --unknown-noun-- patronage --unk_noun--
5912 --unk-- --unknown-noun-- volunteerism --unk_noun--
5990 --unk-- --unknown-adjective-- utopian --unk_adj--
6709 --unk-- --unknown-noun-- citizenship --unk_noun--
6738 --unk-- --unknown-noun-- abomination --unk_noun--
6793 --unk-- --unknown-adjective-- reflexively --unk_adj--
6809 --unk-- --unknown-noun-- regimentation --unk_noun--
6876 --unk-- --unknown-noun-- compulsory --unk_noun--
7150 --unk-- --unknown-adjective-- arguably --unk_adj--
7192 --unk-- --unknown-noun-- compulsion --unk_noun--
7208 --unk-- --unknown-adjective-- unenforceable --unk_adj--
7374 --unk-- --unknown-noun-- recruitment --unk_noun--
7468 --unk-- --unknown-adjective-- challengeable --unk_adj--
7591 --unk-- --unknown-adjective-- unprecedentedly --unk_adj--
7657 --unk-- --unknown-adjective-- cooperatively --unk_adj--
8182 --unk-- --unknown-noun-- reticence --unk_noun--
8772 --unk-- --unknown-noun-- render --unk_noun--
11071 --unk-- --unknown-noun-- breather --unk_noun--
11942 --unk-- --unknown-verb-- unify --unk_verb--
12859 --unk-- --unknown-verb-- frigate --unk_verb--
12907 --unk-- --unknown-noun-- disarmament --unk_noun--
12936 --unk-- --unknown-noun-- affinity --unk_noun--
13240 --unk-- --unknown-verb-- patriarchate --unk_verb--
13438 --unk-- --unknown-noun-- underselling --unk_noun--
13650 --unk-- --unknown-adjective-- wrathful --unk_adj--
13725 --unk-- --unknown-noun-- gist --unk_noun--
14081 --unk-- --unknown-noun-- segmentation --unk_noun--
14110 --unk-- --unknown-adjective-- brightly --unk_adj--
15331 --unk-- --unknown-noun-- connector --unk_noun--
17846 --unk-- --unknown-noun-- readjustment --unk_noun--
18397 --unk-- --unknown-noun-- observation --unk_noun--
18410 --unk-- --unknown-noun-- ticker --unk_noun--
18566 --unk-- --unknown-noun-- trickery --unk_noun--
18750 --unk-- --unknown-adjective-- supersonic --unk_adj--
18854 --unk-- --unknown-noun-- existance --unk_noun--
18885 --unk-- --unknown-adjective-- thankfully --unk_adj--
19011 --unk-- --unknown-noun-- coherence --unk_noun--
19304 --unk-- --unknown-adjective-- autocratic --unk_adj--
19305 --unk-- --unknown-noun-- pseudosocialism --unk_noun--
19326 --unk-- --unknown-noun-- encircling --unk_noun--
19389 --unk-- --unknown-noun-- miscegenation --unk_noun--
19470 --unk-- --unknown-adjective-- ostensible --unk_adj--
19479 --unk-- --unknown-adjective-- purportedly --unk_adj--
19554 --unk-- --unknown-noun-- accuser --unk_noun--
19568 --unk-- --unknown-noun-- embezzler --unk_noun--
19961 --unk-- --unknown-adjective-- unwittingly --unk_adj--
19970 --unk-- --unknown-noun-- platter --unk_noun--
20129 --unk-- --unknown-noun-- centrist --unk_noun--
20384 --unk-- --unknown-adjective-- improbable --unk_adj--
20472 --unk-- --unknown-adjective-- glaringly --unk_adj--
20493 --unk-- --unknown-noun-- clarity --unk_noun--
20496 --unk-- --unknown-noun-- rectification --unk_noun--
20539 --unk-- --unknown-noun-- wiser --unk_noun--
21215 --unk-- --unknown-adjective-- concurrently --unk_adj--
21310 --unk-- --unknown-verb-- revolutionize --unk_verb--
22257 --unk-- --unknown-noun-- compensatory --unk_noun--
22270 --unk-- --unknown-noun-- respiratory --unk_noun--
23603 --unk-- --unknown-noun-- milion --unk_noun--
23928 --unk-- --unknown-noun-- poultry --unk_noun--
23947 --unk-- --unknown-noun-- cessation --unk_noun--
24005 --unk-- --unknown-noun-- mothballing --unk_noun--
24168 --unk-- --unknown-noun-- synthesizer --unk_noun--
24195 --unk-- --unknown-adjective-- distinctly --unk_adj--
24280 --unk-- --unknown-noun-- synthesizer --unk_noun--
24293 --unk-- --unknown-adjective-- robotic --unk_adj--
24294 --unk-- --unknown-noun-- flatness --unk_noun--
24861 --unk-- --unknown-noun-- carnage --unk_noun--
25248 --unk-- --unknown-adjective-- frantic --unk_adj--
25252 --unk-- --unknown-noun-- hammer --unk_noun--
26001 --unk-- --unknown-noun-- whisper --unk_noun--
27468 --unk-- --unknown-noun-- prophecy --unk_noun--
27538 --unk-- --unknown-noun-- encircling --unk_noun--
27716 --unk-- --unknown-verb-- realestate --unk_verb--
27994 --unk-- --unknown-noun-- insolvency --unk_noun--
28110 --unk-- --unknown-adjective-- forceful --unk_adj--
28195 --unk-- --unknown-adjective-- zealous --unk_adj--
28485 --unk-- --unknown-adjective-- belatedly --unk_adj--
29370 --unk-- --unknown-verb-- duplicate --unk_verb--
29902 --unk-- --unknown-adjective-- reptilian --unk_adj--
30078 --unk-- --unknown-noun-- industrialization --unk_noun--
31292 --unk-- --unknown-adjective-- vociferous --unk_adj--
31303 --unk-- --unknown-adjective-- powerless --unk_adj--
31549 --unk-- --unknown-noun-- provocation --unk_noun--
31648 --unk-- --unknown-adjective-- archaic --unk_adj--
31700 --unk-- --unknown-noun-- lament --unk_noun--
32149 --unk-- --unknown-adjective-- tantalizingly --unk_adj--
32393 --unk-- --unknown-noun-- hammer --unk_noun--
33208 --unk-- --unknown-adjective-- defiantly --unk_adj--
33238 --unk-- --unknown-noun-- rickety --unk_noun--
33280 --unk-- --unknown-noun-- unionist --unk_noun--
33336 --unk-- --unknown-noun-- dapper --unk_noun--
33721 --unk-- --unknown-adjective-- repressive --unk_adj--
33832 --unk-- --unknown-noun-- disillusionment --unk_noun--
33861 --unk-- --unknown-noun-- agitation --unk_noun--
</pre>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">(</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">vocabulary_words</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"--u"</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</pre></div>
<pre class="example">
--unknown--
--unknown-adjective--
--unknown-adverb--
--unknown-digit--
--unknown-noun--
--unknown-punctuation--
--unknown-uppercase--
--unknown-verb--
</pre></div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/parts-of-speech-tagging/">Parts-of-Speech Tagging</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/parts-of-speech-tagging/" rel="bookmark"><time class="published dt-published" datetime="2020-11-15T15:59:44-08:00" itemprop="datePublished" title="2020-11-15 15:59">2020-11-15 15:59</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging/#orgbc376be">Beginning</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging/#orgfb283b6">Middle</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging/#orgf33b8cb">End</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging/#org571a010">Raw</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgbc376be">
<h2 id="orgbc376be">Beginning</h2>
<div class="outline-text-2" id="text-orgbc376be">
<ul class="org-ul">
<li><a href="posts/nlp/parts-of-speech-tagging-the-data/">The Dataset</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-training/">Setting Up the Training</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-most-frequent-class-baseline/">Implementing the Baseline Model</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-hidden-markov-model/">Hidden Markov Model</a></li>
<li><a href="posts/nlp/parts-of-speech-viterbi-algorithm/">Viterbi Algorithm</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgfb283b6">
<h2 id="orgfb283b6">Middle</h2>
</div>
<div class="outline-2" id="outline-container-orgf33b8cb">
<h2 id="orgf33b8cb">End</h2>
</div>
<div class="outline-2" id="outline-container-org571a010">
<h2 id="org571a010">Raw</h2>
<div class="outline-text-2" id="text-org571a010">
<pre class="example">

# &lt;a name='1'&gt;&lt;/a&gt;
# # Part 1: Parts-of-speech tagging 
# 
# &lt;a name='1.1'&gt;&lt;/a&gt;

# &lt;a name='1.2'&gt;&lt;/a&gt;

# &lt;a name='2'&gt;&lt;/a&gt;

# &lt;a name='3'&gt;&lt;/a&gt;

# &lt;a name='3.2'&gt;&lt;/a&gt;
# ## Part 3.2 Viterbi Forward
# 
# In this part of the assignment, you will implement the `viterbi_forward` segment. In other words, you will populate your `best_probs` and `best_paths` matrices.
# - Walk forward through the corpus.
# - For each word, compute a probability for each possible tag. 
# - Unlike the previous algorithm `predict_pos` (the 'warm-up' exercise), this will include the path up to that (word,tag) combination. 
# 
# Here is an example with a three-word corpus "Loss tracks upward":
# - Note, in this example, only a subset of states (POS tags) are shown in the diagram below, for easier reading. 
# - In the diagram below, the first word "Loss" is already initialized. 
# - The algorithm will compute a probability for each of the potential tags in the second and future words. 
# 
# Compute the probability that the tag of the second work ('tracks') is a verb, 3rd person singular present (VBZ).  
# - In the `best_probs` matrix, go to the column of the second word ('tracks'), and row 40 (VBZ), this cell is highlighted in light orange in the diagram below.
# - Examine each of the paths from the tags of the first word ('Loss') and choose the most likely path.  
# - An example of the calculation for **one** of those paths is the path from ('Loss', NN) to ('tracks', VBZ).
# - The log of the probability of the path up to and including the first word 'Loss' having POS tag NN is $-14.32$.  The `best_probs` matrix contains this value -14.32 in the column for 'Loss' and row for 'NN'.
# - Find the probability that NN transitions to VBZ.  To find this probability, go to the `A` transition matrix, and go to the row for 'NN' and the column for 'VBZ'.  The value is $4.37e-02$, which is circled in the diagram, so add $-14.32 + log(4.37e-02)$. 
# - Find the log of the probability that the tag VBS would 'emit' the word 'tracks'.  To find this, look at the 'B' emission matrix in row 'VBZ' and the column for the word 'tracks'.  The value $4.61e-04$ is circled in the diagram below.  So add $-14.32 + log(4.37e-02) + log(4.61e-04)$.
# - The sum of $-14.32 + log(4.37e-02) + log(4.61e-04)$ is $-25.13$. Store $-25.13$ in the `best_probs` matrix at row 'VBZ' and column 'tracks' (as seen in the cell that is highlighted in light orange in the diagram).
# - All other paths in best_probs are calculated.  Notice that $-25.13$ is greater than all of the other values in column 'tracks' of matrix `best_probs`, and so the most likely path to 'VBZ' is from 'NN'.  'NN' is in row 20 of the `best_probs` matrix, so $20$ is the most likely path.
# - Store the most likely path $20$ in the `best_paths` table.  This is highlighted in light orange in the diagram below.

# The formula to compute the probability and path for the $i^{th}$ word in the $corpus$, the prior word $i-1$ in the corpus, current POS tag $j$, and previous POS tag $k$ is:
# 
# $\mathrm{prob} = \mathbf{best\_prob}_{k, i-1} + \mathrm{log}(\mathbf{A}_{k, j}) + \mathrm{log}(\mathbf{B}_{j, vocab(corpus_{i})})$
# 
# where $corpus_{i}$ is the word in the corpus at index $i$, and $vocab$ is the dictionary that gets the unique integer that represents a given word.
# 
# $\mathrm{path} = k$
# 
# where $k$ is the integer representing the previous POS tag.
# 

# &lt;a name='ex-06'&gt;&lt;/a&gt;
# 
# ### Exercise 06
# 
# Instructions: Implement the `viterbi_forward` algorithm and store the best_path and best_prob for every possible tag for each word in the matrices `best_probs` and `best_tags` using the pseudo code below.
# 
# `for each word in the corpus
# 
#     for each POS tag type that this word may be
#     
#         for POS tag type that the previous word could be
#         
#             compute the probability that the previous word had a given POS tag, that the current word has a given POS tag, and that the POS tag would emit this current word.
#             
#             retain the highest probability computed for the current word
#             
#             set best_probs to this highest probability
#             
#             set best_paths to the index 'k', representing the POS tag of the previous word which produced the highest probability `
# 
# Please use [math.log](https://docs.python.org/3/library/math.html) to compute the natural logarithm.

# &lt;img src = "Forward4.PNG"/&gt;

# &lt;details&gt;    
# &lt;summary&gt;
#     &lt;font size="3" color="darkgreen"&gt;&lt;b&gt;Hints&lt;/b&gt;&lt;/font&gt;
# &lt;/summary&gt;
# &lt;p&gt;
# &lt;ul&gt;
#     &lt;li&gt;Remember that when accessing emission matrix B, the column index is the unique integer ID associated with the word.  It can be accessed by using the 'vocab' dictionary, where the key is the word, and the value is the unique integer ID for that word.&lt;/li&gt;
# &lt;/ul&gt;
# &lt;/p&gt;
# 

# In[ ]:


# UNQ_C6 (UNIQUE CELL IDENTIFIER, DO NOT EDIT)
# GRADED FUNCTION: viterbi_forward
def viterbi_forward(A, B, test_corpus, best_probs, best_paths, vocab):
    '''
    Input: 
        A, B: The transition and emission matrices respectively
        test_corpus: a list containing a preprocessed corpus
        best_probs: an initilized matrix of dimension (num_tags, len(corpus))
        best_paths: an initilized matrix of dimension (num_tags, len(corpus))
        vocab: a dictionary where keys are words in vocabulary and value is an index 
    Output: 
        best_probs: a completed matrix of dimension (num_tags, len(corpus))
        best_paths: a completed matrix of dimension (num_tags, len(corpus))
    '''
    # Get the number of unique POS tags (which is the num of rows in best_probs)
    num_tags = best_probs.shape[0]
    
    # Go through every word in the corpus starting from word 1
    # Recall that word 0 was initialized in `initialize()`
    for i in range(1, len(test_corpus)): 
        
        # Print number of words processed, every 5000 words
        if i % 5000 == 0:
            print("Words processed: {:&gt;8}".format(i))
            
        ### START CODE HERE (Replace instances of 'None' with your code EXCEPT the first 'best_path_i = None') ###
        # For each unique POS tag that the current word can be
        for j in None: # complete this line
            
            # Initialize best_prob for word i to negative infinity
            best_prob_i = None
            
            # Initialize best_path for current word i to None
            best_path_i = None

            # For each POS tag that the previous word can be:
            for k in None: # complete this line
            
                # Calculate the probability = 
                # best probs of POS tag k, previous word i-1 + 
                # log(prob of transition from POS k to POS j) + 
                # log(prob that emission of POS j is word i)
                prob = None

                # check if this path's probability is greater than
                # the best probability up to and before this point
                if None: # complete this line
                    
                    # Keep track of the best probability
                    best_prob_i = None
                    
                    # keep track of the POS tag of the previous word
                    # that is part of the best path.  
                    # Save the index (integer) associated with 
                    # that previous word's POS tag
                    best_path_i = None

            # Save the best probability for the 
            # given current word's POS tag
            # and the position of the current word inside the corpus
            best_probs[j,i] = None
            
            # Save the unique integer ID of the previous POS tag
            # into best_paths matrix, for the POS tag of the current word
            # and the position of the current word inside the corpus.
            best_paths[j,i] = None

        ### END CODE HERE ###
    return best_probs, best_paths


# Run the `viterbi_forward` function to fill in the `best_probs` and `best_paths` matrices.
# 
# **Note** that this will take a few minutes to run.  There are about 30,000 words to process.

# In[ ]:


# this will take a few minutes to run =&gt; processes ~ 30,000 words
best_probs, best_paths = viterbi_forward(A, B, prep, best_probs, best_paths, vocab)


# In[ ]:


# Test this function 
print(f"best_probs[0,1]: {best_probs[0,1]:.4f}") 
print(f"best_probs[0,4]: {best_probs[0,4]:.4f}") 


# ##### Expected Output
# 
# ```CPP
# best_probs[0,1]: -24.7822
# best_probs[0,4]: -49.5601
# ```

# &lt;a name='3.3'&gt;&lt;/a&gt;
# ## Part 3.3 Viterbi backward
# 
# Now you will implement the Viterbi backward algorithm.
# - The Viterbi backward algorithm gets the predictions of the POS tags for each word in the corpus using the `best_paths` and the `best_probs` matrices.
# 
# The example below shows how to walk backwards through the best_paths matrix to get the POS tags of each word in the corpus. Recall that this example corpus has three words: "Loss tracks upward".
# 
# POS tag for 'upward' is `RB`
# - Select the the most likely POS tag for the last word in the corpus, 'upward' in the `best_prob` table.
# - Look for the row in the column for 'upward' that has the largest probability.
# - Notice that in row 28 of `best_probs`, the estimated probability is -34.99, which is larger than the other values in the column.  So the most likely POS tag for 'upward' is `RB` an adverb, at row 28 of `best_prob`. 
# - The variable `z` is an array that stores the unique integer ID of the predicted POS tags for each word in the corpus.  In array z, at position 2, store the value 28 to indicate that the word 'upward' (at index 2 in the corpus), most likely has the POS tag associated with unique ID 28 (which is `RB`).
# - The variable `pred` contains the POS tags in string form.  So `pred` at index 2 stores the string `RB`.
# 
# 
# POS tag for 'tracks' is `VBZ`
# - The next step is to go backward one word in the corpus ('tracks').  Since the most likely POS tag for 'upward' is `RB`, which is uniquely identified by integer ID 28, go to the `best_paths` matrix in column 2, row 28.  The value stored in `best_paths`, column 2, row 28 indicates the unique ID of the POS tag of the previous word.  In this case, the value stored here is 40, which is the unique ID for POS tag `VBZ` (verb, 3rd person singular present).
# - So the previous word at index 1 of the corpus ('tracks'), most likely has the POS tag with unique ID 40, which is `VBZ`.
# - In array `z`, store the value 40 at position 1, and for array `pred`, store the string `VBZ` to indicate that the word 'tracks' most likely has POS tag `VBZ`.
# 
# POS tag for 'Loss' is `NN`
# - In `best_paths` at column 1, the unique ID stored at row 40 is 20.  20 is the unique ID for POS tag `NN`.
# - In array `z` at position 0, store 20.  In array `pred` at position 0, store `NN`.

# &lt;img src = "Backwards5.PNG"/&gt;

# &lt;a name='ex-07'&gt;&lt;/a&gt;
# ### Exercise 07
# Implement the `viterbi_backward` algorithm, which returns a list of predicted POS tags for each word in the corpus.
# 
# - Note that the numbering of the index positions starts at 0 and not 1. 
# - `m` is the number of words in the corpus.  
#     - So the indexing into the corpus goes from `0` to `m - 1`.
#     - Also, the columns in `best_probs` and `best_paths` are indexed from `0` to `m - 1`
# 
# 
# **In Step 1:**       
# Loop through all the rows (POS tags) in the last entry of `best_probs` and find the row (POS tag) with the maximum value.
# Convert the unique integer ID to a tag (a string representation) using the list `states`.  
# 
# Referring to the three-word corpus described above:
# - `z[2] = 28`: For the word 'upward' at position 2 in the corpus, the POS tag ID is 28.  Store 28 in `z` at position 2.
# - `states[28]` is 'RB': The POS tag ID 28 refers to the POS tag 'RB'.
# - `pred[2] = 'RB'`: In array `pred`, store the POS tag for the word 'upward'.
# 
# **In Step 2:**  
# - Starting at the last column of best_paths, use `best_probs` to find the most likely POS tag for the last word in the corpus.
# - Then use `best_paths` to find the most likely POS tag for the previous word. 
# - Update the POS tag for each word in `z` and in `preds`.
# 
# Referring to the three-word example from above, read best_paths at column 2 and fill in z at position 1.  
# `z[1] = best_paths[z[2],2]`  
# 
# The small test following the routine prints the last few words of the corpus and their states to aid in debug.

# In[ ]:


# UNQ_C7 (UNIQUE CELL IDENTIFIER, DO NOT EDIT)
# GRADED FUNCTION: viterbi_backward
def viterbi_backward(best_probs, best_paths, corpus, states):
    '''
    This function returns the best path.
    
    '''
    # Get the number of words in the corpus
    # which is also the number of columns in best_probs, best_paths
    m = best_paths.shape[1] 
    
    # Initialize array z, same length as the corpus
    z = [None] * m
    
    # Get the number of unique POS tags
    num_tags = best_probs.shape[0]
    
    # Initialize the best probability for the last word
    best_prob_for_last_word = float('-inf')
    
    # Initialize pred array, same length as corpus
    pred = [None] * m
    
    ### START CODE HERE (Replace instances of 'None' with your code) ###
    ## Step 1 ##
    
    # Go through each POS tag for the last word (last column of best_probs)
    # in order to find the row (POS tag integer ID) 
    # with highest probability for the last word
    for k in None: # complete this line

        # If the probability of POS tag at row k 
        # is better than the previously best probability for the last word:
        if None: # complete this line
            
            # Store the new best probability for the lsat word
            best_prob_for_last_word = None
    
            # Store the unique integer ID of the POS tag
            # which is also the row number in best_probs
            z[m - 1] = None
            
    # Convert the last word's predicted POS tag
    # from its unique integer ID into the string representation
    # using the 'states' dictionary
    # store this in the 'pred' array for the last word
    pred[m - 1] = None
    
    ## Step 2 ##
    # Find the best POS tags by walking backward through the best_paths
    # From the last word in the corpus to the 0th word in the corpus
    for i in range(None, None, None): # complete this line
        
        # Retrieve the unique integer ID of
        # the POS tag for the word at position 'i' in the corpus
        pos_tag_for_word_i = None
        
        # In best_paths, go to the row representing the POS tag of word i
        # and the column representing the word's position in the corpus
        # to retrieve the predicted POS for the word at position i-1 in the corpus
        z[i - 1] = None
        
        # Get the previous word's POS tag in string form
        # Use the 'states' dictionary, 
        # where the key is the unique integer ID of the POS tag,
        # and the value is the string representation of that POS tag
        pred[i - 1] = None
        
     ### END CODE HERE ###
    return pred


# In[ ]:


# Run and test your function
pred = viterbi_backward(best_probs, best_paths, prep, states)
m=len(pred)
print('The prediction for pred[-7:m-1] is: \n', prep[-7:m-1], "\n", pred[-7:m-1], "\n")
print('The prediction for pred[0:8] is: \n', pred[0:7], "\n", prep[0:7])


# **Expected Output:**   
# 
# ```CPP
# The prediction for pred[-7:m-1] is:  
#  ['see', 'them', 'here', 'with', 'us', '.']  
#  ['VB', 'PRP', 'RB', 'IN', 'PRP', '.']   
# The prediction for pred[0:8] is:    
#  ['DT', 'NN', 'POS', 'NN', 'MD', 'VB', 'VBN']   
#  ['The', 'economy', "'s", 'temperature', 'will', 'be', 'taken'] 
# ```
# 
# Now you just have to compare the predicted labels to the true labels to evaluate your model on the accuracy metric!

# &lt;a name='4'&gt;&lt;/a&gt;
# # Part 4: Predicting on a data set
# 
# Compute the accuracy of your prediction by comparing it with the true `y` labels. 
# - `pred` is a list of predicted POS tags corresponding to the words of the `test_corpus`. 

# In[ ]:


print('The third word is:', prep[3])
print('Your prediction is:', pred[3])
print('Your corresponding label y is: ', y[3])


# &lt;a name='ex-08'&gt;&lt;/a&gt;
# ### Exercise 08
# 
# Implement a function to compute the accuracy of the viterbi algorithm's POS tag predictions.
# - To split y into the word and its tag you can use `y.split()`. 

# In[ ]:


# UNQ_C8 (UNIQUE CELL IDENTIFIER, DO NOT EDIT)
# GRADED FUNCTION: compute_accuracy
def compute_accuracy(pred, y):
    '''
    Input: 
        pred: a list of the predicted parts-of-speech 
        y: a list of lines where each word is separated by a '\t' (i.e. word \t tag)
    Output: 
        
    '''
    num_correct = 0
    total = 0
    
    # Zip together the prediction and the labels
    for prediction, y in zip(pred, y):
        ### START CODE HERE (Replace instances of 'None' with your code) ###
        # Split the label into the word and the POS tag
        word_tag_tuple = None
        
        # Check that there is actually a word and a tag
        # no more and no less than 2 items
        if None: # complete this line
            continue 

        # store the word and tag separately
        word, tag = None
        
        # Check if the POS tag label matches the prediction
        if None: # complete this line
            
            # count the number of times that the prediction
            # and label match
            num_correct += None
            
        # keep track of the total number of examples (that have valid labels)
        total += None
        
        ### END CODE HERE ###
    return num_correct/total


# In[ ]:


print(f"Accuracy of the Viterbi algorithm is {compute_accuracy(pred, y):.4f}")


# ##### Expected Output
# 
# ```CPP
# Accuracy of the Viterbi algorithm is 0.9531
# ```
# 
# Congratulations you were able to classify the parts-of-speech with 95% accuracy. 

# ### Key Points and overview
# 
# In this assignment you learned about parts-of-speech tagging. 
# - In this assignment, you predicted POS tags by walking forward through a corpus and knowing the previous word.
# - There are other implementations that use bidirectional POS tagging.
# - Bidirectional POS tagging requires knowing the previous word and the next word in the corpus when predicting the current word's POS tag.
# - Bidirectional POS tagging would tell you more about the POS instead of just knowing the previous word. 
# - Since you have learned to implement the unidirectional approach, you have the foundation to implement other POS taggers used in industry.

# ### References
# 
# - ["Speech and Language Processing", Dan Jurafsky and James H. Martin](https://web.stanford.edu/~jurafsky/slp3/)
# - We would like to thank Melanie Tosik for her help and inspiration

</pre></div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/parts-of-speech-tagging-numpy/">Parts-of-Speech Tagging: Numpy</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/parts-of-speech-tagging-numpy/" rel="bookmark"><time class="published dt-published" datetime="2020-11-13T20:39:03-08:00" itemprop="datePublished" title="2020-11-13 20:39">2020-11-13 20:39</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#orgb707228">Beginning</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#org3352a16">Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#org3158cdc">Set Up</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#orgd052a06">The Parts-of-Speech Decoder</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#orgcd2e24e">Tabulate</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#org8c331f2">Middle</a>
<ul>
<li>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#org6ff2a9d">The Tags</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#orgf3b0ef4">Start with a Dictionary</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#org8e2d27d">A Transition Matrix</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#orge98a160">Normalization</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#orgba52c77">Log Sum</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-numpy/#org8624803">Brute Force Check</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgb707228">
<h2 id="orgb707228">Beginning</h2>
<div class="outline-text-2" id="text-orgb707228"></div>
<div class="outline-3" id="outline-container-org3352a16">
<h3 id="org3352a16">Imports</h3>
<div class="outline-text-3" id="text-org3352a16">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org3158cdc">
<h3 id="org3158cdc">Set Up</h3>
<div class="outline-text-3" id="text-org3158cdc"></div>
<div class="outline-4" id="outline-container-orgd052a06">
<h4 id="orgd052a06">The Parts-of-Speech Decoder</h4>
<div class="outline-text-4" id="text-orgd052a06">
<div class="highlight">
<pre><span></span><span class="n">URL</span> <span class="o">=</span> <span class="s2">"https://www.ling.upenn.edu/courses/Fall_2003/ling001/penn_treebank_pos.html"</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">TRANSLATOR</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="o">.</span><span class="n">Tag</span><span class="p">:</span><span class="n">row</span><span class="o">.</span><span class="n">Description</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()}</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgcd2e24e">
<h4 id="orgcd2e24e">Tabulate</h4>
<div class="outline-text-4" id="text-orgcd2e24e">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org8c331f2">
<h2 id="org8c331f2">Middle</h2>
<div class="outline-text-2" id="text-org8c331f2"></div>
<div class="outline-4" id="outline-container-org6ff2a9d">
<h4 id="org6ff2a9d">The Tags</h4>
<div class="outline-text-4" id="text-org6ff2a9d">
<p>We're only going to use three tags.</p>
<div class="highlight">
<pre><span></span><span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'RB'</span><span class="p">,</span> <span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'TO'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">TRANSLATOR</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
</pre></div>
<ul class="org-ul">
<li>RB (Adverb)</li>
<li>NN (Noun, singular or mass)</li>
<li>TO (to)</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgf3b0ef4">
<h3 id="orgf3b0ef4">Start with a Dictionary</h3>
<div class="outline-text-3" id="text-orgf3b0ef4">
<ul class="org-ul">
<li><code>transition_counts</code> is a dictionary with <code>(previous tag, this tag)</code> tuples as keys and the number of times these tags appeared together as the values.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="n">transition_counts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'NN'</span><span class="p">):</span> <span class="mi">16241</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'RB'</span><span class="p">,</span> <span class="s1">'RB'</span><span class="p">):</span> <span class="mi">2263</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'TO'</span><span class="p">,</span> <span class="s1">'TO'</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'TO'</span><span class="p">):</span> <span class="mi">5256</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'RB'</span><span class="p">,</span> <span class="s1">'TO'</span><span class="p">):</span> <span class="mi">855</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'TO'</span><span class="p">,</span> <span class="s1">'NN'</span><span class="p">):</span> <span class="mi">734</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'NN'</span><span class="p">,</span> <span class="s1">'RB'</span><span class="p">):</span> <span class="mi">2431</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'RB'</span><span class="p">,</span> <span class="s1">'NN'</span><span class="p">):</span> <span class="mi">358</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">'TO'</span><span class="p">,</span> <span class="s1">'RB'</span><span class="p">):</span> <span class="mi">200</span>
<span class="p">}</span>
</pre></div>
<p>We're going to need the individual tags later on.</p>
<div class="highlight">
<pre><span></span><span class="n">tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">transition_counts</span><span class="p">))</span>
<span class="n">tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
<p>I don't know what the source is, presumably the Wall Street Journal file that we used in <a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/">the previous exercise</a>.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org8e2d27d">
<h3 id="org8e2d27d">A Transition Matrix</h3>
<div class="outline-text-3" id="text-org8e2d27d">
<p>We're going to make a transition matrix for the <code>transition_counts</code> keys.</p>
<div class="highlight">
<pre><span></span><span class="n">tag_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

<span class="n">transition_matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tag_count</span><span class="p">,</span> <span class="n">tag_count</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">tag_count</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">tag_count</span><span class="p">)):</span>
        <span class="n">transition_matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition_counts</span><span class="p">[</span>
            <span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="n">row</span><span class="p">],</span>
             <span class="n">tags</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
        <span class="p">]</span>

<span class="n">transitions</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">transition_matrix</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">transitions</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">NN</th>
<th class="org-right" scope="col">RB</th>
<th class="org-right" scope="col">TO</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">NN</td>
<td class="org-right">16241</td>
<td class="org-right">2431</td>
<td class="org-right">5256</td>
</tr>
<tr>
<td class="org-left">RB</td>
<td class="org-right">358</td>
<td class="org-right">2263</td>
<td class="org-right">855</td>
</tr>
<tr>
<td class="org-left">TO</td>
<td class="org-right">734</td>
<td class="org-right">200</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="outline-3" id="outline-container-orge98a160">
<h3 id="orge98a160">Normalization</h3>
<div class="outline-text-3" id="text-orge98a160">
<p>We're going to normalize each row so that each value is equal to \(\frac{value}{\textit{sum of row}}\).</p>
<div class="highlight">
<pre><span></span><span class="n">row_sums</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">"rows"</span><span class="p">)</span>
<span class="n">normalized</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">/</span><span class="n">row_sums</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">normalized</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">NN</th>
<th class="org-right" scope="col">RB</th>
<th class="org-right" scope="col">TO</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">NN</td>
<td class="org-right">0.936999</td>
<td class="org-right">0.496731</td>
<td class="org-right">0.859807</td>
</tr>
<tr>
<td class="org-left">RB</td>
<td class="org-right">0.0206542</td>
<td class="org-right">0.462403</td>
<td class="org-right">0.139866</td>
</tr>
<tr>
<td class="org-left">TO</td>
<td class="org-right">0.042347</td>
<td class="org-right">0.0408664</td>
<td class="org-right">0.000327172</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="outline-3" id="outline-container-orgba52c77">
<h3 id="orgba52c77">Log Sum</h3>
<div class="outline-text-3" id="text-orgba52c77">
<p>Now we'll add the log of the sum of the current row to the current value along the diagonal.</p>
<div class="highlight">
<pre><span></span><span class="n">diagonal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>
<span class="n">diagonal</span> <span class="o">=</span> <span class="n">diagonal</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"float64"</span><span class="p">)</span>
<span class="n">row</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag_indices_from</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">diagonal</span>

<span class="n">diagonalized</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">diagonalized</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">NN</th>
<th class="org-right" scope="col">RB</th>
<th class="org-right" scope="col">TO</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">NN</td>
<td class="org-right">16277.7</td>
<td class="org-right">2431</td>
<td class="org-right">5256</td>
</tr>
<tr>
<td class="org-left">RB</td>
<td class="org-right">358</td>
<td class="org-right">2291.73</td>
<td class="org-right">855</td>
</tr>
<tr>
<td class="org-left">TO</td>
<td class="org-right">734</td>
<td class="org-right">200</td>
<td class="org-right">2.69315</td>
</tr>
</tbody>
</table>
</div>
<div class="outline-4" id="outline-container-org8624803">
<h4 id="org8624803">Brute Force Check</h4>
<div class="outline-text-4" id="text-org8624803">
<div class="highlight">
<pre><span></span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag_indices_from</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">))</span>
<span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)),</span>
                           <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">))):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="n">expected</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">])</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">diagonalized</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="si">}</span><span class="s2">) expected: </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">, actual: </span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">expected</span> <span class="o">-</span> <span class="n">actual</span><span class="si">}</span><span class="s2">"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/">Parts-of-Speech Tagging: Creating a Vocabulary</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/" rel="bookmark"><time class="published dt-published" datetime="2020-11-12T18:41:07-08:00" itemprop="datePublished" title="2020-11-12 18:41">2020-11-12 18:41</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org1f1f4e2">Beginning</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org4771107">Imports</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org5bf704a">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org384a319">Middle</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org1277239">Reading Text Data</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org570e17b">Word Counts</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org9de7534">Known Unknowns</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org3bdfaa8">Known Stuff</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org6afaa3e">Label the Unknowns</a></li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#orgf4aa7e9">Getting Tags</a>
<ul>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#orgc22e389">POS Tag Interpreter</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org35b288e">Special Character</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org6b11e50">Empty String</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org14eed3c">Known Preposition</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#orgdb58a13">Nouns</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#orgeb0c429">Noun</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org718598d">Unknown Unknown</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org67affe1">Verbs</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#orgd345513">Adjectives</a></li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org064b04f">Adverbs</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/parts-of-speech-tagging-creating-a-vocabulary/#org0f7c926">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org1f1f4e2">
<h2 id="org1f1f4e2">Beginning</h2>
<div class="outline-text-2" id="text-org1f1f4e2"></div>
<div class="outline-3" id="outline-container-org4771107">
<h3 id="org4771107">Imports</h3>
<div class="outline-text-3" id="text-org4771107">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org5bf704a">
<h3 id="org5bf704a">Set Up</h3>
<div class="outline-text-3" id="text-org5bf704a">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org384a319">
<h2 id="org384a319">Middle</h2>
<div class="outline-text-2" id="text-org384a319"></div>
<div class="outline-3" id="outline-container-org1277239">
<h3 id="org1277239">Reading Text Data</h3>
<div class="outline-text-3" id="text-org1277239">
<p>We're going to start with a pre-tagged dataset taken from the Wall Street Journal.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"WALL_STREET_JOURNAL_POS"</span><span class="p">]</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<p>Here's what the head of the file looks like.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
<pre class="example">
In      IN
an      DT
Oct.    NNP
19      CD
review  NN
</pre>
<p>It's a two-column (tab-separated) file with no header, but we're told that the first column is the word being tagged for its part-of-speech and the second column is the tag itself.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org570e17b">
<h3 id="org570e17b">Word Counts</h3>
<div class="outline-text-3" id="text-org570e17b">
<p>Here we'll count the number of times a word appears in our data set and filter out words that only appear once.</p>
<div class="highlight">
<pre><span></span><span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Pre-Filtered word count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
<span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Filtered Word Count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Pre-Filtered word count: 989,861
Filtered Word Count: 23,768
</pre>
<p>Just a quick check to make sure the counts are right.</p>
<div class="highlight">
<pre><span></span><span class="n">grab_count</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">COUNT</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">remaining</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
<span class="n">kept</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">min</span><span class="p">(</span><span class="n">kept</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">grab_count</span><span class="p">)[</span><span class="n">COUNT</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>

<span class="n">rejected</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[</span><span class="n">remaining</span><span class="p">:]</span>
<span class="k">assert</span> <span class="nb">max</span><span class="p">(</span><span class="n">rejected</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">grab_count</span><span class="p">)[</span><span class="n">COUNT</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span>
</pre></div>
<p>Now, a sorted version.</p>
<div class="highlight">
<pre><span></span><span class="n">words</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
</pre></div>
<p>And a peek at some of the values.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</pre></div>
<pre class="example">
shifts
solvency
downbeat
reassurance
UFOs
</pre></div>
</div>
<div class="outline-3" id="outline-container-org9de7534">
<h3 id="org9de7534">Known Unknowns</h3>
<div class="outline-text-3" id="text-org9de7534">
<p>We have a labeled vocabulary, but any new documents we encounter might have words that aren't in our vocabulary, in case we will label them as "unknown", but there are some unknowns that we can classify based on certain conditions (like their suffix).</p>
</div>
<div class="outline-4" id="outline-container-org3bdfaa8">
<h4 id="org3bdfaa8">Known Stuff</h4>
<div class="outline-text-4" id="text-org3bdfaa8"></div>
<ul class="org-ul">
<li><a id="org3809bc2"></a>Suffixes<br>
<div class="outline-text-5" id="text-org3809bc2">
<p>#+begin_src python :results none Suffixes = Namespace( noun = ["action", "age", "ance", "cy", "dom", "ee", "ence", "er", "hood", "ion", "ism", "ist", "ity", "ling", "ment", "ness", "or", "ry", "scape", "ship", "ty"], verb = ["ate", "ify", "ise", "ize"], adjective = ["able", "ese", "ful", "i", "ian", "ible", "ic", "ish", "ive", "less", "ly", "ous"], adverb = ["ward", "wards", "wise"] )</p>
</div>
</li>
<li><a id="org497e12e"></a>Labels for the Unknowns<br>
<div class="outline-text-5" id="text-org497e12e">
<div class="highlight">
<pre><span></span><span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">"--unknown-</span><span class="si">{}</span><span class="s2">--"</span>
<span class="n">Label</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">digit</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"digit"</span><span class="p">),</span>
    <span class="n">punctuation</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"punctuation"</span><span class="p">),</span>
    <span class="n">uppercase</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"uppercase"</span><span class="p">),</span>
    <span class="n">noun</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"noun"</span><span class="p">),</span>    
    <span class="n">verb</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"verb"</span><span class="p">),</span>
    <span class="n">adjective</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adjective"</span><span class="p">),</span>
    <span class="n">adverb</span><span class="o">=</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"adverb"</span><span class="p">),</span>
    <span class="n">unknown</span><span class="o">=</span><span class="s2">"--unknown--"</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="org1dd6f5e"></a>Bundle Them Up<br>
<div class="outline-text-5" id="text-org1dd6f5e">
<div class="highlight">
<pre><span></span><span class="n">Unknown</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">punctuation</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">),</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">Suffixes</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="n">Label</span><span class="p">,</span>
    <span class="n">has_digit</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\d"</span><span class="p">),</span>
    <span class="n">has_uppercase</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">"[A-Z]"</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org6afaa3e">
<h4 id="org6afaa3e">Label the Unknowns</h4>
<div class="outline-text-4" id="text-org6afaa3e">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">label_unknown</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Assign tokens to unknown words</span>

<span class="sd">    Args:</span>
<span class="sd">     word: word not in our vocabulary</span>

<span class="sd">    Returns:</span>
<span class="sd">     label for the word</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">has_digit</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">digit</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">punctuation</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">word</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">punctuation</span>

    <span class="k">if</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">has_uppercase</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">uppercase</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">noun</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">noun</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">verb</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">verb</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">adjective</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">adjective</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">adverb</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">adverb</span>

    <span class="k">return</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unknown</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">label_unknown</span><span class="p">(</span><span class="s1">'cow2pig'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label_unknown</span><span class="p">(</span><span class="s2">"cow,pig"</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label_unknown</span><span class="p">(</span><span class="s2">"cowPig"</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label_unknown</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cowpig</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">noun</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label_unknown</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cowpig</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">verb</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label_unknown</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cowpig</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">adjective</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label_unknown</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cowpig</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">Unknown</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">adverb</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label_unknown</span><span class="p">(</span><span class="s2">"cowdog"</span><span class="p">))</span>
</pre></div>
<pre class="example">
--unknown-digit--
--unknown-punctuation--
--unknown-uppercase--
--unknown-noun--
--unknown-verb--
--unknown-adjective--
--unknown-adverb--
--unknown--
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf4aa7e9">
<h3 id="orgf4aa7e9">Getting Tags</h3>
<div class="outline-text-3" id="text-orgf4aa7e9">
<p>I don't know what the Coursera example is for - they check to see if an already tagged word is in our vocabulary and then clobber the word with an unknown tag if it isn't and return the original tag. There must be a reason for this, but it isn't explained in the notebook so I'm going to do something different. I'm going to assume that the word isn't tagged and we want to tag it.</p>
</div>
<div class="outline-4" id="outline-container-orgc22e389">
<h4 id="orgc22e389">POS Tag Interpreter</h4>
<div class="outline-text-4" id="text-orgc22e389">
<p>The notebook doesn't say whose tagging system is being used so I'm going to assume that it's the <a href="https://www.ling.upenn.edu/courses/Fall_2003/ling001/penn_treebank_pos.html">Penn Treebank P.O.S. system</a>. I'll make an interpreter for the tags, since I have no idea what some of them mean.</p>
<div class="highlight">
<pre><span></span><span class="n">URL</span> <span class="o">=</span> <span class="s2">"https://www.ling.upenn.edu/courses/Fall_2003/ling001/penn_treebank_pos.html"</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">TRANSLATOR</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="o">.</span><span class="n">Tag</span><span class="p">:</span><span class="n">row</span><span class="o">.</span><span class="n">Description</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()}</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">cleaned</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">)</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cleaned</span><span class="p">)</span>
<span class="n">VOCABULARY</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">}</span> 
<span class="n">EMPTY_LINE</span> <span class="o">=</span> <span class="s2">"--n--"</span>
<span class="n">TAG_FOR_EMPTY_LINE</span> <span class="o">=</span> <span class="s2">"--s--"</span>
<span class="n">DESCRIPTION_FOR_EMPTY_LINE</span> <span class="o">=</span> <span class="s2">"--d--"</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">tag_word</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">set</span><span class="p">,</span> <span class="n">translator</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">"""gets the part-of-speech tag for the word</span>

<span class="sd">    Args:</span>
<span class="sd">     word: the word to tag</span>
<span class="sd">     vocabulary: word to tag dictionary</span>
<span class="sd">     translator: part of speech tag description</span>

<span class="sd">    Returns:</span>
<span class="sd">     word, part-of-speech tag, description</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">word</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EMPTY_LINE</span><span class="p">,</span> <span class="n">TAG_FOR_EMPTY_LINE</span><span class="p">,</span> <span class="n">DESCRIPTION_FOR_EMPTY_LINE</span>
    <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">word</span><span class="p">,</span> <span class="n">label_unknown</span><span class="p">(</span><span class="n">word</span><span class="p">),</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unknown</span>
    <span class="k">return</span> <span class="n">word</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">[</span><span class="n">word</span><span class="p">],</span> <span class="n">translator</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">word</span><span class="p">],</span> <span class="n">Unknown</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span>

<span class="n">tagger</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tag_word</span><span class="p">,</span> <span class="n">vocabulary</span><span class="o">=</span><span class="n">VOCABULARY</span><span class="p">,</span> <span class="n">translator</span><span class="o">=</span><span class="n">TRANSLATOR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org35b288e">
<h4 id="org35b288e">Special Character</h4>
<div class="outline-text-4" id="text-org35b288e">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('\n', '--unknown--', '--unknown--')
</pre></div>
</div>
<div class="outline-4" id="outline-container-org6b11e50">
<h4 id="org6b11e50">Empty String</h4>
<div class="outline-text-4" id="text-org6b11e50">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">""</span><span class="p">))</span>
</pre></div>
<pre class="example">
('--n--', '--s--', '--d--')
</pre></div>
</div>
<div class="outline-4" id="outline-container-org14eed3c">
<h4 id="org14eed3c">Known Preposition</h4>
<div class="outline-text-4" id="text-org14eed3c">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"In"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('In', 'IN', 'Preposition or subordinating conjunction')
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgdb58a13">
<h4 id="orgdb58a13">Nouns</h4>
</div>
<div class="outline-4" id="outline-container-orgeb0c429">
<h4 id="orgeb0c429">Noun</h4>
<div class="outline-text-4" id="text-orgeb0c429">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"bicycle"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('bicycle', 'NN', 'Noun, singular or mass')
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"flatulence"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('flatulence', '--unknown-noun--', '--unknown--')
</pre></div>
</div>
<div class="outline-4" id="outline-container-org718598d">
<h4 id="org718598d">Unknown Unknown</h4>
<div class="outline-text-4" id="text-org718598d">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"tardigrade"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('tardigrade', '--unknown--', '--unknown--')
</pre></div>
</div>
<div class="outline-4" id="outline-container-org67affe1">
<h4 id="org67affe1">Verbs</h4>
<div class="outline-text-4" id="text-org67affe1">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"scrutinize"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('scrutinize', 'VB', 'Verb, base form')
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"euthanize"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('euthanize', '--unknown-verb--', '--unknown--')
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgd345513">
<h4 id="orgd345513">Adjectives</h4>
<div class="outline-text-4" id="text-orgd345513">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"venerable"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('venerable', 'JJ', 'Adjective')
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"malodorous"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('malodorous', '--unknown-adjective--', '--unknown--')
</pre></div>
</div>
<div class="outline-4" id="outline-container-org064b04f">
<h4 id="org064b04f">Adverbs</h4>
<div class="outline-text-4" id="text-org064b04f">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"backwards"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('backwards', 'RB', 'Adverb')
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tagger</span><span class="p">(</span><span class="s2">"bitwise"</span><span class="p">))</span>
</pre></div>
<pre class="example">
('bitwise', '--unknown-verb--', '--unknown--')
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0f7c926">
<h2 id="org0f7c926">End</h2>
<div class="outline-text-2" id="text-org0f7c926">
<p>So, there you have it, a rudimentary way to handle tagging parts of speech for words outside of our vocabulary.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/">Autocorrect: Minimum Edit Distance Backtrace</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/" rel="bookmark"><time class="published dt-published" datetime="2020-11-11T14:47:04-08:00" itemprop="datePublished" title="2020-11-11 14:47">2020-11-11 14:47</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#orgad91bca">Beginning</a>
<ul>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org652b93c">Imports</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org5214eee">Set Up</a>
<ul>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org07b5fd9">Plotting</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org6578e9a">Tabulate</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org94dec20">Middle</a>
<ul>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#orgac4d98b">Backtrace</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org7da334a">Simple Examples</a>
<ul>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#orgfe1552c">Alignment</a></li>
</ul>
</li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org243583e">A Little More Interesting Example</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#orgd6d2468">Examples From Dan Jurasky</a>
<ul>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org4156c0e">Nucleotides</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org7f960a6">Intention and Execution</a></li>
</ul>
</li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org38059a9">What About Sentences?</a></li>
</ul>
</li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#orgb1fdcda">End</a>
<ul>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#orgcf8b336">NLTK</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#orge383775">Bundling It Up</a>
<ul>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org7c5ac8f">Imports</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org82767c1">The Aligner</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org0293fb7">The Editor</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#orgdc1b1e0">The Alignment Path</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org1c22c23">Source Alignment</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org4c88b8d">Target Alignment</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org68c1355">The Table</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#orgda5da63">The Call</a></li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org5365fe4">The String Representation</a></li>
</ul>
</li>
<li><a href="posts/nlp/autocorrect-minimum-edit-distance-backtrace/#org956edcf">Test It</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgad91bca">
<h2 id="orgad91bca">Beginning</h2>
<div class="outline-text-2" id="text-orgad91bca">
<p>This is the last post in a series about Autocorrect that's started in <a href="posts/nlp/autocorrect-the-system/">this post</a>. In the <a href="posts/nlp/autocorrect-minimum-edit-distance/">previous post</a> we implemented some code to find the minimum edit distance between two strings using Dynamic Programming. Now we'll implement the Backtrace Algorithim to find the shortest path through to transform one string to another.</p>
</div>
<div class="outline-3" id="outline-container-org652b93c">
<h3 id="org652b93c">Imports</h3>
<div class="outline-text-3" id="text-org652b93c">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">ascii_uppercase</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">nltk.metrics.distance</span> <span class="kn">import</span> <span class="n">edit_distance_align</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>

<span class="c1"># this repository</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.autocorrect.distance</span> <span class="kn">import</span> <span class="n">MinimumEdits</span>

<span class="c1"># my other stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org5214eee">
<h3 id="org5214eee">Set Up</h3>
<div class="outline-text-3" id="text-org5214eee"></div>
<div class="outline-4" id="outline-container-org07b5fd9">
<h4 id="org07b5fd9">Plotting</h4>
<div class="outline-text-4" id="text-org07b5fd9">
<p>This sets up some convenience code for plotting.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"autocorrect-minimum-edit-distance-backtrace"</span>
<span class="n">FOLDER</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">/"</span> 
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">FOLDER</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
    <span class="n">color_map</span><span class="o">=</span><span class="s2">"Plasma"</span><span class="p">,</span>
    <span class="n">path_color_map</span><span class="o">=</span><span class="s2">"blues"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">FIGUE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6578e9a">
<h4 id="org6578e9a">Tabulate</h4>
<div class="outline-text-4" id="text-org6578e9a">
<p>This sets up a pretty-printer for path-tables.</p>
<div class="highlight">
<pre><span></span><span class="n">PATH</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">"row"</span><span class="p">,</span> <span class="s2">"column"</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org94dec20">
<h2 id="org94dec20">Middle</h2>
<div class="outline-text-2" id="text-org94dec20"></div>
<div class="outline-3" id="outline-container-orgac4d98b">
<h3 id="orgac4d98b">Backtrace</h3>
<div class="outline-text-3" id="text-orgac4d98b">
<p>The <i>backtrace algorithm</i> traces a path through a minimum-edit-distance table to help us to optimally align substrings. How? Let's break that question up. First, how do you do it? We'll just use a greedy search that minimizes the cost. Starting at the last cell in the table (the minimum edit distance cell) we look at the cells directly above, directly to the left, and directly diagonal to the cell and move to the one of those three that has the lowest cost. We keep doing this until we reach the origin (0,0) cell and then we reverse the order of the cells we visited.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">backtrace</span><span class="p">(</span><span class="n">distances</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""finds the path for string alignment using backtrace</span>

<span class="sd">    Args:</span>
<span class="sd">     distances: array of mimimum edit distances</span>
<span class="sd">    """</span>
    <span class="c1"># start at the bottom right cell</span>
    <span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">path</span> <span class="o">=</span> <span class="p">[(</span><span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span><span class="p">)]</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">one_row_back</span> <span class="o">=</span> <span class="n">current_row</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">one_column_up</span> <span class="o">=</span> <span class="n">current_column</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">edits</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># insert</span>
            <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">one_row_back</span><span class="p">,</span> <span class="n">current_column</span><span class="p">],</span> <span class="p">(</span><span class="n">one_row_back</span><span class="p">,</span> <span class="n">current_column</span><span class="p">)),</span>
            <span class="c1"># delete</span>
            <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">current_row</span><span class="p">,</span> <span class="n">one_column_up</span><span class="p">],</span> <span class="p">(</span><span class="n">current_row</span><span class="p">,</span> <span class="n">one_column_up</span><span class="p">)),</span>
            <span class="c1"># substitute</span>
            <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">one_row_back</span><span class="p">,</span> <span class="n">one_column_up</span><span class="p">],</span> <span class="p">(</span><span class="n">one_row_back</span><span class="p">,</span> <span class="n">one_column_up</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">minimum_edit_distance</span><span class="p">,</span> <span class="n">cell_coordinates</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">edits</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_coordinates</span><span class="p">)</span>
        <span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span> <span class="o">=</span> <span class="n">cell_coordinates</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7da334a">
<h3 id="org7da334a">Simple Examples</h3>
<div class="outline-text-3" id="text-org7da334a"></div>
<ul class="org-ul">
<li><a id="orgec48674"></a>One Letter<br>
<div class="outline-text-5" id="text-orgec48674">
<p>We'll start with the simplest case, two strings with the same letter. Here's the distance table.</p>
<div class="highlight">
<pre><span></span><span class="n">editor</span> <span class="o">=</span> <span class="n">MinimumEdits</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">editor</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">#</th>
<th class="org-right" scope="col">a</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">#</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">a</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>
<p>And here's the path through the table.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">PATH</span><span class="p">(</span><span class="n">backtrace</span><span class="p">(</span><span class="n">editor</span><span class="o">.</span><span class="n">distance_table</span><span class="p">)))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">row</th>
<th class="org-right" scope="col">column</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<p>So, we start at the top-left and move to the bottom-right. Not too exciting…</p>
<p>Now let's try adding a second letter to the target word.</p>
<div class="highlight">
<pre><span></span><span class="n">editor</span> <span class="o">=</span> <span class="n">MinimumEdits</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"at"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">editor</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">#</th>
<th class="org-right" scope="col">a</th>
<th class="org-right" scope="col">t</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">#</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-left">a</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">backtrace</span><span class="p">(</span><span class="n">editor</span><span class="o">.</span><span class="n">distance_table</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">PATH</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">row</th>
<th class="org-right" scope="col">column</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
<p>So we move from the top left then diagonally down and then laterally to the right. This gives us the first example of how the path is telling us to align the strings. Whenever the path moves horizontally (the row doesn't change) then that means you want to skip the character in the source.</p>
</div>
</li>
</ul>
<div class="outline-4" id="outline-container-orgfe1552c">
<h4 id="orgfe1552c">Alignment</h4>
<div class="outline-text-4" id="text-orgfe1552c">
<p>The rules for skipping characters as we move through the cells in the path are:</p>
<ol class="org-ol">
<li>If the current row is the same as the previous one, skip the character in the source, but add the character from the target.</li>
<li>If the current column is the same as the previous one, skip the character in the target but add the character from the source.</li>
</ol>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">alignment</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">empty_token</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"*"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Prints the alignment for the path</span>

<span class="sd">    Args:</span>
<span class="sd">     path: list of (row, column) tuples</span>
<span class="sd">     source: the source string</span>
<span class="sd">     target: the target string</span>
<span class="sd">     empty_token: token to insert for skipped characters</span>
<span class="sd">    """</span>
    <span class="n">previous_row</span> <span class="o">=</span> <span class="n">previous_column</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">source_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">empty_token</span> <span class="o">+</span> <span class="n">source</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">empty_token</span> <span class="o">+</span> <span class="n">target</span>
    <span class="k">for</span> <span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">source_token</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">current_row</span><span class="p">]</span> <span class="k">if</span> <span class="n">current_row</span> <span class="o">!=</span> <span class="n">previous_row</span> <span class="k">else</span> <span class="n">empty_token</span>
        <span class="n">target_token</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">current_column</span><span class="p">]</span> <span class="k">if</span> <span class="n">current_column</span> <span class="o">!=</span> <span class="n">previous_column</span> <span class="k">else</span> <span class="n">empty_token</span>

        <span class="n">source_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_token</span><span class="p">)</span>
        <span class="n">target_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_token</span><span class="p">)</span>

        <span class="n">previous_row</span><span class="p">,</span> <span class="n">previous_column</span> <span class="o">=</span> <span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span>

    <span class="k">for</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="p">(</span><span class="n">source_tokens</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|</span><span class="si">{</span><span class="s1">'|'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="si">}</span><span class="s2">|"</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
<p>Our alignment for the previous path looks like this.</p>
<div class="highlight">
<pre><span></span><span class="n">alignment</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"at"</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<tbody>
<tr>
<td class="org-left">a</td>
<td class="org-left">*</td>
</tr>
<tr>
<td class="org-left">a</td>
<td class="org-left">t</td>
</tr>
</tbody>
</table>
<p>Where the <code>*</code> means skip that character. Okay, that might be obvious, but what if we have to skip the first letter?</p>
<div class="highlight">
<pre><span></span><span class="n">editor</span> <span class="o">=</span> <span class="n">MinimumEdits</span><span class="p">(</span><span class="s2">"t"</span><span class="p">,</span> <span class="s2">"at"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">editor</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">#</th>
<th class="org-right" scope="col">a</th>
<th class="org-right" scope="col">t</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">#</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-left">t</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">backtrace</span><span class="p">(</span><span class="n">editor</span><span class="o">.</span><span class="n">distance_table</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">PATH</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">row</th>
<th class="org-right" scope="col">column</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
<p>So in the first two cells the row doesn't change meaning that we skip the first letter in the source.</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<tbody>
<tr>
<td class="org-left">a</td>
<td class="org-left">t</td>
</tr>
<tr>
<td class="org-left">*</td>
<td class="org-left">t</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org243583e">
<h3 id="org243583e">A Little More Interesting Example</h3>
<div class="outline-text-3" id="text-org243583e">
<p>Let's try a slightly more interesting example, aligning "drats" and "maths". First, the distance table.</p>
<div class="highlight">
<pre><span></span><span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span> <span class="o">=</span> <span class="s2">"drats"</span><span class="p">,</span> <span class="s2">"maths"</span>
<span class="n">editor</span> <span class="o">=</span> <span class="n">MinimumEdits</span><span class="p">(</span><span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">editor</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">#</th>
<th class="org-right" scope="col">m</th>
<th class="org-right" scope="col">a</th>
<th class="org-right" scope="col">t</th>
<th class="org-right" scope="col">h</th>
<th class="org-right" scope="col">s</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">#</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
</tr>
<tr>
<td class="org-left">d</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
</tr>
<tr>
<td class="org-left">r</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
<td class="org-right">7</td>
</tr>
<tr>
<td class="org-left">a</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
</tr>
<tr>
<td class="org-left">t</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
</tr>
<tr>
<td class="org-left">s</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
<td class="org-right">5</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">4</td>
</tr>
</tbody>
</table>
<p>Let's plot a heat map for it. If we plot the table as-is it ends up with the rows reversed, so we'll have to reverse the rows before plotting it.</p>
<div class="highlight">
<pre><span></span><span class="n">reversed_table</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">distance_frame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">reversed_table</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_map</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Minimum Edit Distances"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span>
<span class="p">)</span>
<span class="n">plot</span> <span class="o">*=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">Labels</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"drats_maths_distance_table"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/autocorrect-minimum-edit-distance-backtrace/drats_maths_distance_table.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Now we can take a look at the path.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">backtrace</span><span class="p">(</span><span class="n">editor</span><span class="o">.</span><span class="n">distance_table</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">PATH</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">row</th>
<th class="org-right" scope="col">column</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-right">2</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">3</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-right">4</td>
<td class="org-right">3</td>
</tr>
<tr>
<td class="org-right">4</td>
<td class="org-right">4</td>
</tr>
<tr>
<td class="org-right">5</td>
<td class="org-right">5</td>
</tr>
</tbody>
</table>
<p>Now it's getting a little harder to see what's going on so let's plot the path along with the heatmap.</p>
<div class="highlight">
<pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">editor</span><span class="o">.</span><span class="n">distance_table</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
    <span class="n">table</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="s2">"#drats"</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="s2">"#maths"</span><span class="p">))</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">path_plot</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">path_color_map</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Path For Alignment"</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="n">distance_plot</span> <span class="o">=</span> <span class="n">reversed_table</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_map</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Minimum Edit Distances"</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span>
<span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">path_plot</span> <span class="o">+</span> <span class="n">distance_plot</span><span class="p">)</span><span class="o">.</span><span class="n">cols</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"drats_maths_alignment"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/autocorrect-minimum-edit-distance-backtrace/drats_maths_alignment.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>In the top plot the dark-blue rectangles are the ones chosen by the backtrace and the lower plot is a heatmap of the distances for each cell in the distance-table. You can sort of see that the path matches the cooler (smaller distance) cells in the distance heat map as you work from the top-left cell to the bottom-right cell (the minimum edit distance).</p>
<p>To interpret the path: where the column repeats you skip a character in the target and where the row repeats you skip a character in the source so our alignment looks like this.</p>
<div class="highlight">
<pre><span></span><span class="n">alignment</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<tbody>
<tr>
<td class="org-left">d</td>
<td class="org-left">r</td>
<td class="org-left">a</td>
<td class="org-left">t</td>
<td class="org-left">*</td>
<td class="org-left">s</td>
</tr>
<tr>
<td class="org-left">*</td>
<td class="org-left">m</td>
<td class="org-left">a</td>
<td class="org-left">t</td>
<td class="org-left">h</td>
<td class="org-left">s</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="outline-3" id="outline-container-orgd6d2468">
<h3 id="orgd6d2468">Examples From Dan Jurasky</h3>
<div class="outline-text-3" id="text-orgd6d2468">
<p>These are examples from Dan Jurasky's <a href="https://web.stanford.edu/class/cs124/lec/med.pdf">CS 124 lecture slides</a>.</p>
</div>
<div class="outline-4" id="outline-container-org4156c0e">
<h4 id="org4156c0e">Nucleotides</h4>
<div class="outline-text-4" id="text-org4156c0e">
<p>Using the bokeh backend for heatmaps doesn't let you use column and index names that repeat, and I haven't figured out how to set x-ticks and y-ticks explicitly so I'll do it in matplotlib instead.</p>
<div class="highlight">
<pre><span></span><span class="n">HEIGHT</span><span class="p">,</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1000</span>

<span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span> <span class="o">=</span> <span class="s2">"AGGCTATCACCTGACCTCCAGGCCGATGCCC"</span><span class="p">,</span> <span class="s2">"TAGCTATCACGACCGCGGTCGATTTGCCCGAC"</span>
<span class="n">editor</span> <span class="o">=</span> <span class="n">MinimumEdits</span><span class="p">(</span><span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span><span class="p">)</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">backtrace</span><span class="p">(</span><span class="n">editor</span><span class="o">.</span><span class="n">distance_table</span><span class="p">)</span>
</pre></div>
<p>The plotting didn't work for this set so I'm not showing it (it scrambled the order and reduced the number of characters).</p>
<div class="highlight">
<pre><span></span><span class="n">alignment</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<tbody>
<tr>
<td class="org-left">*</td>
<td class="org-left">A</td>
<td class="org-left">G</td>
<td class="org-left">G</td>
<td class="org-left">C</td>
<td class="org-left">T</td>
<td class="org-left">A</td>
<td class="org-left">T</td>
<td class="org-left">C</td>
<td class="org-left">A</td>
<td class="org-left">C</td>
<td class="org-left">C</td>
<td class="org-left">T</td>
<td class="org-left">G</td>
<td class="org-left">A</td>
<td class="org-left">C</td>
<td class="org-left">C</td>
<td class="org-left">T</td>
<td class="org-left">C</td>
<td class="org-left">C</td>
<td class="org-left">A</td>
<td class="org-left">G</td>
<td class="org-left">G</td>
<td class="org-left">*</td>
<td class="org-left">C</td>
<td class="org-left">C</td>
<td class="org-left">G</td>
<td class="org-left">A</td>
<td class="org-left">T</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">G</td>
<td class="org-left">C</td>
<td class="org-left">C</td>
<td class="org-left">C</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
<tr>
<td class="org-left">T</td>
<td class="org-left">A</td>
<td class="org-left">G</td>
<td class="org-left">*</td>
<td class="org-left">C</td>
<td class="org-left">T</td>
<td class="org-left">A</td>
<td class="org-left">T</td>
<td class="org-left">C</td>
<td class="org-left">A</td>
<td class="org-left">C</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">G</td>
<td class="org-left">A</td>
<td class="org-left">C</td>
<td class="org-left">C</td>
<td class="org-left">G</td>
<td class="org-left">C</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">G</td>
<td class="org-left">G</td>
<td class="org-left">T</td>
<td class="org-left">C</td>
<td class="org-left">*</td>
<td class="org-left">G</td>
<td class="org-left">A</td>
<td class="org-left">T</td>
<td class="org-left">T</td>
<td class="org-left">T</td>
<td class="org-left">G</td>
<td class="org-left">C</td>
<td class="org-left">C</td>
<td class="org-left">C</td>
<td class="org-left">G</td>
<td class="org-left">A</td>
<td class="org-left">C</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="outline-4" id="outline-container-org7f960a6">
<h4 id="org7f960a6">Intention and Execution</h4>
<div class="outline-text-4" id="text-org7f960a6">
<div class="highlight">
<pre><span></span><span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span> <span class="o">=</span> <span class="s2">"INTENTION"</span><span class="p">,</span> <span class="s2">"EXECUTION"</span>
<span class="n">editor</span> <span class="o">=</span> <span class="n">MinimumEdits</span><span class="p">(</span><span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">backtrace</span><span class="p">(</span><span class="n">editor</span><span class="o">.</span><span class="n">distance_table</span><span class="p">)</span>
<span class="n">alignment</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<tbody>
<tr>
<td class="org-left">I</td>
<td class="org-left">N</td>
<td class="org-left">T</td>
<td class="org-left">E</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">N</td>
<td class="org-left">T</td>
<td class="org-left">I</td>
<td class="org-left">O</td>
<td class="org-left">N</td>
</tr>
<tr>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">E</td>
<td class="org-left">X</td>
<td class="org-left">E</td>
<td class="org-left">C</td>
<td class="org-left">U</td>
<td class="org-left">T</td>
<td class="org-left">I</td>
<td class="org-left">O</td>
<td class="org-left">N</td>
</tr>
</tbody>
</table>
<p>The output given by the presentation is</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<tbody>
<tr>
<td class="org-left">I</td>
<td class="org-left">N</td>
<td class="org-left">T</td>
<td class="org-left">E</td>
<td class="org-left">*</td>
<td class="org-left">N</td>
<td class="org-left">T</td>
<td class="org-left">I</td>
<td class="org-left">O</td>
<td class="org-left">N</td>
</tr>
<tr>
<td class="org-left">*</td>
<td class="org-left">E</td>
<td class="org-left">X</td>
<td class="org-left">E</td>
<td class="org-left">C</td>
<td class="org-left">U</td>
<td class="org-left">T</td>
<td class="org-left">I</td>
<td class="org-left">O</td>
<td class="org-left">N</td>
</tr>
</tbody>
</table>
<p>But I can't find anyplace where he documents how he derives these alignments so I don't know how to get this form.</p>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">seaborn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">editor</span><span class="o">.</span><span class="n">distance_frame</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FOLDER</span> <span class="o">+</span> <span class="s2">"intention.png"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="intention.png" src="posts/nlp/autocorrect-minimum-edit-distance-backtrace/intention.png"></p>
</div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org38059a9">
<h3 id="org38059a9">What About Sentences?</h3>
<div class="outline-text-3" id="text-org38059a9">
<div class="highlight">
<pre><span></span><span class="n">SOURCE</span> <span class="o">=</span> <span class="s2">"he was big and bold and tall but old"</span>
<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">"he is big i'm told but old"</span>
<span class="n">editor</span> <span class="o">=</span> <span class="n">MinimumEdits</span><span class="p">(</span><span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">backtrace</span><span class="p">(</span><span class="n">editor</span><span class="o">.</span><span class="n">distance_table</span><span class="p">)</span>
<span class="n">alignment</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">SOURCE</span><span class="p">,</span> <span class="n">TARGET</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<tbody>
<tr>
<td class="org-left">h</td>
<td class="org-left">e</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">w</td>
<td class="org-left">a</td>
<td class="org-left">s</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">b</td>
<td class="org-left">i</td>
<td class="org-left">g</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">a</td>
<td class="org-left">n</td>
<td class="org-left">d</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">b</td>
<td class="org-left">o</td>
<td class="org-left">l</td>
<td class="org-left">d</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">a</td>
<td class="org-left">n</td>
<td class="org-left">d</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">t</td>
<td class="org-left">a</td>
<td class="org-left">l</td>
<td class="org-left">l</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">b</td>
<td class="org-left">u</td>
<td class="org-left">t</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">o</td>
<td class="org-left">l</td>
<td class="org-left">d</td>
</tr>
<tr>
<td class="org-left">h</td>
<td class="org-left">e</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">*</td>
<td class="org-left">i</td>
<td class="org-left">s</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">b</td>
<td class="org-left">i</td>
<td class="org-left">g</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">i</td>
<td class="org-left">'</td>
<td class="org-left">m</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">t</td>
<td class="org-left">o</td>
<td class="org-left">l</td>
<td class="org-left">d</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">b</td>
<td class="org-left">u</td>
<td class="org-left">t</td>
<td class="org-left">&nbsp;</td>
<td class="org-left">o</td>
<td class="org-left">l</td>
<td class="org-left">d</td>
</tr>
</tbody>
</table>
<p>Sort of, but I'm sure that's not the right way to do it.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgb1fdcda">
<h2 id="orgb1fdcda">End</h2>
<div class="outline-text-2" id="text-orgb1fdcda"></div>
<div class="outline-3" id="outline-container-orgcf8b336">
<h3 id="orgcf8b336">NLTK</h3>
<div class="outline-text-3" id="text-orgcf8b336">
<p>The NLTK has a function that will get the path for us. It sort of hides the table from us (there's a private(ish) function that you can call to make the path if you have the table, otherwise they build the table and return the path). I couldn't find a direct link to it, but the it's in the <a href="https://www.nltk.org/api/nltk.metrics.html">metrics.distance</a> module and is called <code>edit_distance_align</code>.</p>
<p>Let's see what it does with our last example.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk_path</span> <span class="o">=</span> <span class="n">edit_distance_align</span><span class="p">(</span><span class="s2">"drats"</span><span class="p">,</span> <span class="s2">"maths"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|Ours| NLTK's|"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|-+-|"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">theirs</span><span class="p">,</span> <span class="n">ours</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">nltk_path</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|</span><span class="si">{</span><span class="n">ours</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">theirs</span><span class="si">}</span><span class="s2">|"</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Ours</th>
<th class="org-left" scope="col">NLTK's</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">(0, 0)</td>
<td class="org-left">(0, 0)</td>
</tr>
<tr>
<td class="org-left">(1, 1)</td>
<td class="org-left">(1, 0)</td>
</tr>
<tr>
<td class="org-left">(2, 2)</td>
<td class="org-left">(2, 1)</td>
</tr>
<tr>
<td class="org-left">(3, 2)</td>
<td class="org-left">(3, 2)</td>
</tr>
<tr>
<td class="org-left">(4, 3)</td>
<td class="org-left">(4, 3)</td>
</tr>
<tr>
<td class="org-left">(5, 4)</td>
<td class="org-left">(4, 4)</td>
</tr>
<tr>
<td class="org-left">(5, 5)</td>
<td class="org-left">(5, 5)</td>
</tr>
</tbody>
</table>
<p>So, you can see that ours doesn't really agree with theirs - which one of us is wrong?</p>
<div class="highlight">
<pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">edit_distance_align</span><span class="p">)</span>
</pre></div>
<pre class="example">
Help on function edit_distance_align in module nltk.metrics.distance:

edit_distance_align(s1, s2, substitution_cost=1)
    Calculate the minimum Levenshtein edit-distance based alignment
    mapping between two strings. The alignment finds the mapping
    from string s1 to s2 that minimizes the edit distance cost.
    For example, mapping "rain" to "shine" would involve 2
    substitutions, 2 matches and an insertion resulting in
    the following mapping:
    [(0, 0), (1, 1), (2, 2), (3, 3), (4, 4), (4, 5)]
    NB: (0, 0) is the start state without any letters associated
    See more: https://web.stanford.edu/class/cs124/lec/med.pdf
    
    In case of multiple valid minimum-distance alignments, the
    backtrace has the following operation precedence:
    1. Skip s1 character
    2. Skip s2 character
    3. Substitute s1 and s2 characters
    The backtrace is carried out in reverse string order.
    
    This function does not support transposition.
    
    :param s1, s2: The strings to be aligned
    :type s1: str
    :type s2: str
    :type substitution_cost: int
    :rtype List[Tuple(int, int)]
</pre>
<p>Well, it looks like their substitution cost is 1 by default, not 2 like we're using. Take two.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk_align</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">edit_distance_align</span><span class="p">,</span> <span class="n">substitution_cost</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">nltk_path</span> <span class="o">=</span> <span class="n">nltk_align</span><span class="p">(</span><span class="s2">"drats"</span><span class="p">,</span> <span class="s2">"maths"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|Ours| NLTK's|"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|-+-|"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ours</span><span class="p">,</span> <span class="n">theirs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">nltk_path</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|</span><span class="si">{</span><span class="n">ours</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">theirs</span><span class="si">}</span><span class="s2">|"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ours</span> <span class="o">==</span> <span class="n">theirs</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Ours</th>
<th class="org-left" scope="col">NLTK's</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">(0, 0)</td>
<td class="org-left">(0, 0)</td>
</tr>
<tr>
<td class="org-left">(1, 0)</td>
<td class="org-left">(1, 0)</td>
</tr>
<tr>
<td class="org-left">(2, 1)</td>
<td class="org-left">(2, 1)</td>
</tr>
<tr>
<td class="org-left">(3, 2)</td>
<td class="org-left">(3, 2)</td>
</tr>
<tr>
<td class="org-left">(4, 3)</td>
<td class="org-left">(4, 3)</td>
</tr>
<tr>
<td class="org-left">(4, 4)</td>
<td class="org-left">(4, 4)</td>
</tr>
<tr>
<td class="org-left">(5, 5)</td>
<td class="org-left">(5, 5)</td>
</tr>
</tbody>
</table>
<p>So, if we're wrong, we're at least as wrong as NLTK is. Maybe.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orge383775">
<h3 id="orge383775">Bundling It Up</h3>
<div class="outline-text-3" id="text-orge383775"></div>
<div class="outline-4" id="outline-container-org7c5ac8f">
<h4 id="org7c5ac8f">Imports</h4>
<div class="outline-text-4" id="text-org7c5ac8f">
<div class="highlight">
<pre><span></span><span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>

<span class="c1"># this repo</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.autocorrect.distance</span> <span class="kn">import</span> <span class="n">MinimumEdits</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org82767c1">
<h4 id="org82767c1">The Aligner</h4>
<div class="outline-text-4" id="text-org82767c1">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Aligner</span><span class="p">:</span>
    <span class="sd">"""Create the alignment path</span>

<span class="sd">    Args: </span>
<span class="sd">     source: the source string to align</span>
<span class="sd">     target: the target string to align</span>
<span class="sd">     empty_token: character to use to fill in alignments</span>
<span class="sd">    """</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">target</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">empty_token</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"*"</span>
    <span class="n">_source_alignment</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_target_alignment</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_table</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_editor</span><span class="p">:</span> <span class="n">MinimumEdits</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_path</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0293fb7">
<h4 id="org0293fb7">The Editor</h4>
<div class="outline-text-4" id="text-org0293fb7">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">editor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MinimumEdits</span><span class="p">:</span>
    <span class="sd">"""object to figure out the minimum edit distance"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_editor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_editor</span> <span class="o">=</span> <span class="n">MinimumEdits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_editor</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdc1b1e0">
<h4 id="orgdc1b1e0">The Alignment Path</h4>
<div class="outline-text-4" id="text-orgdc1b1e0">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""An optimal path through the distance table"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">distance_table</span>
        <span class="c1"># start at the bottom right cell</span>
        <span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[(</span><span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span><span class="p">)]</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">one_row_back</span> <span class="o">=</span> <span class="n">current_row</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">one_column_up</span> <span class="o">=</span> <span class="n">current_column</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">edits</span> <span class="o">=</span> <span class="p">(</span>
                <span class="c1"># insert</span>
                <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">one_row_back</span><span class="p">,</span> <span class="n">current_column</span><span class="p">],</span> <span class="p">(</span><span class="n">one_row_back</span><span class="p">,</span> <span class="n">current_column</span><span class="p">)),</span>
                <span class="c1"># delete</span>
                <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">current_row</span><span class="p">,</span> <span class="n">one_column_up</span><span class="p">],</span> <span class="p">(</span><span class="n">current_row</span><span class="p">,</span> <span class="n">one_column_up</span><span class="p">)),</span>
                <span class="c1"># substitute</span>
                <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">one_row_back</span><span class="p">,</span> <span class="n">one_column_up</span><span class="p">],</span> <span class="p">(</span><span class="n">one_row_back</span><span class="p">,</span> <span class="n">one_column_up</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">minimum_edit_distance</span><span class="p">,</span> <span class="n">cell_coordinates</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">edits</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_coordinates</span><span class="p">)</span>
            <span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span> <span class="o">=</span> <span class="n">cell_coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1c22c23">
<h4 id="org1c22c23">Source Alignment</h4>
<div class="outline-text-4" id="text-org1c22c23">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">source_alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""the aligned source tokens</span>

<span class="sd">    Warning:</span>
<span class="sd">     this doesn't create them, call the object to do that</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_alignment</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4c88b8d">
<h4 id="org4c88b8d">Target Alignment</h4>
<div class="outline-text-4" id="text-org4c88b8d">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">target_alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The aligned target tokens</span>

<span class="sd">    Warning:</span>
<span class="sd">     this doesn't create them, the __call__ does</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_alignment</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org68c1355">
<h4 id="org68c1355">The Table</h4>
<div class="outline-text-4" id="text-org68c1355">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""The alignments as an orgtable"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_alignment</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_alignment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">"|</span><span class="si">{</span><span class="s1">'|'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_alignment</span><span class="p">)</span><span class="si">}</span><span class="s2">|</span><span class="se">\n</span><span class="s2">"</span>
                       <span class="sa">f</span><span class="s2">"|</span><span class="si">{</span><span class="s1">'|'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_alignment</span><span class="p">)</span><span class="si">}</span><span class="s2">|"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgda5da63">
<h4 id="orgda5da63">The Call</h4>
<div class="outline-text-4" id="text-orgda5da63">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">"""Sets the source and target token alignments</span>

<span class="sd">    Note:</span>
<span class="sd">     as a side-effect also sets source_alignment and target_alignment</span>

<span class="sd">    Returns:</span>
<span class="sd">     tuple of source and target tokens after alignment</span>
<span class="sd">    """</span>
    <span class="n">previous_row</span> <span class="o">=</span> <span class="n">previous_column</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">source_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_token</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_token</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
    <span class="k">for</span> <span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">source_token</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">source</span><span class="p">[</span><span class="n">current_row</span><span class="p">]</span> <span class="k">if</span> <span class="n">current_row</span> <span class="o">!=</span> <span class="n">previous_row</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_token</span><span class="p">)</span>
        <span class="n">target_token</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">target</span><span class="p">[</span><span class="n">current_column</span><span class="p">]</span> <span class="k">if</span> <span class="n">current_column</span> <span class="o">!=</span> <span class="n">previous_column</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_token</span><span class="p">)</span>

        <span class="n">source_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_token</span><span class="p">)</span>
        <span class="n">target_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_token</span><span class="p">)</span>

        <span class="n">previous_row</span><span class="p">,</span> <span class="n">previous_column</span> <span class="o">=</span> <span class="n">current_row</span><span class="p">,</span> <span class="n">current_column</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_source_alignment</span> <span class="o">=</span> <span class="n">source_tokens</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_target_alignment</span> <span class="o">=</span> <span class="n">target_tokens</span>
    <span class="k">return</span> <span class="n">source_tokens</span><span class="p">,</span> <span class="n">target_tokens</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5365fe4">
<h4 id="org5365fe4">The String Representation</h4>
<div class="outline-text-4" id="text-org5365fe4">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""pass-through for the table"""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org956edcf">
<h3 id="org956edcf">Test It</h3>
<div class="outline-text-3" id="text-org956edcf">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.autocorrect.alignment</span> <span class="kn">import</span> <span class="n">Aligner</span>

<span class="n">align</span> <span class="o">=</span> <span class="n">Aligner</span><span class="p">(</span><span class="s2">"source"</span><span class="p">,</span> <span class="s2">"target"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">align</span><span class="o">.</span><span class="n">editor</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">#</th>
<th class="org-right" scope="col">t</th>
<th class="org-right" scope="col">a</th>
<th class="org-right" scope="col">r</th>
<th class="org-right" scope="col">g</th>
<th class="org-right" scope="col">e</th>
<th class="org-right" scope="col">t</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">#</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
</tr>
<tr>
<td class="org-left">s</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
<td class="org-right">7</td>
</tr>
<tr>
<td class="org-left">o</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
<td class="org-right">7</td>
<td class="org-right">8</td>
</tr>
<tr>
<td class="org-left">u</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
<td class="org-right">7</td>
<td class="org-right">8</td>
<td class="org-right">9</td>
</tr>
<tr>
<td class="org-left">r</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
<td class="org-right">7</td>
<td class="org-right">8</td>
</tr>
<tr>
<td class="org-left">c</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
<td class="org-right">7</td>
<td class="org-right">6</td>
<td class="org-right">7</td>
<td class="org-right">8</td>
<td class="org-right">9</td>
</tr>
<tr>
<td class="org-left">e</td>
<td class="org-right">6</td>
<td class="org-right">7</td>
<td class="org-right">8</td>
<td class="org-right">7</td>
<td class="org-right">8</td>
<td class="org-right">7</td>
<td class="org-right">8</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">PATH</span><span class="p">(</span><span class="n">align</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">row</th>
<th class="org-right" scope="col">column</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-right">2</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">3</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-right">4</td>
<td class="org-right">3</td>
</tr>
<tr>
<td class="org-right">5</td>
<td class="org-right">4</td>
</tr>
<tr>
<td class="org-right">6</td>
<td class="org-right">5</td>
</tr>
<tr>
<td class="org-right">6</td>
<td class="org-right">6</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">align</span><span class="p">())</span>
</pre></div>
<pre class="example">
(['s', 'o', 'u', 'r', 'c', 'e', '*'], ['*', 't', 'a', 'r', 'g', 'e', 't'])
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">align</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<tbody>
<tr>
<td class="org-left">s</td>
<td class="org-left">o</td>
<td class="org-left">u</td>
<td class="org-left">r</td>
<td class="org-left">c</td>
<td class="org-left">e</td>
<td class="org-left">*</td>
</tr>
<tr>
<td class="org-left">*</td>
<td class="org-left">t</td>
<td class="org-left">a</td>
<td class="org-left">r</td>
<td class="org-left">g</td>
<td class="org-left">e</td>
<td class="org-left">t</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">align</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<tbody>
<tr>
<td class="org-left">s</td>
<td class="org-left">o</td>
<td class="org-left">u</td>
<td class="org-left">r</td>
<td class="org-left">c</td>
<td class="org-left">e</td>
<td class="org-left">*</td>
</tr>
<tr>
<td class="org-left">*</td>
<td class="org-left">t</td>
<td class="org-left">a</td>
<td class="org-left">r</td>
<td class="org-left">g</td>
<td class="org-left">e</td>
<td class="org-left">t</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="n">align</span> <span class="o">=</span> <span class="n">Aligner</span><span class="p">(</span><span class="s2">"drafts"</span><span class="p">,</span> <span class="s2">"maths"</span><span class="p">)</span>
<span class="n">nltk_path</span> <span class="o">=</span> <span class="n">nltk_align</span><span class="p">(</span><span class="s2">"drafts"</span><span class="p">,</span> <span class="s2">"maths"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ours</span><span class="p">,</span> <span class="n">theirs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">align</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">nltk_path</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">ours</span> <span class="o">==</span> <span class="n">theirs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">theirs</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">ours</span><span class="si">}</span><span class="s2">"</span>

<span class="nb">print</span><span class="p">(</span><span class="n">align</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<tbody>
<tr>
<td class="org-left">d</td>
<td class="org-left">r</td>
<td class="org-left">a</td>
<td class="org-left">f</td>
<td class="org-left">t</td>
<td class="org-left">*</td>
<td class="org-left">s</td>
</tr>
<tr>
<td class="org-left">*</td>
<td class="org-left">m</td>
<td class="org-left">a</td>
<td class="org-left">*</td>
<td class="org-left">t</td>
<td class="org-left">h</td>
<td class="org-left">s</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-15.html" rel="prev">Newer posts</a></li>
<li class="next"><a href="index-13.html" rel="next">Older posts</a></li>
</ul>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']],},

        });
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script><!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
