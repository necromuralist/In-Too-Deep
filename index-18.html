<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Studies in Deep Learning." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Neurotic Networking (old posts, page 18) | Neurotic Networking</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/index-18.html" rel="canonical">
<link href="index-19.html" rel="prev" type="text/html">
<link href="index-17.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="."><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-data/">NER: Data</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-data/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T15:00:14-08:00" itemprop="datePublished" title="2021-01-13 15:00">2021-01-13 15:00</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-data/#org38f7aa9">The Data</a>
<ul>
<li><a href="posts/nlp/ner-data/#org5883759">Imports</a></li>
<li><a href="posts/nlp/ner-data/#org362657c">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-data/#orged37617">Middle</a>
<ul>
<li><a href="posts/nlp/ner-data/#org7b550f0">Reviewing The Dataset</a></li>
<li><a href="posts/nlp/ner-data/#org1a4a9d1">A Data Generator</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-data/#org8049c57">Bundle It Up</a>
<ul>
<li><a href="posts/nlp/ner-data/#org14a0fab">Imports</a></li>
<li><a href="posts/nlp/ner-data/#org85fff6f">Some Types</a></li>
<li><a href="posts/nlp/ner-data/#org566db03">The Data Generator</a>
<ul>
<li><a href="posts/nlp/ner-data/#orga609f78">The Batch Generator</a></li>
<li><a href="posts/nlp/ner-data/#orgcb8d175">The Generator Method</a></li>
<li><a href="posts/nlp/ner-data/#orgdef3ca3">The Iterator Method</a></li>
<li><a href="posts/nlp/ner-data/#org858e1d7">The Next Method</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-data/#orgacb7400">Test It</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org38f7aa9">
<h2 id="org38f7aa9">The Data</h2>
<div class="outline-text-2" id="text-org38f7aa9">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/">The Previous Post</a></li>
<li><a href="posts/nlp/ner-building-the-model/">The Next Post</a></li>
</ul>
</div>
<div class="outline-3" id="outline-container-org5883759">
<h3 id="org5883759">Imports</h3>
<div class="outline-text-3" id="text-org5883759">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">NERData</span><span class="p">,</span> <span class="n">TOKEN</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org362657c">
<h3 id="org362657c">Set Up</h3>
<div class="outline-text-3" id="text-org362657c">
<div class="highlight">
<pre><span></span><span class="n">ner</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span>

<span class="c1"># to make the functions pass we need to use their names (initially)</span>
<span class="n">vocab</span> <span class="o">=</span> <span class="n">vocabulary</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span>
<span class="n">tag_map</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orged37617">
<h2 id="orged37617">Middle</h2>
<div class="outline-text-2" id="text-orged37617"></div>
<div class="outline-3" id="outline-container-org7b550f0">
<h3 id="org7b550f0">Reviewing The Dataset</h3>
<div class="outline-text-3" id="text-org7b550f0">
<p>As a review we can look at what's in the vocabulary.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">[</span><span class="s2">"the"</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">[</span><span class="s2">"The"</span><span class="p">])</span>
</pre></div>
<pre class="example">
9
35178
61
</pre>
<p>The vocabulary maps words in our vocabulary to unique integers. As you can see, we made it case-sensitive.</p>
<p>We also made a map for tags.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org3f2f153">
- O: 0
- B-geo: 1
- B-gpe: 2
- B-per: 3
- I-geo: 4
- B-org: 5
- I-org: 6
- B-tim: 7
- B-art: 8
- I-art: 9
- I-per: 10
- I-gpe: 11
- I-tim: 12
- B-nat: 13
- B-eve: 14
- I-eve: 15
- I-nat: 16
- UNK: 17
</pre>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Prefix</th>
<th class="org-left" scope="col">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">B</td>
<td class="org-left">Token Begins an entity</td>
</tr>
<tr>
<td class="org-left">I</td>
<td class="org-left">Token is Inside an entity</td>
</tr>
</tbody>
</table>
<p>This is to help when you have multi-token entities. So if you had the name "Burt Reynolds", "Burt" would be tagged <code>B-per</code> and "Reynolds" would be tagged "I-per".</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The number of tags is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tag_map</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The vocabulary size is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The training size is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The validation size is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_validate</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"The first training sentence is "</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">raw_data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Its corresponding label is"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" '</span><span class="si">{</span><span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">raw_data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"The first training encoded sentence is "</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Its corresponding encoded label is"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org08634ec">
The number of tags is 18
The vocabulary size is 35,180
The training size is 33,570
The validation size is 7,194
The first training sentence is 
'Opposition leader Michael Howard said he hopes the government in coming weeks will try to uncover possible security flaws exploited in the attacks .'
Its corresponding label is
 'O O B-per I-per O O O O O O O O O O O O O O O O O O O O'
The first training encoded sentence is 
[7848, 538, 5951, 6187, 172, 502, 2453, 9, 293, 11, 5306, 822, 141, 1962, 7, 26689, 1176, 686, 11905, 14806, 11, 9, 292, 21]
Its corresponding encoded label is
[0, 0, 3, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
</pre></div>
</div>
<div class="outline-3" id="outline-container-org1a4a9d1">
<h3 id="org1a4a9d1">A Data Generator</h3>
<div class="outline-text-3" id="text-org1a4a9d1">
<p>The generator will have a main outer loop:</p>
<pre class="example" id="org97301f9">
while True:  
    yield((X,Y))  
</pre>
<p>runs continuously in the fashion of generators, pausing when yielding the next values. We will generate a batch_size output on each pass of this loop.</p>
<p>It has two inner loops.</p>
<ol class="org-ol">
<li>The first stores in temporal lists the data samples to be included in the next batch, and finds the maximum length of the sentences contained in it. By adjusting the length to include only the size of the longest sentence in each batch, overall computation is reduced.</li>
<li>The second loop moves those inputs from the temporal list into NumPy arrays pre-filled with pad values.</li>
</ol>
<p>There are three slightly out of the ordinary features.</p>
<ol class="org-ol">
<li>The first is the use of the NumPy <code>full</code> function to fill the NumPy arrays with a pad value. See <a href="https://numpy.org/doc/1.18/reference/generated/numpy.full.html"><code>full</code> function documentation</a>.</li>
<li>The second is tracking the current location in the incoming lists of sentences. Generators variables hold their values between invocations, so we create an <code>index</code> variable, initialize to zero, and increment by one for each sample included in a batch. However, we do not use the <code>index</code> to access the positions of the list of sentences directly. Instead, we use it to select one index from a list of indexes. In this way, we can change the order in which we traverse our original list, keeping untouched our original list.</li>
<li>The third also relates to wrapping. Because <code>batch_size</code> and the length of the input lists are not aligned, gathering a batch_size group of inputs may involve wrapping back to the beginning of the input loop. In our approach, it is just enough to reset the <code>index</code> to 0. We can re-shuffle the list of indexes to produce different batches each time.</li>
</ol>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">pad</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Generate batches of data for training</span>

<span class="sd">    Args: </span>
<span class="sd">      batch_size - size of each batch generated</span>
<span class="sd">      x - sentences where words are represented as integers</span>
<span class="sd">      y - tags associated with the sentences</span>
<span class="sd">      pad - number to use as the padding character</span>
<span class="sd">      shuffle - Whether to shuffle the data</span>
<span class="sd">      verbose - Whether to print information to stdout</span>

<span class="sd">    Yields:</span>
<span class="sd">     a tuple containing 2 elements:</span>
<span class="sd">       X - np.ndarray of dim (batch_size, max_len) of padded sentences</span>
<span class="sd">       Y - np.ndarray of dim (batch_size, max_len) of tags associated with the sentences in X</span>
<span class="sd">    """</span>    
    <span class="c1"># count the number of lines in data_lines</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># create an array with the indexes of data_lines that can be shuffled</span>
    <span class="n">lines_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_lines</span><span class="p">))</span>

    <span class="c1"># shuffle the indexes if shuffle is set to True</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines_index</span><span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># tracks current location in x, y</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">buffer_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">buffer_y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
             <span class="c1"># if the index is greater than or equal to the number of lines in x</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">num_lines</span><span class="p">:</span>
                <span class="c1"># then reset the index to 0</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># re-shuffle the indexes if shuffle is set to True</span>
                <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines_index</span><span class="p">)</span>

            <span class="c1"># The current position is obtained using `lines_index[index]`</span>
            <span class="c1"># Store the x value at the current position into the buffer_x</span>
            <span class="n">buffer_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">lines_index</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>

            <span class="c1"># Store the y value at the current position into the buffer_y</span>
            <span class="n">buffer_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">lines_index</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>

            <span class="n">lenx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer_x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>    <span class="c1">#length of current x[]</span>
            <span class="k">if</span> <span class="n">lenx</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
                <span class="n">max_len</span> <span class="o">=</span> <span class="n">lenx</span>                   <span class="c1">#max_len tracks longest x[]</span>

            <span class="c1"># increment index by one</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>


        <span class="c1"># create X,Y, NumPy arrays of size (batch_size, max_len) 'full' of pad value</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_len</span><span class="p">),</span> <span class="n">pad</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_len</span><span class="p">),</span> <span class="n">pad</span><span class="p">)</span>

        <span class="c1"># copy values from lists to NumPy arrays. Use the buffered values</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># get the example (sentence as a tensor)</span>
            <span class="c1"># in `buffer_x` at the `i` index</span>
            <span class="n">x_i</span> <span class="o">=</span> <span class="n">buffer_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># similarly, get the example's labels</span>
            <span class="c1"># in `buffer_y` at the `i` index</span>
            <span class="n">y_i</span> <span class="o">=</span> <span class="n">buffer_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Walk through each word in x_i</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_i</span><span class="p">)):</span>
                <span class="c1"># store the word in x_i at position j into X</span>
                <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                <span class="c1"># store the label in y_i at position j into Y</span>
                <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">"index="</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">yield</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">mini_sentences</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="mi">8</span><span class="p">]</span>
<span class="n">mini_labels</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="mi">8</span><span class="p">]</span>
<span class="n">dg</span> <span class="o">=</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">mini_sentences</span><span class="p">,</span> <span class="n">mini_labels</span><span class="p">,</span> <span class="n">vocab</span><span class="p">[</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>
<span class="n">X2</span><span class="p">,</span> <span class="n">Y2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Y1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Y2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">][:],</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">Y1</span><span class="p">[</span><span class="mi">0</span><span class="p">][:])</span>
</pre></div>
<pre class="example">
index= 5
index= 2
(5, 27) (5, 27) (5, 24) (5, 24)
[ 7848   538  5951  6187   172   502  2453     9   293    11  5306   822
   141  1962     7 26689  1176   686 11905 14806    11     9   292    21
 35178 35178 35178] 
 [    0     0     3    10     0     0     0     0     0     0     0     0
     0     0     0     0     0     0     0     0     0     0     0     0
 35178 35178 35178]
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org8049c57">
<h2 id="org8049c57">Bundle It Up</h2>
<div class="outline-text-2" id="text-org8049c57"></div>
<div class="outline-3" id="outline-container-org14a0fab">
<h3 id="org14a0fab">Imports</h3>
<div class="outline-text-3" id="text-org14a0fab">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org85fff6f">
<h3 id="org85fff6f">Some Types</h3>
<div class="outline-text-3" id="text-org85fff6f">
<div class="highlight">
<pre><span></span><span class="n">Vectors</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
<span class="n">Batch</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org566db03">
<h3 id="org566db03">The Data Generator</h3>
<div class="outline-text-3" id="text-org566db03">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataGenerator</span><span class="p">:</span>
    <span class="sd">"""A generator of data to train the NER Model</span>

<span class="sd">    Args:</span>
<span class="sd">     batch_size: how many lines to generate at once</span>
<span class="sd">     x: the encoded sentences</span>
<span class="sd">     y: the encoded labels </span>
<span class="sd">     padding: encoding to use for padding lines</span>
<span class="sd">     shuffle: whether to shuffle the data</span>
<span class="sd">     verbose: whether to print messages to stdout</span>
<span class="sd">    """</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">Vectors</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">Vectors</span>
    <span class="n">padding</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">_batch</span><span class="p">:</span> <span class="nb">iter</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orga609f78">
<h4 id="orga609f78">The Batch Generator</h4>
<div class="outline-text-4" id="text-orga609f78">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">batch_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Generates batches"""</span>
    <span class="n">line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">line_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">line_count</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">line_indices</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">x_batch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="n">y_batch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="n">longest</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">batch_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">line_count</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">line_indices</span><span class="p">)</span>

            <span class="n">x_batch</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">line_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
            <span class="n">y_batch</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">line_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>

            <span class="n">longest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">longest</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_batch</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]))</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">longest</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">longest</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span> 
            <span class="n">line</span> <span class="o">=</span> <span class="n">x_batch</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">y_batch</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>
                <span class="n">X</span><span class="p">[</span><span class="n">batch_index</span><span class="p">,</span> <span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
                <span class="n">Y</span><span class="p">[</span><span class="n">batch_index</span><span class="p">,</span> <span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"index="</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
    <span class="k">return</span>    
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgcb8d175">
<h4 id="orgcb8d175">The Generator Method</h4>
<div class="outline-text-4" id="text-orgcb8d175">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""The instance of the generator"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_generator</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdef3ca3">
<h4 id="orgdef3ca3">The Iterator Method</h4>
<div class="outline-text-4" id="text-orgdef3ca3">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org858e1d7">
<h4 id="org858e1d7">The Next Method</h4>
<div class="outline-text-4" id="text-org858e1d7">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Batch</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgacb7400">
<h3 id="orgacb7400">Test It</h3>
<div class="outline-text-3" id="text-orgacb7400">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">DataGenerator</span>

<span class="n">generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span>
                          <span class="n">y</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="mi">8</span><span class="p">],</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">padding</span><span class="o">=</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>

<span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
<span class="n">X2</span><span class="p">,</span> <span class="n">Y2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Y1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Y2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">][:],</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">Y1</span><span class="p">[</span><span class="mi">0</span><span class="p">][:])</span>
</pre></div>
<pre class="example">
(5, 27) (5, 27) (5, 24) (5, 24)
[ 7848   538  5951  6187   172   502  2453     9   293    11  5306   822
   141  1962     7 26689  1176   686 11905 14806    11     9   292    21
 35178 35178 35178] 
 [    0     0     3    10     0     0     0     0     0     0     0     0
     0     0     0     0     0     0     0     0     0     0     0     0
 35178 35178 35178]
</pre></div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/named-entity-recognition/">Named Entity Recognition</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/named-entity-recognition/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T14:55:54-08:00" itemprop="datePublished" title="2021-01-13 14:55">2021-01-13 14:55</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/named-entity-recognition/#orge3f6b89">Named Entity Recognition (NER)</a>
<ul>
<li><a href="posts/nlp/named-entity-recognition/#orgd649de0">The Posts In Order</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orge3f6b89">
<h2 id="orge3f6b89">Named Entity Recognition (NER)</h2>
<div class="outline-text-2" id="text-orge3f6b89">
<p>We'll start with the question - "What is Named Entity Recognition (NER)?". NER is a subtask of information extraction that locates and classifies named entities in a text. The named entities could be organizations, persons, locations, times, etc.</p>
<p>We'll train a named entity recognition system that could be trained in a few seconds (on a GPU) and will get around 75% accuracy. Then we'll load in the exact version of the model, which was trained for a longer period of time. We can then evaluate the trained version of the model to get 96% accuracy! Finally, we'll test the named entity recognition system with new sentences.</p>
</div>
<div class="outline-3" id="outline-container-orgd649de0">
<h3 id="orgd649de0">The Posts In Order</h3>
<div class="outline-text-3" id="text-orgd649de0">
<p>These are the posts where we'll actually implement the code.</p>
<ul class="org-ul">
<li><a href="posts/nlp/ner-pre-processing-the-data/">Preprocessing The Data</a></li>
<li><a href="posts/nlp/ner-data/">Generating the Data</a></li>
<li><a href="posts/nlp/ner-building-the-model/">Building the Model</a></li>
<li><a href="posts/nlp/ner-training-the-model/">Training the Model</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/">Evaluating the Model</a></li>
<li><a href="posts/nlp/ner-testing-the-model/">Testing the Model</a></li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-pre-processing-the-data/">NER: Pre-Processing the Data</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-pre-processing-the-data/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T14:43:13-08:00" itemprop="datePublished" title="2021-01-13 14:43">2021-01-13 14:43</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-pre-processing-the-data/#orgb7b7736">Preprocessing The Data</a>
<ul>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org3e9c44f">Imports</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#orga2accc4">Set Up</a>
<ul>
<li><a href="posts/nlp/ner-pre-processing-the-data/#orgd79c9e6">The Dataset</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org8c5f2eb">Middle</a>
<ul>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org520edb2">The Kaggle Data</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org7ccaaa4">Words and Tags</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org7fc741e">Sentences and Labels</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org6f257ab">To Numbers</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org61afc1c">The Train-Test Split</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#orga8a1f3a">Bundling This Up</a>
<ul>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org32d11ae">Imports</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org841a937">Some Constants</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org08394b4">The Data Processor</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org6e1a362">Data Vectorizer</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org23fac43">The Splitter</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org95151bd">The Loader</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#orgbde1cbd">The Processor</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org7440e8b">Testing It Out</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgb7b7736">
<h2 id="orgb7b7736">Preprocessing The Data</h2>
<div class="outline-text-2" id="text-orgb7b7736">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-data/">The Next Post</a></li>
</ul>
<p>We will be using a dataset from <a href="https://www.kaggle.com/abhinavwalia95/entity-annotated-corpus">Kaggle</a> which appears to have originally come from the <a href="https://gmb.let.rug.nl/">Groningen Meaning Bank</a> (a bank of texts, not money). The original data consists of four columns, the sentence number, the word, the part of speech of the word, and the tags. A few tags you might expect to see are:</p>
<ul class="org-ul">
<li>geo: geographical entity</li>
<li>org: organization</li>
<li>per: person</li>
<li>gpe: geopolitical entity</li>
<li>tim: time indicator</li>
<li>art: artifact</li>
<li>eve: event</li>
<li>nat: natural phenomenon</li>
<li>O: filler word</li>
</ul>
</div>
<div class="outline-3" id="outline-container-org3e9c44f">
<h3 id="org3e9c44f">Imports</h3>
<div class="outline-text-3" id="text-org3e9c44f">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">equal</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga2accc4">
<h3 id="orga2accc4">Set Up</h3>
<div class="outline-text-3" id="text-orga2accc4"></div>
<div class="outline-4" id="outline-container-orgd79c9e6">
<h4 id="orgd79c9e6">The Dataset</h4>
<div class="outline-text-4" id="text-orgd79c9e6">
<p><b>Note:</b> to get the encoding for the file use <code>file</code>:</p>
<pre class="example" id="org31715d5">
file -bi ner_dataset.csv
</pre>
<p>In this case we get:</p>
<pre class="example" id="org2e01d64">
application/csv; charset=iso-8859-1
</pre>
<p>Since it isn't ASCII or ISO-8 we'll have to tell pandas what the encoding is.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"NER_DATASET"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"ISO-8859-1"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org8c5f2eb">
<h2 id="org8c5f2eb">Middle</h2>
<div class="outline-text-2" id="text-org8c5f2eb"></div>
<div class="outline-3" id="outline-container-org520edb2">
<h3 id="org520edb2">The Kaggle Data</h3>
<div class="outline-text-3" id="text-org520edb2">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">&nbsp;</th>
<th class="org-right" scope="col">Sentence #</th>
<th class="org-left" scope="col">Word</th>
<th class="org-left" scope="col">POS</th>
<th class="org-left" scope="col">Tag</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">Sentence: 1</td>
<td class="org-left">Thousands</td>
<td class="org-left">NNS</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-right">nan</td>
<td class="org-left">of</td>
<td class="org-left">IN</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">2</td>
<td class="org-right">nan</td>
<td class="org-left">demonstrators</td>
<td class="org-left">NNS</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">3</td>
<td class="org-right">nan</td>
<td class="org-left">have</td>
<td class="org-left">VBP</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">4</td>
<td class="org-right">nan</td>
<td class="org-left">marched</td>
<td class="org-left">VBN</td>
<td class="org-left">O</td>
</tr>
</tbody>
</table>
<p>As you can (kind of) tell, the sentences are broken up so that each row has one word in it.</p>
<p>To make it easier to work with I'm going to rename the columns.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"Sentence #"</span><span class="p">:</span><span class="s2">"sentence"</span><span class="p">,</span> <span class="s2">"Word"</span><span class="p">:</span> <span class="s2">"word"</span><span class="p">,</span> <span class="s2">"Tag"</span><span class="p">:</span> <span class="s2">"tag"</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7ccaaa4">
<h3 id="org7ccaaa4">Words and Tags</h3>
<div class="outline-text-3" id="text-org7ccaaa4">
<p>The first thing we're going to do is separate out the words to build our vocabulary. The <code>vocabulary</code> will be a mapping of each word to an index so that we can convert our text to numbers for our model. In addition we're going to add a <code>&lt;PAD&gt;</code> token so that if our input is to short we can pad it to be the right size. And an <code>UNK</code> token in case we don't know a word.</p>
<div class="highlight">
<pre><span></span><span class="n">token</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Token"</span><span class="p">,</span> <span class="s2">"pad unknown"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">Token</span> <span class="o">=</span> <span class="n">token</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="s2">"UNK"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
<span class="n">vocabulary</span><span class="p">[</span><span class="n">Token</span><span class="o">.</span><span class="n">pad</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>
<span class="n">vocabulary</span><span class="p">[</span><span class="n">Token</span><span class="o">.</span><span class="n">unknown</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
35,180
</pre>
<p>We're going to do the same with the Tag column.</p>
<div class="highlight">
<pre><span></span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
</pre></div>
<pre class="example">
{'O': 0, 'B-geo': 1, 'B-gpe': 2, 'B-per': 3, 'I-geo': 4, 'B-org': 5, 'I-org': 6, 'B-tim': 7, 'B-art': 8, 'I-art': 9, 'I-per': 10, 'I-gpe': 11, 'I-tim': 12, 'B-nat': 13, 'B-eve': 14, 'I-eve': 15, 'I-nat': 16}
</pre>
<p><b>Note:</b> This is actually cheating because I am using the whole dataset. Later on make sure to only use the training data.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org7fc741e">
<h3 id="org7fc741e">Sentences and Labels</h3>
<div class="outline-text-3" id="text-org7fc741e">
<p>We're also going to need to smash the words back into sentences. There's probably a clever pandas way to do this, but I'll just brute-force it. We'll also need to join the labels for the sentences into strings.</p>
<div class="highlight">
<pre><span></span><span class="n">sentences</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sentence</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pandas</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">sentence</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="n">sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sentence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
47,958
47,958
['Thousands', 'of', 'demonstrators', 'have', 'marched', 'through', 'London', 'to', 'protest', 'the', 'war', 'in', 'Iraq', 'and', 'demand', 'the', 'withdrawal', 'of', 'British', 'troops', 'from', 'that', 'country', '.']
['O', 'O', 'O', 'O', 'O', 'O', 'B-geo', 'O', 'O', 'O', 'O', 'O', 'B-geo', 'O', 'O', 'O', 'O', 'O', 'B-gpe', 'O', 'O', 'O', 'O', 'O']
</pre>
<p>We're going to convert them to numbers so I didn't join them into strings.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org6f257ab">
<h3 id="org6f257ab">To Numbers</h3>
<div class="outline-text-3" id="text-org6f257ab">
<div class="highlight">
<pre><span></span><span class="n">sentence_vectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="n">vocabulary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">Token</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span>
<span class="p">]</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence_vectors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sentence_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 9, 15, 1, 16, 17, 18, 19, 20, 21]
</pre>
<div class="highlight">
<pre><span></span><span class="n">label_vectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">sentence_labels</span><span class="p">]</span> <span class="k">for</span> <span class="n">sentence_labels</span> <span class="ow">in</span> <span class="n">labels</span>
<span class="p">]</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_vectors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
[0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0]
</pre>
<p>In this case we're assuming that there's no unknown tags because they are only used for training and testing so we wouldn't expect to see one that isn't in our current dataset, unlike the sentences which are going to be used with new data and so might have tokens we haven't seen before.</p>
<p>We could add the padding here, but instead we're going to do it in the batch generator.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org61afc1c">
<h3 id="org61afc1c">The Train-Test Split</h3>
<div class="outline-text-3" id="text-org61afc1c">
<p>This time we're going to do a real train-validation-test split.</p>
<div class="highlight">
<pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Split"</span><span class="p">,</span> <span class="s2">"train validation test"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">Split</span> <span class="o">=</span> <span class="n">splits</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="mi">33570</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="mi">7194</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="mi">7194</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_leftovers</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_leftovers</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="n">Split</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
<span class="n">x_validation</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_validation</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">x_leftovers</span><span class="p">,</span> <span class="n">y_leftovers</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">Split</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">train</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">train</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_validation</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">validation</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_validation</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">validation</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">test</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">test</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga8a1f3a">
<h3 id="orga8a1f3a">Bundling This Up</h3>
<div class="outline-text-3" id="text-orga8a1f3a"></div>
<div class="outline-4" id="outline-container-org32d11ae">
<h4 id="org32d11ae">Imports</h4>
<div class="outline-text-4" id="text-org32d11ae">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org841a937">
<h4 id="org841a937">Some Constants</h4>
<div class="outline-text-4" id="text-org841a937">
<div class="highlight">
<pre><span></span><span class="n">Read</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Read"</span><span class="p">,</span> <span class="s2">"dotenv key encoding"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">READ</span> <span class="o">=</span> <span class="n">Read</span><span class="p">(</span><span class="n">dotenv</span><span class="o">=</span><span class="s2">"posts/nlp/.env"</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">"NER_DATASET"</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">"ISO-8859-1"</span><span class="p">)</span>

<span class="n">COLUMNS</span><span class="o">=</span><span class="p">{</span><span class="s2">"Sentence #"</span><span class="p">:</span><span class="s2">"sentence"</span><span class="p">,</span>
         <span class="s2">"Word"</span><span class="p">:</span> <span class="s2">"word"</span><span class="p">,</span>
         <span class="s2">"Tag"</span><span class="p">:</span> <span class="s2">"tag"</span><span class="p">}</span>

<span class="n">Token</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Token"</span><span class="p">,</span> <span class="s2">"pad unknown"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">TOKEN</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="s2">"UNK"</span><span class="p">)</span>

<span class="n">Splits</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Split"</span><span class="p">,</span> <span class="s2">"train validation test"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">SPLIT</span> <span class="o">=</span> <span class="n">Splits</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="mi">33570</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="mi">7194</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="mi">7194</span><span class="p">)</span>

<span class="n">DataSets</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"DataSets"</span><span class="p">,</span> <span class="p">[</span>
    <span class="s2">"x_train"</span><span class="p">,</span>
    <span class="s2">"y_train"</span><span class="p">,</span>
    <span class="s2">"x_validate"</span><span class="p">,</span>
    <span class="s2">"y_validate"</span><span class="p">,</span>
    <span class="s2">"x_test"</span><span class="p">,</span>
    <span class="s2">"y_test"</span>
<span class="p">])</span>

<span class="n">TheData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"TheData"</span><span class="p">,</span> <span class="p">[</span>
    <span class="s2">"vocabulary"</span><span class="p">,</span>
    <span class="s2">"tags"</span><span class="p">,</span>
    <span class="s2">"data_sets"</span><span class="p">,</span>
    <span class="s2">"raw_data_sets"</span><span class="p">,</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org08394b4">
<h4 id="org08394b4">The Data Processor</h4>
<div class="outline-text-4" id="text-org08394b4">
<p>Each of the three sets needs to be vectorized since I'm not saving the sentences beforehand. So this class handles that.</p>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataFlattener</span><span class="p">:</span>
    <span class="sd">"""Converts the kaggle data to sentences and labels</span>

<span class="sd">    Args:</span>
<span class="sd">     data: the data to convert</span>
<span class="sd">    """</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">_sentences</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_labels</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org6d405b6"></a>Sentences<br>
<div class="outline-text-5" id="text-org6d405b6">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">sentences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""List of sentences from the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_sentences_and_labels</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span>
</pre></div>
</div>
</li>
<li><a id="org94592ca"></a>Labels<br>
<div class="outline-text-5" id="text-org94592ca">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""List of labels from the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_sentences_and_labels</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span>
</pre></div>
</div>
</li>
<li><a id="org99a4839"></a>Sentences and Labels maker<br>
<div class="outline-text-5" id="text-org99a4839">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">set_sentences_and_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Converts the data to lists</span>
<span class="sd">    of sentence token lists and also sets the labels</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sentence</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pandas</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">sentence</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sentence</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">sentence</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sentence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org6e1a362">
<h4 id="org6e1a362">Data Vectorizer</h4>
<div class="outline-text-4" id="text-org6e1a362">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataVectorizer</span><span class="p">:</span>
    <span class="sd">"""Converts the data-set strings to vectors</span>

<span class="sd">    Args:</span>
<span class="sd">     data_sets: the split up data sets</span>
<span class="sd">     vocabulary: map from token to index</span>
<span class="sd">     tags: map from tag to index</span>
<span class="sd">    """</span>
    <span class="n">data_sets</span><span class="p">:</span> <span class="n">namedtuple</span>
    <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_vectorized_datasets</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org82ac5d9"></a>Vectorized Data Sets<br>
<div class="outline-text-5" id="text-org82ac5d9">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vectorized_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
    <span class="sd">"""the original data sets converted to indices"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorized_datasets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sentence_vectors</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_vectors</span><span class="p">,</span>
                                   <span class="n">to_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
        <span class="n">label_vectors</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_vectors</span><span class="p">,</span>
                                <span class="n">to_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vectorized_datasets</span> <span class="o">=</span> <span class="n">DataSets</span><span class="p">(</span>
            <span class="n">x_train</span> <span class="o">=</span> <span class="n">sentence_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">),</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">label_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">),</span>
            <span class="n">x_validate</span> <span class="o">=</span> <span class="n">sentence_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_validate</span><span class="p">),</span>
            <span class="n">y_validate</span> <span class="o">=</span> <span class="n">label_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_validate</span><span class="p">),</span>
            <span class="n">x_test</span> <span class="o">=</span> <span class="n">sentence_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_test</span><span class="p">),</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">label_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_test</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorized_datasets</span>
</pre></div>
</div>
</li>
<li><a id="org53c7fc4"></a>Sentence Vectors<br>
<div class="outline-text-5" id="text-org53c7fc4">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">to_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">to_index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Sentences converted to Integers</span>

<span class="sd">    Args:</span>
<span class="sd">     source: iterator of tokenized strings to convert</span>
<span class="sd">     to_index: map to convert the tokens to indices</span>

<span class="sd">    Returns:</span>
<span class="sd">     tokens in source converted to indices</span>
<span class="sd">    """</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source</span>
        <span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vectors</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org23fac43">
<h4 id="org23fac43">The Splitter</h4>
<div class="outline-text-4" id="text-org23fac43">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataSplitter</span><span class="p">:</span>
    <span class="sd">"""Splits up the training, testing, etc.</span>

<span class="sd">    Args:</span>
<span class="sd">     split: constants with the train, test counts</span>
<span class="sd">     sentences: input data to split</span>
<span class="sd">     labels: y-data to split</span>
<span class="sd">     random_state: seed for the splitting</span>
<span class="sd">    """</span>
    <span class="n">split</span><span class="p">:</span> <span class="n">namedtuple</span>
    <span class="n">sentences</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span>    
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_data_sets</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgc92ea2a"></a>Data Sets<br>
<div class="outline-text-5" id="text-orgc92ea2a">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
    <span class="sd">"""The Split data sets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_train</span><span class="p">,</span> <span class="n">x_leftovers</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_leftovers</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentences</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">train_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">train</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">x_validate</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">x_leftovers</span><span class="p">,</span>
            <span class="n">y_leftovers</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">test</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_sets</span> <span class="o">=</span> <span class="n">DataSets</span><span class="p">(</span><span class="n">x_train</span><span class="o">=</span><span class="n">x_train</span><span class="p">,</span>
                                   <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
                                   <span class="n">x_validate</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                                   <span class="n">y_validate</span><span class="o">=</span><span class="n">y_validate</span><span class="p">,</span>
                                   <span class="n">x_test</span><span class="o">=</span><span class="n">x_test</span><span class="p">,</span>
                                   <span class="n">y_test</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span>
                                   <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_validate</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sentences</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_sets</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org95151bd">
<h4 id="org95151bd">The Loader</h4>
<div class="outline-text-4" id="text-org95151bd">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataLoader</span><span class="p">:</span>
    <span class="sd">"""Loads and converts the kaggle data</span>

<span class="sd">    Args:</span>
<span class="sd">      read: the stuff to download the data</span>
<span class="sd">    """</span>
    <span class="n">read</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="n">READ</span>    
    <span class="n">_data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tags</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org5548e30"></a>The Kaggle Data<br>
<div class="outline-text-5" id="text-org5548e30">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">"""The original kaggle dataset"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">load_dotenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">dotenv</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">COLUMNS</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>
</div>
</li>
<li><a id="orgb36bd32"></a>The Vocabulary<br>
<div class="outline-text-5" id="text-orgb36bd32">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""map of word to index</span>

<span class="sd">    Note:</span>
<span class="sd">      This is creating a transformation of the entire data-set</span>
<span class="sd">    so it comes before the train-test-split so it uses the whole</span>
<span class="sd">    dataset, not just training</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">word</span><span class="p">:</span> <span class="n">index</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span>
</pre></div>
</div>
</li>
<li><a id="org1295804"></a>The Tags<br>
<div class="outline-text-5" id="text-org1295804">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""map of tag to index"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orgbde1cbd">
<h4 id="orgbde1cbd">The Processor</h4>
<div class="outline-text-4" id="text-orgbde1cbd">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NERData</span><span class="p">:</span>
    <span class="sd">"""Master NER Data preparer</span>

<span class="sd">    Args:</span>
<span class="sd">     read_constants: stuff to help load the dataset</span>
<span class="sd">     split_constants: stuff to help split the dataset</span>
<span class="sd">     random_state: seed for the splitting</span>
<span class="sd">    """</span>
    <span class="n">read_constants</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="n">READ</span>
    <span class="n">split_constants</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="n">SPLIT</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">33</span>
    <span class="n">_data</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_loader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_flattener</span><span class="p">:</span> <span class="n">DataFlattener</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_splitter</span><span class="p">:</span> <span class="n">DataSplitter</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vectorizer</span> <span class="o">=</span> <span class="n">DataVectorizer</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgaa2b53c"></a>The Data<br>
<div class="outline-text-5" id="text-orgaa2b53c">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
    <span class="sd">"""The split up data sets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">TheData</span><span class="p">(</span>
            <span class="n">vocabulary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">raw_data_sets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">data_sets</span><span class="p">,</span>
            <span class="n">data_sets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectorized_datasets</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>
</div>
</li>
<li><a id="org55efb26"></a>The Loader<br>
<div class="outline-text-5" id="text-org55efb26">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">loader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
    <span class="sd">"""The loader of the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">read</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_constants</span><span class="p">,</span>            
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span>
</pre></div>
</div>
</li>
<li><a id="org93954cb"></a>The Flattener<br>
<div class="outline-text-5" id="text-org93954cb">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">flattener</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFlattener</span><span class="p">:</span>
    <span class="sd">"""The sentence and label builder"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flattener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flattener</span> <span class="o">=</span> <span class="n">DataFlattener</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flattener</span>
</pre></div>
</div>
</li>
<li><a id="org22ae9fb"></a>The Splitter<br>
<div class="outline-text-5" id="text-org22ae9fb">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">splitter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataSplitter</span><span class="p">:</span>
    <span class="sd">"""The splitter upper for the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span> <span class="o">=</span> <span class="n">DataSplitter</span><span class="p">(</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_constants</span><span class="p">,</span>
            <span class="n">sentences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattener</span><span class="o">.</span><span class="n">sentences</span><span class="p">,</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattener</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span>
</pre></div>
</div>
</li>
<li><a id="org311b951"></a>The Vectorizer<br>
<div class="outline-text-5" id="text-org311b951">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vectorizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataVectorizer</span><span class="p">:</span>
    <span class="sd">"""Vectorizes the raw-data sets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vectorizer</span> <span class="o">=</span> <span class="n">DataVectorizer</span><span class="p">(</span>
            <span class="n">data_sets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">data_sets</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">vocabulary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorizer</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org7440e8b">
<h4 id="org7440e8b">Testing It Out</h4>
<div class="outline-text-4" id="text-org7440e8b">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">NERData</span>

<span class="n">ner</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span>

<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">Split</span><span class="o">.</span><span class="n">train</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_validate</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">Split</span><span class="o">.</span><span class="n">validation</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_test</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">Split</span><span class="o">.</span><span class="n">test</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/rnns-and-vanishing-gradients/">RNNS and Vanishing Gradients</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/rnns-and-vanishing-gradients/" rel="bookmark"><time class="published dt-published" datetime="2021-01-10T18:52:32-08:00" itemprop="datePublished" title="2021-01-10 18:52">2021-01-10 18:52</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org98a7cf2">Vanishing Gradients</a>
<ul>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orga1e80e2">Background</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org44f3412">Imports</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orge680ed3">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org3833fe2">Middle</a>
<ul>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org0148401">The Data</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orga46f84d">The Sigmoid</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orgbaef3e9">The Gradient</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org14c2b17">Plotting the Sigmoid</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orgf62b2cf">The Numerical Impact</a>
<ul>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org0e5c5cf">Multiplication & Decay</a></li>
</ul>
</li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org3c4f499">A Decay Simulation</a>
<ul>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org2fc8f45">Input data</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orgad5ea92">Plot The Decay</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org90ef4ee">So, How Do You Fix This?</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org98a7cf2">
<h2 id="org98a7cf2">Vanishing Gradients</h2>
<div class="outline-text-2" id="text-org98a7cf2">
<p>This will be a look at the problem of vanishing gradients from an intuitive standpoint.</p>
</div>
<div class="outline-3" id="outline-container-orga1e80e2">
<h3 id="orga1e80e2">Background</h3>
<div class="outline-text-3" id="text-orga1e80e2">
<p>Adding layers to a neural network introduces multiplicative effects in both forward and backward propagation. The back-prop in particular presents a problem as the gradient of activation functions can be very small. Multiplied together across many layers, their product can be vanishingly small. This results in weights not being updated in the front layers and training not progressing.</p>
<p>Gradients of the sigmoid function, for example, are in the range 0 to 0.25. To calculate gradients for the front layers of a neural network the chain rule is used. This means that these tiny values are multiplied starting at the last layer, working backwards to the first layer, with the gradients shrinking exponentially at each step.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org44f3412">
<h3 id="org44f3412">Imports</h3>
<div class="outline-text-3" id="text-org44f3412">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># another project</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orge680ed3">
<h3 id="orge680ed3">Set Up</h3>
<div class="outline-text-3" id="text-orge680ed3">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"rnns-and-vanishing-gradients"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Plot"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"width"</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">,</span> <span class="s2">"fontscale"</span><span class="p">,</span> <span class="s2">"tan"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">])</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3833fe2">
<h2 id="org3833fe2">Middle</h2>
<div class="outline-text-2" id="text-org3833fe2"></div>
<div class="outline-3" id="outline-container-org0148401">
<h3 id="org0148401">The Data</h3>
<div class="outline-text-3" id="text-org0148401">
<p>This will be an evenly spaced set of points over an interval (see <a href="https://numpy.org/doc/stable/reference/generated/numpy.linspace.html">numpy.linspace</a>).</p>
<div class="highlight">
<pre><span></span><span class="n">STOP</span><span class="p">,</span> <span class="n">STEPS</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">STOP</span><span class="p">,</span> <span class="n">STOP</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga46f84d">
<h3 id="orga46f84d">The Sigmoid</h3>
<div class="outline-text-3" id="text-orga46f84d">
<p>Our activation function will be the <a href="https://en.wikipedia.org/wiki/Sigmoid_function">sigmoid (wikipedia link)</a> (well, the logistic function).</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>
</pre></div>
<p>Now we'll calculate the activations for our input data.</p>
<div class="highlight">
<pre><span></span><span class="n">activations</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgbaef3e9">
<h3 id="orgbaef3e9">The Gradient</h3>
<div class="outline-text-3" id="text-orgbaef3e9">
<p>Our gradient is the derivative of the sigmoid.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">gradient</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
<p>Now we can get the gradients for our activations.</p>
<div class="highlight">
<pre><span></span><span class="n">gradients</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">activations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org14c2b17">
<h3 id="org14c2b17">Plotting the Sigmoid</h3>
<div class="outline-text-3" id="text-org14c2b17">
<div class="highlight">
<pre><span></span><span class="n">tangent_x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">tangent_y</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">tangent_x</span><span class="p">)</span>
<span class="n">span</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">gradient_tangent</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">tangent_x</span><span class="p">))</span>

<span class="n">tangent_plot_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tangent_x</span> <span class="o">-</span> <span class="n">span</span><span class="p">,</span> <span class="n">tangent_x</span> <span class="o">+</span> <span class="n">span</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">)</span>
<span class="n">tangent_plot_y</span> <span class="o">=</span> <span class="n">tangent_y</span> <span class="o">+</span> <span class="n">gradient_tangent</span> <span class="o">*</span> <span class="p">(</span><span class="n">tangent_plot_x</span> <span class="o">-</span> <span class="n">tangent_x</span><span class="p">)</span>

<span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">"X"</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
     <span class="s2">"Sigmoid"</span><span class="p">:</span> <span class="n">activations</span><span class="p">,</span>
     <span class="s2">"X-Tangent"</span><span class="p">:</span> <span class="n">tangent_plot_x</span><span class="p">,</span>
     <span class="s2">"Y-Tangent"</span><span class="p">:</span> <span class="n">tangent_plot_y</span><span class="p">,</span>
     <span class="s2">"Gradient"</span><span class="p">:</span> <span class="n">gradients</span><span class="p">})</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Sigmoid"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Gradient"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X-Tangent"</span><span class="p">,</span>
                       <span class="n">y</span><span class="o">=</span><span class="s2">"Y-Tangent"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">tan</span><span class="p">))</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">"Sigmoid and Tangent"</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="n">fontscale</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">fontscale</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"sigmoid_tangent"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/rnns-and-vanishing-gradients/sigmoid_tangent.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The thing to notice is that as the input data moves away from the center (at 0) the gradients get smaller in either direction, rapidly approaching zero.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgf62b2cf">
<h3 id="orgf62b2cf">The Numerical Impact</h3>
<div class="outline-text-3" id="text-orgf62b2cf"></div>
<div class="outline-4" id="outline-container-org0e5c5cf">
<h4 id="org0e5c5cf">Multiplication & Decay</h4>
<div class="outline-text-4" id="text-org0e5c5cf">
<p>Multiplying numbers smaller than 1 results in smaller and smaller numbers. Below is an example that finds the gradient for an input <i>x = 0</i> and multiplies it over n steps. Look how quickly it 'Vanishes' to almost zero. Yet \(\sigma(x=0) \implies 0.5\) which has a sigmoid gradient of 0.25 and that happens to be the largest sigmoid gradient possible.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org3c4f499">
<h3 id="org3c4f499">A Decay Simulation</h3>
<div class="outline-text-3" id="text-org3c4f499"></div>
<div class="outline-4" id="outline-container-org2fc8f45">
<h4 id="org2fc8f45">Input data</h4>
<div class="outline-text-4" id="text-org2fc8f45">
<div class="highlight">
<pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">gradients</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">steps</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Inputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"steps :"</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x value :"</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"sigmoid :"</span><span class="p">,</span> <span class="s2">"</span><span class="si">{:.5f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"gradient :"</span><span class="p">,</span> <span class="s2">"</span><span class="si">{:.5f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gradients</span><span class="p">),</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Inputs --
steps : 6
x value : 0
sigmoid : 0.50000
gradient : 0.25000 

</pre></div>
</div>
<div class="outline-4" id="outline-container-orgad5ea92">
<h4 id="orgad5ea92">Plot The Decay</h4>
<div class="outline-text-4" id="text-orgad5ea92">
<div class="highlight">
<pre><span></span><span class="n">decaying_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">))</span> <span class="o">*</span> <span class="n">gradients</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">Step</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">Gradient</span><span class="o">=</span><span class="n">decaying_values</span><span class="p">))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Step"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Gradient"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Cumulative Gradient"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">fontscale</span>
<span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"cumulative_gradient"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/rnns-and-vanishing-gradients/cumulative_gradient.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The point being that the gradients very quickly approach zero.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org90ef4ee">
<h2 id="org90ef4ee">So, How Do You Fix This?</h2>
<div class="outline-text-2" id="text-org90ef4ee">
<p>One solution is to use activation functions that don't have tiny gradients. Other solutions involve more sophisticated model design. But they're both discussions for another time.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/deep-n-grams-batch-generation/">Deep N-Grams: Batch Generation</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/deep-n-grams-batch-generation/" rel="bookmark"><time class="published dt-published" datetime="2021-01-05T17:08:48-08:00" itemprop="datePublished" title="2021-01-05 17:08">2021-01-05 17:08</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org4c33076">Generating Batches of Data</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org587b4a7">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org1b3b9f2">Set Up</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org37bacff">The DataLoader</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org302a98b">Middle</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgae7b466">The Data Generator</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgbce3a82">Implementing the Generator</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgb3fe97a">Try out the data generator.</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgb716386">Repeating Batch generator</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orge52bbd9">Bundle It Up</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgde66e12">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org4fddc66">Data Generator</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org6c2d63e">Line Count</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgc06983b">Line Indices</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgc9c094c">The Iterator Method</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgf6f0498">The Batch Generator</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org951e7dd">The Generator</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org756ca76">The Next Method</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgd78badb">Try It Out</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org4c33076">
<h2 id="org4c33076">Generating Batches of Data</h2>
<div class="outline-text-2" id="text-org4c33076">
<ul class="org-ul">
<li><a href="posts/nlp/deep-n-grams/">First Post</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/">Previous Post</a></li>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/">Next Post</a></li>
</ul>
<p>Most of the time in Natural Language Processing, and AI in general we use batches when training our data sets. Here, you will build a data generator that takes in a text and returns a batch of text lines (lines are sentences).</p>
<ul class="org-ul">
<li>The generator converts text lines (sentences) into numpy arrays of integers padded by zeros so that all arrays have the same length, which is the length of the longest sentence in the entire data set.</li>
</ul>
<p>This generator returns the data in a format that you could directly use in your model when computing the feed-forward pass of your algorithm. This iterator returns a batch of lines and a per-token mask. The batch is a tuple of three parts: inputs, targets, and mask. The inputs and targets are identical. The second column will be used to evaluate your predictions. Mask is 1 for non-padding tokens.</p>
</div>
<div class="outline-3" id="outline-container-org587b4a7">
<h3 id="org587b4a7">Imports</h3>
<div class="outline-text-3" id="text-org587b4a7">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">be_true</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn.data_loader</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1b3b9f2">
<h3 id="org1b3b9f2">Set Up</h3>
<div class="outline-text-3" id="text-org1b3b9f2"></div>
<div class="outline-4" id="outline-container-org37bacff">
<h4 id="org37bacff">The DataLoader</h4>
<div class="outline-text-4" id="text-org37bacff">
<div class="highlight">
<pre><span></span><span class="n">data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org302a98b">
<h2 id="org302a98b">Middle</h2>
<div class="outline-text-2" id="text-org302a98b"></div>
<div class="outline-3" id="outline-container-orgae7b466">
<h3 id="orgae7b466">The Data Generator</h3>
<div class="outline-text-3" id="text-orgae7b466">
<ul class="org-ul">
<li>While True loop: this will yield one batch at a time.</li>
<li>if index &gt;= num_lines, set index to 0.</li>
<li>The generator should return shuffled batches of data. To achieve this without modifying the actual lines a list containing the indexes of data_lines` is created. This list can be shuffled and used to get random batches everytime the index is reset.</li>
<li>if len(line) &lt; max_length append line to cur_batch.
<ul class="org-ul">
<li>Note that a line that has length equal to max_length should not be appended to the batch.</li>
<li>This is because when converting the characters into a tensor of integers, an additional end of sentence token id will be added.</li>
<li>So if max_length is 5, and a line has 4 characters, the tensor representing those 4 characters plus the end of sentence character will be f length 5, which is the max length.</li>
</ul>
</li>
<li>if len(cur_batch) == batch_size, go over every line, convert it to an int and store it.</li>
</ul>
<p><b>Remember that when calling np you are really calling trax.fastmath.numpy which is trax’s version of numpy that is compatible with JAX. As a result of this, where you used to encounter the type numpy.ndarray now you will find the type jax.interpreters.xla.DeviceArray.</b></p>
<p><b>Hints:</b></p>
<ul class="org-ul">
<li>Use the line_to_tensor function above inside a list comprehension in order to pad lines with zeros.</li>
<li>Keep in mind that the length of the tensor is always 1 + the length of the original line of characters. Keep this in mind when setting the padding of zeros.</li>
</ul>
<p>To get it to pass you'll have to pass in the <code>to-tensor</code> method of the <code>DataLoader</code> so we'll need to alias it to match their definition.</p>
<div class="highlight">
<pre><span></span><span class="n">line_to_tensor</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">to_tensor</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgbce3a82">
<h4 id="orgbce3a82">Implementing the Generator</h4>
<div class="outline-text-4" id="text-orgbce3a82">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                   <span class="n">line_to_tensor</span><span class="o">=</span><span class="n">line_to_tensor</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">"""Generator function that yields batches of data</span>

<span class="sd">    Args:</span>
<span class="sd">       batch_size (int): number of examples (in this case, sentences) per batch.</span>
<span class="sd">       max_length (int): maximum length of the output tensor.</span>
<span class="sd">       NOTE: max_length includes the end-of-sentence character that will be added</span>
<span class="sd">               to the tensor.  </span>
<span class="sd">               Keep in mind that the length of the tensor is always 1 + the length</span>
<span class="sd">               of the original line of characters.</span>
<span class="sd">       data_lines (list): list of the sentences to group into batches.</span>
<span class="sd">       line_to_tensor (function, optional): function that converts line to tensor. Defaults to line_to_tensor.</span>
<span class="sd">       shuffle (bool, optional): True if the generator should generate random batches of data. Defaults to True.</span>

<span class="sd">    Yields:</span>
<span class="sd">       tuple: two copies of the batch (jax.interpreters.xla.DeviceArray) and mask (jax.interpreters.xla.DeviceArray).</span>
<span class="sd">       NOTE: jax.interpreters.xla.DeviceArray is trax's version of numpy.ndarray</span>
<span class="sd">    """</span>
    <span class="c1"># initialize the index that points to the current position in the lines index array</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># initialize the list that will contain the current batch</span>
    <span class="n">cur_batch</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># count the number of lines in data_lines</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_lines</span><span class="p">)</span>

    <span class="c1"># create an array with the indexes of data_lines that can be shuffled</span>
    <span class="n">lines_index</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">num_lines</span><span class="p">)]</span>

    <span class="c1"># shuffle line indexes if shuffle is set to True</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines_index</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># if the index is greater or equal than to the number of lines in data_lines</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">num_lines</span><span class="p">:</span>
            <span class="c1"># then reset the index to 0</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># shuffle line indexes if shuffle is set to True</span>
            <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines_index</span><span class="p">)</span>

        <span class="c1"># get a line at the `lines_index[index]` position in data_lines</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">data_lines</span><span class="p">[</span><span class="n">lines_index</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>

        <span class="c1"># if the length of the line is less than max_length</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="c1"># append the line to the current batch</span>
            <span class="n">cur_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># increment the index by one</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># if the current batch is now equal to the desired batch size</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_batch</span><span class="p">)</span> <span class="o">==</span> <span class="n">batch_size</span><span class="p">:</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># go through each line (li) in cur_batch</span>
            <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">cur_batch</span><span class="p">:</span>
                <span class="c1"># convert the line (li) to a tensor of integers</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="n">line_to_tensor</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>

                <span class="c1"># Create a list of zeros to represent the padding</span>
                <span class="c1"># so that the tensor plus padding will have length `max_length`</span>
                <span class="n">pad</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="p">))</span>

                <span class="c1"># combine the tensor plus pad</span>
                <span class="n">tensor_pad</span> <span class="o">=</span> <span class="n">tensor</span> <span class="o">+</span> <span class="n">pad</span>

                <span class="c1"># append the padded tensor to the batch</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor_pad</span><span class="p">)</span>

                <span class="c1"># A mask for  tensor_pad is 1 wherever tensor_pad is not</span>
                <span class="c1"># 0 and 0 wherever tensor_pad is 0, i.e. if tensor_pad is</span>
                <span class="c1"># [1, 2, 3, 0, 0, 0] then example_mask should be</span>
                <span class="c1"># [1, 1, 1, 0, 0, 0]</span>
                <span class="c1"># Hint: Use a list comprehension for this</span>
                <span class="n">example_mask</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tensor_pad</span><span class="p">]</span>
                <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_mask</span><span class="p">)</span>

            <span class="c1"># convert the batch (data type list) to a trax's numpy array</span>
            <span class="n">batch_np_arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">mask_np_arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>


            <span class="c1"># Yield two copies of the batch and mask.</span>
            <span class="k">yield</span> <span class="n">batch_np_arr</span><span class="p">,</span> <span class="n">batch_np_arr</span><span class="p">,</span> <span class="n">mask_np_arr</span>

            <span class="c1"># reset the current batch to an empty list</span>
            <span class="n">cur_batch</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb3fe97a">
<h4 id="orgb3fe97a">Try out the data generator.</h4>
<div class="outline-text-4" id="text-orgb3fe97a">
<div class="highlight">
<pre><span></span><span class="n">tmp_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'12345678901'</span><span class="p">,</span>
             <span class="s1">'123456789'</span><span class="p">,</span>
             <span class="s1">'234567890'</span><span class="p">,</span>
             <span class="s1">'345678901'</span><span class="p">]</span>
</pre></div>
<p>Create a generator with a batch size of 2 and a maximum length of 10.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_data_gen</span> <span class="o">=</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                              <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                              <span class="n">data_lines</span><span class="o">=</span><span class="n">tmp_lines</span><span class="p">,</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<p>Get one batch.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tmp_data_gen</span><span class="p">)</span>
</pre></div>
<p>View the batch.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tmp_batch</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]))</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp_batch</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="nb">bool</span><span class="p">((</span><span class="n">batch</span><span class="o">==</span><span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<pre class="example">
(DeviceArray([[49, 50, 51, 52, 53, 54, 55, 56, 57,  1],
             [50, 51, 52, 53, 54, 55, 56, 57, 48,  1]], dtype=int32), DeviceArray([[49, 50, 51, 52, 53, 54, 55, 56, 57,  1],
             [50, 51, 52, 53, 54, 55, 56, 57, 48,  1]], dtype=int32), DeviceArray([[1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
             [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]], dtype=int32))
</pre>
<p>Now that you have your generator, you can just call them and they will return tensors which correspond to your lines in Shakespeare. The first column and the second column are identical. Now you can go ahead and start building your neural network.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb716386">
<h3 id="orgb716386">Repeating Batch generator</h3>
<div class="outline-text-3" id="text-orgb716386">
<p>The way the iterator is currently defined, it will keep providing batches forever.</p>
<p>Although it is not needed, we want to show you the <code>itertools.cycle</code> function which is really useful when you have a generator that eventually stops.</p>
<p>Usually we want to cycle over the dataset multiple times during training (i.e. train for multiple <b>epochs</b>).</p>
<p>For small datasets we can use <a href="https://docs.python.org/3.8/library/itertools.html#itertools.cycle"><code>itertools.cycle</code></a> to achieve this easily.</p>
<div class="highlight">
<pre><span></span><span class="n">infinite_data_generator</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span>
    <span class="n">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">data_lines</span><span class="o">=</span><span class="n">tmp_lines</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">ten_lines</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">infinite_data_generator</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ten_lines</span><span class="p">))</span>
</pre></div>
<pre class="example">
10
</pre></div>
</div>
<div class="outline-3" id="outline-container-orge52bbd9">
<h3 id="orge52bbd9">Bundle It Up</h3>
<div class="outline-text-3" id="text-orge52bbd9">
<p>As always, since this is going to be needed further down the road, I'll bundle it up.</p>
</div>
<div class="outline-4" id="outline-container-orgde66e12">
<h4 id="orgde66e12">Imports</h4>
<div class="outline-text-4" id="text-orgde66e12">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn.data_loader</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4fddc66">
<h4 id="org4fddc66">Data Generator</h4>
<div class="outline-text-4" id="text-org4fddc66">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataGenerator</span><span class="p">:</span>
    <span class="sd">"""Generates batches</span>

<span class="sd">    Args:</span>
<span class="sd">     data: lines of data</span>
<span class="sd">     data_loader: something with to-tensor method</span>
<span class="sd">     batch_size: size of the batches</span>
<span class="sd">     max_length: the maximum length for a line (longer lines will be ignored)</span>
<span class="sd">     shuffle: whether to shuffle the data</span>
<span class="sd">    """</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">data_loader</span><span class="p">:</span> <span class="n">DataLoader</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">_line_count</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span> <span class="kc">None</span>
    <span class="n">_line_indices</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_generator</span><span class="p">:</span> <span class="nb">object</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6c2d63e">
<h4 id="org6c2d63e">Line Count</h4>
<div class="outline-text-4" id="text-org6c2d63e">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">line_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Number of lines in the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_count</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc06983b">
<h4 id="orgc06983b">Line Indices</h4>
<div class="outline-text-4" id="text-orgc06983b">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">line_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Indices of the lines in the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_count</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc9c094c">
<h4 id="orgc9c094c">The Iterator Method</h4>
<div class="outline-text-4" id="text-orgc9c094c">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""A pass-through for this method"""</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf6f0498">
<h4 id="orgf6f0498">The Batch Generator</h4>
<div class="outline-text-4" id="text-orgf6f0498">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Generator method that yields batches of data</span>

<span class="sd">    Yields:</span>
<span class="sd">     (batch, batch, mask)</span>
<span class="sd">    """</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_batch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_indices</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_count</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">line_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
            <span class="n">current_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_batch</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">current_batch</span><span class="p">:</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">tensor</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="p">))</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
                <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tensor</span><span class="p">])</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">current_batch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org951e7dd">
<h4 id="org951e7dd">The Generator</h4>
<div class="outline-text-4" id="text-org951e7dd">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Infinite generator of batches"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_generator</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org756ca76">
<h4 id="org756ca76">The Next Method</h4>
<div class="outline-text-4" id="text-org756ca76">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""make this an iterator"""</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd78badb">
<h3 id="orgd78badb">Try It Out</h3>
<div class="outline-text-3" id="text-orgd78badb">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn</span> <span class="kn">import</span> <span class="n">DataGenerator</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
<span class="n">test_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'12345678901'</span><span class="p">,</span>
              <span class="s1">'123456789'</span><span class="p">,</span>
              <span class="s1">'234567890'</span><span class="p">,</span>
              <span class="s1">'345678901'</span><span class="p">]</span>

<span class="n">generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">test_lines</span><span class="p">,</span>
                          <span class="n">data_loader</span><span class="o">=</span><span class="n">loader</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">actual</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]))</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span><span class="nb">bool</span><span class="p">((</span><span class="n">batch</span><span class="o">==</span><span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/deep-n-grams-generating-sentences/">Deep N-Grams: Generating Sentences</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/deep-n-grams-generating-sentences/" rel="bookmark"><time class="published dt-published" datetime="2021-01-05T16:49:26-08:00" itemprop="datePublished" title="2021-01-05 16:49">2021-01-05 16:49</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#orgaec32e3">Generating New Sentences</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org16eebf2">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org935d244">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#orgba3abb9">Middle</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org1690989">The Gumbel Sample</a></li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org4653cab">A Predictor</a></li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org0e0bc78">Some Predictions</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org8f78caf">On statistical methods</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgaec32e3">
<h2 id="orgaec32e3">Generating New Sentences</h2>
<div class="outline-text-2" id="text-orgaec32e3">
<ul class="org-ul">
<li><a href="posts/nlp/deep-n-grams/">First Post</a></li>
<li><a href="posts/nlp/deep-n-grams-evaluating-the-model/">Previous Post</a></li>
</ul>
<p>Now we'll use the language model to generate new sentences for that we need to make draws from a <a href="https://en.wikipedia.org/wiki/Gumbel_distribution">Gumble distribution</a>.</p>
<p>The Gumbel Probability Density Function (PDF) is defined as: \[ f(z) = {1\over{\beta}}e^{\left(-z+e^{(-z)}\right)} \]</p>
<p>Where: \[ z = {(x - \mu)\over{\beta}} \]</p>
<p>The maximum value is what we choose as the prediction in the last step of a Recursive Neural Network <code>RNN</code> we are using for text generation. A sample of a random variable from an exponential distribution approaches the Gumbel distribution when the sample increases asymptotically. For that reason, the Gumbel distribution is used to sample from a categorical distribution.</p>
</div>
<div class="outline-3" id="outline-container-org16eebf2">
<h3 id="org16eebf2">Imports</h3>
<div class="outline-text-3" id="text-org16eebf2">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn</span> <span class="kn">import</span> <span class="n">GRUModel</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org935d244">
<h3 id="org935d244">Set Up</h3>
<div class="outline-text-3" id="text-org935d244">
<div class="highlight">
<pre><span></span><span class="n">gru</span> <span class="o">=</span> <span class="n">GRUModel</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">gru</span><span class="o">.</span><span class="n">model</span>
<span class="n">ours</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/models/gru-shakespeare-model/model.pkl.gz"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">init_from_file</span><span class="p">(</span><span class="n">ours</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgba3abb9">
<h2 id="orgba3abb9">Middle</h2>
<div class="outline-text-2" id="text-orgba3abb9"></div>
<div class="outline-3" id="outline-container-org1690989">
<h3 id="org1690989">The Gumbel Sample</h3>
<div class="outline-text-3" id="text-org1690989">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">gumbel_sample</span><span class="p">(</span><span class="n">log_probabilities</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
                  <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Gumbel sampling from a categorical distribution</span>

<span class="sd">    Args:</span>
<span class="sd">     log_probabilities: model predictions for a given input</span>
<span class="sd">     temperature: fudge</span>

<span class="sd">    Returns:</span>
<span class="sd">     the maximum sample</span>
<span class="sd">    """</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">,</span>
                             <span class="n">size</span><span class="o">=</span><span class="n">log_probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">log_probabilities</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org4653cab">
<h3 id="org4653cab">A Predictor</h3>
<div class="outline-text-3" id="text-org4653cab">
<div class="highlight">
<pre><span></span><span class="n">END_OF_SENTENCE</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">number_of_characters</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">break_on</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">END_OF_SENTENCE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Predicts characters</span>

<span class="sd">    Args:</span>
<span class="sd">     number_of_characters: how many characters to predict</span>
<span class="sd">     prefix: character to prompt the predictions</span>
<span class="sd">     break_on: identifier for character to prematurely stop on</span>

<span class="sd">    Returns:</span>
<span class="sd">     prefix followed by predicted characters</span>
<span class="sd">    """</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">character</span><span class="p">)</span> <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">maximum_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="n">number_of_characters</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_characters</span><span class="p">):</span>
        <span class="n">current_inputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">maximum_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">current_inputs</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>  <span class="c1"># Add batch dim.</span>
        <span class="n">next_character</span> <span class="o">=</span> <span class="n">gumbel_sample</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)])</span>
        <span class="n">inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">next_character</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">inputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">break_on</span><span class="p">:</span>
            <span class="k">break</span>  <span class="c1"># EOS</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">next_character</span><span class="p">)))</span>

    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org0e0bc78">
<h3 id="org0e0bc78">Some Predictions</h3>
<div class="outline-text-3" id="text-org0e0bc78">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
</pre></div>
<pre class="example">
you would not live at essenomed 
</pre>
<p>Yes, but I don't know anyone who would. Note that we are using a random sample, so repeatedly making predictions won't necessarily get you the same result.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
</pre></div>
<pre class="example">
[exeunt]
katharine       yes, you are like the 
le beau where's some of my prett
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="s2">"falstaff"</span><span class="p">))</span>
</pre></div>
<pre class="example">
falstaff        yea, marry, lady, she hath bianced three months.
</pre>
<p><i>bianced</i>?</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="s2">"beast"</span><span class="p">))</span>
</pre></div>
<pre class="example">
beastly, and god forbid, sir! our revenue's cannon,
</pre>
<div class="highlight">
<pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="s2">"finger"</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
</pre></div>
<pre class="example">
finger, iago, an
finger, iago, and ask.
finger, iago, and ask.
finger, iago, and ask.
finger, iago, and ask.
</pre>
<p>So, if you feed it enough text, it becomes more deterministic.</p>
<div class="highlight">
<pre><span></span><span class="n">SPACE</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="s2">"iago"</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">start</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>    
</pre></div>
<pre class="example">
iago your husband if there never for you need no never
</pre>
<p>In the generated text above, you can see that the model generates text that makes sense capturing dependencies between words and without any input. A simple n-gram model would have not been able to capture all of that in one sentence.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org8f78caf">
<h2 id="org8f78caf">On statistical methods</h2>
<div class="outline-text-2" id="text-org8f78caf">
<p>Using a statistical method will not give you results that are as good. The model would not be able to encode information seen previously in the data set and as a result, the perplexity will increase. The higher the perplexity, the worse your model is. Furthermore, statistical N-Gram models take up too much space and memory. As a result, it would be inefficient and too slow. Conversely, with deep neural networks, you can get a better perplexity. Note though, that learning about n-gram language models is still important and leads to a better understanding of deep neural networks.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/deep-n-grams-evaluating-the-model/">Deep N-Grams: Evaluating the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/deep-n-grams-evaluating-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-05T16:48:54-08:00" itemprop="datePublished" title="2021-01-05 16:48">2021-01-05 16:48</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/deep-n-grams-evaluating-the-model/#org1d4abd9">Evaluating the Model</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-evaluating-the-model/#orgf1d6ec3">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-evaluating-the-model/#org440eabc">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-evaluating-the-model/#orgdfd684d">Middle</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-evaluating-the-model/#orgfc8b51a">Testing</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-evaluating-the-model/#orgb03d143">Pre-Built Model</a></li>
<li><a href="posts/nlp/deep-n-grams-evaluating-the-model/#org0cace37">Our Model</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org1d4abd9">
<h2 id="org1d4abd9">Evaluating the Model</h2>
<div class="outline-text-2" id="text-org1d4abd9">
<ul class="org-ul">
<li><a href="posts/nlp/deep-n-grams/">First Post</a></li>
<li><a href="posts/nlp/deep-n-grams-training-the-model/">Previous Post</a></li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/">Next Post</a></li>
</ul>
<p>Now that you have learned how to train a model, you will learn how to evaluate it. To evaluate language models, we usually use perplexity which is a measure of how well a probability model predicts a sample. Note that perplexity is defined as:</p>
<p>\[ P(W) = \sqrt[N]{\prod_{i=1}^{N} \frac{1}{P(w_i| w_1,...,w_{n-1})}} \]</p>
<p>As an implementation hack, you would usually take the log of that formula (to enable us to use the log probabilities we get as output of our <code>RNN</code>, convert exponents to products, and products into sums which makes computations less complicated and computationally more efficient). You should also take care of the padding, since you do not want to include the padding when calculating the perplexity (because we do not want to have a perplexity measure that is artificially good).</p>
\begin{align} log P(W) &amp;= {log\left(\sqrt[N]{\prod_{i=1}^{N} \frac{1}{P(w_i| w_1,\ldots,w_{n-1})}}\right)} \\ &amp;= {log\left({\prod_{i=1}^{N} \frac{1}{P(w_i| w_1,\ldots,w_{n-1})}}\right)^{\frac{1}{N}}}\\ & = {log\left({\prod_{i=1}^{N}{P(w_i| w_1,\ldots,w_{n-1})}}\right)^{-\frac{1}{N}}} \\ & = -\frac{1}{N}{log\left({\prod_{i=1}^{N}{P(w_i| w_1,\ldots,w_{n-1})}}\right)} \\ & = -\frac{1}{N}{\left({\sum_{i=1}^{N}{logP(w_i| w_1,\ldots,w_{n-1})}}\right)} \end{align}
<p><b>Instructions:</b> Write a program that will help evaluate your model. Implementation hack: your program takes in preds and target. Preds is a tensor of log probabilities. You can use <a href="https://github.com/google/trax/blob/22765bb18608d376d8cd660f9865760e4ff489cd/trax/layers/metrics.py#L154"><code>tl.one_hot</code></a> to transform the target into the same dimension. You then multiply them and sum.</p>
<p>You also have to create a mask to only get the non-padded probabilities. Good luck!</p>
<p><b>Hints</b></p>
<ul class="org-ul">
<li>To convert the target into the same dimension as the predictions tensor use tl.one.hot with target and preds.shape[-1].</li>
<li>You will also need the np.equal function in order to unpad the data and properly compute perplexity.</li>
<li>Keep in mind while implementing the formula above that \(w_i\) represents a letter from our 256 letter alphabet.</li>
</ul>
</div>
<div class="outline-3" id="outline-container-orgf1d6ec3">
<h3 id="orgf1d6ec3">Imports</h3>
<div class="outline-text-3" id="text-orgf1d6ec3">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">DataGenerator</span><span class="p">,</span> <span class="n">GRUModel</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org440eabc">
<h3 id="org440eabc">Set Up</h3>
<div class="outline-text-3" id="text-org440eabc">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">DataSettings</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">"DataSettings"</span><span class="p">,</span>
    <span class="s2">"batch_size max_length output"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">DataSettings</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                        <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="s2">"~/models/gru-shakespeare-model/"</span><span class="p">)</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
<span class="n">training_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">training</span><span class="p">,</span> <span class="n">data_loader</span><span class="o">=</span><span class="n">loader</span><span class="p">,</span>
                                   <span class="n">batch_size</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                   <span class="n">max_length</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                                   <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgdfd684d">
<h2 id="orgdfd684d">Middle</h2>
<div class="outline-text-2" id="text-orgdfd684d">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">test_model</span><span class="p">(</span><span class="n">preds</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">interpreters</span><span class="o">.</span><span class="n">xla</span><span class="o">.</span><span class="n">DeviceArray</span><span class="p">,</span>
               <span class="n">target</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">interpreters</span><span class="o">.</span><span class="n">xla</span><span class="o">.</span><span class="n">DeviceArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Function to test the model.</span>

<span class="sd">    Args:</span>
<span class="sd">       preds: Predictions of a list of batches of tensors corresponding to lines of text.</span>
<span class="sd">       target: Actual list of batches of tensors corresponding to lines of text.</span>

<span class="sd">    Returns:</span>
<span class="sd">       float: log_perplexity of the model.</span>
<span class="sd">    """</span>
    <span class="n">total_log_ppx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">n_categories</span><span class="o">=</span><span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># HINT: tl.one_hot() should replace one of the Nones</span>

    <span class="n">non_pad</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>          <span class="c1"># You should check if the target equals 0</span>
    <span class="n">ppx</span> <span class="o">=</span> <span class="n">total_log_ppx</span> <span class="o">*</span> <span class="n">non_pad</span>                             <span class="c1"># Get rid of the padding</span>

    <span class="n">log_ppx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ppx</span><span class="p">)</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">non_pad</span><span class="p">)</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">log_ppx</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgfc8b51a">
<h3 id="orgfc8b51a">Testing</h3>
<div class="outline-text-3" id="text-orgfc8b51a"></div>
<div class="outline-4" id="outline-container-orgb03d143">
<h4 id="orgb03d143">Pre-Built Model</h4>
<div class="outline-text-4" id="text-orgb03d143">
<p>We're going to start with a pre-built file and see how it does relative to our model.</p>
<div class="highlight">
<pre><span></span><span class="n">gru</span> <span class="o">=</span> <span class="n">GRUModel</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">gru</span><span class="o">.</span><span class="n">model</span>
<span class="n">pre_built</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"PRE_BUILT_MODEL"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">init_from_file</span><span class="p">(</span><span class="n">pre_built</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Serial[
    ShiftRight(1)
  ]
  Embedding_256_512
  GRU_512
  GRU_512
  Dense_256
  LogSoftmax
]
</pre>
<div class="highlight">
<pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">training_generator</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">log_ppx</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'The log perplexity and perplexity of your model are respectively'</span><span class="p">,</span> <span class="n">log_ppx</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_ppx</span><span class="p">))</span>
</pre></div>
<pre class="example">
The log perplexity and perplexity of your model are respectively 2.0370717 7.6681223
</pre></div>
</div>
<div class="outline-4" id="outline-container-org0cace37">
<h4 id="org0cace37">Our Model</h4>
<div class="outline-text-4" id="text-org0cace37">
<div class="highlight">
<pre><span></span><span class="n">gru</span> <span class="o">=</span> <span class="n">GRUModel</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">gru</span><span class="o">.</span><span class="n">model</span>
<span class="n">ours</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/models/gru-shakespeare-model/model.pkl.gz"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">init_from_file</span><span class="p">(</span><span class="n">ours</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Serial[
    ShiftRight(1)
  ]
  Embedding_256_512
  GRU_512
  GRU_512
  Dense_256
  LogSoftmax
]
</pre>
<div class="highlight">
<pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">training_generator</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">log_ppx</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'The log perplexity and perplexity of your model are respectively'</span><span class="p">,</span> <span class="n">log_ppx</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_ppx</span><span class="p">))</span>
</pre></div>
<pre class="example">
The log perplexity and perplexity of your model are respectively 0.93021315 2.5350494
</pre>
<p>On the one hand I over-trained my model, on the other hand… why such a big difference?</p>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/deep-n-grams-training-the-model/">Deep N-Grams: Training the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/deep-n-grams-training-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-05T16:48:29-08:00" itemprop="datePublished" title="2021-01-05 16:48">2021-01-05 16:48</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#orgba6913f">Training The Model</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#org0a4b09f">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#org53186ab">Set Up</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#orga45fa3f">Some Constants</a></li>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#org741b52a">Previous Code From this Series</a></li>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#org73b342d">Plotting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#org0c64c7f">Middle</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#org69aeb6d">Some Jargon</a></li>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#orgcc2f879">Training the Model</a></li>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#org49218c5">Take Two</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#org92add33">Plotting Accuracy</a></li>
<li><a href="posts/nlp/deep-n-grams-training-the-model/#orge2c4e98">Plotting Loss</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgba6913f">
<h2 id="orgba6913f">Training The Model</h2>
<div class="outline-text-2" id="text-orgba6913f">
<ul class="org-ul">
<li><a href="posts/nlp/deep-n-grams/">First Post</a></li>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/">Previous Post</a></li>
<li><a href="posts/nlp/deep-n-grams-evaluating-the-model/">Next Post</a></li>
</ul>
<p>Now we are going to train the model. We have to define:</p>
<ul class="org-ul">
<li>the cost function</li>
<li>the optimizer</li>
</ul>
<p>To train a model on a task, Trax defines an abstraction called <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html?highlight=TrainTask#trax.supervised.training.TrainTask"><code>trax.supervised.training.TrainTask</code></a> which packages the training data, loss, and optimizer (among other things) together into an object.</p>
<p>Similarly, to evaluate a model Trax defines an abstraction <code>trax.supervised.training.EvalTask</code> which packages the eval data and metrics (among other things) into another object (and which doesn't seem to have any documentation yet).</p>
<p>The final piece tying things together is the <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.Loop"><code>trax.supervised.training.Loop</code></a> abstraction that is a very simple and flexible way to put everything together and train the model, all the while evaluating it and saving checkpoints.</p>
<p>Using <code>training.Loop</code> will save you a lot of code compared to always writing the training loop by hand, like you did in courses 1 and 2. More importantly, you are less likely to have a bug in that code that would ruin your training.</p>
</div>
<div class="outline-3" id="outline-container-org0a4b09f">
<h3 id="org0a4b09f">Imports</h3>
<div class="outline-text-3" id="text-org0a4b09f">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">equal</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">from</span> <span class="nn">holoviews</span> <span class="kn">import</span> <span class="n">opts</span>
<span class="kn">from</span> <span class="nn">trax.supervised</span> <span class="kn">import</span> <span class="n">training</span> <span class="k">as</span> <span class="n">trax_training</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">trax</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn</span> <span class="kn">import</span> <span class="n">GRUModel</span><span class="p">,</span> <span class="n">DataGenerator</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="c1"># another project</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org53186ab">
<h3 id="org53186ab">Set Up</h3>
<div class="outline-text-3" id="text-org53186ab"></div>
<div class="outline-4" id="outline-container-orga45fa3f">
<h4 id="orga45fa3f">Some Constants</h4>
<div class="outline-text-4" id="text-orga45fa3f">
<div class="highlight">
<pre><span></span><span class="n">DataSettings</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">"DataSettings"</span><span class="p">,</span>
    <span class="s2">"batch_size max_length learning_rate output"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">DataSettings</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                        <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="s2">"~/models/gru-shakespeare-model/"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org741b52a">
<h4 id="org741b52a">Previous Code From this Series</h4>
<div class="outline-text-4" id="text-org741b52a">
<div class="highlight">
<pre><span></span><span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>

<span class="c1"># the name "training" was getting confusing (since trax's module is also called</span>
<span class="c1"># training) so this is training_generator and their's is trax_training</span>
<span class="n">training_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">training</span><span class="p">,</span> <span class="n">data_loader</span><span class="o">=</span><span class="n">loader</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                  <span class="n">max_length</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>

<span class="n">evaluation</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">validation</span><span class="p">,</span> <span class="n">data_loader</span><span class="o">=</span><span class="n">loader</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                  <span class="n">max_length</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>
<span class="n">gru</span> <span class="o">=</span> <span class="n">GRUModel</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org73b342d">
<h4 id="org73b342d">Plotting</h4>
<div class="outline-text-4" id="text-org73b342d">
<div class="highlight">
<pre><span></span><span class="n">slug</span> <span class="o">=</span> <span class="s2">"deep-n-grams-training-the-model"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">slug</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Plot"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"width"</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">,</span> <span class="s2">"fontscale"</span><span class="p">,</span> <span class="s2">"tan"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">])</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0c64c7f">
<h2 id="org0c64c7f">Middle</h2>
<div class="outline-text-2" id="text-org0c64c7f"></div>
<div class="outline-3" id="outline-container-org69aeb6d">
<h3 id="org69aeb6d">Some Jargon</h3>
<div class="outline-text-3" id="text-org69aeb6d">
<p>An <code>epoch</code> is traditionally defined as one pass through the dataset.</p>
<p>Since the dataset was divided into <code>batches</code> you need several <code>steps</code> (gradient evaluations) in order to complete an <code>epoch</code>. So, one <code>epoch</code> corresponds to the number of examples in a <code>batch</code> times the number of <code>steps</code>. In short, in each <code>epoch</code> you go over all of the data.</p>
<p>The <code>max_length</code> variable defines the maximum length of lines to be used in training our data, lines longer that that length are discarded.</p>
<p>Below is a function and results that indicate how many lines conform to our criteria of maximum length of a sentence in the entire dataset and how many <code>steps</code> are required in order to cover the entire dataset which in turn corresponds to an <code>epoch</code>.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">lines_used</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Counts the number of lines of max_length or shorter</span>

<span class="sd">    Args: </span>
<span class="sd">     lines: all lines of text as an array of lines</span>
<span class="sd">     max_length: maximum length of a line to use</span>

<span class="sd">    Returns:</span>
<span class="sd">     number of usable examples</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_length</span><span class="p">)</span>
</pre></div>
<p>Let's see what we get.</p>
<div class="highlight">
<pre><span></span><span class="n">useable</span> <span class="o">=</span> <span class="n">lines_used</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">training</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of used lines from the dataset: </span><span class="si">{</span><span class="n">useable</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Batch size (a power of 2): </span><span class="si">{</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">useable</span><span class="o">/</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of steps to cover one epoch: </span><span class="si">{</span><span class="n">steps_per_epoch</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># our training sets aren't exactly the same for some reason.</span>
<span class="c1"># expect(useable).to(equal(25881))</span>
<span class="c1"># expect(steps_per_epoch).to(equal(808))</span>
</pre></div>
<pre class="example">
Number of used lines from the dataset: 25,781
Batch size (a power of 2): 32
Number of steps to cover one epoch: 805
</pre>
<p>It looks like the original notebook used <code>os.listdir</code> while I'm using <code>Path.glob</code>. Neither of them load the files in alphabetical order, but they also don't load them in the same order as each other for some reason, so our data sets are the same length but the training and validation split created slightly different sets. Oh, well.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgcc2f879">
<h3 id="orgcc2f879">Training the Model</h3>
<div class="outline-text-3" id="text-orgcc2f879">
<p>We'll implement the <code>train_model</code> program below to train the neural network we created in the previous post. Here is a list of things to do:</p>
<ul class="org-ul">
<li>Create a <code>trax.supervised.trainer.TrainTask</code> object:
<ul class="org-ul">
<li>labeled_data = the labeled data that we want to <b>train</b> on.</li>
<li>loss_fn = <a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html?highlight=CrossEntropyLoss#trax.layers.metrics.CrossEntropyLoss">CrossEntropyLoss()</a> (<b>note that this is deprecated</b>)</li>
<li>optimizer = <a href="https://trax-ml.readthedocs.io/en/latest/trax.optimizers.html?highlight=Adam#trax.optimizers.adam.Adam">trax.optimizers.Adam()</a> with a learning rate of 0.0005</li>
</ul>
</li>
<li>Create a <code>trax.supervised.trainer.EvalTask</code> object:
<ul class="org-ul">
<li>labeled_data = the labeled data that we want to <b>evaluate</b> on.</li>
<li>metrics = <a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.metrics.CrossEntropyLoss">CrossEntropyLoss()</a> and <a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.metrics.Accuracy">Accuracy()</a></li>
<li>How frequently we want to evaluate and checkpoint the model.</li>
</ul>
</li>
<li>Create a <code>trax.supervised.trainer.Loop</code> object, this encapsulates the following:
<ul class="org-ul">
<li>The previously created <code>TrainTask</code> and <code>EvalTask</code> objects.</li>
<li>the training model</li>
<li>optionally the evaluation model, if different from the training model. <b>NOTE:</b> in presence of Dropout, etc. we usually want the evaluation model to behave slightly differently than the training model.</li>
</ul>
</li>
</ul>
<p>We will be using a cross entropy loss, with the Adam optimizer. See the <a href="https://trax-ml.readthedocs.io/en/latest/index.html">trax</a> documentation to get a better understanding. Make sure you use the number of steps provided as a parameter to train for the desired number of steps.</p>
<p><b>NOTE:</b> Don't forget to wrap the data generator in <code>itertools.cycle</code> to iterate on it for multiple epochs.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">,</span> <span class="n">data_generator</span><span class="p">:</span> <span class="n">DataGenerator</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">training</span><span class="p">,</span>
                <span class="n">eval_lines</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">validation</span><span class="p">,</span>
                <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s1">'model/'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">:</span> 
    <span class="sd">"""Function that trains the model</span>

<span class="sd">    Args:</span>
<span class="sd">      model: GRU model.</span>
<span class="sd">      data_generator: Data generator function.</span>
<span class="sd">      batch_size: Number of lines per batch.</span>
<span class="sd">      max_length: Maximum length allowed for a line to be processed. </span>
<span class="sd">      lines: List of lines to use for training. Defaults to lines.</span>
<span class="sd">      eval_lines: List of lines to use for evaluation.</span>
<span class="sd">      n_steps: Number of steps to train.</span>
<span class="sd">      output_dir: Relative path of directory to save model.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Training loop for the model.</span>
<span class="sd">    """</span>
    <span class="c1"># this is the broken version for submission, I'll make a separate one for local running.</span>

    <span class="n">bare_train_generator</span> <span class="o">=</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span>
     <span class="n">line_to_tensor</span><span class="p">)</span>
    <span class="n">infinite_train_generator</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">bare_train_generator</span><span class="p">)</span>

    <span class="n">bare_eval_generator</span> <span class="o">=</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span>
                                         <span class="n">eval_lines</span><span class="p">,</span>
                                         <span class="n">line_to_tensor</span><span class="p">)</span>

    <span class="n">infinite_eval_generator</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">bare_eval_generator</span><span class="p">)</span>

    <span class="c1"># the notebook code is out of date so we need to have one for them and one for us... damnit</span>
    <span class="c1"># this first one is theirs</span>
    <span class="n">train_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">(</span>
        <span class="n">labeled_data</span><span class="o">=</span><span class="n">infinite_train_generator</span><span class="p">,</span>
        <span class="n">loss_layer</span><span class="o">=</span><span class="n">tl</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(),</span>   <span class="c1"># Don't forget to instantiate this object</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">trax</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">)</span>     <span class="c1"># Don't forget to add the learning rate parameter</span>
    <span class="p">)</span>

    <span class="n">eval_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">(</span>
        <span class="n">labeled_data</span><span class="o">=</span><span class="n">infinite_eval_generator</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(),</span> <span class="n">tl</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">()],</span> <span class="c1"># Don't forget to instantiate these objects</span>
        <span class="n">n_eval_batches</span><span class="o">=</span><span class="mi">3</span>      <span class="c1"># For better evaluation accuracy in reasonable time</span>
    <span class="p">)</span>

    <span class="n">training_loop</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                                  <span class="n">train_task</span><span class="p">,</span>
                                  <span class="n">eval_task</span><span class="o">=</span><span class="n">eval_task</span><span class="p">,</span>
                                  <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="n">training_loop</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps</span><span class="p">)</span>


    <span class="c1"># We return this because it contains a handle to the model, which has the weights etc.</span>
    <span class="k">return</span> <span class="n">training_loop</span>
</pre></div>
<pre class="example" id="org6c6975b">
training_loop = train_model(GRULM(), data_generator)
</pre>
<p>The model was only trained for 1 step due to the constraints of this environment. Even on a GPU accelerated environment it will take many hours for it to achieve a good level of accuracy. For the rest of the assignment you will be using a pretrained model but now you should understand how the training can be done using Trax.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org49218c5">
<h3 id="org49218c5">Take Two</h3>
<div class="outline-text-3" id="text-org49218c5">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">take_two</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">,</span>
             <span class="n">training</span><span class="p">:</span> <span class="n">DataGenerator</span><span class="p">,</span>
             <span class="n">evaluation</span><span class="p">:</span> <span class="n">DataGenerator</span><span class="p">,</span>
             <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
             <span class="n">batches</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">evaluation_batches</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
             <span class="n">steps_per_checkpoint</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
             <span class="n">output_dir</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">trax_training</span><span class="o">.</span><span class="n">Loop</span><span class="p">:</span> 
    <span class="sd">"""Function that trains the model</span>

<span class="sd">    Args:</span>
<span class="sd">      model: GRU model.</span>
<span class="sd">      training: cycling data generator for training</span>
<span class="sd">      evaluation: cycling data generator for evaluation</span>
<span class="sd">      learning_rate: alpha for the optimizer</span>
<span class="sd">      batches: Number of batches to train.</span>
<span class="sd">      evaluation_batches: number of evaluation batches to run</span>
<span class="sd">      steps_per_checkpoint: how often to stop and evaluate the model</span>
<span class="sd">      output_dir: Relative path of directory to save model.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Training loop for the model.</span>
<span class="sd">    """</span>
    <span class="n">train_task</span> <span class="o">=</span> <span class="n">trax_training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">(</span>
        <span class="n">labeled_data</span><span class="o">=</span><span class="n">training</span><span class="p">,</span>
        <span class="n">loss_layer</span><span class="o">=</span><span class="n">layers</span><span class="o">.</span><span class="n">WeightedCategoryCrossEntropy</span><span class="p">(),</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">trax</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">),</span>
        <span class="n">n_steps_per_checkpoint</span><span class="o">=</span><span class="n">steps_per_checkpoint</span>
    <span class="p">)</span>

    <span class="n">eval_task</span> <span class="o">=</span> <span class="n">trax_training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">(</span>
        <span class="n">labeled_data</span><span class="o">=</span><span class="n">evaluation</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">layers</span><span class="o">.</span><span class="n">WeightedCategoryCrossEntropy</span><span class="p">(),</span>
                 <span class="n">layers</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">()],</span>
        <span class="n">n_eval_batches</span><span class="o">=</span><span class="n">evaluation_batches</span>
    <span class="p">)</span>

    <span class="n">training_loop</span> <span class="o">=</span> <span class="n">trax_training</span><span class="o">.</span><span class="n">Loop</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                                  <span class="n">train_task</span><span class="p">,</span>
                                  <span class="n">eval_tasks</span><span class="o">=</span><span class="p">[</span><span class="n">eval_task</span><span class="p">],</span>
                                  <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">training_loop</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">n_steps</span><span class="o">=</span><span class="n">batches</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Elapsed: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">training_loop</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">loop</span> <span class="o">=</span> <span class="n">take_two</span><span class="p">(</span><span class="n">gru</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">training_generator</span><span class="p">,</span> <span class="n">evaluation</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org41ec732">

Step      1: Total number of trainable weights: 3411200
Step      1: Ran 1 train steps in 2.64 secs
Step      1: train WeightedCategoryCrossEntropy |  5.54519987
Step      1: eval  WeightedCategoryCrossEntropy |  5.54099703
Step      1: eval                      Accuracy |  0.15382584

Step   1000: Ran 999 train steps in 38.68 secs
Step   1000: train WeightedCategoryCrossEntropy |  2.28923297
Step   1000: eval  WeightedCategoryCrossEntropy |  1.82684219
Step   1000: eval                      Accuracy |  0.45511819
Elapsed: 0:00:41.796167
</pre>
<p>Now let's see what the history tells us.</p>
<p><b>Note:</b> As of January 9, 2021 the version of trax on pypi (1.3.7) doesn't have a <code>History</code> object (and it isn't documented) so to use this I had to install trax from the master branch of the <a href="https://github.com/google/trax/">GitHub Repsitory</a>.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Evaluation metrics: </span><span class="si">{</span><span class="n">loop</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">metrics_for_mode</span><span class="p">(</span><span class="s1">'eval'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training Metrics: </span><span class="si">{</span><span class="n">loop</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">metrics_for_mode</span><span class="p">(</span><span class="s1">'train'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Evaluation Accuracy: </span><span class="si">{</span><span class="n">loop</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'eval'</span><span class="p">,</span> <span class="s1">'metrics/Accuracy'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
['eval', 'train']
Evaluation metrics: ['metrics/Accuracy', 'metrics/WeightedCategoryCrossEntropy']
Training Metrics: ['metrics/WeightedCategoryCrossEntropy', 'training/gradients_l2', 'training/learning_rate', 'training/loss', 'training/steps per second', 'training/weights_l2']
Evaluation Accuracy: [(1, 0.15382583936055502), (1000, 0.45511818925539654)]
</pre>
<p>It made a pretty remarkable improvement after a thousand batches, especially considering it only took forty-seconds or so. Let's up the number of batches.</p>
<div class="highlight">
<pre><span></span><span class="n">loop</span> <span class="o">=</span> <span class="n">take_two</span><span class="p">(</span><span class="n">gru</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">training_generator</span><span class="p">,</span> <span class="n">evaluation</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
<pre class="example">

Step   2000: Ran 1000 train steps in 39.75 secs
Step   2000: train WeightedCategoryCrossEntropy |  1.66551745
Step   2000: eval  WeightedCategoryCrossEntropy |  1.65215000
Step   2000: eval                      Accuracy |  0.49342343
Elapsed: 0:00:40.189560
</pre>
<p>Well, I forgot to up the number of batches. This time though…</p>
<div class="highlight">
<pre><span></span><span class="n">loop</span> <span class="o">=</span> <span class="n">take_two</span><span class="p">(</span><span class="n">gru</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">training_generator</span><span class="p">,</span> <span class="n">evaluation</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org9661056">

Step   3000: Ran 1000 train steps in 39.81 secs
Step   3000: train WeightedCategoryCrossEntropy |  1.49474919
Step   3000: eval  WeightedCategoryCrossEntropy |  1.50722202
Step   3000: eval                      Accuracy |  0.53727521

Step   4000: Ran 1000 train steps in 38.82 secs
Step   4000: train WeightedCategoryCrossEntropy |  1.40773308
Step   4000: eval  WeightedCategoryCrossEntropy |  1.44813490
Step   4000: eval                      Accuracy |  0.54536728

Step   5000: Ran 1000 train steps in 38.90 secs
Step   5000: train WeightedCategoryCrossEntropy |  1.35936761
Step   5000: eval  WeightedCategoryCrossEntropy |  1.40560397
Step   5000: eval                      Accuracy |  0.55885768

Step   6000: Ran 1000 train steps in 38.88 secs
Step   6000: train WeightedCategoryCrossEntropy |  1.33801484
Step   6000: eval  WeightedCategoryCrossEntropy |  1.36113369
Step   6000: eval                      Accuracy |  0.57642752

Step   7000: Ran 1000 train steps in 38.86 secs
Step   7000: train WeightedCategoryCrossEntropy |  1.32240558
Step   7000: eval  WeightedCategoryCrossEntropy |  1.38307476
Step   7000: eval                      Accuracy |  0.56590829

Step   8000: Ran 1000 train steps in 38.90 secs
Step   8000: train WeightedCategoryCrossEntropy |  1.30228114
Step   8000: eval  WeightedCategoryCrossEntropy |  1.38889817
Step   8000: eval                      Accuracy |  0.56193008

Step   9000: Ran 1000 train steps in 38.88 secs
Step   9000: train WeightedCategoryCrossEntropy |  1.28101051
Step   9000: eval  WeightedCategoryCrossEntropy |  1.36015956
Step   9000: eval                      Accuracy |  0.56561601

Step  10000: Ran 1000 train steps in 38.86 secs
Step  10000: train WeightedCategoryCrossEntropy |  1.27505744
Step  10000: eval  WeightedCategoryCrossEntropy |  1.36137756
Step  10000: eval                      Accuracy |  0.57053447

Step  11000: Ran 1000 train steps in 38.85 secs
Step  11000: train WeightedCategoryCrossEntropy |  1.27052534
Step  11000: eval  WeightedCategoryCrossEntropy |  1.34181790
Step  11000: eval                      Accuracy |  0.57359161

Step  12000: Ran 1000 train steps in 38.85 secs
Step  12000: train WeightedCategoryCrossEntropy |  1.25399101
Step  12000: eval  WeightedCategoryCrossEntropy |  1.34485857
Step  12000: eval                      Accuracy |  0.57139154
Elapsed: 0:06:30.471829
</pre>
<p>It seems to be plateauing.</p>
<div class="highlight">
<pre><span></span><span class="n">loop</span> <span class="o">=</span> <span class="n">take_two</span><span class="p">(</span><span class="n">gru</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">training_generator</span><span class="p">,</span> <span class="n">evaluation</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org604fa6a">

Step  13000: Ran 1000 train steps in 39.74 secs
Step  13000: train WeightedCategoryCrossEntropy |  1.28382349
Step  13000: eval  WeightedCategoryCrossEntropy |  1.34152850
Step  13000: eval                      Accuracy |  0.56759004

Step  14000: Ran 1000 train steps in 38.70 secs
Step  14000: train WeightedCategoryCrossEntropy |  1.24999321
Step  14000: eval  WeightedCategoryCrossEntropy |  1.31848574
Step  14000: eval                      Accuracy |  0.58393063

Step  15000: Ran 1000 train steps in 38.64 secs
Step  15000: train WeightedCategoryCrossEntropy |  1.23975933
Step  15000: eval  WeightedCategoryCrossEntropy |  1.31624317
Step  15000: eval                      Accuracy |  0.58447830

Step  16000: Ran 1000 train steps in 38.64 secs
Step  16000: train WeightedCategoryCrossEntropy |  1.21947169
Step  16000: eval  WeightedCategoryCrossEntropy |  1.28875721
Step  16000: eval                      Accuracy |  0.57887546

Step  17000: Ran 1000 train steps in 38.62 secs
Step  17000: train WeightedCategoryCrossEntropy |  1.21219873
Step  17000: eval  WeightedCategoryCrossEntropy |  1.33571080
Step  17000: eval                      Accuracy |  0.57712994

Step  18000: Ran 1000 train steps in 38.66 secs
Step  18000: train WeightedCategoryCrossEntropy |  1.21026635
Step  18000: eval  WeightedCategoryCrossEntropy |  1.32456430
Step  18000: eval                      Accuracy |  0.58517017

Step  19000: Ran 1000 train steps in 38.64 secs
Step  19000: train WeightedCategoryCrossEntropy |  1.21169627
Step  19000: eval  WeightedCategoryCrossEntropy |  1.32556013
Step  19000: eval                      Accuracy |  0.58419540

Step  20000: Ran 1000 train steps in 38.71 secs
Step  20000: train WeightedCategoryCrossEntropy |  1.18635964
Step  20000: eval  WeightedCategoryCrossEntropy |  1.29579870
Step  20000: eval                      Accuracy |  0.58305796

Step  21000: Ran 1000 train steps in 38.64 secs
Step  21000: train WeightedCategoryCrossEntropy |  1.18904626
Step  21000: eval  WeightedCategoryCrossEntropy |  1.30543160
Step  21000: eval                      Accuracy |  0.58511112

Step  22000: Ran 1000 train steps in 38.66 secs
Step  22000: train WeightedCategoryCrossEntropy |  1.19396818
Step  22000: eval  WeightedCategoryCrossEntropy |  1.29183892
Step  22000: eval                      Accuracy |  0.58100422

Step  23000: Ran 1000 train steps in 38.71 secs
Step  23000: train WeightedCategoryCrossEntropy |  1.19577324
Step  23000: eval  WeightedCategoryCrossEntropy |  1.31765648
Step  23000: eval                      Accuracy |  0.57812850

Step  24000: Ran 1000 train steps in 38.77 secs
Step  24000: train WeightedCategoryCrossEntropy |  1.16455758
Step  24000: eval  WeightedCategoryCrossEntropy |  1.30760705
Step  24000: eval                      Accuracy |  0.58308929

Step  25000: Ran 1000 train steps in 38.68 secs
Step  25000: train WeightedCategoryCrossEntropy |  1.17373812
Step  25000: eval  WeightedCategoryCrossEntropy |  1.33733491
Step  25000: eval                      Accuracy |  0.58254947

Step  26000: Ran 1000 train steps in 38.73 secs
Step  26000: train WeightedCategoryCrossEntropy |  1.17703664
Step  26000: eval  WeightedCategoryCrossEntropy |  1.30382776
Step  26000: eval                      Accuracy |  0.59271948

Step  27000: Ran 1000 train steps in 38.77 secs
Step  27000: train WeightedCategoryCrossEntropy |  1.17249799
Step  27000: eval  WeightedCategoryCrossEntropy |  1.29767748
Step  27000: eval                      Accuracy |  0.59217713

Step  28000: Ran 1000 train steps in 38.70 secs
Step  28000: train WeightedCategoryCrossEntropy |  1.15188992
Step  28000: eval  WeightedCategoryCrossEntropy |  1.27955910
Step  28000: eval                      Accuracy |  0.60145231

Step  29000: Ran 1000 train steps in 38.71 secs
Step  29000: train WeightedCategoryCrossEntropy |  1.15883470
Step  29000: eval  WeightedCategoryCrossEntropy |  1.32158053
Step  29000: eval                      Accuracy |  0.58393308

Step  30000: Ran 1000 train steps in 38.69 secs
Step  30000: train WeightedCategoryCrossEntropy |  1.16402268
Step  30000: eval  WeightedCategoryCrossEntropy |  1.28583026
Step  30000: eval                      Accuracy |  0.59060840

Step  31000: Ran 1000 train steps in 38.76 secs
Step  31000: train WeightedCategoryCrossEntropy |  1.15244710
Step  31000: eval  WeightedCategoryCrossEntropy |  1.31478047
Step  31000: eval                      Accuracy |  0.58421228

Step  32000: Ran 1000 train steps in 38.74 secs
Step  32000: train WeightedCategoryCrossEntropy |  1.13865745
Step  32000: eval  WeightedCategoryCrossEntropy |  1.30897808
Step  32000: eval                      Accuracy |  0.58211388

Step  33000: Ran 1000 train steps in 38.70 secs
Step  33000: train WeightedCategoryCrossEntropy |  1.14797425
Step  33000: eval  WeightedCategoryCrossEntropy |  1.28837899
Step  33000: eval                      Accuracy |  0.59355628

Step  34000: Ran 1000 train steps in 38.71 secs
Step  34000: train WeightedCategoryCrossEntropy |  1.15177202
Step  34000: eval  WeightedCategoryCrossEntropy |  1.26875858
Step  34000: eval                      Accuracy |  0.59396426

Step  35000: Ran 1000 train steps in 38.74 secs
Step  35000: train WeightedCategoryCrossEntropy |  1.13462234
Step  35000: eval  WeightedCategoryCrossEntropy |  1.33155421
Step  35000: eval                      Accuracy |  0.58831197

Step  36000: Ran 1000 train steps in 38.76 secs
Step  36000: train WeightedCategoryCrossEntropy |  1.12743652
Step  36000: eval  WeightedCategoryCrossEntropy |  1.31895538
Step  36000: eval                      Accuracy |  0.57935937

Step  37000: Ran 1000 train steps in 38.76 secs
Step  37000: train WeightedCategoryCrossEntropy |  1.13511860
Step  37000: eval  WeightedCategoryCrossEntropy |  1.34238366
Step  37000: eval                      Accuracy |  0.58156353

Step  38000: Ran 1000 train steps in 38.72 secs
Step  38000: train WeightedCategoryCrossEntropy |  1.14187491
Step  38000: eval  WeightedCategoryCrossEntropy |  1.30659600
Step  38000: eval                      Accuracy |  0.58288614

Step  39000: Ran 1000 train steps in 38.76 secs
Step  39000: train WeightedCategoryCrossEntropy |  1.12084019
Step  39000: eval  WeightedCategoryCrossEntropy |  1.28768833
Step  39000: eval                      Accuracy |  0.60021923

Step  40000: Ran 1000 train steps in 38.71 secs
Step  40000: train WeightedCategoryCrossEntropy |  1.11764979
Step  40000: eval  WeightedCategoryCrossEntropy |  1.33905506
Step  40000: eval                      Accuracy |  0.57679999

Step  41000: Ran 1000 train steps in 38.74 secs
Step  41000: train WeightedCategoryCrossEntropy |  1.12686217
Step  41000: eval  WeightedCategoryCrossEntropy |  1.32088705
Step  41000: eval                      Accuracy |  0.58238810

Step  42000: Ran 1000 train steps in 38.75 secs
Step  42000: train WeightedCategoryCrossEntropy |  1.13109481
Step  42000: eval  WeightedCategoryCrossEntropy |  1.31838973
Step  42000: eval                      Accuracy |  0.58213743

Step  43000: Ran 1000 train steps in 38.79 secs
Step  43000: train WeightedCategoryCrossEntropy |  1.10290754
Step  43000: eval  WeightedCategoryCrossEntropy |  1.31488041
Step  43000: eval                      Accuracy |  0.59099247

Step  44000: Ran 1000 train steps in 38.75 secs
Step  44000: train WeightedCategoryCrossEntropy |  1.11154807
Step  44000: eval  WeightedCategoryCrossEntropy |  1.32115630
Step  44000: eval                      Accuracy |  0.58481665

Step  45000: Ran 1000 train steps in 38.74 secs
Step  45000: train WeightedCategoryCrossEntropy |  1.11626506
Step  45000: eval  WeightedCategoryCrossEntropy |  1.32583074
Step  45000: eval                      Accuracy |  0.58425963

Step  46000: Ran 1000 train steps in 38.75 secs
Step  46000: train WeightedCategoryCrossEntropy |  1.12253380
Step  46000: eval  WeightedCategoryCrossEntropy |  1.28128795
Step  46000: eval                      Accuracy |  0.59816724

Step  47000: Ran 1000 train steps in 38.78 secs
Step  47000: train WeightedCategoryCrossEntropy |  1.08949089
Step  47000: eval  WeightedCategoryCrossEntropy |  1.31317608
Step  47000: eval                      Accuracy |  0.58273973

Step  48000: Ran 1000 train steps in 38.75 secs
Step  48000: train WeightedCategoryCrossEntropy |  1.10382092
Step  48000: eval  WeightedCategoryCrossEntropy |  1.35037680
Step  48000: eval                      Accuracy |  0.58653913

Step  49000: Ran 1000 train steps in 38.74 secs
Step  49000: train WeightedCategoryCrossEntropy |  1.10920715
Step  49000: eval  WeightedCategoryCrossEntropy |  1.34068878
Step  49000: eval                      Accuracy |  0.57137036

Step  50000: Ran 1000 train steps in 38.78 secs
Step  50000: train WeightedCategoryCrossEntropy |  1.10644996
Step  50000: eval  WeightedCategoryCrossEntropy |  1.32040668
Step  50000: eval                      Accuracy |  0.58469077

Step  51000: Ran 1000 train steps in 38.73 secs
Step  51000: train WeightedCategoryCrossEntropy |  1.08133543
Step  51000: eval  WeightedCategoryCrossEntropy |  1.31978738
Step  51000: eval                      Accuracy |  0.58491902

Step  52000: Ran 1000 train steps in 38.73 secs
Step  52000: train WeightedCategoryCrossEntropy |  1.09691930
Step  52000: eval  WeightedCategoryCrossEntropy |  1.32925705
Step  52000: eval                      Accuracy |  0.58861417

Step  53000: Ran 1000 train steps in 38.68 secs
Step  53000: train WeightedCategoryCrossEntropy |  1.10452163
Step  53000: eval  WeightedCategoryCrossEntropy |  1.29868329
Step  53000: eval                      Accuracy |  0.60251764

Step  54000: Ran 1000 train steps in 38.74 secs
Step  54000: train WeightedCategoryCrossEntropy |  1.09207809
Step  54000: eval  WeightedCategoryCrossEntropy |  1.35772077
Step  54000: eval                      Accuracy |  0.57129671

Step  55000: Ran 1000 train steps in 38.72 secs
Step  55000: train WeightedCategoryCrossEntropy |  1.07641542
Step  55000: eval  WeightedCategoryCrossEntropy |  1.36485183
Step  55000: eval                      Accuracy |  0.58672802

Step  56000: Ran 1000 train steps in 38.72 secs
Step  56000: train WeightedCategoryCrossEntropy |  1.08802187
Step  56000: eval  WeightedCategoryCrossEntropy |  1.30784667
Step  56000: eval                      Accuracy |  0.59716912

Step  57000: Ran 1000 train steps in 38.71 secs
Step  57000: train WeightedCategoryCrossEntropy |  1.09764445
Step  57000: eval  WeightedCategoryCrossEntropy |  1.35429418
Step  57000: eval                      Accuracy |  0.57975992

Step  58000: Ran 1000 train steps in 38.74 secs
Step  58000: train WeightedCategoryCrossEntropy |  1.07809854
Step  58000: eval  WeightedCategoryCrossEntropy |  1.32458742
Step  58000: eval                      Accuracy |  0.57735123

Step  59000: Ran 1000 train steps in 38.72 secs
Step  59000: train WeightedCategoryCrossEntropy |  1.07255101
Step  59000: eval  WeightedCategoryCrossEntropy |  1.28845433
Step  59000: eval                      Accuracy |  0.59338196

Step  60000: Ran 1000 train steps in 38.73 secs
Step  60000: train WeightedCategoryCrossEntropy |  1.08358848
Step  60000: eval  WeightedCategoryCrossEntropy |  1.31605566
Step  60000: eval                      Accuracy |  0.58012034

Step  61000: Ran 1000 train steps in 38.70 secs
Step  61000: train WeightedCategoryCrossEntropy |  1.08817053
Step  61000: eval  WeightedCategoryCrossEntropy |  1.32721674
Step  61000: eval                      Accuracy |  0.58768902

Step  62000: Ran 1000 train steps in 38.73 secs
Step  62000: train WeightedCategoryCrossEntropy |  1.06626439
Step  62000: eval  WeightedCategoryCrossEntropy |  1.33657344
Step  62000: eval                      Accuracy |  0.58727795
Elapsed: 0:32:19.629778
</pre>
<div class="highlight">
<pre><span></span><span class="n">loop</span> <span class="o">=</span> <span class="n">take_two</span><span class="p">(</span><span class="n">gru</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">training_generator</span><span class="p">,</span> <span class="n">evaluation</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org62e0a68">

Step  63000: Ran 1000 train steps in 39.93 secs
Step  63000: train WeightedCategoryCrossEntropy |  1.16796327
Step  63000: eval  WeightedCategoryCrossEntropy |  1.36395303
Step  63000: eval                      Accuracy |  0.57032533

Step  64000: Ran 1000 train steps in 38.89 secs
Step  64000: train WeightedCategoryCrossEntropy |  1.11666918
Step  64000: eval  WeightedCategoryCrossEntropy |  1.32780838
Step  64000: eval                      Accuracy |  0.57505075

Step  65000: Ran 1000 train steps in 38.90 secs
Step  65000: train WeightedCategoryCrossEntropy |  1.10621011
Step  65000: eval  WeightedCategoryCrossEntropy |  1.33678579
Step  65000: eval                      Accuracy |  0.57886046

Step  66000: Ran 1000 train steps in 38.93 secs
Step  66000: train WeightedCategoryCrossEntropy |  1.06902885
Step  66000: eval  WeightedCategoryCrossEntropy |  1.33837553
Step  66000: eval                      Accuracy |  0.58116663

Step  67000: Ran 1000 train steps in 38.86 secs
Step  67000: train WeightedCategoryCrossEntropy |  1.07529819
Step  67000: eval  WeightedCategoryCrossEntropy |  1.34368738
Step  67000: eval                      Accuracy |  0.58368655

Step  68000: Ran 1000 train steps in 38.88 secs
Step  68000: train WeightedCategoryCrossEntropy |  1.08158481
Step  68000: eval  WeightedCategoryCrossEntropy |  1.31722498
Step  68000: eval                      Accuracy |  0.58705380

Step  69000: Ran 1000 train steps in 38.95 secs
Step  69000: train WeightedCategoryCrossEntropy |  1.08769965
Step  69000: eval  WeightedCategoryCrossEntropy |  1.31406136
Step  69000: eval                      Accuracy |  0.58490791

Step  70000: Ran 1000 train steps in 38.88 secs
Step  70000: train WeightedCategoryCrossEntropy |  1.04882610
Step  70000: eval  WeightedCategoryCrossEntropy |  1.38410521
Step  70000: eval                      Accuracy |  0.56796430

Step  71000: Ran 1000 train steps in 38.90 secs
Step  71000: train WeightedCategoryCrossEntropy |  1.06316447
Step  71000: eval  WeightedCategoryCrossEntropy |  1.30895372
Step  71000: eval                      Accuracy |  0.58984526

Step  72000: Ran 1000 train steps in 38.91 secs
Step  72000: train WeightedCategoryCrossEntropy |  1.07383156
Step  72000: eval  WeightedCategoryCrossEntropy |  1.38230101
Step  72000: eval                      Accuracy |  0.56828884

Step  73000: Ran 1000 train steps in 38.94 secs
Step  73000: train WeightedCategoryCrossEntropy |  1.07366288
Step  73000: eval  WeightedCategoryCrossEntropy |  1.29979046
Step  73000: eval                      Accuracy |  0.59334222

Step  74000: Ran 1000 train steps in 38.89 secs
Step  74000: train WeightedCategoryCrossEntropy |  1.04150283
Step  74000: eval  WeightedCategoryCrossEntropy |  1.39114801
Step  74000: eval                      Accuracy |  0.56706931

Step  75000: Ran 1000 train steps in 38.89 secs
Step  75000: train WeightedCategoryCrossEntropy |  1.06011724
Step  75000: eval  WeightedCategoryCrossEntropy |  1.31870242
Step  75000: eval                      Accuracy |  0.58975877

Step  76000: Ran 1000 train steps in 38.93 secs
Step  76000: train WeightedCategoryCrossEntropy |  1.06862414
Step  76000: eval  WeightedCategoryCrossEntropy |  1.33027065
Step  76000: eval                      Accuracy |  0.58500228

Step  77000: Ran 1000 train steps in 38.92 secs
Step  77000: train WeightedCategoryCrossEntropy |  1.05721939
Step  77000: eval  WeightedCategoryCrossEntropy |  1.36938119
Step  77000: eval                      Accuracy |  0.57774687

Step  78000: Ran 1000 train steps in 38.86 secs
Step  78000: train WeightedCategoryCrossEntropy |  1.04032123
Step  78000: eval  WeightedCategoryCrossEntropy |  1.35787050
Step  78000: eval                      Accuracy |  0.58307936

Step  79000: Ran 1000 train steps in 38.89 secs
Step  79000: train WeightedCategoryCrossEntropy |  1.05514109
Step  79000: eval  WeightedCategoryCrossEntropy |  1.34510783
Step  79000: eval                      Accuracy |  0.59036636

Step  80000: Ran 1000 train steps in 38.91 secs
Step  80000: train WeightedCategoryCrossEntropy |  1.06119215
Step  80000: eval  WeightedCategoryCrossEntropy |  1.35925500
Step  80000: eval                      Accuracy |  0.58475639

Step  81000: Ran 1000 train steps in 38.93 secs
Step  81000: train WeightedCategoryCrossEntropy |  1.04676783
Step  81000: eval  WeightedCategoryCrossEntropy |  1.36667589
Step  81000: eval                      Accuracy |  0.57690132

Step  82000: Ran 1000 train steps in 38.88 secs
Step  82000: train WeightedCategoryCrossEntropy |  1.03751075
Step  82000: eval  WeightedCategoryCrossEntropy |  1.34715915
Step  82000: eval                      Accuracy |  0.58315720

Step  83000: Ran 1000 train steps in 38.88 secs
Step  83000: train WeightedCategoryCrossEntropy |  1.05128062
Step  83000: eval  WeightedCategoryCrossEntropy |  1.39356836
Step  83000: eval                      Accuracy |  0.57512679

Step  84000: Ran 1000 train steps in 38.89 secs
Step  84000: train WeightedCategoryCrossEntropy |  1.05902994
Step  84000: eval  WeightedCategoryCrossEntropy |  1.33182939
Step  84000: eval                      Accuracy |  0.57415217

Step  85000: Ran 1000 train steps in 38.93 secs
Step  85000: train WeightedCategoryCrossEntropy |  1.03327870
Step  85000: eval  WeightedCategoryCrossEntropy |  1.35110184
Step  85000: eval                      Accuracy |  0.57771309

Step  86000: Ran 1000 train steps in 38.81 secs
Step  86000: train WeightedCategoryCrossEntropy |  1.03494859
Step  86000: eval  WeightedCategoryCrossEntropy |  1.38251416
Step  86000: eval                      Accuracy |  0.57844079

Step  87000: Ran 1000 train steps in 38.95 secs
Step  87000: train WeightedCategoryCrossEntropy |  1.04720616
Step  87000: eval  WeightedCategoryCrossEntropy |  1.39008860
Step  87000: eval                      Accuracy |  0.57346765

Step  88000: Ran 1000 train steps in 38.92 secs
Step  88000: train WeightedCategoryCrossEntropy |  1.05683839
Step  88000: eval  WeightedCategoryCrossEntropy |  1.34061221
Step  88000: eval                      Accuracy |  0.57800055

Step  89000: Ran 1000 train steps in 38.96 secs
Step  89000: train WeightedCategoryCrossEntropy |  1.02072740
Step  89000: eval  WeightedCategoryCrossEntropy |  1.36288555
Step  89000: eval                      Accuracy |  0.57487903

Step  90000: Ran 1000 train steps in 38.94 secs
Step  90000: train WeightedCategoryCrossEntropy |  1.03256643
Step  90000: eval  WeightedCategoryCrossEntropy |  1.33989787
Step  90000: eval                      Accuracy |  0.58749672

Step  91000: Ran 1000 train steps in 38.90 secs
Step  91000: train WeightedCategoryCrossEntropy |  1.04493618
Step  91000: eval  WeightedCategoryCrossEntropy |  1.33348036
Step  91000: eval                      Accuracy |  0.58970133

Step  92000: Ran 1000 train steps in 38.88 secs
Step  92000: train WeightedCategoryCrossEntropy |  1.05325651
Step  92000: eval  WeightedCategoryCrossEntropy |  1.37317479
Step  92000: eval                      Accuracy |  0.57510771

Step  93000: Ran 1000 train steps in 38.92 secs
Step  93000: train WeightedCategoryCrossEntropy |  1.01199973
Step  93000: eval  WeightedCategoryCrossEntropy |  1.34816321
Step  93000: eval                      Accuracy |  0.58193330

Step  94000: Ran 1000 train steps in 38.84 secs
Step  94000: train WeightedCategoryCrossEntropy |  1.03259039
Step  94000: eval  WeightedCategoryCrossEntropy |  1.40019397
Step  94000: eval                      Accuracy |  0.57431702

Step  95000: Ran 1000 train steps in 38.88 secs
Step  95000: train WeightedCategoryCrossEntropy |  1.04201376
Step  95000: eval  WeightedCategoryCrossEntropy |  1.39143252
Step  95000: eval                      Accuracy |  0.57650570

Step  96000: Ran 1000 train steps in 39.04 secs
Step  96000: train WeightedCategoryCrossEntropy |  1.04046071
Step  96000: eval  WeightedCategoryCrossEntropy |  1.39077107
Step  96000: eval                      Accuracy |  0.56915913

Step  97000: Ran 1000 train steps in 38.87 secs
Step  97000: train WeightedCategoryCrossEntropy |  1.01071739
Step  97000: eval  WeightedCategoryCrossEntropy |  1.36615340
Step  97000: eval                      Accuracy |  0.58579030

Step  98000: Ran 1000 train steps in 38.88 secs
Step  98000: train WeightedCategoryCrossEntropy |  1.02754629
Step  98000: eval  WeightedCategoryCrossEntropy |  1.37784847
Step  98000: eval                      Accuracy |  0.56786172

Step  99000: Ran 1000 train steps in 38.86 secs
Step  99000: train WeightedCategoryCrossEntropy |  1.04122782
Step  99000: eval  WeightedCategoryCrossEntropy |  1.35543263
Step  99000: eval                      Accuracy |  0.57437052

Step  100000: Ran 1000 train steps in 38.91 secs
Step  100000: train WeightedCategoryCrossEntropy |  1.02983260
Step  100000: eval  WeightedCategoryCrossEntropy |  1.37780102
Step  100000: eval                      Accuracy |  0.57324133

Step  101000: Ran 1000 train steps in 38.87 secs
Step  101000: train WeightedCategoryCrossEntropy |  1.01030552
Step  101000: eval  WeightedCategoryCrossEntropy |  1.36497653
Step  101000: eval                      Accuracy |  0.58740668

Step  102000: Ran 1000 train steps in 38.90 secs
Step  102000: train WeightedCategoryCrossEntropy |  1.02731681
Step  102000: eval  WeightedCategoryCrossEntropy |  1.35321331
Step  102000: eval                      Accuracy |  0.57775164

Step  103000: Ran 1000 train steps in 38.91 secs
Step  103000: train WeightedCategoryCrossEntropy |  1.03641915
Step  103000: eval  WeightedCategoryCrossEntropy |  1.34763209
Step  103000: eval                      Accuracy |  0.58446699

Step  104000: Ran 1000 train steps in 38.94 secs
Step  104000: train WeightedCategoryCrossEntropy |  1.01956904
Step  104000: eval  WeightedCategoryCrossEntropy |  1.36184053
Step  104000: eval                      Accuracy |  0.57803359

Step  105000: Ran 1000 train steps in 38.89 secs
Step  105000: train WeightedCategoryCrossEntropy |  1.01011324
Step  105000: eval  WeightedCategoryCrossEntropy |  1.38106732
Step  105000: eval                      Accuracy |  0.57777325

Step  106000: Ran 1000 train steps in 38.89 secs
Step  106000: train WeightedCategoryCrossEntropy |  1.02553248
Step  106000: eval  WeightedCategoryCrossEntropy |  1.35610406
Step  106000: eval                      Accuracy |  0.57794044

Step  107000: Ran 1000 train steps in 38.82 secs
Step  107000: train WeightedCategoryCrossEntropy |  1.03704548
Step  107000: eval  WeightedCategoryCrossEntropy |  1.42385058
Step  107000: eval                      Accuracy |  0.56722079

Step  108000: Ran 1000 train steps in 38.95 secs
Step  108000: train WeightedCategoryCrossEntropy |  1.00718296
Step  108000: eval  WeightedCategoryCrossEntropy |  1.31863145
Step  108000: eval                      Accuracy |  0.58128174

Step  109000: Ran 1000 train steps in 38.88 secs
Step  109000: train WeightedCategoryCrossEntropy |  1.01074588
Step  109000: eval  WeightedCategoryCrossEntropy |  1.38885832
Step  109000: eval                      Accuracy |  0.57076645

Step  110000: Ran 1000 train steps in 38.89 secs
Step  110000: train WeightedCategoryCrossEntropy |  1.02346790
Step  110000: eval  WeightedCategoryCrossEntropy |  1.38532333
Step  110000: eval                      Accuracy |  0.56799785

Step  111000: Ran 1000 train steps in 38.91 secs
Step  111000: train WeightedCategoryCrossEntropy |  1.03170466
Step  111000: eval  WeightedCategoryCrossEntropy |  1.43979116
Step  111000: eval                      Accuracy |  0.55651154

Step  112000: Ran 1000 train steps in 38.91 secs
Step  112000: train WeightedCategoryCrossEntropy |  0.99752879
Step  112000: eval  WeightedCategoryCrossEntropy |  1.40813621
Step  112000: eval                      Accuracy |  0.57297881

Step  113000: Ran 1000 train steps in 38.86 secs
Step  113000: train WeightedCategoryCrossEntropy |  1.00867105
Step  113000: eval  WeightedCategoryCrossEntropy |  1.40307196
Step  113000: eval                      Accuracy |  0.57566841

Step  114000: Ran 1000 train steps in 38.90 secs
Step  114000: train WeightedCategoryCrossEntropy |  1.02337575
Step  114000: eval  WeightedCategoryCrossEntropy |  1.44530074
Step  114000: eval                      Accuracy |  0.55467153

Step  115000: Ran 1000 train steps in 38.87 secs
Step  115000: train WeightedCategoryCrossEntropy |  1.03222477
Step  115000: eval  WeightedCategoryCrossEntropy |  1.41283929
Step  115000: eval                      Accuracy |  0.57396744

Step  116000: Ran 1000 train steps in 38.91 secs
Step  116000: train WeightedCategoryCrossEntropy |  0.98707652
Step  116000: eval  WeightedCategoryCrossEntropy |  1.38734619
Step  116000: eval                      Accuracy |  0.57764675

Step  117000: Ran 1000 train steps in 38.88 secs
Step  117000: train WeightedCategoryCrossEntropy |  1.00943744
Step  117000: eval  WeightedCategoryCrossEntropy |  1.35685408
Step  117000: eval                      Accuracy |  0.58032387

Step  118000: Ran 1000 train steps in 38.91 secs
Step  118000: train WeightedCategoryCrossEntropy |  1.02165031
Step  118000: eval  WeightedCategoryCrossEntropy |  1.41391091
Step  118000: eval                      Accuracy |  0.55870849

Step  119000: Ran 1000 train steps in 38.94 secs
Step  119000: train WeightedCategoryCrossEntropy |  1.02332592
Step  119000: eval  WeightedCategoryCrossEntropy |  1.37008909
Step  119000: eval                      Accuracy |  0.58312436

Step  120000: Ran 1000 train steps in 38.87 secs
Step  120000: train WeightedCategoryCrossEntropy |  0.99027425
Step  120000: eval  WeightedCategoryCrossEntropy |  1.39020562
Step  120000: eval                      Accuracy |  0.56893224

Step  121000: Ran 1000 train steps in 38.91 secs
Step  121000: train WeightedCategoryCrossEntropy |  1.01001906
Step  121000: eval  WeightedCategoryCrossEntropy |  1.34898885
Step  121000: eval                      Accuracy |  0.58765940

Step  122000: Ran 1000 train steps in 38.91 secs
Step  122000: train WeightedCategoryCrossEntropy |  1.01810360
Step  122000: eval  WeightedCategoryCrossEntropy |  1.31699550
Step  122000: eval                      Accuracy |  0.59351979

Step  123000: Ran 1000 train steps in 38.94 secs
Step  123000: train WeightedCategoryCrossEntropy |  1.00846207
Step  123000: eval  WeightedCategoryCrossEntropy |  1.36349829
Step  123000: eval                      Accuracy |  0.58220035

Step  124000: Ran 1000 train steps in 38.90 secs
Step  124000: train WeightedCategoryCrossEntropy |  0.99121541
Step  124000: eval  WeightedCategoryCrossEntropy |  1.36115118
Step  124000: eval                      Accuracy |  0.58584205

Step  125000: Ran 1000 train steps in 38.95 secs
Step  125000: train WeightedCategoryCrossEntropy |  1.00830889
Step  125000: eval  WeightedCategoryCrossEntropy |  1.40724500
Step  125000: eval                      Accuracy |  0.56920058

Step  126000: Ran 1000 train steps in 38.90 secs
Step  126000: train WeightedCategoryCrossEntropy |  1.01781940
Step  126000: eval  WeightedCategoryCrossEntropy |  1.36977708
Step  126000: eval                      Accuracy |  0.58009328

Step  127000: Ran 1000 train steps in 38.96 secs
Step  127000: train WeightedCategoryCrossEntropy |  1.00031054
Step  127000: eval  WeightedCategoryCrossEntropy |  1.41326904
Step  127000: eval                      Accuracy |  0.57243240

Step  128000: Ran 1000 train steps in 38.92 secs
Step  128000: train WeightedCategoryCrossEntropy |  0.99219322
Step  128000: eval  WeightedCategoryCrossEntropy |  1.44404384
Step  128000: eval                      Accuracy |  0.57395190

Step  129000: Ran 1000 train steps in 38.99 secs
Step  129000: train WeightedCategoryCrossEntropy |  1.00709093
Step  129000: eval  WeightedCategoryCrossEntropy |  1.41958042
Step  129000: eval                      Accuracy |  0.57267843

Step  130000: Ran 1000 train steps in 38.99 secs
Step  130000: train WeightedCategoryCrossEntropy |  1.01912773
Step  130000: eval  WeightedCategoryCrossEntropy |  1.33912981
Step  130000: eval                      Accuracy |  0.59197128

Step  131000: Ran 1000 train steps in 39.00 secs
Step  131000: train WeightedCategoryCrossEntropy |  0.98723483
Step  131000: eval  WeightedCategoryCrossEntropy |  1.41522125
Step  131000: eval                      Accuracy |  0.57427963

Step  132000: Ran 1000 train steps in 38.94 secs
Step  132000: train WeightedCategoryCrossEntropy |  0.99342090
Step  132000: eval  WeightedCategoryCrossEntropy |  1.41465898
Step  132000: eval                      Accuracy |  0.57029406

Step  133000: Ran 1000 train steps in 38.88 secs
Step  133000: train WeightedCategoryCrossEntropy |  1.00727808
Step  133000: eval  WeightedCategoryCrossEntropy |  1.38130502
Step  133000: eval                      Accuracy |  0.57192655

Step  134000: Ran 1000 train steps in 38.91 secs
Step  134000: train WeightedCategoryCrossEntropy |  1.01677108
Step  134000: eval  WeightedCategoryCrossEntropy |  1.37716194
Step  134000: eval                      Accuracy |  0.57707018

Step  135000: Ran 1000 train steps in 38.98 secs
Step  135000: train WeightedCategoryCrossEntropy |  0.98251414
Step  135000: eval  WeightedCategoryCrossEntropy |  1.43346206
Step  135000: eval                      Accuracy |  0.56802229

Step  136000: Ran 1000 train steps in 38.94 secs
Step  136000: train WeightedCategoryCrossEntropy |  0.99259746
Step  136000: eval  WeightedCategoryCrossEntropy |  1.40438286
Step  136000: eval                      Accuracy |  0.56927029

Step  137000: Ran 1000 train steps in 38.95 secs
Step  137000: train WeightedCategoryCrossEntropy |  1.00365269
Step  137000: eval  WeightedCategoryCrossEntropy |  1.39464525
Step  137000: eval                      Accuracy |  0.56577289

Step  138000: Ran 1000 train steps in 38.94 secs
Step  138000: train WeightedCategoryCrossEntropy |  1.01699519
Step  138000: eval  WeightedCategoryCrossEntropy |  1.38829728
Step  138000: eval                      Accuracy |  0.56793642

Step  139000: Ran 1000 train steps in 38.95 secs
Step  139000: train WeightedCategoryCrossEntropy |  0.97175646
Step  139000: eval  WeightedCategoryCrossEntropy |  1.41113611
Step  139000: eval                      Accuracy |  0.57514930

Step  140000: Ran 1000 train steps in 38.90 secs
Step  140000: train WeightedCategoryCrossEntropy |  0.99368864
Step  140000: eval  WeightedCategoryCrossEntropy |  1.37815968
Step  140000: eval                      Accuracy |  0.57881431

Step  141000: Ran 1000 train steps in 38.89 secs
Step  141000: train WeightedCategoryCrossEntropy |  1.00594318
Step  141000: eval  WeightedCategoryCrossEntropy |  1.37036717
Step  141000: eval                      Accuracy |  0.58198376

Step  142000: Ran 1000 train steps in 38.90 secs
Step  142000: train WeightedCategoryCrossEntropy |  1.00673234
Step  142000: eval  WeightedCategoryCrossEntropy |  1.40482660
Step  142000: eval                      Accuracy |  0.58230907

Step  143000: Ran 1000 train steps in 38.90 secs
Step  143000: train WeightedCategoryCrossEntropy |  0.97389799
Step  143000: eval  WeightedCategoryCrossEntropy |  1.39242669
Step  143000: eval                      Accuracy |  0.58056428

Step  144000: Ran 1000 train steps in 38.92 secs
Step  144000: train WeightedCategoryCrossEntropy |  0.99413979
Step  144000: eval  WeightedCategoryCrossEntropy |  1.41043913
Step  144000: eval                      Accuracy |  0.56678424

Step  145000: Ran 1000 train steps in 38.95 secs
Step  145000: train WeightedCategoryCrossEntropy |  1.00447440
Step  145000: eval  WeightedCategoryCrossEntropy |  1.36656562
Step  145000: eval                      Accuracy |  0.57477281

Step  146000: Ran 1000 train steps in 38.99 secs
Step  146000: train WeightedCategoryCrossEntropy |  0.99580330
Step  146000: eval  WeightedCategoryCrossEntropy |  1.48764821
Step  146000: eval                      Accuracy |  0.55135592

Step  147000: Ran 1000 train steps in 38.92 secs
Step  147000: train WeightedCategoryCrossEntropy |  0.97624487
Step  147000: eval  WeightedCategoryCrossEntropy |  1.40377279
Step  147000: eval                      Accuracy |  0.58196793

Step  148000: Ran 1000 train steps in 38.91 secs
Step  148000: train WeightedCategoryCrossEntropy |  0.99337947
Step  148000: eval  WeightedCategoryCrossEntropy |  1.38602730
Step  148000: eval                      Accuracy |  0.56986465

Step  149000: Ran 1000 train steps in 38.88 secs
Step  149000: train WeightedCategoryCrossEntropy |  1.00641680
Step  149000: eval  WeightedCategoryCrossEntropy |  1.39816805
Step  149000: eval                      Accuracy |  0.57870026

Step  150000: Ran 1000 train steps in 38.92 secs
Step  150000: train WeightedCategoryCrossEntropy |  0.98345733
Step  150000: eval  WeightedCategoryCrossEntropy |  1.42259351
Step  150000: eval                      Accuracy |  0.56833545

Step  151000: Ran 1000 train steps in 38.91 secs
Step  151000: train WeightedCategoryCrossEntropy |  0.97820592
Step  151000: eval  WeightedCategoryCrossEntropy |  1.38016677
Step  151000: eval                      Accuracy |  0.57927004

Step  152000: Ran 1000 train steps in 38.92 secs
Step  152000: train WeightedCategoryCrossEntropy |  0.99465126
Step  152000: eval  WeightedCategoryCrossEntropy |  1.40752935
Step  152000: eval                      Accuracy |  0.57599767

Step  153000: Ran 1000 train steps in 38.91 secs
Step  153000: train WeightedCategoryCrossEntropy |  1.00440490
Step  153000: eval  WeightedCategoryCrossEntropy |  1.38850121
Step  153000: eval                      Accuracy |  0.57887087

Step  154000: Ran 1000 train steps in 38.98 secs
Step  154000: train WeightedCategoryCrossEntropy |  0.97649008
Step  154000: eval  WeightedCategoryCrossEntropy |  1.40402273
Step  154000: eval                      Accuracy |  0.57060033

Step  155000: Ran 1000 train steps in 38.91 secs
Step  155000: train WeightedCategoryCrossEntropy |  0.97934151
Step  155000: eval  WeightedCategoryCrossEntropy |  1.48141162
Step  155000: eval                      Accuracy |  0.56002742

Step  156000: Ran 1000 train steps in 38.92 secs
Step  156000: train WeightedCategoryCrossEntropy |  0.99469137
Step  156000: eval  WeightedCategoryCrossEntropy |  1.36240538
Step  156000: eval                      Accuracy |  0.57810269

Step  157000: Ran 1000 train steps in 38.91 secs
Step  157000: train WeightedCategoryCrossEntropy |  1.00433600
Step  157000: eval  WeightedCategoryCrossEntropy |  1.39899556
Step  157000: eval                      Accuracy |  0.57247500

Step  158000: Ran 1000 train steps in 38.93 secs
Step  158000: train WeightedCategoryCrossEntropy |  0.96986669
Step  158000: eval  WeightedCategoryCrossEntropy |  1.40644030
Step  158000: eval                      Accuracy |  0.57322383

Step  159000: Ran 1000 train steps in 38.92 secs
Step  159000: train WeightedCategoryCrossEntropy |  0.98071331
Step  159000: eval  WeightedCategoryCrossEntropy |  1.44401983
Step  159000: eval                      Accuracy |  0.57154638

Step  160000: Ran 1000 train steps in 38.93 secs
Step  160000: train WeightedCategoryCrossEntropy |  0.99308157
Step  160000: eval  WeightedCategoryCrossEntropy |  1.41375522
Step  160000: eval                      Accuracy |  0.57750905

Step  161000: Ran 1000 train steps in 38.97 secs
Step  161000: train WeightedCategoryCrossEntropy |  1.00366378
Step  161000: eval  WeightedCategoryCrossEntropy |  1.40615169
Step  161000: eval                      Accuracy |  0.57685037

Step  162000: Ran 1000 train steps in 39.03 secs
Step  162000: train WeightedCategoryCrossEntropy |  0.96036094
Step  162000: eval  WeightedCategoryCrossEntropy |  1.40110429
Step  162000: eval                      Accuracy |  0.57392023
Elapsed: 1:04:57.283108
</pre>
<div class="highlight">
<pre><span></span><span class="n">loop</span> <span class="o">=</span> <span class="n">take_two</span><span class="p">(</span><span class="n">gru</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">training_generator</span><span class="p">,</span> <span class="n">evaluation</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</pre></div>
<pre class="example" id="orgeaff824">

Step   7200: Ran 100 train steps in 49.91 secs
Step   7200: train WeightedCategoryCrossEntropy |  1.40845227
Step   7200: eval  WeightedCategoryCrossEntropy |  1.53364094
Step   7200: eval                      Accuracy |  0.53398244

Step   7300: Ran 100 train steps in 46.69 secs
Step   7300: train WeightedCategoryCrossEntropy |  1.37220216
Step   7300: eval  WeightedCategoryCrossEntropy |  1.42109434
Step   7300: eval                      Accuracy |  0.55498699

Step   7400: Ran 100 train steps in 46.79 secs
Step   7400: train WeightedCategoryCrossEntropy |  1.34160054
Step   7400: eval  WeightedCategoryCrossEntropy |  1.42887247
Step   7400: eval                      Accuracy |  0.54843716

Step   7500: Ran 100 train steps in 46.75 secs
Step   7500: train WeightedCategoryCrossEntropy |  1.33687389
Step   7500: eval  WeightedCategoryCrossEntropy |  1.39091337
Step   7500: eval                      Accuracy |  0.56296345

Step   7600: Ran 100 train steps in 46.73 secs
Step   7600: train WeightedCategoryCrossEntropy |  1.32682574
Step   7600: eval  WeightedCategoryCrossEntropy |  1.36574340
Step   7600: eval                      Accuracy |  0.56962399

Step   7700: Ran 100 train steps in 47.18 secs
Step   7700: train WeightedCategoryCrossEntropy |  1.31113505
Step   7700: eval  WeightedCategoryCrossEntropy |  1.37930723
Step   7700: eval                      Accuracy |  0.56413543

Step   7800: Ran 100 train steps in 46.63 secs
Step   7800: train WeightedCategoryCrossEntropy |  1.30171084
Step   7800: eval  WeightedCategoryCrossEntropy |  1.40999524
Step   7800: eval                      Accuracy |  0.56547354

Step   7900: Ran 100 train steps in 46.62 secs
Step   7900: train WeightedCategoryCrossEntropy |  1.29436350
Step   7900: eval  WeightedCategoryCrossEntropy |  1.33792806
Step   7900: eval                      Accuracy |  0.58449248

Step   8000: Ran 100 train steps in 46.63 secs
Step   8000: train WeightedCategoryCrossEntropy |  1.29799175
Step   8000: eval  WeightedCategoryCrossEntropy |  1.33296335
Step   8000: eval                      Accuracy |  0.57597931

Step   8100: Ran 100 train steps in 46.70 secs
Step   8100: train WeightedCategoryCrossEntropy |  1.28517950
Step   8100: eval  WeightedCategoryCrossEntropy |  1.40022814
Step   8100: eval                      Accuracy |  0.55829932

Step   8200: Ran 100 train steps in 46.64 secs
Step   8200: train WeightedCategoryCrossEntropy |  1.28536940
Step   8200: eval  WeightedCategoryCrossEntropy |  1.37004666
Step   8200: eval                      Accuracy |  0.56932286

Step   8300: Ran 100 train steps in 46.59 secs
Step   8300: train WeightedCategoryCrossEntropy |  1.28937984
Step   8300: eval  WeightedCategoryCrossEntropy |  1.39467760
Step   8300: eval                      Accuracy |  0.55672725

Step   8400: Ran 100 train steps in 46.59 secs
Step   8400: train WeightedCategoryCrossEntropy |  1.28266370
Step   8400: eval  WeightedCategoryCrossEntropy |  1.40646402
Step   8400: eval                      Accuracy |  0.56549414

Step   8500: Ran 100 train steps in 46.58 secs
Step   8500: train WeightedCategoryCrossEntropy |  1.28980207
Step   8500: eval  WeightedCategoryCrossEntropy |  1.35758976
Step   8500: eval                      Accuracy |  0.57382486

Step   8600: Ran 100 train steps in 46.59 secs
Step   8600: train WeightedCategoryCrossEntropy |  1.28626430
Step   8600: eval  WeightedCategoryCrossEntropy |  1.39424094
Step   8600: eval                      Accuracy |  0.55458832

Step   8700: Ran 100 train steps in 46.55 secs
Step   8700: train WeightedCategoryCrossEntropy |  1.27769840
Step   8700: eval  WeightedCategoryCrossEntropy |  1.34323144
Step   8700: eval                      Accuracy |  0.57333910

Step   8800: Ran 100 train steps in 46.56 secs
Step   8800: train WeightedCategoryCrossEntropy |  1.27631617
Step   8800: eval  WeightedCategoryCrossEntropy |  1.36277807
Step   8800: eval                      Accuracy |  0.57450738

Step   8900: Ran 100 train steps in 46.63 secs
Step   8900: train WeightedCategoryCrossEntropy |  1.27718043
Step   8900: eval  WeightedCategoryCrossEntropy |  1.37657404
Step   8900: eval                      Accuracy |  0.56594115

Step   9000: Ran 100 train steps in 46.56 secs
Step   9000: train WeightedCategoryCrossEntropy |  1.27473545
Step   9000: eval  WeightedCategoryCrossEntropy |  1.33857087
Step   9000: eval                      Accuracy |  0.57156471

Step   9100: Ran 100 train steps in 46.60 secs
Step   9100: train WeightedCategoryCrossEntropy |  1.27636838
Step   9100: eval  WeightedCategoryCrossEntropy |  1.32985719
Step   9100: eval                      Accuracy |  0.58792001

Step   9200: Ran 100 train steps in 46.57 secs
Step   9200: train WeightedCategoryCrossEntropy |  1.27704740
Step   9200: eval  WeightedCategoryCrossEntropy |  1.33943196
Step   9200: eval                      Accuracy |  0.57151316

Step   9300: Ran 100 train steps in 46.60 secs
Step   9300: train WeightedCategoryCrossEntropy |  1.27908921
Step   9300: eval  WeightedCategoryCrossEntropy |  1.35788206
Step   9300: eval                      Accuracy |  0.56833035

Step   9400: Ran 100 train steps in 46.59 secs
Step   9400: train WeightedCategoryCrossEntropy |  1.27476656
Step   9400: eval  WeightedCategoryCrossEntropy |  1.37336095
Step   9400: eval                      Accuracy |  0.57279189

Step   9500: Ran 100 train steps in 46.64 secs
Step   9500: train WeightedCategoryCrossEntropy |  1.27277946
Step   9500: eval  WeightedCategoryCrossEntropy |  1.38834250
Step   9500: eval                      Accuracy |  0.55810201

Step   9600: Ran 100 train steps in 46.67 secs
Step   9600: train WeightedCategoryCrossEntropy |  1.26448727
Step   9600: eval  WeightedCategoryCrossEntropy |  1.39491995
Step   9600: eval                      Accuracy |  0.55545733

Step   9700: Ran 100 train steps in 46.71 secs
Step   9700: train WeightedCategoryCrossEntropy |  1.26453817
Step   9700: eval  WeightedCategoryCrossEntropy |  1.31964866
Step   9700: eval                      Accuracy |  0.58797077

Step   9800: Ran 100 train steps in 46.63 secs
Step   9800: train WeightedCategoryCrossEntropy |  1.26623130
Step   9800: eval  WeightedCategoryCrossEntropy |  1.33691669
Step   9800: eval                      Accuracy |  0.58117094

Step   9900: Ran 100 train steps in 46.61 secs
Step   9900: train WeightedCategoryCrossEntropy |  1.26877284
Step   9900: eval  WeightedCategoryCrossEntropy |  1.35668564
Step   9900: eval                      Accuracy |  0.56906497

Step  10000: Ran 100 train steps in 46.91 secs
Step  10000: train WeightedCategoryCrossEntropy |  1.27724636
Step  10000: eval  WeightedCategoryCrossEntropy |  1.37475316
Step  10000: eval                      Accuracy |  0.57083255

Step  10100: Ran 100 train steps in 46.64 secs
Step  10100: train WeightedCategoryCrossEntropy |  1.27599573
Step  10100: eval  WeightedCategoryCrossEntropy |  1.39496668
Step  10100: eval                      Accuracy |  0.55946493

Step  10200: Ran 100 train steps in 46.66 secs
Step  10200: train WeightedCategoryCrossEntropy |  1.26500976
Step  10200: eval  WeightedCategoryCrossEntropy |  1.30219173
Step  10200: eval                      Accuracy |  0.58777571

Step  10300: Ran 100 train steps in 46.64 secs
Step  10300: train WeightedCategoryCrossEntropy |  1.26295793
Step  10300: eval  WeightedCategoryCrossEntropy |  1.34939114
Step  10300: eval                      Accuracy |  0.58265235

Step  10400: Ran 100 train steps in 46.71 secs
Step  10400: train WeightedCategoryCrossEntropy |  1.26094663
Step  10400: eval  WeightedCategoryCrossEntropy |  1.34398154
Step  10400: eval                      Accuracy |  0.58220708

Step  10500: Ran 100 train steps in 46.64 secs
Step  10500: train WeightedCategoryCrossEntropy |  1.26208460
Step  10500: eval  WeightedCategoryCrossEntropy |  1.33290792
Step  10500: eval                      Accuracy |  0.57700493

Step  10600: Ran 100 train steps in 46.64 secs
Step  10600: train WeightedCategoryCrossEntropy |  1.26667988
Step  10600: eval  WeightedCategoryCrossEntropy |  1.35851014
Step  10600: eval                      Accuracy |  0.56506201

Step  10700: Ran 100 train steps in 46.68 secs
Step  10700: train WeightedCategoryCrossEntropy |  1.26337409
Step  10700: eval  WeightedCategoryCrossEntropy |  1.33711513
Step  10700: eval                      Accuracy |  0.56967231

Step  10800: Ran 100 train steps in 46.71 secs
Step  10800: train WeightedCategoryCrossEntropy |  1.26840901
Step  10800: eval  WeightedCategoryCrossEntropy |  1.34306133
Step  10800: eval                      Accuracy |  0.57760129

Step  10900: Ran 100 train steps in 46.68 secs
Step  10900: train WeightedCategoryCrossEntropy |  1.26851952
Step  10900: eval  WeightedCategoryCrossEntropy |  1.36890825
Step  10900: eval                      Accuracy |  0.56626668

Step  11000: Ran 100 train steps in 46.60 secs
Step  11000: train WeightedCategoryCrossEntropy |  1.26771557
Step  11000: eval  WeightedCategoryCrossEntropy |  1.33610710
Step  11000: eval                      Accuracy |  0.58137830

Step  11100: Ran 100 train steps in 46.61 secs
Step  11100: train WeightedCategoryCrossEntropy |  1.26955628
Step  11100: eval  WeightedCategoryCrossEntropy |  1.31183930
Step  11100: eval                      Accuracy |  0.58702825

Step  11200: Ran 100 train steps in 46.51 secs
Step  11200: train WeightedCategoryCrossEntropy |  1.25960994
Step  11200: eval  WeightedCategoryCrossEntropy |  1.35415089
Step  11200: eval                      Accuracy |  0.57303894

Step  11300: Ran 100 train steps in 46.57 secs
Step  11300: train WeightedCategoryCrossEntropy |  1.26471293
Step  11300: eval  WeightedCategoryCrossEntropy |  1.35277263
Step  11300: eval                      Accuracy |  0.57152595

Step  11400: Ran 100 train steps in 46.53 secs
Step  11400: train WeightedCategoryCrossEntropy |  1.25756633
Step  11400: eval  WeightedCategoryCrossEntropy |  1.30689363
Step  11400: eval                      Accuracy |  0.58587994

Step  11500: Ran 100 train steps in 46.72 secs
Step  11500: train WeightedCategoryCrossEntropy |  1.26152885
Step  11500: eval  WeightedCategoryCrossEntropy |  1.35160565
Step  11500: eval                      Accuracy |  0.57004086

Step  11600: Ran 100 train steps in 46.56 secs
Step  11600: train WeightedCategoryCrossEntropy |  1.23939836
Step  11600: eval  WeightedCategoryCrossEntropy |  1.31620030
Step  11600: eval                      Accuracy |  0.57880658

Step  11700: Ran 100 train steps in 46.58 secs
Step  11700: train WeightedCategoryCrossEntropy |  1.23543918
Step  11700: eval  WeightedCategoryCrossEntropy |  1.36910570
Step  11700: eval                      Accuracy |  0.56298707

Step  11800: Ran 100 train steps in 46.54 secs
Step  11800: train WeightedCategoryCrossEntropy |  1.24286366
Step  11800: eval  WeightedCategoryCrossEntropy |  1.36233894
Step  11800: eval                      Accuracy |  0.57290844

Step  11900: Ran 100 train steps in 46.57 secs
Step  11900: train WeightedCategoryCrossEntropy |  1.23808372
Step  11900: eval  WeightedCategoryCrossEntropy |  1.35872213
Step  11900: eval                      Accuracy |  0.57846189

Step  12000: Ran 100 train steps in 46.53 secs
Step  12000: train WeightedCategoryCrossEntropy |  1.23670936
Step  12000: eval  WeightedCategoryCrossEntropy |  1.32247432
Step  12000: eval                      Accuracy |  0.57690984

Step  12100: Ran 100 train steps in 46.55 secs
Step  12100: train WeightedCategoryCrossEntropy |  1.24116862
Step  12100: eval  WeightedCategoryCrossEntropy |  1.34740726
Step  12100: eval                      Accuracy |  0.57368577

Step  12200: Ran 100 train steps in 46.56 secs
Step  12200: train WeightedCategoryCrossEntropy |  1.23870814
Step  12200: eval  WeightedCategoryCrossEntropy |  1.34412030
Step  12200: eval                      Accuracy |  0.57441618

Step  12300: Ran 100 train steps in 46.51 secs
Step  12300: train WeightedCategoryCrossEntropy |  1.23964739
Step  12300: eval  WeightedCategoryCrossEntropy |  1.31778471
Step  12300: eval                      Accuracy |  0.59404006

Step  12400: Ran 100 train steps in 46.57 secs
Step  12400: train WeightedCategoryCrossEntropy |  1.23977387
Step  12400: eval  WeightedCategoryCrossEntropy |  1.36329297
Step  12400: eval                      Accuracy |  0.56865372

Step  12500: Ran 100 train steps in 46.56 secs
Step  12500: train WeightedCategoryCrossEntropy |  1.24057162
Step  12500: eval  WeightedCategoryCrossEntropy |  1.32396106
Step  12500: eval                      Accuracy |  0.57749913

Step  12600: Ran 100 train steps in 46.57 secs
Step  12600: train WeightedCategoryCrossEntropy |  1.23996282
Step  12600: eval  WeightedCategoryCrossEntropy |  1.35980467
Step  12600: eval                      Accuracy |  0.57681503

Step  12700: Ran 100 train steps in 46.53 secs
Step  12700: train WeightedCategoryCrossEntropy |  1.23197782
Step  12700: eval  WeightedCategoryCrossEntropy |  1.35620030
Step  12700: eval                      Accuracy |  0.56576115

Step  12800: Ran 100 train steps in 46.54 secs
Step  12800: train WeightedCategoryCrossEntropy |  1.23929477
Step  12800: eval  WeightedCategoryCrossEntropy |  1.32664406
Step  12800: eval                      Accuracy |  0.57836610

Step  12900: Ran 100 train steps in 46.53 secs
Step  12900: train WeightedCategoryCrossEntropy |  1.24684954
Step  12900: eval  WeightedCategoryCrossEntropy |  1.35356160
Step  12900: eval                      Accuracy |  0.57247027

Step  13000: Ran 100 train steps in 46.54 secs
Step  13000: train WeightedCategoryCrossEntropy |  1.23555624
Step  13000: eval  WeightedCategoryCrossEntropy |  1.30849167
Step  13000: eval                      Accuracy |  0.58658669

Step  13100: Ran 100 train steps in 46.54 secs
Step  13100: train WeightedCategoryCrossEntropy |  1.23514199
Step  13100: eval  WeightedCategoryCrossEntropy |  1.32829968
Step  13100: eval                      Accuracy |  0.57877260

Step  13200: Ran 100 train steps in 46.57 secs
Step  13200: train WeightedCategoryCrossEntropy |  1.24334764
Step  13200: eval  WeightedCategoryCrossEntropy |  1.32007960
Step  13200: eval                      Accuracy |  0.58390542

Step  13300: Ran 100 train steps in 46.50 secs
Step  13300: train WeightedCategoryCrossEntropy |  1.23758221
Step  13300: eval  WeightedCategoryCrossEntropy |  1.33836234
Step  13300: eval                      Accuracy |  0.57748077

Step  13400: Ran 100 train steps in 46.53 secs
Step  13400: train WeightedCategoryCrossEntropy |  1.23699570
Step  13400: eval  WeightedCategoryCrossEntropy |  1.28857458
Step  13400: eval                      Accuracy |  0.59427991

Step  13500: Ran 100 train steps in 46.56 secs
Step  13500: train WeightedCategoryCrossEntropy |  1.24157882
Step  13500: eval  WeightedCategoryCrossEntropy |  1.33362718
Step  13500: eval                      Accuracy |  0.57985461

Step  13600: Ran 100 train steps in 46.57 secs
Step  13600: train WeightedCategoryCrossEntropy |  1.24225903
Step  13600: eval  WeightedCategoryCrossEntropy |  1.33033669
Step  13600: eval                      Accuracy |  0.58468521

Step  13700: Ran 100 train steps in 46.56 secs
Step  13700: train WeightedCategoryCrossEntropy |  1.24346125
Step  13700: eval  WeightedCategoryCrossEntropy |  1.31333911
Step  13700: eval                      Accuracy |  0.58795037

Step  13800: Ran 100 train steps in 46.56 secs
Step  13800: train WeightedCategoryCrossEntropy |  1.24078453
Step  13800: eval  WeightedCategoryCrossEntropy |  1.34135834
Step  13800: eval                      Accuracy |  0.57634938

Step  13900: Ran 100 train steps in 46.67 secs
Step  13900: train WeightedCategoryCrossEntropy |  1.23734236
Step  13900: eval  WeightedCategoryCrossEntropy |  1.36791305
Step  13900: eval                      Accuracy |  0.56584058

Step  14000: Ran 100 train steps in 46.56 secs
Step  14000: train WeightedCategoryCrossEntropy |  1.23029447
Step  14000: eval  WeightedCategoryCrossEntropy |  1.36097904
Step  14000: eval                      Accuracy |  0.56552213

Step  14100: Ran 100 train steps in 46.66 secs
Step  14100: train WeightedCategoryCrossEntropy |  1.23631048
Step  14100: eval  WeightedCategoryCrossEntropy |  1.32405988
Step  14100: eval                      Accuracy |  0.57309214

Step  14200: Ran 100 train steps in 46.68 secs
Step  14200: train WeightedCategoryCrossEntropy |  1.22712052
Step  14200: eval  WeightedCategoryCrossEntropy |  1.37027800
Step  14200: eval                      Accuracy |  0.55948075

Step  14300: Ran 100 train steps in 46.63 secs
Step  14300: train WeightedCategoryCrossEntropy |  1.23570395
Step  14300: eval  WeightedCategoryCrossEntropy |  1.30359221
Step  14300: eval                      Accuracy |  0.59196734

Step  14400: Ran 100 train steps in 46.63 secs
Step  14400: train WeightedCategoryCrossEntropy |  1.23788667
Step  14400: eval  WeightedCategoryCrossEntropy |  1.30524611
Step  14400: eval                      Accuracy |  0.58691663

Step  14500: Ran 100 train steps in 46.69 secs
Step  14500: train WeightedCategoryCrossEntropy |  1.23419011
Step  14500: eval  WeightedCategoryCrossEntropy |  1.36804922
Step  14500: eval                      Accuracy |  0.56866386

Step  14600: Ran 100 train steps in 46.65 secs
Step  14600: train WeightedCategoryCrossEntropy |  1.23835301
Step  14600: eval  WeightedCategoryCrossEntropy |  1.29339818
Step  14600: eval                      Accuracy |  0.59275184

Step  14700: Ran 100 train steps in 46.65 secs
Step  14700: train WeightedCategoryCrossEntropy |  1.23351562
Step  14700: eval  WeightedCategoryCrossEntropy |  1.32991219
Step  14700: eval                      Accuracy |  0.58760637

Step  14800: Ran 100 train steps in 46.64 secs
Step  14800: train WeightedCategoryCrossEntropy |  1.23453915
Step  14800: eval  WeightedCategoryCrossEntropy |  1.33311164
Step  14800: eval                      Accuracy |  0.57431032

Step  14900: Ran 100 train steps in 46.68 secs
Step  14900: train WeightedCategoryCrossEntropy |  1.23706901
Step  14900: eval  WeightedCategoryCrossEntropy |  1.34093809
Step  14900: eval                      Accuracy |  0.57359574

Step  15000: Ran 100 train steps in 46.61 secs
Step  15000: train WeightedCategoryCrossEntropy |  1.23998272
Step  15000: eval  WeightedCategoryCrossEntropy |  1.33679171
Step  15000: eval                      Accuracy |  0.57252198

Step  15100: Ran 100 train steps in 46.58 secs
Step  15100: train WeightedCategoryCrossEntropy |  1.23732710
Step  15100: eval  WeightedCategoryCrossEntropy |  1.29972788
Step  15100: eval                      Accuracy |  0.58468580

Step  15200: Ran 100 train steps in 46.60 secs
Step  15200: train WeightedCategoryCrossEntropy |  1.23871386
Step  15200: eval  WeightedCategoryCrossEntropy |  1.35088738
Step  15200: eval                      Accuracy |  0.57375431

Step  15300: Ran 100 train steps in 46.73 secs
Step  15300: train WeightedCategoryCrossEntropy |  1.23521864
Step  15300: eval  WeightedCategoryCrossEntropy |  1.30088254
Step  15300: eval                      Accuracy |  0.58499869

Step  15400: Ran 100 train steps in 46.65 secs
Step  15400: train WeightedCategoryCrossEntropy |  1.21270466
Step  15400: eval  WeightedCategoryCrossEntropy |  1.32416697
Step  15400: eval                      Accuracy |  0.58676630

Step  15500: Ran 100 train steps in 46.60 secs
Step  15500: train WeightedCategoryCrossEntropy |  1.20742071
Step  15500: eval  WeightedCategoryCrossEntropy |  1.31221966
Step  15500: eval                      Accuracy |  0.57679959

Step  15600: Ran 100 train steps in 46.54 secs
Step  15600: train WeightedCategoryCrossEntropy |  1.21754849
Step  15600: eval  WeightedCategoryCrossEntropy |  1.35318093
Step  15600: eval                      Accuracy |  0.57858366

Step  15700: Ran 100 train steps in 46.59 secs
Step  15700: train WeightedCategoryCrossEntropy |  1.20770407
Step  15700: eval  WeightedCategoryCrossEntropy |  1.33204349
Step  15700: eval                      Accuracy |  0.57040226

Step  15800: Ran 100 train steps in 46.58 secs
Step  15800: train WeightedCategoryCrossEntropy |  1.21227086
Step  15800: eval  WeightedCategoryCrossEntropy |  1.32108204
Step  15800: eval                      Accuracy |  0.58142904

Step  15900: Ran 100 train steps in 46.66 secs
Step  15900: train WeightedCategoryCrossEntropy |  1.20630026
Step  15900: eval  WeightedCategoryCrossEntropy |  1.34532928
Step  15900: eval                      Accuracy |  0.57363081

Step  16000: Ran 100 train steps in 46.58 secs
Step  16000: train WeightedCategoryCrossEntropy |  1.21732092
Step  16000: eval  WeightedCategoryCrossEntropy |  1.34888089
Step  16000: eval                      Accuracy |  0.57829400

Step  16100: Ran 100 train steps in 46.57 secs
Step  16100: train WeightedCategoryCrossEntropy |  1.20914495
Step  16100: eval  WeightedCategoryCrossEntropy |  1.34065656
Step  16100: eval                      Accuracy |  0.57866746

Step  16200: Ran 100 train steps in 46.57 secs
Step  16200: train WeightedCategoryCrossEntropy |  1.21117663
Step  16200: eval  WeightedCategoryCrossEntropy |  1.32027900
Step  16200: eval                      Accuracy |  0.58533911

Step  16300: Ran 100 train steps in 46.58 secs
Step  16300: train WeightedCategoryCrossEntropy |  1.21760499
Step  16300: eval  WeightedCategoryCrossEntropy |  1.30371308
Step  16300: eval                      Accuracy |  0.59620357

Step  16400: Ran 100 train steps in 46.52 secs
Step  16400: train WeightedCategoryCrossEntropy |  1.20953822
Step  16400: eval  WeightedCategoryCrossEntropy |  1.31595250
Step  16400: eval                      Accuracy |  0.58975597

Step  16500: Ran 100 train steps in 46.51 secs
Step  16500: train WeightedCategoryCrossEntropy |  1.22410822
Step  16500: eval  WeightedCategoryCrossEntropy |  1.33057849
Step  16500: eval                      Accuracy |  0.58313890

Step  16600: Ran 100 train steps in 46.57 secs
Step  16600: train WeightedCategoryCrossEntropy |  1.21633768
Step  16600: eval  WeightedCategoryCrossEntropy |  1.34370232
Step  16600: eval                      Accuracy |  0.56324571

Step  16700: Ran 100 train steps in 46.50 secs
Step  16700: train WeightedCategoryCrossEntropy |  1.21109343
Step  16700: eval  WeightedCategoryCrossEntropy |  1.34736327
Step  16700: eval                      Accuracy |  0.55796552

Step  16800: Ran 100 train steps in 46.53 secs
Step  16800: train WeightedCategoryCrossEntropy |  1.22027659
Step  16800: eval  WeightedCategoryCrossEntropy |  1.34284500
Step  16800: eval                      Accuracy |  0.58001840

Step  16900: Ran 100 train steps in 46.49 secs
Step  16900: train WeightedCategoryCrossEntropy |  1.21650743
Step  16900: eval  WeightedCategoryCrossEntropy |  1.31663891
Step  16900: eval                      Accuracy |  0.58754251

Step  17000: Ran 100 train steps in 46.52 secs
Step  17000: train WeightedCategoryCrossEntropy |  1.21804380
Step  17000: eval  WeightedCategoryCrossEntropy |  1.32078075
Step  17000: eval                      Accuracy |  0.57559681

Step  17100: Ran 100 train steps in 46.54 secs
Step  17100: train WeightedCategoryCrossEntropy |  1.22012901
Step  17100: eval  WeightedCategoryCrossEntropy |  1.28926949
Step  17100: eval                      Accuracy |  0.59518562
</pre>
<p>It looks like it's stuck.</p>
</div>
<div class="outline-4" id="outline-container-org92add33">
<h4 id="org92add33">Plotting Accuracy</h4>
<div class="outline-text-4" id="text-org92add33">
<div class="highlight">
<pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"eval"</span><span class="p">,</span> <span class="s2">"metrics/Accuracy"</span><span class="p">),</span>
                         <span class="n">columns</span><span class="o">=</span><span class="s2">"Batch Accuracy"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
<span class="n">vline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">maximum</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">hline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">maximum</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Batch"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Accuracy"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">blue</span><span class="p">))</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">*</span> <span class="n">hline</span> <span class="o">*</span> <span class="n">vline</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                                   <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Evaluation Batch Accuracy"</span><span class="p">,</span>
                                   <span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"evaluation_accuracy"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/deep-n-grams-training-the-model/evaluation_accuracy.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
<div class="outline-4" id="outline-container-orge2c4e98">
<h4 id="orge2c4e98">Plotting Loss</h4>
<div class="outline-text-4" id="text-orge2c4e98">
<div class="highlight">
<pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"eval"</span><span class="p">,</span> <span class="s2">"metrics/WeightedCategoryCrossEntropy"</span><span class="p">)</span>
                         <span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">"Batch Loss"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">minimum</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">Loss</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]</span>
<span class="n">vline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">minimum</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">hline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">minimum</span><span class="o">.</span><span class="n">Loss</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Batch"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Loss"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">blue</span><span class="p">))</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">*</span> <span class="n">hline</span> <span class="o">*</span> <span class="n">vline</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                                   <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Evaluation Batch Cross Entropy"</span><span class="p">,</span>
                                   <span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"evaluation_cross_entropy"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
: <object data="posts/nlp/deep-n-grams-training-the-model/evaluation_cross_entropy.html" height="800" style="width:100%" type="text/html">:
<p>Figure Missing</p>
:</object>
<p>Well, it looks like it's getting worse, not better. I'm probably overfitting. I guess this model isn't good enough to do better.</p>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/deep-n-grams-creating-the-model/">Deep N-Grams: Creating the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/deep-n-grams-creating-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-05T16:48:01-08:00" itemprop="datePublished" title="2021-01-05 16:48">2021-01-05 16:48</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/#org293e12a">Defining the GRU Model</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/#orgecf0840">Imports</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/#orgafa355e">Middle</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/#org6af8637">The GRU Model</a></li>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/#org6ccf7af">Will It Build?</a></li>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/#org046cd8d">Saving it for Later</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/#orgdbfa5a3">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/#org52de6ea">Model Builder</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/#orgb9900af">Check It Out</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org293e12a">
<h2 id="org293e12a">Defining the GRU Model</h2>
<div class="outline-text-2" id="text-org293e12a">
<ul class="org-ul">
<li><a href="posts/nlp/deep-n-grams/">First Post</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/">Previous Post</a></li>
<li><a href="posts/nlp/deep-n-grams-training-the-model/">Next Post</a></li>
</ul>
<p>We're going to build a <code>GRU</code> model using trax. We'll do this by passing in "layers" to the <code>Serial</code> class:</p>
<ul class="org-ul">
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.combinators.Serial"><code>Serial</code></a>: Class that applies layers serially (by function composition).
<ul class="org-ul">
<li>You can pass in the layers as arguments to <code>Serial</code>, separated by commas.</li>
<li>For example: <code>Serial(Embeddings(...), Mean(...), Dense(...), LogSoftmax(...))</code></li>
</ul>
</li>
</ul>
<p>These are the layers that we'll be using:</p>
<ul class="org-ul">
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.attention.ShiftRight"><code>ShiftRight</code></a>: A layer that adds padding to shift the input. (note that this is one of the Trax methods that has re-named the arguments)
<ul class="org-ul">
<li><code>ShiftRight(n_positions=1, mode</code>'train')= layer to shift the tensor to the right n_positions times</li>
<li>Here in the exercise you only need to specify the mode and not worry about n_positions</li>
</ul>
</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Embedding"><code>Embedding</code></a>: Initializes the embedding layer which maps tokens/IDs to vectors
<ul class="org-ul">
<li><code>Embedding(vocab_size, d_feature)</code>. In this case it is the size of the vocabulary by the dimension of the model.</li>
<li><code>vocab_size</code> is the number of unique words in the given vocabulary.</li>
<li><code>d_feature</code> is the number of elements in the word embedding (some choices for a word embedding size range from 150 to 300, for example).</li>
</ul>
</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.rnn.GRU"><code>GRU</code></a>: The <code>Trax</code> GRU layer.
<ul class="org-ul">
<li><code>GRU(n_units)</code> Builds a traditional GRU of n_cells with dense internal transformations.</li>
<li>An academic paper looking at the GRU: <a href="https://arxiv.org/abs/1412.3555">Empirical Evaluation of Gated Neural Networks On Sequence Modeling</a></li>
</ul>
</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Dense"><code>Dense</code></a>: A dense (fully-connected) layer.
<ul class="org-ul">
<li><code>Dense(n_units)</code>: The parameter <code>n_units</code> is the number of units chosen for this dense layer.</li>
</ul>
</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.LogSoftmax"><code>LogSoftmax</code></a>: Log of the output probabilities.
<ul class="org-ul">
<li>Here, you don't need to set any parameters for <code>LogSoftMax()</code>.</li>
</ul>
</li>
</ul>
</div>
<div class="outline-3" id="outline-container-orgecf0840">
<h3 id="orgecf0840">Imports</h3>
<div class="outline-text-3" id="text-orgecf0840">
<div class="highlight">
<pre><span></span><span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgafa355e">
<h2 id="orgafa355e">Middle</h2>
<div class="outline-text-2" id="text-orgafa355e"></div>
<div class="outline-3" id="outline-container-org6af8637">
<h3 id="org6af8637">The GRU Model</h3>
<div class="outline-text-3" id="text-org6af8637">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">GRULM</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">'train'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">:</span>
    <span class="sd">"""Returns a GRU language model.</span>

<span class="sd">    Args:</span>
<span class="sd">       vocab_size (int, optional): Size of the vocabulary. Defaults to 256.</span>
<span class="sd">       d_model (int, optional): Depth of embedding (n_units in the GRU cell). Defaults to 512.</span>
<span class="sd">       n_layers (int, optional): Number of GRU layers. Defaults to 2.</span>
<span class="sd">       mode (str, optional): 'train', 'eval' or 'predict', predict mode is for fast inference. Defaults to "train".</span>

<span class="sd">    Returns:</span>
<span class="sd">       trax.layers.combinators.Serial: A GRU language model as a layer that maps from a tensor of tokens to activations over a vocab set.</span>
<span class="sd">    """</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
        <span class="c1"># the ``n_shifts`` argument seems to have changed to ``n_positions``,</span>
        <span class="c1"># don't use it remain be backwards compatible</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">ShiftRight</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">),</span>
        <span class="o">*</span><span class="p">[</span><span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layers</span><span class="p">)],</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org6ccf7af">
<h3 id="org6ccf7af">Will It Build?</h3>
<div class="outline-text-3" id="text-org6ccf7af">
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">GRULM</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Serial[
    ShiftRight(1)
  ]
  Embedding_256_512
  GRU_512
  GRU_512
  Dense_256
  LogSoftmax
]
</pre></div>
</div>
<div class="outline-3" id="outline-container-org046cd8d">
<h3 id="org046cd8d">Saving it for Later</h3>
<div class="outline-text-3" id="text-org046cd8d">
<p>It seems a little goofy to do this, but since I might forget some of the values, might as well.</p>
</div>
<div class="outline-4" id="outline-container-orgdbfa5a3">
<h4 id="orgdbfa5a3">Imports</h4>
<div class="outline-text-4" id="text-orgdbfa5a3">
<div class="highlight">
<pre><span></span><span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="kn">import</span> <span class="nn">attr</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org52de6ea">
<h4 id="org52de6ea">Model Builder</h4>
<div class="outline-text-4" id="text-org52de6ea">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">GRUModel</span><span class="p">:</span>
    <span class="sd">"""Builds the layers for the GRU model</span>

<span class="sd">    Args:</span>
<span class="sd">     shift_positions: amount of padding to add to the front of input</span>
<span class="sd">     vocabulary_size: the size of our learned vocabulary</span>
<span class="sd">     model_dimensions: the GRU and Embeddings dimensions</span>
<span class="sd">     gru_layers: how many GRU layers to create</span>
<span class="sd">     mode: train, eval, or predict</span>
<span class="sd">    """</span>
    <span class="n">shift_positions</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">vocabulary_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">256</span>
    <span class="n">model_dimensions</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">512</span>
    <span class="n">gru_layers</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"train"</span>
    <span class="n">_model</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgaa18b32"></a>The Model<br>
<div class="outline-text-5" id="text-orgaa18b32">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">:</span>
    <span class="sd">"""The GRU Model"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">ShiftRight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_positions</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dimensions</span><span class="p">),</span>
            <span class="o">*</span><span class="p">[</span><span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dimensions</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">gru_layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gru_layers</span><span class="p">)],</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary_size</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgb9900af">
<h3 id="orgb9900af">Check It Out</h3>
<div class="outline-text-3" id="text-orgb9900af">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn</span> <span class="kn">import</span> <span class="n">GRUModel</span>

<span class="n">gru</span> <span class="o">=</span> <span class="n">GRUModel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gru</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Serial[
    ShiftRight(1)
  ]
  Embedding_256_512
  GRU_512
  GRU_512
  Dense_256
  LogSoftmax
]
</pre></div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/deep-n-grams-loading-the-data/">Deep N-Grams: Loading the Data</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/deep-n-grams-loading-the-data/" rel="bookmark"><time class="published dt-published" datetime="2021-01-05T16:47:30-08:00" itemprop="datePublished" title="2021-01-05 16:47">2021-01-05 16:47</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#org9033715">Text to Tensor</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#org91d1d48">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#org47c023b">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#orgff918c2">Middle</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#org64e988c">Loading the Data</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#org1251323">To Tensors</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#org53569e1">Test the Output</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#orgb41b286">Bundle It Up</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#org26f8b4a">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#orge9151ec">The Data Loader</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#orge26cabc">The Data Path</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#org0cfc5af">The Lines</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#org3130ca0">The Training Set</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#orgd2c086f">The Validation Set</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#orgef52bbf">To Tensor</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/#org342a237">Check the Data Loader</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org9033715">
<h2 id="org9033715">Text to Tensor</h2>
<div class="outline-text-2" id="text-org9033715">
<ul class="org-ul">
<li><a href="posts/nlp/deep-n-grams/">Previous Post</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/">Next Post</a></li>
</ul>
<p>In this section we're going to load the text data and transform it into tensors.</p>
</div>
<div class="outline-3" id="outline-container-org91d1d48">
<h3 id="org91d1d48">Imports</h3>
<div class="outline-text-3" id="text-org91d1d48">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span><span class="n">be_true</span><span class="p">,</span>
                     <span class="n">contain_exactly</span><span class="p">,</span>
                     <span class="n">equal</span><span class="p">,</span>
                     <span class="n">expect</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org47c023b">
<h3 id="org47c023b">Set Up</h3>
<div class="outline-text-3" id="text-org47c023b">
<p>The path to the data is kept in a <code>.env</code> file so we'll load it into the environment here.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"SHAKESPEARE"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">expect</span><span class="p">(</span><span class="n">data_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgff918c2">
<h2 id="orgff918c2">Middle</h2>
<div class="outline-text-2" id="text-orgff918c2"></div>
<div class="outline-3" id="outline-container-org64e988c">
<h3 id="org64e988c">Loading the Data</h3>
<div class="outline-text-3" id="text-org64e988c">
<p>We're going to be using the plays of Shakespeare. Unlike previously, this data source has them in separate files so we'll have to load each one separately. We're going to be generating characters, not words, so each character has to be given an integer ID. We'll use the Unicode values given to us by the built-in <a href="https://docs.python.org/3/library/functions.html#ord">ord</a> function.</p>
<div class="highlight">
<pre><span></span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">data_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.txt"</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">filename</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">play</span><span class="p">:</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">play</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cleaned</span> <span class="k">if</span> <span class="n">line</span><span class="p">]</span>
</pre></div>
<p>This only cleans out the leading and trailing whitespace, there are other things like tabs still in there.</p>
<div class="highlight">
<pre><span></span><span class="n">line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of lines: </span><span class="si">{</span><span class="n">line_count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Sample line at position 0: </span><span class="si">{</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Sample line at position 999: </span><span class="si">{</span><span class="n">lines</span><span class="p">[</span><span class="mi">999</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Number of lines: 125,097
Sample line at position 0: king john
Sample line at position 999: as it makes harmful all that speak of it.
</pre>
<p>To make this a little easier, we'll convert all characters to lowercase. This way, for example, the model only needs to predict the likelihood that a letter is 'a' and not decide between uppercase 'A' and lowercase 'a'.</p>
<div class="highlight">
<pre><span></span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

<span class="n">new_line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">new_line_count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">line_count</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of lines: </span><span class="si">{</span><span class="n">new_line_count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Sample line at position 0: </span><span class="si">{</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Sample line at position 999: </span><span class="si">{</span><span class="n">lines</span><span class="p">[</span><span class="mi">999</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Number of lines: 125,097
Sample line at position 0: king john
Sample line at position 999: as it makes harmful all that speak of it.
</pre>
<p>Once again, we're gong to do a strait split to create the training and validation data instead of using randomization.</p>
<div class="highlight">
<pre><span></span><span class="n">SPLIT</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">validation</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="n">SPLIT</span><span class="p">:]</span>
<span class="n">training</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="n">SPLIT</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of lines for training: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">training</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of lines for validation: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">validation</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Number of lines for training: 124,097
Number of lines for validation: 1,000
</pre></div>
</div>
<div class="outline-3" id="outline-container-org1251323">
<h3 id="org1251323">To Tensors</h3>
<div class="outline-text-3" id="text-org1251323">
<p>Like I mentioned before, we're going to use python's <code>ord</code> function to convert the letters to integers.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="s2">"abc xyz123"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">character</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">ord</span><span class="p">(</span><span class="n">character</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
a: 97
b: 98
c: 99
 : 32
x: 120
y: 121
z: 122
1: 49
2: 50
3: 51
</pre>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">line_to_tensor</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">EOS_int</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Turns a line of text into a tensor</span>

<span class="sd">    Args:</span>
<span class="sd">     line: A single line of text.</span>
<span class="sd">     EOS_int: End-of-sentence integer. Defaults to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">     a list of integers (unicode values) for the characters in the ``line``.</span>
<span class="sd">    """</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># for each character:</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>

        <span class="c1"># convert to unicode int</span>
        <span class="n">c_int</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c1"># append the unicode integer to the tensor list</span>
        <span class="n">tensor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_int</span><span class="p">)</span>

    <span class="c1"># include the end-of-sentence integer</span>
    <span class="n">tensor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EOS_int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tensor</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org53569e1">
<h4 id="org53569e1">Test the Output</h4>
<div class="outline-text-4" id="text-org53569e1">
<div class="highlight">
<pre><span></span><span class="n">actual</span> <span class="o">=</span> <span class="n">line_to_tensor</span><span class="p">(</span><span class="s1">'abc xyz'</span><span class="p">)</span>
<span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">97</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">expect</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb41b286">
<h3 id="orgb41b286">Bundle It Up</h3>
<div class="outline-text-3" id="text-orgb41b286">
<p>This is going to be needed in future posts so I'm going to put it in a class.</p>
</div>
<div class="outline-4" id="outline-container-org26f8b4a">
<h4 id="org26f8b4a">Imports</h4>
<div class="outline-text-4" id="text-org26f8b4a">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">import</span> <span class="nn">attr</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge9151ec">
<h4 id="orge9151ec">The Data Loader</h4>
<div class="outline-text-4" id="text-orge9151ec">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataLoader</span><span class="p">:</span>
    <span class="sd">"""Load the data and convert it to 'tensors'</span>

<span class="sd">    Args:</span>
<span class="sd">     env_path: the path to the env file (as a string)</span>
<span class="sd">     env_key: the environmental variable with the path to the data</span>
<span class="sd">     validation_size: number for the validation set</span>
<span class="sd">     end_of_sentence: integer to use to indicate the end of a sentence</span>
<span class="sd">    """</span>
    <span class="n">env_path</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"posts/nlp/.env"</span>
    <span class="n">env_key</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"SHAKESPEARE"</span>
    <span class="n">validation_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1000</span>
    <span class="n">end_of_sentence</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">_data_path</span><span class="p">:</span> <span class="n">Path</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_lines</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_training</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_validation</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge26cabc">
<h4 id="orge26cabc">The Data Path</h4>
<div class="outline-text-4" id="text-orge26cabc">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sd">"""Loads the dotenv and converts the path</span>

<span class="sd">    Raises:</span>
<span class="sd">     assertion error if path doesn't exist</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">load_dotenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env_path</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env_key</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0cfc5af">
<h4 id="org0cfc5af">The Lines</h4>
<div class="outline-text-4" id="text-org0cfc5af">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The lines of text-data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.txt"</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">filename</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">play</span><span class="p">:</span>
                <span class="n">cleaned</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">play</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cleaned</span> <span class="k">if</span> <span class="n">line</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3130ca0">
<h4 id="org3130ca0">The Training Set</h4>
<div class="outline-text-4" id="text-org3130ca0">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">training</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Subset of the lines for training"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_size</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd2c086f">
<h4 id="orgd2c086f">The Validation Set</h4>
<div class="outline-text-4" id="text-orgd2c086f">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">validation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The validation subset of the lines"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_size</span><span class="p">:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgef52bbf">
<h4 id="orgef52bbf">To Tensor</h4>
<div class="outline-text-4" id="text-orgef52bbf">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Converts the line to the unicode value</span>

<span class="sd">    Args:</span>
<span class="sd">     line: the text to convert</span>
<span class="sd">    Returns:</span>
<span class="sd">     line converted to unicode integer encodings</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">character</span><span class="p">)</span> <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">end_of_sentence</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org342a237">
<h3 id="org342a237">Check the Data Loader</h3>
<div class="outline-text-3" id="text-org342a237">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn.data_loader</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>

<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">lines</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">line_count</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">validation</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">SPLIT</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">training</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">line_count</span> <span class="o">-</span> <span class="n">SPLIT</span><span class="p">))</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="s1">'abc xyz'</span><span class="p">)</span>
<span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">97</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">expect</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">lines</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
<pre class="example">
king john
dramatis personae
king john:
prince henry    son to the king.
arthur  duke of bretagne, nephew to the king.
the earl of
pembroke        (pembroke:)
the earl of essex       (essex:)
the earl of
salisbury       (salisbury:)
</pre></div>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-19.html" rel="prev">Newer posts</a></li>
<li class="next"><a href="index-17.html" rel="next">Older posts</a></li>
</ul>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']],},

        });
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script><!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
