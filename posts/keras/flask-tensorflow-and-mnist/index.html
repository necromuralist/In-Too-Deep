<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Serving a TensorFlow MNIST model with Flask." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Flask, TensorFlow, Streamlit and the MNIST Dataset | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/keras/flask-tensorflow-and-mnist/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../../fastai/hand-rolling-a-countvectorizer/" rel="prev" title="Hand-rolling a CountVectorizer" type="text/html">
<link href="../../nlp/01-twitter-preprocessing-with-nltk/" rel="next" title="Twitter Preprocessing With NLTK" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Flask, TensorFlow, Streamlit and the MNIST Dataset" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/keras/flask-tensorflow-and-mnist/" property="og:url">
<meta content="Serving a TensorFlow MNIST model with Flask." property="og:description">
<meta content="article" property="og:type">
<meta content="2020-06-18T15:43:56-07:00" property="article:published_time">
<meta content="flask" property="article:tag">
<meta content="mnist" property="article:tag">
<meta content="tensorflow" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Flask, TensorFlow, Streamlit and the MNIST Dataset</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2020-06-18T15:43:56-07:00" itemprop="datePublished" title="2020-06-18 15:43">2020-06-18 15:43</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga0cf289">Beginning</a>
<ul>
<li><a href="#org87050f5">Set Up</a></li>
<li><a href="#org16f348b">The Environment</a></li>
<li><a href="#org8d0a82f">Plotting</a></li>
<li><a href="#org8565141">The Random Seed</a></li>
<li><a href="#org5d742aa">The Data</a></li>
<li><a href="#orgf079c21">A Note On the Tangling</a></li>
</ul>
</li>
<li><a href="#org688132c">Middle</a>
<ul>
<li><a href="#orgf8ed624">The Data</a></li>
<li><a href="#org2782468">The Neural Network Model</a></li>
<li><a href="#orga330501">The Web Page</a></li>
</ul>
</li>
<li><a href="#orgdf52e38">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orga0cf289">
<h2 id="orga0cf289">Beginning</h2>
<div class="outline-text-2" id="text-orga0cf289">
<p>This is a re-working of Coursera's <a href="https://www.coursera.org/learn/neural-network-visualizer/home/welcome">Neural Network Vizualizer Web App With Python</a> course. What we'll do is use <a href="https://www.tensorflow.org/">tensorflow</a> to build a model to classify images of handwritten digits from the <a href="http://yann.lecun.com/exdb/mnist/">MNIST Database of Handwritten Digits</a> which tensoflow provides as one of their pre-built datasets. MNIST (according to <a href="https://www.wikiwand.com/en/MNIST_database">wikipedia</a>) stands for <i>Modified <a href="https://www.wikiwand.com/en/National_Institute_of_Standards_and_Technology">National Institute of Standards and Technology</a></i> (so we're using the Modified NIST Database).</p>
<p>Once we have the model we'll use <a href="https://palletsprojects.com/p/flask/">Flask</a> to serve up the model and <a href="https://www.streamlit.io/">Streamlit</a> to build a web page to view the results.</p>
</div>
<div class="outline-3" id="outline-container-org87050f5">
<h3 id="org87050f5">Set Up</h3>
<div class="outline-text-3" id="text-org87050f5"></div>
<div class="outline-4" id="outline-container-org0749101">
<h4 id="org0749101">Parts</h4>
<div class="outline-text-4" id="text-org0749101">
<p>These are the libraries that we will use.</p>
</div>
<ul class="org-ul">
<li><a id="orga988162"></a>Python<br>
<div class="outline-text-5" id="text-orga988162">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</li>
<li><a id="org48d836b"></a>PyPi<br>
<div class="outline-text-5" id="text-org48d836b">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">HoverTool</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">tensorflow</span>
</pre></div>
</div>
</li>
<li><a id="org55663b4"></a>My Stuff<br>
<div class="outline-text-5" id="text-org55663b4">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org16f348b">
<h3 id="org16f348b">The Environment</h3>
<div class="outline-text-3" id="text-org16f348b">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">".env"</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org8d0a82f">
<h3 id="org8d0a82f">Plotting</h3>
<div class="outline-text-3" id="text-org8d0a82f">
<p>There won't be a lot of plotting, but we'll use matplotlib with seaborn to look at some images to see what they look like and <a href="https://hvplot.holoviz.org/">HVplot</a> to do other visualizations.</p>
<div class="highlight">
<pre><span></span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<p>This is for the nikola posts. If you run the jupyter kernel on a remote machine there's going to be two behaviors for the plot-files. If you create the file in the code block (like I do for the HVPlot plots) then the file will show up on the remote machine. If you use the <code>:file</code> argument in the org-mode header (like I do for matplotlib) it will create the file on the machine where you're running emacs. Given this behavior it might make more sense to edit the emacs file on the remote machine so all the files are created there… next time.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"flask-tensorflow-and-mnist"</span>
<span class="n">OUTPUT</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/keras/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org8565141">
<h3 id="org8565141">The Random Seed</h3>
<div class="outline-text-3" id="text-org8565141">
<p>Since I'm commenting on the outcomes I'll set the random seed to try and make things more consistent.</p>
<div class="highlight">
<pre><span></span><span class="n">tensorflow</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">2020</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org5d742aa">
<h3 id="org5d742aa">The Data</h3>
<div class="outline-text-3" id="text-org5d742aa">
<p>Like I mentioned, tensorflow includes the MNIST data set that we can grab with the <a href="https://www.tensorflow.org/api_docs/python/tf/keras/datasets/mnist/load_data">load_data</a> function. It returns two tuples of numpy arrays.</p>
<div class="highlight">
<pre><span></span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
<p>Let's see how much data we have.</p>
<div class="highlight">
<pre><span></span><span class="n">rows</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training:</span><span class="se">\t</span><span class="si">{</span><span class="n">rows</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> images</span><span class="se">\t</span><span class="s2">image = </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">rows</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Testing:</span><span class="se">\t</span><span class="si">{</span><span class="n">rows</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> images</span><span class="se">\t</span><span class="s2">image = </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training:       60,000 images   image = 28 x 28
Testing:        10,000 images   image = 28 x 28
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgf079c21">
<h3 id="orgf079c21">A Note On the Tangling</h3>
<div class="outline-text-3" id="text-orgf079c21">
<p>I'm going to do this as a <a href="https://www.wikiwand.com/en/Literate_programming">literate programming</a> document with the tangle going into a temporary folder. I was creating the temporary folder using python but I'm running the code on a different machine from where I'm editing this document so running python executes on the remote machine but tangling out the files happens on my local machine. Maybe next time it will make more sense to edit the document on the remote machine (note to future self). Although that also introduces problems because then I'd have to run the tests headless… Every solution has a problem.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org688132c">
<h2 id="org688132c">Middle</h2>
<div class="outline-text-2" id="text-org688132c"></div>
<div class="outline-3" id="outline-container-orgf8ed624">
<h3 id="orgf8ed624">The Data</h3>
<div class="outline-text-3" id="text-orgf8ed624"></div>
<div class="outline-4" id="outline-container-org5747ba0">
<h4 id="org5747ba0">The Distribution</h4>
<div class="outline-text-4" id="text-org5747ba0">
<p>First, we can look at the distribution of the digits to see if they are equally represented.</p>
<div class="highlight">
<pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
          <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
          <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"index"</span><span class="p">:</span> <span class="s2">"Digit"</span><span class="p">,</span>
                           <span class="mi">0</span><span class="p">:</span> <span class="s2">"Count"</span><span class="p">}))</span>
<span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span>
    <span class="n">tooltips</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">"Digit"</span><span class="p">,</span> <span class="s2">"@Digit"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Count"</span><span class="p">,</span> <span class="s2">"@Count{0,0}"</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Digit"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Digit Counts"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"digit_distribution"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">output</span><span class="p">()</span>
</pre></div>
<object data="digit_distribution.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>If you look at the values for the counts you can see that there is a pretty significant difference between 1 and 5.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Count</span> <span class="o">-</span> <span class="n">labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
1,321
</pre>
<p>But we're doing this as an exercise to get a web-page up more so than build a real model so let's not worry about that for now.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org05ffae3">
<h4 id="org05ffae3">Some Example Digits</h4>
<div class="outline-text-4" id="text-org05ffae3">
<p>We'll make a 4 x 4 grid of the first 16 images to see what they look like. Note that our array uses 0-based indexing but matplotlib uses 1-based indexing so we have to make sure that the reference to the cell in the subplot is one ahead of the index for the array.</p>
<div class="highlight">
<pre><span></span><span class="n">IMAGES</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">ROWS</span> <span class="o">=</span> <span class="n">COLUMNS</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IMAGES</span><span class="p">):</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">ROWS</span><span class="p">,</span> <span class="n">COLUMNS</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'binary'</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
<div class="figure">
<p><img alt="sample_digits.png" src="sample_digits.png"></p>
</div>
<p>So the digits (at least the first 16) seem to be pretty clear.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgb52bbfe">
<h4 id="orgb52bbfe">Normalizing the Data</h4>
<div class="outline-text-4" id="text-orgb52bbfe">
<p>One problem we have, though, is that images use values from 0 to 255 to indicate the brightness of a pixel, but neural networks tend to work better with values from 0 to 1, so we'l have to scale the data back. The images are also 28 x 28 squares, but we need to transform them to flat vectors. We can change the shape of the input data using the <a href="https://numpy.org/doc/1.18/reference/generated/numpy.reshape.html">numpy.reshape</a> function, which takes the original data and the shape you want to change it to. In our case we want the same number of rows that there were originally and we want to reduce the images from 2-dimensional images to 1-dimensional images which we can do by passing in the number of total number of pixels in each image as a single number instead of width and height.</p>
<p>Since we have to do this for both the training and testing data I'll make a helper function.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">"""reshapes the data and scales the values"""</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">pixels</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">pixels</span><span class="p">)</span>

    <span class="n">MAX_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">MAX_BRIGHTNESS</span>

    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">x_train</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org2782468">
<h3 id="org2782468">The Neural Network Model</h3>
<div class="outline-text-3" id="text-org2782468"></div>
<div class="outline-4" id="outline-container-org6cae185">
<h4 id="org6cae185">Build and Train It</h4>
<div class="outline-text-4" id="text-org6cae185">
<p>Now we'll build the model. It's going to be a simple fully-connected network with three layers (input, hidden, output). To make the visualization simpler we'll use the <a href="https://www.tensorflow.org/api_docs/python/tf/keras/activations/sigmoid">sigmoid activation</a> function.</p>
<p>Besides the shallowness of the model it's also going to be relatively simple, with only 32 nodes in the hidden layer.</p>
<p>First we'll build it as a <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Sequential">Sequential</a> (linear stack) model.</p>
<div class="highlight">
<pre><span></span><span class="n">rows</span><span class="p">,</span> <span class="n">pixels</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span>
<span class="n">HIDDEN_NODES</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">CATEGORIES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">ACTIVATION</span> <span class="o">=</span> <span class="s2">"sigmoid"</span>
<span class="n">OUTPUT_ACTIVATION</span> <span class="o">=</span> <span class="s2">"softmax"</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">HIDDEN_NODES</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="n">ACTIVATION</span><span class="p">,</span>
                                  <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">pixels</span><span class="p">,)),</span>
    <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">HIDDEN_NODES</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="n">ACTIVATION</span><span class="p">),</span>
    <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">CATEGORIES</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="n">OUTPUT_ACTIVATION</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
<p>Now we can <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Model#compile">compile</a> the model using a <a href="https://www.tensorflow.org/api_docs/python/tf/keras/losses/SparseCategoricalCrossentropy">sparse categorical cross-entropy loss function</a>, which is for the case where you have more than one category (non-binary) and the <a href="https://www.tensorflow.org/api_docs/python/tf/keras/optimizers/Adam">Adam</a> optimizer.</p>
<div class="highlight">
<pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">'sparse_categorical_crossentropy'</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="s1">'adam'</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">'accuracy'</span><span class="p">])</span>
</pre></div>
<p>And next we'll train the model by calling its <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Model#fit">fit</a> method.</p>
<div class="highlight">
<pre><span></span><span class="n">NO_OUTPUT</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">2048</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="n">NO_OUTPUT</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org845fd90">
<h4 id="org845fd90">Plot the Training History</h4>
<div class="outline-text-4" id="text-org845fd90">
<div class="highlight">
<pre><span></span><span class="n">history</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"loss"</span><span class="p">:</span> <span class="s2">"Training Loss"</span><span class="p">,</span>
        <span class="s2">"accuracy"</span><span class="p">:</span> <span class="s2">"Training Accuracy"</span><span class="p">,</span>
        <span class="s2">"val_loss"</span><span class="p">:</span> <span class="s2">"Validation Loss"</span><span class="p">,</span>
        <span class="s2">"val_accuracy"</span><span class="p">:</span> <span class="s2">"Validation Accuracy"</span><span class="p">,</span>
    <span class="p">})</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span>
    <span class="n">tooltips</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">"Metric"</span><span class="p">,</span> <span class="s2">"$name"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Epoch"</span><span class="p">,</span> <span class="s2">"$x"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Value"</span><span class="p">,</span> <span class="s2">"$y"</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">hvplot</span><span class="p">()</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Training History"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"training_history"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">output</span><span class="p">()</span>
</pre></div>
<object data="training_history.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">lowest</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">highest</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">) Min=</span><span class="si">{</span><span class="n">lowest</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Max=</span><span class="si">{</span><span class="n">highest</span><span class="si">:</span><span class="s2"> 0.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
(Training Loss) Min=0.20 Max= 2.26
(Training Accuracy) Min=0.22 Max= 0.95
(Validation Loss) Min=0.21 Max= 2.14
(Validation Accuracy) Min=0.38 Max= 0.94
</pre>
<p>So our validation accuracy goes from 38 % to 94%, which isn't bad, especially when you consider what a simple model we have.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgc098849">
<h4 id="orgc098849">Save It</h4>
<div class="outline-text-4" id="text-orgc098849">
<p>Now we can save the model to use in our flask application.</p>
<p><b>Note To Self:</b> Since this is being run on a remote machine, both the <code>.env</code> file and the directory to save the models refers to the remote machine, not the local machine where this file is being edited so you have to copy it to the local machine later on to use it with flask.</p>
<p>Also note that the you can't see the name since I put it in a <code>.env</code> file but it has <code>.h5</code> as the extension. According to the TensorFlow page on <a href="https://www.tensorflow.org/guide/keras/save_and_serialize">saving and loading a model</a>, H5 is the older format, they've switched to the <a href="https://www.tensorflow.org/guide/saved_model">SavedModel</a> format, you lose some information that would help you resume training, but we're not going to do that anyway, and the H5 format should be a little smaller.</p>
<p>Most of the next blob is to make sure the folder for the model exists. I put it in the environment variable mostly because I keep changing my mind as to where to put it and what to call it.</p>
<div class="highlight">
<pre><span></span><span class="n">base</span> <span class="o">=</span> <span class="s2">"flask_tensorflow_mnist"</span>
<span class="n">MODELS</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">base</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_model"</span><span class="p">]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">MODELS</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
<span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="n">MODELS</span><span class="o">/</span><span class="n">MODEL_NAME</span>
<span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">MODEL_PATH</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orga330501">
<h3 id="orga330501">The Web Page</h3>
<div class="outline-text-3" id="text-orga330501"></div>
<ul class="org-ul">
<li><a id="org0022143"></a>Back-End (The Model Server)<br>
<ul class="org-ul">
<li><a id="org1657b0e"></a>Tests<br>
<ul class="org-ul">
<li><a id="org528e804"></a>Fixtures<br>
<div class="outline-text-7" id="text-org528e804">
<p>These are the pytest fixtures to make it easier to create objects.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>

 <span class="c1"># from pypi</span>

 <span class="kn">import</span> <span class="nn">pytest</span>
 <span class="kn">import</span> <span class="nn">tensorflow</span>

 <span class="c1"># software under test</span>
 <span class="kn">from</span> <span class="nn">ml_server</span> <span class="kn">import</span> <span class="n">app</span>


 <span class="k">class</span> <span class="nc">Katamari</span><span class="p">:</span>
     <span class="sd">"""Something to stick things into"""</span>


 <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
 <span class="k">def</span> <span class="nf">katamari</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Katamari</span><span class="p">:</span>
     <span class="k">return</span> <span class="n">Katamari</span><span class="p">()</span>


 <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
 <span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
     <span class="sd">"""generates the flask client for testing"""</span>
     <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"TESTING"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
     <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
         <span class="k">yield</span> <span class="n">client</span>
     <span class="k">return</span>


 <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
 <span class="k">def</span> <span class="nf">mnist</span><span class="p">():</span>
     <span class="sd">"""Gets the test labels"""</span>
     <span class="n">MAX_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>
     <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
     <span class="k">return</span> <span class="n">Namespace</span><span class="p">(</span>
         <span class="n">x_test</span><span class="o">=</span><span class="n">x_test</span><span class="o">/</span><span class="n">MAX_BRIGHTNESS</span><span class="p">,</span>
         <span class="n">y_test</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span>
     <span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="org5d252ce"></a>Features<br>
<div class="outline-text-7" id="text-org5d252ce">
<p>These are the feature files.</p>
<div class="highlight">
<pre><span></span> Feature: A Prediction Getter

 Scenario: The root page is retrieved
   Given a connection to the flask client
   When the root page is retrieved
   Then it has the expected text

 Scenario: A prediction is retrieved
   Given the get_prediction function
   When a prediction is retrieved
   Then it has the correct tuple

 Scenario: The API end-point is retrieved
   Given a connection to the flask client
   When the API end-point is retrieved
   Then the response has the expected JSON
</pre></div>
</div>
</li>
<li><a id="orge1a3f93"></a>The Tests<br>
<div class="outline-text-7" id="text-orge1a3f93">
<p>These are the actual test functions.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>

 <span class="kn">import</span> <span class="nn">random</span>

 <span class="c1"># pypi</span>
 <span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">be</span><span class="p">,</span>
     <span class="n">be_true</span><span class="p">,</span>
     <span class="n">contain</span><span class="p">,</span>
     <span class="n">equal</span><span class="p">,</span>
     <span class="n">expect</span><span class="p">,</span>
 <span class="p">)</span>

 <span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">given</span><span class="p">,</span>
     <span class="n">when</span><span class="p">,</span>
     <span class="n">then</span><span class="p">,</span>
     <span class="n">scenario</span><span class="p">,</span>
     <span class="n">scenarios</span><span class="p">,</span>
 <span class="p">)</span>

 <span class="kn">import</span> <span class="nn">numpy</span>

 <span class="c1"># for testing</span>
 <span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">client</span><span class="p">,</span> <span class="n">katamari</span><span class="p">,</span> <span class="n">mnist</span>

 <span class="c1"># software under test</span>
 <span class="kn">from</span> <span class="nn">ml_server</span> <span class="kn">import</span> <span class="n">get_prediction</span><span class="p">,</span> <span class="n">PATHS</span>

 <span class="n">scenarios</span><span class="p">(</span><span class="s2">"get_predictions.feature"</span><span class="p">)</span>

 <span class="c1"># ***** Get Root Page ***** #</span>
 <span class="c1"># Scenario: The root page is retrieved</span>


 <span class="nd">@given</span><span class="p">(</span><span class="s2">"a connection to the flask client"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">setup_client</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
     <span class="c1"># this is a no-op since I made a fixture to build the client instead</span>
     <span class="k">return</span>


 <span class="nd">@when</span><span class="p">(</span><span class="s2">"the root page is retrieved"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">get_root_page</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
     <span class="n">katamari</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">))</span>
     <span class="k">return</span>

 <span class="nd">@then</span><span class="p">(</span><span class="s2">"it has the expected text"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_root_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
         <span class="n">contain</span><span class="p">(</span><span class="sa">b</span><span class="s2">"This is the Neural Network Visualizer"</span><span class="p">))</span>
     <span class="k">return</span>

 <span class="c1"># ***** get predictions ***** #</span>
 <span class="c1"># *** Call the function *** #</span>
 <span class="c1"># Scenario: A prediction is retrieved</span>

 <span class="nd">@given</span><span class="p">(</span><span class="s2">"the get_prediction function"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_get_prediction</span><span class="p">():</span>
     <span class="sd">"""Another no-op"""</span>
     <span class="k">return</span>

 <span class="nd">@when</span><span class="p">(</span><span class="s2">"a prediction is retrieved"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">call_get_prediction</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
     <span class="n">choice_mock</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
     <span class="n">katamari</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">6</span>
     <span class="n">choice_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">index</span>
     <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">"ml_server.numpy.random.choice"</span><span class="p">,</span> <span class="n">choice_mock</span><span class="p">)</span>
     <span class="n">katamari</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">get_prediction</span><span class="p">()</span>
     <span class="k">return</span>


 <span class="nd">@then</span><span class="p">(</span><span class="s2">"it has the correct tuple"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_predictions</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mnist</span><span class="p">):</span>
     <span class="c1"># Our model emits a list with one array for each layer of the model</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

     <span class="c1"># the last layer is the prediction layer</span>
     <span class="n">predictions</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

     <span class="n">predicted</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">y_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>

     <span class="c1"># now check the image</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">x_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="c1"># expect(katamari.output[1].shape).to(equal((28, 28)))</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
     <span class="k">return</span>

 <span class="c1"># *** API Call *** #</span>
 <span class="c1">#Scenario: the API end-point is retrieved</span>
 <span class="c1">#  Given a connection to the flask client</span>


 <span class="nd">@when</span><span class="p">(</span><span class="s2">"the API end-point is retrieved"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">get_predictions</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
     <span class="c1"># set up the mock so we can control which of the images it tries to predict</span>
     <span class="n">choice_mock</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>

     <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">"ml_server.numpy.random.choice"</span><span class="p">,</span> <span class="n">choice_mock</span><span class="p">)</span>

     <span class="n">katamari</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
     <span class="n">choice_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">index</span>

     <span class="n">katamari</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">api</span><span class="p">)</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">))</span>
     <span class="k">return</span>


 <span class="nd">@then</span><span class="p">(</span><span class="s2">"the response has the expected JSON"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_response</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mnist</span><span class="p">):</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_json</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
     <span class="n">data</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">json</span>
     <span class="n">layers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"prediction"</span><span class="p">]</span>

     <span class="c1"># the prediction should be the three outputs of our model</span>
     <span class="c1"># except with lists instead of numpy arrays</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
     <span class="n">prediction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

     <span class="c1"># now check that it made the expected prediction</span>
     <span class="n">predicted</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">y_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>

     <span class="c1"># and that it gave us the right image</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">x_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">"image"</span><span class="p">]),</span> <span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
     <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><a id="orgf0ea8d1"></a>The Implementation<br>
<div class="outline-text-6" id="text-orgf0ea8d1">
<p>This is where we tangle out a file to run a flask server that will serve up our model's predictions.</p>
<div class="highlight">
<pre><span></span> <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="n">app</span><span class="o">&gt;&gt;</span>


 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">model</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">feature</span><span class="o">-</span><span class="n">model</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">data</span><span class="o">&gt;&gt;</span>


 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">get</span><span class="o">-</span><span class="n">prediction</span><span class="o">&gt;&gt;</span>


 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">index</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">api</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">main</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>First up is our imports. Other than Flask there really isn't anything new here.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
 <span class="kn">import</span> <span class="nn">json</span>
 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">import</span> <span class="nn">random</span>
 <span class="kn">import</span> <span class="nn">string</span>

 <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

 <span class="c1"># pypi</span>
 <span class="kn">import</span> <span class="nn">numpy</span>
 <span class="kn">import</span> <span class="nn">tensorflow</span>

 <span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
 <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
</pre></div>
<p>Now we create the flask app and something to hold the paths.</p>
<div class="highlight">
<pre><span></span> <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

 <span class="n">PATHS</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
     <span class="n">root</span> <span class="o">=</span> <span class="s2">"/"</span><span class="p">,</span>
     <span class="n">api</span> <span class="o">=</span> <span class="s2">"/api"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
<p>Next we'll load the saved model. I'm going to break this up a little bit just because I wasn't clear about what was going on originally.</p>
<div class="highlight">
<pre><span></span> <span class="n">load_dotenv</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

 <span class="n">base</span> <span class="o">=</span> <span class="s2">"flask_tensorflow_mnist"</span>
 <span class="n">MODELS</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">base</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
 <span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_model"</span><span class="p">]</span>
 <span class="k">assert</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
 <span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="n">MODELS</span><span class="o">/</span><span class="n">MODEL_NAME</span>
 <span class="k">assert</span> <span class="n">MODEL_PATH</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>

 <span class="n">model</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">)</span>
</pre></div>
<p>At this point we should have a re-loaded version of our trained model (minus some information as noted above because it was saved using the <code>H5</code> format). Our model has one output layer - the softmax prediction layer - which gives the probabilities that an input image is one of the ten digits, but since we want to see what each layer is doing, we'll create a new model with the output from each layer added to the outputs - so since we have three layers in the model we'll now have three outputs.</p>
<div class="highlight">
<pre><span></span> <span class="n">feature_model</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
     <span class="n">inputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
     <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">output</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">])</span>
</pre></div>
<p>Next let's load and normalize the data. We don't use the training data or the labels here.</p>
<div class="highlight">
<pre><span></span> <span class="n">MAX_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>

 <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
 <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">/</span><span class="n">MAX_BRIGHTNESS</span>
</pre></div>
<p>Now we create the function to get the prediction for an image. It also returns the image so that we can see what it was.</p>
<div class="highlight">
<pre><span></span> <span class="n">ROWS</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">,</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span>
 <span class="n">PIXELS</span> <span class="o">=</span> <span class="n">HEIGHT</span> <span class="o">*</span> <span class="n">WIDTH</span>

 <span class="k">def</span> <span class="nf">get_prediction</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
     <span class="sd">"""Gets a random image and prediction</span>

<span class="sd">     The 'prediction' isn't so much the value (e.g. it's a 5) but rather the</span>
<span class="sd">     outputs of each layer so that they can be visualised. So the first value</span>
<span class="sd">     of the tuple will be a list of arrays whose length will be the number of </span>
<span class="sd">     layers in the model. Each array will be the outputs for that layer.</span>

<span class="sd">     This always pulls the image from =x_test=.</span>

<span class="sd">     Returns:</span>
<span class="sd">      What our model predicts for a random image and the image</span>
<span class="sd">     """</span>
     <span class="n">index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ROWS</span><span class="p">)</span>
     <span class="n">image</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[</span><span class="n">index</span><span class="p">,:,:]</span>
     <span class="n">image_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">PIXELS</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">feature_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image_array</span><span class="p">),</span> <span class="n">image</span>
</pre></div>
<p>Next we create the handler for the REST calls. If you make a GET request from the root you'll get an HTML page back.</p>
<div class="highlight">
<pre><span></span> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
 <span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
     <span class="sd">"""The home page view"""</span>
     <span class="k">return</span> <span class="s2">"This is the Neural Network Visualizer (use /api for the API)"</span>
</pre></div>
<p>If you return a dict flask will automatically identify it as JSON.</p>
<div class="highlight">
<pre><span></span> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">api</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"GET"</span><span class="p">])</span>
 <span class="k">def</span> <span class="nf">api</span><span class="p">():</span>
     <span class="sd">"""the JSON view</span>

<span class="sd">     Returns:</span>
<span class="sd">       JSON with prediction layers and image</span>
<span class="sd">     """</span>
     <span class="n">predictions</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">get_prediction</span><span class="p">()</span>

     <span class="c1"># JSON needs lists, not numpy arrays</span>
     <span class="n">final_predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">prediction</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">]</span>
     <span class="k">return</span> <span class="p">{</span><span class="s2">"prediction"</span><span class="p">:</span> <span class="n">final_predictions</span><span class="p">,</span>
             <span class="s1">'image'</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
</pre></div>
<p>And now we make the "main" entry point.</p>
<div class="highlight">
<pre><span></span> <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
     <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
<p>To run this you would enter the same directory as the <code>ml_server.py</code> file and execute:</p>
<div class="highlight">
<pre><span></span> python ml_server.py
</pre></div>
<p>Or better, use the <a href="https://flask.palletsprojects.com/en/1.1.x/server/">development server</a>.</p>
<div class="highlight">
<pre><span></span>set -X FLASK_APP ml_server
set -X FLASK_ENV development

flask run
</pre></div>
<p>This will automatically re-load if you make changes to the code. The first two lines in the code block above tell flask which one of the modules has the flask-app and also that it should run in development mode. I'm using the <a href="https://fishshell.com/">Fish Shell</a>, so if you are using bash or a similar shell instead the lines would be this instead.</p>
<div class="highlight">
<pre><span></span>export FLASK_APP=ml_server
export FLASK_ENV=development

flask run
</pre></div>
</div>
</li>
</ul>
</li>
<li><a id="orgf2b9652"></a>Front-End<br>
<ul class="org-ul">
<li><a id="org379f01f"></a>Tests<br>
<div class="outline-text-6" id="text-org379f01f">
<div class="highlight">
<pre><span></span>&lt;&lt;front-end-feature-title&gt;&gt;

&lt;&lt;front-end-click&gt;&gt;
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">browser</span><span class="p">():</span>
    <span class="sd">"""Creates the selenium webdriver session"""</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">browser</span>
    <span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>


<span class="n">CSSSelectors</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">main_title</span> <span class="o">=</span> <span class="s2">".main h1"</span><span class="p">,</span>
    <span class="n">main_button</span> <span class="o">=</span> <span class="s2">".main button"</span><span class="p">,</span>
    <span class="n">sidebar_title</span> <span class="o">=</span> <span class="s2">".sidebar h1"</span><span class="p">,</span>
    <span class="n">sidebar_image</span> <span class="o">=</span> <span class="s2">".sidebar-content img"</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">HomePage</span><span class="p">:</span>
    <span class="sd">"""A page-class for testing</span>

<span class="sd">    Args:</span>
<span class="sd">     address: the address of the streamlit server</span>
<span class="sd">     wait: seconds to implicitly wait for page-objects</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"http://localhost:8501"</span><span class="p">,</span>
                 <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">wait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">browser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">:</span>
        <span class="sd">"""The browser opened to the home page"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">main_title</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""The object with the main title"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
                <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">main_title</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">main_button</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""The man button"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
                <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">main_button</span>
            <span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sidebar_title</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""The sidebar title element"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
                <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">sidebar_title</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sidebar_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""This tries to get the sidebar image element</span>
<span class="sd">       """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
            <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">sidebar_image</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Finalizer that closes the browser"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">home_page</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">HomePage</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span> <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">front</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">front</span><span class="o">-</span><span class="n">text</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">front</span><span class="o">-</span><span class="n">click</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
</li>
<li><a id="org4d3a643"></a>The Features<br>
<div class="outline-text-6" id="text-org4d3a643">
<p>We can start with the imports and basic set up.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># pypi</span>
 <span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">be_true</span><span class="p">,</span>
     <span class="n">equal</span><span class="p">,</span>
     <span class="n">expect</span>
 <span class="p">)</span>

 <span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">given</span><span class="p">,</span>
     <span class="n">scenarios</span><span class="p">,</span>
     <span class="n">then</span><span class="p">,</span>
     <span class="n">when</span><span class="p">,</span>
 <span class="p">)</span>

 <span class="c1"># fixtures</span>
 <span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span>

 <span class="kn">from</span> <span class="nn">front_end_fixtures</span> <span class="kn">import</span> <span class="n">home_page</span>

 <span class="n">and_also</span> <span class="o">=</span> <span class="n">then</span>
 <span class="n">scenarios</span><span class="p">(</span><span class="s2">"front_end.feature"</span><span class="p">)</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgcc136b2"></a>The Initial Text<br>
<div class="outline-text-7" id="text-orgcc136b2">
<div class="highlight">
<pre><span></span> Feature: The GUI web page to view the model

 Scenario: The user goes to the home page and checks it out
   Given a browser on the home page
   When the user checks out the titles and button
   Then they have the expected text
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># ***** The Text ***** #</span>
<span class="c1"># Scenario: The user goes to the home page and checks it out</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a browser on the home page"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_browser</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">home_page</span><span class="p">):</span>
    <span class="c1"># katamari.home_page = home_page</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks out the titles and button"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">home_page</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">main_title</span> <span class="o">=</span> <span class="n">home_page</span><span class="o">.</span><span class="n">main_title</span><span class="o">.</span><span class="n">text</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">button_text</span> <span class="o">=</span> <span class="n">home_page</span><span class="o">.</span><span class="n">main_button</span><span class="o">.</span><span class="n">text</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">sidebar_title</span> <span class="o">=</span> <span class="n">home_page</span><span class="o">.</span><span class="n">sidebar_title</span><span class="o">.</span><span class="n">text</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"they have the expected text"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">main_title</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="s2">"Neural Network Visualizer"</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">button_text</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="s2">"Get Random Prediction"</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">sidebar_title</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="s2">"Input Image"</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="orgb48ff3b"></a>Click the Button<br>
<div class="outline-text-7" id="text-orgb48ff3b">
<div class="highlight">
<pre><span></span>Scenario: The user gets a random prediction
  Given a browser on the home page
  When the user clicks on the button
  Then the sidebar displays the input image
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># ***** The button click ****** #</span>
<span class="c1"># Scenario: The user gets a random prediction</span>
<span class="c1">#  Given a browser on the home page</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user clicks on the button"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">click_get_image_button</span><span class="p">(</span><span class="n">home_page</span><span class="p">):</span>
    <span class="n">home_page</span><span class="o">.</span><span class="n">main_button</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"the sidebar displays the input image"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_sidebar_sections</span><span class="p">(</span><span class="n">home_page</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">home_page</span><span class="o">.</span><span class="n">sidebar_image</span><span class="o">.</span><span class="n">is_displayed</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><a id="org63935f8"></a>Streamlit<br>
<div class="outline-text-6" id="text-org63935f8">
<p>For the front-end we'll use Streamlit, a python library to make creating web-pages for certain types of applications more easily (I think, I'll need to check it out more later).</p>
<div class="highlight">
<pre><span></span> <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">url</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">title</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">sidebar</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">control</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>First the imports.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">import</span> <span class="nn">json</span>
 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

 <span class="c1"># pypi</span>
 <span class="kn">import</span> <span class="nn">requests</span>
 <span class="kn">import</span> <span class="nn">numpy</span>
 <span class="kn">import</span> <span class="nn">streamlit</span>
 <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>

 <span class="c1"># this code</span>
 <span class="kn">from</span> <span class="nn">ml_server</span> <span class="kn">import</span> <span class="n">PATHS</span>
</pre></div>
<p>Now we'll setup the URL for our flask backend - as you can see we're expecting to run this on the <code>localhost</code> address, you'd have to change this for make it available outside the host PC.</p>
<div class="highlight">
<pre><span></span> <span class="n">URI</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="s2">"http://127.0.0.1:5000/"</span><span class="p">,</span> <span class="n">PATHS</span><span class="o">.</span><span class="n">api</span><span class="p">)</span>
</pre></div>
<p>Next we'll set the title for the page - this can be a little confusing, although it's called the title, it isn't the HTML title but rather the main heading for the page.</p>
<div class="highlight">
<pre><span></span> <span class="n">streamlit</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Neural Network Visualizer'</span><span class="p">)</span>
</pre></div>
<p>Now we'll add a collapsible sidebar where we'll eventually put our image output and add a headline for it (<code>Input Image</code>).</p>
<div class="highlight">
<pre><span></span> <span class="n">streamlit</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s1">'# Input Image'</span><span class="p">)</span>
</pre></div>
<p>Now we'll add some logic. I think this would be the <code>control</code> portion of a more traditional web-server. It's basically where we react to a button press by getting a random image and visualizing how it makes a prediction.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># create a button and wait for someone to press it</span>
 <span class="k">if</span> <span class="n">streamlit</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">"Get Random Prediction"</span><span class="p">):</span>
     <span class="c1"># Someone pressed the button, make an API call to our flask server</span>
     <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URI</span><span class="p">)</span>

     <span class="c1"># convert the response to a dict</span>
     <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

     <span class="c1"># get the prediction array</span>
     <span class="n">predictions</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'prediction'</span><span class="p">)</span>

     <span class="c1"># get the image we were making the prediction for</span>
     <span class="n">image</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'image'</span><span class="p">)</span>

     <span class="c1"># the image </span>
     <span class="c1"># streamlit expects a numpy array or string-like object, not lists</span>
     <span class="n">image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

     <span class="c1"># show the image in the sidebar</span>
     <span class="n">streamlit</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

     <span class="c1"># iterate over the prediction for each layer in the model</span>
     <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
         <span class="c1"># convert the prediction list to an array</span>
         <span class="c1"># and flatten it to a vector</span>
         <span class="n">numbers</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>
         <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
         <span class="n">rows</span> <span class="o">=</span> <span class="mi">1</span>
         <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
             <span class="c1"># this is the output layer so we only want one row</span>
             <span class="c1"># and we want 10 columns (one for each digit)</span>
             <span class="n">columns</span> <span class="o">=</span> <span class="mi">10</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="c1"># this is the input or hidden layer</span>
             <span class="c1"># since our model had 32 hidden nodes it has 32 columns</span>
             <span class="c1"># the original version had 2 rows and 16 columns, but</span>
             <span class="c1"># while that looked nicer, I think it makes more sense for </span>
             <span class="c1"># there to be one layer</span>
             <span class="n">columns</span> <span class="o">=</span> <span class="mi">32</span>
         <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
             <span class="c1"># add a subplot to the figure</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">number</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
                           <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float32'</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'binary'</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
             <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                 <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
         <span class="n">streamlit</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s1">'Layer </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
         <span class="n">streamlit</span><span class="o">.</span><span class="n">pyplot</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgdf52e38">
<h2 id="orgdf52e38">End</h2>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/flask/" rel="tag">flask</a></li>
<li><a class="tag p-category" href="../../../categories/mnist/" rel="tag">mnist</a></li>
<li><a class="tag p-category" href="../../../categories/tensorflow/" rel="tag">tensorflow</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../../fastai/hand-rolling-a-countvectorizer/" rel="prev" title="Hand-rolling a CountVectorizer">Previous post</a></li>
<li class="next"><a href="../../nlp/01-twitter-preprocessing-with-nltk/" rel="next" title="Twitter Preprocessing With NLTK">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
