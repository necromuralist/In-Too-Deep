<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Preprocessing twitter tweets with NLTK." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Twitter Preprocessing With NLTK | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/twitter-preprocessing-with-nltk/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>
<script async src="../../../assets/javascript/bokeh-1.3.4.min.js" type="text/javascript"></script>
<meta content="Cloistered Monkey" name="author">
<link href="/posts/keras/flask-tensorflow-and-mnist/" rel="prev" title="Flask, TensorFlow, Streamlit and the MNIST Dataset" type="text/html">
<link href="/posts/nlp/twitter-word-frequencies/" rel="next" title="Twitter Word Frequencies" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Twitter Preprocessing With NLTK" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/twitter-preprocessing-with-nltk/" property="og:url">
<meta content="Preprocessing twitter tweets with NLTK." property="og:description">
<meta content="article" property="og:type">
<meta content="2020-07-03T21:23:48-07:00" property="article:published_time">
<meta content="nlp" property="article:tag">
<meta content="nltk" property="article:tag">
<meta content="preprocessing" property="article:tag">
<meta content="twitter" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/Neurotic-Networking/"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="/posts/nlp/twitter-preprocessing-with-nltk/index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href="/posts/nlp/twitter-preprocessing-with-nltk/">Twitter Preprocessing With NLTK</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/nlp/twitter-preprocessing-with-nltk/" rel="bookmark"><time class="published dt-published" datetime="2020-07-03T21:23:48-07:00" itemprop="datePublished" title="2020-07-03 21:23">2020-07-03 21:23</time></a></p>
<p class="sourceline"><a class="sourcelink" href="/posts/nlp/twitter-preprocessing-with-nltk/index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/nlp/twitter-preprocessing-with-nltk/#org33309ff">Beginning</a>
<ul>
<li><a href="/posts/nlp/twitter-preprocessing-with-nltk/#orgb51b3ae">Set Up</a></li>
</ul>
</li>
<li><a href="/posts/nlp/twitter-preprocessing-with-nltk/#orgd5acccb">Middle</a>
<ul>
<li><a href="/posts/nlp/twitter-preprocessing-with-nltk/#orga2d5f9f">Explore the Data</a></li>
<li><a href="/posts/nlp/twitter-preprocessing-with-nltk/#org54f8a0c">Processing the Data</a></li>
</ul>
</li>
<li><a href="/posts/nlp/twitter-preprocessing-with-nltk/#org0630e7a">End</a>
<ul>
<li><a href="/posts/nlp/twitter-preprocessing-with-nltk/#orgdd41b33">Tests</a></li>
<li><a href="/posts/nlp/twitter-preprocessing-with-nltk/#org404a3b4">Implementation</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org33309ff">
<h2 id="org33309ff">Beginning</h2>
<div class="outline-text-2" id="text-org33309ff">
<p>This is a look at taking a corpus of <a href="https://twitter.com/explore">Twitter</a> data gathered as part of the <a href="https://www.nltk.org/">Natural Language Toolkit (NLTK)</a> and creating a preprocessor for a <a href="https://www.wikiwand.com/en/Sentiment_analysis">Sentiment Analysis</a> pipeline. This dataset has entries whose sentiment was categorized by hand so it's a convenient source for training models.</p>
<p>The <a href="https://www.nltk.org/howto/corpus.html">NLTK Corpus How To</a> has a brief description of the Twitter dataset and they also have <a href="https://www.nltk.org/howto/twitter.html">some documentation</a> about how to gather new data using the Twitter API yourself.</p>
</div>
<div class="outline-3" id="outline-container-orgb51b3ae">
<h3 id="orgb51b3ae">Set Up</h3>
<div class="outline-text-3" id="text-orgb51b3ae"></div>
<div class="outline-4" id="outline-container-org13158ee">
<h4 id="org13158ee">Imports</h4>
<div class="outline-text-4" id="text-org13158ee">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>
<span class="kn">from</span> <span class="nn">nltk.stem</span> <span class="kn">import</span> <span class="n">PorterStemmer</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">TweetTokenizer</span>

<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">CountPercentage</span><span class="p">,</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org047e733">
<h4 id="org047e733">Data</h4>
<div class="outline-text-4" id="text-org047e733">
<p>The first thing to do is download the dataset using the <a href="https://www.nltk.org/data.html">download</a> function. If you don't pass an argument to it a dialog will open and you can choose to download any or all of their datasets, but for this exercise we'll just download the Twitter samples. Note that if you run this function and the samples were already downloaded then it won't re-download them so it's safe to call it in any case.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'twitter_samples'</span><span class="p">)</span>
</pre></div>
<p>The data is contained in three files. You can see the file names using the <code>twitter_samples.fileids</code> function.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">fileids</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
- negative_tweets.json
- positive_tweets.json
- tweets.20150430-223406.json
</pre>
<p>As you can see (or maybe guess) two of the files contain tweets that have been categorized as negative or positive. The third file has another 20,000 tweets that aren't classified.</p>
<p>If you want to work with the files directly without using the NLTK interface (or move or delete them) you can use the <code>twitter_samples.abspaths</code> function to see where they are.</p>
<div class="highlight">
<pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">twitter_samples</span><span class="o">.</span><span class="n">abspaths</span><span class="p">())</span>
</pre></div>
<pre class="example">
[FileSystemPathPointer('/home/athena/nltk_data/corpora/twitter_samples/negative_tweets.json'),
 FileSystemPathPointer('/home/athena/nltk_data/corpora/twitter_samples/positive_tweets.json'),
 FileSystemPathPointer('/home/athena/nltk_data/corpora/twitter_samples/tweets.20150430-223406.json')]
</pre>
<p>The dataset contains the JSON for each tweet, including some metadata, which you can access through the <code>twitter_samples.docs</code> function. Here's a sample.</p>
<div class="highlight">
<pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">twitter_samples</span><span class="o">.</span><span class="n">docs</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
{'contributors': None,
 'coordinates': None,
 'created_at': 'Fri Jul 24 10:42:49 +0000 2015',
 'entities': {'hashtags': [], 'symbols': [], 'urls': [], 'user_mentions': []},
 'favorite_count': 0,
 'favorited': False,
 'geo': None,
 'id': 624530164626534400,
 'id_str': '624530164626534400',
 'in_reply_to_screen_name': None,
 'in_reply_to_status_id': None,
 'in_reply_to_status_id_str': None,
 'in_reply_to_user_id': None,
 'in_reply_to_user_id_str': None,
 'is_quote_status': False,
 'lang': 'en',
 'metadata': {'iso_language_code': 'en', 'result_type': 'recent'},
 'place': None,
 'retweet_count': 0,
 'retweeted': False,
 'source': '&lt;a href="https://mobile.twitter.com" rel="nofollow"&gt;Mobile Web '
           '(M2)&lt;/a&gt;',
 'text': 'hopeless for tmr :(',
 'truncated': False,
 'user': {'contributors_enabled': False,
          'created_at': 'Sun Mar 08 05:43:40 +0000 2015',
          'default_profile': False,
          'default_profile_image': False,
          'description': '⇨ [V] TravelGency █ 2/4 Goddest from Girls Day █ 92L '
                         '█ sucrp',
          'entities': {'description': {'urls': []}},
          'favourites_count': 196,
          'follow_request_sent': False,
          'followers_count': 1281,
          'following': False,
          'friends_count': 1264,
          'geo_enabled': True,
          'has_extended_profile': False,
          'id': 3078803375,
          'id_str': '3078803375',
          'is_translation_enabled': False,
          'is_translator': False,
          'lang': 'id',
          'listed_count': 3,
          'location': 'wearegsd;favor;pucukfams;barbx',
          'name': 'yuwra ✈ ',
          'notifications': False,
          'profile_background_color': '000000',
          'profile_background_image_url': 'http://pbs.twimg.com/profile_background_images/585476378365014016/j1mvQu3c.png',
          'profile_background_image_url_https': 'https://pbs.twimg.com/profile_background_images/585476378365014016/j1mvQu3c.png',
          'profile_background_tile': True,
          'profile_banner_url': 'https://pbs.twimg.com/profile_banners/3078803375/1433287528',
          'profile_image_url': 'http://pbs.twimg.com/profile_images/622631732399898624/kmYsX_k1_normal.jpg',
          'profile_image_url_https': 'https://pbs.twimg.com/profile_images/622631732399898624/kmYsX_k1_normal.jpg',
          'profile_link_color': '000000',
          'profile_sidebar_border_color': '000000',
          'profile_sidebar_fill_color': '000000',
          'profile_text_color': '000000',
          'profile_use_background_image': True,
          'protected': False,
          'screen_name': 'yuwraxkim',
          'statuses_count': 19710,
          'time_zone': 'Jakarta',
          'url': None,
          'utc_offset': 25200,
          'verified': False}}
</pre>
<p>There's some potentially useful data here - like if the tweet was re-tweeted, but for what we're doing we'll just use the tweet itself.</p>
<p>To get just the text of the tweets you use the <code>twitter_samples.strings</code> function.</p>
<div class="highlight">
<pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">)</span>
</pre></div>
<pre class="example">
Help on method strings in module nltk.corpus.reader.twitter:

strings(fileids=None) method of nltk.corpus.reader.twitter.TwitterCorpusReader instance
    Returns only the text content of Tweets in the file(s)
    
    :return: the given file(s) as a list of Tweets.
    :rtype: list(str)

</pre>
<p>Note that it says that it returns only the given file(s) as a list of tweets but it also makes the <code>fileids</code> argument optional. If you don't pass in any argument you end up with the tweets from all the files in the same list, which you probably don't want.</p>
<div class="highlight">
<pre><span></span><span class="n">positive_tweets</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s1">'positive_tweets.json'</span><span class="p">)</span>
<span class="n">negative_tweets</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s1">'negative_tweets.json'</span><span class="p">)</span>
<span class="n">all_tweets</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s2">"tweets.20150430-223406.json"</span><span class="p">)</span>
</pre></div>
<p>Now I'll download the stopwords for our pre-processing and setup the english stopwords for use later.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'stopwords'</span><span class="p">)</span>
<span class="n">english_stopwords</span> <span class="o">=</span> <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s2">"english"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3a7d16f">
<h4 id="org3a7d16f">The Random Seed</h4>
<div class="outline-text-4" id="text-org3a7d16f">
<p>This just sets the random seed so that we get the same values if we re-run this later on (although this is a little tricky with the notebook, since you can call the same code multiple times).</p>
<div class="highlight">
<pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">20200704</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf503998">
<h4 id="orgf503998">Plotting</h4>
<div class="outline-text-4" id="text-orgf503998">
<p>I won't be doing a lot of plotting here, but this is a setup for the little that I do.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"twitter-preprocessing-with-nltk"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"../../files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                <span class="n">create_folder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgd5acccb">
<h2 id="orgd5acccb">Middle</h2>
<div class="outline-text-2" id="text-orgd5acccb">
<p>It can be more convenient to use a <a href="https://pandas.pydata.org/pandas-docs/stable/reference/series.html">Pandas Series</a> for some checks of the tweets so I'll convert the all-tweets list to one.</p>
<div class="highlight">
<pre><span></span><span class="n">all_tweets</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">all_tweets</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orga2d5f9f">
<h3 id="orga2d5f9f">Explore the Data</h3>
<div class="outline-text-3" id="text-orga2d5f9f">
<p>Let's start by looking at the number of tweets we got and confirming that the <code>strings</code> function gave us back a list of strings like the docstring said it would.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_tweets</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Number of positive tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">positive_tweets</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Number of negative tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">negative_tweets</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="p">(</span><span class="n">positive_tweets</span><span class="p">,</span> <span class="n">negative_tweets</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">thing</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">str</span>
</pre></div>
<pre class="example">
Number of tweets: 20,000
Number of positive tweets: 5,000
Number of negative tweets: 5,000
</pre>
<p>We can see that the data for each file is made up of strings stored in a list and there were 20,000 tweets in total but only half as much were categorized.</p>
</div>
<div class="outline-4" id="outline-container-org0494f7e">
<h4 id="org0494f7e">Looking At Some Examples</h4>
<div class="outline-text-4" id="text-org0494f7e">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Random Positive Tweet: </span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">positive_tweets</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Random Negative Tweet: </span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">negative_tweets</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Random Positive Tweet: @Aaliyan_ Lucky me :))
Random Negative Tweet: @NotRedbutBlue awww :(
at least u never got called luis manzano tho
</pre>
<p>Sometimes the tweets look more like text message replies than micro-blog posts. One thing the original exercise noted is that there are <a href="https://www.wikiwand.com/en/Emoji">Emoticons</a> in the dataset that need to be handled.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org82f877c">
<h4 id="org82f877c">The First Token</h4>
<div class="outline-text-4" id="text-org82f877c">
<p>Later on we're going to remove the "RT" (re-tweet) token at the start of the strings. Let's look at how significant this is.</p>
<div class="highlight">
<pre><span></span><span class="n">first_tokens</span> <span class="o">=</span> <span class="n">tweets</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">top_ten</span> <span class="o">=</span> <span class="n">CountPercentage</span><span class="p">(</span><span class="n">first_tokens</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">value_label</span><span class="o">=</span><span class="s2">"First Token"</span><span class="p">)</span>
<span class="n">top_ten</span><span class="p">()</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">First Token</th>
<th class="org-right" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">RT</td>
<td class="org-right">13287</td>
<td class="org-right">92.92</td>
</tr>
<tr>
<td class="org-left">I</td>
<td class="org-right">160</td>
<td class="org-right">1.12</td>
</tr>
<tr>
<td class="org-left">Farage</td>
<td class="org-right">141</td>
<td class="org-right">0.99</td>
</tr>
<tr>
<td class="org-left">The</td>
<td class="org-right">134</td>
<td class="org-right">0.94</td>
</tr>
<tr>
<td class="org-left">VIDEO:</td>
<td class="org-right">132</td>
<td class="org-right">0.92</td>
</tr>
<tr>
<td class="org-left">Nigel</td>
<td class="org-right">117</td>
<td class="org-right">0.82</td>
</tr>
<tr>
<td class="org-left">Ed</td>
<td class="org-right">116</td>
<td class="org-right">0.81</td>
</tr>
<tr>
<td class="org-left">Miliband</td>
<td class="org-right">77</td>
<td class="org-right">0.54</td>
</tr>
<tr>
<td class="org-left">SNP</td>
<td class="org-right">69</td>
<td class="org-right">0.48</td>
</tr>
<tr>
<td class="org-left">@UKIP</td>
<td class="org-right">67</td>
<td class="org-right">0.47</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">top_ten</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">"Percent (%)"</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">"First Token"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Top Ten Tweet First Tokens"</span><span class="p">,</span> 
    <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"top_ten"</span><span class="p">,</span> <span class="n">create_folder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">())</span>
</pre></div>
<object data="/posts/nlp/twitter-preprocessing-with-nltk/top_ten.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So, about 93 % of the unclassified tweets start with <code>RT</code>, making it perhaps not so informative a token. Or maybe it is… what does a re-tweet tell us? Let's look at if the re-tweeted show up as duplicates and if so, how many times they show up.</p>
<div class="highlight">
<pre><span></span><span class="n">retweeted</span> <span class="o">=</span> <span class="n">tweets</span><span class="p">[</span><span class="n">tweets</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"RT"</span><span class="p">)]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">retweeted</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<ul class="org-ul">
<li>491</li>
<li>430</li>
<li>131</li>
<li>131</li>
<li>117</li>
<li>103</li>
<li>82</li>
<li>73</li>
<li>69</li>
<li>68</li>
</ul>
<p>Some of the entries are the same tweet repeated hundreds of times. Does each one count as an additional entry? I don't show it here because the tweets are kind of long, but the top five are all about British politics, so there might have been some kind of bias in the way the tweets were gathered.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org54f8a0c">
<h3 id="org54f8a0c">Processing the Data</h3>
<div class="outline-text-3" id="text-org54f8a0c">
<p>There are four basic steps for NLP pre-processing:</p>
<ul class="org-ul">
<li><a href="https://nlp.stanford.edu/IR-book/html/htmledition/tokenization-1.html">Tokenization</a></li>
<li>Lower-casing</li>
<li>Removing <a href="https://www.wikiwand.com/en/Stop_words">stop words</a> and punctuation</li>
<li><a href="https://www.wikiwand.com/en/Stemming">Stemming</a></li>
</ul>
<p>We're going to start by taking one tweet and seeing how it is transformed by this process.</p>
<div class="highlight">
<pre><span></span><span class="n">THE_CHOSEN</span> <span class="o">=</span> <span class="n">positive_tweets</span><span class="p">[</span><span class="mi">2277</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">THE_CHOSEN</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) #sunflowers #favourites #happy #Friday off… https://t.co/3tfYom0N1i
</pre></div>
<div class="outline-4" id="outline-container-org6a4f3ac">
<h4 id="org6a4f3ac">Cleaning Up Twitter-Specific Markup</h4>
<div class="outline-text-4" id="text-org6a4f3ac">
<p>Although I listed four steps in the beginning, there's often another step where we remove things that are common or not useful but known in advance. In this case we want to remove re-tweet tags (<code>RT</code>), hyperlinks, and hashtags. We're going to do that with python's built in <a href="https://docs.python.org/3/library/re.html">regular expression</a> module. We're also going to do it one tweet at a time, although you could perhapse more efficiently do it in bulk using pandas.</p>
<div class="highlight">
<pre><span></span><span class="n">START_OF_LINE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"^"</span>
<span class="n">OPTIONAL</span> <span class="o">=</span> <span class="s2">"?"</span>
<span class="n">ANYTHING</span> <span class="o">=</span> <span class="s2">"."</span>
<span class="n">ZERO_OR_MORE</span> <span class="o">=</span> <span class="s2">"*"</span>
<span class="n">ONE_OR_MORE</span> <span class="o">=</span> <span class="s2">"+"</span>

<span class="n">SPACE</span> <span class="o">=</span> <span class="s2">"\s"</span>
<span class="n">SPACES</span> <span class="o">=</span> <span class="n">SPACE</span> <span class="o">+</span> <span class="n">ONE_OR_MORE</span>
<span class="n">EVERYTHING_OR_NOTHING</span> <span class="o">=</span> <span class="n">ANYTHING</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span>

<span class="n">ERASE</span> <span class="o">=</span> <span class="s2">""</span>
<span class="n">FORWARD_SLASH</span> <span class="o">=</span> <span class="s2">"\/"</span>
<span class="n">NEWLINES</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"[\r\n]"</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgd478144"></a>Re-Tweets<br>
<div class="outline-text-5" id="text-orgd478144">
<p>None of the positive or negative samples have this tag so I'm going to pull an example from the complete set just to show it working.</p>
<div class="highlight">
<pre><span></span><span class="n">RE_TWEET</span> <span class="o">=</span> <span class="n">START_OF_LINE</span> <span class="o">+</span> <span class="s2">"RT"</span> <span class="o">+</span> <span class="n">SPACES</span>

<span class="n">tweet</span> <span class="o">=</span> <span class="n">all_tweets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
<span class="n">tweet</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">RE_TWEET</span><span class="p">,</span> <span class="n">ERASE</span><span class="p">,</span> <span class="n">tweet</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
</pre></div>
<pre class="example">
RT @KirkKus: Indirect cost of the UK being in the EU is estimated to be costing Britain £170 billion per year! #BetterOffOut #UKIP
@KirkKus: Indirect cost of the UK being in the EU is estimated to be costing Britain £170 billion per year! #BetterOffOut #UKIP
</pre></div>
</li>
<li><a id="orgd18a349"></a>Hyperlinks<br>
<div class="outline-text-5" id="text-orgd18a349">
<div class="highlight">
<pre><span></span><span class="n">HYPERLINKS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"http"</span> <span class="o">+</span> <span class="s2">"s"</span> <span class="o">+</span> <span class="n">OPTIONAL</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="n">FORWARD_SLASH</span> <span class="o">+</span> <span class="n">FORWARD_SLASH</span>
              <span class="o">+</span> <span class="n">EVERYTHING_OR_NOTHING</span> <span class="o">+</span> <span class="n">NEWLINES</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">THE_CHOSEN</span><span class="p">)</span>
<span class="n">re_chosen</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">HYPERLINKS</span><span class="p">,</span> <span class="n">ERASE</span><span class="p">,</span> <span class="n">THE_CHOSEN</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) #sunflowers #favourites #happy #Friday off… https://t.co/3tfYom0N1i
My beautiful sunflowers on a sunny Friday morning off :) #sunflowers #favourites #happy #Friday off… 
</pre>
<p>Note that the way the regular expression is written, it eats everything after the <code>http</code>.</p>
</div>
</li>
<li><a id="org591fd52"></a>HashTags<br>
<div class="outline-text-5" id="text-org591fd52">
<p>We aren't removing the actual hash-tags, just the hash-marks (<code>#</code>).</p>
<div class="highlight">
<pre><span></span><span class="n">HASH</span> <span class="o">=</span> <span class="s2">"#"</span>
<span class="n">re_chosen</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">HASH</span><span class="p">,</span> <span class="n">ERASE</span><span class="p">,</span> <span class="n">re_chosen</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) sunflowers favourites happy Friday off… 
</pre></div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org73eb9e1">
<h4 id="org73eb9e1">Tokenize</h4>
<div class="outline-text-4" id="text-org73eb9e1">
<p>NLTK has a tokenizer specially built for tweets. The <code>twitter_samples</code> module actually has a <code>tokenizer</code> function that breaks the tweets up, but since we are using regular expressions to clean up the strings a little first, it makes more sense to tokenize the strings afterwards. Also note that one of the steps in the pipeline is to lower-case the letters, which the <code>TweetTokenizer</code> will do for us if we set the <code>preserve_case</code> argument to <code>False</code>.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">help</span><span class="p">(</span><span class="n">TweetTokenizer</span><span class="p">))</span>
</pre></div>
<pre class="example">
Help on class TweetTokenizer in module nltk.tokenize.casual:

class TweetTokenizer(builtins.object)
 |  TweetTokenizer(preserve_case=True, reduce_len=False, strip_handles=False)
 |  
 |  Tokenizer for tweets.
 |  
 |      &gt;&gt;&gt; from nltk.tokenize import TweetTokenizer
 |      &gt;&gt;&gt; tknzr = TweetTokenizer()
 |      &gt;&gt;&gt; s0 = "This is a cooool #dummysmiley: :-) :-P &lt;3 and some arrows &lt; &gt; -&gt; &lt;--"
 |      &gt;&gt;&gt; tknzr.tokenize(s0)
 |      ['This', 'is', 'a', 'cooool', '#dummysmiley', ':', ':-)', ':-P', '&lt;3', 'and', 'some', 'arrows', '&lt;', '&gt;', '-&gt;', '&lt;--']
 |  
 |  Examples using `strip_handles` and `reduce_len parameters`:
 |  
 |      &gt;&gt;&gt; tknzr = TweetTokenizer(strip_handles=True, reduce_len=True)
 |      &gt;&gt;&gt; s1 = '@remy: This is waaaaayyyy too much for you!!!!!!'
 |      &gt;&gt;&gt; tknzr.tokenize(s1)
 |      [':', 'This', 'is', 'waaayyy', 'too', 'much', 'for', 'you', '!', '!', '!']
 |  
 |  Methods defined here:
 |  
 |  __init__(self, preserve_case=True, reduce_len=False, strip_handles=False)
 |      Initialize self.  See help(type(self)) for accurate signature.
 |  
 |  tokenize(self, text)
 |      :param text: str
 |      :rtype: list(str)
 |      :return: a tokenized list of strings; concatenating this list returns        the original string if `preserve_case=False`
 |  
 |  ----------------------------------------------------------------------
 |  Data descriptors defined here:
 |  
 |  __dict__
 |      dictionary for instance variables (if defined)
 |  
 |  __weakref__
 |      list of weak references to the object (if defined)

None
</pre>
<div class="highlight">
<pre><span></span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">TweetTokenizer</span><span class="p">(</span><span class="n">preserve_case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strip_handles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">reduce_len</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>As I mentioned, <code>preserve_case</code> lower-cases the letters. The other two arguments are <code>strip_handles</code> which removes the twitter-handles and <code>reduce_len</code> which limits the number of times a character can be repeated to three - so <code>zzzzz</code> will be changed to <code>zzz</code>. Now we can tokenize our partly cleaned token.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) sunflowers favourites happy Friday off… 
['my', 'beautiful', 'sunflowers', 'on', 'a', 'sunny', 'friday', 'morning', 'off', ':)', 'sunflowers', 'favourites', 'happy', 'friday', 'off', '…']
</pre></div>
</div>
<div class="outline-4" id="outline-container-org2d28fe5">
<h4 id="org2d28fe5">Remove Stop Words and Punctuation</h4>
<div class="outline-text-4" id="text-org2d28fe5">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">english_stopwords</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>
</pre></div>
<pre class="example">
['i', 'me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you', "you're", "you've", "you'll", "you'd", 'your', 'yours', 'yourself', 'yourselves', 'he', 'him', 'his', 'himself', 'she', "she's", 'her', 'hers', 'herself', 'it', "it's", 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves', 'what', 'which', 'who', 'whom', 'this', 'that', "that'll", 'these', 'those', 'am', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing', 'a', 'an', 'the', 'and', 'but', 'if', 'or', 'because', 'as', 'until', 'while', 'of', 'at', 'by', 'for', 'with', 'about', 'against', 'between', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'to', 'from', 'up', 'down', 'in', 'out', 'on', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when', 'where', 'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 's', 't', 'can', 'will', 'just', 'don', "don't", 'should', "should've", 'now', 'd', 'll', 'm', 'o', 're', 've', 'y', 'ain', 'aren', "aren't", 'couldn', "couldn't", 'didn', "didn't", 'doesn', "doesn't", 'hadn', "hadn't", 'hasn', "hasn't", 'haven', "haven't", 'isn', "isn't", 'ma', 'mightn', "mightn't", 'mustn', "mustn't", 'needn', "needn't", 'shan', "shan't", 'shouldn', "shouldn't", 'wasn', "wasn't", 'weren', "weren't", 'won', "won't", 'wouldn', "wouldn't"]
!"#$%&amp;'()*+,-./:;&lt;=&gt;?@[\]^_`{|}~
</pre>
<div class="highlight">
<pre><span></span><span class="n">cleaned</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">english_stopwords</span> <span class="ow">and</span>
                                       <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
</pre></div>
<pre class="example">
['beautiful', 'sunflowers', 'sunny', 'friday', 'morning', ':)', 'sunflowers', 'favourites', 'happy', 'friday', '…']
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgfa961fe">
<h4 id="orgfa961fe">Stemming</h4>
<div class="outline-text-4" id="text-orgfa961fe">
<p>We're going to use the <a href="https://www.nltk.org/_modules/nltk/stem/porter.html">Porter Stemmer</a> from NLTK (<a href="https://tartarus.org/martin/PorterStemmer/">this</a> is the official Porter Stemmer algorithm page) to stem the words.</p>
<div class="highlight">
<pre><span></span><span class="n">stemmer</span> <span class="o">=</span> <span class="n">PorterStemmer</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">stemmed</span> <span class="o">=</span> <span class="p">[</span><span class="n">stemmer</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">cleaned</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stemmed</span><span class="p">)</span>
</pre></div>
<pre class="example">
['beauti', 'sunflow', 'sunni', 'friday', 'morn', ':)', 'sunflow', 'favourit', 'happi', 'friday', '…']
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0630e7a">
<h2 id="org0630e7a">End</h2>
<div class="outline-text-2" id="text-org0630e7a">
<p>So now we've seen the basic steps that we're going to need to preprocess our tweets for <a href="https://www.wikiwand.com/en/Sentiment_analysis">Sentiment Analysis</a>.</p>
<p><b>Note:</b> This is a re-write of an exercise taken from Coursera's <a href="https://www.deeplearning.ai/natural-language-processing-specialization/">Natural Language Processing</a> specialization.</p>
<p>The rest of this is outside the scope of the exercise, it's just to get it all into one place.</p>
</div>
<div class="outline-3" id="outline-container-orgdd41b33">
<h3 id="orgdd41b33">Tests</h3>
<div class="outline-text-3" id="text-orgdd41b33">
<p>I'm going to use <a href="https://github.com/pytest-dev/pytest-bdd">pytest-bdd</a> to run the tests for the pre-processor but I'm also going to take advantage of org-babel and keep the scenario definitions and the test functions grouped by what they do, even though they will exist in two different files (<code>tweet_preprocessing.feature</code> and <code>test_preprocessing.py</code>) when tangled out of this file.</p>
</div>
<div class="outline-4" id="outline-container-org8a2bf74">
<h4 id="org8a2bf74">The Tangles</h4>
<div class="outline-text-4" id="text-org8a2bf74">
<div class="highlight">
<pre><span></span>Feature: Tweet pre-processor

&lt;&lt;stock-processing&gt;&gt;

&lt;&lt;re-tweet-processing&gt;&gt;

&lt;&lt;hyperlink-processing&gt;&gt;

&lt;&lt;hash-processing&gt;&gt;

&lt;&lt;tokenization-preprocessing&gt;&gt;

&lt;&lt;stop-word-preprocessing&gt;&gt;

&lt;&lt;stem-preprocessing&gt;&gt;

&lt;&lt;whole-shebang-preprocessing&gt;&gt;
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># software under test</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>

<span class="k">class</span> <span class="nc">Katamari</span><span class="p">:</span>
    <span class="sd">"""Something to stick values into"""</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">katamari</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Katamari</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">processor</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">contain_exactly</span><span class="p">,</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">given</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">,</span>
    <span class="n">then</span><span class="p">,</span>
    <span class="n">when</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">And</span> <span class="o">=</span> <span class="n">when</span>


<span class="c1"># fixtures</span>
<span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span>

<span class="n">scenarios</span><span class="p">(</span><span class="s2">"../../features/twitter/tweet_preprocessing.feature"</span><span class="p">)</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">stock</span><span class="o">-</span><span class="n">symbol</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">re</span><span class="o">-</span><span class="n">tweet</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">hyperlinks</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">hashtags</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">tokenization</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">unstopping</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">stem</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">call</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>Now on to the sections that go into the tangles.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgb60074f">
<h4 id="orgb60074f">Stock Symbols</h4>
<div class="outline-text-4" id="text-orgb60074f">
<p>Twitter has a special symbol for stocks which is a dollar sign followed by the stock ticker name (e.g. <code>$HOG</code> for Harley Davidson) that I'll remove. This is going to assume anything with a dollar sign immediately followed by a letter, number, or underscore is a stock symbol.</p>
<div class="highlight">
<pre><span></span>Scenario: A tweet with a stock symbol is cleaned
  Given a tweet with a stock symbol in it
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1">#Scenario: A tweet with a stock symbol is cleaned</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet with a stock symbol in it"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_stock_symbol</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">(),</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> "</span>
                         <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">tail</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># the cleaner ignores spaces so there's going to be two spaces between</span>
    <span class="c1"># the head and tail after the symbol is removed</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">tail</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span>

<span class="c1">#   When the tweet is cleaned</span>
<span class="c1">#   Then it has the text removed</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb577b2d">
<h4 id="orgb577b2d">The Re-tweets</h4>
<div class="outline-text-4" id="text-orgb577b2d">
<p>This tests that we can remove the RT tag.</p>
<div class="highlight">
<pre><span></span>Scenario: A re-tweet is cleaned.

  Given a tweet that has been re-tweeted
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: A re-tweet is cleaned.</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet that has been re-tweeted"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_re_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">spaces</span> <span class="o">=</span> <span class="s2">" "</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"RT</span><span class="si">{</span><span class="n">spaces</span><span class="si">}{</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the tweet is cleaned"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it has the text removed"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_cleaned_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3a7ad1a">
<h4 id="org3a7ad1a">Hyperlinks</h4>
<div class="outline-text-4" id="text-org3a7ad1a">
<p>Now test that we can remove hyperlinks.</p>
<div class="highlight">
<pre><span></span>Scenario: The tweet has a hyperlink
  Given a tweet with a hyperlink
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The tweet has a hyperlink</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet with a hyperlink"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_hyperlink</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">base</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">faker</span><span class="o">.</span><span class="n">uri</span><span class="p">()</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0feb5f2">
<h4 id="org0feb5f2">Hash Symbols</h4>
<div class="outline-text-4" id="text-org0feb5f2">
<p>Test that we can remove the pound symbol.</p>
<div class="highlight">
<pre><span></span>Scenario: A tweet has hash symbols in it.
  Given a tweet with hash symbols
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet with hash symbols"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_hash_symbols</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">expected_tokens</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">word</span><span class="p">()</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"#</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
        <span class="n">expected_tokens</span> <span class="o">=</span> <span class="n">expected_tokens</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+</span> <span class="n">expected_tokens</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expected_tokens</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org171244a">
<h4 id="org171244a">Tokenization</h4>
<div class="outline-text-4" id="text-org171244a">
<p>This is being done by NLTK, so it might not really make sense to test it, but I figured adding a test would make it more likely that I'd slow down enough to understand what it's doing.</p>
<div class="highlight">
<pre><span></span>Scenario: The text is tokenized
  Given a string of text
  When the text is tokenized
  Then it is the expected list of strings
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The text is tokenized</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a string of text"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">"Time flies like an Arrow, fruit flies like a BANANAAAA!"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"time flies like an arrow , "</span>
                         <span class="s2">"fruit flies like a bananaaa !"</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the text is tokenized"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it is the expected list of strings"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_tokens</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge7df91a">
<h4 id="orge7df91a">Stop Word Removal</h4>
<div class="outline-text-4" id="text-orge7df91a">
<p>Check that we're removing stop-words and punctuation.</p>
<div class="highlight">
<pre><span></span>Scenario: The user removes stop words and punctuation
  Given a tokenized string
  When the string is un-stopped
  Then it is the expected list of strings
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1">#Scenario: The user removes stop words and punctuation</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tokenized string"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_tokenized_string</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"now is the winter of our discontent , "</span>
                       <span class="s2">"made glorious summer by this son of york ;"</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"winter discontent made glorious "</span>
                         <span class="s2">"summer son york"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the string is un-stopped"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">un_stop</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">remove_useless_tokens</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span>
<span class="c1">#  Then it is the expected list of strings</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5bf7b98">
<h4 id="org5bf7b98">Stemming</h4>
<div class="outline-text-4" id="text-org5bf7b98">
<p>This is kind of a fake test. I guessed incorrectly what the stemming would do the first time so I had to go back and match the test values to what it output. I don't think I'll take the time to learn how the stemming is working, though, so it'll have to do.</p>
<div class="highlight">
<pre><span></span>Scenario: The user stems the tokens
  Given a tokenized string
  When the string is un-stopped
  And tokens are stemmed
  Then it is the expected list of strings
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user stems the tokens</span>
<span class="c1">#  Given a tokenized string</span>
<span class="c1">#  When the string is un-stopped</span>


<span class="nd">@And</span><span class="p">(</span><span class="s2">"tokens are stemmed"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stem_tokens</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="s2">"winter discont made gloriou summer son york"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span>


<span class="c1">#  Then it is the expected list of strings</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge176349">
<h4 id="orge176349">The Whole Shebang</h4>
<div class="outline-text-4" id="text-orge176349">
<p>I made some of the steps separate just for illustration and testing, but I'll make the processor callable so they don't have to be done separately.</p>
<div class="highlight">
<pre><span></span>Scenario: The user calls the processor
  Given a tweet
  When the processor is called with the tweet
  Then it returns the cleaned, tokenized, and stemmed list
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user calls the processor</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">words</span> <span class="o">=</span> <span class="s2">"How now, brown cow? Whither and dither the smelly laulau. Boooooow Wooooow!"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweet</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"RT </span><span class="si">{</span><span class="n">katamari</span><span class="o">.</span><span class="n">words</span><span class="si">}</span><span class="s2">  #bocceballs </span><span class="si">{</span><span class="n">faker</span><span class="o">.</span><span class="n">uri</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="s2">"brown cow whither dither smelli laulau booow wooow boccebal"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the processor is called with the tweet"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it returns the cleaned, tokenized, and stemmed list"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_processed_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org404a3b4">
<h3 id="org404a3b4">Implementation</h3>
<div class="outline-text-3" id="text-org404a3b4">
<p>I'm going to implement it as a class rather than a function just so that all this stuff that's floating around in the notebook as global variables is collected in one place.</p>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">nltk.stem</span> <span class="kn">import</span> <span class="n">PorterStemmer</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">TweetTokenizer</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">nltk</span>

<span class="o">&lt;&lt;</span><span class="n">regular</span><span class="o">-</span><span class="n">expressions</span><span class="o">&gt;&gt;</span>


<span class="nd">@attr</span><span class="o">.</span><span class="n">s</span>
<span class="k">class</span> <span class="nc">TwitterProcessor</span><span class="p">:</span>
    <span class="sd">"""processor for tweets"""</span>
    <span class="n">_tokenizer</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">_stopwords</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">_stemmer</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">clean</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">tokenizer</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">un</span><span class="o">-</span><span class="n">stop</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">stopwords</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">stemmer</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">stem</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">call</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org9ce3bcf">
<h4 id="org9ce3bcf">A Regular Expression Helper</h4>
<div class="outline-text-4" id="text-org9ce3bcf">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">WheatBran</span><span class="p">:</span>
    <span class="sd">"""This is a holder for the regular expressions"""</span>
    <span class="n">START_OF_LINE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"^"</span>
    <span class="n">OPTIONAL</span> <span class="o">=</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">?"</span>
    <span class="n">ANYTHING</span> <span class="o">=</span> <span class="s2">"."</span>
    <span class="n">ZERO_OR_MORE</span> <span class="o">=</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">*"</span>
    <span class="n">ONE_OR_MORE</span> <span class="o">=</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">+"</span>
    <span class="n">ONE_OF_THESE</span> <span class="o">=</span> <span class="s2">"[</span><span class="si">{}</span><span class="s2">]"</span>

    <span class="n">SPACE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\s"</span>
    <span class="n">SPACES</span> <span class="o">=</span> <span class="n">ONE_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SPACE</span><span class="p">)</span>
    <span class="n">PART_OF_A_WORD</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\w"</span>
    <span class="n">EVERYTHING_OR_NOTHING</span> <span class="o">=</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ANYTHING</span><span class="p">)</span>

    <span class="n">ERASE</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">FORWARD_SLASHES</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\/\/"</span>
    <span class="n">NEWLINES</span> <span class="o">=</span> <span class="n">ONE_OF_THESE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\r\n"</span><span class="p">)</span>
    <span class="c1"># a dollar is a special regular expression character meaning end of line</span>
    <span class="c1"># so escape it</span>
    <span class="n">DOLLAR_SIGN</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\$"</span>

    <span class="c1"># to remove</span>
    <span class="n">STOCK_SYMBOL</span> <span class="o">=</span> <span class="n">DOLLAR_SIGN</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PART_OF_A_WORD</span><span class="p">)</span>
    <span class="n">RE_TWEET</span> <span class="o">=</span> <span class="n">START_OF_LINE</span> <span class="o">+</span> <span class="s2">"RT"</span> <span class="o">+</span> <span class="n">SPACES</span>
    <span class="n">HYPERLINKS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"http"</span> <span class="o">+</span> <span class="n">OPTIONAL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"s"</span><span class="p">)</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="n">FORWARD_SLASHES</span>
                  <span class="o">+</span> <span class="n">EVERYTHING_OR_NOTHING</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NEWLINES</span><span class="p">))</span>
    <span class="n">HASH</span> <span class="o">=</span> <span class="s2">"#"</span>

    <span class="n">remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">STOCK_SYMBOL</span><span class="p">,</span> <span class="n">RE_TWEET</span><span class="p">,</span> <span class="n">HYPERLINKS</span><span class="p">,</span> <span class="n">HASH</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5d7938d">
<h4 id="org5d7938d">The Clean Method</h4>
<div class="outline-text-4" id="text-org5d7938d">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Removes sub-strings from the tweet</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: string tweet</span>

<span class="sd">    Returns:</span>
<span class="sd">     tweet with certain sub-strings removed</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">WheatBran</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
        <span class="n">tweet</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">WheatBran</span><span class="o">.</span><span class="n">ERASE</span><span class="p">,</span> <span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tweet</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org69aadde">
<h4 id="org69aadde">The Tokenizer</h4>
<div class="outline-text-4" id="text-org69aadde">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TweetTokenizer</span><span class="p">:</span>
    <span class="sd">"""The NLTK Tweet Tokenizer</span>

<span class="sd">    It will:</span>
<span class="sd">     - tokenize a string</span>
<span class="sd">     - remove twitter handles</span>
<span class="sd">     - remove repeated characters after the first three</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span> <span class="o">=</span> <span class="n">TweetTokenizer</span><span class="p">(</span><span class="n">preserve_case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">strip_handles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">reduce_len</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org105c23a">
<h4 id="org105c23a">Stopwords</h4>
<div class="outline-text-4" id="text-org105c23a">
<p>This might make more sense to be done at the module level, but I'll see how it goes.</p>
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">stopwords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""NLTK English stopwords</span>

<span class="sd">    Warning:</span>
<span class="sd">     if the stopwords haven't been downloaded this also tries too download them</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopwords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'stopwords'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopwords</span> <span class="o">=</span>  <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s2">"english"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopwords</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org817cda1">
<h4 id="org817cda1">Un-Stop the Tokens</h4>
<div class="outline-text-4" id="text-org817cda1">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">remove_useless_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Remove stopwords and punctuation</span>

<span class="sd">    Args:</span>
<span class="sd">     tokens: list of strings</span>

<span class="sd">    Returns:</span>
<span class="sd">     tokens with unuseful tokens removed</span>
<span class="sd">    """</span>    
    <span class="k">return</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopwords</span> <span class="ow">and</span>
                                        <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga4bbc14">
<h4 id="orga4bbc14">Stem the Tokens</h4>
<div class="outline-text-4" id="text-orga4bbc14">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">stemmer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PorterStemmer</span><span class="p">:</span>
    <span class="sd">"""Porter Stemmer for the tokens"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stemmer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stemmer</span> <span class="o">=</span> <span class="n">PorterStemmer</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stemmer</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">stem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stemmer</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0a471f1">
<h4 id="org0a471f1">Call Me</h4>
<div class="outline-text-4" id="text-org0a471f1">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""does all the processing in one step</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: string to process</span>
<span class="sd">    """</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>    
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_useless_tokens</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cleaned</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="/categories/nlp/" rel="tag">nlp</a></li>
<li><a class="tag p-category" href="/categories/nltk/" rel="tag">nltk</a></li>
<li><a class="tag p-category" href="/categories/preprocessing/" rel="tag">preprocessing</a></li>
<li><a class="tag p-category" href="/categories/twitter/" rel="tag">twitter</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="/posts/keras/flask-tensorflow-and-mnist/" rel="prev" title="Flask, TensorFlow, Streamlit and the MNIST Dataset">Previous post</a></li>
<li class="next"><a href="/posts/nlp/twitter-word-frequencies/" rel="next" title="Twitter Word Frequencies">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Contents © 2020 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="/assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> 
</body>
</html>
