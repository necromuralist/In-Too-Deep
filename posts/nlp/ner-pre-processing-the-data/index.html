<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Pre-processing the kaggle dataset." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>NER: Pre-Processing the Data | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/ner-pre-processing-the-data/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../rnns-and-vanishing-gradients/" rel="prev" title="RNNS and Vanishing Gradients" type="text/html">
<link href="../named-entity-recognition/" rel="next" title="Named Entity Recognition" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="NER: Pre-Processing the Data" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/ner-pre-processing-the-data/" property="og:url">
<meta content="Pre-processing the kaggle dataset." property="og:description">
<meta content="article" property="og:type">
<meta content="2021-01-13T14:43:13-08:00" property="article:published_time">
<meta content="lstm" property="article:tag">
<meta content="ner" property="article:tag">
<meta content="nlp" property="article:tag">
<meta content="rnn" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">NER: Pre-Processing the Data</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2021-01-13T14:43:13-08:00" itemprop="datePublished" title="2021-01-13 14:43">2021-01-13 14:43</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3421d31">Preprocessing The Data</a>
<ul>
<li><a href="#org35b824c">Imports</a></li>
<li><a href="#org3440d45">Set Up</a>
<ul>
<li><a href="#org09ecad0">The Dataset</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgfdfffa7">Middle</a>
<ul>
<li><a href="#org2fa99d1">The Kaggle Data</a></li>
<li><a href="#orgb89205b">Words and Tags</a></li>
<li><a href="#org9ed3979">Sentences and Labels</a></li>
<li><a href="#orgefc9f48">To Numbers</a></li>
<li><a href="#orge1a1fa3">The Train-Test Split</a></li>
<li><a href="#orgbd35d16">Bundling This Up</a>
<ul>
<li><a href="#orgc2879f3">Imports</a></li>
<li><a href="#org6e6b290">Some Constants</a></li>
<li><a href="#orga6cba4a">The Data Processor</a></li>
<li><a href="#org3449aea">Data Vectorizer</a></li>
<li><a href="#org5f6ce18">The Splitter</a></li>
<li><a href="#org8f66288">The Loader</a></li>
<li><a href="#org3f7e4db">The Processor</a></li>
<li><a href="#orgd2fc0e2">Testing It Out</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org3421d31">
<h2 id="org3421d31">Preprocessing The Data</h2>
<div class="outline-text-2" id="text-org3421d31">
<ul class="org-ul">
<li><a href="../named-entity-recognition/">The First Post</a></li>
<li><a href="../ner-data/">The Next Post</a></li>
</ul>
<p>We will be using a dataset from <a href="https://www.kaggle.com/abhinavwalia95/entity-annotated-corpus">Kaggle</a> which appears to have originally come from the <a href="https://gmb.let.rug.nl/">Groningen Meaning Bank</a> (a bank of texts, not money). The original data consists of four columns, the sentence number, the word, the part of speech of the word, and the tags. A few tags you might expect to see are:</p>
<ul class="org-ul">
<li>geo: geographical entity</li>
<li>org: organization</li>
<li>per: person</li>
<li>gpe: geopolitical entity</li>
<li>tim: time indicator</li>
<li>art: artifact</li>
<li>eve: event</li>
<li>nat: natural phenomenon</li>
<li>O: filler word</li>
</ul>
</div>
<div class="outline-3" id="outline-container-org35b824c">
<h3 id="org35b824c">Imports</h3>
<div class="outline-text-3" id="text-org35b824c">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">equal</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org3440d45">
<h3 id="org3440d45">Set Up</h3>
<div class="outline-text-3" id="text-org3440d45"></div>
<div class="outline-4" id="outline-container-org09ecad0">
<h4 id="org09ecad0">The Dataset</h4>
<div class="outline-text-4" id="text-org09ecad0">
<p><b>Note:</b> to get the encoding for the file use <code>file</code>:</p>
<pre class="example" id="org2f8354c">
file -bi ner_dataset.csv
</pre>
<p>In this case we get:</p>
<pre class="example" id="org997baf9">
application/csv; charset=iso-8859-1
</pre>
<p>Since it isn't ASCII or ISO-8 we'll have to tell pandas what the encoding is.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"NER_DATASET"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"ISO-8859-1"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgfdfffa7">
<h2 id="orgfdfffa7">Middle</h2>
<div class="outline-text-2" id="text-orgfdfffa7"></div>
<div class="outline-3" id="outline-container-org2fa99d1">
<h3 id="org2fa99d1">The Kaggle Data</h3>
<div class="outline-text-3" id="text-org2fa99d1">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">&nbsp;</th>
<th class="org-right" scope="col">Sentence #</th>
<th class="org-left" scope="col">Word</th>
<th class="org-left" scope="col">POS</th>
<th class="org-left" scope="col">Tag</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">Sentence: 1</td>
<td class="org-left">Thousands</td>
<td class="org-left">NNS</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-right">nan</td>
<td class="org-left">of</td>
<td class="org-left">IN</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">2</td>
<td class="org-right">nan</td>
<td class="org-left">demonstrators</td>
<td class="org-left">NNS</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">3</td>
<td class="org-right">nan</td>
<td class="org-left">have</td>
<td class="org-left">VBP</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">4</td>
<td class="org-right">nan</td>
<td class="org-left">marched</td>
<td class="org-left">VBN</td>
<td class="org-left">O</td>
</tr>
</tbody>
</table>
<p>As you can (kind of) tell, the sentences are broken up so that each row has one word in it.</p>
<p>To make it easier to work with I'm going to rename the columns.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"Sentence #"</span><span class="p">:</span><span class="s2">"sentence"</span><span class="p">,</span> <span class="s2">"Word"</span><span class="p">:</span> <span class="s2">"word"</span><span class="p">,</span> <span class="s2">"Tag"</span><span class="p">:</span> <span class="s2">"tag"</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb89205b">
<h3 id="orgb89205b">Words and Tags</h3>
<div class="outline-text-3" id="text-orgb89205b">
<p>The first thing we're going to do is separate out the words to build our vocabulary. The <code>vocabulary</code> will be a mapping of each word to an index so that we can convert our text to numbers for our model. In addition we're going to add a <code>&lt;PAD&gt;</code> token so that if our input is to short we can pad it to be the right size. And an <code>UNK</code> token in case we don't know a word.</p>
<div class="highlight">
<pre><span></span><span class="n">token</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Token"</span><span class="p">,</span> <span class="s2">"pad unknown"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">Token</span> <span class="o">=</span> <span class="n">token</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="s2">"UNK"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
<span class="n">vocabulary</span><span class="p">[</span><span class="n">Token</span><span class="o">.</span><span class="n">pad</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>
<span class="n">vocabulary</span><span class="p">[</span><span class="n">Token</span><span class="o">.</span><span class="n">unknown</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
35,180
</pre>
<p>We're going to do the same with the Tag column.</p>
<div class="highlight">
<pre><span></span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
</pre></div>
<pre class="example">
{'O': 0, 'B-geo': 1, 'B-gpe': 2, 'B-per': 3, 'I-geo': 4, 'B-org': 5, 'I-org': 6, 'B-tim': 7, 'B-art': 8, 'I-art': 9, 'I-per': 10, 'I-gpe': 11, 'I-tim': 12, 'B-nat': 13, 'B-eve': 14, 'I-eve': 15, 'I-nat': 16}
</pre>
<p><b>Note:</b> This is actually cheating because I am using the whole dataset. Later on make sure to only use the training data.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org9ed3979">
<h3 id="org9ed3979">Sentences and Labels</h3>
<div class="outline-text-3" id="text-org9ed3979">
<p>We're also going to need to smash the words back into sentences. There's probably a clever pandas way to do this, but I'll just brute-force it. We'll also need to join the labels for the sentences into strings.</p>
<div class="highlight">
<pre><span></span><span class="n">sentences</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sentence</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pandas</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">sentence</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="n">sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sentence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
47,958
47,958
['Thousands', 'of', 'demonstrators', 'have', 'marched', 'through', 'London', 'to', 'protest', 'the', 'war', 'in', 'Iraq', 'and', 'demand', 'the', 'withdrawal', 'of', 'British', 'troops', 'from', 'that', 'country', '.']
['O', 'O', 'O', 'O', 'O', 'O', 'B-geo', 'O', 'O', 'O', 'O', 'O', 'B-geo', 'O', 'O', 'O', 'O', 'O', 'B-gpe', 'O', 'O', 'O', 'O', 'O']
</pre>
<p>We're going to convert them to numbers so I didn't join them into strings.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgefc9f48">
<h3 id="orgefc9f48">To Numbers</h3>
<div class="outline-text-3" id="text-orgefc9f48">
<div class="highlight">
<pre><span></span><span class="n">sentence_vectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="n">vocabulary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">Token</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span>
<span class="p">]</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence_vectors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sentence_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 9, 15, 1, 16, 17, 18, 19, 20, 21]
</pre>
<div class="highlight">
<pre><span></span><span class="n">label_vectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">sentence_labels</span><span class="p">]</span> <span class="k">for</span> <span class="n">sentence_labels</span> <span class="ow">in</span> <span class="n">labels</span>
<span class="p">]</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_vectors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
[0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0]
</pre>
<p>In this case we're assuming that there's no unknown tags because they are only used for training and testing so we wouldn't expect to see one that isn't in our current dataset, unlike the sentences which are going to be used with new data and so might have tokens we haven't seen before.</p>
<p>We could add the padding here, but instead we're going to do it in the batch generator.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orge1a1fa3">
<h3 id="orge1a1fa3">The Train-Test Split</h3>
<div class="outline-text-3" id="text-orge1a1fa3">
<p>This time we're going to do a real train-validation-test split.</p>
<div class="highlight">
<pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Split"</span><span class="p">,</span> <span class="s2">"train validation test"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">Split</span> <span class="o">=</span> <span class="n">splits</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="mi">33570</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="mi">7194</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="mi">7194</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_leftovers</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_leftovers</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="n">Split</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
<span class="n">x_validation</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_validation</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">x_leftovers</span><span class="p">,</span> <span class="n">y_leftovers</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">Split</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">train</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">train</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_validation</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">validation</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_validation</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">validation</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">test</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">test</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgbd35d16">
<h3 id="orgbd35d16">Bundling This Up</h3>
<div class="outline-text-3" id="text-orgbd35d16"></div>
<div class="outline-4" id="outline-container-orgc2879f3">
<h4 id="orgc2879f3">Imports</h4>
<div class="outline-text-4" id="text-orgc2879f3">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6e6b290">
<h4 id="org6e6b290">Some Constants</h4>
<div class="outline-text-4" id="text-org6e6b290">
<div class="highlight">
<pre><span></span><span class="n">Read</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Read"</span><span class="p">,</span> <span class="s2">"dotenv key encoding"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">READ</span> <span class="o">=</span> <span class="n">Read</span><span class="p">(</span><span class="n">dotenv</span><span class="o">=</span><span class="s2">"posts/nlp/.env"</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">"NER_DATASET"</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">"ISO-8859-1"</span><span class="p">)</span>

<span class="n">COLUMNS</span><span class="o">=</span><span class="p">{</span><span class="s2">"Sentence #"</span><span class="p">:</span><span class="s2">"sentence"</span><span class="p">,</span>
         <span class="s2">"Word"</span><span class="p">:</span> <span class="s2">"word"</span><span class="p">,</span>
         <span class="s2">"Tag"</span><span class="p">:</span> <span class="s2">"tag"</span><span class="p">}</span>

<span class="n">Token</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Token"</span><span class="p">,</span> <span class="s2">"pad unknown"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">TOKEN</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="s2">"UNK"</span><span class="p">)</span>

<span class="n">Splits</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Split"</span><span class="p">,</span> <span class="s2">"train validation test"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">SPLIT</span> <span class="o">=</span> <span class="n">Splits</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="mi">33570</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="mi">7194</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="mi">7194</span><span class="p">)</span>

<span class="n">DataSets</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"DataSets"</span><span class="p">,</span> <span class="p">[</span>
    <span class="s2">"x_train"</span><span class="p">,</span>
    <span class="s2">"y_train"</span><span class="p">,</span>
    <span class="s2">"x_validate"</span><span class="p">,</span>
    <span class="s2">"y_validate"</span><span class="p">,</span>
    <span class="s2">"x_test"</span><span class="p">,</span>
    <span class="s2">"y_test"</span>
<span class="p">])</span>

<span class="n">TheData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"TheData"</span><span class="p">,</span> <span class="p">[</span>
    <span class="s2">"vocabulary"</span><span class="p">,</span>
    <span class="s2">"tags"</span><span class="p">,</span>
    <span class="s2">"data_sets"</span><span class="p">,</span>
    <span class="s2">"raw_data_sets"</span><span class="p">,</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga6cba4a">
<h4 id="orga6cba4a">The Data Processor</h4>
<div class="outline-text-4" id="text-orga6cba4a">
<p>Each of the three sets needs to be vectorized since I'm not saving the sentences beforehand. So this class handles that.</p>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataFlattener</span><span class="p">:</span>
    <span class="sd">"""Converts the kaggle data to sentences and labels</span>

<span class="sd">    Args:</span>
<span class="sd">     data: the data to convert</span>
<span class="sd">    """</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">_sentences</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_labels</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org20f67c7"></a>Sentences<br>
<div class="outline-text-5" id="text-org20f67c7">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">sentences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""List of sentences from the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_sentences_and_labels</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span>
</pre></div>
</div>
</li>
<li><a id="org8d6358f"></a>Labels<br>
<div class="outline-text-5" id="text-org8d6358f">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""List of labels from the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_sentences_and_labels</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span>
</pre></div>
</div>
</li>
<li><a id="org9050ae9"></a>Sentences and Labels maker<br>
<div class="outline-text-5" id="text-org9050ae9">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">set_sentences_and_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Converts the data to lists</span>
<span class="sd">    of sentence token lists and also sets the labels</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sentence</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pandas</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">sentence</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sentence</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">sentence</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sentence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org3449aea">
<h4 id="org3449aea">Data Vectorizer</h4>
<div class="outline-text-4" id="text-org3449aea">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataVectorizer</span><span class="p">:</span>
    <span class="sd">"""Converts the data-set strings to vectors</span>

<span class="sd">    Args:</span>
<span class="sd">     data_sets: the split up data sets</span>
<span class="sd">     vocabulary: map from token to index</span>
<span class="sd">     tags: map from tag to index</span>
<span class="sd">    """</span>
    <span class="n">data_sets</span><span class="p">:</span> <span class="n">namedtuple</span>
    <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_vectorized_datasets</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org9dca86f"></a>Vectorized Data Sets<br>
<div class="outline-text-5" id="text-org9dca86f">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vectorized_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
    <span class="sd">"""the original data sets converted to indices"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorized_datasets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sentence_vectors</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_vectors</span><span class="p">,</span>
                                   <span class="n">to_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
        <span class="n">label_vectors</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_vectors</span><span class="p">,</span>
                                <span class="n">to_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vectorized_datasets</span> <span class="o">=</span> <span class="n">DataSets</span><span class="p">(</span>
            <span class="n">x_train</span> <span class="o">=</span> <span class="n">sentence_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">),</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">label_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">),</span>
            <span class="n">x_validate</span> <span class="o">=</span> <span class="n">sentence_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_validate</span><span class="p">),</span>
            <span class="n">y_validate</span> <span class="o">=</span> <span class="n">label_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_validate</span><span class="p">),</span>
            <span class="n">x_test</span> <span class="o">=</span> <span class="n">sentence_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_test</span><span class="p">),</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">label_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_test</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorized_datasets</span>
</pre></div>
</div>
</li>
<li><a id="orgacb8ad2"></a>Sentence Vectors<br>
<div class="outline-text-5" id="text-orgacb8ad2">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">to_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">to_index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Sentences converted to Integers</span>

<span class="sd">    Args:</span>
<span class="sd">     source: iterator of tokenized strings to convert</span>
<span class="sd">     to_index: map to convert the tokens to indices</span>

<span class="sd">    Returns:</span>
<span class="sd">     tokens in source converted to indices</span>
<span class="sd">    """</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source</span>
        <span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vectors</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org5f6ce18">
<h4 id="org5f6ce18">The Splitter</h4>
<div class="outline-text-4" id="text-org5f6ce18">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataSplitter</span><span class="p">:</span>
    <span class="sd">"""Splits up the training, testing, etc.</span>

<span class="sd">    Args:</span>
<span class="sd">     split: constants with the train, test counts</span>
<span class="sd">     sentences: input data to split</span>
<span class="sd">     labels: y-data to split</span>
<span class="sd">     random_state: seed for the splitting</span>
<span class="sd">    """</span>
    <span class="n">split</span><span class="p">:</span> <span class="n">namedtuple</span>
    <span class="n">sentences</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span>    
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_data_sets</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org802ad19"></a>Data Sets<br>
<div class="outline-text-5" id="text-org802ad19">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
    <span class="sd">"""The Split data sets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_train</span><span class="p">,</span> <span class="n">x_leftovers</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_leftovers</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentences</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">train_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">train</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">x_validate</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">x_leftovers</span><span class="p">,</span>
            <span class="n">y_leftovers</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">test</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_sets</span> <span class="o">=</span> <span class="n">DataSets</span><span class="p">(</span><span class="n">x_train</span><span class="o">=</span><span class="n">x_train</span><span class="p">,</span>
                                   <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
                                   <span class="n">x_validate</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                                   <span class="n">y_validate</span><span class="o">=</span><span class="n">y_validate</span><span class="p">,</span>
                                   <span class="n">x_test</span><span class="o">=</span><span class="n">x_test</span><span class="p">,</span>
                                   <span class="n">y_test</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span>
                                   <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_validate</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sentences</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_sets</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org8f66288">
<h4 id="org8f66288">The Loader</h4>
<div class="outline-text-4" id="text-org8f66288">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataLoader</span><span class="p">:</span>
    <span class="sd">"""Loads and converts the kaggle data</span>

<span class="sd">    Args:</span>
<span class="sd">      read: the stuff to download the data</span>
<span class="sd">    """</span>
    <span class="n">read</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="n">READ</span>    
    <span class="n">_data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tags</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orga005cd2"></a>The Kaggle Data<br>
<div class="outline-text-5" id="text-orga005cd2">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">"""The original kaggle dataset"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">load_dotenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">dotenv</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">COLUMNS</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>
</div>
</li>
<li><a id="orgb877054"></a>The Vocabulary<br>
<div class="outline-text-5" id="text-orgb877054">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""map of word to index</span>

<span class="sd">    Note:</span>
<span class="sd">      This is creating a transformation of the entire data-set</span>
<span class="sd">    so it comes before the train-test-split so it uses the whole</span>
<span class="sd">    dataset, not just training</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">word</span><span class="p">:</span> <span class="n">index</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span>
</pre></div>
</div>
</li>
<li><a id="orgaea3481"></a>The Tags<br>
<div class="outline-text-5" id="text-orgaea3481">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""map of tag to index"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org3f7e4db">
<h4 id="org3f7e4db">The Processor</h4>
<div class="outline-text-4" id="text-org3f7e4db">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NERData</span><span class="p">:</span>
    <span class="sd">"""Master NER Data preparer</span>

<span class="sd">    Args:</span>
<span class="sd">     read_constants: stuff to help load the dataset</span>
<span class="sd">     split_constants: stuff to help split the dataset</span>
<span class="sd">     random_state: seed for the splitting</span>
<span class="sd">    """</span>
    <span class="n">read_constants</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="n">READ</span>
    <span class="n">split_constants</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="n">SPLIT</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">33</span>
    <span class="n">_data</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_loader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_flattener</span><span class="p">:</span> <span class="n">DataFlattener</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_splitter</span><span class="p">:</span> <span class="n">DataSplitter</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vectorizer</span> <span class="o">=</span> <span class="n">DataVectorizer</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org6af3a3d"></a>The Data<br>
<div class="outline-text-5" id="text-org6af3a3d">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
    <span class="sd">"""The split up data sets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">TheData</span><span class="p">(</span>
            <span class="n">vocabulary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">raw_data_sets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">data_sets</span><span class="p">,</span>
            <span class="n">data_sets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectorized_datasets</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>
</div>
</li>
<li><a id="org74f81f8"></a>The Loader<br>
<div class="outline-text-5" id="text-org74f81f8">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">loader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
    <span class="sd">"""The loader of the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">read</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_constants</span><span class="p">,</span>            
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span>
</pre></div>
</div>
</li>
<li><a id="org1b1f189"></a>The Flattener<br>
<div class="outline-text-5" id="text-org1b1f189">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">flattener</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFlattener</span><span class="p">:</span>
    <span class="sd">"""The sentence and label builder"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flattener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flattener</span> <span class="o">=</span> <span class="n">DataFlattener</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flattener</span>
</pre></div>
</div>
</li>
<li><a id="orgfc4ba18"></a>The Splitter<br>
<div class="outline-text-5" id="text-orgfc4ba18">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">splitter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataSplitter</span><span class="p">:</span>
    <span class="sd">"""The splitter upper for the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span> <span class="o">=</span> <span class="n">DataSplitter</span><span class="p">(</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_constants</span><span class="p">,</span>
            <span class="n">sentences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattener</span><span class="o">.</span><span class="n">sentences</span><span class="p">,</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattener</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span>
</pre></div>
</div>
</li>
<li><a id="org2d52d6b"></a>The Vectorizer<br>
<div class="outline-text-5" id="text-org2d52d6b">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vectorizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataVectorizer</span><span class="p">:</span>
    <span class="sd">"""Vectorizes the raw-data sets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vectorizer</span> <span class="o">=</span> <span class="n">DataVectorizer</span><span class="p">(</span>
            <span class="n">data_sets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">data_sets</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">vocabulary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorizer</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orgd2fc0e2">
<h4 id="orgd2fc0e2">Testing It Out</h4>
<div class="outline-text-4" id="text-orgd2fc0e2">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">NERData</span>

<span class="n">ner</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span>

<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">Split</span><span class="o">.</span><span class="n">train</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_validate</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">Split</span><span class="o">.</span><span class="n">validation</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_test</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">Split</span><span class="o">.</span><span class="n">test</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/lstm/" rel="tag">lstm</a></li>
<li><a class="tag p-category" href="../../../categories/ner/" rel="tag">ner</a></li>
<li><a class="tag p-category" href="../../../categories/nlp/" rel="tag">nlp</a></li>
<li><a class="tag p-category" href="../../../categories/rnn/" rel="tag">rnn</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../rnns-and-vanishing-gradients/" rel="prev" title="RNNS and Vanishing Gradients">Previous post</a></li>
<li class="next"><a href="../named-entity-recognition/" rel="next" title="Named Entity Recognition">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer"><a href="https://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://licensebuttons.net/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
