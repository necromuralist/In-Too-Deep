<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Evaluating the accuracy of a Siamese Model." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Evaluating a Siamese Model | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/evaluating-a-siamese-model/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../modified-triplet-loss/" rel="prev" title="Modified Triplet Loss" type="text/html">
<link href="../siamese-networks-duplicate-questions/" rel="next" title="Siamese Networks: Duplicate Questions" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Evaluating a Siamese Model" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/evaluating-a-siamese-model/" property="og:url">
<meta content="Evaluating the accuracy of a Siamese Model." property="og:description">
<meta content="article" property="og:type">
<meta content="2021-01-21T18:34:27-08:00" property="article:published_time">
<meta content="nlp" property="article:tag">
<meta content="nn" property="article:tag">
<meta content="siamese networks" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Evaluating a Siamese Model</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2021-01-21T18:34:27-08:00" itemprop="datePublished" title="2021-01-21 18:34">2021-01-21 18:34</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd6f4257">Beginning</a>
<ul>
<li><a href="#org7c9a639">Imports</a></li>
<li><a href="#org7a44ecc">Set Up</a></li>
</ul>
</li>
<li><a href="#org7f39a5e">Middle</a>
<ul>
<li><a href="#orgd7df08d">Data</a></li>
<li><a href="#orgb9d9902">Calculating the accuracy</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgd6f4257">
<h2 id="orgd6f4257">Beginning</h2>
<div class="outline-text-2" id="text-orgd6f4257">
<p>We are going to learn how to evaluate a Siamese model using the accuracy metric.</p>
</div>
<div class="outline-3" id="outline-container-org7c9a639">
<h3 id="org7c9a639">Imports</h3>
<div class="outline-text-3" id="text-org7c9a639">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">trax_numpy</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7a44ecc">
<h3 id="org7a44ecc">Set Up</h3>
<div class="outline-text-3" id="text-org7a44ecc">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="n">PREFIX</span> <span class="o">=</span> <span class="s2">"SIAMESE_"</span>
<span class="n">q1</span> <span class="o">=</span> <span class="n">trax_numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">PREFIX</span> <span class="o">+</span> <span class="s2">"Q1"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="n">q2</span> <span class="o">=</span> <span class="n">trax_numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">PREFIX</span> <span class="o">+</span> <span class="s2">"Q2"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="n">v1</span> <span class="o">=</span> <span class="n">trax_numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">PREFIX</span> <span class="o">+</span> <span class="s2">"V1"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="n">v2</span> <span class="o">=</span> <span class="n">trax_numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">PREFIX</span> <span class="o">+</span> <span class="s2">"V2"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">trax_numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">PREFIX</span> <span class="o">+</span> <span class="s2">"Y_TEST"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org7f39a5e">
<h2 id="org7f39a5e">Middle</h2>
<div class="outline-text-2" id="text-org7f39a5e"></div>
<div class="outline-3" id="outline-container-orgd7df08d">
<h3 id="orgd7df08d">Data</h3>
<div class="outline-text-3" id="text-orgd7df08d">
<p>We're going to use some pre-made data rather than start from scratch to (hopefully) make the actual evaluation clearer.</p>
<p>These are the data structures:</p>
<ul class="org-ul">
<li><code>q1</code>: vector with dimension <code>(batch_size X max_length)</code> containing first questions to compare in the test set.</li>
<li><code>q2</code>: vector with dimension <code>(batch_size X max_length)</code> containing second questions to compare in the test set.</li>
</ul>
<p><b>Notice that for each pair of vectors within a batch \(([q1_1, q1_2, q1_3, \ldots]\), \([q2_1, q2_2,q2_3, ...])\) \(q1_i\) is associated with \(q2_k\).</b></p>
<ul class="org-ul">
<li><code>y_test</code>: 1 if \(q1_i\) and \(q2_k\) are duplicates, 0 otherwise.</li>
<li><code>v1</code>: output vector from the model's prediction associated with the first questions.</li>
<li><code>v2</code>: output vector from the model's prediction associated with the second questions.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'q1 has shape: </span><span class="si">{</span><span class="n">q1</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> </span><span class="se">\n\n</span><span class="s1">And it looks like this: </span><span class="se">\n\n</span><span class="s1"> </span><span class="si">{</span><span class="n">q1</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org9af265f">
q1 has shape: (512, 64) 

And it looks like this: 

 [[ 32  38   4 ...   1   1   1]
 [ 30 156  78 ...   1   1   1]
 [ 32  38   4 ...   1   1   1]
 ...
 [ 32  33   4 ...   1   1   1]
 [ 30 156 317 ...   1   1   1]
 [ 30 156   6 ...   1   1   1]]
</pre>
<p>The ones on the right side are padding values.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'q2 has shape: </span><span class="si">{</span><span class="n">q2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> </span><span class="se">\n\n</span><span class="s1">And looks like this: </span><span class="se">\n\n</span><span class="s1"> </span><span class="si">{</span><span class="n">q2</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org1263497">
q2 has shape: (512, 64) 

And looks like this: 

 [[   30   156    78 ...     1     1     1]
 [  283   156    78 ...     1     1     1]
 [   32    38     4 ...     1     1     1]
 ...
 [   32    33     4 ...     1     1     1]
 [   30   156    78 ...     1     1     1]
 [   30   156 10596 ...     1     1     1]]
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'y_test has shape: </span><span class="si">{</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> </span><span class="se">\n\n</span><span class="s1">And looks like this: </span><span class="se">\n\n</span><span class="s1"> </span><span class="si">{</span><span class="n">y_test</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example" id="orgbbfe81c">
y_test has shape: (512,) 

And looks like this: 

 [0 1 1 0 0 0 0 1 0 1 1 0 0 0 1 1 1 0 1 1 0 0 0 0 1 1 0 0 0 0 1 0 1 1 0 0 0
 0 0 0 1 0 0 0 1 0 0 0 0 1 0 1 1 1 1 0 1 0 1 0 0 0 1 0 1 1 1 0 0 0 1 0 1 0
 0 0 0 1 0 0 1 1 0 0 0 1 0 1 1 0 1 0 0 0 1 0 1 0 0 0 0 1 1 1 0 1 0 1 1 0 0
 0 1 0 0 1 1 0 0 1 0 1 0 0 1 1 0 1 0 0 1 1 0 1 1 1 0 1 0 0 0 0 0 0 0 0 0 0
 1 0 1 1 1 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 1 0 0 0 0 0 1 1 0 1 0 1 1 0 1 1 1
 1 0 1 1 0 0 0 0 1 1 0 0 0 0 0 1 1 0 1 0 0 1 1 0 0 0 1 0 1 0 0 0 0 1 0 0 1
 0 0 0 0 0 0 0 1 1 0 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0
 1 0 0 0 0 1 0 0 0 0 1 0 1 0 1 1 0 0 0 0 1 1 1 1 0 0 0 0 0 0 0 0 1 0 0 0 1
 1 0 1 1 0 0 0 1 0 1 0 1 1 0 0 0 1 0 0 0 0 1 0 0 0 0 1 1 1 0 1 0 1 1 1 0 0
 0 1 0 1 0 1 1 0 0 0 0 0 0 0 0 1 0 1 0 1 0 1 0 0 1 0 0 1 0 1 0 0 1 0 0 0 0
 0 0 1 0 1 1 0 0 0 0 1 1 0 0 0 0 0 0 0 1 1 1 0 0 1 1 1 0 1 1 0 1 0 1 1 1 0
 1 1 0 1 0 1 0 0 0 0 0 0 0 0 1 1 0 0 0 1 0 0 0 1 1 0 1 1 1 0 0 0 1 0 1 1 1
 0 1 0 0 0 0 0 0 0 1 1 1 0 0 1 1 0 0 0 1 0 0 0 1 0 0 0 0 0 1 1 0 0 0 0 0 1
 1 0 1 0 0 1 0 0 0 0 0 0 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'v1 has shape: </span><span class="si">{</span><span class="n">v1</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> </span><span class="se">\n\n</span><span class="s1">And looks like this: </span><span class="se">\n\n</span><span class="s1"> </span><span class="si">{</span><span class="n">v1</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example" id="orgcfe8cb4">
v1 has shape: (512, 128) 

And looks like this: 

 [[ 0.01273625 -0.1496373  -0.01982759 ...  0.02205012 -0.00169148
  -0.01598107]
 [-0.05592084  0.05792497 -0.02226785 ...  0.08156938 -0.02570007
  -0.00503111]
 [ 0.05686752  0.0294889   0.04522024 ...  0.03141788 -0.08459651
  -0.00968536]
 ...
 [ 0.15115018  0.17791134  0.02200656 ... -0.00851707  0.00571415
  -0.00431194]
 [ 0.06995274  0.13110274  0.0202337  ... -0.00902792 -0.01221745
   0.00505962]
 [-0.16043712 -0.11899089 -0.15950686 ...  0.06544471 -0.01208312
  -0.01183368]]
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'v2 has shape: </span><span class="si">{</span><span class="n">v2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> </span><span class="se">\n\n</span><span class="s1">And looks like this: </span><span class="se">\n\n</span><span class="s1"> </span><span class="si">{</span><span class="n">v2</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org5c2c3a6">
v2 has shape: (512, 128) 

And looks like this: 

 [[ 0.07437647  0.02804951 -0.02974014 ...  0.02378932 -0.01696189
  -0.01897198]
 [ 0.03270066  0.15122835 -0.02175895 ...  0.00517202 -0.14617395
   0.00204823]
 [ 0.05635608  0.05454165  0.042222   ...  0.03831453 -0.05387777
  -0.01447786]
 ...
 [ 0.04727105 -0.06748016  0.04194937 ...  0.07600753 -0.03072828
   0.00400715]
 [ 0.00269269  0.15222628  0.01714724 ...  0.01482705 -0.0197884
   0.01389528]
 [-0.15475044 -0.15718803 -0.14732707 ...  0.04299919 -0.01070975
  -0.01318042]]
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgb9d9902">
<h3 id="orgb9d9902">Calculating the accuracy</h3>
<div class="outline-text-3" id="text-orgb9d9902">
<p>You will calculate the accuracy by iterating over the test set and checking if the model predicts right or wrong.</p>
<p>You will also need the <code>batch size</code> and the <code>threshold</code> that will determine if two questions are the same or not.</p>
<p><b>Note:</b> A higher threshold means that only very similar questions will be considered as the same question.</p>
<div class="highlight">
<pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">batch</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
</pre></div>
<p>The process is pretty straightforward:</p>
<ul class="org-ul">
<li>Iterate over each one of the elements in the batch</li>
<li>Compute the cosine similarity between the predictions
<ul class="org-ul">
<li>For computing the cosine similarity, the two output vectors should have been normalized using L2 normalization meaning their magnitude will be 1. This has been taken care off by the Siamese network. Hence the cosine similarity here is just dot product between two vectors. You can check by implementing the usual cosine similarity formula and check if this holds or not.</li>
</ul>
</li>
<li>Determine if this value is greater than the threshold (If it is, consider the two questions as the same and return 1 else 0)</li>
<li>Compare against the actual target and if the prediction matches, add 1 to the accuracy (increment the correct prediction counter)</li>
<li>Divide the accuracy by the number of processed elements</li>
</ul>
<div class="highlight">
<pre><span></span><span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="n">trax_numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">v2</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
    <span class="n">similar_enough</span> <span class="o">=</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="n">threshold</span>
    <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">==</span> <span class="n">similar_enough</span><span class="p">)</span>

<span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">batch_size</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The accuracy of the model is: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
</pre></div>
<pre class="example">
The accuracy of the model is: 0.6621.
</pre></div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/nlp/" rel="tag">nlp</a></li>
<li><a class="tag p-category" href="../../../categories/nn/" rel="tag">nn</a></li>
<li><a class="tag p-category" href="../../../categories/siamese-networks/" rel="tag">siamese networks</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../modified-triplet-loss/" rel="prev" title="Modified Triplet Loss">Previous post</a></li>
<li class="next"><a href="../siamese-networks-duplicate-questions/" rel="next" title="Siamese Networks: Duplicate Questions">Next post</a></li>
</ul>
</nav>
</aside>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']],},

        });
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script></article>
<!--End of body content-->
<footer id="footer"><a href="https://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://licensebuttons.net/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
