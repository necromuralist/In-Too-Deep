<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Deep N-Grams: Batch Generation | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/deep-n-grams-batch-generation/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../deep-n-grams-generating-sentences/" rel="prev" title="Deep N-Grams: Generating Sentences" type="text/html">
<link href="../rnns-and-vanishing-gradients/" rel="next" title="RNNS and Vanishing Gradients" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Deep N-Grams: Batch Generation" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/deep-n-grams-batch-generation/" property="og:url">
<meta content="Table of Contents Generating Batches of Data Imports Set Up The DataLoader Middle The Data Generator Implementing the Generator Try out the data generator. Repeating Batch generator Bundle" property="og:description">
<meta content="article" property="og:type">
<meta content="2021-01-05T17:08:48-08:00" property="article:published_time">
<meta content="gru" property="article:tag">
<meta content="n-grams" property="article:tag">
<meta content="nlp" property="article:tag">
<meta content="rnns" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Deep N-Grams: Batch Generation</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2021-01-05T17:08:48-08:00" itemprop="datePublished" title="2021-01-05 17:08">2021-01-05 17:08</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4c33076">Generating Batches of Data</a>
<ul>
<li><a href="#org587b4a7">Imports</a></li>
<li><a href="#org1b3b9f2">Set Up</a>
<ul>
<li><a href="#org37bacff">The DataLoader</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org302a98b">Middle</a>
<ul>
<li><a href="#orgae7b466">The Data Generator</a>
<ul>
<li><a href="#orgbce3a82">Implementing the Generator</a></li>
<li><a href="#orgb3fe97a">Try out the data generator.</a></li>
</ul>
</li>
<li><a href="#orgb716386">Repeating Batch generator</a></li>
<li><a href="#orge52bbd9">Bundle It Up</a>
<ul>
<li><a href="#orgde66e12">Imports</a></li>
<li><a href="#org4fddc66">Data Generator</a></li>
<li><a href="#org6c2d63e">Line Count</a></li>
<li><a href="#orgc06983b">Line Indices</a></li>
<li><a href="#orgc9c094c">The Iterator Method</a></li>
<li><a href="#orgf6f0498">The Batch Generator</a></li>
<li><a href="#org951e7dd">The Generator</a></li>
<li><a href="#org756ca76">The Next Method</a></li>
</ul>
</li>
<li><a href="#orgd78badb">Try It Out</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org4c33076">
<h2 id="org4c33076">Generating Batches of Data</h2>
<div class="outline-text-2" id="text-org4c33076">
<ul class="org-ul">
<li><a href="../deep-n-grams/">First Post</a></li>
<li><a href="../deep-n-grams-loading-the-data/">Previous Post</a></li>
<li><a href="../deep-n-grams-creating-the-model/">Next Post</a></li>
</ul>
<p>Most of the time in Natural Language Processing, and AI in general we use batches when training our data sets. Here, you will build a data generator that takes in a text and returns a batch of text lines (lines are sentences).</p>
<ul class="org-ul">
<li>The generator converts text lines (sentences) into numpy arrays of integers padded by zeros so that all arrays have the same length, which is the length of the longest sentence in the entire data set.</li>
</ul>
<p>This generator returns the data in a format that you could directly use in your model when computing the feed-forward pass of your algorithm. This iterator returns a batch of lines and a per-token mask. The batch is a tuple of three parts: inputs, targets, and mask. The inputs and targets are identical. The second column will be used to evaluate your predictions. Mask is 1 for non-padding tokens.</p>
</div>
<div class="outline-3" id="outline-container-org587b4a7">
<h3 id="org587b4a7">Imports</h3>
<div class="outline-text-3" id="text-org587b4a7">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">be_true</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn.data_loader</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1b3b9f2">
<h3 id="org1b3b9f2">Set Up</h3>
<div class="outline-text-3" id="text-org1b3b9f2"></div>
<div class="outline-4" id="outline-container-org37bacff">
<h4 id="org37bacff">The DataLoader</h4>
<div class="outline-text-4" id="text-org37bacff">
<div class="highlight">
<pre><span></span><span class="n">data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org302a98b">
<h2 id="org302a98b">Middle</h2>
<div class="outline-text-2" id="text-org302a98b"></div>
<div class="outline-3" id="outline-container-orgae7b466">
<h3 id="orgae7b466">The Data Generator</h3>
<div class="outline-text-3" id="text-orgae7b466">
<ul class="org-ul">
<li>While True loop: this will yield one batch at a time.</li>
<li>if index &gt;= num_lines, set index to 0.</li>
<li>The generator should return shuffled batches of data. To achieve this without modifying the actual lines a list containing the indexes of data_lines` is created. This list can be shuffled and used to get random batches everytime the index is reset.</li>
<li>if len(line) &lt; max_length append line to cur_batch.
<ul class="org-ul">
<li>Note that a line that has length equal to max_length should not be appended to the batch.</li>
<li>This is because when converting the characters into a tensor of integers, an additional end of sentence token id will be added.</li>
<li>So if max_length is 5, and a line has 4 characters, the tensor representing those 4 characters plus the end of sentence character will be f length 5, which is the max length.</li>
</ul>
</li>
<li>if len(cur_batch) == batch_size, go over every line, convert it to an int and store it.</li>
</ul>
<p><b>Remember that when calling np you are really calling trax.fastmath.numpy which is trax’s version of numpy that is compatible with JAX. As a result of this, where you used to encounter the type numpy.ndarray now you will find the type jax.interpreters.xla.DeviceArray.</b></p>
<p><b>Hints:</b></p>
<ul class="org-ul">
<li>Use the line_to_tensor function above inside a list comprehension in order to pad lines with zeros.</li>
<li>Keep in mind that the length of the tensor is always 1 + the length of the original line of characters. Keep this in mind when setting the padding of zeros.</li>
</ul>
<p>To get it to pass you'll have to pass in the <code>to-tensor</code> method of the <code>DataLoader</code> so we'll need to alias it to match their definition.</p>
<div class="highlight">
<pre><span></span><span class="n">line_to_tensor</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">to_tensor</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgbce3a82">
<h4 id="orgbce3a82">Implementing the Generator</h4>
<div class="outline-text-4" id="text-orgbce3a82">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                   <span class="n">line_to_tensor</span><span class="o">=</span><span class="n">line_to_tensor</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">"""Generator function that yields batches of data</span>

<span class="sd">    Args:</span>
<span class="sd">       batch_size (int): number of examples (in this case, sentences) per batch.</span>
<span class="sd">       max_length (int): maximum length of the output tensor.</span>
<span class="sd">       NOTE: max_length includes the end-of-sentence character that will be added</span>
<span class="sd">               to the tensor.  </span>
<span class="sd">               Keep in mind that the length of the tensor is always 1 + the length</span>
<span class="sd">               of the original line of characters.</span>
<span class="sd">       data_lines (list): list of the sentences to group into batches.</span>
<span class="sd">       line_to_tensor (function, optional): function that converts line to tensor. Defaults to line_to_tensor.</span>
<span class="sd">       shuffle (bool, optional): True if the generator should generate random batches of data. Defaults to True.</span>

<span class="sd">    Yields:</span>
<span class="sd">       tuple: two copies of the batch (jax.interpreters.xla.DeviceArray) and mask (jax.interpreters.xla.DeviceArray).</span>
<span class="sd">       NOTE: jax.interpreters.xla.DeviceArray is trax's version of numpy.ndarray</span>
<span class="sd">    """</span>
    <span class="c1"># initialize the index that points to the current position in the lines index array</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># initialize the list that will contain the current batch</span>
    <span class="n">cur_batch</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># count the number of lines in data_lines</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_lines</span><span class="p">)</span>

    <span class="c1"># create an array with the indexes of data_lines that can be shuffled</span>
    <span class="n">lines_index</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">num_lines</span><span class="p">)]</span>

    <span class="c1"># shuffle line indexes if shuffle is set to True</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines_index</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># if the index is greater or equal than to the number of lines in data_lines</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">num_lines</span><span class="p">:</span>
            <span class="c1"># then reset the index to 0</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># shuffle line indexes if shuffle is set to True</span>
            <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines_index</span><span class="p">)</span>

        <span class="c1"># get a line at the `lines_index[index]` position in data_lines</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">data_lines</span><span class="p">[</span><span class="n">lines_index</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>

        <span class="c1"># if the length of the line is less than max_length</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="c1"># append the line to the current batch</span>
            <span class="n">cur_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># increment the index by one</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># if the current batch is now equal to the desired batch size</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_batch</span><span class="p">)</span> <span class="o">==</span> <span class="n">batch_size</span><span class="p">:</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># go through each line (li) in cur_batch</span>
            <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">cur_batch</span><span class="p">:</span>
                <span class="c1"># convert the line (li) to a tensor of integers</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="n">line_to_tensor</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>

                <span class="c1"># Create a list of zeros to represent the padding</span>
                <span class="c1"># so that the tensor plus padding will have length `max_length`</span>
                <span class="n">pad</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="p">))</span>

                <span class="c1"># combine the tensor plus pad</span>
                <span class="n">tensor_pad</span> <span class="o">=</span> <span class="n">tensor</span> <span class="o">+</span> <span class="n">pad</span>

                <span class="c1"># append the padded tensor to the batch</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor_pad</span><span class="p">)</span>

                <span class="c1"># A mask for  tensor_pad is 1 wherever tensor_pad is not</span>
                <span class="c1"># 0 and 0 wherever tensor_pad is 0, i.e. if tensor_pad is</span>
                <span class="c1"># [1, 2, 3, 0, 0, 0] then example_mask should be</span>
                <span class="c1"># [1, 1, 1, 0, 0, 0]</span>
                <span class="c1"># Hint: Use a list comprehension for this</span>
                <span class="n">example_mask</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tensor_pad</span><span class="p">]</span>
                <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_mask</span><span class="p">)</span>

            <span class="c1"># convert the batch (data type list) to a trax's numpy array</span>
            <span class="n">batch_np_arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">mask_np_arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>


            <span class="c1"># Yield two copies of the batch and mask.</span>
            <span class="k">yield</span> <span class="n">batch_np_arr</span><span class="p">,</span> <span class="n">batch_np_arr</span><span class="p">,</span> <span class="n">mask_np_arr</span>

            <span class="c1"># reset the current batch to an empty list</span>
            <span class="n">cur_batch</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb3fe97a">
<h4 id="orgb3fe97a">Try out the data generator.</h4>
<div class="outline-text-4" id="text-orgb3fe97a">
<div class="highlight">
<pre><span></span><span class="n">tmp_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'12345678901'</span><span class="p">,</span>
             <span class="s1">'123456789'</span><span class="p">,</span>
             <span class="s1">'234567890'</span><span class="p">,</span>
             <span class="s1">'345678901'</span><span class="p">]</span>
</pre></div>
<p>Create a generator with a batch size of 2 and a maximum length of 10.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_data_gen</span> <span class="o">=</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                              <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                              <span class="n">data_lines</span><span class="o">=</span><span class="n">tmp_lines</span><span class="p">,</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<p>Get one batch.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tmp_data_gen</span><span class="p">)</span>
</pre></div>
<p>View the batch.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tmp_batch</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]))</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp_batch</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="nb">bool</span><span class="p">((</span><span class="n">batch</span><span class="o">==</span><span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<pre class="example">
(DeviceArray([[49, 50, 51, 52, 53, 54, 55, 56, 57,  1],
             [50, 51, 52, 53, 54, 55, 56, 57, 48,  1]], dtype=int32), DeviceArray([[49, 50, 51, 52, 53, 54, 55, 56, 57,  1],
             [50, 51, 52, 53, 54, 55, 56, 57, 48,  1]], dtype=int32), DeviceArray([[1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
             [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]], dtype=int32))
</pre>
<p>Now that you have your generator, you can just call them and they will return tensors which correspond to your lines in Shakespeare. The first column and the second column are identical. Now you can go ahead and start building your neural network.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb716386">
<h3 id="orgb716386">Repeating Batch generator</h3>
<div class="outline-text-3" id="text-orgb716386">
<p>The way the iterator is currently defined, it will keep providing batches forever.</p>
<p>Although it is not needed, we want to show you the <code>itertools.cycle</code> function which is really useful when you have a generator that eventually stops.</p>
<p>Usually we want to cycle over the dataset multiple times during training (i.e. train for multiple <b>epochs</b>).</p>
<p>For small datasets we can use <a href="https://docs.python.org/3.8/library/itertools.html#itertools.cycle"><code>itertools.cycle</code></a> to achieve this easily.</p>
<div class="highlight">
<pre><span></span><span class="n">infinite_data_generator</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span>
    <span class="n">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">data_lines</span><span class="o">=</span><span class="n">tmp_lines</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">ten_lines</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">infinite_data_generator</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ten_lines</span><span class="p">))</span>
</pre></div>
<pre class="example">
10
</pre></div>
</div>
<div class="outline-3" id="outline-container-orge52bbd9">
<h3 id="orge52bbd9">Bundle It Up</h3>
<div class="outline-text-3" id="text-orge52bbd9">
<p>As always, since this is going to be needed further down the road, I'll bundle it up.</p>
</div>
<div class="outline-4" id="outline-container-orgde66e12">
<h4 id="orgde66e12">Imports</h4>
<div class="outline-text-4" id="text-orgde66e12">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn.data_loader</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4fddc66">
<h4 id="org4fddc66">Data Generator</h4>
<div class="outline-text-4" id="text-org4fddc66">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataGenerator</span><span class="p">:</span>
    <span class="sd">"""Generates batches</span>

<span class="sd">    Args:</span>
<span class="sd">     data: lines of data</span>
<span class="sd">     data_loader: something with to-tensor method</span>
<span class="sd">     batch_size: size of the batches</span>
<span class="sd">     max_length: the maximum length for a line (longer lines will be ignored)</span>
<span class="sd">     shuffle: whether to shuffle the data</span>
<span class="sd">    """</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">data_loader</span><span class="p">:</span> <span class="n">DataLoader</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">_line_count</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span> <span class="kc">None</span>
    <span class="n">_line_indices</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_generator</span><span class="p">:</span> <span class="nb">object</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6c2d63e">
<h4 id="org6c2d63e">Line Count</h4>
<div class="outline-text-4" id="text-org6c2d63e">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">line_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Number of lines in the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_count</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc06983b">
<h4 id="orgc06983b">Line Indices</h4>
<div class="outline-text-4" id="text-orgc06983b">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">line_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Indices of the lines in the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_count</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc9c094c">
<h4 id="orgc9c094c">The Iterator Method</h4>
<div class="outline-text-4" id="text-orgc9c094c">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""A pass-through for this method"""</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf6f0498">
<h4 id="orgf6f0498">The Batch Generator</h4>
<div class="outline-text-4" id="text-orgf6f0498">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Generator method that yields batches of data</span>

<span class="sd">    Yields:</span>
<span class="sd">     (batch, batch, mask)</span>
<span class="sd">    """</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_batch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_indices</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_count</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">line_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
            <span class="n">current_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_batch</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">current_batch</span><span class="p">:</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">tensor</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="p">))</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
                <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tensor</span><span class="p">])</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">current_batch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org951e7dd">
<h4 id="org951e7dd">The Generator</h4>
<div class="outline-text-4" id="text-org951e7dd">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Infinite generator of batches"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_generator</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org756ca76">
<h4 id="org756ca76">The Next Method</h4>
<div class="outline-text-4" id="text-org756ca76">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""make this an iterator"""</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd78badb">
<h3 id="orgd78badb">Try It Out</h3>
<div class="outline-text-3" id="text-orgd78badb">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn</span> <span class="kn">import</span> <span class="n">DataGenerator</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
<span class="n">test_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'12345678901'</span><span class="p">,</span>
              <span class="s1">'123456789'</span><span class="p">,</span>
              <span class="s1">'234567890'</span><span class="p">,</span>
              <span class="s1">'345678901'</span><span class="p">]</span>

<span class="n">generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">test_lines</span><span class="p">,</span>
                          <span class="n">data_loader</span><span class="o">=</span><span class="n">loader</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">actual</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]))</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span><span class="nb">bool</span><span class="p">((</span><span class="n">batch</span><span class="o">==</span><span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/gru/" rel="tag">gru</a></li>
<li><a class="tag p-category" href="../../../categories/n-grams/" rel="tag">n-grams</a></li>
<li><a class="tag p-category" href="../../../categories/nlp/" rel="tag">nlp</a></li>
<li><a class="tag p-category" href="../../../categories/rnns/" rel="tag">rnns</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../deep-n-grams-generating-sentences/" rel="prev" title="Deep N-Grams: Generating Sentences">Previous post</a></li>
<li class="next"><a href="../rnns-and-vanishing-gradients/" rel="next" title="RNNS and Vanishing Gradients">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
