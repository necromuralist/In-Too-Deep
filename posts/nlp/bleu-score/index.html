<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Bleu Score | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/bleu-score/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../siamese-networks-new-questions/" rel="prev" title="Siamese Networks: New Questions" type="text/html">
<link href="../stack-semantics/" rel="next" title="Stack Semantics" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Bleu Score" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/bleu-score/" property="og:url">
<meta content="Table of Contents Calculating the Bilingual Evaluation Understudy (BLEU) score Imports Set Up Middle Part 1: BLEU Score Defining the BLEU Score Explaining the BLEU score N-Gram Precision (exam" property="og:description">
<meta content="article" property="og:type">
<meta content="2021-02-11T19:51:55-08:00" property="article:published_time">
<meta content="nlp" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Bleu Score</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2021-02-11T19:51:55-08:00" itemprop="datePublished" title="2021-02-11 19:51">2021-02-11 19:51</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5066aa3">Calculating the Bilingual Evaluation Understudy (BLEU) score</a>
<ul>
<li><a href="#org4fc337b">Imports</a></li>
<li><a href="#orgbb50f08">Set Up</a></li>
</ul>
</li>
<li><a href="#org67905a9">Middle</a>
<ul>
<li><a href="#orgc59f90d">Part 1: BLEU Score</a>
<ul>
<li><a href="#org7139423">Defining the BLEU Score</a></li>
<li><a href="#org2f6af78">Explaining the BLEU score</a></li>
<li><a href="#orga8754e8">N-Gram Precision (example)</a></li>
<li><a href="#org30ab0bd">N-gram BLEU score (example):</a></li>
<li><a href="#org00d47e7">Example Calculations of the BLEU score</a></li>
</ul>
</li>
<li><a href="#org98c3ae8">Part 2: BLEU computation on a corpus</a>
<ul>
<li><a href="#orge8c0db3">Loading Data Sets for Evaluation Using the BLEU Score</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org5066aa3">
<h2 id="org5066aa3">Calculating the Bilingual Evaluation Understudy (BLEU) score</h2>
<div class="outline-text-2" id="text-org5066aa3">
<p>We will be implementing a popular metric for evaluating the quality of machine-translated text: the <a href="https://en.wikipedia.org/wiki/BLEU">BLEU</a> score proposed by Kishore Papineni, et al. In their 2002 paper <a href="https://www.aclweb.org/anthology/P02-1040.pdf">"BLEU: a Method for Automatic Evaluation of Machine Translation"</a>, the BLEU score works by comparing "candidate" text to one or more "reference" translations. The result is better the closer the score is to 1. Let's see how to get this value in the following sections.</p>
</div>
<div class="outline-3" id="outline-container-org4fc337b">
<h3 id="org4fc337b">Imports</h3>
<div class="outline-text-3" id="text-org4fc337b">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">nltk.util</span> <span class="kn">import</span> <span class="n">ngrams</span>

<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">sacrebleu</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgbb50f08">
<h3 id="orgbb50f08">Set Up</h3>
<div class="outline-text-3" id="text-orgbb50f08">
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'punkt'</span><span class="p">)</span>
<span class="n">slug</span> <span class="o">=</span> <span class="s2">"bleu-score"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">slug</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Plot"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"width"</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">,</span> <span class="s2">"fontscale"</span><span class="p">,</span> <span class="s2">"tan"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">])</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>

<span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org67905a9">
<h2 id="org67905a9">Middle</h2>
<div class="outline-text-2" id="text-org67905a9"></div>
<div class="outline-3" id="outline-container-orgc59f90d">
<h3 id="orgc59f90d">Part 1: BLEU Score</h3>
<div class="outline-text-3" id="text-orgc59f90d">
<p>We will implement our own version of the BLEU Score using Numpy. To verify that our implementation is correct, we will compare our results with those generated by the <a href="https://github.com/mjpost/sacrebleu">SacreBLEU library</a>. This package provides hassle-free computation of shareable, comparable, and reproducible BLEU scores. It also knows all the standard test sets and handles downloading, processing, and tokenization.</p>
</div>
<div class="outline-4" id="outline-container-org7139423">
<h4 id="org7139423">Defining the BLEU Score</h4>
<div class="outline-text-4" id="text-org7139423">
<p>We can express the BLEU score as:</p>
<p>\[ BLEU = BP\left(\prod_{i=1}^{4}precision_i\right)^{(1/4)} \]</p>
<p>with the <i>Brevity Penalty</i> and <i>precision</i> defined as:</p>
<p>\[ BP = min\left(1, e^{(1-(\textit{reference}/\textit{candidate}))}\right) \]</p>
<p>\[ precision_i = \frac {\sum_{snt \in{cand}}\sum_{i\in{snt}}min\Bigl(m^{i}_{cand}, m^{i}_{ref}\Bigr)}{w^{i}_{t}} \]</p>
<p>where:</p>
<ul class="org-ul">
<li>\(m^{i}_{cand}\), is the count of i-gram in candidate matching the reference translation.</li>
<li>\(m^{i}_{ref}\), is the count of i-gram in the reference translation.</li>
<li>\(w^{i}_{t}\), is the total number of i-grams in candidate translation.</li>
</ul>
</div>
</div>
<div class="outline-4" id="outline-container-org2f6af78">
<h4 id="org2f6af78">Explaining the BLEU score</h4>
<div class="outline-text-4" id="text-org2f6af78"></div>
<ul class="org-ul">
<li><a id="org43530e9"></a>Brevity Penalty (example)<br>
<div class="outline-text-5" id="text-org43530e9">
<div class="highlight">
<pre><span></span><span class="n">ref_length</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">can_length</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ref_length</span> <span class="o">/</span> <span class="n">can_length</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">brevity_penalty</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">"Reference Length/Candidate Length"</span><span class="p">:</span> <span class="n">x</span>
                                    <span class="p">,</span> <span class="s2">"Brevity Penalty"</span><span class="p">:</span> <span class="n">brevity_penalty</span><span class="p">})</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Reference Length/Candidate Length"</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="s2">"Brevity Penalty"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Brevity Penalty"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">fontscale</span>    
<span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"brevity_penalty"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="brevity_penalty.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The <i>brevity penalty</i> penalizes generated translations that are too short compared to the closest reference length with an exponential decay. The brevity penalty compensates for the fact that the BLEU score has no recall term.</p>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orga8754e8">
<h4 id="orga8754e8">N-Gram Precision (example)</h4>
<div class="outline-text-4" id="text-orga8754e8">
<p>And now for a meaningless plot.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">"1-gram"</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">],</span>
                                   <span class="s2">"2-gram"</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">],</span>
                                   <span class="s2">"3-gram"</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">],</span>
                                   <span class="s2">"4-gram"</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]})</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"N-Gram Precision"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"n_gram_precision"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="n_gram_precision.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The n-gram precision counts how many unigrams, bigrams, trigrams, and four-grams (i=1,…,4) match their n-gram counterpart in the reference translations. This term acts as a precision metric. Unigrams account for adequacy while longer n-grams account for fluency of the translation. To avoid overcounting, the n-gram counts are clipped to the maximal n-gram count occurring in the reference (\(m_{n}^{ref}\)). Typically precision shows exponential decay with the with the degree of the n-gram.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org30ab0bd">
<h4 id="org30ab0bd">N-gram BLEU score (example):</h4>
<div class="outline-text-4" id="text-org30ab0bd">
<p>Another meaningless plot.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">"1-gram"</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">],</span>
                                   <span class="s2">"2-gram"</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.77</span><span class="p">],</span>
                                   <span class="s2">"3-gram"</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.74</span><span class="p">],</span>
                                   <span class="s2">"4-gram"</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.71</span><span class="p">]})</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Modified N-Gram Precision"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">fontscale</span>
<span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"modified_n_gram_precision"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="modified_n_gram_precision.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>When the n-gram precision is multiplied by the BP, then the exponential decay of n-grams is almost fully compensated. The BLEU score corresponds to a geometric average of this modified n-gram precision.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org00d47e7">
<h4 id="org00d47e7">Example Calculations of the BLEU score</h4>
<div class="outline-text-4" id="text-org00d47e7">
<p>In this example we will have a reference translation and 2 candidates translations. We will tokenize all sentences using the NLTK.</p>
</div>
<ul class="org-ul">
<li><a id="org5a2579f"></a>Step 1: Computing the Brevity Penalty<br>
<div class="outline-text-5" id="text-org5a2579f">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">brevity_penalty</span><span class="p">(</span><span class="n">candidate</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">reference</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""Calculates the brevity penalty"""</span>
    <span class="n">reference_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">candidate_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>

    <span class="c1"># Brevity Penalty</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">reference_length</span> <span class="o">&lt;</span> <span class="n">candidate_length</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">reference_length</span> <span class="o">/</span> <span class="n">candidate_length</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><a id="orgffe5946"></a>Step 2: Computing the Precision<br>
<div class="outline-text-5" id="text-orgffe5946">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">clipped_precision</span><span class="p">(</span><span class="n">candidate</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">reference</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Clipped precision function given a original and a machine translated sentences</span>
<span class="sd">    """</span>
    <span class="n">clipped_precision_score</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">ref_n_gram</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">ngrams</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
        <span class="n">cand_n_gram</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">ngrams</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>

        <span class="n">c</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cand_n_gram</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cand_n_gram</span><span class="p">:</span> <span class="c1"># for every n-gram up to 4 in candidate text</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ref_n_gram</span><span class="p">:</span> <span class="c1"># check if it is in the reference n-gram</span>
                <span class="k">if</span> <span class="n">cand_n_gram</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ref_n_gram</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span> <span class="c1"># if the count of the candidate n-gram is bigger</span>
                                                   <span class="c1"># than the corresponding count in the reference n-gram,</span>
                    <span class="n">cand_n_gram</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_n_gram</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="c1"># then set the count of the candidate n-gram to be equal</span>
                                                   <span class="c1"># to the reference n-gram</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cand_n_gram</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># else set the candidate n-gram equal to zero</span>

        <span class="n">clipped_precision_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">cand_n_gram</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">/</span><span class="n">c</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>

    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_i</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">p_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">clipped_precision_score</span><span class="p">))</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fsum</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">s</span>
</pre></div>
</div>
</li>
<li><a id="org4e06802"></a>Step 3: Computing the BLEU score<br>
<div class="outline-text-5" id="text-org4e06802">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">bleu_score</span><span class="p">(</span><span class="n">candidate</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">reference</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">BP</span> <span class="o">=</span> <span class="n">brevity_penalty</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">clipped_precision</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">BP</span> <span class="o">*</span> <span class="n">precision</span>
</pre></div>
</div>
</li>
<li><a id="org2d74d05"></a>Step 4: Testing with our Example Reference and Candidates Sentences<br>
<div class="outline-text-5" id="text-org2d74d05">
<div class="highlight">
<pre><span></span><span class="n">reference</span> <span class="o">=</span> <span class="s2">"The NASA Opportunity rover is battling a massive dust storm on planet Mars."</span>
<span class="n">candidate_1</span> <span class="o">=</span> <span class="s2">"The Opportunity rover is combating a big sandstorm on planet Mars."</span>
<span class="n">candidate_2</span> <span class="o">=</span> <span class="s2">"A NASA rover is fighting a massive storm on planet Mars."</span>

<span class="n">tokenized_ref</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<span class="n">tokenized_cand_1</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">candidate_1</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<span class="n">tokenized_cand_2</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">candidate_2</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="s2">"Results reference versus candidate 1 our own code BLEU: "</span><span class="p">,</span>
    <span class="nb">round</span><span class="p">(</span><span class="n">bleu_score</span><span class="p">(</span><span class="n">tokenized_cand_1</span><span class="p">,</span> <span class="n">tokenized_ref</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
<pre class="example">
Results reference versus candidate 1 our own code BLEU:  27.6
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="s2">"Results reference versus candidate 2 our own code BLEU: "</span><span class="p">,</span>
    <span class="nb">round</span><span class="p">(</span><span class="n">bleu_score</span><span class="p">(</span><span class="n">tokenized_cand_2</span><span class="p">,</span> <span class="n">tokenized_ref</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
<pre class="example">
Results reference versus candidate 2 our own code BLEU:  35.3
</pre></div>
</li>
<li><a id="org993f82d"></a>Step 5: Comparing the Results from our Code with the SacreBLEU Library<br>
<div class="outline-text-5" id="text-org993f82d">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="s2">"Results reference versus candidate 1 sacrebleu library BLEU: "</span><span class="p">,</span>
    <span class="nb">round</span><span class="p">(</span><span class="n">sacrebleu</span><span class="o">.</span><span class="n">corpus_bleu</span><span class="p">(</span><span class="n">candidate_1</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
<pre class="example">
Results reference versus candidate 1 sacrebleu library BLEU:  27.6
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="s2">"Results reference versus candidate 2 sacrebleu library BLEU: "</span><span class="p">,</span>
    <span class="nb">round</span><span class="p">(</span><span class="n">sacrebleu</span><span class="o">.</span><span class="n">corpus_bleu</span><span class="p">(</span><span class="n">candidate_2</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
<pre class="example">
Results reference versus candidate 2 sacrebleu library BLEU:  35.3
</pre></div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org98c3ae8">
<h3 id="org98c3ae8">Part 2: BLEU computation on a corpus</h3>
<div class="outline-text-3" id="text-org98c3ae8"></div>
<div class="outline-4" id="outline-container-orge8c0db3">
<h4 id="orge8c0db3">Loading Data Sets for Evaluation Using the BLEU Score</h4>
<div class="outline-text-4" id="text-orge8c0db3">
<p>In this section, we will show a simple pipeline for evaluating machine translated text. Due to storage and speed constraints, we will not be using our own model in this lab. Instead, we will be using <a href="https://translate.google.com">Google Translate</a> to generate English to German translations and we will evaluate it against a known evaluation set. There are three files we will need:</p>
<ol class="org-ol">
<li>A source text in English. In this lab, we will use the first 1671 words of the <a href="http://statmt.org/wmt19/translation-task.html">wmt19</a> evaluation dataset downloaded via SacreBLEU. We just grabbed a subset because of limitations in the number of words that can be translated using Google Translate.</li>
<li>A reference translation to German of the corresponding first 1671 words from the original English text. This is also provided by SacreBLEU.</li>
<li>A candidate machine translation to German from the same 1671 words. This is generated by feeding the source text to a machine translation model. As mentioned above, we will use Google Translate to generate the translations in this file.</li>
</ol>
<p>With that, we can now compare the reference an candidate translation to get the BLEU Score.</p>
<p>Load the raw data.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"WMT19_SOURCE"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">wmt19_src_1</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"WMT19_REFERENCE"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">wmt19_ref_1</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"WMT19_CANDIDATE"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">wmt19_can_1</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">tokenized_corpus_src</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">wmt19_src_1</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<span class="n">tokenized_corpus_ref</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">wmt19_ref_1</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<span class="n">tokenized_corpus_cand</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">wmt19_can_1</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>    
</pre></div>
<p>Inspecting the first sentence of the data.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"English source text:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">wmt19_src_1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">170</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tokenized_corpus_src</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"German reference translation:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">wmt19_ref_1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">219</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tokenized_corpus_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">35</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"German machine translation:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">wmt19_can_1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">199</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tokenized_corpus_cand</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">29</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org18909cd">
English source text:

﻿Welsh AMs worried about 'looking like muppets'
There is consternation among some AMs at a suggestion their title should change to MWPs (Member of the Welsh Parliament).
 -&gt; ['\ufeffwelsh', 'ams', 'worried', 'about', "'looking", 'like', "muppets'", 'there', 'is', 'consternation', 'among', 'some', 'ams', 'at', 'a', 'suggestion', 'their', 'title', 'should', 'change', 'to', 'mwps', '(', 'member', 'of', 'the', 'welsh', 'parliament', ')', '.']

German reference translation:

﻿Walisische Ageordnete sorgen sich "wie Dödel auszusehen"
Es herrscht Bestürzung unter einigen Mitgliedern der Versammlung über einen Vorschlag, der ihren Titel zu MWPs (Mitglied der walisischen Parlament) ändern soll.
 -&gt; ['\ufeffwalisische', 'ageordnete', 'sorgen', 'sich', '``', 'wie', 'dödel', 'auszusehen', "''", 'es', 'herrscht', 'bestürzung', 'unter', 'einigen', 'mitgliedern', 'der', 'versammlung', 'über', 'einen', 'vorschlag', ',', 'der', 'ihren', 'titel', 'zu', 'mwps', '(', 'mitglied', 'der', 'walisischen', 'parlament', ')', 'ändern', 'soll', '.']

German machine translation:

Walisische AMs machten sich Sorgen, dass sie wie Muppets aussehen könnten
Einige AMs sind bestürzt über den Vorschlag, ihren Titel in MWPs (Mitglied des walisischen Parlaments) zu ändern.
Es ist aufg -&gt; ['walisische', 'ams', 'machten', 'sich', 'sorgen', ',', 'dass', 'sie', 'wie', 'muppets', 'aussehen', 'könnten', 'einige', 'ams', 'sind', 'bestürzt', 'über', 'den', 'vorschlag', ',', 'ihren', 'titel', 'in', 'mwps', '(', 'mitglied', 'des', 'walisischen', 'parlaments']
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="s2">"Results reference versus candidate 1 our own BLEU implementation: "</span><span class="p">,</span>
    <span class="nb">round</span><span class="p">(</span><span class="n">bleu_score</span><span class="p">(</span><span class="n">tokenized_corpus_cand</span><span class="p">,</span> <span class="n">tokenized_corpus_ref</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
<pre class="example">
Results reference versus candidate 1 our own BLEU implementation:  43.6
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="s2">"Results reference versus candidate 1 sacrebleu library BLEU: "</span><span class="p">,</span>
    <span class="nb">round</span><span class="p">(</span><span class="n">sacrebleu</span><span class="o">.</span><span class="n">corpus_bleu</span><span class="p">(</span><span class="n">wmt19_can_1</span><span class="p">,</span> <span class="n">wmt19_ref_1</span><span class="p">)</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
<pre class="example">
Results reference versus candidate 1 sacrebleu library BLEU:  43.2
</pre>
<p><b>BLEU Score Interpretation on a Corpus</b></p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Score</th>
<th class="org-left" scope="col">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">&lt; 10</td>
<td class="org-left">Almost useless</td>
</tr>
<tr>
<td class="org-left">10 - 19</td>
<td class="org-left">Hard to get the gist</td>
</tr>
<tr>
<td class="org-left">20 - 29</td>
<td class="org-left">The gist is clear, but has significant grammatical errors</td>
</tr>
<tr>
<td class="org-left">30 - 40</td>
<td class="org-left">Understandable to good translations</td>
</tr>
<tr>
<td class="org-left">40 - 50</td>
<td class="org-left">High quality translations</td>
</tr>
<tr>
<td class="org-left">50 - 60</td>
<td class="org-left">Very high quality, adequate, and fluent translations</td>
</tr>
<tr>
<td class="org-left">&gt; 60</td>
<td class="org-left">Quality often better than human</td>
</tr>
</tbody>
</table>
<p>From the table above (taken from <a href="https://cloud.google.com/translate/automl/docs/evaluate">here</a>), we can see the translation is high quality (<b>if you see "Hard to get the gist", please open your workspace, delete `wmt19_can.txt` and get the latest version via the Lab Help button</b>). Moreover, the results of our coded BLEU score are almost identical to those of the SacreBLEU package.</p>
</div>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/nlp/" rel="tag">nlp</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../siamese-networks-new-questions/" rel="prev" title="Siamese Networks: New Questions">Previous post</a></li>
<li class="next"><a href="../stack-semantics/" rel="next" title="Stack Semantics">Next post</a></li>
</ul>
</nav>
</aside>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']],},

        });
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script></article>
<!--End of body content-->
<footer id="footer"><a href="https://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://licensebuttons.net/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
