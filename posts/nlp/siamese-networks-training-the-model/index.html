<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Training the Siamese Network Model." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Siamese Networks: Training the Model | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/siamese-networks-training-the-model/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../siamese-networks-hard-negative-mining/" rel="prev" title="Siamese Networks: Hard Negative Mining" type="text/html">
<link href="../siamese-networks-evaluating-the-model/" rel="next" title="Siamese Networks: Evaluating the Model" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Siamese Networks: Training the Model" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/siamese-networks-training-the-model/" property="og:url">
<meta content="Training the Siamese Network Model." property="og:description">
<meta content="article" property="og:type">
<meta content="2021-01-25T19:38:08-08:00" property="article:published_time">
<meta content="nlp" property="article:tag">
<meta content="siamese networks" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Siamese Networks: Training the Model</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2021-01-25T19:38:08-08:00" itemprop="datePublished" title="2021-01-25 19:38">2021-01-25 19:38</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org83121db">Beginning</a>
<ul>
<li><a href="#org342bb9f">Imports</a></li>
<li><a href="#org89866f9">Set Up</a>
<ul>
<li><a href="#org632ee57">The Timer And Plotting</a></li>
<li><a href="#orgb8159f8">The Data</a></li>
<li><a href="#orgef67788">The Data generator</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org32b90c6">Middle</a>
<ul>
<li><a href="#org4145c13">Training the Model</a></li>
<li><a href="#org745c728">Training</a>
<ul>
<li><a href="#org1b5676e">Trial Two</a></li>
<li><a href="#org96feb22">Trial Three</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org83121db">
<h2 id="org83121db">Beginning</h2>
<div class="outline-text-2" id="text-org83121db">
<p>Now we are going to train the Siamese Network Model model. As usual, we have to define the cost function and the optimizer. We also have to feed in the built model. Before, going into the training, we will use a special data set up. We will define the inputs using the data generator we built above. The lambda function acts as a seed to remember the last batch that was given. Run the cell below to get the question pairs inputs.</p>
</div>
<div class="outline-3" id="outline-container-org342bb9f">
<h3 id="org342bb9f">Imports</h3>
<div class="outline-text-3" id="text-org342bb9f">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryFile</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">holoviews</span> <span class="kn">import</span> <span class="n">opts</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">trax</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.siamese_networks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DataGenerator</span><span class="p">,</span>
    <span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">SiameseModel</span><span class="p">,</span>
    <span class="n">TOKENS</span><span class="p">,</span>
    <span class="n">triplet_loss_layer</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">Timer</span><span class="p">,</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org89866f9">
<h3 id="org89866f9">Set Up</h3>
<div class="outline-text-3" id="text-org89866f9"></div>
<div class="outline-4" id="outline-container-org632ee57">
<h4 id="org632ee57">The Timer And Plotting</h4>
<div class="outline-text-4" id="text-org632ee57">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">slug</span> <span class="o">=</span> <span class="s2">"siamese-networks-training-the-model"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">slug</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Plot"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"width"</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">,</span> <span class="s2">"fontscale"</span><span class="p">,</span> <span class="s2">"tan"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">])</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb8159f8">
<h4 id="orgb8159f8">The Data</h4>
<div class="outline-text-4" id="text-orgb8159f8">
<div class="highlight">
<pre><span></span><span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgef67788">
<h4 id="orgef67788">The Data generator</h4>
<div class="outline-text-4" id="text-orgef67788">
<div class="highlight">
<pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">train_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">question_one</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">question_two</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">validation_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">question_one</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">question_two</span><span class="p">,</span>
                                     <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"training question 1 rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">question_one</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"validation question 1 rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">question_one</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
training question 1 rows: 89,179
validation question 1 rows: 22,295
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org32b90c6">
<h2 id="org32b90c6">Middle</h2>
<div class="outline-text-2" id="text-org32b90c6"></div>
<div class="outline-3" id="outline-container-org4145c13">
<h3 id="org4145c13">Training the Model</h3>
<div class="outline-text-3" id="text-org4145c13">
<p>We will now write a function that takes in the model and trains it. To train the model we have to decide how many times to iterate over the entire data set; each iteration is defined as an <code>epoch</code>. For each epoch, you have to go over all the data, using the training iterator.</p>
<ul class="org-ul">
<li>Create <code>TrainTask</code> and <code>EvalTask</code></li>
<li>Create the training loop <code>trax.supervised.training.Loop</code></li>
<li>Pass in the following depending on the context (train_task or eval_task):
<ul class="org-ul">
<li><code>labeled_data=generator</code></li>
<li><code>metrics</code>[TripletLoss()]=,</li>
<li><code>loss_layer=TripletLoss()</code></li>
<li><code>optimizer=trax.optimizers.Adam</code> with learning rate of 0.01</li>
<li><code>lr_schedule=lr_schedule</code>,</li>
<li><code>output_dir=output_dir</code></li>
</ul>
</li>
</ul>
<p>We will be using the triplet loss function with Adam optimizer. Please read the <a href="https://trax-ml.readthedocs.io/en/latest/trax.optimizers.html?highlight=adam#trax.optimizers.adam.Adam">trax Adam</a> documentation to get a full understanding.</p>
<p>This function should return a <code>training.Loop</code> object. To read more about this check the <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html?highlight=loop#trax.supervised.training.Loop">training.Loop</a> documentation.</p>
<div class="highlight">
<pre><span></span><span class="n">lr_schedule</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">lr</span><span class="o">.</span><span class="n">warmup_and_rsqrt_decay</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">Siamese</span><span class="p">,</span> <span class="n">TripletLoss</span><span class="p">,</span> <span class="n">lr_schedule</span><span class="p">,</span> <span class="n">train_generator</span><span class="o">=</span><span class="n">train_generator</span><span class="p">,</span> <span class="n">val_generator</span><span class="o">=</span><span class="n">validation_generator</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">"~/models/siamese_networks/"</span><span class="p">,</span>
                <span class="n">steps_per_checkpoint</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">"""Training the Siamese Model</span>

<span class="sd">    Args:</span>
<span class="sd">       Siamese (function): Function that returns the Siamese model.</span>
<span class="sd">       TripletLoss (function): Function that defines the TripletLoss loss function.</span>
<span class="sd">       lr_schedule (function): Trax multifactor schedule function.</span>
<span class="sd">       train_generator (generator, optional): Training generator. Defaults to train_generator.</span>
<span class="sd">       val_generator (generator, optional): Validation generator. Defaults to val_generator.</span>
<span class="sd">       output_dir (str, optional): Path to save model to. Defaults to 'model/'.</span>

<span class="sd">    Returns:</span>
<span class="sd">       trax.supervised.training.Loop: Training loop for the model.</span>
<span class="sd">    """</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>

    <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>

    <span class="n">train_task</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">supervised</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">(</span>
        <span class="n">labeled_data</span><span class="o">=</span><span class="n">train_generator</span><span class="p">,</span>       <span class="c1"># Use generator (train)</span>
        <span class="n">loss_layer</span><span class="o">=</span><span class="n">TripletLoss</span><span class="p">(),</span>         <span class="c1"># Use triplet loss. Don't forget to instantiate this object</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">trax</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>          <span class="c1"># Don't forget to add the learning rate parameter</span>
        <span class="n">lr_schedule</span><span class="o">=</span><span class="n">lr_schedule</span><span class="p">,</span> <span class="c1"># Use Trax multifactor schedule function</span>
        <span class="n">n_steps_per_checkpoint</span><span class="o">=</span><span class="n">steps_per_checkpoint</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">eval_task</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">supervised</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">(</span>
        <span class="n">labeled_data</span><span class="o">=</span><span class="n">val_generator</span><span class="p">,</span>       <span class="c1"># Use generator (val)</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">TripletLoss</span><span class="p">()],</span>          <span class="c1"># Use triplet loss. Don't forget to instantiate this object</span>
    <span class="p">)</span>

    <span class="c1">### END CODE HERE ###</span>

    <span class="n">training_loop</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">supervised</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">(</span><span class="n">Siamese</span><span class="p">,</span>
                                                  <span class="p">[</span><span class="n">train_task</span><span class="p">],</span>
                                                  <span class="n">eval_tasks</span><span class="o">=</span><span class="p">[</span><span class="n">eval_task</span><span class="p">],</span>
                                                  <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">training_loop</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org745c728">
<h3 id="org745c728">Training</h3>
<div class="outline-text-3" id="text-org745c728"></div>
<div class="outline-4" id="outline-container-org1b5676e">
<h4 id="org1b5676e">Trial Two</h4>
<div class="outline-text-4" id="text-org1b5676e">
<p><b>Note:</b> I re-ran this next code block so it's actually the second run.</p>
<div class="highlight">
<pre><span></span><span class="n">train_steps</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">siamese</span> <span class="o">=</span> <span class="n">SiameseModel</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">))</span>
<span class="n">training_loop</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">siamese</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">triplet_loss_layer</span><span class="p">,</span> <span class="n">lr_schedule</span><span class="p">,</span> <span class="n">steps_per_checkpoint</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">real_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

<span class="n">TIMER</span><span class="o">.</span><span class="n">emit</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">TIMER</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">with</span> <span class="n">TemporaryFile</span><span class="p">(</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">temp_file</span>
    <span class="n">training_loop</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_steps</span><span class="p">)</span>
<span class="n">TIMER</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">real_stdout</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">TIMER</span><span class="o">.</span><span class="n">ended</span> <span class="o">-</span> <span class="n">TIMER</span><span class="o">.</span><span class="n">started</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0:19:46.056057
</pre>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">training_loop</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">training_loop</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">metrics_for_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
</pre></div>
<pre class="example">
eval
['metrics/TripletLoss']
train
['metrics/TripletLoss', 'training/gradients_l2', 'training/learning_rate', 'training/loss', 'training/steps per second', 'training/weights_l2']
</pre></div>
<ul class="org-ul">
<li><a id="org2a71d7e"></a>Plotting the Metrics<br>
<div class="outline-text-5" id="text-org2a71d7e">
<p><b>Note:</b> As of February 2021, the version of trax on pypi doesn't have a <i>history</i> attribute - to get it you have to install the code from the github repository.</p>
<div class="highlight">
<pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_loop</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"eval"</span><span class="p">,</span> <span class="s2">"metrics/TripletLoss"</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="s2">"Batch TripletLoss"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">minimum</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">TripletLoss</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]</span>
<span class="n">vline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">minimum</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">hline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">minimum</span><span class="o">.</span><span class="n">TripletLoss</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Batch"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"TripletLoss"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">blue</span><span class="p">))</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">*</span> <span class="n">hline</span> <span class="o">*</span> <span class="n">vline</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Evaluation Batch Triplet Loss"</span><span class="p">,</span>
                                   <span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"evaluation_triplet_loss"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="evaluation_triplet_loss.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>It looks the loss is stabilizing. If it doesn't perform well I'll re-train it.</p>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org96feb22">
<h4 id="org96feb22">Trial Three</h4>
<div class="outline-text-4" id="text-org96feb22">
<p>Let's see if the continues going down.</p>
<div class="highlight">
<pre><span></span><span class="n">train_steps</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">siamese</span> <span class="o">=</span> <span class="n">SiameseModel</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">))</span>
<span class="n">training_loop</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">siamese</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">triplet_loss_layer</span><span class="p">,</span> <span class="n">lr_schedule</span><span class="p">,</span> <span class="n">steps_per_checkpoint</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">real_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

<span class="n">TIMER</span><span class="o">.</span><span class="n">emit</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">TIMER</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">with</span> <span class="n">TemporaryFile</span><span class="p">(</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">temp_file</span>
    <span class="n">training_loop</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_steps</span><span class="p">)</span>
<span class="n">TIMER</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">real_stdout</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">TIMER</span><span class="o">.</span><span class="n">ended</span> <span class="o">-</span> <span class="n">TIMER</span><span class="o">.</span><span class="n">started</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0:17:41.167719
</pre></div>
<ul class="org-ul">
<li><a id="org4823356"></a>Plotting the Metrics<br>
<div class="outline-text-5" id="text-org4823356">
<div class="highlight">
<pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">training_loop</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"eval"</span><span class="p">,</span> <span class="s2">"metrics/TripletLoss"</span><span class="p">),</span>
    <span class="n">columns</span><span class="o">=</span><span class="s2">"Batch TripletLoss"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">minimum</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">TripletLoss</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]</span>
<span class="n">vline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">minimum</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">hline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">minimum</span><span class="o">.</span><span class="n">TripletLoss</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Batch"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"TripletLoss"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">blue</span><span class="p">))</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">*</span> <span class="n">hline</span> <span class="o">*</span> <span class="n">vline</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Evaluation Batch Triplet Loss (Third Run)"</span><span class="p">,</span>
                                   <span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"evaluation_triplet_loss_third"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="evaluation_triplet_loss.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>It looks like it stopped improving. Probably time to stop.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/nlp/" rel="tag">nlp</a></li>
<li><a class="tag p-category" href="../../../categories/siamese-networks/" rel="tag">siamese networks</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../siamese-networks-hard-negative-mining/" rel="prev" title="Siamese Networks: Hard Negative Mining">Previous post</a></li>
<li class="next"><a href="../siamese-networks-evaluating-the-model/" rel="next" title="Siamese Networks: Evaluating the Model">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer"><a href="https://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://licensebuttons.net/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
