<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Loading the data for the deep learning model." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Sentiment Analysis: Pre-processing the Data | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/sentiment-analysis-pre-processing-the-data/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../sentiment-analysis-deep-learning-model/" rel="prev" title="Sentiment Analysis: Deep Learning Model" type="text/html">
<link href="../sentiment-analysis-defining-the-model/" rel="next" title="Sentiment Analysis: Defining the Model" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Sentiment Analysis: Pre-processing the Data" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/sentiment-analysis-pre-processing-the-data/" property="og:url">
<meta content="Loading the data for the deep learning model." property="og:description">
<meta content="article" property="og:type">
<meta content="2020-12-23T15:43:02-08:00" property="article:published_time">
<meta content="deep learning" property="article:tag">
<meta content="nlp" property="article:tag">
<meta content="sentiment analysis" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Sentiment Analysis: Pre-processing the Data</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2020-12-23T15:43:02-08:00" itemprop="datePublished" title="2020-12-23 15:43">2020-12-23 15:43</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0858681">Beginning</a>
<ul>
<li>
<ul>
<li><a href="#org6aa75ed">Imports</a></li>
</ul>
</li>
<li><a href="#orgbd82533">Set Up</a></li>
</ul>
</li>
<li><a href="#org90aea4e">Middle</a>
<ul>
<li><a href="#org37fab45">The NLTK Data</a></li>
<li><a href="#org821793b">Split It Up</a>
<ul>
<li><a href="#orga82dd67">Split positive set into validation and training</a></li>
<li><a href="#org10ee461">Split negative set into validation and training</a></li>
<li><a href="#orge16f3ed">Combine the Data Sets</a></li>
</ul>
</li>
<li><a href="#org3e42e4b">Building the vocabulary</a></li>
<li><a href="#orgcc429fb">Converting a tweet to a tensor</a></li>
<li><a href="#orgc5c2a25">Creating a batch generator</a>
<ul>
<li><a href="#orge92f2b2">data_generator</a></li>
<li><a href="#orgcdcd890">Test the train_generator</a></li>
</ul>
</li>
<li><a href="#org71e5bf2">Bundle It Up</a>
<ul>
<li><a href="#orgfbfdfb8">Imports</a></li>
<li><a href="#org1b664b2">Defaults</a></li>
<li><a href="#orgac6ad75">NLTK Settings</a></li>
<li><a href="#org93d0480">Special Tokens</a></li>
<li><a href="#orgc9a5392">The Builder</a></li>
<li><a href="#org41811b5">The Generator</a></li>
</ul>
</li>
<li><a href="#org1cf6073">Test It Out</a></li>
</ul>
</li>
<li><a href="#org5e716e9">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org0858681">
<h2 id="org0858681">Beginning</h2>
<div class="outline-text-2" id="text-org0858681">
<p>This is the next in a series about building a Deep Learning model for sentiment analysis. The first post was <a href="../sentiment-analysis-deep-learning-model/">this one</a>.</p>
</div>
<div class="outline-4" id="outline-container-org6aa75ed">
<h4 id="org6aa75ed">Imports</h4>
<div class="outline-text-4" id="text-org6aa75ed">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">contain_exactly</span><span class="p">,</span> <span class="n">equal</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>

<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgbd82533">
<h3 id="orgbd82533">Set Up</h3>
<div class="outline-text-3" id="text-orgbd82533">
<p>The NLTK data has to be downloaded at least once.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">"twitter_samples"</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="s2">"~/data/datasets/nltk_data/"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org90aea4e">
<h2 id="org90aea4e">Middle</h2>
<div class="outline-text-2" id="text-org90aea4e"></div>
<div class="outline-3" id="outline-container-org37fab45">
<h3 id="org37fab45">The NLTK Data</h3>
<div class="outline-text-3" id="text-org37fab45">
<div class="highlight">
<pre><span></span><span class="n">positive</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s1">'positive_tweets.json'</span><span class="p">)</span>
<span class="n">negative</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s1">'negative_tweets.json'</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Positive Tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Negative Tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">negative</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Positive Tweets: 5,000
Negative Tweets: 5,000
</pre></div>
</div>
<div class="outline-3" id="outline-container-org821793b">
<h3 id="org821793b">Split It Up</h3>
<div class="outline-text-3" id="text-org821793b">
<p>Instead of randomly splitting the data we're going to do a straight slice.</p>
<div class="highlight">
<pre><span></span><span class="n">SPLIT</span> <span class="o">=</span> <span class="mi">4000</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orga82dd67">
<h4 id="orga82dd67">Split positive set into validation and training</h4>
<div class="outline-text-4" id="text-orga82dd67">
<div class="highlight">
<pre><span></span><span class="n">positive_validation</span>   <span class="o">=</span> <span class="n">positive</span><span class="p">[</span><span class="n">SPLIT</span><span class="p">:]</span>
<span class="n">positive_training</span>  <span class="o">=</span> <span class="n">positive</span><span class="p">[:</span><span class="n">SPLIT</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org10ee461">
<h4 id="org10ee461">Split negative set into validation and training</h4>
<div class="outline-text-4" id="text-org10ee461">
<div class="highlight">
<pre><span></span><span class="n">negative_validation</span> <span class="o">=</span> <span class="n">negative</span><span class="p">[</span><span class="n">SPLIT</span><span class="p">:]</span>
<span class="n">negative_training</span>  <span class="o">=</span> <span class="n">negative</span><span class="p">[:</span><span class="n">SPLIT</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge16f3ed">
<h4 id="orge16f3ed">Combine the Data Sets</h4>
<div class="outline-text-4" id="text-orge16f3ed">
<p>The X data.</p>
<div class="highlight">
<pre><span></span><span class="n">train_x</span> <span class="o">=</span> <span class="n">positive_training</span> <span class="o">+</span> <span class="n">negative_training</span>
<span class="n">validation_x</span> <span class="o">=</span> <span class="n">positive_validation</span> <span class="o">+</span> <span class="n">negative_validation</span>
</pre></div>
<p>The labels (1 for positive, 0 for negative).</p>
<div class="highlight">
<pre><span></span><span class="n">train_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positive_training</span><span class="p">)),</span>
                       <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">negative_training</span><span class="p">)))</span>
<span class="n">validation_y</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positive_validation</span><span class="p">)),</span>
                             <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">negative_validation</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"length of train_x </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"length of validation_x </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_x</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
length of train_x 8,000
length of validation_x 2,000
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org3e42e4b">
<h3 id="org3e42e4b">Building the vocabulary</h3>
<div class="outline-text-3" id="text-org3e42e4b">
<p>Now build the vocabulary.</p>
<ul class="org-ul">
<li>Map each word in each tweet to an integer (an "index").</li>
<li>The following code does this for you, but please read it and understand what it's doing.</li>
<li>Note that you will build the vocabulary based on the training data.</li>
<li>To do so, you will assign an index to everyword by iterating over your training set.</li>
</ul>
<p>The vocabulary will also include some special tokens</p>
<ul class="org-ul">
<li><code>__PAD__</code>: padding</li>
<li><code>&lt;/e&gt;</code>: end of line</li>
<li><code>__UNK__</code>: a token representing any word that is not in the vocabulary.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="n">Tokens</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="s2">"__PAD__"</span><span class="p">,</span> <span class="n">ending</span><span class="o">=</span><span class="s2">"__&lt;/e&gt;__"</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="s2">"__UNK__"</span><span class="p">)</span>
<span class="n">process</span> <span class="o">=</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
<span class="n">vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">Tokens</span><span class="o">.</span><span class="n">padding</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Tokens</span><span class="o">.</span><span class="n">ending</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Tokens</span><span class="o">.</span><span class="n">unknown</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">train_x</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">:</span>
            <span class="n">vocabulary</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Words in the vocabulary: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">token</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
<pre class="example">
Words in the vocabulary: 9,164
0: __PAD__: 0
1: __&lt;/e&gt;__: 1
2: __UNK__: 2
3: followfriday: 3
4: top: 4
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgcc429fb">
<h3 id="orgcc429fb">Converting a tweet to a tensor</h3>
<div class="outline-text-3" id="text-orgcc429fb">
<p>Now we'll write a function that will convert each tweet to a tensor (a list of unique integer IDs representing the processed tweet).</p>
<ul class="org-ul">
<li>Note, the returned data type will be a <b>regular Python `list()`</b>
<ul class="org-ul">
<li>You won't use TensorFlow in this function</li>
<li>You also won't use a numpy array</li>
<li>You also won't use trax.fastmath.numpy array</li>
</ul>
</li>
<li>
<p>For words in the tweet that are not in the vocabulary, set them to the unique ID for the token `__UNK__`.</p>
<p>For example, given this string:</p>
</li>
</ul>
<pre class="example" id="org82625d8">
'@happypuppy, is Maria happy?'
</pre>
<p>You first tokenize it.</p>
<pre class="example" id="orgf620b87">
['maria', 'happi']
</pre>
<p>Then convert each word into the index for it.</p>
<pre class="example" id="org7c468df">
[2, 56]
</pre>
<p>Notice that the word "maria" is not in the vocabulary, so it is assigned the unique integer associated with the <code>__UNK__</code> token, because it is considered "unknown."</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">tweet_to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vocab_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                    <span class="n">unk_token</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">'__UNK__'</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Convert a tweet to a list of indices</span>

<span class="sd">    Args: </span>
<span class="sd">       tweet - A string containing a tweet</span>
<span class="sd">       vocab_dict - The words dictionary</span>
<span class="sd">       unk_token - The special string for unknown tokens</span>
<span class="sd">       verbose - Print info during runtime</span>

<span class="sd">    Returns:</span>
<span class="sd">       tensor_l - A python list with indices for the tweet tokens</span>
<span class="sd">    """</span>
    <span class="c1"># Process the tweet into a list of words</span>
    <span class="c1"># where only important words are kept (stop words removed)</span>
    <span class="n">word_l</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"List of words from the processed tweet:"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">word_l</span><span class="p">)</span>

    <span class="c1"># Initialize the list that will contain the unique integer IDs of each word</span>
    <span class="n">tensor_l</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Get the unique integer ID of the __UNK__ token</span>
    <span class="n">unk_ID</span> <span class="o">=</span> <span class="n">vocab_dict</span><span class="p">[</span><span class="n">unk_token</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The unique integer ID for the unk_token is </span><span class="si">{</span><span class="n">unk_ID</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># for each word in the list:</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_l</span><span class="p">:</span>

        <span class="c1"># Get the unique integer ID.</span>
        <span class="c1"># If the word doesn't exist in the vocab dictionary,</span>
        <span class="c1"># use the unique ID for __UNK__ instead.</span>
        <span class="n">word_ID</span> <span class="o">=</span> <span class="n">vocab_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">unk_ID</span><span class="p">)</span>

        <span class="c1"># Append the unique integer ID to the tensor list.</span>
        <span class="n">tensor_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_ID</span><span class="p">)</span> 

    <span class="k">return</span> <span class="n">tensor_l</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Actual tweet is</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">positive_validation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Tensor of tweet:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">tweet_to_tensor</span><span class="p">(</span><span class="n">positive_validation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vocab_dict</span><span class="o">=</span><span class="n">vocabulary</span><span class="p">))</span>
</pre></div>
<pre class="example">
Actual tweet is
 Bro:U wan cut hair anot,ur hair long Liao bo
Me:since ord liao,take it easy lor treat as save $ leave it longer :)
Bro:LOL Sibei xialan

Tensor of tweet:
 [1072, 96, 484, 2376, 750, 8220, 1132, 750, 53, 2, 2701, 796, 2, 2, 354, 606, 2, 3523, 1025, 602, 4599, 9, 1072, 158, 2, 2]
</pre>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">test_tweet_to_tensor</span><span class="p">():</span>
    <span class="n">test_cases</span> <span class="o">=</span> <span class="p">[</span>

        <span class="p">{</span>
            <span class="s2">"name"</span><span class="p">:</span><span class="s2">"simple_test_check"</span><span class="p">,</span>
            <span class="s2">"input"</span><span class="p">:</span> <span class="p">[</span><span class="n">positive_validation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vocabulary</span><span class="p">],</span>
            <span class="s2">"expected"</span><span class="p">:[</span><span class="mi">444</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="mi">567</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
            <span class="s2">"error"</span><span class="p">:</span><span class="s2">"The function gives bad output for val_pos[1]. Test failed"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">"name"</span><span class="p">:</span><span class="s2">"datatype_check"</span><span class="p">,</span>
            <span class="s2">"input"</span><span class="p">:[</span><span class="n">positive_validation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vocabulary</span><span class="p">],</span>
            <span class="s2">"expected"</span><span class="p">:</span><span class="nb">type</span><span class="p">([]),</span>
            <span class="s2">"error"</span><span class="p">:</span><span class="s2">"Datatype mismatch. Need only list not np.array"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">"name"</span><span class="p">:</span><span class="s2">"without_unk_check"</span><span class="p">,</span>
            <span class="s2">"input"</span><span class="p">:[</span><span class="n">positive_validation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vocabulary</span><span class="p">],</span>
            <span class="s2">"expected"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span>
            <span class="s2">"error"</span><span class="p">:</span><span class="s2">"Unk word check not done- Please check if you included mapping for unknown word"</span>
        <span class="p">}</span>
    <span class="p">]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">test_case</span> <span class="ow">in</span> <span class="n">test_cases</span><span class="p">:</span>        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">test_case</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"simple_test_check"</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">test_case</span><span class="p">[</span><span class="s2">"expected"</span><span class="p">]</span> <span class="o">==</span> <span class="n">tweet_to_tensor</span><span class="p">(</span><span class="o">*</span><span class="n">test_case</span><span class="p">[</span><span class="s1">'input'</span><span class="p">])</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">test_case</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"datatype_check"</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tweet_to_tensor</span><span class="p">(</span><span class="o">*</span><span class="n">test_case</span><span class="p">[</span><span class="s1">'input'</span><span class="p">]),</span> <span class="n">test_case</span><span class="p">[</span><span class="s2">"expected"</span><span class="p">])</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">test_case</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"without_unk_check"</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tweet_to_tensor</span><span class="p">(</span><span class="o">*</span><span class="n">test_case</span><span class="p">[</span><span class="s1">'input'</span><span class="p">])</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">test_case</span><span class="p">[</span><span class="s1">'error'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\033</span><span class="s2">[92m All tests passed"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="s2">" Tests passed out of 3"</span><span class="p">)</span>
<span class="n">test_tweet_to_tensor</span><span class="p">()</span>            
</pre></div>
<pre class="example">
The function gives bad output for val_pos[1]. Test failed
2  Tests passed out of 3
</pre>
<p>Their tweet processor wipes out everything after the start of a URL, even if it isn't part of the URL, so they have fewer tokens, so the indices won't match exactly.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgc5c2a25">
<h3 id="orgc5c2a25">Creating a batch generator</h3>
<div class="outline-text-3" id="text-orgc5c2a25">
<p>Most of the time in Natural Language Processing, and AI in general we use batches when training our data sets.</p>
<ul class="org-ul">
<li>If instead of training with batches of examples, you were to train a model with one example at a time, it would take a very long time to train the model.</li>
<li>You will now build a data generator that takes in the positive/negative tweets and returns a batch of training examples. It returns the model inputs, the targets (positive or negative labels) and the weight for each target (ex: this allows us to treat some examples as more important to get right than others, but commonly this will all be 1.0).</li>
</ul>
<p>Once you create the generator, you could include it in a for loop:</p>
<pre class="example" id="org3f53ea6">
for batch_inputs, batch_targets, batch_example_weights in data_generator:
</pre>
<p>You can also get a single batch like this:</p>
<pre class="example" id="orga6e82d8">
batch_inputs, batch_targets, batch_example_weights = next(data_generator)
</pre>
<p>The generator returns the next batch each time it's called.</p>
<ul class="org-ul">
<li>This generator returns the data in a format (tensors) that you could directly use in your model.</li>
<li>It returns a triple: the inputs, targets, and loss weights:</li>
</ul>
<p>– Inputs is a tensor that contains the batch of tweets we put into the model. – Targets is the corresponding batch of labels that we train to generate. – Loss weights here are just 1s with same shape as targets. Next week, you will use it to mask input padding.</p>
</div>
<div class="outline-4" id="outline-container-orge92f2b2">
<h4 id="orge92f2b2">data_generator</h4>
<div class="outline-text-4" id="text-orge92f2b2">
<p>A batch of spaghetti.</p>
<div class="highlight">
<pre><span></span><span class="c1"># UNQ_C2 (UNIQUE CELL IDENTIFIER, DO NOT EDIT)</span>
<span class="c1"># GRADED: Data generator</span>
<span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">data_pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">data_neg</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">loop</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">vocab_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Generates batches of data</span>

<span class="sd">    Args: </span>
<span class="sd">       data_pos - Set of positive examples</span>
<span class="sd">       data_neg - Set of negative examples</span>
<span class="sd">       batch_size - number of samples per batch. Must be even</span>
<span class="sd">       loop - True or False</span>
<span class="sd">       vocab_dict - The words dictionary</span>
<span class="sd">       shuffle - Shuffle the data order</span>

<span class="sd">    Yield:</span>
<span class="sd">       inputs - Subset of positive and negative examples</span>
<span class="sd">       targets - The corresponding labels for the subset</span>
<span class="sd">       example_weights - An array specifying the importance of each example        </span>
<span class="sd">    """</span>
    <span class="c1"># make sure the batch size is an even number</span>
    <span class="c1"># to allow an equal number of positive and negative samples</span>
    <span class="k">assert</span> <span class="n">batch_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Number of positive examples in each batch is half of the batch size</span>
    <span class="c1"># same with number of negative examples in each batch</span>
    <span class="n">n_to_take</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># Use pos_index to walk through the data_pos array</span>
    <span class="c1"># same with neg_index and data_neg</span>
    <span class="n">pos_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">neg_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">len_data_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_pos</span><span class="p">)</span>
    <span class="n">len_data_neg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_neg</span><span class="p">)</span>

    <span class="c1"># Get and array with the data indexes</span>
    <span class="n">pos_index_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">len_data_pos</span><span class="p">))</span>
    <span class="n">neg_index_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">len_data_neg</span><span class="p">))</span>

    <span class="c1"># shuffle lines if shuffle is set to True</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">rnd</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">pos_index_lines</span><span class="p">)</span>
        <span class="n">rnd</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">neg_index_lines</span><span class="p">)</span>

    <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Loop indefinitely</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">:</span>  

        <span class="c1"># create a batch with positive and negative examples</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># First part: Pack n_to_take positive examples</span>

        <span class="c1"># Start from pos_index and increment i up to n_to_take</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_to_take</span><span class="p">):</span>

            <span class="c1"># If the positive index goes past the positive dataset length,</span>
            <span class="k">if</span> <span class="n">pos_index</span> <span class="o">&gt;=</span> <span class="n">len_data_pos</span><span class="p">:</span> 

                <span class="c1"># If loop is set to False, break once we reach the end of the dataset</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="p">:</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="c1"># If user wants to keep re-using the data, reset the index</span>
                <span class="n">pos_index</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                    <span class="c1"># Shuffle the index of the positive sample</span>
                    <span class="n">rnd</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">pos_index_lines</span><span class="p">)</span>

            <span class="c1"># get the tweet as pos_index</span>
            <span class="n">tweet</span> <span class="o">=</span> <span class="n">data_pos</span><span class="p">[</span><span class="n">pos_index_lines</span><span class="p">[</span><span class="n">pos_index</span><span class="p">]]</span>

            <span class="c1"># convert the tweet into tensors of integers representing the processed words</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">tweet_to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">vocab_dict</span><span class="p">)</span>

            <span class="c1"># append the tensor to the batch list</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

            <span class="c1"># Increment pos_index by one</span>
            <span class="n">pos_index</span> <span class="o">=</span> <span class="n">pos_index</span> <span class="o">+</span> <span class="mi">1</span>


        <span class="c1"># Second part: Pack n_to_take negative examples</span>

        <span class="c1"># Using the same batch list, start from neg_index and increment i up to n_to_take</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">neg_index</span><span class="p">,</span> <span class="n">n_to_take</span><span class="p">):</span>

            <span class="c1"># If the negative index goes past the negative dataset length,</span>
            <span class="k">if</span> <span class="n">neg_index</span> <span class="o">&gt;</span> <span class="n">len_data_neg</span><span class="p">:</span>

                <span class="c1"># If loop is set to False, break once we reach the end of the dataset</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="p">:</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="c1"># If user wants to keep re-using the data, reset the index</span>
                <span class="n">neg_index</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                    <span class="c1"># Shuffle the index of the negative sample</span>
                    <span class="n">rnd</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">neg_index_lines</span><span class="p">)</span>
            <span class="c1"># get the tweet at neg_index</span>
            <span class="n">tweet</span> <span class="o">=</span> <span class="n">data_neg</span><span class="p">[</span><span class="n">neg_index_lines</span><span class="p">[</span><span class="n">neg_index</span><span class="p">]]</span>

            <span class="c1"># convert the tweet into tensors of integers representing the processed words</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">tweet_to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">vocab_dict</span><span class="p">)</span>

            <span class="c1"># append the tensor to the batch list</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

            <span class="c1"># Increment neg_index by one</span>
            <span class="n">neg_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="c1"># Update the start index for positive data </span>
        <span class="c1"># so that it's n_to_take positions after the current pos_index</span>
        <span class="n">pos_index</span> <span class="o">+=</span> <span class="n">n_to_take</span>

        <span class="c1"># Update the start index for negative data </span>
        <span class="c1"># so that it's n_to_take positions after the current neg_index</span>
        <span class="n">neg_index</span> <span class="o">+=</span> <span class="n">n_to_take</span>

        <span class="c1"># Get the max tweet length (the length of the longest tweet) </span>
        <span class="c1"># (you will pad all shorter tweets to have this length)</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">])</span> 


        <span class="c1"># Initialize the input_l, which will </span>
        <span class="c1"># store the padded versions of the tensors</span>
        <span class="n">tensor_pad_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Pad shorter tweets with zeros</span>
        <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="c1"># Get the number of positions to pad for this tensor so that it will be max_len long</span>
            <span class="n">n_pad</span> <span class="o">=</span> <span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

            <span class="c1"># Generate a list of zeros, with length n_pad</span>
            <span class="n">pad_l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_pad</span>

            <span class="c1"># concatenate the tensor and the list of padded zeros</span>
            <span class="n">tensor_pad</span> <span class="o">=</span> <span class="n">tensor</span> <span class="o">+</span> <span class="n">pad_l</span>

            <span class="c1"># append the padded tensor to the list of padded tensors</span>
            <span class="n">tensor_pad_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor_pad</span><span class="p">)</span>

        <span class="c1"># convert the list of padded tensors to a numpy array</span>
        <span class="c1"># and store this as the model inputs</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tensor_pad_l</span><span class="p">)</span>

        <span class="c1"># Generate the list of targets for the positive examples (a list of ones)</span>
        <span class="c1"># The length is the number of positive examples in the batch</span>
        <span class="n">target_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[:</span><span class="n">n_to_take</span><span class="p">])</span>

        <span class="c1"># Generate the list of targets for the negative examples (a list of zeros)</span>
        <span class="c1"># The length is the number of negative examples in the batch</span>
        <span class="n">target_neg</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">n_to_take</span><span class="p">:])</span>

        <span class="c1"># Concatenate the positve and negative targets</span>
        <span class="n">target_l</span> <span class="o">=</span> <span class="n">target_pos</span> <span class="o">+</span> <span class="n">target_neg</span>

        <span class="c1"># Convert the target list into a numpy array</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_l</span><span class="p">)</span>

        <span class="c1"># Example weights: Treat all examples equally importantly.It should return an np.array. Hint: Use np.ones_like()</span>
        <span class="n">example_weights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">example_weights</span>
</pre></div>
<p>Now you can use your data generator to create a data generator for the training data, and another data generator for the validation data.</p>
<p>We will create a third data generator that does not loop, for testing the final accuracy of the model.</p>
<div class="highlight">
<pre><span></span><span class="c1"># Set the random number generator for the shuffle procedure</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">random</span>
<span class="n">rnd</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> 

<span class="c1"># Create the training data generator</span>
<span class="k">def</span> <span class="nf">train_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">positive_training</span><span class="p">,</span> <span class="n">negative_training</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span>

<span class="c1"># Create the validation data generator</span>
<span class="k">def</span> <span class="nf">val_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">positive_validation</span><span class="p">,</span> <span class="n">negative_validation</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span>

<span class="c1"># Create the validation data generator</span>
<span class="k">def</span> <span class="nf">test_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">positive_validation</span><span class="p">,</span> <span class="n">negative_validation</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                          <span class="kc">False</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span>

<span class="c1"># Get a batch from the train_generator and inspect.</span>
<span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">example_weights</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">train_generator</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># this will print a list of 4 tensors padded with zeros</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Inputs: </span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Targets: </span><span class="si">{</span><span class="n">targets</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Example Weights: </span><span class="si">{</span><span class="n">example_weights</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example">
Inputs: [[2030 4492 3231    9    0    0    0    0    0    0    0]
 [5009  571 2025 1475 5233 3532  142 3532  132  464    9]
 [3798  111   96  587 2960 4007    0    0    0    0    0]
 [ 256 3798    0    0    0    0    0    0    0    0    0]]
Targets: [1 1 0 0]
Example Weights: [1 1 1 1]
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgcdcd890">
<h4 id="orgcdcd890">Test the train_generator</h4>
<div class="outline-text-4" id="text-orgcdcd890">
<p>Create a data generator for training data which produces batches of size 4 (for tensors and their respective targets).</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_data_gen</span> <span class="o">=</span> <span class="n">train_generator</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
<p>Call the data generator to get one batch and its targets.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_inputs</span><span class="p">,</span> <span class="n">tmp_targets</span><span class="p">,</span> <span class="n">tmp_example_weights</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tmp_data_gen</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The inputs shape is </span><span class="si">{</span><span class="n">tmp_inputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The targets shape is </span><span class="si">{</span><span class="n">tmp_targets</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The example weights shape is </span><span class="si">{</span><span class="n">tmp_example_weights</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp_inputs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"input tensor: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">; target </span><span class="si">{</span><span class="n">tmp_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">; example weights </span><span class="si">{</span><span class="n">tmp_example_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
The inputs shape is (4, 14)
The targets shape is (4,)
The example weights shape is (4,)
input tensor: [3 4 5 6 7 8 9 0 0 0 0 0 0 0]; target 1; example weights 1
input tensor: [10 11 12 13 14 15 16 17 18 19 20  9 21 22]; target 1; example weights 1
input tensor: [5807 2931 3798    0    0    0    0    0    0    0    0    0    0    0]; target 0; example weights 1
input tensor: [ 865  261 3689 5808  313 4499  571 1248 2795  333 1220 3798    0    0]; target 0; example weights 1
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org71e5bf2">
<h3 id="org71e5bf2">Bundle It Up</h3>
<div class="outline-text-3" id="text-org71e5bf2"></div>
<div class="outline-4" id="outline-container-orgfbfdfb8">
<h4 id="orgfbfdfb8">Imports</h4>
<div class="outline-text-4" id="text-orgfbfdfb8">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1b664b2">
<h4 id="org1b664b2">Defaults</h4>
<div class="outline-text-4" id="text-org1b664b2">
<div class="highlight">
<pre><span></span><span class="n">Defaults</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">split</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgac6ad75">
<h4 id="orgac6ad75">NLTK Settings</h4>
<div class="outline-text-4" id="text-orgac6ad75">
<div class="highlight">
<pre><span></span><span class="n">NLTK</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">corpus</span><span class="o">=</span><span class="s2">"twitter_samples"</span><span class="p">,</span>
    <span class="n">negative</span> <span class="o">=</span> <span class="s2">"negative_tweets.json"</span><span class="p">,</span>
    <span class="n">positive</span><span class="o">=</span><span class="s2">"positive_tweets.json"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org93d0480">
<h4 id="org93d0480">Special Tokens</h4>
<div class="outline-text-4" id="text-org93d0480">
<div class="highlight">
<pre><span></span><span class="n">SpecialTokens</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="s2">"__PAD__"</span><span class="p">,</span>
                          <span class="n">ending</span><span class="o">=</span><span class="s2">"__&lt;/e&gt;__"</span><span class="p">,</span>
                          <span class="n">unknown</span><span class="o">=</span><span class="s2">"__UNK__"</span><span class="p">)</span>

<span class="n">SpecialIDs</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">ending</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">unknown</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc9a5392">
<h4 id="orgc9a5392">The Builder</h4>
<div class="outline-text-4" id="text-orgc9a5392">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TensorBuilder</span><span class="p">:</span>
    <span class="sd">"""converts tweets to tensors</span>

<span class="sd">    Args: </span>
<span class="sd">     - split: where to split the training and validation data</span>
<span class="sd">    """</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">split</span>
    <span class="n">_positive</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negative</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_positive_training</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negative_training</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_positive_validation</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negative_validation</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_process</span><span class="p">:</span> <span class="n">TwitterProcessor</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_x_train</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org5398920"></a>Positive Tweets<br>
<div class="outline-text-5" id="text-org5398920">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">positive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The raw positive NLTK tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positive</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="n">NLTK</span><span class="o">.</span><span class="n">positive</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive</span>
</pre></div>
</div>
</li>
<li><a id="orgb0cdb5a"></a>Negative Tweets<br>
<div class="outline-text-5" id="text-orgb0cdb5a">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negative</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The raw negative NLTK tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negative</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="n">NLTK</span><span class="o">.</span><span class="n">negative</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative</span>
</pre></div>
</div>
</li>
<li><a id="org81aab72"></a>Positive Training<br>
<div class="outline-text-5" id="text-org81aab72">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">positive_training</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The positive training data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_training</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positive_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_training</span>
</pre></div>
</div>
</li>
<li><a id="org92c4379"></a>Negative Training<br>
<div class="outline-text-5" id="text-org92c4379">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negative_training</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The negative training data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_training</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negative_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_training</span>
</pre></div>
</div>
</li>
<li><a id="org5c274b2"></a>Positive Validation<br>
<div class="outline-text-5" id="text-org5c274b2">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">positive_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The positive validation data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positive_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_validation</span>
</pre></div>
</div>
</li>
<li><a id="org661bef9"></a>Negative Validation<br>
<div class="outline-text-5" id="text-org661bef9">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negative_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The negative validation data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negative_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_validation</span>
</pre></div>
</div>
</li>
<li><a id="org07062cb"></a>Twitter Processor<br>
<div class="outline-text-5" id="text-org07062cb">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TwitterProcessor</span><span class="p">:</span>
    <span class="sd">"""processor for tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span>
</pre></div>
</div>
</li>
<li><a id="orgcb75bb6"></a>X Train<br>
<div class="outline-text-5" id="text-orgcb75bb6">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">x_train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The unprocessed training data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_train</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_training</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_training</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_train</span>
</pre></div>
</div>
</li>
<li><a id="org441e317"></a>The Vocabulary<br>
<div class="outline-text-5" id="text-org441e317">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""A map of token to numeric id"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">SpecialTokens</span><span class="o">.</span><span class="n">padding</span><span class="p">:</span> <span class="n">SpecialIDs</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span>
                            <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">ending</span><span class="p">:</span> <span class="n">SpecialIDs</span><span class="o">.</span><span class="n">ending</span><span class="p">,</span>
                            <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">unknown</span><span class="p">:</span> <span class="n">SpecialIDs</span><span class="o">.</span><span class="n">unknown</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span>
</pre></div>
</div>
</li>
<li><a id="orgc2d6ccd"></a>To Tensor<br>
<div class="outline-text-5" id="text-orgc2d6ccd">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Converts tweet to list of numeric identifiers</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: the string to convert</span>

<span class="sd">    Returns:</span>
<span class="sd">     list of IDs for the tweet</span>
<span class="sd">    """</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SpecialIDs</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">tensor</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org41811b5">
<h4 id="org41811b5">The Generator</h4>
<div class="outline-text-4" id="text-org41811b5">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TensorGenerator</span><span class="p">:</span>
    <span class="sd">"""Generates batches of vectorized-tweets</span>

<span class="sd">    Args:</span>
<span class="sd">     converter: TensorBuilder object</span>
<span class="sd">     positive_data: list of positive data</span>
<span class="sd">     negative_data: list of negative data</span>
<span class="sd">     batch_size: the size for each generated batch     </span>
<span class="sd">     shuffle: whether to shuffle the generated data</span>
<span class="sd">     infinite: whether to generate data forever</span>
<span class="sd">    """</span>
    <span class="n">converter</span><span class="p">:</span> <span class="n">TensorBuilder</span>
    <span class="n">positive_data</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">negative_data</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">infinite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_positive_indices</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negative_indices</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_positives</span><span class="p">:</span> <span class="nb">iter</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negatives</span><span class="p">:</span> <span class="nb">iter</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org35dd8e8"></a>Positive Indices<br>
<div class="outline-text-5" id="text-org35dd8e8">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">positive_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The indices to use to grab the positive tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_positive_indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_positive_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_indices</span>
</pre></div>
</div>
</li>
<li><a id="org45dce39"></a>Negative Indices<br>
<div class="outline-text-5" id="text-org45dce39">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negative_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Indices for the negative tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">negative_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_negative_indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_negative_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_indices</span>
</pre></div>
</div>
</li>
<li><a id="orgae659da"></a>Positives<br>
<div class="outline-text-5" id="text-orgae659da">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">positives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""The positive index generator"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positives</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_generator</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positives</span>
</pre></div>
</div>
</li>
<li><a id="orgcd2901c"></a>Negatives<br>
<div class="outline-text-5" id="text-orgcd2901c">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negatives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""The negative index generator"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negatives</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negatives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_generator</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negatives</span>
</pre></div>
</div>
</li>
<li><a id="org65a5d8d"></a>Positive Generator<br>
<div class="outline-text-5" id="text-org65a5d8d">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">positive_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Generator of indices for positive tweets"""</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_indices</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infinite</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_positive_indices</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org7d0f713"></a>Negative Generator<br>
<div class="outline-text-5" id="text-org7d0f713">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">negative_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""generator of indices for negative tweets"""</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">negative_indices</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infinite</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_negative_indices</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="orgdcb00ca"></a>The Iterator<br>
<div class="outline-text-5" id="text-orgdcb00ca">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</li>
<li><a id="orga98f773"></a>The Next Method<br>
<div class="outline-text-5" id="text-orga98f773">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">half_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># get the indices</span>
    <span class="n">positives</span> <span class="o">=</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positives</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">half_batch</span><span class="p">))</span>
    <span class="n">negatives</span> <span class="o">=</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">negatives</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">half_batch</span><span class="p">))</span>

    <span class="c1"># get the tweets</span>
    <span class="n">positives</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">positives</span><span class="p">)</span>
    <span class="n">negatives</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">negative_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">negatives</span><span class="p">)</span>

    <span class="c1"># get the token ids</span>
    <span class="k">try</span><span class="p">:</span>    
        <span class="n">positives</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">positives</span><span class="p">]</span>
        <span class="n">negatives</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">negatives</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="c1"># the next(self.positives) in the first generator will raise a</span>
        <span class="c1"># RuntimeError if</span>
        <span class="c1"># we're not running this infinitely</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="n">batch</span> <span class="o">=</span> <span class="n">positives</span> <span class="o">+</span> <span class="n">negatives</span>

    <span class="n">longest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">))</span>

    <span class="n">paddings</span> <span class="o">=</span> <span class="p">(</span><span class="n">longest</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span> <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
    <span class="n">paddings</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">padding</span> <span class="k">for</span> <span class="n">padding</span> <span class="ow">in</span> <span class="n">paddings</span><span class="p">)</span>

    <span class="n">padded</span> <span class="o">=</span> <span class="p">[</span><span class="n">tensor</span> <span class="o">+</span> <span class="n">padding</span> <span class="k">for</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">padding</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">paddings</span><span class="p">)]</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">padded</span><span class="p">)</span>

    <span class="c1"># the labels for the inputs</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">half_batch</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">half_batch</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="c1"># default the weights to ones</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">weights</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org1cf6073">
<h3 id="org1cf6073">Test It Out</h3>
<div class="outline-text-3" id="text-org1cf6073">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.tensor_generator</span> <span class="kn">import</span> <span class="n">TensorBuilder</span><span class="p">,</span> <span class="n">TensorGenerator</span>

<span class="n">converter</span> <span class="o">=</span> <span class="n">TensorBuilder</span><span class="p">()</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">tweet</span> <span class="o">=</span> <span class="n">positive_validation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1072</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">484</span><span class="p">,</span> <span class="mi">2376</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">8220</span><span class="p">,</span> <span class="mi">1132</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2701</span><span class="p">,</span> <span class="mi">796</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
            <span class="mi">354</span><span class="p">,</span> <span class="mi">606</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3523</span><span class="p">,</span> <span class="mi">1025</span><span class="p">,</span> <span class="mi">602</span><span class="p">,</span> <span class="mi">4599</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1072</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">generator</span> <span class="o">=</span> <span class="n">TensorGenerator</span><span class="p">(</span><span class="n">converter</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">))</span>
</pre></div>
<pre class="example">
(array([[ 749, 1019,  313, 1020,   75],
       [1009,    9,    0,    0,    0],
       [3540, 6030, 6031, 3798,    0],
       [  50,   96, 3798,    0,    0]]), array([1, 1, 0, 0]), array([1, 1, 1, 1]))
</pre>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">generator</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">break</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">))</span>
</pre></div>
<pre class="example" id="org7a8916d">
[[  22 1228  434  354  227 2371    9]
 [ 267  160   89    0    0    0    0]
 [ 315 1008 8480 3798 2108  371 3233]
 [8232 8233  791 3798    0    0    0]]

[[1173 1061  586    9  896  729 1264  345 1062 1063]
 [3387  558  991 2166 3388 3231  558  238  120    0]
 [ 198 5997 3798    0    0    0    0    0    0    0]
 [ 223  310 3798    0    0    0    0    0    0    0]]

[[4015 4015 4015 4016  231 2117   57  422    9 4017 4018 4019   86   86]
 [2554   57  102  358   75    0    0    0    0    0    0    0    0    0]
 [  50   38  881 3798    0    0    0    0    0    0    0    0    0    0]
 [6729 6730 6731  382 3798    0    0    0    0    0    0    0    0    0]]

[[3479   75    0    0    0    0    0    0    0    0    0    0    0    0
     0    0    0]
 [4636 4637  233 4299  111  237 2626    9    0    0    0    0    0    0
     0    0    0]
 [  73  381  463 4321  142   96 7390 7391   92   85 1394 7392 5895 7393
    45 3798 7394]
 [8863 2844  991  127 5818    0    0    0    0    0    0    0    0    0
     0    0    0]]

[[ 226  615   22   75    0    0]
 [2135  703  237  435 3124    9]
 [2379 6264 3798    0    0    0]
 [6504 1912 2380 3798    0    0]]

[[5623  120    0    0    0    0    0    0    0    0]
 [ 133   54  102   63 1300   56    9   50   92 3181]
 [2094  383   73  464 3798    0    0    0    0    0]
 [ 223  101 8754  383 2085 5818 8755    0    0    0]]

(array([[ 374,   44, 2981,  435,  132,  111, 1040, 1382,    9,    0,    0,
           0],
       [ 369,  398,  283,    9, 2671, 1411,  136,  184,  769, 1262, 2061,
        3460],
       [1094, 9024,  315,  381, 3798,    0,    0,    0,    0,    0,    0,
           0],
       [9036, 3798,    0,    0,    0,    0,    0,    0,    0,    0,    0,
           0]]), array([1, 1, 0, 0]), array([1, 1, 1, 1]))
</pre>
<p>Ladies and gentlemen, we have ourselves a generator.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org5e716e9">
<h2 id="org5e716e9">End</h2>
<div class="outline-text-2" id="text-org5e716e9">
<p>Now that we have our data, the next step will be to <a href="../sentiment-analysis-defining-the-model/">define the model</a>.</p>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/deep-learning/" rel="tag">deep learning</a></li>
<li><a class="tag p-category" href="../../../categories/nlp/" rel="tag">nlp</a></li>
<li><a class="tag p-category" href="../../../categories/sentiment-analysis/" rel="tag">sentiment analysis</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../sentiment-analysis-deep-learning-model/" rel="prev" title="Sentiment Analysis: Deep Learning Model">Previous post</a></li>
<li class="next"><a href="../sentiment-analysis-defining-the-model/" rel="next" title="Sentiment Analysis: Defining the Model">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer"><a href="https://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://licensebuttons.net/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
