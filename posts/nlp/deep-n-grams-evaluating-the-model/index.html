<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Evaluating the GRU model." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Deep N-Grams: Evaluating the Model | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/deep-n-grams-evaluating-the-model/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../deep-n-grams-training-the-model/" rel="prev" title="Deep N-Grams: Training the Model" type="text/html">
<link href="../deep-n-grams-generating-sentences/" rel="next" title="Deep N-Grams: Generating Sentences" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Deep N-Grams: Evaluating the Model" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/deep-n-grams-evaluating-the-model/" property="og:url">
<meta content="Evaluating the GRU model." property="og:description">
<meta content="article" property="og:type">
<meta content="2021-01-05T16:48:54-08:00" property="article:published_time">
<meta content="gru" property="article:tag">
<meta content="n-grams" property="article:tag">
<meta content="nlp" property="article:tag">
<meta content="rnn" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Deep N-Grams: Evaluating the Model</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2021-01-05T16:48:54-08:00" itemprop="datePublished" title="2021-01-05 16:48">2021-01-05 16:48</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org52ff250">Evaluating the Model</a>
<ul>
<li><a href="#org2f93568">Imports</a></li>
<li><a href="#org406631f">Set Up</a></li>
</ul>
</li>
<li><a href="#org9c99ae3">Middle</a>
<ul>
<li><a href="#orgd41d487">Testing</a>
<ul>
<li><a href="#orgcb7b880">Pre-Built Model</a></li>
<li><a href="#org8a66ba8">Our Model</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org52ff250">
<h2 id="org52ff250">Evaluating the Model</h2>
<div class="outline-text-2" id="text-org52ff250">
<ul class="org-ul">
<li><a href="../deep-n-grams/">First Post</a></li>
<li><a href="../deep-n-grams-training-the-model/">Previous Post</a></li>
<li><a href="../deep-n-grams-generating-sentences/">Next Post</a></li>
</ul>
<p>Now that you have learned how to train a model, you will learn how to evaluate it. To evaluate language models, we usually use perplexity which is a measure of how well a probability model predicts a sample. Note that perplexity is defined as:</p>
<p>\[ P(W) = \sqrt[N]{\prod_{i=1}^{N} \frac{1}{P(w_i| w_1,...,w_{n-1})}} \]</p>
<p>As an implementation hack, you would usually take the log of that formula (to enable us to use the log probabilities we get as output of our <code>RNN</code>, convert exponents to products, and products into sums which makes computations less complicated and computationally more efficient). You should also take care of the padding, since you do not want to include the padding when calculating the perplexity (because we do not want to have a perplexity measure that is artificially good).</p>
\begin{align} log P(W) &amp;= {log\left(\sqrt[N]{\prod_{i=1}^{N} \frac{1}{P(w_i| w_1,\ldots,w_{n-1})}}\right)} \\ &amp;= {log\left({\prod_{i=1}^{N} \frac{1}{P(w_i| w_1,\ldots,w_{n-1})}}\right)^{\frac{1}{N}}}\\ & = {log\left({\prod_{i=1}^{N}{P(w_i| w_1,\ldots,w_{n-1})}}\right)^{-\frac{1}{N}}} \\ & = -\frac{1}{N}{log\left({\prod_{i=1}^{N}{P(w_i| w_1,\ldots,w_{n-1})}}\right)} \\ & = -\frac{1}{N}{\left({\sum_{i=1}^{N}{logP(w_i| w_1,\ldots,w_{n-1})}}\right)} \end{align}
<p><b>Instructions:</b> Write a program that will help evaluate your model. Implementation hack: your program takes in preds and target. Preds is a tensor of log probabilities. You can use <a href="https://github.com/google/trax/blob/22765bb18608d376d8cd660f9865760e4ff489cd/trax/layers/metrics.py#L154"><code>tl.one_hot</code></a> to transform the target into the same dimension. You then multiply them and sum.</p>
<p>You also have to create a mask to only get the non-padded probabilities. Good luck!</p>
<p><b>Hints</b></p>
<ul class="org-ul">
<li>To convert the target into the same dimension as the predictions tensor use tl.one.hot with target and preds.shape[-1].</li>
<li>You will also need the np.equal function in order to unpad the data and properly compute perplexity.</li>
<li>Keep in mind while implementing the formula above that \(w_i\) represents a letter from our 256 letter alphabet.</li>
</ul>
</div>
<div class="outline-3" id="outline-container-org2f93568">
<h3 id="org2f93568">Imports</h3>
<div class="outline-text-3" id="text-org2f93568">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">DataGenerator</span><span class="p">,</span> <span class="n">GRUModel</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org406631f">
<h3 id="org406631f">Set Up</h3>
<div class="outline-text-3" id="text-org406631f">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">DataSettings</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">"DataSettings"</span><span class="p">,</span>
    <span class="s2">"batch_size max_length output"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">DataSettings</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                        <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="s2">"~/models/gru-shakespeare-model/"</span><span class="p">)</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
<span class="n">training_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">loader</span><span class="o">.</span><span class="n">training</span><span class="p">,</span> <span class="n">data_loader</span><span class="o">=</span><span class="n">loader</span><span class="p">,</span>
                                   <span class="n">batch_size</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                   <span class="n">max_length</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                                   <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org9c99ae3">
<h2 id="org9c99ae3">Middle</h2>
<div class="outline-text-2" id="text-org9c99ae3">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">test_model</span><span class="p">(</span><span class="n">preds</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">interpreters</span><span class="o">.</span><span class="n">xla</span><span class="o">.</span><span class="n">DeviceArray</span><span class="p">,</span>
               <span class="n">target</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">interpreters</span><span class="o">.</span><span class="n">xla</span><span class="o">.</span><span class="n">DeviceArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Function to test the model.</span>

<span class="sd">    Args:</span>
<span class="sd">       preds: Predictions of a list of batches of tensors corresponding to lines of text.</span>
<span class="sd">       target: Actual list of batches of tensors corresponding to lines of text.</span>

<span class="sd">    Returns:</span>
<span class="sd">       float: log_perplexity of the model.</span>
<span class="sd">    """</span>
    <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>
    <span class="n">total_log_ppx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">n_categories</span><span class="o">=</span><span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># HINT: tl.one_hot() should replace one of the Nones</span>

    <span class="n">non_pad</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>          <span class="c1"># You should check if the target equals 0</span>
    <span class="n">ppx</span> <span class="o">=</span> <span class="n">total_log_ppx</span> <span class="o">*</span> <span class="n">non_pad</span>                             <span class="c1"># Get rid of the padding</span>

    <span class="n">log_ppx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ppx</span><span class="p">)</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">non_pad</span><span class="p">)</span>
    <span class="c1">### END CODE HERE ###</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">log_ppx</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgd41d487">
<h3 id="orgd41d487">Testing</h3>
<div class="outline-text-3" id="text-orgd41d487"></div>
<div class="outline-4" id="outline-container-orgcb7b880">
<h4 id="orgcb7b880">Pre-Built Model</h4>
<div class="outline-text-4" id="text-orgcb7b880">
<p>We're going to start with a pre-built file and see how it does relative to our model.</p>
<div class="highlight">
<pre><span></span><span class="n">gru</span> <span class="o">=</span> <span class="n">GRUModel</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">gru</span><span class="o">.</span><span class="n">model</span>
<span class="n">pre_built</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"PRE_BUILT_MODEL"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">init_from_file</span><span class="p">(</span><span class="n">pre_built</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Serial[
    ShiftRight(1)
  ]
  Embedding_256_512
  GRU_512
  GRU_512
  Dense_256
  LogSoftmax
]
</pre>
<div class="highlight">
<pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">training_generator</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">log_ppx</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'The log perplexity and perplexity of your model are respectively'</span><span class="p">,</span> <span class="n">log_ppx</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_ppx</span><span class="p">))</span>
</pre></div>
<pre class="example">
The log perplexity and perplexity of your model are respectively 2.0370717 7.6681223
</pre></div>
</div>
<div class="outline-4" id="outline-container-org8a66ba8">
<h4 id="org8a66ba8">Our Model</h4>
<div class="outline-text-4" id="text-org8a66ba8">
<div class="highlight">
<pre><span></span><span class="n">gru</span> <span class="o">=</span> <span class="n">GRUModel</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">gru</span><span class="o">.</span><span class="n">model</span>
<span class="n">ours</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/models/gru-shakespeare-model/model.pkl.gz"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">init_from_file</span><span class="p">(</span><span class="n">ours</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Serial[
    ShiftRight(1)
  ]
  Embedding_256_512
  GRU_512
  GRU_512
  Dense_256
  LogSoftmax
]
</pre>
<div class="highlight">
<pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">training_generator</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">log_ppx</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'The log perplexity and perplexity of your model are respectively'</span><span class="p">,</span> <span class="n">log_ppx</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_ppx</span><span class="p">))</span>
</pre></div>
<pre class="example">
The log perplexity and perplexity of your model are respectively 0.93021315 2.5350494
</pre>
<p>On the one hand I over-trained my model, on the other hand… why such a big difference?</p>
</div>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/gru/" rel="tag">gru</a></li>
<li><a class="tag p-category" href="../../../categories/n-grams/" rel="tag">n-grams</a></li>
<li><a class="tag p-category" href="../../../categories/nlp/" rel="tag">nlp</a></li>
<li><a class="tag p-category" href="../../../categories/rnn/" rel="tag">rnn</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../deep-n-grams-training-the-model/" rel="prev" title="Deep N-Grams: Training the Model">Previous post</a></li>
<li class="next"><a href="../deep-n-grams-generating-sentences/" rel="next" title="Deep N-Grams: Generating Sentences">Next post</a></li>
</ul>
</nav>
</aside>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']],},

        });
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script></article>
<!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
