<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Replicating the melanoma-detection CNN project." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Dermatologist Mini-Project | In Too Deep</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../../rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/In-Too-Deep/posts/nano/dermatologist/dermatologist-mini-project/" rel="canonical"><!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>
<meta content="Cloistered Monkey" name="author">
<link href="../../rnn/character-level-rnn-exercise/" rel="prev" title="Character Level RNN Exercise" type="text/html">
<link href="../../../more-links/" rel="next" title="More Links" type="text/html">
<meta content="In Too Deep" property="og:site_name">
<meta content="Dermatologist Mini-Project" property="og:title">
<meta content="https://necromuralist.github.io/In-Too-Deep/posts/nano/dermatologist/dermatologist-mini-project/" property="og:url">
<meta content="Replicating the melanoma-detection CNN project." property="og:description">
<meta content="article" property="og:type">
<meta content="2019-01-16T21:17:45-08:00" property="article:published_time">
<meta content="cnn" property="article:tag">
<meta content="dermatologist" property="article:tag">
<meta content="project" property="article:tag">
<meta content="transfer learning" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/In-Too-Deep/"><span id="blog-title">In Too Deep</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/In-Too-Deep/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Dermatologist Mini-Project</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2019-01-16T21:17:45-08:00" itemprop="datePublished" title="2019-01-16 21:17">2019-01-16 21:17</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org67cce8f">Introduction</a></li>
<li><a href="#org6a276ef">Data Sources</a></li>
<li><a href="#orga5c2c50">Set Up</a></li>
<li><a href="#orgce333e5">The Model</a></li>
<li><a href="#orgbf7c56b">The Testing</a></li>
<li><a href="#org35fc2eb">Prepping The Test File</a></li>
<li><a href="#org272663f">References</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org67cce8f">
<h2 id="org67cce8f">Introduction</h2>
<div class="outline-text-2" id="text-org67cce8f">
<p>This is an exercise in using transfer learning to diagnose melanoma based on images of skin legions. There are three diseases to be detected:</p>
<ul class="org-ul">
<li>Melanoma</li>
<li>Nevus</li>
<li>Sebhorrheic Keratosis</li>
</ul>
<p>There is a paper online <a href="https://arxiv.org/pdf/1710.05006.pdf">here</a> (PDF link) that describes the approaches that did best in the competition.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org6a276ef">
<h2 id="org6a276ef">Data Sources</h2>
<div class="outline-text-2" id="text-org6a276ef">
<p>The data is taken from the <a href="https://challenge.kitware.com/#challenge/583f126bcad3a51cc66c8d9a">ISIC 2017: Skin Lesion Analysis Towards Melanoma Detection</a> challenge.</p>
<ul class="org-ul">
<li><a href="https://s3-us-west-1.amazonaws.com/udacity-dlnfd/datasets/skin-cancer/train.zip">Training Data</a></li>
<li><a href="https://s3-us-west-1.amazonaws.com/udacity-dlnfd/datasets/skin-cancer/valid.zip">Validation Data</a></li>
<li><a href="https://s3-us-west-1.amazonaws.com/udacity-dlnfd/datasets/skin-cancer/test.zip">Test Data</a></li>
</ul>
<p>Each folder contains three sub-folders:</p>
<ul class="org-ul">
<li><code>melanoma/</code></li>
<li><code>nevus/</code></li>
<li><code>seborrheic_keratosis/</code></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orga5c2c50">
<h2 id="orga5c2c50">Set Up</h2>
<div class="outline-text-2" id="text-orga5c2c50"></div>
<div class="outline-3" id="outline-container-orgc8049c7">
<h3 id="orgc8049c7">Imports</h3>
<div class="outline-text-3" id="text-orgc8049c7"></div>
<div class="outline-4" id="outline-container-org113b9db">
<h4 id="org113b9db">Python</h4>
<div class="outline-text-4" id="text-org113b9db">
<div class="highlight">
<pre><span></span>from pathlib import Path
import warnings
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga77849a">
<h4 id="orga77849a">PyPi</h4>
<div class="outline-text-4" id="text-orga77849a">
<div class="highlight">
<pre><span></span>from dotenv import load_dotenv
from PIL import Image, ImageFile
from torchvision import datasets
import matplotlib
warnings.filterwarnings("ignore", category=matplotlib.cbook.mplDeprecation)
import matplotlib.pyplot as pyplot
import matplotlib.image as mpimage
import matplotlib.patches as patches
import numpy
import pyttsx3
import seaborn
import torch
import torchvision.models as models
import torch.nn as nn
import torch.nn.functional as F
import torch.optim as optimizer
import torchvision.transforms as transforms
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd1cb1ab">
<h4 id="orgd1cb1ab">This Project</h4>
<div class="outline-text-4" id="text-orgd1cb1ab">
<div class="highlight">
<pre><span></span>from neurotic.tangles.data_paths import (Batches, DataPathTwo, DataSets,
                                         TrainingTestingValidationPaths,
                                         Transformer)
from neurotic.tangles.models import Inception
from neurotic.tangles.timer import Timer
from neurotic.tangles.trainer import Trainer
from neurotic.tangles.logging import Tee
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org196314c">
<h3 id="org196314c">Plotting</h3>
<div class="outline-text-3" id="text-org196314c">
<div class="highlight">
<pre><span></span>get_ipython().run_line_magic('matplotlib', 'inline')
get_ipython().run_line_magic('config', "InlineBackend.figure_format = 'retina'")
seaborn.set(style="whitegrid",
            rc={"axes.grid": False,
                "font.family": ["sans-serif"],
                "font.sans-serif": ["Open Sans", "Latin Modern Sans", "Lato"],
                "figure.figsize": (8, 6)},
            font_scale=1)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org9cd881a">
<h3 id="org9cd881a">Set the Random Seed</h3>
<div class="outline-text-3" id="text-org9cd881a">
<div class="highlight">
<pre><span></span>numpy.random.seed(seed=2019)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orge29ac1f">
<h3 id="orge29ac1f">Handle Truncated Images</h3>
<div class="outline-text-3" id="text-orge29ac1f">
<p>There seems to be at least one image that is truncated which will cause an exception when it's loaded so this next setting lets us ignore the error and keep working.</p>
<div class="highlight">
<pre><span></span>ImageFile.LOAD_TRUNCATED_IMAGES = True
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgace9749">
<h3 id="orgace9749">Constants</h3>
<div class="outline-text-3" id="text-orgace9749">
<p>These are some global constants</p>
</div>
</div>
<div class="outline-3" id="outline-container-org9b55594">
<h3 id="org9b55594">Load Dotenv</h3>
<div class="outline-text-3" id="text-org9b55594">
<div class="highlight">
<pre><span></span>load_dotenv()
</pre></div>
</div>
<div class="outline-4" id="outline-container-orge22b2b3">
<h4 id="orge22b2b3">Model Path</h4>
<div class="outline-text-4" id="text-orge22b2b3">
<p>This is where to save the best model.</p>
<div class="highlight">
<pre><span></span>MODEL_PATH = DataPathTwo(folder_key="MODELS")
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgce333e5">
<h2 id="orgce333e5">The Model</h2>
<div class="outline-text-2" id="text-orgce333e5"></div>
<div class="outline-3" id="outline-container-orgc8af86d">
<h3 id="orgc8af86d">The Training</h3>
<div class="outline-text-3" id="text-orgc8af86d">
<div class="highlight">
<pre><span></span>load_dotenv()
EPOCHS = 100
transfer_path = MODEL_PATH.folder.joinpath("model_transfer.pt")
directory = "~/logs/dermatalogist"
training_log = Tee(log_name="inception_train.log", directory_name=directory)
testing_log = Tee(log_name="inception_test.log", directory_name=directory)
data_sets = DataSets()
inception = Inception(data_sets.class_count)
batches = Batches(data_sets)
trainer = Trainer(training_batches=batches.training,
                  validation_batches=batches.validation,
                  testing_batches=batches.testing,
                  model=inception.model,
                  model_path=transfer_path,
                  optimizer=inception.optimizer,
                  criterion=inception.criterion ,
                  device=inception.device,
                  epochs=EPOCHS,
                  epoch_start=1,
                  is_inception=True,
                  load_model=False,
                  training_log=training_log,
                  testing_log=testing_log,
                  beep=True,
)
</pre></div>
<div class="highlight">
<pre><span></span>trainer()
</pre></div>
<pre class="example">
Starting Training
Started: 2019-01-26 13:59:40.249210
Started: 2019-01-26 13:59:40.249398
Ended: 2019-01-26 14:16:25.675136
Elapsed: 0:16:45.425738
Epoch: 1        Training - Loss: 0.85   Accuracy: 0.67  Validation - Loss: 0.97 Accuracy: 0.53
Validation loss decreased (inf --&gt; 0.973706). Saving model ...
Started: 2019-01-26 14:16:26.913182
Ended: 2019-01-26 14:33:23.108155
Elapsed: 0:16:56.194973
Epoch: 2        Training - Loss: 0.78   Accuracy: 0.68  Validation - Loss: 0.93 Accuracy: 0.56
Validation loss decreased (0.973706 --&gt; 0.934509). Saving model ...
Ended: 2019-01-26 14:33:23.997547
Elapsed: 0:16:57.084365

Starting Testing
Started: 2019-01-26 14:33:24.706175
Test Loss: 0.697
Test Accuracy: 70.95 (1419.0/2000)
Ended: 2019-01-26 14:47:30.356073
Elapsed: 0:14:05.649898
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-orgbf7c56b">
<h2 id="orgbf7c56b">The Testing</h2>
<div class="outline-text-2" id="text-orgbf7c56b">
<p>The remote session died so I'll just load the test output.</p>
<div class="highlight">
<pre><span></span>testing_log = Tee(log_name="inception_test.log", directory_name="~/logs/dermatologist")
with testing_log.path.open() as reader:
    for line in reader:
        print(line.rstrip())
</pre></div>
<pre class="example">

Starting Testing
Test Loss: 0.620
Test Accuracy: 74.80 (1496.0/2000)

</pre></div>
</div>
<div class="outline-2" id="outline-container-org35fc2eb">
<h2 id="org35fc2eb">Prepping The Test File</h2>
<div class="outline-text-2" id="text-org35fc2eb">
<p>To check the model you need to create a CSV file with three columns.</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Column</th>
<th class="org-left" scope="col">Description</th>
<th class="org-left" scope="col">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>Id</code></td>
<td class="org-left">Path to the file</td>
<td class="org-left"><code>data/test/melanoma/ISIC_0012258.jpg</code></td>
</tr>
<tr>
<td class="org-left"><code>task_1</code></td>
<td class="org-left">Is melanoma</td>
<td class="org-left"><code>0</code></td>
</tr>
<tr>
<td class="org-left"><code>task_2</code></td>
<td class="org-left">Is seborrheic keratosis</td>
<td class="org-left"><code>1</code></td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span>class Predictions:
    """Maps the test data to a predictions file

    Args:
     model_path: path to the stored model parameters
     device: processor to use
     output_path: path to the CSV to output
     test_path: path to the test folder
     inception: object with the model
    """
    def __init__(self, model_path: Path,
                 device: torch.device,
                 output_path: Path,
                 test_path: Path,
                 data_sets: DataSets=None,                 
                 inception: Inception=None) -&gt; None:
        self.model_path = model_path
        self.output_path = output_path
        self.test_path = test_path
        self._device = device
        self._data_sets = data_sets
        self._activation = None
        self.inception = inception
        return

    @property
    def data_sets(self) -&gt; DataSets:
        """the data-sets"""
        if self._data_sets is None:
            self._data_sets = DataSets()
        return self._data_sets

    @property
    def device(self):
        """The processor to use"""
        if self._device is None:
            self._device = torch.device("cuda"
                                        if torch.cuda.is_available()
                                        else "cpu")
        return self._device

    @property
    def inception(self) -&gt; Inception:
        """The Inception Object"""
        if self._inception is None:
            self._inception = Inception(
                classel= self.data_sets.class_count,
                model_path=self.model_path,
                device=self.device)
            self._inception.model.eval()
        return self._inception

    @property
    def activation(self) -&gt; nn.Sigmoid:
        """The non-linear activation"""
        if self._activation is None:
            self._activation = nn.Sigmoid()
        return self._activation

    @inception.setter
    def inception(self, new_inception: Inception) -&gt; None:
        """Sets the inception model to eval only"""
        self._inception = new_inception
        self._inception.model.eval()
        return

    def prediction(self, image_path: Path) -&gt; numpy.ndarray:
        """Calculate predicted class for an image

        Args:
         image_path: path to an inmage file
        Returns:
         array with the probabilities for each disease
        """
        model = self.inception.model        
        image = Image.open(image_path)
        tensor = self.data_sets.transformer.testing(image)
        # add a batch number
        tensor = tensor.unsqueeze_(0)
        tensor = tensor.to(self.inception.device)
        x = torch.autograd.Variable(tensor)
        output = torch.exp(model(x))
        _, top_class = output.topk(1, dim=1)
        return top_class.item()

    def __call__(self) -&gt; None:
        """Creates CSV of predictions"""
        with self.output_path.open("w") as writer:
            writer.write("Id,task_1,task_2\n")
            for category in self.test_path.iterdir():
                for path in category.iterdir():
                    identifier = 'data/' + str(path).split("/dermatologist/")[-1]
                    guess = self.prediction(path)
                    first = 0 if guess else 1
                    second = 1 if guess == 2 else 0
                    writer.write("{},{},{}\n".format(identifier,
                                                     first,
                                                     second))
        return
</pre></div>
<div class="highlight">
<pre><span></span>TIMER = Timer()
test_path = DataPathTwo(folder_key="TEST").folder
csv_output = Path("~/documents/pcloud_drive/outcomes/dermatologist/predictions.csv").expanduser()

predictions = Predictions(model_path=transfer_path,
                          device=inception.device,
                          output_path=csv_output,
                          test_path=test_path,
                          data_sets=data_sets,
                          inception=inception)
with TIMER:
    predictions()
</pre></div>
<pre class="example">
Started: 2019-01-29 22:36:10.975682
Ended: 2019-01-29 22:46:47.190355
Elapsed: 0:10:36.214673

</pre></div>
</div>
<div class="outline-2" id="outline-container-org272663f">
<h2 id="org272663f">References</h2>
<div class="outline-text-2" id="text-org272663f">
<ul class="org-ul">
<li><a href="https://github.com/udacity/dermatologist-ai">Github Repository</a></li>
</ul>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../../categories/cnn/" rel="tag">cnn</a></li>
<li><a class="tag p-category" href="../../../../categories/dermatologist/" rel="tag">dermatologist</a></li>
<li><a class="tag p-category" href="../../../../categories/project/" rel="tag">project</a></li>
<li><a class="tag p-category" href="../../../../categories/transfer-learning/" rel="tag">transfer learning</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../../rnn/character-level-rnn-exercise/" rel="prev" title="Character Level RNN Exercise">Previous post</a></li>
<li class="next"><a href="../../../more-links/" rel="next" title="More Links">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Contents © 2019 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../../assets/js/all-nocdn.js"></script><!-- fancy dates -->
<script>

    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
</script><!-- end fancy dates -->
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script>
</body>
</html>
