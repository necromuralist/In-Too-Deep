<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Saving and loading pytorch models." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Part 6 - Saving and Loading Models | In Too Deep</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../../rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/In-Too-Deep/posts/nano/pytorch/part-6-saving-and-loading-models/" rel="canonical"><!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript">
</script>
<meta content="Cloistered Monkey" name="author">
<link href="../part-5-inference-and-validation/" rel="prev" title="Part 5 - Inference and Validation" type="text/html">
<link href="../part-7-loading-image-data/" rel="next" title="Part 7 - Loading Image Data" type="text/html">
<meta content="In Too Deep" property="og:site_name">
<meta content="Part 6 - Saving and Loading Models" property="og:title">
<meta content="https://necromuralist.github.io/In-Too-Deep/posts/nano/pytorch/part-6-saving-and-loading-models/" property="og:url">
<meta content="Saving and loading pytorch models." property="og:description">
<meta content="article" property="og:type">
<meta content="2018-11-21T17:38:28-08:00" property="article:published_time">
<meta content="exercise" property="article:tag">
<meta content="lecture" property="article:tag">
<meta content="pytorch" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/In-Too-Deep/"><span id="blog-title">In Too Deep</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/In-Too-Deep/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Part 6 - Saving and Loading Models</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2018-11-21T17:38:28-08:00" itemprop="datePublished" title="2018-11-21 17:38">2018-11-21 17:38</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7859f06">Introduction</a></li>
<li><a href="#org10554a4">Set Up</a></li>
<li><a href="#org752743d">The Data</a></li>
<li><a href="#org52cdaf7">Training the Network</a></li>
<li><a href="#orgeb59602">Saving and loading networks</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org7859f06">
<h2 id="org7859f06">Introduction</h2>
<div class="outline-text-2" id="text-org7859f06">
<p>This is from <a href="https://github.com/udacity/deep-learning-v2-pytorch.git">Udacity's Deep Learning Repository</a> which supports their Deep Learning Nanodegree.</p>
<p>In this notebook we're going to look at how to save and load models with PyTorch.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org10554a4">
<h2 id="org10554a4">Set Up</h2>
<div class="outline-text-2" id="text-org10554a4"></div>
<div class="outline-3" id="outline-container-org00c5816">
<h3 id="org00c5816">Imports</h3>
<div class="outline-text-3" id="text-org00c5816"></div>
<div class="outline-4" id="outline-container-orgbb0d0f8">
<h4 id="orgbb0d0f8">Python</h4>
<div class="outline-text-4" id="text-orgbb0d0f8">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org156cdc0">
<h4 id="org156cdc0">PyPi</h4>
<div class="outline-text-4" id="text-org156cdc0">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="kn">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb334bcb">
<h4 id="orgb334bcb">Nano Program</h4>
<div class="outline-text-4" id="text-orgb334bcb">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">nano.pytorch</span> <span class="kn">import</span> <span class="n">helper</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org503396c">
<h4 id="org503396c">This Project</h4>
<div class="outline-text-4" id="text-org503396c">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.tangles.data_paths</span> <span class="kn">import</span> <span class="n">DataPathTwo</span>
<span class="kn">from</span> <span class="nn">fashion</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">label_decoder</span><span class="p">,</span>
    <span class="n">train</span><span class="p">,</span>
    <span class="n">DropoutModel</span><span class="p">,</span>
    <span class="n">HyperParameters</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org1a4b8e8">
<h3 id="org1a4b8e8">Plotting</h3>
<div class="outline-text-3" id="text-org1a4b8e8">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">get_python</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_python</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org752743d">
<h2 id="org752743d">The Data</h2>
<div class="outline-text-2" id="text-org752743d">
<p>Once again we're going to use the <code>fashion-MNIST</code> data.</p>
</div>
<div class="outline-3" id="outline-container-orgf8ab565">
<h3 id="orgf8ab565">The Path</h3>
<div class="outline-text-3" id="text-orgf8ab565">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">DataPathTwo</span><span class="p">(</span><span class="n">folder_key</span><span class="o">=</span><span class="s2">"FASHION_MNIST"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
</pre></div>
<pre class="example">
~/datasets/F_MNIST

</pre></div>
</div>
<div class="outline-3" id="outline-container-org9f622e9">
<h3 id="org9f622e9">Define a transform to normalize the data</h3>
<div class="outline-text-3" id="text-org9f622e9">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))])</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org681efea">
<h3 id="org681efea">Download and Load the Training Data</h3>
<div class="outline-text-3" id="text-org681efea">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">trainset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                 <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">training</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                                          <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org216ac50">
<h3 id="org216ac50">Download and Load the Test Data</h3>
<div class="outline-text-3" id="text-org216ac50">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">testset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">testing</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">testset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>Here's one of the images.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">trainloader</span><span class="p">))</span>
<span class="n">helper</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]);</span>
</pre></div>
<div class="figure">
<p><img alt="image_one.png" src="image_one.png"></p>
</div>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">label_decoder</span><span class="p">[</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()])</span>
</pre></div>
<pre class="example">
Sneaker

</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org52cdaf7">
<h2 id="org52cdaf7">Training the Network</h2>
<div class="outline-text-2" id="text-org52cdaf7">
<p>I'm re-using the <code>DropoutModel</code> from the previous lesson about avoiding over-fitting using dropout. I'm also re-using the (somewhat updated) <code>train</code> function.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">DropoutModel</span><span class="p">()</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">NLLLoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
      <span class="n">train_batches</span><span class="o">=</span><span class="n">training</span><span class="p">,</span> <span class="n">test_batches</span><span class="o">=</span><span class="n">testing</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
<pre class="example">
Epoch: 1/30 Training loss: 2.41 Test Loss: 2.40 Test Accuracy: 0.09
Epoch: 2/30 Training loss: 2.41 Test Loss: 2.40 Test Accuracy: 0.09

</pre></div>
</div>
<div class="outline-2" id="outline-container-orgeb59602">
<h2 id="orgeb59602">Saving and loading networks</h2>
<div class="outline-text-2" id="text-orgeb59602">
<p>Rather than re-training your model every time you want to use it you can instead save it an re-load the pre-trained model when you need it.</p>
<p>The parameters for PyTorch networks are stored in a model's <code>state_dict</code>.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"Our model: </span><span class="se">\n\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"The state dict keys: </span><span class="se">\n\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
<pre class="example">
Our model: 

 DropoutModel(
  (input_to_hidden): Linear(in_features=784, out_features=256, bias=True)
  (hidden_1_to_hidden_2): Linear(in_features=256, out_features=128, bias=True)
  (hidden_2_to_hidden_3): Linear(in_features=128, out_features=64, bias=True)
  (hidden_3_to_output): Linear(in_features=64, out_features=10, bias=True)
  (dropout): Dropout(p=0.2)
) 

The state dict keys: 

 odict_keys(['input_to_hidden.weight', 'input_to_hidden.bias', 'hidden_1_to_hidden_2.weight', 'hidden_1_to_hidden_2.bias', 'hidden_2_to_hidden_3.weight', 'hidden_2_to_hidden_3.bias', 'hidden_3_to_output.weight', 'hidden_3_to_output.bias'])
</pre>
<p>The simplest thing to do is simply save the state dict with <a href="https://pytorch.org/docs/stable/torch.html?highlight=save#torch.save"><code>torch.save</code></a>, which uses python's <a href="https://docs.python.org/3.6/library/pickle.html">pickle</a> to serialze the settings. PyTorch has <a href="https://pytorch.org/docs/stable/notes/serialization.html#recommend-saving-models">an explanation</a> for why you would prefer saving the settings instead of the entire model.</p>
<p>As an example, we can save our trained model's settings to a file <code>checkpoint.pth</code>.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">file_name</span> <span class="o">=</span> <span class="s2">"checkpoint.pth"</span>
<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">file_name</span><span class="p">)</span>
</pre></div>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">check_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"File Size: {} K"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
<pre class="example">
File Size: 972.392 K

</pre>
<p>So it's almost a megabyte, better remember to clean it up later.</p>
<p>I couldn't find an explanation for the file-extension, but the pytorch documentation mentions that it's a convention to use <code>.pt</code> and <code>.pth</code> as extensions. I'm assuming <i>pt</i> is for PyTorch and the <i>h</i> is for hyper-parameters, but I'm not really sure that it's the case.</p>
<p>To load the model you can use <a href="https://pytorch.org/docs/stable/torch.html?highlight=torch%20load#torch.load"><code>torch.load</code></a>.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'checkpoint.pth'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">state_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
<pre class="example">
odict_keys(['input_to_hidden.weight', 'input_to_hidden.bias', 'hidden_1_to_hidden_2.weight', 'hidden_1_to_hidden_2.bias', 'hidden_2_to_hidden_3.weight', 'hidden_2_to_hidden_3.bias', 'hidden_3_to_output.weight', 'hidden_3_to_output.bias'])

</pre>
<p>To load the state-dict you take your instantiated but untrained model and call its <a href="https://pytorch.org/docs/stable/nn.html?highlight=load_state_dict#torch.nn.Module.load_state_dict"><code>load_state_dict</code></a> method.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
</pre></div>
<p>Seems pretty straightforward, but as usual it's a bit more complicated. Loading the state dict works only if the model architecture is exactly the same as the checkpoint architecture. Using a model with a different architecture, this fails.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">parameters</span> <span class="o">=</span> <span class="n">HyperParameters</span><span class="p">()</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">hidden_layer_1</span> <span class="o">=</span> <span class="mi">400</span>
</pre></div>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">bad_model</span> <span class="o">=</span> <span class="n">DropoutModel</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="c1"># This will throw an error because the tensor sizes are wrong!</span>
<span class="n">bad_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
</pre></div>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="ne">RuntimeError</span><span class="p">:</span> <span class="n">Error</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">loading</span> <span class="n">state_dict</span> <span class="k">for</span> <span class="n">DropoutModel</span><span class="p">:</span>
        <span class="n">size</span> <span class="n">mismatch</span> <span class="k">for</span> <span class="n">input_to_hidden</span><span class="o">.</span><span class="n">weight</span><span class="p">:</span> <span class="n">copying</span> <span class="n">a</span> <span class="n">param</span> <span class="n">of</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">400</span><span class="p">,</span> <span class="mi">784</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">checkpoint</span><span class="p">,</span> <span class="n">where</span> <span class="n">the</span> <span class="n">shape</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">256</span><span class="p">,</span> <span class="mi">784</span><span class="p">])</span> <span class="ow">in</span> <span class="n">current</span> <span class="n">model</span><span class="o">.</span>
        <span class="n">size</span> <span class="n">mismatch</span> <span class="k">for</span> <span class="n">input_to_hidden</span><span class="o">.</span><span class="n">bias</span><span class="p">:</span> <span class="n">copying</span> <span class="n">a</span> <span class="n">param</span> <span class="n">of</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">400</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">checkpoint</span><span class="p">,</span> <span class="n">where</span> <span class="n">the</span> <span class="n">shape</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">256</span><span class="p">])</span> <span class="ow">in</span> <span class="n">current</span> <span class="n">model</span><span class="o">.</span>
        <span class="n">size</span> <span class="n">mismatch</span> <span class="k">for</span> <span class="n">hidden_1_to_hidden_2</span><span class="o">.</span><span class="n">weight</span><span class="p">:</span> <span class="n">copying</span> <span class="n">a</span> <span class="n">param</span> <span class="n">of</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">checkpoint</span><span class="p">,</span> <span class="n">where</span> <span class="n">the</span> <span class="n">shape</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span> <span class="ow">in</span> <span class="n">current</span> <span class="n">model</span><span class="o">.</span>
</pre></div>
<p>This means we need to rebuild the model exactly as it was when trained. Information about the model architecture needs to be saved in the checkpoint, along with the state dict. To do this, you build a dictionary with all the information you need to compeletely rebuild the model.</p>
<p>Originally the bad-model was just called 'model' and that seems to have messed up the state-dict so I'm going to re-use the one we made before.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'hyperparameters'</span><span class="p">:</span> <span class="n">HyperParameters</span><span class="p">,</span>
              <span class="s1">'state_dict'</span><span class="p">:</span> <span class="n">state_dict</span><span class="p">}</span>

<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</pre></div>
<p>Remember that this is using pickle under the hood so whatever you save has to be pickleable. It probably would be safer to use parameters instead of a settings object like I did, but I didn't know we were going to be doing this.</p>
<p>Here's a function to load checkpoint-files.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">load_checkpoint</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
    <span class="sd">"""Load the model checkpoint from disk</span>

<span class="sd">    Args:</span>
<span class="sd">     filepath: path to the saved checkpoint</span>
<span class="sd">    """</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">DropoutModel</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">"hyperparameters"</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">'state_dict'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
<p>You can see from the function that the checkpoint is really just pickling a dictionary, and we can add any arbitrary things we want to it. I'm not really sure what it gives that using pickle directly doesn't have.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
DropoutModel(
  (input_to_hidden): Linear(in_features=784, out_features=256, bias=True)
  (hidden_1_to_hidden_2): Linear(in_features=256, out_features=128, bias=True)
  (hidden_2_to_hidden_3): Linear(in_features=128, out_features=64, bias=True)
  (hidden_3_to_output): Linear(in_features=64, out_features=10, bias=True)
  (dropout): Dropout(p=0.2)
)

</pre>
<p>PyTorch has more about saving and loading models in <a href="https://pytorch.org/tutorials/beginner/saving_loading_models.html">their documentation</a>, including saving your model to continue training later (you need to save more than the model's settings).</p>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../../categories/exercise/" rel="tag">exercise</a></li>
<li><a class="tag p-category" href="../../../../categories/lecture/" rel="tag">lecture</a></li>
<li><a class="tag p-category" href="../../../../categories/pytorch/" rel="tag">pytorch</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../part-5-inference-and-validation/" rel="prev" title="Part 5 - Inference and Validation">Previous post</a></li>
<li class="next"><a href="../part-7-loading-image-data/" rel="next" title="Part 7 - Loading Image Data">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Contents © 2019 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../../assets/js/all-nocdn.js">
</script><!-- fancy dates -->
<script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
</script><!-- end fancy dates -->
<script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script>
</body>
</html>
