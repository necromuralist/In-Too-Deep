<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Part 4 of the introduction to pytorch." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Part 4 - Classifying Fashion-MNIST | In Too Deep</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../../rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/In-Too-Deep/posts/nano/pytorch/part-4-fashion/" rel="canonical"><!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../../site.webmanifest" rel="manifest">
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>
<script async src="../../../assets/javascript/bokeh-1.3.4.min.js" type="text/javascript"></script>
<meta content="Cloistered Monkey" name="author">
<link href="/posts/nano/pytorch/training-neural-networks/" rel="prev" title="Training Neural Networks" type="text/html">
<link href="/posts/nano/pytorch/part-5-inference-and-validation/" rel="next" title="Part 5 - Inference and Validation" type="text/html">
<meta content="In Too Deep" property="og:site_name">
<meta content="Part 4 - Classifying Fashion-MNIST" property="og:title">
<meta content="https://necromuralist.github.io/In-Too-Deep/posts/nano/pytorch/part-4-fashion/" property="og:url">
<meta content="Part 4 of the introduction to pytorch." property="og:description">
<meta content="article" property="og:type">
<meta content="2018-11-19T19:15:07-08:00" property="article:published_time">
<meta content="exercise" property="article:tag">
<meta content="pytorch" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/In-Too-Deep/"><span id="blog-title">In Too Deep</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/In-Too-Deep/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="/posts/nano/pytorch/part-4-fashion/index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href="/posts/nano/pytorch/part-4-fashion/">Part 4 - Classifying Fashion-MNIST</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/nano/pytorch/part-4-fashion/" rel="bookmark"><time class="published dt-published" datetime="2018-11-19T19:15:07-08:00" itemprop="datePublished" title="2018-11-19 19:15">2018-11-19 19:15</time></a></p>
<p class="sourceline"><a class="sourcelink" href="/posts/nano/pytorch/part-4-fashion/index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/nano/pytorch/part-4-fashion/#org8d975a3">Introduction</a></li>
<li><a href="/posts/nano/pytorch/part-4-fashion/#org0fd77b0">Set Up</a></li>
<li><a href="/posts/nano/pytorch/part-4-fashion/#org2080825">The Data</a></li>
<li><a href="/posts/nano/pytorch/part-4-fashion/#orgb077441">The Network</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org8d975a3">
<h2 id="org8d975a3">Introduction</h2>
<div class="outline-text-2" id="text-org8d975a3">
<p>This is from <a href="https://github.com/udacity/deep-learning-v2-pytorch.git">Udacity's Deep Learning Repository</a> which supports their Deep Learning Nanodegree.</p>
<p>This post uses the <a href="https://github.com/zalandoresearch/fashion-mnist">Fashion-MNIST dataset</a>, a set of article images from <a href="https://www.zalando.com/">Zalando</a>, a fashion retailer. It is meant to be a drop-in replacement for the MNIST dataset. The dataset was created because some people the consider original MNIST too easy, with classical machine learning algorithms achieving better than 97% accuracy. The dataset keeps the 10 classes, but now instead of digits they represent clothing types.</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">Label</th>
<th class="org-left" scope="col">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-left">T-shirt/top</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-left">Trouser</td>
</tr>
<tr>
<td class="org-right">2</td>
<td class="org-left">Pullover</td>
</tr>
<tr>
<td class="org-right">3</td>
<td class="org-left">Dress</td>
</tr>
<tr>
<td class="org-right">4</td>
<td class="org-left">Coat</td>
</tr>
<tr>
<td class="org-right">5</td>
<td class="org-left">Sandal</td>
</tr>
<tr>
<td class="org-right">6</td>
<td class="org-left">Shirt</td>
</tr>
<tr>
<td class="org-right">7</td>
<td class="org-left">Sneaker</td>
</tr>
<tr>
<td class="org-right">8</td>
<td class="org-left">Bag</td>
</tr>
<tr>
<td class="org-right">9</td>
<td class="org-left">Ankle boot</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="n">descriptions</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"T-shirt/top"</span><span class="p">,</span>
                <span class="s2">"Trouser"</span><span class="p">,</span>
                <span class="s2">"Pullover"</span><span class="p">,</span>
                <span class="s2">"Dress"</span><span class="p">,</span>
                <span class="s2">"Coat"</span><span class="p">,</span>
                <span class="s2">"Sandal"</span><span class="p">,</span>
                <span class="s2">"Shirt"</span><span class="p">,</span>
                <span class="s2">"Sneaker"</span><span class="p">,</span>
                <span class="s2">"Bag"</span><span class="p">,</span>
                <span class="s2">"Ankle boot"</span><span class="p">,</span>
                <span class="p">)</span>

<span class="n">label_decoder</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">descriptions</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org0fd77b0">
<h2 id="org0fd77b0">Set Up</h2>
<div class="outline-text-2" id="text-org0fd77b0"></div>
<div class="outline-3" id="outline-container-org07f9168">
<h3 id="org07f9168">Imports</h3>
<div class="outline-text-3" id="text-org07f9168"></div>
<div class="outline-4" id="outline-container-orgfc5fe0a">
<h4 id="orgfc5fe0a">Python Standard Library</h4>
<div class="outline-text-4" id="text-orgfc5fe0a">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5bf1633">
<h4 id="org5bf1633">PyPi</h4>
<div class="outline-text-4" id="text-org5bf1633">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="kn">as</span> <span class="nn">F</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf43c751">
<h4 id="orgf43c751">The Udacity Code</h4>
<div class="outline-text-4" id="text-orgf43c751">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">nano.pytorch</span> <span class="kn">import</span> <span class="n">helper</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgfa8d66e">
<h3 id="orgfa8d66e">Plotting</h3>
<div class="outline-text-3" id="text-orgfa8d66e">
<div class="highlight">
<pre><span></span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org2080825">
<h2 id="org2080825">The Data</h2>
<div class="outline-text-2" id="text-org2080825"></div>
<div class="outline-3" id="outline-container-orge3bc9d3">
<h3 id="orge3bc9d3">Normalization</h3>
<div class="outline-text-3" id="text-orge3bc9d3">
<p>First, a transform to normalize the data.</p>
<div class="highlight">
<pre><span></span><span class="n">means</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">deviations</span> <span class="o">=</span> <span class="n">means</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">deviations</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgab96a64">
<h3 id="orgab96a64">Load The Data</h3>
<div class="outline-text-3" id="text-orgab96a64">
<p>First our training set.</p>
<div class="highlight">
<pre><span></span><span class="n">training</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span><span class="s1">'~/datasets/F_MNIST/'</span><span class="p">,</span>
                                 <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                 <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                 <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>

<span class="n">training_batches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">training</span><span class="p">,</span>
                                               <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                                               <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<pre class="example">
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-images-idx3-ubyte.gz
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-labels-idx1-ubyte.gz
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-images-idx3-ubyte.gz
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-labels-idx1-ubyte.gz
Processing...
Done!
</pre>
<p>Now our test set.</p>
<div class="highlight">
<pre><span></span><span class="n">testing</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span><span class="s1">'~/datasets/F_MNIST/'</span><span class="p">,</span>
                                <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>

<span class="n">test_batches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">testing</span><span class="p">,</span>
                                           <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                                           <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>The data is apparently on a european amazon web-service server.</p>
<p>Let's take a look at one of the images.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">show_next_image</span><span class="p">(</span><span class="n">data_set</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">"""plots the next image</span>

<span class="sd">    Args:</span>
<span class="sd">     data_set: iterator to get the next image from</span>

<span class="sd">    Returns:</span>
<span class="sd">     image, label: the next items in the data set</span>
<span class="sd">    """</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data_set</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">seaborn</span><span class="o">.</span><span class="n">axes_style</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"white"</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)}):</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">show_next_image</span><span class="p">(</span><span class="n">training_batches</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="image.png" src="/posts/nano/pytorch/part-4-fashion/image.png"></p>
</div>
<p>Every time I re-run this the image changes. That was originally just a blob.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">label_decoder</span><span class="p">[</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()])</span>
</pre></div>
<pre class="example">
Sneaker

</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-orgb077441">
<h2 id="orgb077441">The Network</h2>
<div class="outline-text-2" id="text-orgb077441">
<p>Here you should define your network. As with MNIST, each image is 28x28 which is a total of 784 pixels, and there are 10 classes. You should include at least one hidden layer. We suggest you use ReLU activations for the layers and to return the logits or log-softmax from the forward pass. It's up to you how many layers you add and the size of those layers.</p>
</div>
<div class="outline-3" id="outline-container-org1480992">
<h3 id="org1480992">Hyper Parameters</h3>
<div class="outline-text-3" id="text-org1480992">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">HyperParameters</span><span class="p">:</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span>
    <span class="n">hidden_layer_1</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">hidden_layer_2</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.005</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">200</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org5abe570">
<h3 id="org5abe570">The Model</h3>
<div class="outline-text-3" id="text-org5abe570">
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="n">OrderedDict</span><span class="p">(</span>
        <span class="n">input_to_hidden</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">HyperParameters</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
                                  <span class="n">HyperParameters</span><span class="o">.</span><span class="n">hidden_layer_1</span><span class="p">),</span>
        <span class="n">activation_1</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
        <span class="n">hidden_to_hidden</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">HyperParameters</span><span class="o">.</span><span class="n">hidden_layer_1</span><span class="p">,</span>
                                   <span class="n">HyperParameters</span><span class="o">.</span><span class="n">hidden_layer_2</span><span class="p">),</span>
        <span class="n">activation_2</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
        <span class="n">hidden_to_output</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">HyperParameters</span><span class="o">.</span><span class="n">hidden_layer_2</span><span class="p">,</span>
                                   <span class="n">HyperParameters</span><span class="o">.</span><span class="n">outputs</span><span class="p">),</span>
        <span class="n">activation_out</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">HyperParameters</span><span class="o">.</span><span class="n">rows</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org658ee3a">
<h3 id="org658ee3a">The Optimizer and Loss</h3>
<div class="outline-text-3" id="text-org658ee3a">
<div class="highlight">
<pre><span></span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">NLLLoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">HyperParameters</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org91ab0a7">
<h3 id="org91ab0a7">Training</h3>
<div class="outline-text-3" id="text-org91ab0a7">
<p>The process:</p>
<ul class="org-ul">
<li>Make a forward pass through the network to get the logits</li>
<li>Use the logits to calculate the loss</li>
<li>Perform a backward pass through the network with `loss.backward()` to calculate the gradients</li>
<li>Take a step with the optimizer to update the weights</li>
</ul>
<p>By adjusting the hyperparameters (hidden units, learning rate, etc), you should be able to get the training loss below 0.4.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">HyperParameters</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
    <span class="n">running_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">training_batches</span><span class="p">:</span>
        <span class="c1"># some setup</span>
        <span class="c1">## Flatten the images</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">## Reset the optimizer</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="c1"># forward pass</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

        <span class="c1"># back-propagation</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

        <span class="c1"># take the next step</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training loss: {running_loss/len(data_batches)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training loss: 1.2992842076048414
Training loss: 0.4147487568385057
Training loss: 0.3563503011393903
Training loss: 0.31974349495793963
Training loss: 0.2909906929267495
Training loss: 0.2669587785135836
Training loss: 0.24693025264150298
Training loss: 0.22828677767661334
Training loss: 0.2111341437932525
Training loss: 0.19651830268662368
Training loss: 0.18078892016763498
Training loss: 0.1678272306934984
Training loss: 0.15590339134147427
Training loss: 0.1440456182614509
Training loss: 0.13368237831159188
Training loss: 0.1232291767592115
Training loss: 0.11354898248336462
Training loss: 0.104927517529299
Training loss: 0.09589472461912806
Training loss: 0.08939716171846589
</pre>
<p>Check out a prediction.</p>
<div class="highlight">
<pre><span></span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">test_batches</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Convert 2D image to 1D vector</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">resize_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">784</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">probabilities</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">seaborn</span><span class="o">.</span><span class="n">axes_style</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">):</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">view_classify</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">resize_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">probabilities</span><span class="p">,</span>
                         <span class="n">version</span><span class="o">=</span><span class="s1">'Fashion'</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="prediction_image.png" src="/posts/nano/pytorch/part-4-fashion/prediction_image.png"></p>
</div>
<p>That looks pretty good to me.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">label_decoder</span><span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">item</span><span class="p">()])</span>
<span class="k">print</span><span class="p">(</span><span class="n">label_decoder</span><span class="p">[</span><span class="n">probabilities</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()])</span>
</pre></div>
<pre class="example">
Sandal
Sandal

</pre>
<p>So this time we got it right.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">break</span>
<span class="k">print</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">resize_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">784</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">label_decoder</span><span class="p">[</span><span class="n">probabilities</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()])</span>
<span class="k">print</span><span class="p">(</span><span class="n">label_decoder</span><span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">item</span><span class="p">()])</span>
</pre></div>
<pre class="example">
10
Dress
Coat

</pre>
<p>Oops, look like we're still having problems.</p>
<div class="highlight">
<pre><span></span><span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">test_batches</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s1">'Accuracy of the network on the test images: </span><span class="si">%d</span><span class="s1"> </span><span class="si">%%</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span>
    <span class="mi">100</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span><span class="p">))</span>
</pre></div>
<pre class="example">
Accuracy of the network on the test images: 88 %

</pre>
<p>Not bad, it could probably be tuned to do better, the loss hasn't stopped reducing, for instance, so maybe more epochs would help.</p>
<div class="highlight">
<pre><span></span><span class="n">class_correct</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">class_total</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"|Item|Accuracy (%)|"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"|-+-|"</span><span class="p">)</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">test_batches</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">class_correct</span><span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">class_total</span><span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'|{}|{:.1f}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">label_decoder</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">class_correct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">class_total</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Item</th>
<th class="org-right" scope="col">Accuracy (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">T-shirt/top</td>
<td class="org-right">88.0</td>
</tr>
<tr>
<td class="org-left">Trouser</td>
<td class="org-right">97.5</td>
</tr>
<tr>
<td class="org-left">Pullover</td>
<td class="org-right">87.2</td>
</tr>
<tr>
<td class="org-left">Dress</td>
<td class="org-right">88.0</td>
</tr>
<tr>
<td class="org-left">Coat</td>
<td class="org-right">83.2</td>
</tr>
<tr>
<td class="org-left">Sandal</td>
<td class="org-right">97.4</td>
</tr>
<tr>
<td class="org-left">Shirt</td>
<td class="org-right">57.3</td>
</tr>
<tr>
<td class="org-left">Sneaker</td>
<td class="org-right">95.5</td>
</tr>
<tr>
<td class="org-left">Bag</td>
<td class="org-right">95.7</td>
</tr>
<tr>
<td class="org-left">Ankle boot</td>
<td class="org-right">95.6</td>
</tr>
</tbody>
</table>
<p>Generally it seems to do okay, but the shirt seems to have gotten worse than when I was using fewer epochs. I might be overfitting by putting so many epochs and if I were to improve it I would probably work on other hyper-parameters.</p>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="/categories/exercise/" rel="tag">exercise</a></li>
<li><a class="tag p-category" href="/categories/pytorch/" rel="tag">pytorch</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="/posts/nano/pytorch/training-neural-networks/" rel="prev" title="Training Neural Networks">Previous post</a></li>
<li class="next"><a href="/posts/nano/pytorch/part-5-inference-and-validation/" rel="next" title="Part 5 - Inference and Validation">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Contents © 2019 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="/assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> 
</body>
</html>
