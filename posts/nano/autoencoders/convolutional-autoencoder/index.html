<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Autoencoding with a Convolutional Neural Network" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Convolutional Autoencoder | Neurotic Networking</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../../rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nano/autoencoders/convolutional-autoencoder/" rel="canonical"><!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../simple-autoencoder/" rel="prev" title="Simple Autoencoder" type="text/html">
<link href="../denoising-autoencoder/" rel="next" title="Denoising Autoencoder" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Convolutional Autoencoder" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nano/autoencoders/convolutional-autoencoder/" property="og:url">
<meta content="Autoencoding with a Convolutional Neural Network" property="og:description">
<meta content="article" property="og:type">
<meta content="2018-12-19T12:15:02-08:00" property="article:published_time">
<meta content="autoencoder" property="article:tag">
<meta content="cnn" property="article:tag">
<meta content="exercise" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/Neurotic-Networking/"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Convolutional Autoencoder</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2018-12-19T12:15:02-08:00" itemprop="datePublished" title="2018-12-19 12:15">2018-12-19 12:15</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgfaef222">Introduction</a></li>
<li><a href="#org15b8fc1">Compressed Representation</a></li>
<li><a href="#org68eac86">Set Up</a></li>
<li><a href="#org3c4e078">The Data</a></li>
<li><a href="#org905ec0d">Visualize the Data</a></li>
<li><a href="#org953b1d2">Convolutional Autoencoder</a></li>
<li><a href="#orgb2fb44c">Transpose Convolutions, Decoder</a></li>
<li><a href="#org64522aa">Initialize The NN</a></li>
<li><a href="#org7e5532c">Training</a></li>
<li><a href="#org49e2bc4">Checking out the results</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgfaef222">
<h2 id="orgfaef222">Introduction</h2>
<div class="outline-text-2" id="text-orgfaef222">
<p>Sticking with the <a href="https://en.wikipedia.org/wiki/MNIST_database">MNIST</a> dataset, let's improve our autoencoder's performance using convolutional layers. We'll build a convolutional autoencoder to compress the MNIST dataset.</p>
<ul class="org-ul">
<li>The encoder portion will be made of convolutional and pooling layers and the decoder will be made of <b>transpose convolutional layers</b> that learn to "upsample" a compressed representation.</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org15b8fc1">
<h2 id="org15b8fc1">Compressed Representation</h2>
<div class="outline-text-2" id="text-org15b8fc1">
<p>A compressed representation can be great for saving and sharing any kind of data in a way that is more efficient than storing raw data. In practice, the compressed representation often holds key information about an input image and we can use it for denoising images or other kinds of reconstruction and transformation!</p>
</div>
</div>
<div class="outline-2" id="outline-container-org68eac86">
<h2 id="org68eac86">Set Up</h2>
<div class="outline-text-2" id="text-org68eac86"></div>
<div class="outline-3" id="outline-container-orgea44606">
<h3 id="orgea44606">Imports</h3>
<div class="outline-text-3" id="text-orgea44606"></div>
<div class="outline-4" id="outline-container-org005a091">
<h4 id="org005a091">Python Standard Library</h4>
<div class="outline-text-4" id="text-org005a091">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd7850f6">
<h4 id="orgd7850f6">From PyPi</h4>
<div class="outline-text-4" id="text-orgd7850f6">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Graph</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgcb649af">
<h3 id="orgcb649af">Plotting</h3>
<div class="outline-text-3" id="text-orgcb649af">
<div class="highlight">
<pre><span></span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org12e5d61">
<h3 id="org12e5d61">Test for <a href="http://pytorch.org/docs/stable/cuda.html">CUDA</a></h3>
<div class="outline-text-3" id="text-org12e5d61">
<p>The test-code uses the check later on so I'll save it to the <code>train_on_gpu</code> variable.</p>
<div class="highlight">
<pre><span></span><span class="n">train_on_gpu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda:0"</span> <span class="k">if</span> <span class="n">train_on_gpu</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Using: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
</pre></div>
<pre class="example">
Using: cuda:0
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org3c4e078">
<h2 id="org3c4e078">The Data</h2>
<div class="outline-text-2" id="text-org3c4e078"></div>
<div class="outline-3" id="outline-container-orgdf51715">
<h3 id="orgdf51715">Setup the Data Transform</h3>
<div class="outline-text-3" id="text-orgdf51715">
<div class="highlight">
<pre><span></span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1888696">
<h3 id="org1888696">Load the Training and Test Datasets</h3>
<div class="outline-text-3" id="text-org1888696">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">()</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/datasets/MNIST/"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">())</span>
</pre></div>
<pre class="example">
/home/hades/datasets/MNIST
True
</pre>
<div class="highlight">
<pre><span></span><span class="n">train_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7f4c6b0">
<h3 id="org7f4c6b0">Create training and test dataloaders</h3>
<div class="outline-text-3" id="text-org7f4c6b0">
<div class="highlight">
<pre><span></span><span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># how many samples per batch to load</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org2d80d8c">
<h3 id="org2d80d8c">Prepare Data Loaders</h3>
<div class="outline-text-3" id="text-org2d80d8c">
<div class="highlight">
<pre><span></span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> 
                                           <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                                           <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span>
                                          <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                                          <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org905ec0d">
<h2 id="org905ec0d">Visualize the Data</h2>
<div class="outline-text-2" id="text-org905ec0d"></div>
<div class="outline-3" id="outline-container-orgddd3583">
<h3 id="orgddd3583">Obtain One Batch of Training Images</h3>
<div class="outline-text-3" id="text-orgddd3583">
<div class="highlight">
<pre><span></span><span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataiter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc17eae0">
<h3 id="orgc17eae0">Get One Image From the Batch</h3>
<div class="outline-text-3" id="text-orgc17eae0">
<div class="highlight">
<pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org88efff6">
<h3 id="org88efff6">Plot</h3>
<div class="outline-text-3" id="text-org88efff6">
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"First Image"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="first_image.png" src="first_image.png"></p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org953b1d2">
<h2 id="org953b1d2">Convolutional Autoencoder</h2>
<div class="outline-text-2" id="text-org953b1d2"></div>
<div class="outline-3" id="outline-container-orgc6540f0">
<h3 id="orgc6540f0">Encoder</h3>
<div class="outline-text-3" id="text-orgc6540f0">
<p>The encoder part of the network will be a typical convolutional pyramid. Each convolutional layer will be followed by a max-pooling layer to reduce the dimensions of the layers.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org3c03eba">
<h3 id="org3c03eba">Decoder</h3>
<div class="outline-text-3" id="text-org3c03eba">
<p>The decoder, though, might be something new to you. The decoder needs to convert from a narrow representation to a wide, reconstructed image. For example, the representation could be a 7x7x4 max-pool layer. This is the output of the encoder, but also the input to the decoder. We want to get a 28x28x1 image out from the decoder so we need to work our way back up from the compressed representation. A schematic of the network is shown below.</p>
<div class="highlight">
<pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">"png"</span><span class="p">)</span>

<span class="c1"># Input layer</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"28x28x1 Input"</span><span class="p">)</span>

<span class="c1"># the Encoder</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"28x28x16 Convolution"</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"c"</span><span class="p">,</span> <span class="s2">"14x14x16 MaxPool"</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"d"</span><span class="p">,</span> <span class="s2">"14x14x4 Convolution"</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"e"</span><span class="p">,</span> <span class="s2">"7x7x4 MaxPool"</span><span class="p">)</span>

<span class="c1"># The Decoder</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"f"</span><span class="p">,</span> <span class="s2">"14x14x16 Transpose Convolution"</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"g"</span><span class="p">,</span> <span class="s2">"28x28x1 Transpose Convolution"</span><span class="p">)</span>

<span class="c1"># The Output</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"h"</span><span class="p">,</span> <span class="s2">"28x28x1 Output"</span><span class="p">)</span>

<span class="n">edges</span> <span class="o">=</span> <span class="s2">"abcdefgh"</span>
<span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>

<span class="n">graph</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"graphs/network_graph.dot"</span><span class="p">)</span>
<span class="n">graph</span>
</pre></div>
<div class="figure">
<p><img alt="network_graph.dot.png" src="../../../files/posts/nano/autoencoders/convolutional-autoencoder/network_graph.dot.png"></p>
</div>
<div class="figure">
<p><img alt="network_graph.dot.png" src="network_graph.dot.png"></p>
</div>
<p>Here our final encoder layer has size 7x7x4 = 196. The original images have size 28x28 = 784, so the encoded vector is 25% the size of the original image. These are just suggested sizes for each of the layers. Feel free to change the depths and sizes, in fact, you're encouraged to add additional layers to make this representation even smaller! Remember our goal here is to find a small representation of the input data.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgb2fb44c">
<h2 id="orgb2fb44c">Transpose Convolutions, Decoder</h2>
<div class="outline-text-2" id="text-orgb2fb44c">
<p>This decoder uses <b>transposed convolutional</b> layers to increase the width and height of the input layers. They work almost exactly the same as convolutional layers, but in reverse. A stride in the input layer results in a larger stride in the transposed convolution layer. For example, if you have a 3x3 kernel, a 3x3 patch in the input layer will be reduced to one unit in a convolutional layer. Comparatively, one unit in the input layer will be expanded to a 3x3 path in a transposed convolution layer. PyTorch provides us with an easy way to create the layers, <a href="https://pytorch.org/docs/stable/nn.html#convtranspose2d"><code>nn.ConvTranspose2d</code></a>.</p>
<p>It is important to note that transpose convolution layers can lead to artifacts in the final images, such as checkerboard patterns. This is due to overlap in the kernels which can be avoided by setting the stride and kernel size equal. In <a href="http://distill.pub/2016/deconv-checkerboard/">this Distill article</a> from Augustus Odena, <b>et al</b>, the authors show that these checkerboard artifacts can be avoided by resizing the layers using nearest neighbor or bilinear interpolation (upsampling) followed by a convolutional layer.</p>
<p>We'll show this approach in another notebook, so you can experiment with it and see the difference.</p>
<ul class="org-ul">
<li>Build the encoder out of a series of convolutional and pooling layers.</li>
<li>When building the decoder, recall that transpose convolutional layers can upsample an input by a factor of 2 using a stride and kernel_size of 2.</li>
</ul>
<p>See:</p>
<ul class="org-ul">
<li><a href="https://pytorch.org/docs/stable/nn.html?highlight=conv2d#torch.nn.Conv2d">Conv2d</a></li>
<li><a href="https://pytorch.org/docs/stable/nn.html?highlight=maxpool#torch.nn.MaxPool2d">MaxPool2d</a></li>
<li><a href="https://pytorch.org/docs/stable/nn.html#relu">ReLU</a></li>
<li><a href="https://pytorch.org/docs/stable/nn.html#sigmoid">Sigmoid</a></li>
</ul>
<p>To get the output size of our Convolutional Layers you use the formula:</p>
<p>\[ o = \frac{W - F + 2P}{S} + 1 \]</p>
<p>Where <i>W</i> is the input size (28 here), <i>F</i> is the filter size, <i>P</i> is the zero-padding, and <i>S</i> is the stride. For our first layer we want to keep the output the same size as the input.</p>
<p>The output for a maxpool layer uses a similar set of equations.</p>
\begin{align} W_2 &amp;= \frac{W_1 - F}{S} + 1\\ H_2 &amp;= \frac{H_Y - F}{S} + 1\\ D_2 = D_1\\ \end{align}
<p>Where <i>W</i> is the width, <i>H</i> is the height, and <i>D</i> is the depth.</p>
<div class="highlight">
<pre><span></span><span class="n">Layer</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Layer"</span><span class="p">,</span> <span class="s2">"kernel stride depth padding"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">Layer</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span><span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
<span class="k">def</span> <span class="nf">output_size</span><span class="p">(</span><span class="n">input_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">Layer</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Calculates the output size of the layer</span>

<span class="sd">    Args:</span>
<span class="sd">     input_size: the size of the input to the layer</span>
<span class="sd">     layer: named tuple with values for the layer</span>
<span class="sd">     expected: the value you are expecting</span>

<span class="sd">    Returns:</span>
<span class="sd">     the size of the output</span>

<span class="sd">    Raises:</span>
<span class="sd">     AssertionError: the calculated value wasn't the expected one</span>
<span class="sd">    """</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">input_size</span> <span class="o">-</span> <span class="n">layer</span><span class="o">.</span><span class="n">kernel</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">layer</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span><span class="o">/</span><span class="n">layer</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Layer Output Size: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">size</span> <span class="o">==</span> <span class="n">expected</span>
    <span class="k">return</span> <span class="n">size</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-org34370f0">
<h3 id="org34370f0">The Encoder Layers</h3>
<div class="outline-text-3" id="text-org34370f0"></div>
<div class="outline-4" id="outline-container-org48dec25">
<h4 id="org48dec25">Layer One</h4>
<div class="outline-text-4" id="text-org48dec25">
<p>The first layer is a Convolutional Layer that we want to have the same size output as the input but with a depth of sixteen. The <a href="https://cs231n.github.io/convolutional-networks/">CS 231</a> page notes that to keep the size of the output the same as the input you should set the stride to one and once you have decided on your kernle size (<i>F</i>) then you can find your padding using this equation:</p>
<p>\[ P = \frac{F - 1}{2} \]</p>
<p>In this case I'm going to use a filter size of three so our padding will be:</p>
\begin{align} P &amp;= \frac{3 - 1}{2}\\ &amp;= 1\\ \end{align}
<p>We can double-check this by plugging the values back intoo the equation for output size.</p>
\begin{align} W' &amp;= \frac{W - F + 2P}{S} + 1\\ &amp;= \frac{28 - 3 + 2(1)}{1} + 1\\ &amp;= 28\\ \end{align}
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Variable</th>
<th class="org-left" scope="col">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><i>W</i></td>
<td class="org-left">One dimension of the input</td>
</tr>
<tr>
<td class="org-left"><i>F</i></td>
<td class="org-left">One dimension of the Kernel (filter)</td>
</tr>
<tr>
<td class="org-left"><i>S</i></td>
<td class="org-left">Stride</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span> <span class="n">layer_one</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                   <span class="n">padding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>

 <span class="n">INPUT_ONE</span> <span class="o">=</span> <span class="mi">28</span>
 <span class="n">OUTPUT_ONE</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">(</span><span class="n">INPUT_ONE</span><span class="p">,</span> <span class="n">layer_one</span><span class="p">,</span> <span class="n">INPUT_ONE</span><span class="p">)</span>
 <span class="n">INPUT_DEPTH</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
<pre class="example">
Layer(kernel=3, stride=1, depth=16, padding=1)
Layer Output Size: 28.0
</pre></div>
</div>
<div class="outline-4" id="outline-container-org7dc8d3c">
<h4 id="org7dc8d3c">Layer Two</h4>
<div class="outline-text-4" id="text-org7dc8d3c">
<p>The second layer is a MaxPool layer that will keep the depth of six but will halve the size to fourteen. According to the <a href="https://cs231n.github.io/convolutional-networks/">CS 231 n</a> page on Convolutional Networks, there are only two values for the kernel size that are usually used - 2 and 3, and the stride is usually just 2, with a kernel size of 2 being more common, and as it turns out, a kernel size of 2 and a stride of 2 will reduce our input dimensions by a half, which is what we want.</p>
\begin{align} W &amp;= \frac{28 - 2}{2} + 1\\ &amp;= 14\\ \end{align}
<div class="highlight">
<pre><span></span> <span class="n">layer_two</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">layer_one</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
 <span class="n">OUTPUT_TWO</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">(</span><span class="n">OUTPUT_ONE</span><span class="p">,</span> <span class="n">layer_two</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
</pre></div>
<pre class="example">
Layer(kernel=2, stride=2, depth=16, padding=0)
Layer Output Size: 14.0
</pre></div>
</div>
<div class="outline-4" id="outline-container-org88760cd">
<h4 id="org88760cd">Layer Three</h4>
<div class="outline-text-4" id="text-org88760cd">
<p>Our third layer is another convolutional layer that preserves the input width and height but this time the output will have a depth of 4.</p>
<div class="highlight">
<pre><span></span><span class="n">layer_three</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">OUTPUT_THREE</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">(</span><span class="n">OUTPUT_TWO</span><span class="p">,</span> <span class="n">layer_three</span><span class="p">,</span> <span class="n">OUTPUT_TWO</span><span class="p">)</span>
</pre></div>
<pre class="example">
Layer(kernel=3, stride=1, depth=4, padding=1)
Layer Output Size: 14.0
</pre></div>
</div>
<div class="outline-4" id="outline-container-org3539692">
<h4 id="org3539692">Layer Four</h4>
<div class="outline-text-4" id="text-org3539692">
<p>The last layer in the encoder is a max pool layer that reduces the previous layer by half (to dimensions of 7) while preserving the depth.</p>
<div class="highlight">
<pre><span></span><span class="n">layer_four</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">layer_three</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
<span class="n">OUTPUT_FOUR</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">(</span><span class="n">OUTPUT_THREE</span><span class="p">,</span> <span class="n">layer_four</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</pre></div>
<pre class="example">
Layer(kernel=2, stride=2, depth=4, padding=0)
Layer Output Size: 7.0
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org518fb33">
<h3 id="org518fb33">Decoders</h3>
<div class="outline-text-3" id="text-org518fb33"></div>
<div class="outline-4" id="outline-container-org16c85e1">
<h4 id="org16c85e1">Layer Five</h4>
<div class="outline-text-4" id="text-org16c85e1">
<p>We want an output of 14 x 14 x 16 from an input of 7 x 7 x 4. The comments given with this exercise say that using a kernel of 2 and stride of 2 will double the dimensions, much as those same values halve the dimensions with Max-Pooling.</p>
<div class="highlight">
<pre><span></span><span class="n">layer_five</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb5fa887">
<h4 id="orgb5fa887">Layer Six</h4>
<div class="outline-text-4" id="text-orgb5fa887">
<p>This layer will expand the image back to its original size of 28 x 28 x 1</p>
<div class="highlight">
<pre><span></span><span class="n">layer_six</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org8c1c313">
<h3 id="org8c1c313">Define the NN Architecture</h3>
<div class="outline-text-3" id="text-org8c1c313">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">ConvAutoencoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""A CNN AutoEncoder-Decoder"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1">## encoder layers ##</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convolution_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">INPUT_DEPTH</span><span class="p">,</span>
                                       <span class="n">out_channels</span><span class="o">=</span><span class="n">layer_one</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                                       <span class="n">kernel_size</span><span class="o">=</span><span class="n">layer_one</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> 
                                       <span class="n">stride</span><span class="o">=</span><span class="n">layer_one</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span>
                                       <span class="n">padding</span><span class="o">=</span><span class="n">layer_one</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">layer_two</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
                                       <span class="n">stride</span><span class="o">=</span><span class="n">layer_two</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">convolution_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">layer_two</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                                       <span class="n">out_channels</span><span class="o">=</span><span class="n">layer_three</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                                       <span class="n">kernel_size</span><span class="o">=</span><span class="n">layer_three</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
                                       <span class="n">stride</span><span class="o">=</span><span class="n">layer_three</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span>
                                       <span class="n">padding</span><span class="o">=</span><span class="n">layer_three</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>

        <span class="c1">## decoder layers ##</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transpose_convolution_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="n">layer_four</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> 
            <span class="n">out_channels</span><span class="o">=</span><span class="n">layer_five</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="n">layer_five</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
            <span class="n">stride</span><span class="o">=</span><span class="n">layer_five</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transpose_convolution_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="n">layer_five</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> 
            <span class="n">out_channels</span><span class="o">=</span><span class="n">layer_six</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="n">layer_six</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
            <span class="n">stride</span><span class="o">=</span><span class="n">layer_six</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="c1">## encode ##</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convolution_1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convolution_2</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="c1">## decode ##</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transpose_convolution_1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transpose_convolution_2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">ConvAutoencoder</span><span class="p">()</span>
<span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataiter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">convolution_1</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">max_pool_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">convolution_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">max_pool_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">transpose_convolution_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">transpose_convolution_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">])</span>
</pre></div>
<pre class="example">
torch.Size([20, 16, 28, 28])
torch.Size([20, 16, 14, 14])
torch.Size([20, 16, 14, 14])
torch.Size([20, 4, 14, 14])
torch.Size([20, 4, 7, 7])
torch.Size([20, 4, 7, 7])
torch.Size([20, 16, 14, 14])
torch.Size([20, 16, 14, 14])
torch.Size([20, 1, 28, 28])
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org64522aa">
<h2 id="org64522aa">Initialize The NN</h2>
<div class="outline-text-2" id="text-org64522aa">
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ConvAutoencoder</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
<pre class="example">
ConvAutoencoder(
  (convolution_1): Conv2d(1, 16, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
  (max_pool): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
  (convolution_2): Conv2d(16, 4, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
  (transpose_convolution_1): ConvTranspose2d(4, 16, kernel_size=(2, 2), stride=(2, 2))
  (transpose_convolution_2): ConvTranspose2d(16, 1, kernel_size=(2, 2), stride=(2, 2))
  (relu): ReLU()
  (sigmoid): Sigmoid()
)
</pre></div>
</div>
<div class="outline-2" id="outline-container-org7e5532c">
<h2 id="org7e5532c">Training</h2>
<div class="outline-text-2" id="text-org7e5532c">
<p>Here I'll write a bit of code to train the network. I'm not too interested in validation here, so I'll just monitor the training loss and the test loss afterwards.</p>
<p>We are not concerned with labels in this case, just images, which we can get from the <code>train_loader</code>. Because we're comparing pixel values in input and output images, it will be best to use a loss that is meant for a regression task. Regression is all about comparing quantities rather than probabilistic values. So, in this case, I'll use <a href="https://pytorch.org/docs/stable/nn.html?highlight=mseloss#torch.nn.MSELoss">MSELoss</a>. And compare output images and input images as follows:</p>
<div class="highlight">
<pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>
</pre></div>
<p>Otherwise, this is pretty straightfoward training with PyTorch. Since this is a convolutional autoencoder, our images <i>do not</i> need to be flattened before being passed in an input to our model.</p>
</div>
<div class="outline-3" id="outline-container-org73f48e7">
<h3 id="org73f48e7">Train the Model</h3>
<div class="outline-text-3" id="text-org73f48e7">
<div class="highlight">
<pre><span></span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">started</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># monitor training loss</span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1">###################</span>
    <span class="c1"># train the model #</span>
    <span class="c1">###################</span>

    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
        <span class="c1"># _ stands in for labels, here</span>
        <span class="c1"># no need to flatten images</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># clear the gradients of all optimized variables</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="c1"># forward pass: compute predicted outputs by passing inputs to the model</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="c1"># calculate the loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>
        <span class="c1"># backward pass: compute gradient of the loss with respect to model parameters</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="c1"># perform a single optimization step (parameter update)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="c1"># update running training loss</span>
        <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">*</span><span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># print avg training statistics </span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Epoch: </span><span class="si">{}</span><span class="s1"> </span><span class="se">\t</span><span class="s1">Training Loss: </span><span class="si">{:.6f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">epoch</span><span class="p">,</span> 
        <span class="n">train_loss</span>
        <span class="p">))</span>
<span class="n">ended</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Ended: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ended</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Elapsed: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ended</span> <span class="o">-</span> <span class="n">started</span><span class="p">))</span>
</pre></div>
<pre class="example">
Epoch: 1        Training Loss: 0.259976
Epoch: 2        Training Loss: 0.244956
Epoch: 3        Training Loss: 0.235354
Epoch: 4        Training Loss: 0.226544
Epoch: 5        Training Loss: 0.216255
Epoch: 6        Training Loss: 0.207204
Epoch: 7        Training Loss: 0.200490
Epoch: 8        Training Loss: 0.195582
Epoch: 9        Training Loss: 0.191870
Epoch: 10       Training Loss: 0.189247
Epoch: 11       Training Loss: 0.187027
Epoch: 12       Training Loss: 0.185084
Epoch: 13       Training Loss: 0.183055
Epoch: 14       Training Loss: 0.181224
Epoch: 15       Training Loss: 0.179749
Epoch: 16       Training Loss: 0.178564
Epoch: 17       Training Loss: 0.177572
Epoch: 18       Training Loss: 0.176735
Epoch: 19       Training Loss: 0.176076
Epoch: 20       Training Loss: 0.175518
Epoch: 21       Training Loss: 0.175040
Epoch: 22       Training Loss: 0.174629
Epoch: 23       Training Loss: 0.174230
Epoch: 24       Training Loss: 0.173856
Epoch: 25       Training Loss: 0.173497
Epoch: 26       Training Loss: 0.173166
Epoch: 27       Training Loss: 0.172838
Epoch: 28       Training Loss: 0.172520
Epoch: 29       Training Loss: 0.172212
Epoch: 30       Training Loss: 0.171920
Ended: 2018-12-21 17:41:26.461977
Elapsed: 0:07:50.942721
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org49e2bc4">
<h2 id="org49e2bc4">Checking out the results</h2>
<div class="outline-text-2" id="text-org49e2bc4">
<p>Below I've plotted some of the test images along with their reconstructions. These look a little rough around the edges, likely due to the checkerboard effect we mentioned above that tends to happen with transpose layers.</p>
</div>
<div class="outline-3" id="outline-container-org91102e7">
<h3 id="org91102e7">Obtain One Batch Of Test Images</h3>
<div class="outline-text-3" id="text-org91102e7">
<div class="highlight">
<pre><span></span><span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataiter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org33e3a11">
<h3 id="org33e3a11">Get Sample Outputs</h3>
<div class="outline-text-3" id="text-org33e3a11">
<div class="highlight">
<pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org3bc0c3a">
<h3 id="org3bc0c3a">Prep Images for Display</h3>
<div class="outline-text-3" id="text-org3bc0c3a">
<div class="highlight">
<pre><span></span><span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org149898a">
<h3 id="org149898a">Output Is Resized Into a Batch Of Images</h3>
<div class="outline-text-3" id="text-org149898a">
<div class="highlight">
<pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7e46dea">
<h3 id="org7e46dea">Use Detach When It's An Output That Requires Grad</h3>
<div class="outline-text-3" id="text-org7e46dea">
<div class="highlight">
<pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7632b9e">
<h3 id="org7632b9e">plot the first ten input images and then reconstructed images</h3>
<div class="outline-text-3" id="text-org7632b9e">
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"Auto-Encoded/Decoded Images"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>
<span class="c1"># input images on top row, reconstructions on bottom</span>
<span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">images</span><span class="p">,</span> <span class="n">output</span><span class="p">],</span> <span class="n">axes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="reconstructed.png" src="reconstructed.png"></p>
</div>
<p>That is better than I would have thought it would be.</p>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../../categories/autoencoder/" rel="tag">autoencoder</a></li>
<li><a class="tag p-category" href="../../../../categories/cnn/" rel="tag">cnn</a></li>
<li><a class="tag p-category" href="../../../../categories/exercise/" rel="tag">exercise</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../simple-autoencoder/" rel="prev" title="Simple Autoencoder">Previous post</a></li>
<li class="next"><a href="../denoising-autoencoder/" rel="next" title="Denoising Autoencoder">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script>
</body>
</html>
