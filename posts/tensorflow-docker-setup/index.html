<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Setting up tensorflow with docker." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Tensorflow Docker Setup | Neurotic Networking</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/tensorflow-docker-setup/" rel="canonical"><!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]-->
<link href="../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../nlp/sentiment-analysis-testing-the-model/" rel="prev" title="Sentiment Analysis: Testing the Model" type="text/html">
<link href="../nlp/hidden-state-activation/" rel="next" title="Hidden State Activation" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Tensorflow Docker Setup" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/tensorflow-docker-setup/" property="og:url">
<meta content="Setting up tensorflow with docker." property="og:description">
<meta content="article" property="og:type">
<meta content="2020-12-27T14:12:26-08:00" property="article:published_time">
<meta content="docker" property="article:tag">
<meta content="jupyter" property="article:tag">
<meta content="tensorflow" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Tensorflow Docker Setup</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2020-12-27T14:12:26-08:00" itemprop="datePublished" title="2020-12-27 14:12">2020-12-27 14:12</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8658920">Beginning</a></li>
<li><a href="#org294a9e3">Setting Up</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org8658920">
<h2 id="org8658920">Beginning</h2>
<div class="outline-text-2" id="text-org8658920">
<p>I recently re-started using tensorflow and the python interpreter kept crashing. It appears that they compiled the latest version to require <a href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions#Advanced_Vector_Extensions_2">AVX2</a> and the server I was using has <a href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions#Advanced_Vector_Extensions_2">AVX</a> but not AVX2. I couldn't find any documentation about this requirement, but running the code on a different machine that has both AVX and AVX2 got rid of the problem. This might be a transient problem, as the nightly build doesn't crash on either machine, but trying to run the nightly build with other code is a nightmare as it seems that every framework related to tensorflow tries to revert the version back to the broken one, so I gave up and changed machines. The process of setting up cuda and tensorflow over and over again proved difficult, as there's different ways to do it (through apt, using nvidia installers, building from source) and each presents a different problem. The version apt installs, for instance puts the folders in places the tensorflow <code>configure.py</code> file can't figure out (if you build tensorflow from source) and using the nvidia debian package for cudnn left my packages in a broken state, as it was trying to install something that then broke another packages requirementsâ€¦ Anyway, I'm going to try and avoid building tensorflow from source and run everything from docker containers.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org294a9e3">
<h2 id="org294a9e3">Setting Up</h2>
<div class="outline-text-2" id="text-org294a9e3">
<p>I don't know for sure that this is necessary, but I followed <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker">nvidia's docker installation</a> instructions. If nothing else you can use it to check that the setup works. After that I setup tensorflow's container with a dockerfile:</p>
<div class="highlight">
<pre><span></span>FROM tensorflow/tensorflow:latest-gpu-py3-jupyter
RUN apt-get update &amp;& \
        apt-get install openssh-server --yes &amp;& \
        echo "Adding neurotic user" &amp;& \
        useradd --create-home --shell /bin/bash neurotic
COPY authorized_keys /home/neurotic/.ssh/
ENTRYPOINT service ssh restart &amp;& bash
</pre></div>
<p>The latest tensorflow container comes with python 2.7 as the default for some reason, and all the dependencies are installed with it in mind so to get python 3 (3.6 as of now) you need to specify the <code>py3</code> tag like I did in the from line. Additionally I use ssh-forwarding for jupyter kernels so I can work in emacs with them so I installed the ssh-server and also created a non-root user to run jupyter. The last line <code>ENTRYPOINT service ssh restart &amp;& bash</code> makes sure the ssh-server is running and opens up a bash shell. To build the container I used this command:</p>
<div class="highlight">
<pre><span></span>docker build -t neurotic-tensorflow .
</pre></div>
<p>This creates an image named <code>neurotic-tensorflow</code>. To run it I use this command:</p>
<div class="highlight">
<pre><span></span>docker run --gpus all -p 2222:22 --name data-neurotic \
       --mount type=bind,source=$HOME/projects/neurotic-networks,target=/home/neurotic/neurotic-networks \
       --mount type=bind,source=/media/data,target=/home/neurotic/data \
       -it neurotic-tensorflow bash
</pre></div>
<p>The <code>--gpus all</code> makes the GPUs available. The <code>-p 2222:22</code> flag maps the ssh-server in the container to port 2222 on the host. This allows you to ssh into the container using <code>ssh neurotic@localhost -p 2222</code> without knowing the IP address of the container. You can also grab the IP address and then ssh into it like it's another machine on the network:</p>
<div class="highlight">
<pre><span></span>docker inspect --format "{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}" data-neurotic
</pre></div>
<p>Where <code>data-neurotic</code> is the name given to the container in the <code>docker run</code> command, but the advantage of the port mapping is that:</p>
<ul class="org-ul">
<li>You don't need to know the address of the container if you are on the host machine.</li>
<li>You can ssh into the container from another machine by substituting the host's IP address for <code>localhost</code> in the ssh command</li>
</ul>
<p>The <code>mount</code> options mount some folders into the container so we can share files.</p>
<p>Once you've run it you can restart it at any time using:</p>
<div class="highlight">
<pre><span></span>docker start data-neurotic
</pre></div>
<p>And if you need to run something as root you can attach the running container.</p>
<div class="highlight">
<pre><span></span>docker attach data-neurotic
</pre></div>
<p><b>NOTE:</b> The python 3 container has cuda 10.1 installed but the latest version of tensorflow expects 11.0 - and tensorflow seems to use hard-coded names. So to make it work you either have to upgrade cuda or symlink the file and rename it to look like the newer version.</p>
<div class="highlight">
<pre><span></span>ln -s /usr/local/cuda-10.1/targets/x86_64-linux/lib/libcudart.so.10.1 /usr/lib/x86_64-linux-gnu/libcudart.so.11.0
</pre></div>
<p>Tensorflow dependencies are incredibly convoluted and broken all over the place.</p>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../categories/docker/" rel="tag">docker</a></li>
<li><a class="tag p-category" href="../../categories/jupyter/" rel="tag">jupyter</a></li>
<li><a class="tag p-category" href="../../categories/tensorflow/" rel="tag">tensorflow</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../nlp/sentiment-analysis-testing-the-model/" rel="prev" title="Sentiment Analysis: Testing the Model">Previous post</a></li>
<li class="next"><a href="../nlp/hidden-state-activation/" rel="next" title="Hidden State Activation">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer"><a href="https://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://licensebuttons.net/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
