<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Studies in Deep Learning." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Neurotic Networking</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/" rel="canonical">
<link href="index-10.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
<link href="posts/nlp/naive-bayes-twitter-sentiment-classification/" rel="prefetch" type="text/html">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="."><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item active"><a class="nav-link" href=".">Cloistered Monkey <span class="sr-only">(active)</span></a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/naive-bayes-twitter-sentiment-classification/">Naive Bayes Twitter Sentiment Classification</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/" rel="bookmark"><time class="published dt-published" datetime="2020-08-25T10:16:04-07:00" itemprop="datePublished" title="2020-08-25 10:16">2020-08-25 10:16</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#orgd1a7cdd">Beginning</a>
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#orgb9c06d2">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#orge03d773">Middle</a>
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org1c00004">Training the Naive Bayes Classifier</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org4424e41">Testing The Model</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org74ba438">Filtering Words</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org0c93422">Error Analysis</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#orgb9aa999">Predict Your Own Tweet</a></li>
</ul>
</li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org976e2b4">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgd1a7cdd">
<h2 id="orgd1a7cdd">Beginning</h2>
<div class="outline-text-2" id="text-orgd1a7cdd"></div>
<div class="outline-3" id="outline-container-orgb9c06d2">
<h3 id="orgb9c06d2">Set Up</h3>
<div class="outline-text-3" id="text-orgb9c06d2"></div>
<div class="outline-4" id="outline-container-org83bccf9">
<h4 id="org83bccf9">Imports</h4>
<div class="outline-text-4" id="text-org83bccf9">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org683bcd2">
<h4 id="org683bcd2">Tabulate</h4>
<div class="outline-text-4" id="text-org683bcd2">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgfdee454">
<h4 id="orgfdee454">The Dotenv</h4>
<div class="outline-text-4" id="text-orgfdee454">
<p>I put the path to the data files in a .env file so this loads it into the environment.</p>
<div class="highlight">
<pre><span></span><span class="n">env_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">env_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6834c6c">
<h4 id="org6834c6c">The Timer</h4>
<div class="outline-text-4" id="text-org6834c6c">
<p>This is a helper to keep track of how long things are taking.</p>
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org80cdaaa">
<h4 id="org80cdaaa">Load the Twitter Data</h4>
<div class="outline-text-4" id="text-org80cdaaa">
<p>I split the data <a href="posts/nlp/01-twitter-preprocessing-with-nltk/">previously</a> for the Logistic Regression twitter sentiment classifier so I'll load it here and skip building the sets.</p>
<div class="highlight">
<pre><span></span><span class="n">train_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="n">test_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training: {len(train_raw):,}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Testing: {len(test_raw):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training: 8,000
Testing: 2,000
</pre>
<p>I'll also re-use the WordCounter from the Logistic Regression. Despite the name it also does tokenizing and cleaning.</p>
<div class="highlight">
<pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2829255">
<h4 id="org2829255">Constants</h4>
<div class="outline-text-4" id="text-org2829255">
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_SENTIMENT"</span><span class="p">],</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Sentiment</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">Sentiment</span><span class="p">)</span>
</pre></div>
<pre class="example">
Namespace(decode={1: 'positive', 0: 'negative'}, encode={'positive': 1, 'negative': 0}, negative=0, positive=1)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orge03d773">
<h2 id="orge03d773">Middle</h2>
<div class="outline-text-2" id="text-orge03d773"></div>
<div class="outline-3" id="outline-container-org1c00004">
<h3 id="org1c00004">Training the Naive Bayes Classifier</h3>
<div class="outline-text-3" id="text-org1c00004"></div>
<div class="outline-4" id="outline-container-org0b349f4">
<h4 id="org0b349f4">Priors and Log Priors</h4>
<div class="outline-text-4" id="text-org0b349f4">
<p>\(P(D_{pos})\) is the probability that the document is positive. \(P(D_{neg})\) is the probability that the document is negative.</p>
<p>Use the formulas as follows and store the values in a dictionary:</p>
\begin{align} P(D_{pos}) &amp;= \frac{D_{pos}}{D}\\ P(D_{neg}) &amp;= \frac{D_{neg}}{D}\\ \end{align}
<p>Where \(D\) is the total number of documents, or tweets in this case, \(D_{pos}\) is the total number of positive tweets and \(D_{neg}\) is the total number of negative tweets.</p>
<p>The prior is the ratio of the probabilities \(\frac{P(D_{pos})}{P(D_{neg})}\). If you look at the definitions of the probabilities, they have the same denominator (<i>D</i>) so taking the ratio of the probabilities means the denominator cancels out and we don't really need it.</p>
\begin{align} \frac{P(D_{pos})}{P(D_{neg})} &amp;= \frac{\frac{D_{pos}}{D}}{\frac{D_{neg}}{D}}\\ &amp;= \frac{\left( \frac{D_{pos}}{\cancel{D}}\right) \left(\frac{\cancel{D}}{D_{neg}}\right) }{ \cancel{\left(\frac{D_{neg}}{D}\right)} \cancel{\left(\frac{D}{D_{neg}}\right)} }\\ &amp;= \frac{D_{pos}}{D_{neg}}\\ \end{align}
<p>We can take the log of the prior to rescale it, and we'll call this the logprior.</p>
\begin{align} \text{logprior} &amp;= log \left( \frac{P(D_{pos})}{P(D_{neg})} \right) \\ &amp;= log \left( \frac{D_{pos}}{D_{neg}} \right)\\ \end{align}
<p>Note that \(log(\frac{A}{B})\) is the same as \(log(A) - log(B)\). So the logprior can also be calculated as the difference between two logs:</p>
\begin{align} \text{logprior} &amp;= \log (P(D_{pos})) - \log (P(D_{neg})) \\ &amp;= \log (D_{pos}) - \log (D_{neg})\\ \end{align}</div>
</div>
<div class="outline-4" id="outline-container-orgd5b2f39">
<h4 id="orgd5b2f39">Positive and Negative Probabilities</h4>
<div class="outline-text-4" id="text-orgd5b2f39">
<p>To compute the positive probability and the negative probability for a specific word in the vocabulary, we'll use the following inputs:</p>
<ul class="org-ul">
<li>\(freq_{pos}\) and \(freq_{neg}\) are the frequencies of that specific word in the positive or negative class. In other words, the positive frequency of a word is the number of times the word is counted with the label of 1.</li>
<li>\(N_{pos}\) and \(N_{neg}\) are the total number of positive and negative words for all documents (for all tweets), respectively.</li>
<li><i>V</i> is the number of unique words in the entire set of documents, for all classes, whether positive or negative.</li>
</ul>
<p>We'll use these to compute the positive and negative probability for a specific word using this formula:</p>
\begin{align} P(W_{pos}) &amp;= \frac{freq_{pos} + 1}{N_{pos} + V}\\ P(W_{neg}) &amp;= \frac{freq_{neg} + 1}{N_{neg} + V}\\ \end{align}
<p>Notice that we add the "+1" in the numerator for additive smoothing. This <a href="https://en.wikipedia.org/wiki/Additive_smoothing">wiki article</a> explains more about additive smoothing.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org1029247">
<h4 id="org1029247">Log Likelihood</h4>
<div class="outline-text-4" id="text-org1029247">
<p>To compute the loglikelihood of that very same word, we can implement the following equations:</p>
<p>\[ \text{loglikelihood} = \log \left(\frac{P(W_{pos})}{P(W_{neg})} \right) \]</p>
</div>
</div>
<div class="outline-4" id="outline-container-org508a095">
<h4 id="org508a095">Calculating Stuff</h4>
<div class="outline-text-4" id="text-org508a095">
<ul class="org-ul">
<li><i>V</i> is the number of unique words in our word counter.</li>
<li>\(freq_{pos}\) and \(freq_{neg}\) are what <code>counter.counts</code> has for the values</li>
<li>\(N_{pos}\) and \(N_{neg}\) are the total number of positive and negative words respectively, which we can calculate from the counter</li>
<li><i>D</i> is the number of documents in the training set</li>
<li>\(D_{pos}\) and \(D_{neg}\) are the number of documents labeled positive and those labeled negative</li>
</ul>
</div>
</div>
<div class="outline-4" id="outline-container-orgb798006">
<h4 id="orgb798006">The Function</h4>
<div class="outline-text-4" id="text-orgb798006">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">train_naive_bayes</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Input:</span>
<span class="sd">       freqs: dictionary from (word, label) to how often the word appears</span>
<span class="sd">       train_x: a list of tweets</span>
<span class="sd">       train_y: a list of labels correponding to the tweets (0,1)</span>
<span class="sd">    Output:</span>
<span class="sd">       logprior: the log prior. (equation 3 above)</span>
<span class="sd">       loglikelihood: the log likelihood of you Naive bayes equation. (equation 6 above)</span>
<span class="sd">    '''</span>
    <span class="n">loglikelihood</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">logprior</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">### START CODE HERE (REPLACE INSTANCES OF 'None' with your code) ###</span>

    <span class="c1"># calculate V, the number of unique words in the vocabulary</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">freqs</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="n">V</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>

    <span class="c1"># calculate N_pos and N_neg</span>
    <span class="n">N_pos</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">freqs</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">freqs</span>
                 <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span>
    <span class="n">N_neg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">freqs</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">freqs</span>
                 <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">))</span>

    <span class="c1"># Calculate D, the number of documents</span>
    <span class="n">D</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>

    <span class="c1"># Calculate D_pos, the number of positive documents (*hint: use sum(&lt;np_array&gt;))</span>
    <span class="n">D_pos</span> <span class="o">=</span> <span class="n">train_y</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Calculate D_neg, the number of negative documents (*hint: compute using D and D_pos)</span>
    <span class="n">D_neg</span> <span class="o">=</span> <span class="n">D</span> <span class="o">-</span> <span class="n">D_pos</span>

    <span class="c1"># Calculate logprior</span>
    <span class="n">logprior</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">D_pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">D_neg</span><span class="p">)</span>

    <span class="c1"># For each word in the vocabulary...</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">:</span>
        <span class="c1"># get the positive and negative frequency of the word</span>
        <span class="n">freq_pos</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">)]</span>
        <span class="n">freq_neg</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">)]</span>

        <span class="c1"># calculate the probability that each word is positive, and negative</span>
        <span class="n">p_w_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N_pos</span> <span class="o">+</span> <span class="n">V</span><span class="p">)</span>
        <span class="n">p_w_neg</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_neg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N_neg</span> <span class="o">+</span> <span class="n">V</span><span class="p">)</span>

        <span class="c1"># calculate the log likelihood of the word</span>
        <span class="n">loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_w_pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_w_neg</span><span class="p">)</span>

    <span class="c1">### END CODE HERE ###</span>

    <span class="k">return</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">all_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_raw</span><span class="p">,</span> <span class="n">test_raw</span><span class="p">])</span>
<span class="n">check</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">all_raw</span><span class="p">[</span><span class="n">all_raw</span><span class="o">.</span><span class="n">label</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4000</span><span class="p">],</span> <span class="n">all_raw</span><span class="p">[</span><span class="n">all_raw</span><span class="o">.</span><span class="n">label</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4000</span><span class="p">]])</span>
<span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">train_naive_bayes</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">check</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">check</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Log Prior: {logprior}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Log Likelihood: {len(loglikelihood)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Log Prior: 0.0
Log Likelihood: 9172
</pre>
<div class="highlight">
<pre><span></span><span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">train_naive_bayes</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Log Prior: {logprior}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Log Likelihood: {len(loglikelihood)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-08-27 17:53:26,369 graeae.timers.timer start: Started: 2020-08-27 17:53:26.368827
2020-08-27 17:53:26,423 graeae.timers.timer end: Ended: 2020-08-27 17:53:26.423193
2020-08-27 17:53:26,424 graeae.timers.timer end: Elapsed: 0:00:00.054366
Log Prior: -0.006500022885560952
Log Likelihood: 9172
</pre>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{len(train_raw[train_raw.label==0]):,}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{len(train_raw[train_raw.label==1]):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
4,013
3,987
</pre>
<p>We end up with a negative prior in the second case because we don't have a perfect balance between the positive and negative counts.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org4424e41">
<h3 id="org4424e41">Testing The Model</h3>
<div class="outline-text-3" id="text-org4424e41">
<p>Implement the `naive_bayes_predict` function to make predictions on tweets.</p>
<ul class="org-ul">
<li>The function takes in the `tweet`, `logprior`, `loglikelihood`.</li>
<li>It returns the probability that the tweet belongs to the positive or negative class.</li>
<li>For each tweet, sum up loglikelihoods of each word in the tweet.</li>
<li>Also add the logprior to this sum to get the predicted sentiment of that tweet.</li>
</ul>
<p>\[ p = logprior + \sum_i^N (loglikelihood_i) \]</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">naive_bayes_predict</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Input:</span>
<span class="sd">       tweet: a string</span>
<span class="sd">       logprior: a number</span>
<span class="sd">       loglikelihood: a dictionary of words mapping to numbers</span>
<span class="sd">    Output:</span>
<span class="sd">       p: the sum of all the logliklihoods of each word in the tweet (if found in the dictionary) + logprior (a number)</span>

<span class="sd">    '''</span>
    <span class="c1"># process the tweet to get a list of words</span>
    <span class="n">word_l</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>

    <span class="c1"># initialize probability to zero</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># add the logprior</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">logprior</span>

    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_l</span><span class="p">:</span>

        <span class="c1"># check if the word exists in the loglikelihood dictionary</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">loglikelihood</span><span class="p">:</span>
            <span class="c1"># add the log likelihood of that word to the probability</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="n">loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>

    <span class="c1">### END CODE HERE ###</span>

    <span class="k">return</span> <span class="n">p</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">my_tweet</span> <span class="o">=</span> <span class="s1">'She smiled.'</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">my_tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'The expected output is'</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</pre></div>
<pre class="example">
The expected output is 1.44329786012511
</pre>
<p><b>Instructions</b>:</p>
<ul class="org-ul">
<li>Implement `test_naive_bayes` to check the accuracy of your predictions.</li>
<li>The function takes in your `test_x`, `test_y`, log_prior, and loglikelihood</li>
<li>It returns the accuracy of your model.</li>
<li>First, use `naive_bayes_predict` function to make predictions for each tweet in text_x.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">test_naive_bayes</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Input:</span>
<span class="sd">       test_x: A list of tweets</span>
<span class="sd">       test_y: the corresponding labels for the list of tweets</span>
<span class="sd">       logprior: the logprior</span>
<span class="sd">       loglikelihood: a dictionary with the loglikelihoods for each word</span>
<span class="sd">    Output:</span>
<span class="sd">       accuracy: (# of tweets classified correctly)/(total # of tweets)</span>
<span class="sd">    """</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># return this properly</span>

    <span class="c1">### START CODE HERE (REPLACE INSTANCES OF 'None' with your code) ###</span>
    <span class="n">y_hats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">test_x</span><span class="p">:</span>
        <span class="c1"># if the prediction is &gt; 0</span>
        <span class="k">if</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># the predicted class is 1</span>
            <span class="n">y_hat_i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise the predicted class is 0</span>
            <span class="n">y_hat_i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># append the predicted class to the list y_hats</span>
        <span class="n">y_hats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_hat_i</span><span class="p">)</span>

    <span class="c1"># error is the average of the absolute values of the differences between y_hats and test_y</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_hats</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_y</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Accuracy is 1 minus the error</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">error</span>
    <span class="k">return</span> <span class="n">accuracy</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"Naive Bayes accuracy = </span><span class="si">%0.4f</span><span class="s2">"</span> <span class="o">%</span>
      <span class="p">(</span><span class="n">test_naive_bayes</span><span class="p">(</span><span class="n">test_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)))</span>
</pre></div>
<pre class="example">
Naive Bayes accuracy = 0.9955
</pre>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'I am happy'</span><span class="p">,</span> <span class="s1">'I am bad'</span><span class="p">,</span> <span class="s1">'this movie should have been great.'</span><span class="p">,</span> <span class="s1">'great'</span><span class="p">,</span> <span class="s1">'great great'</span><span class="p">,</span> <span class="s1">'great great great'</span><span class="p">,</span> <span class="s1">'great great great great'</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'{tweet} -&gt; {p:.2f}'</span><span class="p">)</span>
</pre></div>
<pre class="example">
I am happy -&gt; 1.89
I am bad -&gt; -1.63
this movie should have been great. -&gt; 2.05
great -&gt; 2.06
great great -&gt; 4.13
great great great -&gt; 6.19
great great great great -&gt; 8.25
</pre>
<div class="highlight">
<pre><span></span><span class="n">my_tweet</span> <span class="o">=</span> <span class="s2">"the answer is in the umwelt"</span>
<span class="k">print</span><span class="p">(</span><span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">my_tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">))</span>
</pre></div>
<pre class="example">
-0.41441957689474407
</pre></div>
</div>
<div class="outline-3" id="outline-container-org74ba438">
<h3 id="org74ba438">Filtering Words</h3>
<div class="outline-text-3" id="text-org74ba438">
<ul class="org-ul">
<li>Some words have more positive counts than others, and can be considered "more positive". Likewise, some words can be considered more negative than others.</li>
<li>One way for us to define the level of positiveness or negativeness, without calculating the log likelihood, is to compare the positive to negative frequency of the word.</li>
<li>Note that we can also use the log likelihood calculations to compare relative positivity or negativity of words.</li>
<li>We can calculate the ratio of positive to negative frequencies of a word.</li>
<li>Once we're able to calculate these ratios, we can also filter a subset of words that have a minimum ratio of positivity / negativity or higher.</li>
<li>Similarly, we can also filter a subset of words that have a maximum ratio of positivity / negativity or lower (words that are at least as negative, or even more negative than a given threshold).</li>
<li>Given the `freqs` dictionary of words and a particular word, use `lookup(freqs,word,1)` to get the positive count of the word.</li>
<li>Similarly, use the `lookup()` function to get the negative count of that word.</li>
<li>Calculate the ratio of positive divided by negative counts</li>
</ul>
<p>\[ ratio = \frac{\text{pos_words} + 1}{\text{neg_words} + 1} \]</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Words</th>
<th class="org-right" scope="col">Positive word count</th>
<th class="org-right" scope="col">Negative Word Count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">glad</td>
<td class="org-right">41</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-left">arriv</td>
<td class="org-right">57</td>
<td class="org-right">4</td>
</tr>
<tr>
<td class="org-left">:(</td>
<td class="org-right">1</td>
<td class="org-right">3663</td>
</tr>
<tr>
<td class="org-left">:-(</td>
<td class="org-right">0</td>
<td class="org-right">378</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_ratio</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Input:</span>
<span class="sd">       freqs: dictionary containing the words</span>
<span class="sd">       word: string to lookup</span>

<span class="sd">    Output: a dictionary with keys 'positive', 'negative', and 'ratio'.</span>
<span class="sd">       Example: {'positive': 10, 'negative': 20, 'ratio': 0.5}</span>
<span class="sd">    '''</span>
    <span class="n">pos_neg_ratio</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'positive'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'negative'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'ratio'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

    <span class="c1"># use lookup() to find positive counts for the word (denoted by the integer 1)</span>
    <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s1">'positive'</span><span class="p">]</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="c1"># use lookup() to find negative counts for the word (denoted by integer 0)</span>
    <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s1">'negative'</span><span class="p">]</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>

    <span class="c1"># calculate the ratio of positive to negative counts for the word</span>
    <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s1">'ratio'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"positive"</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span>
        <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"negative"</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">### END CODE HERE ###</span>
    <span class="k">return</span> <span class="n">pos_neg_ratio</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">get_ratio</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="s1">'happi'</span><span class="p">))</span>
</pre></div>
<pre class="example">
{'positive': 160, 'negative': 23, 'ratio': 6.708333333333333}
</pre></div>
<div class="outline-4" id="outline-container-org1985c54">
<h4 id="org1985c54">get words by threshold</h4>
<div class="outline-text-4" id="text-org1985c54">
<ul class="org-ul">
<li>If we set the label to 1, then we'll look for all words whose threshold of positive/negative is at least as high as that threshold, or higher.</li>
<li>If we set the label to 0, then we'll look for all words whose threshold of positive/negative is at most as low as the given threshold, or lower.</li>
<li>Use the `get_ratio()` function to get a dictionary containing the positive count, negative count, and the ratio of positive to negative counts.</li>
<li>Append a dictionary to a list, where the key is the word, and the dictionary is the dictionary `pos_neg_ratio` that is returned by the `get_ratio()` function.</li>
</ul>
<p>An example key-value pair would have this structure:</p>
<div class="highlight">
<pre><span></span><span class="p">{</span><span class="s1">'happi'</span><span class="p">:</span>
     <span class="p">{</span><span class="s1">'positive'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'negative'</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">'ratio'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
 <span class="p">}</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_words_by_threshold</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Input:</span>
<span class="sd">       freqs: dictionary of words</span>
<span class="sd">       label: 1 for positive, 0 for negative</span>
<span class="sd">       threshold: ratio that will be used as the cutoff for including a word in the returned dictionary</span>
<span class="sd">    Output:</span>
<span class="sd">       word_set: dictionary containing the word and information on its positive count, negative count, and ratio of positive to negative counts.</span>
<span class="sd">       example of a key value pair:</span>
<span class="sd">       {'happi':</span>
<span class="sd">           {'positive': 10, 'negative': 20, 'ratio': 0.5}</span>
<span class="sd">       }</span>
<span class="sd">    '''</span>
    <span class="n">word_list</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1">### START CODE HERE (REPLACE INSTANCES OF 'None' with your code) ###</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
        <span class="n">word</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">key</span>

        <span class="c1"># get the positive/negative ratio for a word</span>
        <span class="n">pos_neg_ratio</span> <span class="o">=</span> <span class="n">get_ratio</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

        <span class="c1"># if the label is 1 and the ratio is greater than or equal to the threshold...</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">label</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"ratio"</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"ratio"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">)):</span>

            <span class="c1"># Add the pos_neg_ratio to the dictionary</span>
            <span class="n">word_list</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_neg_ratio</span>

        <span class="c1"># otherwise, do not include this word in the list (do nothing)</span>

    <span class="c1">### END CODE HERE ###</span>
    <span class="k">return</span> <span class="n">word_list</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">passed</span> <span class="o">=</span> <span class="n">get_words_by_threshold</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">passed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"word: {word}</span><span class="se">\t</span><span class="s2">{info}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
word: :(        {'positive': 1, 'negative': 3705, 'ratio': 0.0005396654074473826}
word: :-(       {'positive': 0, 'negative': 407, 'ratio': 0.0024509803921568627}
word: ♛ {'positive': 0, 'negative': 162, 'ratio': 0.006134969325153374}
word: 》 {'positive': 0, 'negative': 162, 'ratio': 0.006134969325153374}
word: beli̇ev   {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
word: wi̇ll     {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
word: justi̇n   {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
word: ｓｅｅ       {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
word: ｍｅ        {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
word: sad       {'positive': 3, 'negative': 100, 'ratio': 0.039603960396039604}
word: &gt;:(    {'positive': 0, 'negative': 36, 'ratio': 0.02702702702702703}
</pre>
<div class="highlight">
<pre><span></span><span class="n">passed</span> <span class="o">=</span> <span class="n">get_words_by_threshold</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">passed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"word: {word}</span><span class="se">\t</span><span class="s2">{info}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
word: :)        {'positive': 2967, 'negative': 1, 'ratio': 1484.0}
word: :-)       {'positive': 547, 'negative': 0, 'ratio': 548.0}
word: :D        {'positive': 537, 'negative': 0, 'ratio': 538.0}
word: :p        {'positive': 113, 'negative': 0, 'ratio': 114.0}
word: fback     {'positive': 22, 'negative': 0, 'ratio': 23.0}
word: blog      {'positive': 29, 'negative': 2, 'ratio': 10.0}
word: followfriday      {'positive': 19, 'negative': 0, 'ratio': 20.0}
word: recent    {'positive': 9, 'negative': 0, 'ratio': 10.0}
word: stat      {'positive': 52, 'negative': 0, 'ratio': 53.0}
word: arriv     {'positive': 57, 'negative': 4, 'ratio': 11.6}
word: thx       {'positive': 11, 'negative': 0, 'ratio': 12.0}
word: here'     {'positive': 19, 'negative': 0, 'ratio': 20.0}
word: influenc  {'positive': 16, 'negative': 0, 'ratio': 17.0}
word: bam       {'positive': 34, 'negative': 0, 'ratio': 35.0}
word: warsaw    {'positive': 34, 'negative': 0, 'ratio': 35.0}
word: welcom    {'positive': 58, 'negative': 4, 'ratio': 11.8}
word: vid       {'positive': 9, 'negative': 0, 'ratio': 10.0}
word: ceo       {'positive': 9, 'negative': 0, 'ratio': 10.0}
word: 1month    {'positive': 9, 'negative': 0, 'ratio': 10.0}
word: flipkartfashionfriday     {'positive': 14, 'negative': 0, 'ratio': 15.0}
word: inde      {'positive': 10, 'negative': 0, 'ratio': 11.0}
word: glad      {'positive': 35, 'negative': 2, 'ratio': 12.0}
word: braindot  {'positive': 9, 'negative': 0, 'ratio': 10.0}
word: ;)        {'positive': 21, 'negative': 0, 'ratio': 22.0}
word: goodnight {'positive': 19, 'negative': 1, 'ratio': 10.0}
word: youth     {'positive': 10, 'negative': 0, 'ratio': 11.0}
word: shout     {'positive': 9, 'negative': 0, 'ratio': 10.0}
word: fantast   {'positive': 10, 'negative': 0, 'ratio': 11.0}
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org0c93422">
<h3 id="org0c93422">Error Analysis</h3>
<div class="outline-text-3" id="text-org0c93422">
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="s1">'Truth Predicted Tweet'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="n">y_hat</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">y_hat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">"{row.label}</span><span class="se">\t</span><span class="s2">{numpy.sign(y_hat) &gt; 0:d}</span><span class="se">\t</span><span class="s2">"</span>
            <span class="n">f</span><span class="s2">"{' '.join(counter.process(row.tweet)).encode('ascii', 'ignore')}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Truth Predicted Tweet
0       1       b'whatev stil l young &gt;:-('
1       0       b'look fun kik va 642 kik kikgirl french model orgasm hannib phonesex :)'
0       1       b'great news thank let us know :( hope good weekend'
0       1       b"amb pleas harry' jean :) ): ): ):"
0       1       b'srsli fuck u unfollow hope ur futur child unpar u &gt;:-('
1       0       b'ate last cooki shir 0 &gt;:d'
1       0       b'snapchat jennyjean 22 snapchat kikmeboy model french kikchat sabadodeganarseguidor sexysasunday :)'
1       0       b'add kik ughtm 545 kik kikmeguy kissm nude likeforfollow musicbiz sexysasunday :)'
0       1       b'sr financi analyst expedia inc bellevu wa financ expediajob job job hire'
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgb9aa999">
<h3 id="orgb9aa999">Predict Your Own Tweet</h3>
<div class="outline-text-3" id="text-orgb9aa999">
<div class="highlight">
<pre><span></span><span class="n">my_tweet</span> <span class="o">=</span> <span class="s1">'my balls itch'</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">my_tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{my_tweet} is a positive tweet: {numpy.sign(p) &gt; 0}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
my balls itch is a positive tweet: True
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org976e2b4">
<h2 id="org976e2b4">End</h2>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/visualizing-naive-bayes/">Visualizing Naive Bayes</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/visualizing-naive-bayes/" rel="bookmark"><time class="published dt-published" datetime="2020-08-18T06:16:19-07:00" itemprop="datePublished" title="2020-08-18 06:16">2020-08-18 06:16</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/visualizing-naive-bayes/#org37ecc8f">Beginning</a>
<ul>
<li><a href="posts/nlp/visualizing-naive-bayes/#org134fa4e">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/visualizing-naive-bayes/#orgc5e431c">Middle</a>
<ul>
<li><a href="posts/nlp/visualizing-naive-bayes/#orga12be23">Calculating Likelihoods</a></li>
</ul>
</li>
<li><a href="posts/nlp/visualizing-naive-bayes/#orgda7b7c9">End</a></li>
<li><a href="posts/nlp/visualizing-naive-bayes/#org3fa8e30">Raw</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org37ecc8f">
<h2 id="org37ecc8f">Beginning</h2>
<div class="outline-text-2" id="text-org37ecc8f"></div>
<div class="outline-3" id="outline-container-org134fa4e">
<h3 id="org134fa4e">Set Up</h3>
<div class="outline-text-3" id="text-org134fa4e"></div>
<div class="outline-4" id="outline-container-org303455a">
<h4 id="org303455a">Imports</h4>
<div class="outline-text-4" id="text-org303455a">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># graeae</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb491396">
<h4 id="orgb491396">Plotting</h4>
<div class="outline-text-4" id="text-orgb491396">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"visualizing-naive-bayes"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="n">f</span><span class="s2">"files/posts/nlp/{SLUG}"</span><span class="p">,</span> <span class="n">create_folder</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">plot_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">plot_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="k">with</span> <span class="n">plot_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Plot</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
<span class="c1"># Plot = Namespace(</span>
<span class="c1">#     width=990,</span>
<span class="c1">#     height=780,</span>
<span class="c1">#     tan="#ddb377",</span>
<span class="c1">#     blue="#4687b7",</span>
<span class="c1">#     red="#ce7b6d",</span>
<span class="c1">#     font_scale=2,</span>
<span class="c1">#     color_cycle = holoviews.Cycle(["#4687b7", "#ce7b6d"])</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgc5e431c">
<h2 id="orgc5e431c">Middle</h2>
<div class="outline-text-2" id="text-orgc5e431c"></div>
<div class="outline-3" id="outline-container-orga12be23">
<h3 id="orga12be23">Calculating Likelihoods</h3>
<div class="outline-text-3" id="text-orga12be23">
<p>This starts with the likelihoods pre-calculated. I'll add in the calculations later.</p>
\begin{align} log \frac{P(tweet|pos)}{P(tweet|neg)} &amp;= log(P(tweet|pos)) - log(P(tweet|neg)) \\ positive = log(P(tweet|pos)) &amp;= \sum_{i=0}^{n}{log P(W_i|pos)}\\ negative = log(P(tweet|neg)) &amp;= \sum_{i=0}^{n}{log P(W_i|neg)}\\ \end{align}
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"BAYES_FEATURES"</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
<pre class="example">
    positive   negative  sentiment
0 -45.763393 -63.351354        1.0
</pre>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"sentiment"</span><span class="p">,</span>
                               <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                                   <span class="n">title</span><span class="o">=</span><span class="s2">"Positive vs Negative"</span><span class="p">,</span>
                                   <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                   <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                                   <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
                               <span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"positive_vs_negative_sentiment"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/visualizing-naive-bayes/positive_vs_negative_sentiment.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
</div>
<div class="outline-2" id="outline-container-orgda7b7c9">
<h2 id="orgda7b7c9">End</h2>
</div>
<div class="outline-2" id="outline-container-org3fa8e30">
<h2 id="org3fa8e30">Raw</h2>
<div class="outline-text-2" id="text-org3fa8e30">
<div class="highlight">
<pre><span></span><span class="c1">#  ## Calculate the likelihoods for each tweet</span>
<span class="c1"># </span>
<span class="c1"># For each tweet, we have calculated the likelihood of the tweet to be positive and the likelihood to be negative. We have calculated in different columns the numerator and denominator of the likelihood ratio introduced previously.  </span>
<span class="c1"># </span>
<span class="c1"># $$log \frac{P(tweet|pos)}{P(tweet|neg)} = log(P(tweet|pos)) - log(P(tweet|neg)) $$</span>
<span class="c1"># $$positive = log(P(tweet|pos)) = \sum_{i=0}^{n}{log P(W_i|pos)}$$</span>
<span class="c1"># $$negative = log(P(tweet|neg)) = \sum_{i=0}^{n}{log P(W_i|neg)}$$</span>
<span class="c1"># </span>
<span class="c1"># We did not include the code because this is part of this week's assignment.  The __'bayes_features.csv'__ file contains the final result of this process. </span>
<span class="c1"># </span>
<span class="c1"># The cell below loads the table in a dataframe. Dataframes are data structures that simplify the manipulation of data, allowing filtering, slicing, joining, and summarization.</span>

<span class="c1"># In[ ]:</span>




<span class="c1"># Plot the samples using columns 1 and 2 of the matrix</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="c1">#Create a new figure with a custom size</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'red'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">]</span> <span class="c1"># Define a color palete</span>

<span class="c1"># Color base on sentiment</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> 
    <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">colors</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">sentiment</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'*'</span><span class="p">)</span>  <span class="c1"># Plot a dot for each tweet</span>

<span class="c1"># Custom limits for this chart</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">250</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">250</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Positive"</span><span class="p">)</span> <span class="c1"># x-axis label</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Negative"</span><span class="p">)</span> <span class="c1"># y-axis label</span>


<span class="c1"># # Using Confidence Ellipses to interpret Naïve Bayes</span>
<span class="c1"># </span>
<span class="c1"># In this section, we will use the [confidence ellipse]( https://matplotlib.org/3.1.1/gallery/statistics/confidence_ellipse.html#sphx-glr-gallery-statistics-confidence-ellipse-py) to give us an idea of what the Naïve Bayes model see.</span>
<span class="c1"># </span>
<span class="c1"># A confidence ellipse is a way to visualize a 2D random variable. It is a better way than plotting the points over a cartesian plane because, with big datasets, the points can overlap badly and hide the real distribution of the data. Confidence ellipses summarize the information of the dataset with only four parameters: </span>
<span class="c1"># </span>
<span class="c1"># * Center: It is the numerical mean of the attributes</span>
<span class="c1"># * Height and width: Related with the variance of each attribute. The user must specify the desired amount of standard deviations used to plot the ellipse. </span>
<span class="c1"># * Angle: Related with the covariance among attributes.</span>
<span class="c1"># </span>
<span class="c1"># The parameter __n_std__ stands for the number of standard deviations bounded by the ellipse. Remember that for normal random distributions:</span>
<span class="c1"># </span>
<span class="c1"># * About 68% of the area under the curve falls within 1 standard deviation around the mean.</span>
<span class="c1"># * About 95% of the area under the curve falls within 2 standard deviations around the mean.</span>
<span class="c1"># * About 99.7% of the area under the curve falls within 3 standard deviations around the mean.</span>
<span class="c1"># </span>
<span class="c1"># &lt;img src=std.jpg width="400" &gt;</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># In the next chart, we will plot the data and its corresponding confidence ellipses using 2 std and 3 std. </span>

<span class="c1"># In[ ]:</span>


<span class="c1"># Plot the samples using columns 1 and 2 of the matrix</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'red'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">]</span> <span class="c1"># Define a color palete</span>

<span class="c1"># Color base on sentiment</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">colors</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">sentiment</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'*'</span><span class="p">)</span>  <span class="c1"># Plot a dot for tweet</span>

<span class="c1"># Custom limits for this chart</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>  
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Positive"</span><span class="p">)</span> <span class="c1"># x-axis label</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Negative"</span><span class="p">)</span> <span class="c1"># y-axis label</span>

<span class="n">data_pos</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">sentiment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># Filter only the positive samples</span>
<span class="n">data_neg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">sentiment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># Filter only the negative samples</span>

<span class="c1"># Print confidence ellipses of 2 std</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">data_pos</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">'$2\sigma$'</span> <span class="p">)</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">data_neg</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data_neg</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'orange'</span><span class="p">)</span>

<span class="c1"># Print confidence ellipses of 3 std</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">data_pos</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">':'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">'$3\sigma$'</span><span class="p">)</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">data_neg</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data_neg</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'orange'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">':'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># In the next cell, we will modify the features of the samples with positive sentiment (1), in a way that the two distributions overlap. In this case, the Naïve Bayes method will produce a lower accuracy than with the original data.</span>

<span class="c1"># In[ ]:</span>


<span class="n">data2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Copy the whole data frame</span>

<span class="c1"># The following 2 lines only modify the entries in the data frame where sentiment == 1</span>
<span class="n">data2</span><span class="o">.</span><span class="n">negative</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">sentiment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data2</span><span class="o">.</span><span class="n">negative</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">+</span> <span class="mi">50</span> <span class="c1"># Modify the negative attribute</span>
<span class="n">data2</span><span class="o">.</span><span class="n">positive</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">sentiment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data2</span><span class="o">.</span><span class="n">positive</span> <span class="o">/</span> <span class="mf">1.5</span> <span class="o">-</span> <span class="mi">50</span> <span class="c1"># Modify the positive attribute </span>


<span class="c1"># Now let us plot the two distributions and the confidence ellipses</span>

<span class="c1"># In[ ]:</span>


<span class="c1"># Plot the samples using columns 1 and 2 of the matrix</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'red'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">]</span> <span class="c1"># Define a color palete</span>

<span class="c1"># Color base on sentiment</span>

<span class="c1">#data.negative[data.sentiment == 1] =  data.negative * 2</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data2</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data2</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">colors</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data2</span><span class="o">.</span><span class="n">sentiment</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'*'</span><span class="p">)</span>  <span class="c1"># Plot a dot for tweet</span>
<span class="c1"># Custom limits for this chart</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>  
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Positive"</span><span class="p">)</span> <span class="c1"># x-axis label</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Negative"</span><span class="p">)</span> <span class="c1"># y-axis label</span>

<span class="n">data_pos</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="n">data2</span><span class="o">.</span><span class="n">sentiment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># Filter only the positive samples</span>
<span class="n">data_neg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data2</span><span class="o">.</span><span class="n">sentiment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># Filter only the negative samples</span>

<span class="c1"># Print confidence ellipses of 2 std</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">data_pos</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">'$2\sigma$'</span> <span class="p">)</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">data_neg</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data_neg</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'orange'</span><span class="p">)</span>

<span class="c1"># Print confidence ellipses of 3 std</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">data_pos</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">':'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">'$3\sigma$'</span><span class="p">)</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">data_neg</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">data_neg</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'orange'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">':'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># To give away: Understanding the data allows us to predict if the method will perform well or not. Alternatively, it will allow us to understand why it worked well or bad.</span>
</pre></div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/bibliographies/text-data-management-and-analysis/">Text Data Management and Analysis</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/bibliographies/text-data-management-and-analysis/" rel="bookmark"><time class="published dt-published" datetime="2020-07-30T13:23:23-07:00" itemprop="datePublished" title="2020-07-30 13:23">2020-07-30 13:23</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div class="outline-2" id="outline-container-org4e47994">
<h2 id="org4e47994">Bibliography</h2>
<div class="outline-text-2" id="text-org4e47994">
<ul class="org-ul">
<li>Zhai C, Massung S. Text data management and analysis: a practical introduction to information retrieval and text mining. First edition. New York: Association for Computing Machinery; 2016. 510 p. (ACM books).</li>
</ul>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/bibliographies/sentiment-analysis-in-social-networks/">Sentiment Analysis In Social Networks</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/bibliographies/sentiment-analysis-in-social-networks/" rel="bookmark"><time class="published dt-published" datetime="2020-07-30T13:05:58-07:00" itemprop="datePublished" title="2020-07-30 13:05">2020-07-30 13:05</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div class="outline-2" id="outline-container-org810ae12">
<h2 id="org810ae12">Bibliography</h2>
<div class="outline-text-2" id="text-org810ae12">
<ul class="org-ul">
<li>Pozzi FA, Fersini E, Messina E, Liu B, editors. Sentiment analysis in social networks. Elsevier Inc.: 2017. 263 p.</li>
</ul>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/bibliographies/bib-speech-and-language-processing-jurafsky-martin/">Speech and Language Processing</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/bibliographies/bib-speech-and-language-processing-jurafsky-martin/" rel="bookmark"><time class="published dt-published" datetime="2020-07-27T20:53:07-07:00" itemprop="datePublished" title="2020-07-27 20:53">2020-07-27 20:53</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div class="outline-2" id="outline-container-org916923a">
<h2 id="org916923a">Citation</h2>
<div class="outline-text-2" id="text-org916923a">
<p>Jurafsky, D. & Martin, J. (2020). Speech and language processing : an introduction to natural language processing, computational linguistics, and speech recognition. 3rd Edition draft. <a href="https://web.stanford.edu/~jurafsky/slp3/">(URL)</a></p>
</div>
</div>
<div class="outline-2" id="outline-container-org08b8787">
<h2 id="org08b8787">Notes</h2>
<div class="outline-text-2" id="text-org08b8787">
<p>Online and PDF version of a (work in progress) revision to this text about text processing.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/the-tweet-vectorizer/">The Tweet Vectorizer</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/the-tweet-vectorizer/" rel="bookmark"><time class="published dt-published" datetime="2020-07-24T16:51:53-07:00" itemprop="datePublished" title="2020-07-24 16:51">2020-07-24 16:51</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/the-tweet-vectorizer/#org78f56f0">Beginning</a>
<ul>
<li><a href="posts/nlp/the-tweet-vectorizer/#org35cb242">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/the-tweet-vectorizer/#org7358ca9">Middle</a>
<ul>
<li><a href="posts/nlp/the-tweet-vectorizer/#org181f220">The Tweet Vectors</a></li>
<li><a href="posts/nlp/the-tweet-vectorizer/#orgf39068c">The Tweet Vectorizer</a></li>
<li><a href="posts/nlp/the-tweet-vectorizer/#org65b07a4">Plotting The Vectors</a></li>
</ul>
</li>
<li><a href="posts/nlp/the-tweet-vectorizer/#org908b740">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org78f56f0">
<h2 id="org78f56f0">Beginning</h2>
<div class="outline-text-2" id="text-org78f56f0">
<p>In the previous post (<a href="posts/nlp/twitter-word-frequencies/">Twitter Word Frequencies</a>) I built up a word-counter now we're going to use it to create word-counters for our tweets.</p>
<p>We are going to be classifying <a href="https://help.twitter.com/en/using-twitter/how-to-tweet">tweets</a> by positive or negative sentiment, but tweets are free-form text (and images, but we're ignoring them) and we want numbers in a table form so in order to be able to work with the tweets we'll have to convert them somehow. That's what we'll be doing here.</p>
</div>
<div class="outline-3" id="outline-container-org35cb242">
<h3 id="org35cb242">Set Up</h3>
<div class="outline-text-3" id="text-org35cb242">
<p>This is some preliminary stuff so we have python ready to go.</p>
</div>
<div class="outline-4" id="outline-container-org9ce2ddb">
<h4 id="org9ce2ddb">Imports</h4>
<div class="outline-text-4" id="text-org9ce2ddb">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">bokeh.models.tools</span> <span class="kn">import</span> <span class="n">HoverTool</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>
<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># the vectorizer</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.vectorizer</span> <span class="kn">import</span> <span class="n">TweetVectorizer</span>

<span class="c1"># some helper stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0c088fd">
<h4 id="org0c088fd">The Environment</h4>
<div class="outline-text-4" id="text-org0c088fd">
<p>I'm using environment variables (well, in this case a <code>.env</code> file) to keep track of where I save files so this loads the paths into the environment.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgccea6b4">
<h4 id="orgccea6b4">The Data</h4>
<div class="outline-text-4" id="text-orgccea6b4">
<div class="highlight">
<pre><span></span><span class="n">training</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_PROCESSED"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="n">train_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_SENTIMENT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Sentiment</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
<p>The <code>training</code> frame has the cleaned, stemmed, and tokenized version of the tweets.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
tweet    [park, get, sunlight, :)]
label                            1
Name: 0, dtype: object
</pre>
<p>This is what we need for when things are working. The <code>train_raw</code> frame has the tweets as they come from NLTK.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
tweet    off to the park to get some sunlight : )
label                                           1
Name: 0, dtype: object
</pre>
<p>This is just for double-checking if things aren't working the way we expect.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org63491ed">
<h4 id="org63491ed">For Plotting</h4>
<div class="outline-text-4" id="text-org63491ed">
<p>These are some helpers for the plotting that I'll do later on.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"the-tweet-vectorizer"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="n">f</span><span class="s2">"files/posts/nlp/{SLUG}"</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Plot</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgadb7191">
<h4 id="orgadb7191">The Token Counter</h4>
<div class="outline-text-4" id="text-orgadb7191">
<p>I made the counts in a previous post (<a href="posts/nlp/twitter-word-frequencies/">Twitter Word Frequencies</a>) so I'll just load it here.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_COUNTER"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org7358ca9">
<h2 id="org7358ca9">Middle</h2>
<div class="outline-text-2" id="text-org7358ca9"></div>
<div class="outline-3" id="outline-container-org181f220">
<h3 id="org181f220">The Tweet Vectors</h3>
<div class="outline-text-3" id="text-org181f220">
<p>In an earlier post we built a dictionary-like set to count the number of times each token was in a positive tweet and the number of times it was in a negative tweet. To represent a tweet as a vector we're going to sum the total counts for the tokens in the tweet when they are positive and when they are positive.</p>
<p>Come again?</p>
<p>Lets say you have a tweet <code>"a b c"</code> which tokenizes to <code>a, b, c</code> and you look up the positive and negative tweet counts for each token so you add them up, getting this:</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Token</th>
<th class="org-right" scope="col">Positive</th>
<th class="org-right" scope="col">Negative</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">a</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
</tr>
<tr>
<td class="org-left">b</td>
<td class="org-right">2</td>
<td class="org-right">5</td>
</tr>
<tr>
<td class="org-left">c</td>
<td class="org-right">3</td>
<td class="org-right">6</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Total</td>
<td class="org-right">6</td>
<td class="org-right">15</td>
</tr>
</tbody>
</table>
<p>The bottom row (<code>total</code>) has the values for our vector for any tweet containing the tokens <i>a, b,</i> and <i>c</i>. So to represent this tweet you would create a vector of the form:</p>
\begin{align} \hat{v} &amp;= \langle bias, positive, negative \rangle\\ &amp;= \langle 1, 6, 15\rangle\\ \end{align}
<p><b>Note:</b> The bias is always one (it just is).</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgf39068c">
<h3 id="orgf39068c">The Tweet Vectorizer</h3>
<div class="outline-text-3" id="text-orgf39068c">
<p>Here's where I'll create the class to create the vectors.</p>
</div>
<div class="outline-4" id="outline-container-orgaac713e">
<h4 id="orgaac713e">The Testing</h4>
<div class="outline-text-4" id="text-orgaac713e">
<p>We'll start with some vaguely BDD-ish testing. First the tangles.</p>
<div class="highlight">
<pre><span></span>Feature: A Tweet Count Vectorizer

&lt;&lt;extract-features-feature&gt;&gt;

&lt;&lt;get-vectors-feature&gt;&gt;

&lt;&lt;reset-vectors-feature&gt;&gt;

&lt;&lt;check-rep-vectorizer-tweets-feature&gt;&gt;

&lt;&lt;check-rep-vectorizer-counter-feature&gt;&gt;
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">be</span><span class="p">,</span>
    <span class="n">be_true</span><span class="p">,</span>
    <span class="n">contain_exactly</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
    <span class="n">raise_error</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">given</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">,</span>
    <span class="n">when</span><span class="p">,</span>
    <span class="n">then</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this testing</span>
<span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span>

<span class="c1"># software under test</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.vectorizer</span> <span class="kn">import</span> <span class="n">Columns</span><span class="p">,</span> <span class="n">TweetVectorizer</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>

<span class="n">and_also</span> <span class="o">=</span> <span class="n">then</span>
<span class="n">scenarios</span><span class="p">(</span><span class="s2">"../../features/twitter/tweet_vectorizer.feature"</span><span class="p">)</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">extract</span><span class="o">-</span><span class="n">features</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">vectors</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">reset</span><span class="o">-</span><span class="n">vectors</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">vectorizer</span><span class="o">-</span><span class="n">tweets</span><span class="o">-</span><span class="n">check</span><span class="o">-</span><span class="n">rep</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">vectorizer</span><span class="o">-</span><span class="n">counter</span><span class="o">-</span><span class="n">check</span><span class="o">-</span><span class="n">rep</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>And now we can move on to the tests.</p>
</div>
<ul class="org-ul">
<li><a id="org162bd58"></a>Extract Features<br>
<div class="outline-text-5" id="text-org162bd58">
<p>For training and testing I'm going to want to convert them in bulk, but first I'll create a method so that a single tweet can be vectorized.</p>
<div class="highlight">
<pre><span></span>Scenario: A user converts a tweet to a feature-vector

Given a Tweet Vectorizer
When the user converts a tweet to a feature-vector
Then it's the expected feature-vector
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: A user converts a tweet to a feature-vector</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a Tweet Vectorizer"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_tweet_vectorizer</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">TWEETS</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">TOKENS</span> <span class="o">=</span> <span class="s2">"A B C"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="n">TOKENS</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TWEETS</span><span class="p">)]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">WordCounter</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">processed</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span>
                                          <span class="n">counter</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
                                          <span class="n">bias</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">({(</span><span class="s1">'A'</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="mi">1</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="s1">'B'</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span><span class="mi">2</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="s1">'C'</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="mi">3</span><span class="p">})</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">"A B C"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user converts a tweet to a feature-vector"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="s2">"A B C"</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual_array</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="s2">"A B C"</span><span class="p">,</span> <span class="n">as_array</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it's the expected feature-vector"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_feature_vectors</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_array</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">expected_array</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org295fb86"></a>Get the Vectors<br>
<div class="outline-text-5" id="text-org295fb86">
<div class="highlight">
<pre><span></span>Scenario: A user retrieves the count vectors
Given a user sets up the Count Vectorizer with tweets
When the user checks the count vectors
Then the first column is the bias colum
And the positive counts are correct
And the negative counts are correct
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Feature: A Tweet Count Vectorizer</span>

<span class="c1"># Scenario: A user retrieves the count vectors</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a user sets up the Count Vectorizer with tweets"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_vectorizer</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">TWEETS</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">TOKENS</span> <span class="o">=</span> <span class="s2">"A B C"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="n">TOKENS</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TWEETS</span><span class="p">)]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">WordCounter</span><span class="p">)</span>

    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span>
                                          <span class="n">counter</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
                                          <span class="n">bias</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">TOKENS</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">({(</span><span class="s1">'A'</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="mi">1</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="s1">'B'</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span><span class="mi">2</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="s1">'C'</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="mi">3</span><span class="p">})</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">negative</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">sum</span><span class="p">([</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                                      <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">TOKENS</span><span class="p">])</span>
                                      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TWEETS</span><span class="p">)])</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">sum</span><span class="p">([</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
                                      <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">TOKENS</span><span class="p">])</span>
                                     <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TWEETS</span><span class="p">)])</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks the count vectors"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_count_vectors</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="c1"># kind of silly, but useful for troubleshooting</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual_vectors</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectors</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"the first column is the bias colum"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_bias</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_vectors</span><span class="p">[:,</span> <span class="n">Columns</span><span class="o">.</span><span class="n">bias</span><span class="p">]</span><span class="o">==</span><span class="n">katamari</span><span class="o">.</span><span class="n">bias</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@and_also</span><span class="p">(</span><span class="s2">"the positive counts are correct"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_positive_counts</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">positive</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">actual_vectors</span><span class="p">[:,</span> <span class="n">Columns</span><span class="o">.</span><span class="n">positive</span><span class="p">]</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@and_also</span><span class="p">(</span><span class="s2">"the negative counts are correct"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_negative_counts</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">negative</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">actual_vectors</span><span class="p">[:,</span> <span class="n">Columns</span><span class="o">.</span><span class="n">negative</span><span class="p">]</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">negative</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">negative</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org95edb51"></a>Reset the Vectors<br>
<div class="outline-text-5" id="text-org95edb51">
<div class="highlight">
<pre><span></span>Scenario: The vectors are reset
Given a Tweet Vectorizer with the vectors set
When the user calls the reset method
Then the vectors are gone
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The vectors are reset</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a Tweet Vectorizer with the vectors set"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_vectors</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectors</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()],</span> <span class="n">counter</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_vectors</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">vectors</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user calls the reset method"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">call_reset</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">vectors</span><span class="p">))</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"the vectors are gone"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_vectors_gone</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_vectors</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org609d20e"></a>Check Rep<br>
<div class="outline-text-5" id="text-org609d20e">
<div class="highlight">
<pre><span></span>Scenario: the check-rep is called with bad tweets
Given a Tweet Vectorizer with bad tweets
When check-rep is called
Then it raises an AssertionError
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: the check-rep is called with bad tweets</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a Tweet Vectorizer with bad tweets"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_bad_tweets</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                          <span class="n">counter</span><span class="o">=</span><span class="n">WordCounter</span><span class="p">(</span>
                                              <span class="n">tweets</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">None</span><span class="p">))</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"check-rep is called"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">call_check_rep</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">bad_call</span><span class="p">():</span>
        <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">check_rep</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">bad_call</span> <span class="o">=</span> <span class="n">bad_call</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it raises an AssertionError"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_assertion_error</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">bad_call</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">raise_error</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
<div class="highlight">
<pre><span></span>Scenario: the check-rep is called with a bad word-counter
Given a Tweet Vectorizer with the wrong counter object
When check-rep is called
Then it raises an AssertionError
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: the check-rep is called with a bad word-counter</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a Tweet Vectorizer with the wrong counter object"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_bad_counter</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="p">[</span><span class="s2">"apple"</span><span class="p">],</span> <span class="n">counter</span><span class="o">=</span><span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">())</span>
    <span class="k">return</span>

<span class="c1"># When check-rep is called</span>
<span class="c1"># Then it raises an AssertionError</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orgba20e3e">
<h4 id="orgba20e3e">The Implementation</h4>
<div class="outline-text-4" id="text-orgba20e3e">
<p>Okay, so now for the actual class.</p>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">attr</span>


<span class="c1"># this package</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>

<span class="n">Columns</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">bias</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">positive</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">negative</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>

<span class="n">TweetClass</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">positive</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">negative</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="c1"># some types</span>
<span class="n">Tweets</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">Vector</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span>


<span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TweetVectorizer</span><span class="p">:</span>
    <span class="sd">"""A tweet vectorizer</span>

<span class="sd">    Args:</span>
<span class="sd">     tweets: the pre-processed/tokenized tweets to vectorize</span>
<span class="sd">     counts: the counter with the tweet token counts</span>
<span class="sd">     processed: to not process the bulk tweets</span>
<span class="sd">     bias: constant to use for the bias</span>
<span class="sd">    """</span>
    <span class="n">tweets</span><span class="p">:</span> <span class="n">Tweets</span>
    <span class="n">counts</span><span class="p">:</span> <span class="n">Counter</span>
    <span class="n">processed</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">bias</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">_process</span><span class="p">:</span> <span class="n">TwitterProcessor</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">_vectors</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TwitterProcessor</span><span class="p">:</span>
        <span class="sd">"""Processes tweet strings to tokens"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">"""The vectorized tweet counts"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tweets</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span>

    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_array</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Vector</span><span class="p">:</span>
        <span class="sd">"""converts a single tweet to an array of counts</span>

<span class="sd">       Args:</span>
<span class="sd">        tweet: a string tweet to count up</span>
<span class="sd">        as_array: whether to return an array instead of a list</span>

<span class="sd">       Returns:</span>
<span class="sd">        either a list of floats or a 1 x 3 array</span>
<span class="sd">       """</span>
        <span class="c1"># this is a hack to make this work both in bulk and one tweet at a time</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tweet</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span>
            <span class="nb">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">TweetClass</span><span class="o">.</span><span class="n">positive</span><span class="p">)]</span>
                 <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">)),</span>
            <span class="nb">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">TweetClass</span><span class="o">.</span><span class="n">negative</span><span class="p">)]</span>
                                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vector</span><span class="p">])</span> <span class="k">if</span> <span class="n">as_array</span> <span class="k">else</span> <span class="n">vector</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">"""Removes the vectors"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">check_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">"""Checks that the tweets and word-counter are set</span>

<span class="sd">       Raises:</span>
<span class="sd">        AssertionError if one of them isn't right</span>
<span class="sd">       """</span>
        <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tweets</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Counter</span>
        <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org65b07a4">
<h3 id="org65b07a4">Plotting The Vectors</h3>
<div class="outline-text-3" id="text-org65b07a4">
<p>Now that we have a vectorizer definition, let's see what it looks like when we plot the training set. First, we'll have to convert the training set tweets to the vectors.</p>
<div class="highlight">
<pre><span></span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">counter</span><span class="o">=</span><span class="n">counter</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span>
                        <span class="s2">"bias positive negative"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">data</span><span class="p">[</span><span class="s2">"Sentiment"</span><span class="p">]</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">decode</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
['park' 'get' 'sunlight' ':)']
bias                1
positive         3139
negative          208
Sentiment    positive
Name: 0, dtype: object
</pre>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tweet</span><span class="p">)</span>
<span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">training</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tweet</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{token}</span><span class="se">\t</span><span class="s2">{counter.counts[(token, 1)]}"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{token}</span><span class="se">\t</span><span class="s2">{counter.counts[(token, 0)]}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
off to the park to get some sunlight : )
park    6
park    7
get     165
get     200
sunlight        1
sunlight        0
:)      2967
:)      1
</pre>
<p>So a smiley face seems to overwhelm other tokens.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>
<pre class="example">
negative    4013
positive    3987
Name: Sentiment, dtype: int64
</pre>
<p>If you followed the previous post you can probably figure out that this is the training set. Weird but I hadn't noticed that they aren't exactly balanced… Anyway, now the plot.</p>
<div class="highlight">
<pre><span></span><span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span>
    <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">"Positive"</span><span class="p">,</span> <span class="s2">"@positive{0,0}"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Negative"</span><span class="p">,</span> <span class="s2">"@negative{0,0}"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Sentiment"</span><span class="p">,</span> <span class="s2">"@Sentiment"</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Sentiment"</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">])</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                               <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                               <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                               <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
                               <span class="n">title</span><span class="o">=</span><span class="s2">"Positive vs Negative Tweet Sentiment"</span><span class="p">,</span>
                           <span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"positive_negative_scatter"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/the-tweet-vectorizer/positive_negative_scatter.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So, each point is a tweet and the color is what the tweet was classified as. I don't know why they seem to group in bunches, but you can sort of see that by using the token counts we've made them separable. This becomes even more obvious if we change the scale to a logarithmic one.</p>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Sentiment"</span><span class="p">,</span>
                           <span class="n">loglog</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                           <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">])</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                               <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                               <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                               <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
                               <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                               <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                               <span class="n">apply_ranges</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                               <span class="n">title</span><span class="o">=</span><span class="s2">"Positive vs Negative Tweet Sentiment (log-log)"</span><span class="p">,</span>
                           <span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"positive_negative_scatter_log"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/the-tweet-vectorizer/positive_negative_scatter_log.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>I don't know why but the <code>xlim</code> and <code>ylim</code> arguments don't seem to work when you use a logarithmic scale, but if you zoom out using the <code>wheel zoom</code> tool (third icon from the top of the toolbar on the right) you'll see that there's a pretty good separation between the sentiment classifications.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org908b740">
<h2 id="org908b740">End</h2>
<div class="outline-text-2" id="text-org908b740">
<p>So, that's it for vectorizing tweets I'll save the values so I don't have to re-do them again when I actually fit the model. Since I changed some values to make it better for plotting I'll change them back first.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"Sentiment"</span><span class="p">:</span> <span class="s2">"sentiment"</span><span class="p">})</span>
<span class="n">data</span><span class="p">[</span><span class="s2">"sentiment"</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">encode</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAIN_VECTORS"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
</pre></div>
<p>To make it consistent I'm going to convert the test set too.</p>
<div class="highlight">
<pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_PROCESSED"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="n">test_vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">counter</span><span class="o">=</span><span class="n">counter</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="s2">"bias positive negative"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">test_data</span><span class="p">[</span><span class="s2">"sentiment"</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">label</span>

<span class="n">test_data</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_VECTORS"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
</pre></div>
<p>We also need to use the vectorizers to vectorize future tweets so I'll pickle them too.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_VECTORIZER"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">vectorizer</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</pre></div>
<p>Next up in the series: <a href="posts/nlp/implementing-twitter-logistic-regression/">Implementing Logistic Regression for Tweet Sentiment Analysis</a>.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/implementing-twitter-logistic-regression/">Implementing Logistic Regression for Tweet Sentiment Analysis</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/implementing-twitter-logistic-regression/" rel="bookmark"><time class="published dt-published" datetime="2020-07-14T16:16:22-07:00" itemprop="datePublished" title="2020-07-14 16:16">2020-07-14 16:16</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#org077b5cb">Beginning</a>
<ul>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#orgc4cc261">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#orgfcc38ec">Middle</a>
<ul>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#org9bcc4ef">Logistic Regression</a></li>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#org2a28d35">Train the Model</a></li>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#orgedb9cb4">Test the Model</a></li>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#org8f95e9b">The Wrong Stuff</a></li>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#org25bb1dc">Some Fresh Tweets</a></li>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#orge033e0b">Compare to SKLearn</a></li>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#org807eac6">Vizualizing the Model</a></li>
</ul>
</li>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/#org3c4f63b">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org077b5cb">
<h2 id="org077b5cb">Beginning</h2>
<div class="outline-text-2" id="text-org077b5cb">
<p>In the previous post in this series (<a href="posts/nlp/the-tweet-vectorizer/">The Tweet Vectorizer</a>) I transformed some tweet data to vectors based on the sums of the positive and negative tokens in each tweet. This post will implement a Logistic Regression model to train on those vectors to classify tweets by sentiment.</p>
</div>
<div class="outline-3" id="outline-container-orgc4cc261">
<h3 id="orgc4cc261">Set Up</h3>
<div class="outline-text-3" id="text-orgc4cc261"></div>
<div class="outline-4" id="outline-container-org0003602">
<h4 id="org0003602">Imports</h4>
<div class="outline-text-4" id="text-org0003602">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">bokeh.models.tools</span> <span class="kn">import</span> <span class="n">HoverTool</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">be_true</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
    <span class="n">equal</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegressionCV</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># this package</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.sentiment</span> <span class="kn">import</span> <span class="n">TweetSentiment</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.vectorizer</span> <span class="kn">import</span> <span class="n">TweetVectorizer</span>

<span class="c1"># for plotting</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3da75e6">
<h4 id="org3da75e6">The Timer</h4>
<div class="outline-text-4" id="text-org3da75e6">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5a39142">
<h4 id="org5a39142">The Dotenv</h4>
<div class="outline-text-4" id="text-org5a39142">
<p>This loads the locations of previous data and object saves I made.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org511393f">
<h4 id="org511393f">The Data</h4>
<div class="outline-text-4" id="text-org511393f">
<p>I made vectors earlier but to process new tweets I need the Twitter Vectorizer anyway, so I'm going to reprocess everything here.</p>
<div class="highlight">
<pre><span></span><span class="n">train_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="n">test_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training: {len(train_raw):,}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Testing: {len(test_raw):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training: 8,000
Testing: 2,000
</pre>
<div class="highlight">
<pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="s2">"bias positive negative"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="n">train_vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">processed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">test_vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">test_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">processed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
<p>But it's easier to work with the DataFrame when exploring and I've been going back and fiddling with different parts of the pipeline and not all the data-files are up to date so it's safer to start from the raw files again.</p>
<div class="highlight">
<pre><span></span><span class="n">training</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
<span class="n">testing</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

<span class="n">training</span><span class="p">[</span><span class="s2">"sentiment"</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">label</span>
<span class="n">testing</span><span class="p">[</span><span class="s2">"sentiment"</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">label</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training: {len(training):,}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Testing: {len(testing):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training: 8,000
Testing: 2,000
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgacb2869">
<h4 id="orgacb2869">For Plotting</h4>
<div class="outline-text-4" id="text-orgacb2869">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"implementing-twitter-logistic-regression"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="n">f</span><span class="s2">"files/posts/nlp/{SLUG}"</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Plot</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0a27128">
<h4 id="org0a27128">Types</h4>
<div class="outline-text-4" id="text-org0a27128">
<p>Some stuff for type hinting.</p>
<div class="highlight">
<pre><span></span><span class="n">Tweet</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<span class="n">PositiveProbability</span> <span class="o">=</span> <span class="n">Tweet</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgfcc38ec">
<h2 id="orgfcc38ec">Middle</h2>
<div class="outline-text-2" id="text-orgfcc38ec"></div>
<div class="outline-3" id="outline-container-org9bcc4ef">
<h3 id="org9bcc4ef">Logistic Regression</h3>
<div class="outline-text-3" id="text-org9bcc4ef">
<p>Now that we have the data it's time to implement the <a href="https://www.wikiwand.com/en/Logistic_regression">Logistic Regression</a> model to classify tweets as positive or negative.</p>
</div>
<div class="outline-4" id="outline-container-org46c8633">
<h4 id="org46c8633">The Sigmoid Function</h4>
<div class="outline-text-4" id="text-org46c8633">
<p>Logistic Regression uses a version of <a href="https://www.wikiwand.com/en/Sigmoid_function">the Sigmoid Function</a> called the Standard <a href="https://www.wikiwand.com/en/Logistic_function">Logistic Function</a> to measure whether an entry has passed the threshold for classification. This is the mathematical definition:</p>
<p>\[ \sigma(z) = \frac{1}{1 + e^{-x \cdot \theta}} \]</p>
<p>The numerator (1) determines the maximum value for the function, so in this case the range is from 0 to 1 and we can interpret \(\sigma(z)\) as the probability that a tweet (<i>z</i>) is positive (<i>1</i>). The interpretation of \(\sigma(z)\) is it's the probability that <i>z</i> (a vector representation of a tweet times the weights) is classified as 1 (having a positive sentiment). So we could re-write this as:</p>
<p>\[ P(Y=1 | z) = \frac{1}{1 + e^{-(\beta_0 + \beta_1 x_1 + \beta_2 x_2)}} \]</p>
<p>Where \(x_1\) is the sum of the positive tweet counts for the tokens in \(x\) and \(x_2\) is the sum of the negative tweet counts for the tokens. \(\beta_0\) is our bias and \(\beta_1\) and \(\beta_2\) are the weights that we're going to find by training our model.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="n">Tweet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PositiveProbability</span><span class="p">:</span>
    <span class="sd">"""Calculates the logistic function value</span>

<span class="sd">    Args:</span>
<span class="sd">     z: input to the logistic function (float or array)</span>

<span class="sd">    Returns:</span>
<span class="sd">     calculated sigmoid for z</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">z</span><span class="p">))</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org718d841"></a>A Little Test<br>
<div class="outline-text-5" id="text-org718d841">
<p>We have a couple of given values to test that our sigmoid is correct.</p>
<div class="highlight">
<pre><span></span><span class="n">expect</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>

<span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">(</span><span class="mf">4.92</span><span class="p">),</span> <span class="mf">0.9927537604041685</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9927537604041685</span><span class="p">])</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">4.92</span><span class="p">]))</span>

<span class="n">expect</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">actual</span><span class="o">==</span><span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="orgcaf628a"></a>Plotting It<br>
<div class="outline-text-5" id="text-orgcaf628a">
<p>Let's see what the output looks like.</p>
<div class="highlight">
<pre><span></span><span class="n">min_x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span>
<span class="n">max_x</span> <span class="o">=</span> <span class="mi">6</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">halfway</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plot_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">))</span>
<span class="n">curve</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">)</span>

<span class="n">line</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">Curve</span><span class="p">([(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">halfway</span><span class="p">),</span> <span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">halfway</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">tan</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">curve</span> <span class="o">*</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Sigmoid"</span><span class="p">,</span>
    <span class="n">show_grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">embedded</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"sigmoid_function"</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">embedded</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/implementing-twitter-logistic-regression/sigmoid_function.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Looking at the plot you can see that the probability that a tweet is positive is 0.5 when the input is 0, becomes more likely the more positive the input is, and is less likely the more negative an input is. Next we'll need to look at how to train our model.</p>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orgded8453">
<h4 id="orgded8453">The Loss Function</h4>
<div class="outline-text-4" id="text-orgded8453">
<p>To train our model we need a way to measure how well (or in this case poorly) it's doing. For this we'll use the <a href="http://wiki.fast.ai/index.php/Log_Loss">Log Loss</a> function which is the negative logarithm of our probability - so for each tweet, we'll calculate \(\sigma\) (which is the probability that it's positive) and take the negative logarithm of it to get the log-loss.</p>
<p>The formula for loss:</p>
<p>\[ Loss = - \left( y\log (p) + (1-y)\log (1-p) \right) \]</p>
<p>\(y\) is the classification of the tweet (1 or 0) so when the tweet is classified 1 (positive) the right term becomes 0 and when the tweet is classified 0 (negative) the left term becomes 0 so this is the equivalent of:</p>
<div class="highlight">
<pre><span></span><span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>
</pre></div>
<p>Where \(p\) is the probability that the tweet is positive and \(1 - p\) is the probability that it isn't (so it's negative since that's the only alternative). We take the negative of the logarithm because \(log(p)\) is negative (all the values of \(p\) are between 0 and 1) so negating it makes the output positive.</p>
<p>We can fill it in to make it match what we're going to actually calculate - for the \(i^{th}\) item in our dataset \(p = \sigma(z^i \cdot \theta)\) and the equation becomes:</p>
<p>\[ Loss = - \left( y^{(i)}\log (\sigma(z^{(i)} \cdot \theta)) + (1-y^{(i)})\log (1-\sigma(z^{(i)} \cdot \theta)) \right) \]</p>
<div class="highlight">
<pre><span></span><span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>
<span class="n">losses</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
    <span class="s2">"p"</span><span class="p">:</span> <span class="n">probabilities</span><span class="p">,</span>
    <span class="s2">"Log-Loss"</span><span class="p">:</span> <span class="n">losses</span> 
<span class="p">})</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"p"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Log-Loss"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Log-Loss (Y=1)"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">losses</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"log_loss_example"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/implementing-twitter-logistic-regression/log_loss_example.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So what is this telling us? This is for the case where a tweet is labeled positive and at the far left, near 0 (<code>log(0)</code> is undefined so you can use a really small probability but not 0) our model is saying that it probably isn't a positive tweet, so the log-loss is fairly high, then as we move along the x-axis our model is saying that it is more and more likely that the tweet is positive so our log-loss goes down, until we reach the point where our model says that it's 100% guaranteed to be a positive tweet, at which point our log-loss drops to zero. Fairly intuitive.</p>
<p>Let's look at the case where the tweet is actually negative (<i>y=0</i>). Since <i>p</i> is the probability that it's positive, when the label is 0 we need to take the log of <i>1-p</i> to see what the model thinks the probability is that it's negative.</p>
<div class="highlight">
<pre><span></span><span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>
<span class="n">losses</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probabilities</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
    <span class="s2">"p"</span><span class="p">:</span> <span class="n">probabilities</span><span class="p">,</span>
    <span class="s2">"Log-Loss"</span><span class="p">:</span> <span class="n">losses</span> 
<span class="p">})</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"p"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Log-Loss"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Log-Loss (Y=0)"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">losses</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"log_loss_y_0_example"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/implementing-twitter-logistic-regression/log_loss_y_0_example.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So now we have basically the opposite loss. In this case the tweet is not positive so when the model puts a low likelihood that the tweet is positive the log-loss is small, but as you move along the x-axis the model is giving more probability to the notion that the tweet is positive so the log-loss gets larger.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org16ac146">
<h4 id="org16ac146">Training the Model</h4>
<div class="outline-text-4" id="text-org16ac146">
<p>To train the model we're going to use <a href="https://www.wikiwand.com/en/Gradient_descent">Gradient Descent</a>. What this means is that we're going to use the <i>gradient</i> of our loss function to figure out how to update our weights. The <i>gradient</i> is just the slope of the loss-function (but generalized to multiple dimensions).</p>
<p>How do we do this? First we calculate our model's estimate of the input being positive, then we calculate the gradient of its loss. If you remember from calculus the slope of a line is the derivative of its function so instead of calculating the loss, we'll calculate the derivative of the loss-function which is given as:</p>
<p>\[ \nabla_{\theta}L_{\theta} = \left [ \sigma(x \cdot \theta) - y \right] x_j \]</p>
<p>The rightmost term \(x_j\) represents one term in the input vector, the one that matches the weight - this has to be repeated for each \(\beta\) in \(\theta\) so in our case it will be repeated three times, with \(x\) being 1 for the bias term.</p>
<p>It's called stochastic gradient descent because the inputs are chosen randomly from our training set. This turns out to not give you a smooth descent so we're going to do <b>batch training</b> which changes our gradient a little.</p>
<p>\[ \nabla_{\theta_j}L_{\theta} = \frac{1}{m} \sum_{i=1}^m(\sigma(x \cdot \theta)-y)x_j \]</p>
<p>Our gradient is now the average of the gradients for each of the inputs in our training set. We update the weights by subtracting a fraction of the difference between the current weights and the gradient. The fraction \(\eta\) is called the <i>learning rate</i> and it controls how much the weights change, representng how fast our model will learn. If it is too large we can miss the minimum and if it's too large it will take too long to train the model, so we need to choose the right value for it to reach the minima within a feasible time.</p>
<p>Here's the algorithm in the rough.</p>
<ul class="org-ul">
<li><i>L</i>: Loss Function</li>
<li>\(\sigma\): probability function parameterized by \(\theta\)</li>
<li><i>x</i>: set of training inputs</li>
<li><i>y</i>: set of training labels</li>
</ul>
<script>
    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<pre id="gradientdescent" style="display:hidden">
\begin{algorithm}
\caption{Gradient Descent}
\begin{algorithmic}
\STATE $\theta \gets 0$
\WHILE{not done}

 \FOR{each $(x^{(i)},y^{(i)})$ in training data}
  \State $\hat{y} \gets \sigma(x^{(i)}; \theta)$
  \State $loss \gets L(\hat{y}^{(i)}, y^{(i)})$
  \State $g \gets \nabla_{\theta} L(\hat{y}^{(i)}, y^{(i)})$
  \State $\theta \gets \theta - \eta g$
 \ENDFOR

\ENDWHILE
\end{algorithmic}
\end{algorithm}
</pre>
<p>We can translate this a little more.</p>
<pre id="gradientdescentengrish" style="display:hidden">
\begin{algorithm}
\caption{Gradient Descent}
\begin{algorithmic}
\STATE Initialize the weights
\WHILE{the loss is still too high}

 \FOR{each $(x^{(i)},y^{(i)})$ in training data}
  \State What is our probability that the input is positive?
  \State How far off are we?
  \State What direction would we need to head to maximize the error?
  \State Let's go in the opposite direction.
 \ENDFOR

\ENDWHILE
\end{algorithmic}
\end{algorithm}
</pre>
<script>
    pseudocode.renderElement(document.getElementById("gradientdescent"));
    pseudocode.renderElement(document.getElementById("gradientdescentengrish"));
</script>
<p>Note that the losses aren't needed for the algorithm to train the model, just for assessing how well the model did.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgd7e3a4d">
<h4 id="orgd7e3a4d">Implement It</h4>
<div class="outline-text-4" id="text-orgd7e3a4d"></div>
<ul class="org-ul">
<li><a id="orgd899531"></a>The Function<br>
<div class="outline-text-5" id="text-orgd899531">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">gradient_descent</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">weights</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">"""Finds the weights for the model</span>

<span class="sd">    Args:</span>
<span class="sd">     x: the tweet vectors</span>
<span class="sd">     y: the positive/negative labels</span>
<span class="sd">     weights: the regression weights</span>
<span class="sd">     learning_rate: (eta) how much to update the weights</span>
<span class="sd">     iterations: the number of times to repeat training</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">learning_rate</span> <span class="o">/=</span> <span class="n">rows</span>
    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        <span class="c1"># average loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_hat</span><span class="p">)))</span> <span class="o">+</span>
                               <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_hat</span><span class="p">))))</span><span class="o">/</span><span class="n">rows</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="p">((</span><span class="n">y_hat</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">gradient</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">losses</span>
</pre></div>
<p>If you look at the implementation you can see that there are some changes made to it from what I wrote earlier. This is because the algorithm I wrote in pseudocode came from a book while the implementation that I made came from a Coursera assignment. The main differences being that we use a set number of iterations to train the model and the learning rate is divided by the number of training examples. Of course, you could just divide the learning rate before passing it in to the function so it doesn't really change it that much. I also had to take into account the fact that you can't just take a dot product of two matrices if their shapes aren't compatible - the rows of the left hand matrix has to match the columns of the right hand matrix) so there's some transposing of matrices being done. Our actual implementation might be more like this.</p>
<pre id="gradientdescentimplementation" style="display:hidden">
\begin{algorithm}
\caption{Gradient Descent Implemented}
\begin{algorithmic}
\STATE $\theta \gets 0$
\STATE $m \gets rows(X)$
\FOR{$iteration \in$ \{0 $\ldots iterations-1$ \}}
  \STATE $\hat{Y} \gets \sigma(X \cdot \theta)$
  \STATE $loss \gets -\frac{1}{m}(Y^T \cdot \ln \hat{Y}) + (1 - Y)^T \cdot (\ln 1 - \hat{Y})$
  \STATE $\nabla \gets \sum (\hat{Y} - Y)^T \cdot x$
  \STATE $\theta \gets \theta - \frac{\eta}{m} \nabla^T$
 \ENDFOR
\end{algorithmic}
\end{algorithm}
</pre>
<script>
    pseudocode.renderElement(document.getElementById("gradientdescentimplementation"));
</script></div>
</li>
<li><a id="org39fec2c"></a>Test It<br>
<div class="outline-text-5" id="text-org39fec2c">
<p>First we'll make a fake (random) input set to make it easier to check the gradient descent.</p>
<div class="highlight">
<pre><span></span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">fake</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2000</span>
<span class="n">fake_tweet_vectors</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="n">fake</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<p>Now, the fake labels - we'll make around 35% of them negative and the rest positive.</p>
<div class="highlight">
<pre><span></span><span class="n">fake_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.35</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="org4a3c709"></a>Do the Descent<br>
<div class="outline-text-5" id="text-org4a3c709">
<p>So now we can pass our test data into the gradient descent function and see what happens.</p>
<div class="highlight">
<pre><span></span><span class="n">fake_weights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">fake_loss</span><span class="p">,</span> <span class="n">fake_weights</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">gradient_descent</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">fake_tweet_vectors</span><span class="p">,</span>
                                           <span class="n">y</span><span class="o">=</span><span class="n">fake_labels</span><span class="p">,</span> 
                                           <span class="n">weights</span><span class="o">=</span><span class="n">fake_weights</span><span class="p">,</span>
                                           <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
                                           <span class="n">iterations</span><span class="o">=</span><span class="mi">700</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fake_loss</span><span class="p">,</span> <span class="mf">0.67094970</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"The log-loss after training is {fake_loss:.8f}."</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"The trained weights are {[round(t, 8) for t in numpy.squeeze(fake_weights)]}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
The log-loss after training is 0.67094970.
The trained weights are [4.1e-07, 0.00035658, 7.309e-05]
</pre></div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org2a28d35">
<h3 id="org2a28d35">Train the Model</h3>
<div class="outline-text-3" id="text-org2a28d35">
<p>Now that we have our parts let's actually train the model using the real training data. I originally did this expecting numpy arrays (like in earlier steps I was expecting python lists instead of numpy arrays - stuff changes) so I'll be extracting the relevant columns from the pandas DataFrame and converting them back to arrays.</p>
<div class="highlight">
<pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mf">1e-9</span>
<span class="n">iterations</span> <span class="o">=</span> <span class="mi">1500</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">final_loss</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">gradient_descent</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">train_vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">training</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"The log-loss after training is {final_loss:.8f}."</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"The resulting vector of weights is "</span>
      <span class="n">f</span><span class="s2">"{[round(t, 8) for t in numpy.squeeze(weights)]}"</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">TweetSentiment</span><span class="p">(</span><span class="n">train_vectorizer</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">()</span>

<span class="n">correct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">training</span><span class="o">.</span><span class="n">sentiment</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training Accuracy: {correct/len(training)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-07-27 17:54:58,357 graeae.timers.timer start: Started: 2020-07-27 17:54:58.357765
2020-07-27 17:54:58,776 graeae.timers.timer end: Ended: 2020-07-27 17:54:58.776834
2020-07-27 17:54:58,777 graeae.timers.timer end: Elapsed: 0:00:00.419069
The log-loss after training is 0.22043072.
The resulting vector of weights is [6e-08, 0.00053899, -0.0005613]
Training Accuracy: 0.997625
</pre>
<div class="highlight">
<pre><span></span><span class="n">plot_losses</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">"Log-Loss"</span><span class="p">:</span> <span class="n">losses</span><span class="p">})</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plot_losses</span><span class="o">.</span><span class="n">hvplot</span><span class="p">()</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Training Losses"</span><span class="p">,</span>
                            <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                            <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                            <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span>
                            <span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"training_loss"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/implementing-twitter-logistic-regression/training_loss.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>As you can see, the losses are still on the decline, but we'll stop here to see how it's doing.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgedb9cb4">
<h3 id="orgedb9cb4">Test the Model</h3>
<div class="outline-text-3" id="text-orgedb9cb4">
<p>This will be a class to predict the sentiment of a tweet using our model.</p>
<div class="highlight">
<pre><span></span><span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">.vectorizer</span> <span class="kn">import</span> <span class="n">TweetVectorizer</span>


<span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TweetSentiment</span><span class="p">:</span>
    <span class="sd">"""Predicts the sentiment of a tweet</span>

<span class="sd">    Args:</span>
<span class="sd">     vectorizer: something to vectorize tweets</span>
<span class="sd">     theta: vector of weights for the logistic regression model</span>
<span class="sd">    """</span>
    <span class="n">vectorizer</span><span class="p">:</span> <span class="n">TweetVectorizer</span>
    <span class="n">theta</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>

    <span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vectors</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">"""the logistic function</span>

<span class="sd">       Args:</span>
<span class="sd">        vectors: a matrix of bias, positive, negative counts</span>

<span class="sd">       Returns:</span>
<span class="sd">        array of probabilities that the tweets are positive</span>
<span class="sd">       """</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">vectors</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">probability_positive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">"""Calculates the probability of the tweet being positive</span>

<span class="sd">       Args:</span>
<span class="sd">        tweet: a tweet to classify</span>

<span class="sd">       Returns:</span>
<span class="sd">        the probability that the tweet is a positive one</span>
<span class="sd">       """</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">as_array</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">"""Decides if the tweet was positive or not</span>

<span class="sd">       Args:</span>
<span class="sd">        tweet: the tweet message to classify.</span>
<span class="sd">       """</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probability_positive</span><span class="p">(</span><span class="n">tweet</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">"""Get the sentiments of the vectorized tweets</span>

<span class="sd">       Note:</span>
<span class="sd">        this assumes that the vectorizer passed in has the tweets</span>

<span class="sd">       Returns:</span>
<span class="sd">        array of predicted sentiments (1 for positive 0 for negative)</span>
<span class="sd">       """</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">sentiment</span> <span class="o">=</span> <span class="n">TweetSentiment</span><span class="p">(</span><span class="n">test_vectorizer</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'I am happy'</span><span class="p">,</span> <span class="s1">'I am bad'</span><span class="p">,</span> <span class="s1">'this movie should have been great.'</span><span class="p">,</span> <span class="s1">'great'</span><span class="p">,</span> <span class="s1">'great great'</span><span class="p">,</span> <span class="s1">'great great great'</span><span class="p">,</span> <span class="s1">'great great great great'</span><span class="p">]:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'{tweet} -&gt; {sentiment.probability_positive(tweet)}'</span><span class="p">)</span>
</pre></div>
<pre class="example">
I am happy -&gt; 0.5183237992258976
I am bad -&gt; 0.4924963884222927
this movie should have been great. -&gt; 0.5156997144475827
great -&gt; 0.5158056039006712
great great -&gt; 0.5315796358935646
great great great -&gt; 0.5472908064541816
great great great great -&gt; 0.5629083094155534
</pre>
<p>Strangely very near the center. Probably because the words weren't that commonly used in our training set.</p>
<div class="highlight">
<pre><span></span><span class="n">totals</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Great positive percentage: {100 * counter.counts[('great', 1)]/totals:.2f} %"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Great negative percentage: {100 * counter.counts[('great', 0)]/totals:.2f} % "</span><span class="p">)</span>
</pre></div>
<pre class="example">
Great positive percentage: 0.24 %
Great negative percentage: 0.03 % 
</pre>
<p>Now we can see how it did overall.</p>
<div class="highlight">
<pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">sentiment</span><span class="p">()</span>
<span class="n">correct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">testing</span><span class="o">.</span><span class="n">sentiment</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Accuracy: {correct/len(testing)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Accuracy: 0.996
</pre>
<p>Almost suspiciously good.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org8f95e9b">
<h3 id="org8f95e9b">The Wrong Stuff</h3>
<div class="outline-text-3" id="text-org8f95e9b">
<div class="highlight">
<pre><span></span><span class="n">wrong_places</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">testing</span><span class="o">.</span><span class="n">sentiment</span>
<span class="n">wrong</span> <span class="o">=</span> <span class="n">testing</span><span class="p">[</span><span class="n">wrong_places</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wrong</span><span class="p">))</span>
</pre></div>
<pre class="example">
8
</pre>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">wrong</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"*"</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Tweet number {row.Index}"</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Tweet: {raw.tweet}"</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">train_vectorizer</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Tokens: {tokens}"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Probability Positive: {sentiment.probability_positive(raw.tweet)}"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Actual Classification: {row.sentiment}"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{token} </span><span class="se">\t</span><span class="s2">Positive: {counter.counts[(token, 1)]} "</span>
              <span class="n">f</span><span class="s2">"Negative: {counter.counts[(token, 0)]}"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">()</span>
</pre></div>
<pre class="example">
**********
Tweet number 64
Tweet: @_sarah_mae omg you can't just tell this and don't say more :p can't wait to know !!!! ❤️
Tokens: ['omg', "can't", 'tell', 'say', ':p', "can't", 'wait', 'know', '❤', '️']
Probability Positive: 0.48137283482824483
Actual Classification: 1

omg     Positive: 11 Negative: 51
can't   Positive: 36 Negative: 145
tell    Positive: 20 Negative: 19
say     Positive: 48 Negative: 52
:p      Positive: 113 Negative: 0
can't   Positive: 36 Negative: 145
wait    Positive: 59 Negative: 37
know    Positive: 123 Negative: 100
❤       Positive: 18 Negative: 20
️       Positive: 9 Negative: 18

**********
Tweet number 118
Tweet: @bae_ts WHATEVER STIL L YOUNG &amp;gt;:-(
Tokens: ['whatev', 'stil', 'l', 'young', '&gt;:-(']
Probability Positive: 0.5006402767570053
Actual Classification: 0

whatev  Positive: 5 Negative: 0
stil    Positive: 0 Negative: 0
l       Positive: 4 Negative: 1
young   Positive: 2 Negative: 3
&gt;:-(         Positive: 0 Negative: 2

**********
Tweet number 435
Tweet: @wtfxmbs AMBS please it's harry's jeans :)):):):(
Tokens: ['amb', 'pleas', "harry'", 'jean', ':)', '):', '):', '):']
Probability Positive: 0.821626817973081
Actual Classification: 0

amb     Positive: 0 Negative: 0
pleas   Positive: 76 Negative: 215
harry'  Positive: 0 Negative: 1
jean    Positive: 0 Negative: 1
:)      Positive: 2967 Negative: 1
):      Positive: 7 Negative: 1
):      Positive: 7 Negative: 1
):      Positive: 7 Negative: 1

**********
Tweet number 458
Tweet: @GODDAMMlT SRSLY FUCK U UNFOLLOWER HOPE UR FUTURE CHILD UNPARENTS U &amp;gt;:-(
Tokens: ['srsli', 'fuck', 'u', 'unfollow', 'hope', 'ur', 'futur', 'child', 'unpar', 'u', '&gt;:-(']
Probability Positive: 0.5157383070453547
Actual Classification: 0

srsli   Positive: 1 Negative: 4
fuck    Positive: 19 Negative: 48
u       Positive: 193 Negative: 162
unfollow        Positive: 55 Negative: 8
hope    Positive: 119 Negative: 77
ur      Positive: 28 Negative: 20
futur   Positive: 13 Negative: 1
child   Positive: 3 Negative: 3
unpar   Positive: 0 Negative: 0
u       Positive: 193 Negative: 162
&gt;:-(         Positive: 0 Negative: 2

**********
Tweet number 493
Tweet: 5h + kids makes all ://:(\\\
Tokens: ['5h', 'kid', 'make', ':/']
Probability Positive: 0.5003797971971914
Actual Classification: 0

5h      Positive: 0 Negative: 0
kid     Positive: 17 Negative: 16
make    Positive: 87 Negative: 77
:/      Positive: 4 Negative: 8

**********
Tweet number 788
Tweet: i love got7's outfit for just right &amp;gt;:( its so fun
Tokens: ['love', 'got', '7', 'outfit', 'right', '&gt;:(', 'fun']
Probability Positive: 0.5197464496373044
Actual Classification: 0

love    Positive: 306 Negative: 114
got     Positive: 55 Negative: 70
7       Positive: 5 Negative: 11
outfit  Positive: 3 Negative: 3
right   Positive: 41 Negative: 39
&gt;:(  Positive: 0 Negative: 36
fun     Positive: 48 Negative: 26

**********
Tweet number 995
Tweet: I ATE YOUR LAST COOKIE SHIR0 &amp;gt;:D
Tokens: ['ate', 'last', 'cooki', 'shir', '0', '&gt;:d']
Probability Positive: 0.4961173289819544
Actual Classification: 1

ate     Positive: 3 Negative: 8
last    Positive: 35 Negative: 58
cooki   Positive: 0 Negative: 2
shir    Positive: 0 Negative: 0
0       Positive: 1 Negative: 0
&gt;:d  Positive: 3 Negative: 0

**********
Tweet number 1662
Tweet: Sr. Financial Analyst - Expedia, Inc.: (#Bellevue, WA) http://t.co/ktknMhvwCI #Finance #ExpediaJobs #Job #Jobs #Hiring
Tokens: ['sr', 'financi', 'analyst', 'expedia', 'inc', 'bellevu', 'wa', 'financ', 'expediajob', 'job', 'job', 'hire']
Probability Positive: 0.5038917149486426
Actual Classification: 0

sr      Positive: 0 Negative: 1
financi         Positive: 0 Negative: 0
analyst         Positive: 0 Negative: 0
expedia         Positive: 0 Negative: 0
inc     Positive: 1 Negative: 2
bellevu         Positive: 0 Negative: 0
wa      Positive: 0 Negative: 0
financ  Positive: 0 Negative: 0
expediajob      Positive: 0 Negative: 0
job     Positive: 28 Negative: 12
job     Positive: 28 Negative: 12
hire    Positive: 0 Negative: 0
</pre>
<p>It looks like these were tweets with uncommon tokens. Personally I'm not sure what to make of some of them myself. And I'm not sure about the classifications - why is a job posting considered a negative tweet?</p>
</div>
</div>
<div class="outline-3" id="outline-container-org25bb1dc">
<h3 id="org25bb1dc">Some Fresh Tweets</h3>
<div class="outline-text-3" id="text-org25bb1dc">
<p>First someone reacting to a post about the <a href="https://www.atlasobscura.com/places/clown-motel">Clown Motel</a> in Tonopah, Nevada. The previous link was to Atlas Obscura, but the tweet came from <a href="https://www.thrillist.com/travel/nation/clown-motel-nevada-hame-anand">thrillist</a>.</p>
<div class="highlight">
<pre><span></span><span class="n">tweet</span> <span class="o">=</span> <span class="s2">"Nah dude. I drove by that at night and it was the creepiest thing ever. The whole town gave me bad vibes. I still shudder when I think about it."</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Classified as {sentiments[sentiment.classify(tweet)]}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Classified as negative
</pre>
<p>Seems reasonable.</p>
<div class="highlight">
<pre><span></span><span class="n">tweet</span> <span class="o">=</span> <span class="s2">"This is just dope. Quaint! I’d love to have an ironic drive-in wedding in Las Vegas and then stay in a clown motel as newly weds for one night. I bet they have Big Clown Suits for newly weds, haha."</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Classified as {sentiments[sentiment.classify(tweet)]}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Classified as positive
</pre></div>
</div>
<div class="outline-3" id="outline-container-orge033e0b">
<h3 id="orge033e0b">Compare to SKLearn</h3>
<div class="outline-text-3" id="text-orge033e0b">
<div class="highlight">
<pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="s2">"bias positive negative"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">classifier</span> <span class="o">=</span> <span class="n">LogisticRegressionCV</span><span class="p">(</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s2">"neg_log_loss"</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">training</span><span class="p">[</span><span class="n">columns</span><span class="p">],</span> <span class="n">training</span><span class="o">.</span><span class="n">sentiment</span><span class="p">)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">testing</span><span class="p">[</span><span class="n">columns</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">correct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">testing</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Accuracy: {correct[0]/len(testing)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Accuracy: 0.995
</pre>
<p>So it did pretty much the same just using the default parameters. We could probably do a parameter search but that's okay for now.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org807eac6">
<h3 id="org807eac6">Vizualizing the Model</h3>
<div class="outline-text-3" id="text-org807eac6">
<p>Since we've been given the model's weights we can plot its output when fed the vectors to see how it separates the data. To get the equation for the separation line we need to solve for the positive or negative terms when the product of the weights and the vector is 0 (\(\theta \times x = 0\), where <i>x</i> is our vector \(\langle bias, positive, negative \rangle\)).</p>
<p>Get ready for some algebra.</p>
\begin{align} \theta \times x &amp;= 0\\ \theta \times \langle bias, positive, negative \rangle &amp;= 0\\ \theta \times \langle 1, positive, negative \rangle &amp;= 0\\ \theta_0 + \theta_1 \times positive + \theta_2 \times negative &amp;= 0\\ \theta_2 \times negative &amp;= -\theta_0 - \theta_1 \times positive\\ negative &amp;= \frac{-\theta_0 - \theta_1 \times positive}{\theta_2}\\ \end{align}
<p>This is the equation for our separation line (on our plot <code>positive</code> is the <i>x-axis</i> and <code>negative</code> is the <i>y-axis</i>, which we can translate to a function to apply to our data.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">negative</span><span class="p">(</span><span class="n">theta</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">positive</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Calculate the negative value</span>

<span class="sd">    This calculates the value for the separation line</span>

<span class="sd">    Args:</span>
<span class="sd">     theta: list of weights for the logistic regression</span>
<span class="sd">     positive: count of positive tweets matching tweet</span>

<span class="sd">    Returns:</span>
<span class="sd">     the calculated negative value for the separation line</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="o">.</span><span class="n">bias</span>
            <span class="o">-</span> <span class="n">positive</span> <span class="o">*</span> <span class="n">theta</span><span class="o">.</span><span class="n">positive</span><span class="p">)</span><span class="o">/</span><span class="n">theta</span><span class="o">.</span><span class="n">negative</span>

<span class="n">theta</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">)</span>
<span class="n">negative_</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">negative</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
</pre></div>
<p>We plotted the vectorized data before, now we can add our regression line.</p>
<div class="highlight">
<pre><span></span><span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span>
    <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">"Positive"</span><span class="p">,</span> <span class="s2">"@positive{0,0}"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Negative"</span><span class="p">,</span> <span class="s2">"@negative{0,0}"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Sentiment"</span><span class="p">,</span> <span class="s2">"@Sentiment"</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="n">training</span><span class="p">[</span><span class="s2">"regression negative"</span><span class="p">]</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">positive</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">positive</span><span class="p">:</span> <span class="n">negative_</span><span class="p">(</span><span class="n">positive</span><span class="o">=</span><span class="n">positive</span><span class="p">))</span>

<span class="n">line</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"regression negative"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">tan</span><span class="p">)</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"sentiment"</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">])</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                               <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                               <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                               <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
                               <span class="n">title</span><span class="o">=</span><span class="s2">"Positive vs Negative Tweet Sentiment"</span><span class="p">,</span>
                           <span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">scatter</span> <span class="o">*</span> <span class="n">line</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"positive_negative_scatter_with_model"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/implementing-twitter-logistic-regression/positive_negative_scatter_with_model.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Let's see if a log-log scale helps.</p>
<div class="highlight">
<pre><span></span><span class="n">line</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"regression negative"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">tan</span><span class="p">)</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"sentiment"</span><span class="p">,</span>
                                  <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">])</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">scatter</span> <span class="o">*</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">xrotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Positive vs Negative Tweet Sentiment"</span><span class="p">,</span>
    <span class="n">logx</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"positive_negative_scatter_log"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/implementing-twitter-logistic-regression/positive_negative_scatter_log.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The log-scale seems to break the auto-scaling of the plot so you'll have to zoom out a little bit (with the <i>Wheel Zoom</i> tool on the toolbar) which will show you that the model did a pretty good job of separating the positive from the negative. You can see that some of the points aren't really linearly separable using our vectors so this is probably as good as it can get.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3c4f63b">
<h2 id="org3c4f63b">End</h2>
<div class="outline-text-2" id="text-org3c4f63b">
<p>This concludes the series begun with the post on <a href="posts/nlp/01-twitter-preprocessing-with-nltk/">pre-processing tweets</a>.</p>
<p>I should mention that I used <a href="posts/bibliographies/bib-speech-and-language-processing-jurafsky-martin/">Speech and Language Processing</a> to understanding the math.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/twitter-word-frequencies/">Twitter Word Frequencies</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/twitter-word-frequencies/" rel="bookmark"><time class="published dt-published" datetime="2020-07-07T18:19:19-07:00" itemprop="datePublished" title="2020-07-07 18:19">2020-07-07 18:19</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/twitter-word-frequencies/#org8f3bded">Beginning</a>
<ul>
<li><a href="posts/nlp/twitter-word-frequencies/#org4543b53">Setup</a></li>
</ul>
</li>
<li><a href="posts/nlp/twitter-word-frequencies/#orgccdca56">Middle</a>
<ul>
<li><a href="posts/nlp/twitter-word-frequencies/#orga4dacad">Word Frequencies</a></li>
<li><a href="posts/nlp/twitter-word-frequencies/#org361e0e6">Counting</a></li>
<li><a href="posts/nlp/twitter-word-frequencies/#orgb4b898c">Plotting</a></li>
</ul>
</li>
<li><a href="posts/nlp/twitter-word-frequencies/#orgb528488">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org8f3bded">
<h2 id="org8f3bded">Beginning</h2>
<div class="outline-text-2" id="text-org8f3bded">
<p>In the previous post in this series (<a href="posts/nlp/01-twitter-preprocessing-with-nltk/">Twitter Preprocessing With NLTK</a>) I made a pre-processor for tweets, now I'm going to make a counter that counts how many times a certain token shows up in positive and negative tweets.</p>
</div>
<div class="outline-3" id="outline-container-org4543b53">
<h3 id="org4543b53">Setup</h3>
<div class="outline-text-3" id="text-org4543b53"></div>
<div class="outline-4" id="outline-container-orgbeb5739">
<h4 id="orgbeb5739">Imports</h4>
<div class="outline-text-4" id="text-orgbeb5739">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">HoverTool</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>

<span class="c1"># some helper stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1f57598">
<h4 id="org1f57598">The Data</h4>
<div class="outline-text-4" id="text-org1f57598">
<p>First we'll load the training data that I set-up while building the tweet pre-processor.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_PROCESSED"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="n">training</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">training_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Rows: {len(training):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
                       tweet  label
0  [park, get, sunlight, :)]      1
Rows: 8,000
</pre>
<p>I also made an object to pass around to make sure I didn't switch the numeric <code>positive</code> and <code>negative</code> encodings so let's load that.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_SENTIMENT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Sentiment</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">Sentiment</span><span class="p">)</span>
</pre></div>
<pre class="example">
Namespace(decode={1: 'positive', 0: 'negative'}, encode={'positive': 1, 'negative': 0}, negative=0, positive=1)
</pre></div>
</div>
<div class="outline-4" id="outline-container-orga322555">
<h4 id="orga322555">Plotting and Printing</h4>
<div class="outline-text-4" id="text-orga322555">
<p>This is some preliminary setup of the plotter and table-printer so I don't have to keep typing the same things over and over.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"01b-twitter-word-frequencies"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="n">f</span><span class="s2">"files/posts/nlp/{SLUG}"</span><span class="p">)</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Plot</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgccdca56">
<h2 id="orgccdca56">Middle</h2>
<div class="outline-text-2" id="text-orgccdca56"></div>
<div class="outline-3" id="outline-container-orga4dacad">
<h3 id="orga4dacad">Word Frequencies</h3>
<div class="outline-text-3" id="text-orga4dacad">
<p>We're going to build up a <a href="https://docs.python.org/3/library/collections.html#collections.Counter">Counter</a> of token frequencies. The keys will be <code>(token, sentiment)</code> tuples and the values will be the counts for the token-sentiment pairs.</p>
</div>
<div class="outline-4" id="outline-container-org1a82642">
<h4 id="org1a82642">Tests</h4>
<div class="outline-text-4" id="text-org1a82642">
<p>These are the tests for the implementation that follows them.</p>
</div>
<ul class="org-ul">
<li><a id="org33829a7"></a>The Tangles<br>
<div class="outline-text-5" id="text-org33829a7">
<div class="highlight">
<pre><span></span>Feature: A Word Frequency Counter

In order to get a sense of how the words correlate with sentiment
I want to be able to count word-sentiment pairs.

&lt;&lt;counter-feature&gt;&gt;

&lt;&lt;call-feature&gt;&gt;
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">be</span><span class="p">,</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">given</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">,</span>
    <span class="n">then</span><span class="p">,</span>
    <span class="n">when</span>
<span class="p">)</span>

<span class="c1"># testing setup</span>
<span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span>

<span class="c1"># software under test</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>

<span class="n">scenarios</span><span class="p">(</span><span class="s2">"../../features/twitter/word_frequencies.feature"</span><span class="p">)</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">creation</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">call</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
</li>
<li><a id="org4225925"></a>Setup<br>
<div class="outline-text-5" id="text-org4225925">
<div class="highlight">
<pre><span></span>Scenario: The Word Counter is created
  Given a word counter class
  When the word counter is created
  Then it has the expected attributes
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The Word Counter is created</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a word counter class"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_class</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">definition</span> <span class="o">=</span> <span class="n">WordCounter</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the word counter is created"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_word_counter</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">definition</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span>
                                           <span class="n">labels</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">processor</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it has the expected attributes"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_attributes</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">tweets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">process</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">processor</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org9ad45ad"></a>The Call<br>
<div class="outline-text-5" id="text-org9ad45ad">
<div class="highlight">
<pre><span></span>Scenario: The Word Frequency counter is called
  Given a word frequency counter
  When the counter is called
  Then the counts are the expected
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The Word Frequency counter is called</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a word frequency counter"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_word_frequency_counter</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"a b aab a b c"</span><span class="p">]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span>
                                   <span class="n">labels</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>

    <span class="n">bad_sentiment</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"c aab aab"</span><span class="p">]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">+=</span> <span class="n">bad_sentiment</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">labels</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># since the tokenizer removes and changes words</span>
    <span class="c1"># I'm going to mock it out</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">TwitterProcessor</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">{(</span><span class="s2">"a"</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="s2">"c"</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s2">"aab"</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span><span class="mi">1</span><span class="p">,</span>
                         <span class="p">(</span><span class="s2">"c"</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s2">"aab"</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">2</span><span class="p">}</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the counter is called"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">call_counter</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"the counts are the expected"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_counts</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">katamari</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org13d8d89">
<h4 id="org13d8d89">Implementation</h4>
<div class="outline-text-4" id="text-org13d8d89">
<p>This is going to be a counter class that pre-processes the tweets and then counts the frequency of word-sentiment pairs.</p>
<div class="highlight">
<pre><span></span><span class="c1"># A Word Counter</span>

<span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">typing</span>

<span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>

<span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">WordCounter</span><span class="p">:</span>
    <span class="sd">"""A word-sentiment counter</span>

<span class="sd">    Args:</span>
<span class="sd">     tweets: list of unprocessed tweets</span>
<span class="sd">     labels: list of 1's (positive) and 0's that identifies sentiment for each tweet</span>
<span class="sd">    """</span>
    <span class="n">tweets</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">_process</span><span class="p">:</span> <span class="n">TwitterProcessor</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_processed</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_counts</span><span class="p">:</span> <span class="n">Counter</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TwitterProcessor</span><span class="p">:</span>
        <span class="sd">"""A callable to process tweets to lists of words"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">processed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">"""The processed and tokenized tweets"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_processed</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tweets</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processed</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">counts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Counter</span><span class="p">:</span>
        <span class="sd">"""Processes the tweets and labels</span>

<span class="sd">       Returns:</span>
<span class="sd">        counts of word-sentiment pairs</span>
<span class="sd">       """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tweets</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span> \
                <span class="n">f</span><span class="s2">"Tweets: {len(self.tweets)}, Labels: {len(self.labels)}"</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">tweet</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tweet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_counts</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">label</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counts</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org361e0e6">
<h3 id="org361e0e6">Counting</h3>
<div class="outline-text-3" id="text-org361e0e6">
<p>Now that we've implemented the counter we might as well get to counting. This is going to be kind of hacky, but I originally wasn't saving the processed data and so was expecting this thing to process it. Maybe I'll change it to look better late. But, anyway that's why I'm assigning the column to the <code>._processed</code> attribute.</p>
<div class="highlight">
<pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">training</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="n">counter</span><span class="o">.</span><span class="n">_processed</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">tweet</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">counts</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Total token-sentiment pairs: {len(counts):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Total token-sentiment pairs: 11,476
</pre>
<p>What are the most common? To make the rest of the post easier I'm going to set up a pandas DataFrame.</p>
<div class="highlight">
<pre><span></span><span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">top_counts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sentiments</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="o">=</span> <span class="n">key</span>
    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">sentiments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentiment</span><span class="p">)</span>
    <span class="n">top_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

<span class="n">top_counts</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">token</span><span class="o">=</span><span class="n">tokens</span><span class="p">,</span>
    <span class="n">count</span><span class="o">=</span><span class="n">top_counts</span><span class="p">,</span>
    <span class="n">sentiment</span><span class="o">=</span><span class="n">sentiments</span><span class="p">,</span>
<span class="p">))</span>

<span class="n">top_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">"sentiment"</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_counts</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">decode</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">top_counts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">20</span><span class="p">]))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">token</th>
<th class="org-right" scope="col">count</th>
<th class="org-left" scope="col">sentiment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">:(</td>
<td class="org-right">3705</td>
<td class="org-left">negative</td>
</tr>
<tr>
<td class="org-left">:)</td>
<td class="org-right">2967</td>
<td class="org-left">positive</td>
</tr>
<tr>
<td class="org-left">:-)</td>
<td class="org-right">547</td>
<td class="org-left">positive</td>
</tr>
<tr>
<td class="org-left">:D</td>
<td class="org-right">537</td>
<td class="org-left">positive</td>
</tr>
<tr>
<td class="org-left">thank</td>
<td class="org-right">516</td>
<td class="org-left">positive</td>
</tr>
<tr>
<td class="org-left">:-(</td>
<td class="org-right">407</td>
<td class="org-left">negative</td>
</tr>
<tr>
<td class="org-left">follow</td>
<td class="org-right">349</td>
<td class="org-left">positive</td>
</tr>
<tr>
<td class="org-left">love</td>
<td class="org-right">306</td>
<td class="org-left">positive</td>
</tr>
<tr>
<td class="org-left">i'm</td>
<td class="org-right">282</td>
<td class="org-left">negative</td>
</tr>
<tr>
<td class="org-left">…</td>
<td class="org-right">261</td>
<td class="org-left">negative</td>
</tr>
<tr>
<td class="org-left">miss</td>
<td class="org-right">241</td>
<td class="org-left">negative</td>
</tr>
<tr>
<td class="org-left">…</td>
<td class="org-right">228</td>
<td class="org-left">positive</td>
</tr>
<tr>
<td class="org-left">pleas</td>
<td class="org-right">215</td>
<td class="org-left">negative</td>
</tr>
<tr>
<td class="org-left">follow</td>
<td class="org-right">211</td>
<td class="org-left">negative</td>
</tr>
<tr>
<td class="org-left">get</td>
<td class="org-right">200</td>
<td class="org-left">negative</td>
</tr>
<tr>
<td class="org-left">want</td>
<td class="org-right">197</td>
<td class="org-left">negative</td>
</tr>
<tr>
<td class="org-left">day</td>
<td class="org-right">194</td>
<td class="org-left">positive</td>
</tr>
<tr>
<td class="org-left">u</td>
<td class="org-right">193</td>
<td class="org-left">positive</td>
</tr>
<tr>
<td class="org-left">good</td>
<td class="org-right">189</td>
<td class="org-left">positive</td>
</tr>
<tr>
<td class="org-left">like</td>
<td class="org-right">189</td>
<td class="org-left">positive</td>
</tr>
</tbody>
</table>
<p>It's interesting that the only tokens in the top 20 that are both positive and negative are ellipses and "follow" and that the four most common tokens were smileys, although given the nature of tweets I guess the use of smileys (emoticons?) shouldn't be so surprising. I didn't notice this at first, but the most common token is a negative one.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgb4b898c">
<h3 id="orgb4b898c">Plotting</h3>
<div class="outline-text-3" id="text-orgb4b898c">
<p>The counts themselves are interesting, but it might be more informative to look at their distribution as well as whether some tokens are more positive or negative.</p>
</div>
<div class="outline-4" id="outline-container-orgb9e4b69">
<h4 id="orgb9e4b69">Positive Vs Negative</h4>
<div class="outline-text-4" id="text-orgb9e4b69">
<div class="highlight">
<pre><span></span><span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">"Token"</span><span class="p">,</span> <span class="s2">"@token"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"Sentiment"</span><span class="p">,</span> <span class="s2">"@sentiment"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"Count"</span><span class="p">,</span> <span class="s2">"@count"</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="n">tooltips</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">top_counts</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">"bar"</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">"sentiment"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"count"</span><span class="p">,</span>
                         <span class="n">hover_cols</span><span class="o">=</span><span class="s2">"all"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>    
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Positive and Negative"</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span>
    <span class="n">line_color</span><span class="o">=</span><span class="s2">"white"</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">embedded</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"positive_negative_distribution"</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">embedded</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/twitter-word-frequencies/positive_negative_distribution.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So it looks like negative sentiment is more common for the tokens, even though the tweets themselves were evenly split, maybe because the negative tweets had more diverse tokens.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgcfd523b">
<h4 id="orgcfd523b">Distribution</h4>
<div class="outline-text-4" id="text-orgcfd523b">
<div class="highlight">
<pre><span></span><span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">"Token"</span><span class="p">,</span> <span class="s2">"@token"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"Sentiment"</span><span class="p">,</span> <span class="s2">"@sentiment"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"Count"</span><span class="p">,</span> <span class="s2">"@count"</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="n">tooltips</span><span class="p">)</span>

<span class="n">CUTOFF</span> <span class="o">=</span> <span class="mi">150</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">top_counts</span><span class="p">[:</span><span class="n">CUTOFF</span><span class="p">]</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">"count"</span><span class="p">,</span> <span class="n">hover_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">"token"</span><span class="p">,</span> <span class="s2">"sentiment"</span><span class="p">],</span>
    <span class="n">loglog</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">],</span>
        <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
        <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span>
        <span class="n">line_color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s2">"Log-Log Count Distribution (top {CUTOFF})"</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"count_distribution"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/twitter-word-frequencies/count_distribution.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>This shows how steep the drop is from the two most common tokens which are then followed by a long tail. Without the logarithmic axes the drop is even more pronounced.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org275b00e">
<h4 id="org275b00e">Positive Vs Negative by Tweet</h4>
<div class="outline-text-4" id="text-org275b00e">
<div class="highlight">
<pre><span></span><span class="n">CUTOFF</span> <span class="o">=</span> <span class="mi">250</span>

<span class="n">top_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">"positive"</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_counts</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">"count"</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">sentiment</span><span class="o">==</span><span class="s2">"positive"</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>

<span class="n">top_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">"negative"</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_counts</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">"count"</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">sentiment</span><span class="o">==</span><span class="s2">"negative"</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span>
<span class="p">)</span>

<span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">"Token"</span><span class="p">,</span> <span class="s2">"@token"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"Positive"</span><span class="p">,</span> <span class="s2">"@positive"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"Negative"</span><span class="p">,</span> <span class="s2">"@negative"</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="n">tooltips</span><span class="p">)</span>

<span class="n">grouped</span> <span class="o">=</span> <span class="n">top_counts</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"token"</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">"positive"</span><span class="p">:</span> <span class="s2">"sum"</span><span class="p">,</span> <span class="s2">"negative"</span><span class="p">:</span> <span class="s2">"sum"</span><span class="p">})</span>
<span class="n">to_plot</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># log plots can't have zero values</span>
<span class="n">MIN</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"positive"</span><span class="p">,</span> <span class="s2">"negative"</span><span class="p">):</span>
    <span class="n">to_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_plot</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">MAX</span> <span class="o">=</span> <span class="n">to_plot</span><span class="o">.</span><span class="n">negative</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">Curve</span><span class="p">(([</span><span class="n">MIN</span><span class="p">,</span> <span class="n">MAX</span><span class="p">],</span> <span class="p">[</span><span class="n">MIN</span><span class="p">,</span> <span class="n">MAX</span><span class="p">]))</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">to_plot</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">loglog</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span>
    <span class="n">hover_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">"token"</span><span class="p">])</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">*</span> <span class="n">scatter</span> <span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">],</span>
        <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s2">"Positive"</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="o">=</span><span class="s2">"Negative"</span><span class="p">,</span>
        <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">"Log-Log Positive vs Negative"</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"scatter_plot"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/twitter-word-frequencies/scatter_plot.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The tokens along or around the diagonal are evenly positive and negative so they probably aren't useful indicators of sentiment in and of themselves, while those furthest from the diagonal are the most biased to one side or the other so we might expect them to be useful in guessing a tweet's sentiment.</p>
<p>There are some unexpectedly negative tokens like "love" (400, 152) and "thank" (620, 107), but at this point we haven't really started to look at the sentiment yet so I'll leave further exploration for later.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgb528488">
<h2 id="orgb528488">End</h2>
<div class="outline-text-2" id="text-orgb528488">
<p>Since the counter gets re-used I'm going to pickle it for later.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_COUNTER"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</pre></div>
<p>Next in this series: <a href="posts/nlp/the-tweet-vectorizer/">The Tweet Vectorizer</a></p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/01-twitter-preprocessing-with-nltk/">Twitter Preprocessing With NLTK</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/01-twitter-preprocessing-with-nltk/" rel="bookmark"><time class="published dt-published" datetime="2020-07-03T21:23:48-07:00" itemprop="datePublished" title="2020-07-03 21:23">2020-07-03 21:23</time> <span class="updated">(updated <time class="dt-updated" datetime="2020-07-24T18:23:48-07:00" itemprop="dateUpdated" title="2020-07-24 18:23">2020-07-24 18:23</time>)</span></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#orgf3b6ac2">Beginning</a>
<ul>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#org1f9d81e">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#org035f1cc">Middle</a>
<ul>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#org239bb2d">Explore the Data</a></li>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#org53b0d94">Processing the Data</a></li>
</ul>
</li>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#org8d2bb43">End</a>
<ul>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#orgbfcc4ec">Tests</a></li>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#orgf41ffb6">Implementation</a></li>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#orgf91284e">Save Things</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgf3b6ac2">
<h2 id="orgf3b6ac2">Beginning</h2>
<div class="outline-text-2" id="text-orgf3b6ac2">
<p>This is the first in a series that will look at taking a group of tweets and building a <a href="https://www.wikiwand.com/en/Logistic_regression">Logistic Regression</a> model to classify tweets as being either positive or negative in their sentiment. This post is followed by:</p>
<ul class="org-ul">
<li><a href="posts/nlp/twitter-word-frequencies/">Twitter Word Frequencies</a></li>
<li><a href="posts/nlp/the-tweet-vectorizer/">The Tweet Vectorizer</a></li>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/">Implementing Logistic Regression for Tweet Sentiment Analysis</a></li>
</ul>
<p>This first post is a look at taking a corpus of <a href="https://twitter.com/explore">Twitter</a> data which comes from the <a href="https://www.nltk.org/">Natural Language Toolkit's (NLTK)</a> collection of data and creating a preprocessor for a <a href="https://www.wikiwand.com/en/Sentiment_analysis">Sentiment Analysis</a> pipeline. This dataset has entries whose sentiment was categorized by hand so it's a convenient source for training models.</p>
<p>The <a href="https://www.nltk.org/howto/corpus.html">NLTK Corpus How To</a> has a brief description of the Twitter dataset and they also have <a href="https://www.nltk.org/howto/twitter.html">some documentation</a> about how to gather new data using the Twitter API yourself.</p>
</div>
<div class="outline-3" id="outline-container-org1f9d81e">
<h3 id="org1f9d81e">Set Up</h3>
<div class="outline-text-3" id="text-org1f9d81e"></div>
<div class="outline-4" id="outline-container-org4f45491">
<h4 id="org4f45491">Imports</h4>
<div class="outline-text-4" id="text-org4f45491">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>
<span class="kn">from</span> <span class="nn">nltk.stem</span> <span class="kn">import</span> <span class="n">PorterStemmer</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">TweetTokenizer</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># this is created further down in the post</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">CountPercentage</span><span class="p">,</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd2fe5a8">
<h4 id="orgd2fe5a8">The Environment</h4>
<div class="outline-text-4" id="text-orgd2fe5a8">
<p>This is where I keep the paths to the files I save.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb7da031">
<h4 id="orgb7da031">Data</h4>
<div class="outline-text-4" id="text-orgb7da031">
<p>The first thing to do is download the dataset using the <a href="https://www.nltk.org/data.html">download</a> function. If you don't pass an argument to it a dialog will open and you can choose to download any or all of their datasets, but for this exercise we'll just download the Twitter samples. Note that if you run this function and the samples were already downloaded then it won't re-download them so it's safe to call it in any case.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'twitter_samples'</span><span class="p">)</span>
</pre></div>
<p>The data is contained in three files. You can see the file names using the <code>twitter_samples.fileids</code> function.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">fileids</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">" - {name}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
- negative_tweets.json
- positive_tweets.json
- tweets.20150430-223406.json
</pre>
<p>As you can see (or maybe guess) two of the files contain tweets that have been categorized as negative or positive. The third file has another 20,000 tweets that aren't classified.</p>
<p>The dataset contains the JSON for each tweet, including some metadata, which you can access through the <code>twitter_samples.docs</code> function. Here's a sample.</p>
<div class="highlight">
<pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">twitter_samples</span><span class="o">.</span><span class="n">docs</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
{'contributors': None,
 'coordinates': None,
 'created_at': 'Fri Jul 24 10:42:49 +0000 2015',
 'entities': {'hashtags': [], 'symbols': [], 'urls': [], 'user_mentions': []},
 'favorite_count': 0,
 'favorited': False,
 'geo': None,
 'id': 624530164626534400,
 'id_str': '624530164626534400',
 'in_reply_to_screen_name': None,
 'in_reply_to_status_id': None,
 'in_reply_to_status_id_str': None,
 'in_reply_to_user_id': None,
 'in_reply_to_user_id_str': None,
 'is_quote_status': False,
 'lang': 'en',
 'metadata': {'iso_language_code': 'en', 'result_type': 'recent'},
 'place': None,
 'retweet_count': 0,
 'retweeted': False,
 'source': '&lt;a href="https://mobile.twitter.com" rel="nofollow"&gt;Mobile Web '
           '(M2)&lt;/a&gt;',
 'text': 'hopeless for tmr :(',
 'truncated': False,
 'user': {'contributors_enabled': False,
          'created_at': 'Sun Mar 08 05:43:40 +0000 2015',
          'default_profile': False,
          'default_profile_image': False,
          'description': '⇨ [V] TravelGency █ 2/4 Goddest from Girls Day █ 92L '
                         '█ sucrp',
          'entities': {'description': {'urls': []}},
          'favourites_count': 196,
          'follow_request_sent': False,
          'followers_count': 1281,
          'following': False,
          'friends_count': 1264,
          'geo_enabled': True,
          'has_extended_profile': False,
          'id': 3078803375,
          'id_str': '3078803375',
          'is_translation_enabled': False,
          'is_translator': False,
          'lang': 'id',
          'listed_count': 3,
          'location': 'wearegsd;favor;pucukfams;barbx',
          'name': 'yuwra ✈ ',
          'notifications': False,
          'profile_background_color': '000000',
          'profile_background_image_url': 'http://pbs.twimg.com/profile_background_images/585476378365014016/j1mvQu3c.png',
          'profile_background_image_url_https': 'https://pbs.twimg.com/profile_background_images/585476378365014016/j1mvQu3c.png',
          'profile_background_tile': True,
          'profile_banner_url': 'https://pbs.twimg.com/profile_banners/3078803375/1433287528',
          'profile_image_url': 'http://pbs.twimg.com/profile_images/622631732399898624/kmYsX_k1_normal.jpg',
          'profile_image_url_https': 'https://pbs.twimg.com/profile_images/622631732399898624/kmYsX_k1_normal.jpg',
          'profile_link_color': '000000',
          'profile_sidebar_border_color': '000000',
          'profile_sidebar_fill_color': '000000',
          'profile_text_color': '000000',
          'profile_use_background_image': True,
          'protected': False,
          'screen_name': 'yuwraxkim',
          'statuses_count': 19710,
          'time_zone': 'Jakarta',
          'url': None,
          'utc_offset': 25200,
          'verified': False}}
</pre>
<p>There's some potentially useful data here - like if the tweet was re-tweeted, but for what we're doing we'll just use the tweet itself.</p>
<p>To get just the text of the tweets you use the <code>twitter_samples.strings</code> function.</p>
<div class="highlight">
<pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">)</span>
</pre></div>
<pre class="example">
Help on method strings in module nltk.corpus.reader.twitter:

strings(fileids=None) method of nltk.corpus.reader.twitter.TwitterCorpusReader instance
    Returns only the text content of Tweets in the file(s)
    
    :return: the given file(s) as a list of Tweets.
    :rtype: list(str)

</pre>
<p>Note that it says that it returns only the given file(s) as a list of tweets but it also makes the <code>fileids</code> argument optional. If you don't pass in any argument you end up with the tweets from all the files in the same list, which you probably don't want.</p>
<div class="highlight">
<pre><span></span><span class="n">positive</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s1">'positive_tweets.json'</span><span class="p">)</span>
<span class="n">negative</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s1">'negative_tweets.json'</span><span class="p">)</span>
<span class="n">all_tweets</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s2">"tweets.20150430-223406.json"</span><span class="p">)</span>
</pre></div>
<p>Now I'll download the stopwords for our pre-processing and setup the english stopwords for use later.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'stopwords'</span><span class="p">)</span>
<span class="n">english_stopwords</span> <span class="o">=</span> <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s2">"english"</span><span class="p">)</span>
</pre></div>
<p>Rather than working with the whole data-set I'm going to split it up here so we'll only work with the training set. First thing is to create a set of labels for the positive and negative tweets.</p>
<div class="highlight">
<pre><span></span><span class="n">Sentiment</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">positive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">negative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">decode</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">"positive"</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s2">"negative"</span>
    <span class="p">},</span>
    <span class="n">encode</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"positive"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">"negative"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">positive_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span>
<span class="n">negative_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative</span><span class="p">)</span>
</pre></div>
<p>Now I'll combine the positive and negative tweets.</p>
<div class="highlight">
<pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="n">positive_labels</span> <span class="o">+</span> <span class="n">negative_labels</span>
<span class="n">tweets</span> <span class="o">=</span> <span class="n">positive</span> <span class="o">+</span> <span class="n">negative</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Labels: {len(labels):,}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"tweets: {len(tweets):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Labels: 10,000
tweets: 10,000
</pre>
<p>Now we can do the train-test splitting. The <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html">train_test_split</a> function shuffles and splits up the dataset, so combining the positive and negative sets first before the splitting seemed like a good idea.</p>
<div class="highlight">
<pre><span></span><span class="n">TRAINING_SIZE</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">SEED</span> <span class="o">=</span> <span class="mi">20200724</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">tweets</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="n">TRAINING_SIZE</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training: {len(x_train):,}</span><span class="se">\t</span><span class="s2">Testing: {len(x_test):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training: 8,000 Testing: 2,000
</pre></div>
</div>
<div class="outline-4" id="outline-container-org21e85d4">
<h4 id="org21e85d4">The Random Seed</h4>
<div class="outline-text-4" id="text-org21e85d4">
<p>This just sets the random seed so that we get the same values if we re-run this later on (although this is a little tricky with the notebook, since you can call the same code multiple times).</p>
<div class="highlight">
<pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9c6de5a">
<h4 id="org9c6de5a">Plotting</h4>
<div class="outline-text-4" id="text-org9c6de5a">
<p>I won't be doing a lot of plotting here, but this is a setup for the little that I do.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"01-twitter-preprocessing-with-nltk"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="n">f</span><span class="s2">"files/posts/nlp/{SLUG}"</span><span class="p">,</span>
                <span class="n">create_folder</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
    <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">Cycle</span><span class="p">([</span><span class="s2">"#4687b7"</span><span class="p">,</span> <span class="s2">"#ce7b6d"</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org035f1cc">
<h2 id="org035f1cc">Middle</h2>
<div class="outline-text-2" id="text-org035f1cc">
<p>It can be more convenient to use a <a href="https://pandas.pydata.org/pandas-docs/stable/reference/series.html">Pandas Series</a> for some checks of the tweets so I'll convert the all-tweets list to one.</p>
<div class="highlight">
<pre><span></span><span class="n">all_tweets</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">all_tweets</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-org239bb2d">
<h3 id="org239bb2d">Explore the Data</h3>
<div class="outline-text-3" id="text-org239bb2d">
<p>Let's start by looking at the number of tweets we got and confirming that the <code>strings</code> function gave us back a list of strings like the docstring said it would.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Number of tweets: {len(all_tweets):,}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'Number of positive tweets: {len(positive):,}'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'Number of negative tweets: {len(negative):,}'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">negative</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">thing</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">str</span>
</pre></div>
<pre class="example">
Number of tweets: 20,000
Number of positive tweets: 5,000
Number of negative tweets: 5,000
</pre>
<p>We can see that the data for each file is made up of strings stored in a list and there were 20,000 tweets in total but only half as much were categorized.</p>
</div>
<div class="outline-4" id="outline-container-org1721170">
<h4 id="org1721170">Looking At Some Examples</h4>
<div class="outline-text-4" id="text-org1721170">
<p>First, since our data sets are shuffled, I'll convert them into a pandas DataFrame to make it a little easier to get positive vs negative tweets.</p>
<div class="highlight">
<pre><span></span><span class="n">training</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">tweet</span><span class="o">=</span><span class="n">x_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_train</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Random Positive Tweet: {random.choice(positive)}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Random Negative Tweet: {random.choice(negative)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Random Positive Tweet: Hi.. Please say"happybirthday" to me :) thanksss :) —  http://t.co/HPXV43LK5L

Random Negative Tweet: I think I should stop getting so angry over stupid shit :(
</pre></div>
</div>
<div class="outline-4" id="outline-container-org44ebee8">
<h4 id="org44ebee8">The First Token</h4>
<div class="outline-text-4" id="text-org44ebee8">
<p>Later on we're going to remove the "RT" (re-tweet) token at the start of the strings. Let's look at how significant this is.</p>
<div class="highlight">
<pre><span></span><span class="n">first_tokens</span> <span class="o">=</span> <span class="n">all_tweets</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">top_ten</span> <span class="o">=</span> <span class="n">CountPercentage</span><span class="p">(</span><span class="n">first_tokens</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">value_label</span><span class="o">=</span><span class="s2">"First Token"</span><span class="p">)</span>
<span class="n">top_ten</span><span class="p">()</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">First Token</th>
<th class="org-right" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">RT</td>
<td class="org-right">13287</td>
<td class="org-right">92.92</td>
</tr>
<tr>
<td class="org-left">I</td>
<td class="org-right">160</td>
<td class="org-right">1.12</td>
</tr>
<tr>
<td class="org-left">Farage</td>
<td class="org-right">141</td>
<td class="org-right">0.99</td>
</tr>
<tr>
<td class="org-left">The</td>
<td class="org-right">134</td>
<td class="org-right">0.94</td>
</tr>
<tr>
<td class="org-left">VIDEO:</td>
<td class="org-right">132</td>
<td class="org-right">0.92</td>
</tr>
<tr>
<td class="org-left">Nigel</td>
<td class="org-right">117</td>
<td class="org-right">0.82</td>
</tr>
<tr>
<td class="org-left">Ed</td>
<td class="org-right">116</td>
<td class="org-right">0.81</td>
</tr>
<tr>
<td class="org-left">Miliband</td>
<td class="org-right">77</td>
<td class="org-right">0.54</td>
</tr>
<tr>
<td class="org-left">SNP</td>
<td class="org-right">69</td>
<td class="org-right">0.48</td>
</tr>
<tr>
<td class="org-left">@UKIP</td>
<td class="org-right">67</td>
<td class="org-right">0.47</td>
</tr>
</tbody>
</table>
<p>That gives you some sense of how much there is, but plotting it might make it a little clearer.</p>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">top_ten</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">"Percent (%)"</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">"First Token"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Top Ten Tweet First Tokens"</span><span class="p">,</span> 
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"top_ten"</span><span class="p">,</span> <span class="n">create_folder</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">())</span>
</pre></div>
<object data="posts/nlp/01-twitter-preprocessing-with-nltk/top_ten.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So, about 93 % of the unclassified tweets start with <code>RT</code>, making it perhaps not so informative a token. Or maybe it is… what does a re-tweet tell us? Let's look at if the re-tweeted show up as duplicates and if so, how many times they show up.</p>
<div class="highlight">
<pre><span></span><span class="n">retweeted</span> <span class="o">=</span> <span class="n">all_tweets</span><span class="p">[</span><span class="n">all_tweets</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"RT"</span><span class="p">)]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">retweeted</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">" - {item}"</span><span class="p">)</span>
</pre></div>
<ul class="org-ul">
<li>491</li>
<li>430</li>
<li>131</li>
<li>131</li>
<li>117</li>
<li>103</li>
<li>82</li>
<li>73</li>
<li>69</li>
<li>68</li>
</ul>
<p>Some of the entries are the same tweet repeated hundreds of times. Does each one count as an additional entry? I don't show it here because the tweets are kind of long, but the top five are all about British politics, so there might have been some kind of bias in the way the tweets were gathered.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org53b0d94">
<h3 id="org53b0d94">Processing the Data</h3>
<div class="outline-text-3" id="text-org53b0d94">
<p>There are four basic steps in our NLP pre-processing:</p>
<ul class="org-ul">
<li><a href="https://nlp.stanford.edu/IR-book/html/htmledition/tokenization-1.html">Tokenization</a></li>
<li>Lower-casing</li>
<li>Removing <a href="https://www.wikiwand.com/en/Stop_words">stop words</a> and punctuation</li>
<li><a href="https://www.wikiwand.com/en/Stemming">Stemming</a></li>
</ul>
<p>Let's start by pulling up a tweet that has most of the stuff we're cleaning up.</p>
<div class="highlight">
<pre><span></span><span class="n">THE_CHOSEN</span> <span class="o">=</span> <span class="n">training</span><span class="p">[(</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"beautiful"</span><span class="p">))</span> <span class="o">&</span>
                      <span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"http"</span><span class="p">))</span> <span class="o">&</span>
                      <span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"#"</span><span class="p">))]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tweet</span>
<span class="k">print</span><span class="p">(</span><span class="n">THE_CHOSEN</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) #sunflowers #favourites #happy #Friday off… https://t.co/3tfYom0N1i
</pre></div>
<div class="outline-4" id="outline-container-orgd1ff16d">
<h4 id="orgd1ff16d">Cleaning Up Twitter-Specific Markup</h4>
<div class="outline-text-4" id="text-orgd1ff16d">
<p>Although I listed four steps in the beginning, there's often another step where we remove things that are common or not useful but known in advance. In this case we want to remove re-tweet tags (<code>RT</code>), hyperlinks, and hashtags. We're going to do that with python's built in <a href="https://docs.python.org/3/library/re.html">regular expression</a> module. We're also going to do it one tweet at a time, although you could perhaps more efficiently do it in bulk using pandas.</p>
<div class="highlight">
<pre><span></span><span class="n">START_OF_LINE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"^"</span>
<span class="n">OPTIONAL</span> <span class="o">=</span> <span class="s2">"?"</span>
<span class="n">ANYTHING</span> <span class="o">=</span> <span class="s2">"."</span>
<span class="n">ZERO_OR_MORE</span> <span class="o">=</span> <span class="s2">"*"</span>
<span class="n">ONE_OR_MORE</span> <span class="o">=</span> <span class="s2">"+"</span>

<span class="n">SPACE</span> <span class="o">=</span> <span class="s2">"\s"</span>
<span class="n">SPACES</span> <span class="o">=</span> <span class="n">SPACE</span> <span class="o">+</span> <span class="n">ONE_OR_MORE</span>
<span class="n">NOT_SPACE</span> <span class="o">=</span> <span class="s2">"[^\s]"</span> <span class="o">+</span> <span class="n">ONE_OR_MORE</span>
<span class="n">EVERYTHING_OR_NOTHING</span> <span class="o">=</span> <span class="n">ANYTHING</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span>

<span class="n">ERASE</span> <span class="o">=</span> <span class="s2">""</span>
<span class="n">FORWARD_SLASH</span> <span class="o">=</span> <span class="s2">"\/"</span>
<span class="n">NEWLINES</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"[\r\n]"</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgdd69f98"></a>Re-Tweets<br>
<div class="outline-text-5" id="text-orgdd69f98">
<p>None of the positive or negative samples have this tag so I'm going to pull an example from the complete set just to show it working.</p>
<div class="highlight">
<pre><span></span><span class="n">RE_TWEET</span> <span class="o">=</span> <span class="n">START_OF_LINE</span> <span class="o">+</span> <span class="s2">"RT"</span> <span class="o">+</span> <span class="n">SPACES</span>

<span class="n">tweet</span> <span class="o">=</span> <span class="n">all_tweets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
<span class="n">tweet</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">RE_TWEET</span><span class="p">,</span> <span class="n">ERASE</span><span class="p">,</span> <span class="n">tweet</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
</pre></div>
<pre class="example">
RT @KirkKus: Indirect cost of the UK being in the EU is estimated to be costing Britain £170 billion per year! #BetterOffOut #UKIP
@KirkKus: Indirect cost of the UK being in the EU is estimated to be costing Britain £170 billion per year! #BetterOffOut #UKIP
</pre></div>
</li>
<li><a id="orgf262e79"></a>Hyperlinks<br>
<div class="outline-text-5" id="text-orgf262e79">
<div class="highlight">
<pre><span></span><span class="n">HYPERLINKS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"http"</span> <span class="o">+</span> <span class="s2">"s"</span> <span class="o">+</span> <span class="n">OPTIONAL</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="n">FORWARD_SLASH</span> <span class="o">+</span> <span class="n">FORWARD_SLASH</span>
              <span class="o">+</span> <span class="n">NOT_SPACE</span> <span class="o">+</span> <span class="n">NEWLINES</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">THE_CHOSEN</span><span class="p">)</span>
<span class="n">re_chosen</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">HYPERLINKS</span><span class="p">,</span> <span class="n">ERASE</span><span class="p">,</span> <span class="n">THE_CHOSEN</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) #sunflowers #favourites #happy #Friday off… https://t.co/3tfYom0N1i
My beautiful sunflowers on a sunny Friday morning off :) #sunflowers #favourites #happy #Friday off… 
</pre></div>
</li>
<li><a id="org527cc9b"></a>HashTags<br>
<div class="outline-text-5" id="text-org527cc9b">
<p>We aren't removing the actual hash-tags, just the hash-marks (<code>#</code>).</p>
<div class="highlight">
<pre><span></span><span class="n">HASH</span> <span class="o">=</span> <span class="s2">"#"</span>
<span class="n">re_chosen</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">HASH</span><span class="p">,</span> <span class="n">ERASE</span><span class="p">,</span> <span class="n">re_chosen</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) sunflowers favourites happy Friday off… 
</pre></div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orga278694">
<h4 id="orga278694">Tokenize</h4>
<div class="outline-text-4" id="text-orga278694">
<p>NLTK has a tokenizer specially built for tweets. The <code>twitter_samples</code> module actually has a <code>tokenizer</code> function that breaks the tweets up, but since we are using regular expressions to clean up the strings a little first, it makes more sense to tokenize the strings afterwards. Also note that one of the steps in the pipeline is to lower-case the letters, which the <code>TweetTokenizer</code> will do for us if we set the <code>preserve_case</code> argument to <code>False</code>.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">help</span><span class="p">(</span><span class="n">TweetTokenizer</span><span class="p">))</span>
</pre></div>
<pre class="example">
Help on class TweetTokenizer in module nltk.tokenize.casual:

class TweetTokenizer(builtins.object)
 |  TweetTokenizer(preserve_case=True, reduce_len=False, strip_handles=False)
 |  
 |  Tokenizer for tweets.
 |  
 |      &gt;&gt;&gt; from nltk.tokenize import TweetTokenizer
 |      &gt;&gt;&gt; tknzr = TweetTokenizer()
 |      &gt;&gt;&gt; s0 = "This is a cooool #dummysmiley: :-) :-P &lt;3 and some arrows &lt; &gt; -&gt; &lt;--"
 |      &gt;&gt;&gt; tknzr.tokenize(s0)
 |      ['This', 'is', 'a', 'cooool', '#dummysmiley', ':', ':-)', ':-P', '&lt;3', 'and', 'some', 'arrows', '&lt;', '&gt;', '-&gt;', '&lt;--']
 |  
 |  Examples using `strip_handles` and `reduce_len parameters`:
 |  
 |      &gt;&gt;&gt; tknzr = TweetTokenizer(strip_handles=True, reduce_len=True)
 |      &gt;&gt;&gt; s1 = '@remy: This is waaaaayyyy too much for you!!!!!!'
 |      &gt;&gt;&gt; tknzr.tokenize(s1)
 |      [':', 'This', 'is', 'waaayyy', 'too', 'much', 'for', 'you', '!', '!', '!']
 |  
 |  Methods defined here:
 |  
 |  __init__(self, preserve_case=True, reduce_len=False, strip_handles=False)
 |      Initialize self.  See help(type(self)) for accurate signature.
 |  
 |  tokenize(self, text)
 |      :param text: str
 |      :rtype: list(str)
 |      :return: a tokenized list of strings; concatenating this list returns        the original string if `preserve_case=False`
 |  
 |  ----------------------------------------------------------------------
 |  Data descriptors defined here:
 |  
 |  __dict__
 |      dictionary for instance variables (if defined)
 |  
 |  __weakref__
 |      list of weak references to the object (if defined)

None
</pre>
<div class="highlight">
<pre><span></span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">TweetTokenizer</span><span class="p">(</span>
    <span class="n">preserve_case</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">strip_handles</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">reduce_len</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>As I mentioned, <code>preserve_case</code> lower-cases the letters. The other two arguments are <code>strip_handles</code> which removes the twitter-handles and <code>reduce_len</code> which limits the number of times a character can be repeated to three - so <code>zzzzz</code> will be changed to <code>zzz</code>. Now we can tokenize our partly cleaned token.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) sunflowers favourites happy Friday off… 
['my', 'beautiful', 'sunflowers', 'on', 'a', 'sunny', 'friday', 'morning', 'off', ':)', 'sunflowers', 'favourites', 'happy', 'friday', 'off', '…']
</pre></div>
</div>
<div class="outline-4" id="outline-container-org0319377">
<h4 id="org0319377">Remove Stop Words and Punctuation</h4>
<div class="outline-text-4" id="text-org0319377">
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">english_stopwords</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>
</pre></div>
<pre class="example">
['i', 'me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you', "you're", "you've", "you'll", "you'd", 'your', 'yours', 'yourself', 'yourselves', 'he', 'him', 'his', 'himself', 'she', "she's", 'her', 'hers', 'herself', 'it', "it's", 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves', 'what', 'which', 'who', 'whom', 'this', 'that', "that'll", 'these', 'those', 'am', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing', 'a', 'an', 'the', 'and', 'but', 'if', 'or', 'because', 'as', 'until', 'while', 'of', 'at', 'by', 'for', 'with', 'about', 'against', 'between', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'to', 'from', 'up', 'down', 'in', 'out', 'on', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when', 'where', 'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 's', 't', 'can', 'will', 'just', 'don', "don't", 'should', "should've", 'now', 'd', 'll', 'm', 'o', 're', 've', 'y', 'ain', 'aren', "aren't", 'couldn', "couldn't", 'didn', "didn't", 'doesn', "doesn't", 'hadn', "hadn't", 'hasn', "hasn't", 'haven', "haven't", 'isn', "isn't", 'ma', 'mightn', "mightn't", 'mustn', "mustn't", 'needn', "needn't", 'shan', "shan't", 'shouldn', "shouldn't", 'wasn', "wasn't", 'weren', "weren't", 'won', "won't", 'wouldn', "wouldn't"]
!"#$%&amp;'()*+,-./:;&lt;=&gt;?@[\]^_`{|}~
</pre>
<p>Not as many stopwords as I would have thought.</p>
<div class="highlight">
<pre><span></span><span class="n">cleaned</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">english_stopwords</span> <span class="ow">and</span>
                                       <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)]</span>
<span class="k">print</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
</pre></div>
<pre class="example">
['beautiful', 'sunflowers', 'sunny', 'friday', 'morning', ':)', 'sunflowers', 'favourites', 'happy', 'friday', '…']
</pre></div>
</div>
<div class="outline-4" id="outline-container-org5230cfc">
<h4 id="org5230cfc">Stemming</h4>
<div class="outline-text-4" id="text-org5230cfc">
<p>We're going to use the <a href="https://www.nltk.org/_modules/nltk/stem/porter.html">Porter Stemmer</a> from NLTK to stem the words (<a href="https://tartarus.org/martin/PorterStemmer/">this</a> is the official Porter Stemmer algorithm page).</p>
<div class="highlight">
<pre><span></span><span class="n">stemmer</span> <span class="o">=</span> <span class="n">PorterStemmer</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">stemmed</span> <span class="o">=</span> <span class="p">[</span><span class="n">stemmer</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">cleaned</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">stemmed</span><span class="p">)</span>
</pre></div>
<pre class="example">
['beauti', 'sunflow', 'sunni', 'friday', 'morn', ':)', 'sunflow', 'favourit', 'happi', 'friday', '…']
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org8d2bb43">
<h2 id="org8d2bb43">End</h2>
<div class="outline-text-2" id="text-org8d2bb43">
<p>So now we've seen the basic steps that we're going to need to preprocess our tweets for <a href="https://www.wikiwand.com/en/Sentiment_analysis">Sentiment Analysis</a>.</p>
<p>Things to check out:</p>
<ul class="org-ul">
<li>The book <a href="https://www-nlp.stanford.edu/IR-book/">Introduction to Information Retrieval</a> by Christopher D. Manning, Prabhakar Raghavan, and Hinrich Schütze has some useful information about tokenizing, stop words, and stemming, among other things (and is available to read online).</li>
<li><a href="https://github.com/s/preprocessor">preprocessor</a> - (called <a href="https://pypi.org/project/tweet-preprocessor/">tweet-preprocessor</a> on pypi) has some of this baked in. The hashtag cleaning removes the word and the pound sign and it doesn't use the NLTK twitter tokenizer but looks like it might be useful (unfortunately not everything is documented so you have to look at the code to figure some things out).</li>
</ul>
<p>Finally I'm going to re-write what we did as a class to re-use it later as well as save the testing and training data.</p>
</div>
<div class="outline-3" id="outline-container-orgbfcc4ec">
<h3 id="orgbfcc4ec">Tests</h3>
<div class="outline-text-3" id="text-orgbfcc4ec">
<p>I'm going to use <a href="https://github.com/pytest-dev/pytest-bdd">pytest-bdd</a> to run the tests for the pre-processor but I'm also going to take advantage of org-babel and keep the scenario definitions and the test functions grouped by what they do, even though they will exist in two different files (<code>tweet_preprocessing.feature</code> and <code>test_preprocessing.py</code>) when tangled out of this file.</p>
</div>
<div class="outline-4" id="outline-container-org4f65335">
<h4 id="org4f65335">The Tangles</h4>
<div class="outline-text-4" id="text-org4f65335">
<div class="highlight">
<pre><span></span>Feature: Tweet pre-processor

&lt;&lt;stock-processing&gt;&gt;

&lt;&lt;re-tweet-processing&gt;&gt;

&lt;&lt;hyperlink-processing&gt;&gt;

&lt;&lt;hash-processing&gt;&gt;

&lt;&lt;tokenization-preprocessing&gt;&gt;

&lt;&lt;stop-word-preprocessing&gt;&gt;

&lt;&lt;stem-preprocessing&gt;&gt;

&lt;&lt;whole-shebang-preprocessing&gt;&gt;
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># software under test</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>

<span class="k">class</span> <span class="nc">Katamari</span><span class="p">:</span>
    <span class="sd">"""Something to stick values into"""</span>

<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">katamari</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Katamari</span><span class="p">()</span>


<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">processor</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">contain_exactly</span><span class="p">,</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">given</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">,</span>
    <span class="n">then</span><span class="p">,</span>
    <span class="n">when</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">And</span> <span class="o">=</span> <span class="n">when</span>


<span class="c1"># fixtures</span>
<span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span>

<span class="n">scenarios</span><span class="p">(</span><span class="s2">"../../features/twitter/tweet_preprocessing.feature"</span><span class="p">)</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">stock</span><span class="o">-</span><span class="n">symbol</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">re</span><span class="o">-</span><span class="n">tweet</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">hyperlinks</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">hashtags</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">tokenization</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">unstopping</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">stem</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">call</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>Now on to the sections that go into the tangles.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org28ab06d">
<h4 id="org28ab06d">Stock Symbols</h4>
<div class="outline-text-4" id="text-org28ab06d">
<p>Twitter has a special symbol for stocks which is a dollar sign followed by the stock ticker name (e.g. <code>$HOG</code> for Harley Davidson) that I'll remove. This is going to assume anything with a dollar sign immediately followed by a letter, number, or underscore is a stock symbol.</p>
<div class="highlight">
<pre><span></span>Scenario: A tweet with a stock symbol is cleaned
  Given a tweet with a stock symbol in it
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1">#Scenario: A tweet with a stock symbol is cleaned</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet with a stock symbol in it"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_stock_symbol</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">(),</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="s2">"{head} ${symbol} "</span>
                         <span class="n">f</span><span class="s2">"{tail}"</span><span class="p">)</span>

    <span class="c1"># the cleaner ignores spaces so there's going to be two spaces between</span>
    <span class="c1"># the head and tail after the symbol is removed</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"{head}  {tail}"</span>
    <span class="k">return</span>

<span class="c1">#   When the tweet is cleaned</span>
<span class="c1">#   Then it has the text removed</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6a5b861">
<h4 id="org6a5b861">The Re-tweets</h4>
<div class="outline-text-4" id="text-org6a5b861">
<p>This tests that we can remove the RT tag.</p>
<div class="highlight">
<pre><span></span>Scenario: A re-tweet is cleaned.

  Given a tweet that has been re-tweeted
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: A re-tweet is cleaned.</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet that has been re-tweeted"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_re_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">spaces</span> <span class="o">=</span> <span class="s2">" "</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"RT{spaces}{katamari.expected}"</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the tweet is cleaned"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it has the text removed"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_cleaned_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6cc2d1f">
<h4 id="org6cc2d1f">Hyperlinks</h4>
<div class="outline-text-4" id="text-org6cc2d1f">
<p>Now test that we can remove hyperlinks.</p>
<div class="highlight">
<pre><span></span>Scenario: The tweet has a hyperlink
  Given a tweet with a hyperlink
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The tweet has a hyperlink</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet with a hyperlink"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_hyperlink</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s2">" :)"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">faker</span><span class="o">.</span><span class="n">uri</span><span class="p">()</span> <span class="o">+</span> <span class="s2">" :)"</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org07ec745">
<h4 id="org07ec745">Hash Symbols</h4>
<div class="outline-text-4" id="text-org07ec745">
<p>Test that we can remove the pound symbol.</p>
<div class="highlight">
<pre><span></span>Scenario: A tweet has hash symbols in it.
  Given a tweet with hash symbols
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet with hash symbols"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_hash_symbols</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">expected_tokens</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">word</span><span class="p">()</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span><span class="s2">"#{word}"</span><span class="p">]</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
        <span class="n">expected_tokens</span> <span class="o">=</span> <span class="n">expected_tokens</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+</span> <span class="n">expected_tokens</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expected_tokens</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4e8e37b">
<h4 id="org4e8e37b">Tokenization</h4>
<div class="outline-text-4" id="text-org4e8e37b">
<p>This is being done by NLTK, so it might not really make sense to test it, but I figured adding a test would make it more likely that I'd slow down enough to understand what it's doing.</p>
<div class="highlight">
<pre><span></span>Scenario: The text is tokenized
  Given a string of text
  When the text is tokenized
  Then it is the expected list of strings
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The text is tokenized</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a string of text"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">"Time flies like an Arrow, fruit flies like a BANANAAAA!"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"time flies like an arrow , "</span>
                         <span class="s2">"fruit flies like a bananaaa !"</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the text is tokenized"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it is the expected list of strings"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_tokens</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdcc8dc4">
<h4 id="orgdcc8dc4">Stop Word Removal</h4>
<div class="outline-text-4" id="text-orgdcc8dc4">
<p>Check that we're removing stop-words and punctuation.</p>
<div class="highlight">
<pre><span></span>Scenario: The user removes stop words and punctuation
  Given a tokenized string
  When the string is un-stopped
  Then it is the expected list of strings
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1">#Scenario: The user removes stop words and punctuation</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tokenized string"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_tokenized_string</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"now is the winter of our discontent , "</span>
                       <span class="s2">"made glorious summer by this son of york ;"</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"winter discontent made glorious "</span>
                         <span class="s2">"summer son york"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the string is un-stopped"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">un_stop</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">remove_useless_tokens</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span>
<span class="c1">#  Then it is the expected list of strings</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0094d2c">
<h4 id="org0094d2c">Stemming</h4>
<div class="outline-text-4" id="text-org0094d2c">
<p>This is kind of a fake test. I guessed incorrectly what the stemming would do the first time so I had to go back and match the test values to what it output. I don't think I'll take the time to learn how the stemming is working, though, so it'll have to do.</p>
<div class="highlight">
<pre><span></span>Scenario: The user stems the tokens
  Given a tokenized string
  When the string is un-stopped
  And tokens are stemmed
  Then it is the expected list of strings
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user stems the tokens</span>
<span class="c1">#  Given a tokenized string</span>
<span class="c1">#  When the string is un-stopped</span>


<span class="nd">@And</span><span class="p">(</span><span class="s2">"tokens are stemmed"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stem_tokens</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="s2">"winter discont made gloriou summer son york"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span>


<span class="c1">#  Then it is the expected list of strings</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6c9ed67">
<h4 id="org6c9ed67">The Whole Shebang</h4>
<div class="outline-text-4" id="text-org6c9ed67">
<p>I made some of the steps separate just for illustration and testing, but I'll make the processor callable so they don't have to be done separately.</p>
<div class="highlight">
<pre><span></span>Scenario: The user calls the processor
  Given a tweet
  When the processor is called with the tweet
  Then it returns the cleaned, tokenized, and stemmed list
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user calls the processor</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">words</span> <span class="o">=</span> <span class="s2">"#FollowFriday @France_Inte @PKuchly57 @Milipol_Paris for being top engaged members in my community this week :)"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweet</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"RT {katamari.words} {faker.uri()}"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">'followfriday'</span><span class="p">,</span> <span class="s1">'top'</span><span class="p">,</span> <span class="s1">'engag'</span><span class="p">,</span> <span class="s1">'member'</span><span class="p">,</span> <span class="s1">'commun'</span><span class="p">,</span> <span class="s1">'week'</span><span class="p">,</span> <span class="s1">':)'</span><span class="p">]</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the processor is called with the tweet"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it returns the cleaned, tokenized, and stemmed list"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_processed_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf41ffb6">
<h3 id="orgf41ffb6">Implementation</h3>
<div class="outline-text-3" id="text-orgf41ffb6"></div>
<div class="outline-4" id="outline-container-orga500e17">
<h4 id="orga500e17">A Regular Expression Helper</h4>
<div class="outline-text-4" id="text-orga500e17">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">WheatBran</span><span class="p">:</span>
    <span class="sd">"""This is a holder for the regular expressions"""</span>
    <span class="n">START_OF_LINE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"^"</span>
    <span class="n">END_OF_LINE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"$"</span>
    <span class="n">OPTIONAL</span> <span class="o">=</span> <span class="s2">"{}?"</span>
    <span class="n">ANYTHING</span> <span class="o">=</span> <span class="s2">"."</span>
    <span class="n">ZERO_OR_MORE</span> <span class="o">=</span> <span class="s2">"{}*"</span>
    <span class="n">ONE_OR_MORE</span> <span class="o">=</span> <span class="s2">"{}+"</span>
    <span class="n">ONE_OF_THESE</span> <span class="o">=</span> <span class="s2">"[{}]"</span>
    <span class="n">FOLLOWED_BY</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"(?={})"</span>
    <span class="n">PRECEDED_BY</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"(?&lt;={})"</span>
    <span class="n">OR</span> <span class="o">=</span> <span class="s2">"|"</span>

    <span class="n">NOT</span> <span class="o">=</span> <span class="s2">"^"</span>
    <span class="n">SPACE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\s"</span>
    <span class="n">SPACES</span> <span class="o">=</span> <span class="n">ONE_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SPACE</span><span class="p">)</span>
    <span class="n">PART_OF_A_WORD</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\w"</span>
    <span class="n">EVERYTHING_OR_NOTHING</span> <span class="o">=</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ANYTHING</span><span class="p">)</span>
    <span class="n">EVERYTHING_BUT_SPACES</span> <span class="o">=</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">ONE_OF_THESE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NOT</span> <span class="o">+</span> <span class="n">SPACE</span><span class="p">))</span>

    <span class="n">ERASE</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">FORWARD_SLASHES</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\/\/"</span>
    <span class="n">NEWLINES</span> <span class="o">=</span> <span class="n">ONE_OF_THESE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\r\n"</span><span class="p">)</span>
    <span class="c1"># a dollar is a special regular expression character meaning end of line</span>
    <span class="c1"># so escape it</span>
    <span class="n">DOLLAR_SIGN</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\$"</span>

    <span class="c1"># to remove</span>
    <span class="n">STOCK_SYMBOL</span> <span class="o">=</span> <span class="n">DOLLAR_SIGN</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PART_OF_A_WORD</span><span class="p">)</span>
    <span class="n">RE_TWEET</span> <span class="o">=</span> <span class="n">START_OF_LINE</span> <span class="o">+</span> <span class="s2">"RT"</span> <span class="o">+</span> <span class="n">SPACES</span>
    <span class="n">HYPERLINKS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"http"</span> <span class="o">+</span> <span class="n">OPTIONAL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"s"</span><span class="p">)</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="n">FORWARD_SLASHES</span>
                  <span class="o">+</span> <span class="n">EVERYTHING_BUT_SPACES</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NEWLINES</span><span class="p">))</span>
    <span class="n">HASH</span> <span class="o">=</span> <span class="s2">"#"</span>

    <span class="n">EYES</span> <span class="o">=</span> <span class="s2">":"</span>
    <span class="n">FROWN</span> <span class="o">=</span> <span class="s2">"\("</span>
    <span class="n">SMILE</span> <span class="o">=</span> <span class="s2">"\)"</span>

    <span class="n">SPACEY_EMOTICON</span> <span class="o">=</span> <span class="p">(</span><span class="n">FOLLOWED_BY</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">START_OF_LINE</span> <span class="o">+</span> <span class="n">OR</span> <span class="o">+</span> <span class="n">PRECEDED_BY</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SPACE</span><span class="p">))</span>
                       <span class="o">+</span> <span class="n">EYES</span> <span class="o">+</span> <span class="n">SPACE</span> <span class="o">+</span> <span class="s2">"{}"</span> <span class="o">+</span>
                       <span class="n">FOLLOWED_BY</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SPACE</span> <span class="o">+</span> <span class="n">OR</span> <span class="o">+</span> <span class="n">END_OF_LINE</span><span class="p">))</span>
    <span class="n">SPACEY_FROWN</span> <span class="o">=</span> <span class="n">SPACEY_EMOTICON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FROWN</span><span class="p">)</span>
    <span class="n">SPACEY_SMILE</span> <span class="o">=</span> <span class="n">SPACEY_EMOTICON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SMILE</span><span class="p">)</span>

    <span class="n">spacey_fixed_emoticons</span> <span class="o">=</span> <span class="p">[</span><span class="s2">":("</span><span class="p">,</span> <span class="s2">":)"</span><span class="p">]</span>
    <span class="n">spacey_emoticons</span> <span class="o">=</span> <span class="p">[</span><span class="n">SPACEY_FROWN</span><span class="p">,</span> <span class="n">SPACEY_SMILE</span><span class="p">]</span>

    <span class="n">remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">STOCK_SYMBOL</span><span class="p">,</span> <span class="n">RE_TWEET</span><span class="p">,</span> <span class="n">HYPERLINKS</span><span class="p">,</span> <span class="n">HASH</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf0da416">
<h4 id="orgf0da416">The Processor</h4>
<div class="outline-text-4" id="text-orgf0da416">
<p>Here's the class-based implementation to pre-process tweets.</p>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">nltk.stem</span> <span class="kn">import</span> <span class="n">PorterStemmer</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">TweetTokenizer</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">nltk</span>

<span class="o">&lt;&lt;</span><span class="n">regular</span><span class="o">-</span><span class="n">expressions</span><span class="o">&gt;&gt;</span>


<span class="nd">@attr.s</span>
<span class="k">class</span> <span class="nc">TwitterProcessor</span><span class="p">:</span>
    <span class="sd">"""processor for tweets"""</span>
    <span class="n">_tokenizer</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">_stopwords</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">_stemmer</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">clean</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">tokenizer</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">un</span><span class="o">-</span><span class="n">stop</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">stopwords</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">stemmer</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">stem</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">call</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">emoticon</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd80677b">
<h4 id="orgd80677b">The Clean Method</h4>
<div class="outline-text-4" id="text-orgd80677b">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Removes sub-strings from the tweet</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: string tweet</span>

<span class="sd">    Returns:</span>
<span class="sd">     tweet with certain sub-strings removed</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">WheatBran</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
        <span class="n">tweet</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">WheatBran</span><span class="o">.</span><span class="n">ERASE</span><span class="p">,</span> <span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tweet</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9f9034f">
<h4 id="org9f9034f">Emoticon Fixer</h4>
<div class="outline-text-4" id="text-org9f9034f">
<p>This tries to handle emoticons with spaces in them.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">unspace_emoticons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span>  <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Tries to  remove spaces from emoticons</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: message to check</span>

<span class="sd">    Returns:</span>
<span class="sd">     tweet with things that looks like emoticons with spaces un-spaced</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">expression</span><span class="p">,</span> <span class="n">fix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">WheatBran</span><span class="o">.</span><span class="n">spacey_emoticons</span><span class="p">,</span> <span class="n">WheatBran</span><span class="o">.</span><span class="n">spacey_fixed_emoticons</span><span class="p">):</span>
        <span class="n">tweet</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">fix</span><span class="p">,</span> <span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tweet</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org893ea91">
<h4 id="org893ea91">The Tokenizer</h4>
<div class="outline-text-4" id="text-org893ea91">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TweetTokenizer</span><span class="p">:</span>
    <span class="sd">"""The NLTK Tweet Tokenizer</span>

<span class="sd">    It will:</span>
<span class="sd">     - tokenize a string</span>
<span class="sd">     - remove twitter handles</span>
<span class="sd">     - remove repeated characters after the first three</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span> <span class="o">=</span> <span class="n">TweetTokenizer</span><span class="p">(</span><span class="n">preserve_case</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                         <span class="n">strip_handles</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                         <span class="n">reduce_len</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org254cdab">
<h4 id="org254cdab">Stopwords</h4>
<div class="outline-text-4" id="text-org254cdab">
<p>This might make more sense to be done at the module level, but I'll see how it goes.</p>
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">stopwords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""NLTK English stopwords</span>

<span class="sd">    Warning:</span>
<span class="sd">     if the stopwords haven't been downloaded this also tries too download them</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopwords</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'stopwords'</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopwords</span> <span class="o">=</span>  <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s2">"english"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopwords</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgaba0084">
<h4 id="orgaba0084">Un-Stop the Tokens</h4>
<div class="outline-text-4" id="text-orgaba0084">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">remove_useless_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Remove stopwords and punctuation</span>

<span class="sd">    Args:</span>
<span class="sd">     tokens: list of strings</span>

<span class="sd">    Returns:</span>
<span class="sd">     tokens with unuseful tokens removed</span>
<span class="sd">    """</span>    
    <span class="k">return</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopwords</span> <span class="ow">and</span>
                                        <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org610a03f">
<h4 id="org610a03f">Stem the Tokens</h4>
<div class="outline-text-4" id="text-org610a03f">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">stemmer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PorterStemmer</span><span class="p">:</span>
    <span class="sd">"""Porter Stemmer for the tokens"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stemmer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stemmer</span> <span class="o">=</span> <span class="n">PorterStemmer</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stemmer</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">stem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""stem the tokens"""</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stemmer</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc3ca6d0">
<h4 id="orgc3ca6d0">Call Me</h4>
<div class="outline-text-4" id="text-orgc3ca6d0">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""does all the processing in one step</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: string to process</span>

<span class="sd">    Returns:</span>
<span class="sd">     the tweet as a pre-processed list of strings</span>
<span class="sd">    """</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unspace_emoticons</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1"># the stopwords are un-stemmed so this has to come before stemming</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_useless_tokens</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cleaned</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf91284e">
<h3 id="orgf91284e">Save Things</h3>
<div class="outline-text-3" id="text-orgf91284e">
<p>Rather than create the training and test sets over and over I'll save them as <a href="https://blog.rstudio.com/2016/03/29/feather/">feather</a> files. I tried saving them as CSVs but I think since the tweets have commas in them it messes it up (or something does anyway). I don't use the un-processed tweets later, but maybe it's a good idea to keep things around.</p>
<p>It occurred to me that I could just pickle the data-frame, but I've never used feather before so it'll give me a chance to try it out. According to that post I linked to about feather it's meant to be fast rather than stable (the format might change) so this is both overkill and impractical, but, oh, well.</p>
</div>
<div class="outline-4" id="outline-container-org24a479b">
<h4 id="org24a479b">Data</h4>
<div class="outline-text-4" id="text-org24a479b">
<p>First I'll process the tweets so I won't have to do this later.</p>
<div class="highlight">
<pre><span></span><span class="n">process</span> <span class="o">=</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
<span class="n">training_processed</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">training_processed</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">"tweet"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">x_train</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">training_processed</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
<pre class="example">
                                      tweet  label
0  off to the park to get some sunlight : )      1
                       tweet  label
0  [park, get, sunlight, :)]      1
</pre>
<p>Now to save it</p>
<div class="highlight">
<pre><span></span><span class="n">processed_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_PROCESSED"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">raw_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>

<span class="n">training_processed</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">processed_path</span><span class="p">)</span>
<span class="n">training</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">processed_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_PROCESSED"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">raw_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>

<span class="n">testing</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">tweet</span><span class="o">=</span><span class="n">x_test</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_test</span><span class="p">))</span>
<span class="n">testing_processed</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">testing_processed</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">"tweet"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">x_test</span><span class="p">]</span>

<span class="n">testing_processed</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">processed_path</span><span class="p">)</span>
<span class="n">testing</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org87670df">
<h4 id="org87670df">Pickles</h4>
<div class="outline-text-4" id="text-org87670df">
<p>I'm spreading this over several posts so I'm going to save some python objects to hold constant values that they share.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_SENTIMENT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Sentiment</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</pre></div>
<p>Next in the series: <a href="posts/nlp/twitter-word-frequencies/">Twitter Word Frequencies</a></p>
<p><b>Note:</b> This series is a re-write of an exercise taken from Coursera's <a href="https://www.deeplearning.ai/natural-language-processing-specialization/">Natural Language Processing</a> specialization. I changed some of the way it works, though, so it won't match their solution 100% (but it's close).</p>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/keras/flask-tensorflow-and-mnist/">Flask, TensorFlow, Streamlit and the MNIST Dataset</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/keras/flask-tensorflow-and-mnist/" rel="bookmark"><time class="published dt-published" datetime="2020-06-18T15:43:56-07:00" itemprop="datePublished" title="2020-06-18 15:43">2020-06-18 15:43</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#orge16295a">Beginning</a>
<ul>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org5df7dba">Set Up</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#orgb7c48ef">The Environment</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#orgb42a262">Plotting</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#orgf7193fb">The Random Seed</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org84b3f82">The Data</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org3b2c4d6">A Note On the Tangling</a></li>
</ul>
</li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#orgc3b4358">Middle</a>
<ul>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org96f5806">The Data</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org2e6e7cd">The Neural Network Model</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org6b8a3b9">The Web Page</a></li>
</ul>
</li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org7e9cbed">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orge16295a">
<h2 id="orge16295a">Beginning</h2>
<div class="outline-text-2" id="text-orge16295a">
<p>This is a re-working of Coursera's <a href="https://www.coursera.org/learn/neural-network-visualizer/home/welcome">Neural Network Vizualizer Web App With Python</a> course. What we'll do is use <a href="https://www.tensorflow.org/">tensorflow</a> to build a model to classify images of handwritten digits from the <a href="http://yann.lecun.com/exdb/mnist/">MNIST Database of Handwritten Digits</a> which tensoflow provides as one of their pre-built datasets. MNIST (according to <a href="https://www.wikiwand.com/en/MNIST_database">wikipedia</a>) stands for <i>Modified <a href="https://www.wikiwand.com/en/National_Institute_of_Standards_and_Technology">National Institute of Standards and Technology</a></i> (so we're using the Modified NIST Database).</p>
<p>Once we have the model we'll use <a href="https://palletsprojects.com/p/flask/">Flask</a> to serve up the model and <a href="https://www.streamlit.io/">Streamlit</a> to build a web page to view the results.</p>
</div>
<div class="outline-3" id="outline-container-org5df7dba">
<h3 id="org5df7dba">Set Up</h3>
<div class="outline-text-3" id="text-org5df7dba"></div>
<div class="outline-4" id="outline-container-org281f179">
<h4 id="org281f179">Parts</h4>
<div class="outline-text-4" id="text-org281f179">
<p>These are the libraries that we will use.</p>
</div>
<ul class="org-ul">
<li><a id="org5205c94"></a>Python<br>
<div class="outline-text-5" id="text-org5205c94">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</li>
<li><a id="org001d206"></a>PyPi<br>
<div class="outline-text-5" id="text-org001d206">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">HoverTool</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">tensorflow</span>
</pre></div>
</div>
</li>
<li><a id="org0567fae"></a>My Stuff<br>
<div class="outline-text-5" id="text-org0567fae">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgb7c48ef">
<h3 id="orgb7c48ef">The Environment</h3>
<div class="outline-text-3" id="text-orgb7c48ef">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">".env"</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb42a262">
<h3 id="orgb42a262">Plotting</h3>
<div class="outline-text-3" id="text-orgb42a262">
<p>There won't be a lot of plotting, but we'll use matplotlib with seaborn to look at some images to see what they look like and <a href="https://hvplot.holoviz.org/">HVplot</a> to do other visualizations.</p>
<div class="highlight">
<pre><span></span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<p>This is for the nikola posts. If you run the jupyter kernel on a remote machine there's going to be two behaviors for the plot-files. If you create the file in the code block (like I do for the HVPlot plots) then the file will show up on the remote machine. If you use the <code>:file</code> argument in the org-mode header (like I do for matplotlib) it will create the file on the machine where you're running emacs. Given this behavior it might make more sense to edit the emacs file on the remote machine so all the files are created there… next time.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"flask-tensorflow-and-mnist"</span>
<span class="n">OUTPUT</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/keras/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf7193fb">
<h3 id="orgf7193fb">The Random Seed</h3>
<div class="outline-text-3" id="text-orgf7193fb">
<p>Since I'm commenting on the outcomes I'll set the random seed to try and make things more consistent.</p>
<div class="highlight">
<pre><span></span><span class="n">tensorflow</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">2020</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org84b3f82">
<h3 id="org84b3f82">The Data</h3>
<div class="outline-text-3" id="text-org84b3f82">
<p>Like I mentioned, tensorflow includes the MNIST data set that we can grab with the <a href="https://www.tensorflow.org/api_docs/python/tf/keras/datasets/mnist/load_data">load_data</a> function. It returns two tuples of numpy arrays.</p>
<div class="highlight">
<pre><span></span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
<p>Let's see how much data we have.</p>
<div class="highlight">
<pre><span></span><span class="n">rows</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training:</span><span class="se">\t</span><span class="s2">{rows:,} images</span><span class="se">\t</span><span class="s2">image = {width} x {height}"</span><span class="p">)</span>
<span class="n">rows</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Testing:</span><span class="se">\t</span><span class="s2">{rows:,} images</span><span class="se">\t</span><span class="s2">image = {width} x {height}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training:       60,000 images   image = 28 x 28
Testing:        10,000 images   image = 28 x 28
</pre></div>
</div>
<div class="outline-3" id="outline-container-org3b2c4d6">
<h3 id="org3b2c4d6">A Note On the Tangling</h3>
<div class="outline-text-3" id="text-org3b2c4d6">
<p>I'm going to do this as a <a href="https://www.wikiwand.com/en/Literate_programming">literate programming</a> document with the tangle going into a temporary folder. I was creating the temporary folder using python but I'm running the code on a different machine from where I'm editing this document so running python executes on the remote machine but tangling out the files happens on my local machine. Maybe next time it will make more sense to edit the document on the remote machine (note to future self). Although that also introduces problems because then I'd have to run the tests headless… Every solution has a problem.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgc3b4358">
<h2 id="orgc3b4358">Middle</h2>
<div class="outline-text-2" id="text-orgc3b4358"></div>
<div class="outline-3" id="outline-container-org96f5806">
<h3 id="org96f5806">The Data</h3>
<div class="outline-text-3" id="text-org96f5806"></div>
<div class="outline-4" id="outline-container-org1b5354e">
<h4 id="org1b5354e">The Distribution</h4>
<div class="outline-text-4" id="text-org1b5354e">
<p>First, we can look at the distribution of the digits to see if they are equally represented.</p>
<div class="highlight">
<pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
          <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
          <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"index"</span><span class="p">:</span> <span class="s2">"Digit"</span><span class="p">,</span>
                           <span class="mi">0</span><span class="p">:</span> <span class="s2">"Count"</span><span class="p">}))</span>
<span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span>
    <span class="n">tooltips</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">"Digit"</span><span class="p">,</span> <span class="s2">"@Digit"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Count"</span><span class="p">,</span> <span class="s2">"@Count{0,0}"</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Digit"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Digit Counts"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"digit_distribution"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">output</span><span class="p">()</span>
</pre></div>
<object data="posts/keras/flask-tensorflow-and-mnist/digit_distribution.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>If you look at the values for the counts you can see that there is a pretty significant difference between 1 and 5.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{int(labels.iloc[1].Count - labels.iloc[5].Count):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
1,321
</pre>
<p>But we're doing this as an exercise to get a web-page up more so than build a real model so let's not worry about that for now.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgace31d3">
<h4 id="orgace31d3">Some Example Digits</h4>
<div class="outline-text-4" id="text-orgace31d3">
<p>We'll make a 4 x 4 grid of the first 16 images to see what they look like. Note that our array uses 0-based indexing but matplotlib uses 1-based indexing so we have to make sure that the reference to the cell in the subplot is one ahead of the index for the array.</p>
<div class="highlight">
<pre><span></span><span class="n">IMAGES</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">ROWS</span> <span class="o">=</span> <span class="n">COLUMNS</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IMAGES</span><span class="p">):</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">ROWS</span><span class="p">,</span> <span class="n">COLUMNS</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'binary'</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
<div class="figure">
<p><img alt="sample_digits.png" src="posts/keras/flask-tensorflow-and-mnist/sample_digits.png"></p>
</div>
<p>So the digits (at least the first 16) seem to be pretty clear.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org4231ce8">
<h4 id="org4231ce8">Normalizing the Data</h4>
<div class="outline-text-4" id="text-org4231ce8">
<p>One problem we have, though, is that images use values from 0 to 255 to indicate the brightness of a pixel, but neural networks tend to work better with values from 0 to 1, so we'l have to scale the data back. The images are also 28 x 28 squares, but we need to transform them to flat vectors. We can change the shape of the input data using the <a href="https://numpy.org/doc/1.18/reference/generated/numpy.reshape.html">numpy.reshape</a> function, which takes the original data and the shape you want to change it to. In our case we want the same number of rows that there were originally and we want to reduce the images from 2-dimensional images to 1-dimensional images which we can do by passing in the number of total number of pixels in each image as a single number instead of width and height.</p>
<p>Since we have to do this for both the training and testing data I'll make a helper function.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">"""reshapes the data and scales the values"""</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">pixels</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">pixels</span><span class="p">)</span>

    <span class="n">MAX_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">MAX_BRIGHTNESS</span>

    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">x_train</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org2e6e7cd">
<h3 id="org2e6e7cd">The Neural Network Model</h3>
<div class="outline-text-3" id="text-org2e6e7cd"></div>
<div class="outline-4" id="outline-container-orgbe5561b">
<h4 id="orgbe5561b">Build and Train It</h4>
<div class="outline-text-4" id="text-orgbe5561b">
<p>Now we'll build the model. It's going to be a simple fully-connected network with three layers (input, hidden, output). To make the visualization simpler we'll use the <a href="https://www.tensorflow.org/api_docs/python/tf/keras/activations/sigmoid">sigmoid activation</a> function.</p>
<p>Besides the shallowness of the model it's also going to be relatively simple, with only 32 nodes in the hidden layer.</p>
<p>First we'll build it as a <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Sequential">Sequential</a> (linear stack) model.</p>
<div class="highlight">
<pre><span></span><span class="n">rows</span><span class="p">,</span> <span class="n">pixels</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span>
<span class="n">HIDDEN_NODES</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">CATEGORIES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">ACTIVATION</span> <span class="o">=</span> <span class="s2">"sigmoid"</span>
<span class="n">OUTPUT_ACTIVATION</span> <span class="o">=</span> <span class="s2">"softmax"</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">HIDDEN_NODES</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="n">ACTIVATION</span><span class="p">,</span>
                                  <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">pixels</span><span class="p">,)),</span>
    <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">HIDDEN_NODES</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="n">ACTIVATION</span><span class="p">),</span>
    <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">CATEGORIES</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="n">OUTPUT_ACTIVATION</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
<p>Now we can <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Model#compile">compile</a> the model using a <a href="https://www.tensorflow.org/api_docs/python/tf/keras/losses/SparseCategoricalCrossentropy">sparse categorical cross-entropy loss function</a>, which is for the case where you have more than one category (non-binary) and the <a href="https://www.tensorflow.org/api_docs/python/tf/keras/optimizers/Adam">Adam</a> optimizer.</p>
<div class="highlight">
<pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">'sparse_categorical_crossentropy'</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="s1">'adam'</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">'accuracy'</span><span class="p">])</span>
</pre></div>
<p>And next we'll train the model by calling its <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Model#fit">fit</a> method.</p>
<div class="highlight">
<pre><span></span><span class="n">NO_OUTPUT</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">2048</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="n">NO_OUTPUT</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org73501b2">
<h4 id="org73501b2">Plot the Training History</h4>
<div class="outline-text-4" id="text-org73501b2">
<div class="highlight">
<pre><span></span><span class="n">history</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"loss"</span><span class="p">:</span> <span class="s2">"Training Loss"</span><span class="p">,</span>
        <span class="s2">"accuracy"</span><span class="p">:</span> <span class="s2">"Training Accuracy"</span><span class="p">,</span>
        <span class="s2">"val_loss"</span><span class="p">:</span> <span class="s2">"Validation Loss"</span><span class="p">,</span>
        <span class="s2">"val_accuracy"</span><span class="p">:</span> <span class="s2">"Validation Accuracy"</span><span class="p">,</span>
    <span class="p">})</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span>
    <span class="n">tooltips</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">"Metric"</span><span class="p">,</span> <span class="s2">"$name"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Epoch"</span><span class="p">,</span> <span class="s2">"$x"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Value"</span><span class="p">,</span> <span class="s2">"$y"</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">hvplot</span><span class="p">()</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Training History"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"training_history"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">output</span><span class="p">()</span>
</pre></div>
<object data="posts/keras/flask-tensorflow-and-mnist/training_history.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">lowest</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">highest</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"({column}) Min={lowest:0.2f} Max={highest: 0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
(Training Loss) Min=0.20 Max= 2.26
(Training Accuracy) Min=0.22 Max= 0.95
(Validation Loss) Min=0.21 Max= 2.14
(Validation Accuracy) Min=0.38 Max= 0.94
</pre>
<p>So our validation accuracy goes from 38 % to 94%, which isn't bad, especially when you consider what a simple model we have.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org2e37ea3">
<h4 id="org2e37ea3">Save It</h4>
<div class="outline-text-4" id="text-org2e37ea3">
<p>Now we can save the model to use in our flask application.</p>
<p><b>Note To Self:</b> Since this is being run on a remote machine, both the <code>.env</code> file and the directory to save the models refers to the remote machine, not the local machine where this file is being edited so you have to copy it to the local machine later on to use it with flask.</p>
<p>Also note that the you can't see the name since I put it in a <code>.env</code> file but it has <code>.h5</code> as the extension. According to the TensorFlow page on <a href="https://www.tensorflow.org/guide/keras/save_and_serialize">saving and loading a model</a>, H5 is the older format, they've switched to the <a href="https://www.tensorflow.org/guide/saved_model">SavedModel</a> format, you lose some information that would help you resume training, but we're not going to do that anyway, and the H5 format should be a little smaller.</p>
<p>Most of the next blob is to make sure the folder for the model exists. I put it in the environment variable mostly because I keep changing my mind as to where to put it and what to call it.</p>
<div class="highlight">
<pre><span></span><span class="n">base</span> <span class="o">=</span> <span class="s2">"flask_tensorflow_mnist"</span>
<span class="n">MODELS</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">base</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">f</span><span class="s2">"{base}_model"</span><span class="p">]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">MODELS</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
<span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="n">MODELS</span><span class="o">/</span><span class="n">MODEL_NAME</span>
<span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">MODEL_PATH</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org6b8a3b9">
<h3 id="org6b8a3b9">The Web Page</h3>
<div class="outline-text-3" id="text-org6b8a3b9"></div>
<ul class="org-ul">
<li><a id="org1b8e273"></a>Back-End (The Model Server)<br>
<ul class="org-ul">
<li><a id="org39539d0"></a>Tests<br>
<ul class="org-ul">
<li><a id="org735bba3"></a>Fixtures<br>
<div class="outline-text-7" id="text-org735bba3">
<p>These are the pytest fixtures to make it easier to create objects.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>

 <span class="c1"># from pypi</span>

 <span class="kn">import</span> <span class="nn">pytest</span>
 <span class="kn">import</span> <span class="nn">tensorflow</span>

 <span class="c1"># software under test</span>
 <span class="kn">from</span> <span class="nn">ml_server</span> <span class="kn">import</span> <span class="n">app</span>


 <span class="k">class</span> <span class="nc">Katamari</span><span class="p">:</span>
     <span class="sd">"""Something to stick things into"""</span>


 <span class="nd">@pytest.fixture</span>
 <span class="k">def</span> <span class="nf">katamari</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Katamari</span><span class="p">:</span>
     <span class="k">return</span> <span class="n">Katamari</span><span class="p">()</span>


 <span class="nd">@pytest.fixture</span>
 <span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
     <span class="sd">"""generates the flask client for testing"""</span>
     <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"TESTING"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
     <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
         <span class="k">yield</span> <span class="n">client</span>
     <span class="k">return</span>


 <span class="nd">@pytest.fixture</span>
 <span class="k">def</span> <span class="nf">mnist</span><span class="p">():</span>
     <span class="sd">"""Gets the test labels"""</span>
     <span class="n">MAX_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>
     <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
     <span class="k">return</span> <span class="n">Namespace</span><span class="p">(</span>
         <span class="n">x_test</span><span class="o">=</span><span class="n">x_test</span><span class="o">/</span><span class="n">MAX_BRIGHTNESS</span><span class="p">,</span>
         <span class="n">y_test</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span>
     <span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="orgbc7bd9f"></a>Features<br>
<div class="outline-text-7" id="text-orgbc7bd9f">
<p>These are the feature files.</p>
<div class="highlight">
<pre><span></span> Feature: A Prediction Getter

 Scenario: The root page is retrieved
   Given a connection to the flask client
   When the root page is retrieved
   Then it has the expected text

 Scenario: A prediction is retrieved
   Given the get_prediction function
   When a prediction is retrieved
   Then it has the correct tuple

 Scenario: The API end-point is retrieved
   Given a connection to the flask client
   When the API end-point is retrieved
   Then the response has the expected JSON
</pre></div>
</div>
</li>
<li><a id="org0ea1e4f"></a>The Tests<br>
<div class="outline-text-7" id="text-org0ea1e4f">
<p>These are the actual test functions.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>

 <span class="kn">import</span> <span class="nn">random</span>

 <span class="c1"># pypi</span>
 <span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">be</span><span class="p">,</span>
     <span class="n">be_true</span><span class="p">,</span>
     <span class="n">contain</span><span class="p">,</span>
     <span class="n">equal</span><span class="p">,</span>
     <span class="n">expect</span><span class="p">,</span>
 <span class="p">)</span>

 <span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">given</span><span class="p">,</span>
     <span class="n">when</span><span class="p">,</span>
     <span class="n">then</span><span class="p">,</span>
     <span class="n">scenario</span><span class="p">,</span>
     <span class="n">scenarios</span><span class="p">,</span>
 <span class="p">)</span>

 <span class="kn">import</span> <span class="nn">numpy</span>

 <span class="c1"># for testing</span>
 <span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">client</span><span class="p">,</span> <span class="n">katamari</span><span class="p">,</span> <span class="n">mnist</span>

 <span class="c1"># software under test</span>
 <span class="kn">from</span> <span class="nn">ml_server</span> <span class="kn">import</span> <span class="n">get_prediction</span><span class="p">,</span> <span class="n">PATHS</span>

 <span class="n">scenarios</span><span class="p">(</span><span class="s2">"get_predictions.feature"</span><span class="p">)</span>

 <span class="c1"># ***** Get Root Page ***** #</span>
 <span class="c1"># Scenario: The root page is retrieved</span>


 <span class="nd">@given</span><span class="p">(</span><span class="s2">"a connection to the flask client"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">setup_client</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
     <span class="c1"># this is a no-op since I made a fixture to build the client instead</span>
     <span class="k">return</span>


 <span class="nd">@when</span><span class="p">(</span><span class="s2">"the root page is retrieved"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">get_root_page</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
     <span class="n">katamari</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">))</span>
     <span class="k">return</span>

 <span class="nd">@then</span><span class="p">(</span><span class="s2">"it has the expected text"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_root_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
         <span class="n">contain</span><span class="p">(</span><span class="sa">b</span><span class="s2">"This is the Neural Network Visualizer"</span><span class="p">))</span>
     <span class="k">return</span>

 <span class="c1"># ***** get predictions ***** #</span>
 <span class="c1"># *** Call the function *** #</span>
 <span class="c1"># Scenario: A prediction is retrieved</span>

 <span class="nd">@given</span><span class="p">(</span><span class="s2">"the get_prediction function"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_get_prediction</span><span class="p">():</span>
     <span class="sd">"""Another no-op"""</span>
     <span class="k">return</span>

 <span class="nd">@when</span><span class="p">(</span><span class="s2">"a prediction is retrieved"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">call_get_prediction</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
     <span class="n">choice_mock</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
     <span class="n">katamari</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">6</span>
     <span class="n">choice_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">index</span>
     <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">"ml_server.numpy.random.choice"</span><span class="p">,</span> <span class="n">choice_mock</span><span class="p">)</span>
     <span class="n">katamari</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">get_prediction</span><span class="p">()</span>
     <span class="k">return</span>


 <span class="nd">@then</span><span class="p">(</span><span class="s2">"it has the correct tuple"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_predictions</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mnist</span><span class="p">):</span>
     <span class="c1"># Our model emits a list with one array for each layer of the model</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

     <span class="c1"># the last layer is the prediction layer</span>
     <span class="n">predictions</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

     <span class="n">predicted</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">y_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>

     <span class="c1"># now check the image</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">x_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="c1"># expect(katamari.output[1].shape).to(equal((28, 28)))</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
     <span class="k">return</span>

 <span class="c1"># *** API Call *** #</span>
 <span class="c1">#Scenario: the API end-point is retrieved</span>
 <span class="c1">#  Given a connection to the flask client</span>


 <span class="nd">@when</span><span class="p">(</span><span class="s2">"the API end-point is retrieved"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">get_predictions</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
     <span class="c1"># set up the mock so we can control which of the images it tries to predict</span>
     <span class="n">choice_mock</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>

     <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">"ml_server.numpy.random.choice"</span><span class="p">,</span> <span class="n">choice_mock</span><span class="p">)</span>

     <span class="n">katamari</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
     <span class="n">choice_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">index</span>

     <span class="n">katamari</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">api</span><span class="p">)</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">))</span>
     <span class="k">return</span>


 <span class="nd">@then</span><span class="p">(</span><span class="s2">"the response has the expected JSON"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_response</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mnist</span><span class="p">):</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_json</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
     <span class="n">data</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">json</span>
     <span class="n">layers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"prediction"</span><span class="p">]</span>

     <span class="c1"># the prediction should be the three outputs of our model</span>
     <span class="c1"># except with lists instead of numpy arrays</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
     <span class="n">prediction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

     <span class="c1"># now check that it made the expected prediction</span>
     <span class="n">predicted</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">y_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>

     <span class="c1"># and that it gave us the right image</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">x_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">"image"</span><span class="p">]),</span> <span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
     <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><a id="org5a6c537"></a>The Implementation<br>
<div class="outline-text-6" id="text-org5a6c537">
<p>This is where we tangle out a file to run a flask server that will serve up our model's predictions.</p>
<div class="highlight">
<pre><span></span> <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="n">app</span><span class="o">&gt;&gt;</span>


 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">model</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">feature</span><span class="o">-</span><span class="n">model</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">data</span><span class="o">&gt;&gt;</span>


 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">get</span><span class="o">-</span><span class="n">prediction</span><span class="o">&gt;&gt;</span>


 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">index</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">api</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">main</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>First up is our imports. Other than Flask there really isn't anything new here.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
 <span class="kn">import</span> <span class="nn">json</span>
 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">import</span> <span class="nn">random</span>
 <span class="kn">import</span> <span class="nn">string</span>

 <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

 <span class="c1"># pypi</span>
 <span class="kn">import</span> <span class="nn">numpy</span>
 <span class="kn">import</span> <span class="nn">tensorflow</span>

 <span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
 <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
</pre></div>
<p>Now we create the flask app and something to hold the paths.</p>
<div class="highlight">
<pre><span></span> <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

 <span class="n">PATHS</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
     <span class="n">root</span> <span class="o">=</span> <span class="s2">"/"</span><span class="p">,</span>
     <span class="n">api</span> <span class="o">=</span> <span class="s2">"/api"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
<p>Next we'll load the saved model. I'm going to break this up a little bit just because I wasn't clear about what was going on originally.</p>
<div class="highlight">
<pre><span></span> <span class="n">load_dotenv</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

 <span class="n">base</span> <span class="o">=</span> <span class="s2">"flask_tensorflow_mnist"</span>
 <span class="n">MODELS</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">base</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
 <span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">f</span><span class="s2">"{base}_model"</span><span class="p">]</span>
 <span class="k">assert</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
 <span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="n">MODELS</span><span class="o">/</span><span class="n">MODEL_NAME</span>
 <span class="k">assert</span> <span class="n">MODEL_PATH</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>

 <span class="n">model</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">)</span>
</pre></div>
<p>At this point we should have a re-loaded version of our trained model (minus some information as noted above because it was saved using the <code>H5</code> format). Our model has one output layer - the softmax prediction layer - which gives the probabilities that an input image is one of the ten digits, but since we want to see what each layer is doing, we'll create a new model with the output from each layer added to the outputs - so since we have three layers in the model we'll now have three outputs.</p>
<div class="highlight">
<pre><span></span> <span class="n">feature_model</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
     <span class="n">inputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
     <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">output</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">])</span>
</pre></div>
<p>Next let's load and normalize the data. We don't use the training data or the labels here.</p>
<div class="highlight">
<pre><span></span> <span class="n">MAX_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>

 <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
 <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">/</span><span class="n">MAX_BRIGHTNESS</span>
</pre></div>
<p>Now we create the function to get the prediction for an image. It also returns the image so that we can see what it was.</p>
<div class="highlight">
<pre><span></span> <span class="n">ROWS</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">,</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span>
 <span class="n">PIXELS</span> <span class="o">=</span> <span class="n">HEIGHT</span> <span class="o">*</span> <span class="n">WIDTH</span>

 <span class="k">def</span> <span class="nf">get_prediction</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
     <span class="sd">"""Gets a random image and prediction</span>

<span class="sd">     The 'prediction' isn't so much the value (e.g. it's a 5) but rather the</span>
<span class="sd">     outputs of each layer so that they can be visualised. So the first value</span>
<span class="sd">     of the tuple will be a list of arrays whose length will be the number of </span>
<span class="sd">     layers in the model. Each array will be the outputs for that layer.</span>

<span class="sd">     This always pulls the image from =x_test=.</span>

<span class="sd">     Returns:</span>
<span class="sd">      What our model predicts for a random image and the image</span>
<span class="sd">     """</span>
     <span class="n">index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ROWS</span><span class="p">)</span>
     <span class="n">image</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[</span><span class="n">index</span><span class="p">,:,:]</span>
     <span class="n">image_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">PIXELS</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">feature_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image_array</span><span class="p">),</span> <span class="n">image</span>
</pre></div>
<p>Next we create the handler for the REST calls. If you make a GET request from the root you'll get an HTML page back.</p>
<div class="highlight">
<pre><span></span> <span class="nd">@app.route</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
 <span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
     <span class="sd">"""The home page view"""</span>
     <span class="k">return</span> <span class="s2">"This is the Neural Network Visualizer (use /api for the API)"</span>
</pre></div>
<p>If you return a dict flask will automatically identify it as JSON.</p>
<div class="highlight">
<pre><span></span> <span class="nd">@app.route</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">api</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"GET"</span><span class="p">])</span>
 <span class="k">def</span> <span class="nf">api</span><span class="p">():</span>
     <span class="sd">"""the JSON view</span>

<span class="sd">     Returns:</span>
<span class="sd">       JSON with prediction layers and image</span>
<span class="sd">     """</span>
     <span class="n">predictions</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">get_prediction</span><span class="p">()</span>

     <span class="c1"># JSON needs lists, not numpy arrays</span>
     <span class="n">final_predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">prediction</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">]</span>
     <span class="k">return</span> <span class="p">{</span><span class="s2">"prediction"</span><span class="p">:</span> <span class="n">final_predictions</span><span class="p">,</span>
             <span class="s1">'image'</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
</pre></div>
<p>And now we make the "main" entry point.</p>
<div class="highlight">
<pre><span></span> <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
     <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
<p>To run this you would enter the same directory as the <code>ml_server.py</code> file and execute:</p>
<div class="highlight">
<pre><span></span> python ml_server.py
</pre></div>
<p>Or better, use the <a href="https://flask.palletsprojects.com/en/1.1.x/server/">development server</a>.</p>
<div class="highlight">
<pre><span></span>set -X FLASK_APP ml_server
set -X FLASK_ENV development

flask run
</pre></div>
<p>This will automatically re-load if you make changes to the code. The first two lines in the code block above tell flask which one of the modules has the flask-app and also that it should run in development mode. I'm using the <a href="https://fishshell.com/">Fish Shell</a>, so if you are using bash or a similar shell instead the lines would be this instead.</p>
<div class="highlight">
<pre><span></span>export FLASK_APP=ml_server
export FLASK_ENV=development

flask run
</pre></div>
</div>
</li>
</ul>
</li>
<li><a id="orgbc90288"></a>Front-End<br>
<ul class="org-ul">
<li><a id="org239ef63"></a>Tests<br>
<div class="outline-text-6" id="text-org239ef63">
<div class="highlight">
<pre><span></span>&lt;&lt;front-end-feature-title&gt;&gt;

&lt;&lt;front-end-click&gt;&gt;
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">browser</span><span class="p">():</span>
    <span class="sd">"""Creates the selenium webdriver session"""</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">browser</span>
    <span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>


<span class="n">CSSSelectors</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">main_title</span> <span class="o">=</span> <span class="s2">".main h1"</span><span class="p">,</span>
    <span class="n">main_button</span> <span class="o">=</span> <span class="s2">".main button"</span><span class="p">,</span>
    <span class="n">sidebar_title</span> <span class="o">=</span> <span class="s2">".sidebar h1"</span><span class="p">,</span>
    <span class="n">sidebar_image</span> <span class="o">=</span> <span class="s2">".sidebar-content img"</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">HomePage</span><span class="p">:</span>
    <span class="sd">"""A page-class for testing</span>

<span class="sd">    Args:</span>
<span class="sd">     address: the address of the streamlit server</span>
<span class="sd">     wait: seconds to implicitly wait for page-objects</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"http://localhost:8501"</span><span class="p">,</span>
                 <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">wait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">browser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">:</span>
        <span class="sd">"""The browser opened to the home page"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">main_title</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""The object with the main title"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
                <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">main_title</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">main_button</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""The man button"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
                <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">main_button</span>
            <span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sidebar_title</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""The sidebar title element"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
                <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">sidebar_title</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sidebar_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""This tries to get the sidebar image element</span>
<span class="sd">       """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
            <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">sidebar_image</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Finalizer that closes the browser"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>


<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">home_page</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">HomePage</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span> <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">front</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">front</span><span class="o">-</span><span class="n">text</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">front</span><span class="o">-</span><span class="n">click</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
</li>
<li><a id="org4f5be71"></a>The Features<br>
<div class="outline-text-6" id="text-org4f5be71">
<p>We can start with the imports and basic set up.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># pypi</span>
 <span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">be_true</span><span class="p">,</span>
     <span class="n">equal</span><span class="p">,</span>
     <span class="n">expect</span>
 <span class="p">)</span>

 <span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">given</span><span class="p">,</span>
     <span class="n">scenarios</span><span class="p">,</span>
     <span class="n">then</span><span class="p">,</span>
     <span class="n">when</span><span class="p">,</span>
 <span class="p">)</span>

 <span class="c1"># fixtures</span>
 <span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span>

 <span class="kn">from</span> <span class="nn">front_end_fixtures</span> <span class="kn">import</span> <span class="n">home_page</span>

 <span class="n">and_also</span> <span class="o">=</span> <span class="n">then</span>
 <span class="n">scenarios</span><span class="p">(</span><span class="s2">"front_end.feature"</span><span class="p">)</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org7d3d39c"></a>The Initial Text<br>
<div class="outline-text-7" id="text-org7d3d39c">
<div class="highlight">
<pre><span></span> Feature: The GUI web page to view the model

 Scenario: The user goes to the home page and checks it out
   Given a browser on the home page
   When the user checks out the titles and button
   Then they have the expected text
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># ***** The Text ***** #</span>
<span class="c1"># Scenario: The user goes to the home page and checks it out</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a browser on the home page"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_browser</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">home_page</span><span class="p">):</span>
    <span class="c1"># katamari.home_page = home_page</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks out the titles and button"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">home_page</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">main_title</span> <span class="o">=</span> <span class="n">home_page</span><span class="o">.</span><span class="n">main_title</span><span class="o">.</span><span class="n">text</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">button_text</span> <span class="o">=</span> <span class="n">home_page</span><span class="o">.</span><span class="n">main_button</span><span class="o">.</span><span class="n">text</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">sidebar_title</span> <span class="o">=</span> <span class="n">home_page</span><span class="o">.</span><span class="n">sidebar_title</span><span class="o">.</span><span class="n">text</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"they have the expected text"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">main_title</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="s2">"Neural Network Visualizer"</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">button_text</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="s2">"Get Random Prediction"</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">sidebar_title</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="s2">"Input Image"</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="orgd75555e"></a>Click the Button<br>
<div class="outline-text-7" id="text-orgd75555e">
<div class="highlight">
<pre><span></span>Scenario: The user gets a random prediction
  Given a browser on the home page
  When the user clicks on the button
  Then the sidebar displays the input image
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># ***** The button click ****** #</span>
<span class="c1"># Scenario: The user gets a random prediction</span>
<span class="c1">#  Given a browser on the home page</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user clicks on the button"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">click_get_image_button</span><span class="p">(</span><span class="n">home_page</span><span class="p">):</span>
    <span class="n">home_page</span><span class="o">.</span><span class="n">main_button</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"the sidebar displays the input image"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_sidebar_sections</span><span class="p">(</span><span class="n">home_page</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">home_page</span><span class="o">.</span><span class="n">sidebar_image</span><span class="o">.</span><span class="n">is_displayed</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><a id="org6c19b17"></a>Streamlit<br>
<div class="outline-text-6" id="text-org6c19b17">
<p>For the front-end we'll use Streamlit, a python library to make creating web-pages for certain types of applications more easily (I think, I'll need to check it out more later).</p>
<div class="highlight">
<pre><span></span> <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">url</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">title</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">sidebar</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">control</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>First the imports.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">import</span> <span class="nn">json</span>
 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

 <span class="c1"># pypi</span>
 <span class="kn">import</span> <span class="nn">requests</span>
 <span class="kn">import</span> <span class="nn">numpy</span>
 <span class="kn">import</span> <span class="nn">streamlit</span>
 <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">pyplot</span>

 <span class="c1"># this code</span>
 <span class="kn">from</span> <span class="nn">ml_server</span> <span class="kn">import</span> <span class="n">PATHS</span>
</pre></div>
<p>Now we'll setup the URL for our flask backend - as you can see we're expecting to run this on the <code>localhost</code> address, you'd have to change this for make it available outside the host PC.</p>
<div class="highlight">
<pre><span></span> <span class="n">URI</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="s2">"http://127.0.0.1:5000/"</span><span class="p">,</span> <span class="n">PATHS</span><span class="o">.</span><span class="n">api</span><span class="p">)</span>
</pre></div>
<p>Next we'll set the title for the page - this can be a little confusing, although it's called the title, it isn't the HTML title but rather the main heading for the page.</p>
<div class="highlight">
<pre><span></span> <span class="n">streamlit</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Neural Network Visualizer'</span><span class="p">)</span>
</pre></div>
<p>Now we'll add a collapsible sidebar where we'll eventually put our image output and add a headline for it (<code>Input Image</code>).</p>
<div class="highlight">
<pre><span></span> <span class="n">streamlit</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s1">'# Input Image'</span><span class="p">)</span>
</pre></div>
<p>Now we'll add some logic. I think this would be the <code>control</code> portion of a more traditional web-server. It's basically where we react to a button press by getting a random image and visualizing how it makes a prediction.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># create a button and wait for someone to press it</span>
 <span class="k">if</span> <span class="n">streamlit</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">"Get Random Prediction"</span><span class="p">):</span>
     <span class="c1"># Someone pressed the button, make an API call to our flask server</span>
     <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URI</span><span class="p">)</span>

     <span class="c1"># convert the response to a dict</span>
     <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

     <span class="c1"># get the prediction array</span>
     <span class="n">predictions</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'prediction'</span><span class="p">)</span>

     <span class="c1"># get the image we were making the prediction for</span>
     <span class="n">image</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'image'</span><span class="p">)</span>

     <span class="c1"># the image </span>
     <span class="c1"># streamlit expects a numpy array or string-like object, not lists</span>
     <span class="n">image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

     <span class="c1"># show the image in the sidebar</span>
     <span class="n">streamlit</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

     <span class="c1"># iterate over the prediction for each layer in the model</span>
     <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
         <span class="c1"># convert the prediction list to an array</span>
         <span class="c1"># and flatten it to a vector</span>
         <span class="n">numbers</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>
         <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
         <span class="n">rows</span> <span class="o">=</span> <span class="mi">1</span>
         <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
             <span class="c1"># this is the output layer so we only want one row</span>
             <span class="c1"># and we want 10 columns (one for each digit)</span>
             <span class="n">columns</span> <span class="o">=</span> <span class="mi">10</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="c1"># this is the input or hidden layer</span>
             <span class="c1"># since our model had 32 hidden nodes it has 32 columns</span>
             <span class="c1"># the original version had 2 rows and 16 columns, but</span>
             <span class="c1"># while that looked nicer, I think it makes more sense for </span>
             <span class="c1"># there to be one layer</span>
             <span class="n">columns</span> <span class="o">=</span> <span class="mi">32</span>
         <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
             <span class="c1"># add a subplot to the figure</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">number</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
                           <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float32'</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'binary'</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
             <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                 <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
         <span class="n">streamlit</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s1">'Layer {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
         <span class="n">streamlit</span><span class="o">.</span><span class="n">pyplot</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org7e9cbed">
<h2 id="org7e9cbed">End</h2>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="next"><a href="index-10.html" rel="next">Older posts</a></li>
</ul>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']]}});
</script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script><!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script>
</body>
</html>
