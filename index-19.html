<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Studies in Deep Learning." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Neurotic Networking (old posts, page 19) | Neurotic Networking</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/index-19.html" rel="canonical">
<link href="." rel="prev" type="text/html">
<link href="index-18.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="."><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/siamese-networks-with-trax/">Siamese Networks With Trax</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/siamese-networks-with-trax/" rel="bookmark"><time class="published dt-published" datetime="2021-01-21T18:33:18-08:00" itemprop="datePublished" title="2021-01-21 18:33">2021-01-21 18:33</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/siamese-networks-with-trax/#orgee93514">Beginning</a>
<ul>
<li><a href="posts/nlp/siamese-networks-with-trax/#orgcfbe42a">Imports</a></li>
</ul>
</li>
<li><a href="posts/nlp/siamese-networks-with-trax/#orgc374e6e">Middle</a>
<ul>
<li><a href="posts/nlp/siamese-networks-with-trax/#org5678573">L2 Normalization</a></li>
<li><a href="posts/nlp/siamese-networks-with-trax/#org556b1e0">The Siamese Model</a></li>
</ul>
</li>
<li><a href="posts/nlp/siamese-networks-with-trax/#org3875eac">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgee93514">
<h2 id="orgee93514">Beginning</h2>
<div class="outline-text-2" id="text-orgee93514"></div>
<div class="outline-3" id="outline-container-orgcfbe42a">
<h3 id="orgcfbe42a">Imports</h3>
<div class="outline-text-3" id="text-orgcfbe42a">
<div class="highlight">
<pre><span></span><span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">jax.interpreters.xla</span> <span class="kn">import</span> <span class="n">_DeviceArray</span> <span class="k">as</span> <span class="n">DeviceArray</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">trax</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">fast_numpy</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgc374e6e">
<h2 id="orgc374e6e">Middle</h2>
<div class="outline-text-2" id="text-orgc374e6e"></div>
<div class="outline-3" id="outline-container-org5678573">
<h3 id="org5678573">L2 Normalization</h3>
<div class="outline-text-3" id="text-org5678573">
<p>Before building the model you will need to define a function that applies L2 normalization to a tensor. Luckily this is pretty straightforward.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeviceArray</span><span class="p">:</span>
    <span class="sd">"""L2 Normalization</span>

<span class="sd">    Args:</span>
<span class="sd">     x: the data to normalize</span>

<span class="sd">    Returns:</span>
<span class="sd">     normalized version of x</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">fast_numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fast_numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
<p>The denominator can be replaced by <code>np.linalg.norm(x, axis</code>-1, keepdims=True)= to achieve the same result.</p>
<div class="highlight">
<pre><span></span><span class="n">tensor</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'The tensor is of type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">And looks like this:</span><span class="se">\n\n</span><span class="s1"> </span><span class="si">{</span><span class="n">tensor</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example">
The tensor is of type: &lt;class 'numpy.ndarray'&gt;

And looks like this:

 [[0.68535982 0.95339335 0.00394827 0.51219226 0.81262096]
 [0.61252607 0.72175532 0.29187607 0.91777412 0.71457578]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">norm_tensor</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'The normalized tensor is of type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">norm_tensor</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">And looks like this:</span><span class="se">\n\n</span><span class="s1"> </span><span class="si">{</span><span class="n">norm_tensor</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example">
The normalized tensor is of type: &lt;class 'jax.interpreters.xla._DeviceArray'&gt;

And looks like this:

 [[0.45177674 0.6284596  0.00260263 0.33762783 0.535665  ]
 [0.40091467 0.47240815 0.1910407  0.6007077  0.46770892]]
</pre>
<p>Notice that the initial tensor was converted from a numpy array to a jax array in the process.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org556b1e0">
<h3 id="org556b1e0">The Siamese Model</h3>
<div class="outline-text-3" id="text-org556b1e0">
<p>To create a <code>Siamese</code> model you will first need to create a LSTM model using the <code>Serial</code> combinator layer and then use another combinator layer called <code>Parallel</code> to create the Siamese model. You should be familiar with the following layers:</p>
<ul class="org-ul">
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.combinators.Serial"><code>Serial</code></a> : A combinator layer that allows to stack layers serially using functioncomposition.</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Embedding"><code>Embedding</code></a> : Maps discrete tokens to vectors. It will have shape <code>(vocabulary length X dimension of output vectors)</code>. The dimension of output vectors (also called <code>d_feature</code>) is the number of elements in the word embedding.</li>
</ul>
<p>-<a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.rnn.LSTM"><code>LSTM</code></a> : The LSTM layer. It leverages another Trax layer called <a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.rnn.LSTMCell"><code>LSTMCell</code></a>. The number of units should be specified and should match the number of elements in the word embedding.</p>
<ul class="org-ul">
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Mean"><code>Mean</code></a> Computes the mean across a desired axis. Mean uses one tensor axis to form groups of values and replaces each group with the mean value of that group.</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.base.Fn"><code>Fn</code></a> Layer with no weights that applies the function f, which should be specified using a lambda syntax.</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.combinators.Parallel"><code>Parallel</code></a> It is a combinator layer (like <code>Serial</code>) that applies a list of layers in parallel to its inputs.</li>
</ul>
<p>Putting everything together the Siamese model looks like this:</p>
<div class="highlight">
<pre><span></span><span class="n">vocab_size</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">model_dimension</span> <span class="o">=</span> <span class="mi">128</span>

<span class="c1"># Define the LSTM model</span>
<span class="n">LSTM</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">d_feature</span><span class="o">=</span><span class="n">model_dimension</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">model_dimension</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Fn</span><span class="p">(</span><span class="s1">'Normalize'</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">normalize</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">)</span>

<span class="c1"># Use the Parallel combinator to create a Siamese model out of the LSTM </span>
<span class="n">Siamese</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">LSTM</span><span class="p">,</span> <span class="n">LSTM</span><span class="p">)</span>
</pre></div>
<p>Next is a helper function that prints information for every layer (sublayer within <code>Serial</code>):</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">show_layers</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">layer_prefix</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Total layers: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sublayers</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sublayers</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'========'</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">layer_prefix</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">sublayers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">'Siamese model:</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">show_layers</span><span class="p">(</span><span class="n">Siamese</span><span class="p">,</span> <span class="s1">'Parallel.sublayers'</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org889ccb7">
Siamese model:

Total layers: 2

========
Parallel.sublayers_0: Serial[
  Embedding_500_128
  LSTM_128
  Mean
  Normalize
]

========
Parallel.sublayers_1: Serial[
  Embedding_500_128
  LSTM_128
  Mean
  Normalize
]
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">'Detail of LSTM models:</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">show_layers</span><span class="p">(</span><span class="n">LSTM</span><span class="p">,</span> <span class="s1">'Serial.sublayers'</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org87fd8c6">
Detail of LSTM models:

Total layers: 4

========
Serial.sublayers_0: Embedding_500_128

========
Serial.sublayers_1: LSTM_128

========
Serial.sublayers_2: Mean

========
Serial.sublayers_3: Normalize
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org3875eac">
<h2 id="org3875eac">End</h2>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-testing-the-model/">NER: Testing the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-testing-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T15:03:18-08:00" itemprop="datePublished" title="2021-01-13 15:03">2021-01-13 15:03</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-testing-the-model/#org9f512b6">Testing New Sentences</a>
<ul>
<li><a href="posts/nlp/ner-testing-the-model/#org06156ca">Set Up the Model and Maps</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-testing-the-model/#org9f84dda">Middle</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org9f512b6">
<h2 id="org9f512b6">Testing New Sentences</h2>
<div class="outline-text-2" id="text-org9f512b6">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/">The Previous Post</a></li>
</ul>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="p">(</span><span class="n">NER</span><span class="p">,</span>
                                                   <span class="n">NERData</span><span class="p">,</span>
                                                   <span class="n">TOKEN</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-org06156ca">
<h3 id="org06156ca">Set Up the Model and Maps</h3>
<div class="outline-text-3" id="text-org06156ca">
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">NER</span><span class="p">(</span><span class="n">vocabulary_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">),</span>
            <span class="n">tag_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span><span class="o">.</span><span class="n">model</span>
<span class="n">model</span><span class="o">.</span><span class="n">init_from_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">"~/models/ner/model.pkl.gz"</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Embedding_35180_50
  LSTM_50
  Dense_18
  LogSoftmax
]
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org9f84dda">
<h2 id="org9f84dda">Middle</h2>
<div class="outline-text-2" id="text-org9f84dda">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">,</span>
            <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">unknown</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Predicts the named entities in a sentence</span>

<span class="sd">    Args:</span>
<span class="sd">     sentence: the sentence to analyze</span>
<span class="sd">     model: the NER model</span>
<span class="sd">     vocabulary: token to id map</span>
<span class="sd">     tags: tag to id map</span>
<span class="sd">     unknown: key in the vocabulary for unknown tokens</span>
<span class="sd">    """</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">vocabulary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">unknown</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
    <span class="n">batch_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)))</span>
    <span class="n">batch_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">tokens</span>
    <span class="n">sentence</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tags</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">predictions</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">sentence</span> <span class="o">=</span> <span class="s2">"Bilbo Baggins, the Shire's director of trade and manufacturing policy for the Lord Sauron, said in an interview on Sunday morning that Rumblefish was working to prepare for the possibility of a second wave of the Coronavirus in the Fall, although he said it wouldn’t necessarily come before the fall of the Empire and the rise of the corpse brigade in July"</span>

<span class="k">def</span> <span class="nf">print_predictions</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">predictions</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="o">!=</span> <span class="s1">'O'</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span>

<span class="n">print_predictions</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
</pre></div>
<pre class="example">
Lord - B-org
Sauron, - I-org
Sunday - B-tim
morning - I-tim
July - B-tim
</pre>
<div class="highlight">
<pre><span></span><span class="n">print_predictions</span><span class="p">(</span><span class="s2">"anyone lived in a pretty how town "</span>
                  <span class="s2">"(with up so floating many bells down) "</span>
                  <span class="s2">"spring summer autumn winter "</span>
                  <span class="s2">"he sang his didn't he danced his did."</span><span class="p">)</span>
</pre></div>
<pre class="example">
summer - I-tim
autumn - I-tim
</pre>
<p>Hmm, that's interesting.</p>
<div class="highlight">
<pre><span></span><span class="n">print_predictions</span><span class="p">(</span><span class="s2">"Spring Summer Autumn Winter"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Summer - B-eve
</pre>
<p>Some kind of anti-spring bias.</p>
<div class="highlight">
<pre><span></span><span class="n">print_predictions</span><span class="p">(</span><span class="s2">"Boogie booty bunny butt"</span><span class="p">)</span>
</pre></div>
<pre class="example">
booty - B-per
</pre>
<p>Well, I suppose I'd have to match the dataset to put more weird things in there.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-evaluating-the-model/">NER: Evaluating the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-evaluating-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T15:02:42-08:00" itemprop="datePublished" title="2021-01-13 15:02">2021-01-13 15:02</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-evaluating-the-model/#orgb4ddedc">Beginning</a>
<ul>
<li><a href="posts/nlp/ner-evaluating-the-model/#orgdfb686e">Imports</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/#org18d66ab">Set Up</a>
<ul>
<li><a href="posts/nlp/ner-evaluating-the-model/#orgc6199e0">Plotting</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/#org124c1e0">The Previous Code</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/ner-evaluating-the-model/#org9ed62b9">Middle</a>
<ul>
<li><a href="posts/nlp/ner-evaluating-the-model/#orga519145">A Test Input</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/#orgc0dfa1c">Plotting</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgb4ddedc">
<h2 id="orgb4ddedc">Beginning</h2>
<div class="outline-text-2" id="text-orgb4ddedc">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-training-the-model/">The Previous Post</a></li>
<li><a href="posts/nlp/ner-testing-the-model/">The Next Post</a></li>
</ul>
<p>Now we'll evaluate our model using the test set. To do this we'll need to create a mask to avoid counting the padding tokens when computing the accuracy.</p>
<ul class="org-ul">
<li><b>Step 1</b>: Calling <code>model(sentences)</code> will give us the predicted output.</li>
<li><b>Step 2</b>: The output will be the prediction with an added dimension. For each word in each sentence there will be a vector of probabilities for each tag type. For each word in each sentence we'll need to pick the maximum valued tag. This will require <a href="https://numpy.org/doc/stable/reference/generated/numpy.argmax.html"><code>np.argmax</code></a> and careful use of the <code>axis</code> argument.</li>
<li><b>Step 3</b>: Create a mask to prevent counting pad characters. It will have the same dimensions as the output.</li>
<li><b>Step 4</b>: Compute the accuracy metric by comparing the outputs against the test labels. Take the sum of that and divide by the total number of <b>unpadded</b> tokens. Use the mask value to mask the padded tokens.</li>
</ul>
</div>
<div class="outline-3" id="outline-container-orgdfb686e">
<h3 id="orgdfb686e">Imports</h3>
<div class="outline-text-3" id="text-orgdfb686e">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">trax</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DataGenerator</span><span class="p">,</span>
                                                   <span class="n">NER</span><span class="p">,</span>
                                                   <span class="n">NERData</span><span class="p">,</span>
                                                   <span class="n">TOKEN</span><span class="p">)</span>
<span class="c1"># another project</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org18d66ab">
<h3 id="org18d66ab">Set Up</h3>
<div class="outline-text-3" id="text-org18d66ab"></div>
<div class="outline-4" id="outline-container-orgc6199e0">
<h4 id="orgc6199e0">Plotting</h4>
<div class="outline-text-4" id="text-orgc6199e0">
<div class="highlight">
<pre><span></span><span class="n">slug</span> <span class="o">=</span> <span class="s2">"ner-evaluating-the-model"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">slug</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Plot"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"width"</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">,</span> <span class="s2">"fontscale"</span><span class="p">,</span> <span class="s2">"tan"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">])</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org124c1e0">
<h4 id="org124c1e0">The Previous Code</h4>
<div class="outline-text-4" id="text-org124c1e0">
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">NER</span><span class="p">(</span><span class="n">vocabulary_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">),</span>
            <span class="n">tag_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span><span class="o">.</span><span class="n">model</span>

<span class="n">Settings</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Settings"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"batch_size"</span><span class="p">,</span> <span class="s2">"padding_id"</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">])</span>
<span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                    <span class="n">padding_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">],</span>
                    <span class="n">seed</span><span class="o">=</span><span class="mi">33</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">init_from_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">"~/models/ner/model.pkl.gz"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

<span class="n">test_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_test</span><span class="p">,</span>
                                   <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span>
                                   <span class="n">batch_size</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">padding_id</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Embedding_35180_50
  LSTM_50
  Dense_18
  LogSoftmax
]
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org9ed62b9">
<h2 id="org9ed62b9">Middle</h2>
<div class="outline-text-2" id="text-org9ed62b9">
<p>As a reminder, here's what happens when you apply a boolean comparison to a numpy array.</p>
<div class="highlight">
<pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
<pre class="example">
[False  True False False]
</pre></div>
<div class="outline-3" id="outline-container-orga519145">
<h3 id="orga519145">A Test Input</h3>
<div class="outline-text-3" id="text-orga519145">
<div class="highlight">
<pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">test_generator</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"x's shape: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> y's shape: </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">predictions</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"predictions has shape: </span><span class="si">{</span><span class="n">predictions</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
x's shape: (64, 44) y's shape: (64, 44)
&lt;class 'jax.interpreters.xla._DeviceArray'&gt;
predictions has shape: (64, 44, 18)
</pre>
<p><b>Note:</b> the model's prediction has 3 axes:</p>
<ul class="org-ul">
<li>the number of examples</li>
<li>the number of words in each example (padded to be as long as the longest sentence in the batch)</li>
<li>the number of possible targets (the 17 named entity tags).</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">evaluate_prediction</span><span class="p">(</span><span class="n">pred</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">interpreters</span><span class="o">.</span><span class="n">xla</span><span class="o">.</span><span class="n">_DeviceArray</span><span class="p">,</span>
                        <span class="n">labels</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                        <span class="n">pad</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">padding_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Calculates the accuracy of a prediction</span>

<span class="sd">    Args:</span>
<span class="sd">      pred: prediction array with shape </span>
<span class="sd">           (num examples, max sentence length in batch, num of classes)</span>
<span class="sd">      labels: array of size (batch_size, seq_len)</span>
<span class="sd">      pad: integer representing pad character</span>

<span class="sd">    Returns:</span>
<span class="sd">      accuracy: fraction of correct predictions</span>
<span class="sd">    """</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="n">pad</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">outputs</span><span class="o">==</span><span class="n">labels</span><span class="p">)[</span><span class="n">mask</span><span class="p">])</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">evaluate_prediction</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"accuracy: "</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>
</pre></div>
<pre class="example">
accuracy:  0.9636752
</pre>
<p>Hmm, does pretty good.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgc0dfa1c">
<h3 id="orgc0dfa1c">Plotting</h3>
<div class="outline-text-3" id="text-orgc0dfa1c">
<p>Let's look at running more batches. It occurred to me that you could also just do the whole set at once, I don't know what's special about using the batches.</p>
<div class="highlight">
<pre><span></span><span class="n">repetitions</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span>
    <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_test</span><span class="p">)</span><span class="o">/</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
<span class="n">nexts</span> <span class="o">=</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">test_generator</span><span class="p">)</span> <span class="k">for</span> <span class="n">repetition</span> <span class="ow">in</span> <span class="n">repetitions</span><span class="p">)</span>
<span class="n">accuracies</span> <span class="o">=</span> <span class="p">[</span><span class="n">evaluate_prediction</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">nexts</span><span class="p">]</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">Accuracy</span><span class="o">=</span><span class="n">accuracies</span><span class="p">))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">"hist"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">tan</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Accuracy Distribution"</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">fontscale</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"accuracy_distribution"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/ner-evaluating-the-model/accuracy_distribution.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-training-the-model/">NER: Training the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-training-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T15:01:58-08:00" itemprop="datePublished" title="2021-01-13 15:01">2021-01-13 15:01</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-training-the-model/#orga4ad638">Training the Model</a>
<ul>
<li><a href="posts/nlp/ner-training-the-model/#orga734e62">Imports</a></li>
<li><a href="posts/nlp/ner-training-the-model/#org66a9eed">Set Up</a>
<ul>
<li><a href="posts/nlp/ner-training-the-model/#org559ff20">Plotting</a></li>
<li><a href="posts/nlp/ner-training-the-model/#org1255e2a">Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/ner-training-the-model/#orgf02fd89">Middle</a>
<ul>
<li><a href="posts/nlp/ner-training-the-model/#orgdb956da">The Data Generators</a></li>
<li><a href="posts/nlp/ner-training-the-model/#org71309f6">Training The Model</a></li>
<li><a href="posts/nlp/ner-training-the-model/#org3868712">Plotting the Metrics</a>
<ul>
<li><a href="posts/nlp/ner-training-the-model/#org85cba30">Accuracy</a></li>
<li><a href="posts/nlp/ner-training-the-model/#org2f89519">Plotting Loss</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orga4ad638">
<h2 id="orga4ad638">Training the Model</h2>
<div class="outline-text-2" id="text-orga4ad638">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-building-the-model/">The Previous Post</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/">The Next Post</a></li>
</ul>
</div>
<div class="outline-3" id="outline-container-orga734e62">
<h3 id="orga734e62">Imports</h3>
<div class="outline-text-3" id="text-orga734e62">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryFile</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">holoviews</span> <span class="kn">import</span> <span class="n">opts</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">trax.supervised</span> <span class="kn">import</span> <span class="n">training</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">trax</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DataGenerator</span><span class="p">,</span>
                                                   <span class="n">NER</span><span class="p">,</span>
                                                   <span class="n">NERData</span><span class="p">,</span>
                                                   <span class="n">TOKEN</span><span class="p">)</span>
<span class="c1"># another project</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org66a9eed">
<h3 id="org66a9eed">Set Up</h3>
<div class="outline-text-3" id="text-org66a9eed"></div>
<div class="outline-4" id="outline-container-org559ff20">
<h4 id="org559ff20">Plotting</h4>
<div class="outline-text-4" id="text-org559ff20">
<div class="highlight">
<pre><span></span><span class="n">slug</span> <span class="o">=</span> <span class="s2">"ner-training-the-model"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">slug</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Plot"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"width"</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">,</span> <span class="s2">"fontscale"</span><span class="p">,</span> <span class="s2">"tan"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">])</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1255e2a">
<h4 id="org1255e2a">Data</h4>
<div class="outline-text-4" id="text-org1255e2a">
<div class="highlight">
<pre><span></span><span class="n">ner</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span>

<span class="n">Settings</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Settings"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"seed"</span><span class="p">,</span> <span class="s2">"batch_size"</span><span class="p">,</span> <span class="s2">"embedding_size"</span><span class="p">,</span> <span class="s2">"learning_rate"</span><span class="p">])</span>
<span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">embedding_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">trainee</span> <span class="o">=</span> <span class="n">NER</span><span class="p">(</span><span class="n">vocabulary_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">),</span>
              <span class="n">tag_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

<span class="n">training_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span>
                                   <span class="n">y</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span>
                                   <span class="n">batch_size</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>

<span class="n">validation_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_validate</span><span class="p">,</span>
                                     <span class="n">y</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_validate</span><span class="p">,</span>
                                     <span class="n">batch_size</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                     <span class="n">padding</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>

<span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">speak</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf02fd89">
<h2 id="orgf02fd89">Middle</h2>
<div class="outline-text-2" id="text-orgf02fd89"></div>
<div class="outline-3" id="outline-container-orgdb956da">
<h3 id="orgdb956da">The Data Generators</h3>
<div class="outline-text-3" id="text-orgdb956da">
<p>Before we start, we need to create the data generators for training and validation data. It is important that you mask padding in the loss weights of your data, which can be done using the <code>id_to_mask</code> argument of <code>trax.supervised.inputs.add_loss_weights</code>.</p>
<div class="highlight">
<pre><span></span><span class="n">train_generator</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add_loss_weights</span><span class="p">(</span>
    <span class="n">training_generator</span><span class="p">,</span>
    <span class="n">id_to_mask</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>

<span class="n">evaluate_generator</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add_loss_weights</span><span class="p">(</span>
    <span class="n">validation_generator</span><span class="p">,</span>
    <span class="n">id_to_mask</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org71309f6">
<h3 id="org71309f6">Training The Model</h3>
<div class="outline-text-3" id="text-org71309f6">
<p>You will now write a function that takes in your model and trains it.</p>
<p>As you've seen in the previous assignments, you will first create the <a href="https://trax-ml.readthedocs.io/en/stable/trax.supervised.html#trax.supervised.training.TrainTask">TrainTask</a> and <a href="https://trax-ml.readthedocs.io/en/stable/trax.supervised.html#trax.supervised.training.EvalTask">EvalTask</a> using your data generator. Then you will use the <code>training.Loop</code> to train your model.</p>
<p><b>Instructions:</b> Implement the <code>train_model</code> program below to train the neural network above. Here is a list of things you should do:</p>
<ul class="org-ul">
<li>Create the trainer object by calling <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.Loop"><code>trax.supervised.training.Loop</code></a> and pass in the following:
<ul class="org-ul">
<li>model = NER</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.TrainTask">training task</a> that uses the train data generator defined in the cell above</li>
<li>loss_layer = <a href="https://github.com/google/trax/blob/22765bb18608d376d8cd660f9865760e4ff489cd/trax/layers/metrics.py#L71">tl.CrossEntropyLoss()</a></li>
<li>optimizer = <a href="https://github.com/google/trax/blob/03cb32995e83fc1455b0c8d1c81a14e894d0b7e3/trax/optimizers/adam.py#L23">trax.optimizers.Adam(0.01)</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.EvalTask">evaluation task</a> that uses the validation data generator defined in the cell above
<ul class="org-ul">
<li>metrics for <code>EvalTask</code>: <code>tl.CrossEntropyLoss()</code> and <code>tl.Accuracy()</code></li>
<li>in <code>EvalTask</code> set <code>n_eval_batches=10</code> for better evaluation accuracy</li>
</ul>
</li>
<li>output_dir = output_dir</li>
</ul>
</li>
</ul>
<p>You'll be using a <a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.metrics.CrossEntropyLoss">cross entropy loss</a>, with an <a href="https://trax-ml.readthedocs.io/en/latest/trax.optimizers.html#trax.optimizers.adam.Adam">Adam optimizer</a>. Please read the <a href="https://trax-ml.readthedocs.io/en/latest/trax.html">trax</a> documentation to get a full understanding. The <a href="https://github.com/google/trax">trax GitHub</a> also contains some useful information and a link to a colab notebook.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">NER</span><span class="p">:</span> <span class="n">trax</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">,</span>
                <span class="n">train_generator</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                <span class="n">eval_generator</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                <span class="n">train_steps</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">steps_per_checkpoint</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="s2">"~/models/ner/"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">:</span>
    <span class="sd">"""Train the Named Entity Recognition Model</span>
<span class="sd">    Args: </span>
<span class="sd">      NER: the model you are building</span>
<span class="sd">      train_generator: The data generator for training examples</span>
<span class="sd">      eval_generator: The data generator for validation examples,</span>
<span class="sd">      train_steps: number of training steps</span>
<span class="sd">      output_dir: folder to save your model</span>

<span class="sd">    Returns:</span>
<span class="sd">      training_loop: a trax supervised training Loop</span>
<span class="sd">    """</span>
    <span class="n">train_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">(</span>
        <span class="n">labeled_data</span><span class="o">=</span><span class="n">train_generator</span><span class="p">,</span>
        <span class="n">loss_layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">WeightedCategoryCrossEntropy</span><span class="p">(),</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">),</span>
        <span class="n">n_steps_per_checkpoint</span><span class="o">=</span><span class="n">steps_per_checkpoint</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">eval_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">(</span>
      <span class="n">labeled_data</span> <span class="o">=</span> <span class="n">eval_generator</span><span class="p">,</span>
      <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers</span><span class="o">.</span><span class="n">WeightedCategoryCrossEntropy</span><span class="p">(),</span>
                 <span class="n">layers</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">()],</span>
      <span class="n">n_eval_batches</span> <span class="o">=</span> <span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span>
    <span class="p">)</span>

    <span class="n">training_loop</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">(</span>
        <span class="n">NER</span><span class="p">,</span>
        <span class="n">train_task</span><span class="p">,</span>
        <span class="n">eval_tasks</span><span class="o">=</span><span class="p">[</span><span class="n">eval_task</span><span class="p">],</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running </span><span class="si">{</span><span class="n">train_steps</span><span class="si">}</span><span class="s2"> steps"</span><span class="p">)</span>
    <span class="n">training_loop</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">n_steps</span> <span class="o">=</span> <span class="n">train_steps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">training_loop</span>
</pre></div>
<p>For some reason they don't give you the option to turn off the print statements so I'm going to suppress all stdout.</p>
<div class="highlight">
<pre><span></span><span class="n">training_steps</span> <span class="o">=</span> <span class="mi">1500</span>
<span class="n">real_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

<span class="n">TIMER</span><span class="o">.</span><span class="n">emit</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">TIMER</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">with</span> <span class="n">TemporaryFile</span><span class="p">(</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">temp_file</span>
    <span class="n">training_loop</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">trainee</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">train_generator</span><span class="p">,</span>
                                <span class="n">evaluate_generator</span><span class="p">,</span>
                                <span class="n">steps_per_checkpoint</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">train_steps</span><span class="o">=</span><span class="n">training_steps</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">TIMER</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">real_stdout</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">TIMER</span><span class="o">.</span><span class="n">ended</span> <span class="o">-</span> <span class="n">TIMER</span><span class="o">.</span><span class="n">started</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0:03:51.538599
</pre></div>
</div>
<div class="outline-3" id="outline-container-org3868712">
<h3 id="org3868712">Plotting the Metrics</h3>
<div class="outline-text-3" id="text-org3868712"></div>
<div class="outline-4" id="outline-container-org85cba30">
<h4 id="org85cba30">Accuracy</h4>
<div class="outline-text-4" id="text-org85cba30">
<div class="highlight">
<pre><span></span><span class="n">history</span> <span class="o">=</span> <span class="n">training_loop</span><span class="o">.</span><span class="n">history</span>
<span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"eval"</span><span class="p">,</span> <span class="s2">"metrics/Accuracy"</span><span class="p">),</span>
                         <span class="n">columns</span><span class="o">=</span><span class="s2">"Batch Accuracy"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
<span class="n">vline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">maximum</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">hline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">maximum</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Batch"</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="s2">"Accuracy"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                        <span class="n">opts</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">blue</span><span class="p">))</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">*</span> <span class="n">hline</span> <span class="o">*</span> <span class="n">vline</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Evaluation Batch Accuracy"</span><span class="p">,</span>
                                   <span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"evaluation_accuracy"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/ner-training-the-model/evaluation_accuracy.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
<div class="outline-4" id="outline-container-org2f89519">
<h4 id="org2f89519">Plotting Loss</h4>
<div class="outline-text-4" id="text-org2f89519">
<div class="highlight">
<pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"eval"</span><span class="p">,</span>
                                     <span class="s2">"metrics/WeightedCategoryCrossEntropy"</span><span class="p">),</span>
                         <span class="n">columns</span><span class="o">=</span><span class="s2">"Batch Loss"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">minimum</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">Loss</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]</span>
<span class="n">vline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">minimum</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">hline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">minimum</span><span class="o">.</span><span class="n">Loss</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Batch"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Loss"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">blue</span><span class="p">))</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">*</span> <span class="n">hline</span> <span class="o">*</span> <span class="n">vline</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Evaluation Batch Cross Entropy"</span><span class="p">,</span>
                                   <span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"evaluation_cross_entropy"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/ner-training-the-model/evaluation_cross_entropy.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So it looks like I passed the best point again and am probably overfitting. I wonder if they have a callback to grab the best model like pytorch does? I'm surprised at how fast these models train.</p>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-building-the-model/">NER: Building the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-building-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T15:01:26-08:00" itemprop="datePublished" title="2021-01-13 15:01">2021-01-13 15:01</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-building-the-model/#org01dafcc">Beginning</a>
<ul>
<li><a href="posts/nlp/ner-building-the-model/#orgc54369b">Imports</a></li>
<li><a href="posts/nlp/ner-building-the-model/#org88426d8">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-building-the-model/#orgba58d01">Middle</a>
<ul>
<li><a href="posts/nlp/ner-building-the-model/#orgea0208b">Inspecting the Model</a></li>
<li><a href="posts/nlp/ner-building-the-model/#org8a25dc2">Pack It Up for Later</a>
<ul>
<li><a href="posts/nlp/ner-building-the-model/#orge40b0a9">Imports</a></li>
<li><a href="posts/nlp/ner-building-the-model/#orge01cd59">Constants</a></li>
<li><a href="posts/nlp/ner-building-the-model/#org5bff2f8">The Model</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-building-the-model/#orgd04ddcb">Sanity Check</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org01dafcc">
<h2 id="org01dafcc">Beginning</h2>
<div class="outline-text-2" id="text-org01dafcc">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-data/">The Previous Post</a></li>
<li><a href="posts/nlp/ner-training-the-model/">The Next Post</a></li>
</ul>
<p>Here we'll actually build the model.</p>
<ul class="org-ul">
<li>Feed the data into an Embedding layer, to produce more semantic entries</li>
<li>Feed it into an LSTM layer</li>
<li>Run the output through a linear layer</li>
<li>Run the result through a log softmax layer to get the predicted class for each word.</li>
</ul>
</div>
<div class="outline-3" id="outline-container-orgc54369b">
<h3 id="orgc54369b">Imports</h3>
<div class="outline-text-3" id="text-orgc54369b">
<div class="highlight">
<pre><span></span><span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">DataGenerator</span><span class="p">,</span> <span class="n">NERData</span><span class="p">,</span> <span class="n">TOKEN</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org88426d8">
<h3 id="org88426d8">Set Up</h3>
<div class="outline-text-3" id="text-org88426d8">
<div class="highlight">
<pre><span></span><span class="n">ner</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span>

<span class="n">vocab</span> <span class="o">=</span> <span class="n">vocabulary</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span>
<span class="n">tag_map</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgba58d01">
<h2 id="orgba58d01">Middle</h2>
<div class="outline-text-2" id="text-orgba58d01">
<p>These are the Trax components we'll use (the links are to the implementations on Github).</p>
<ul class="org-ul">
<li><a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/combinators.py#L26">tl.Serial</a>: Combinator that applies layers serially (by function composition).</li>
<li><a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py#L113">tl.Embedding</a>: Initializes the embedding. In this case it is the dimension of the model by the size of the vocabulary.
<ul class="org-ul">
<li><code>tl.Embedding(vocab_size, d_feature)</code>.</li>
<li><code>vocab_size</code> is the number of unique words in the given vocabulary.</li>
<li><code>d_feature</code> is the number of elements in the word embedding (some choices for a word embedding size range from 150 to 300, for example).</li>
</ul>
</li>
<li><a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/rnn.py#L87">tl.LSTM</a>:=Trax= LSTM layer of size d_model.
<ul class="org-ul">
<li><code>LSTM(n_units)</code> Builds an LSTM layer of n_cells.</li>
</ul>
</li>
<li><a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py#L28)(https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py%23L28">tl.Dense</a>: A dense layer.
<ul class="org-ul">
<li><code>tl.Dense(n_units)</code>: The parameter <code>n_units</code> is the number of units chosen for this dense layer.</li>
</ul>
</li>
<li><a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py#L242">tl.LogSoftmax</a>: Log of the output probabilities.
<ul class="org-ul">
<li>Here, you don't need to set any parameters for <code>LogSoftMax()</code>.</li>
</ul>
</li>
</ul>
<p><b>Online documentation</b></p>
<ul class="org-ul">
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#module-trax.layers.combinators">tl.Serial</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Embedding">tl.Embedding</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.rnn.LSTM">tl.LSTM</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Dense">tl.Dense</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.LogSoftmax">tl.LogSoftmax</a></li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">NER</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">35181</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="n">tag_map</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Args: </span>
<span class="sd">      vocab_size: number of words in the vocabulary</span>
<span class="sd">      d_model: the embedding size</span>

<span class="sd">    Returns:</span>
<span class="sd">       model: a trax serial model</span>
<span class="sd">    """</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">d_feature</span><span class="o">=</span><span class="n">d_model</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">d_model</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tag_map</span><span class="p">)),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgea0208b">
<h3 id="orgea0208b">Inspecting the Model</h3>
<div class="outline-text-3" id="text-orgea0208b">
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">NER</span><span class="p">()</span>
<span class="c1"># display your model</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Embedding_35181_50
  LSTM_50
  Dense_18
  LogSoftmax
]
</pre></div>
</div>
<div class="outline-3" id="outline-container-org8a25dc2">
<h3 id="org8a25dc2">Pack It Up for Later</h3>
<div class="outline-text-3" id="text-org8a25dc2"></div>
<div class="outline-4" id="outline-container-orge40b0a9">
<h4 id="orge40b0a9">Imports</h4>
<div class="outline-text-4" id="text-orge40b0a9">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="kn">import</span> <span class="nn">attr</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge01cd59">
<h4 id="orge01cd59">Constants</h4>
<div class="outline-text-4" id="text-orge01cd59">
<div class="highlight">
<pre><span></span><span class="n">Settings</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Settings"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"embeddings_size"</span><span class="p">])</span>
<span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5bff2f8">
<h4 id="org5bff2f8">The Model</h4>
<div class="outline-text-4" id="text-org5bff2f8">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NER</span><span class="p">:</span>
    <span class="sd">"""The named entity recognition model</span>

<span class="sd">    Args:</span>
<span class="sd">     vocabulary_size: number of tokens in the vocabulary</span>
<span class="sd">     tag_count: number of tags</span>
<span class="sd">     embeddings_size: the number of features in the embeddings layer</span>
<span class="sd">    """</span>
    <span class="n">vocabulary_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">tag_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">embeddings_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">embeddings_size</span>
    <span class="n">_model</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgdc5ba4a"></a>The Actual Model<br>
<div class="outline-text-5" id="text-orgdc5ba4a">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">:</span>
    <span class="sd">"""The NER model instance"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary_size</span><span class="p">,</span>
                             <span class="n">d_feature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_size</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_size</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgd04ddcb">
<h3 id="orgd04ddcb">Sanity Check</h3>
<div class="outline-text-3" id="text-orgd04ddcb">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">NER</span>

<span class="n">builder</span> <span class="o">=</span> <span class="n">NER</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="mi">666</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Embedding_122_50
  LSTM_50
  Dense_666
  LogSoftmax
]
</pre></div>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="previous"><a href="." rel="prev">Newer posts</a></li>
<li class="next"><a href="index-18.html" rel="next">Older posts</a></li>
</ul>
<!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
