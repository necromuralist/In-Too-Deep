<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Studies in Deep Learning." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Neurotic Networking (old posts, page 10) | Neurotic Networking</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/index-10.html" rel="canonical">
<link href="index-11.html" rel="prev" type="text/html">
<link href="index-9.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="."><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/01-twitter-preprocessing-with-nltk/">Twitter Preprocessing With NLTK</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/01-twitter-preprocessing-with-nltk/" rel="bookmark"><time class="published dt-published" datetime="2020-07-03T21:23:48-07:00" itemprop="datePublished" title="2020-07-03 21:23">2020-07-03 21:23</time> <span class="updated">(updated <time class="dt-updated" datetime="2020-07-24T18:23:48-07:00" itemprop="dateUpdated" title="2020-07-24 18:23">2020-07-24 18:23</time>)</span></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#org2e9319c">Beginning</a>
<ul>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#orgffef6bf">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#org65f0f3f">Middle</a>
<ul>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#orgea962b8">Explore the Data</a></li>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#orgdb2387b">Processing the Data</a></li>
</ul>
</li>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#org00d0539">End</a>
<ul>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#orgccb6e5d">Tests</a></li>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#org7386fd7">Implementation</a></li>
<li><a href="posts/nlp/01-twitter-preprocessing-with-nltk/#org642d365">Save Things</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org2e9319c">
<h2 id="org2e9319c">Beginning</h2>
<div class="outline-text-2" id="text-org2e9319c">
<p>This is the first in a series that will look at taking a group of tweets and building a <a href="https://www.wikiwand.com/en/Logistic_regression">Logistic Regression</a> model to classify tweets as being either positive or negative in their sentiment. This post is followed by:</p>
<ul class="org-ul">
<li><a href="posts/nlp/twitter-word-frequencies/">Twitter Word Frequencies</a></li>
<li><a href="posts/nlp/the-tweet-vectorizer/">The Tweet Vectorizer</a></li>
<li><a href="posts/nlp/implementing-twitter-logistic-regression/">Implementing Logistic Regression for Tweet Sentiment Analysis</a></li>
</ul>
<p>This first post is a look at taking a corpus of <a href="https://twitter.com/explore">Twitter</a> data which comes from the <a href="https://www.nltk.org/">Natural Language Toolkit's (NLTK)</a> collection of data and creating a preprocessor for a <a href="https://www.wikiwand.com/en/Sentiment_analysis">Sentiment Analysis</a> pipeline. This dataset has entries whose sentiment was categorized by hand so it's a convenient source for training models.</p>
<p>The <a href="https://www.nltk.org/howto/corpus.html">NLTK Corpus How To</a> has a brief description of the Twitter dataset and they also have <a href="https://www.nltk.org/howto/twitter.html">some documentation</a> about how to gather new data using the Twitter API yourself.</p>
</div>
<div class="outline-3" id="outline-container-orgffef6bf">
<h3 id="orgffef6bf">Set Up</h3>
<div class="outline-text-3" id="text-orgffef6bf"></div>
<div class="outline-4" id="outline-container-org28cad6e">
<h4 id="org28cad6e">Imports</h4>
<div class="outline-text-4" id="text-org28cad6e">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>
<span class="kn">from</span> <span class="nn">nltk.stem</span> <span class="kn">import</span> <span class="n">PorterStemmer</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">TweetTokenizer</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># this is created further down in the post</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">CountPercentage</span><span class="p">,</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb7c4475">
<h4 id="orgb7c4475">The Environment</h4>
<div class="outline-text-4" id="text-orgb7c4475">
<p>This is where I keep the paths to the files I save.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3abdba3">
<h4 id="org3abdba3">Data</h4>
<div class="outline-text-4" id="text-org3abdba3">
<p>The first thing to do is download the dataset using the <a href="https://www.nltk.org/data.html">download</a> function. If you don't pass an argument to it a dialog will open and you can choose to download any or all of their datasets, but for this exercise we'll just download the Twitter samples. Note that if you run this function and the samples were already downloaded then it won't re-download them so it's safe to call it in any case.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'twitter_samples'</span><span class="p">)</span>
</pre></div>
<p>The data is contained in three files. You can see the file names using the <code>twitter_samples.fileids</code> function.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">fileids</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
- negative_tweets.json
- positive_tweets.json
- tweets.20150430-223406.json
</pre>
<p>As you can see (or maybe guess) two of the files contain tweets that have been categorized as negative or positive. The third file has another 20,000 tweets that aren't classified.</p>
<p>The dataset contains the JSON for each tweet, including some metadata, which you can access through the <code>twitter_samples.docs</code> function. Here's a sample.</p>
<div class="highlight">
<pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">twitter_samples</span><span class="o">.</span><span class="n">docs</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
{'contributors': None,
 'coordinates': None,
 'created_at': 'Fri Jul 24 10:42:49 +0000 2015',
 'entities': {'hashtags': [], 'symbols': [], 'urls': [], 'user_mentions': []},
 'favorite_count': 0,
 'favorited': False,
 'geo': None,
 'id': 624530164626534400,
 'id_str': '624530164626534400',
 'in_reply_to_screen_name': None,
 'in_reply_to_status_id': None,
 'in_reply_to_status_id_str': None,
 'in_reply_to_user_id': None,
 'in_reply_to_user_id_str': None,
 'is_quote_status': False,
 'lang': 'en',
 'metadata': {'iso_language_code': 'en', 'result_type': 'recent'},
 'place': None,
 'retweet_count': 0,
 'retweeted': False,
 'source': '&lt;a href="https://mobile.twitter.com" rel="nofollow"&gt;Mobile Web '
           '(M2)&lt;/a&gt;',
 'text': 'hopeless for tmr :(',
 'truncated': False,
 'user': {'contributors_enabled': False,
          'created_at': 'Sun Mar 08 05:43:40 +0000 2015',
          'default_profile': False,
          'default_profile_image': False,
          'description': '⇨ [V] TravelGency █ 2/4 Goddest from Girls Day █ 92L '
                         '█ sucrp',
          'entities': {'description': {'urls': []}},
          'favourites_count': 196,
          'follow_request_sent': False,
          'followers_count': 1281,
          'following': False,
          'friends_count': 1264,
          'geo_enabled': True,
          'has_extended_profile': False,
          'id': 3078803375,
          'id_str': '3078803375',
          'is_translation_enabled': False,
          'is_translator': False,
          'lang': 'id',
          'listed_count': 3,
          'location': 'wearegsd;favor;pucukfams;barbx',
          'name': 'yuwra ✈ ',
          'notifications': False,
          'profile_background_color': '000000',
          'profile_background_image_url': 'http://pbs.twimg.com/profile_background_images/585476378365014016/j1mvQu3c.png',
          'profile_background_image_url_https': 'https://pbs.twimg.com/profile_background_images/585476378365014016/j1mvQu3c.png',
          'profile_background_tile': True,
          'profile_banner_url': 'https://pbs.twimg.com/profile_banners/3078803375/1433287528',
          'profile_image_url': 'http://pbs.twimg.com/profile_images/622631732399898624/kmYsX_k1_normal.jpg',
          'profile_image_url_https': 'https://pbs.twimg.com/profile_images/622631732399898624/kmYsX_k1_normal.jpg',
          'profile_link_color': '000000',
          'profile_sidebar_border_color': '000000',
          'profile_sidebar_fill_color': '000000',
          'profile_text_color': '000000',
          'profile_use_background_image': True,
          'protected': False,
          'screen_name': 'yuwraxkim',
          'statuses_count': 19710,
          'time_zone': 'Jakarta',
          'url': None,
          'utc_offset': 25200,
          'verified': False}}
</pre>
<p>There's some potentially useful data here - like if the tweet was re-tweeted, but for what we're doing we'll just use the tweet itself.</p>
<p>To get just the text of the tweets you use the <code>twitter_samples.strings</code> function.</p>
<div class="highlight">
<pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">)</span>
</pre></div>
<pre class="example">
Help on method strings in module nltk.corpus.reader.twitter:

strings(fileids=None) method of nltk.corpus.reader.twitter.TwitterCorpusReader instance
    Returns only the text content of Tweets in the file(s)
    
    :return: the given file(s) as a list of Tweets.
    :rtype: list(str)

</pre>
<p>Note that it says that it returns only the given file(s) as a list of tweets but it also makes the <code>fileids</code> argument optional. If you don't pass in any argument you end up with the tweets from all the files in the same list, which you probably don't want.</p>
<div class="highlight">
<pre><span></span><span class="n">positive</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s1">'positive_tweets.json'</span><span class="p">)</span>
<span class="n">negative</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s1">'negative_tweets.json'</span><span class="p">)</span>
<span class="n">all_tweets</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s2">"tweets.20150430-223406.json"</span><span class="p">)</span>
</pre></div>
<p>Now I'll download the stopwords for our pre-processing and setup the english stopwords for use later.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'stopwords'</span><span class="p">)</span>
<span class="n">english_stopwords</span> <span class="o">=</span> <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s2">"english"</span><span class="p">)</span>
</pre></div>
<p>Rather than working with the whole data-set I'm going to split it up here so we'll only work with the training set. First thing is to create a set of labels for the positive and negative tweets.</p>
<div class="highlight">
<pre><span></span><span class="n">Sentiment</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">positive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">negative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">decode</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">"positive"</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s2">"negative"</span>
    <span class="p">},</span>
    <span class="n">encode</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"positive"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">"negative"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">positive_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span>
<span class="n">negative_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative</span><span class="p">)</span>
</pre></div>
<p>Now I'll combine the positive and negative tweets.</p>
<div class="highlight">
<pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="n">positive_labels</span> <span class="o">+</span> <span class="n">negative_labels</span>
<span class="n">tweets</span> <span class="o">=</span> <span class="n">positive</span> <span class="o">+</span> <span class="n">negative</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Labels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tweets</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Labels: 10,000
tweets: 10,000
</pre>
<p>Now we can do the train-test splitting. The <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html">train_test_split</a> function shuffles and splits up the dataset, so combining the positive and negative sets first before the splitting seemed like a good idea.</p>
<div class="highlight">
<pre><span></span><span class="n">TRAINING_SIZE</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">SEED</span> <span class="o">=</span> <span class="mi">20200724</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">tweets</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="n">TRAINING_SIZE</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="se">\t</span><span class="s2">Testing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training: 8,000 Testing: 2,000
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgc7e463d">
<h4 id="orgc7e463d">The Random Seed</h4>
<div class="outline-text-4" id="text-orgc7e463d">
<p>This just sets the random seed so that we get the same values if we re-run this later on (although this is a little tricky with the notebook, since you can call the same code multiple times).</p>
<div class="highlight">
<pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgcae8867">
<h4 id="orgcae8867">Plotting</h4>
<div class="outline-text-4" id="text-orgcae8867">
<p>I won't be doing a lot of plotting here, but this is a setup for the little that I do.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"01-twitter-preprocessing-with-nltk"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                <span class="n">create_folder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
    <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">Cycle</span><span class="p">([</span><span class="s2">"#4687b7"</span><span class="p">,</span> <span class="s2">"#ce7b6d"</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org65f0f3f">
<h2 id="org65f0f3f">Middle</h2>
<div class="outline-text-2" id="text-org65f0f3f">
<p>It can be more convenient to use a <a href="https://pandas.pydata.org/pandas-docs/stable/reference/series.html">Pandas Series</a> for some checks of the tweets so I'll convert the all-tweets list to one.</p>
<div class="highlight">
<pre><span></span><span class="n">all_tweets</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">all_tweets</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgea962b8">
<h3 id="orgea962b8">Explore the Data</h3>
<div class="outline-text-3" id="text-orgea962b8">
<p>Let's start by looking at the number of tweets we got and confirming that the <code>strings</code> function gave us back a list of strings like the docstring said it would.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_tweets</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Number of positive tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Number of negative tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">negative</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">negative</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">thing</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">str</span>
</pre></div>
<pre class="example">
Number of tweets: 20,000
Number of positive tweets: 5,000
Number of negative tweets: 5,000
</pre>
<p>We can see that the data for each file is made up of strings stored in a list and there were 20,000 tweets in total but only half as much were categorized.</p>
</div>
<div class="outline-4" id="outline-container-org6171988">
<h4 id="org6171988">Looking At Some Examples</h4>
<div class="outline-text-4" id="text-org6171988">
<p>First, since our data sets are shuffled, I'll convert them into a pandas DataFrame to make it a little easier to get positive vs negative tweets.</p>
<div class="highlight">
<pre><span></span><span class="n">training</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">tweet</span><span class="o">=</span><span class="n">x_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_train</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Random Positive Tweet: </span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Random Negative Tweet: </span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">negative</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Random Positive Tweet: Hi.. Please say"happybirthday" to me :) thanksss :) —  http://t.co/HPXV43LK5L

Random Negative Tweet: I think I should stop getting so angry over stupid shit :(
</pre></div>
</div>
<div class="outline-4" id="outline-container-org4cf4b25">
<h4 id="org4cf4b25">The First Token</h4>
<div class="outline-text-4" id="text-org4cf4b25">
<p>Later on we're going to remove the "RT" (re-tweet) token at the start of the strings. Let's look at how significant this is.</p>
<div class="highlight">
<pre><span></span><span class="n">first_tokens</span> <span class="o">=</span> <span class="n">all_tweets</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">top_ten</span> <span class="o">=</span> <span class="n">CountPercentage</span><span class="p">(</span><span class="n">first_tokens</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">value_label</span><span class="o">=</span><span class="s2">"First Token"</span><span class="p">)</span>
<span class="n">top_ten</span><span class="p">()</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">First Token</th>
<th class="org-right" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">RT</td>
<td class="org-right">13287</td>
<td class="org-right">92.92</td>
</tr>
<tr>
<td class="org-left">I</td>
<td class="org-right">160</td>
<td class="org-right">1.12</td>
</tr>
<tr>
<td class="org-left">Farage</td>
<td class="org-right">141</td>
<td class="org-right">0.99</td>
</tr>
<tr>
<td class="org-left">The</td>
<td class="org-right">134</td>
<td class="org-right">0.94</td>
</tr>
<tr>
<td class="org-left">VIDEO:</td>
<td class="org-right">132</td>
<td class="org-right">0.92</td>
</tr>
<tr>
<td class="org-left">Nigel</td>
<td class="org-right">117</td>
<td class="org-right">0.82</td>
</tr>
<tr>
<td class="org-left">Ed</td>
<td class="org-right">116</td>
<td class="org-right">0.81</td>
</tr>
<tr>
<td class="org-left">Miliband</td>
<td class="org-right">77</td>
<td class="org-right">0.54</td>
</tr>
<tr>
<td class="org-left">SNP</td>
<td class="org-right">69</td>
<td class="org-right">0.48</td>
</tr>
<tr>
<td class="org-left">@UKIP</td>
<td class="org-right">67</td>
<td class="org-right">0.47</td>
</tr>
</tbody>
</table>
<p>That gives you some sense of how much there is, but plotting it might make it a little clearer.</p>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">top_ten</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">"Percent (%)"</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">"First Token"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Top Ten Tweet First Tokens"</span><span class="p">,</span> 
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"top_ten"</span><span class="p">,</span> <span class="n">create_folder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">())</span>
</pre></div>
<object data="posts/nlp/01-twitter-preprocessing-with-nltk/top_ten.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So, about 93 % of the unclassified tweets start with <code>RT</code>, making it perhaps not so informative a token. Or maybe it is… what does a re-tweet tell us? Let's look at if the re-tweeted show up as duplicates and if so, how many times they show up.</p>
<div class="highlight">
<pre><span></span><span class="n">retweeted</span> <span class="o">=</span> <span class="n">all_tweets</span><span class="p">[</span><span class="n">all_tweets</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"RT"</span><span class="p">)]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">retweeted</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<ul class="org-ul">
<li>491</li>
<li>430</li>
<li>131</li>
<li>131</li>
<li>117</li>
<li>103</li>
<li>82</li>
<li>73</li>
<li>69</li>
<li>68</li>
</ul>
<p>Some of the entries are the same tweet repeated hundreds of times. Does each one count as an additional entry? I don't show it here because the tweets are kind of long, but the top five are all about British politics, so there might have been some kind of bias in the way the tweets were gathered.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgdb2387b">
<h3 id="orgdb2387b">Processing the Data</h3>
<div class="outline-text-3" id="text-orgdb2387b">
<p>There are four basic steps in our NLP pre-processing:</p>
<ul class="org-ul">
<li><a href="https://nlp.stanford.edu/IR-book/html/htmledition/tokenization-1.html">Tokenization</a></li>
<li>Lower-casing</li>
<li>Removing <a href="https://www.wikiwand.com/en/Stop_words">stop words</a> and punctuation</li>
<li><a href="https://www.wikiwand.com/en/Stemming">Stemming</a></li>
</ul>
<p>Let's start by pulling up a tweet that has most of the stuff we're cleaning up.</p>
<div class="highlight">
<pre><span></span><span class="n">THE_CHOSEN</span> <span class="o">=</span> <span class="n">training</span><span class="p">[(</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"beautiful"</span><span class="p">))</span> <span class="o">&</span>
                      <span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"http"</span><span class="p">))</span> <span class="o">&</span>
                      <span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"#"</span><span class="p">))]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tweet</span>
<span class="nb">print</span><span class="p">(</span><span class="n">THE_CHOSEN</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) #sunflowers #favourites #happy #Friday off… https://t.co/3tfYom0N1i
</pre></div>
<div class="outline-4" id="outline-container-org5f46cce">
<h4 id="org5f46cce">Cleaning Up Twitter-Specific Markup</h4>
<div class="outline-text-4" id="text-org5f46cce">
<p>Although I listed four steps in the beginning, there's often another step where we remove things that are common or not useful but known in advance. In this case we want to remove re-tweet tags (<code>RT</code>), hyperlinks, and hashtags. We're going to do that with python's built in <a href="https://docs.python.org/3/library/re.html">regular expression</a> module. We're also going to do it one tweet at a time, although you could perhaps more efficiently do it in bulk using pandas.</p>
<div class="highlight">
<pre><span></span><span class="n">START_OF_LINE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"^"</span>
<span class="n">OPTIONAL</span> <span class="o">=</span> <span class="s2">"?"</span>
<span class="n">ANYTHING</span> <span class="o">=</span> <span class="s2">"."</span>
<span class="n">ZERO_OR_MORE</span> <span class="o">=</span> <span class="s2">"*"</span>
<span class="n">ONE_OR_MORE</span> <span class="o">=</span> <span class="s2">"+"</span>

<span class="n">SPACE</span> <span class="o">=</span> <span class="s2">"\s"</span>
<span class="n">SPACES</span> <span class="o">=</span> <span class="n">SPACE</span> <span class="o">+</span> <span class="n">ONE_OR_MORE</span>
<span class="n">NOT_SPACE</span> <span class="o">=</span> <span class="s2">"[^\s]"</span> <span class="o">+</span> <span class="n">ONE_OR_MORE</span>
<span class="n">EVERYTHING_OR_NOTHING</span> <span class="o">=</span> <span class="n">ANYTHING</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span>

<span class="n">ERASE</span> <span class="o">=</span> <span class="s2">""</span>
<span class="n">FORWARD_SLASH</span> <span class="o">=</span> <span class="s2">"\/"</span>
<span class="n">NEWLINES</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"[\r\n]"</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org81c085c"></a>Re-Tweets<br>
<div class="outline-text-5" id="text-org81c085c">
<p>None of the positive or negative samples have this tag so I'm going to pull an example from the complete set just to show it working.</p>
<div class="highlight">
<pre><span></span><span class="n">RE_TWEET</span> <span class="o">=</span> <span class="n">START_OF_LINE</span> <span class="o">+</span> <span class="s2">"RT"</span> <span class="o">+</span> <span class="n">SPACES</span>

<span class="n">tweet</span> <span class="o">=</span> <span class="n">all_tweets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
<span class="n">tweet</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">RE_TWEET</span><span class="p">,</span> <span class="n">ERASE</span><span class="p">,</span> <span class="n">tweet</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
</pre></div>
<pre class="example">
RT @KirkKus: Indirect cost of the UK being in the EU is estimated to be costing Britain £170 billion per year! #BetterOffOut #UKIP
@KirkKus: Indirect cost of the UK being in the EU is estimated to be costing Britain £170 billion per year! #BetterOffOut #UKIP
</pre></div>
</li>
<li><a id="org13bf97b"></a>Hyperlinks<br>
<div class="outline-text-5" id="text-org13bf97b">
<div class="highlight">
<pre><span></span><span class="n">HYPERLINKS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"http"</span> <span class="o">+</span> <span class="s2">"s"</span> <span class="o">+</span> <span class="n">OPTIONAL</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="n">FORWARD_SLASH</span> <span class="o">+</span> <span class="n">FORWARD_SLASH</span>
              <span class="o">+</span> <span class="n">NOT_SPACE</span> <span class="o">+</span> <span class="n">NEWLINES</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">THE_CHOSEN</span><span class="p">)</span>
<span class="n">re_chosen</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">HYPERLINKS</span><span class="p">,</span> <span class="n">ERASE</span><span class="p">,</span> <span class="n">THE_CHOSEN</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) #sunflowers #favourites #happy #Friday off… https://t.co/3tfYom0N1i
My beautiful sunflowers on a sunny Friday morning off :) #sunflowers #favourites #happy #Friday off… 
</pre></div>
</li>
<li><a id="orgac86ebc"></a>HashTags<br>
<div class="outline-text-5" id="text-orgac86ebc">
<p>We aren't removing the actual hash-tags, just the hash-marks (<code>#</code>).</p>
<div class="highlight">
<pre><span></span><span class="n">HASH</span> <span class="o">=</span> <span class="s2">"#"</span>
<span class="n">re_chosen</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">HASH</span><span class="p">,</span> <span class="n">ERASE</span><span class="p">,</span> <span class="n">re_chosen</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) sunflowers favourites happy Friday off… 
</pre></div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org08a286f">
<h4 id="org08a286f">Tokenize</h4>
<div class="outline-text-4" id="text-org08a286f">
<p>NLTK has a tokenizer specially built for tweets. The <code>twitter_samples</code> module actually has a <code>tokenizer</code> function that breaks the tweets up, but since we are using regular expressions to clean up the strings a little first, it makes more sense to tokenize the strings afterwards. Also note that one of the steps in the pipeline is to lower-case the letters, which the <code>TweetTokenizer</code> will do for us if we set the <code>preserve_case</code> argument to <code>False</code>.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">help</span><span class="p">(</span><span class="n">TweetTokenizer</span><span class="p">))</span>
</pre></div>
<pre class="example">
Help on class TweetTokenizer in module nltk.tokenize.casual:

class TweetTokenizer(builtins.object)
 |  TweetTokenizer(preserve_case=True, reduce_len=False, strip_handles=False)
 |  
 |  Tokenizer for tweets.
 |  
 |      &gt;&gt;&gt; from nltk.tokenize import TweetTokenizer
 |      &gt;&gt;&gt; tknzr = TweetTokenizer()
 |      &gt;&gt;&gt; s0 = "This is a cooool #dummysmiley: :-) :-P &lt;3 and some arrows &lt; &gt; -&gt; &lt;--"
 |      &gt;&gt;&gt; tknzr.tokenize(s0)
 |      ['This', 'is', 'a', 'cooool', '#dummysmiley', ':', ':-)', ':-P', '&lt;3', 'and', 'some', 'arrows', '&lt;', '&gt;', '-&gt;', '&lt;--']
 |  
 |  Examples using `strip_handles` and `reduce_len parameters`:
 |  
 |      &gt;&gt;&gt; tknzr = TweetTokenizer(strip_handles=True, reduce_len=True)
 |      &gt;&gt;&gt; s1 = '@remy: This is waaaaayyyy too much for you!!!!!!'
 |      &gt;&gt;&gt; tknzr.tokenize(s1)
 |      [':', 'This', 'is', 'waaayyy', 'too', 'much', 'for', 'you', '!', '!', '!']
 |  
 |  Methods defined here:
 |  
 |  __init__(self, preserve_case=True, reduce_len=False, strip_handles=False)
 |      Initialize self.  See help(type(self)) for accurate signature.
 |  
 |  tokenize(self, text)
 |      :param text: str
 |      :rtype: list(str)
 |      :return: a tokenized list of strings; concatenating this list returns        the original string if `preserve_case=False`
 |  
 |  ----------------------------------------------------------------------
 |  Data descriptors defined here:
 |  
 |  __dict__
 |      dictionary for instance variables (if defined)
 |  
 |  __weakref__
 |      list of weak references to the object (if defined)

None
</pre>
<div class="highlight">
<pre><span></span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">TweetTokenizer</span><span class="p">(</span>
    <span class="n">preserve_case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">strip_handles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">reduce_len</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>As I mentioned, <code>preserve_case</code> lower-cases the letters. The other two arguments are <code>strip_handles</code> which removes the twitter-handles and <code>reduce_len</code> which limits the number of times a character can be repeated to three - so <code>zzzzz</code> will be changed to <code>zzz</code>. Now we can tokenize our partly cleaned token.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">re_chosen</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</pre></div>
<pre class="example">
My beautiful sunflowers on a sunny Friday morning off :) sunflowers favourites happy Friday off… 
['my', 'beautiful', 'sunflowers', 'on', 'a', 'sunny', 'friday', 'morning', 'off', ':)', 'sunflowers', 'favourites', 'happy', 'friday', 'off', '…']
</pre></div>
</div>
<div class="outline-4" id="outline-container-org86dcb16">
<h4 id="org86dcb16">Remove Stop Words and Punctuation</h4>
<div class="outline-text-4" id="text-org86dcb16">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">english_stopwords</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>
</pre></div>
<pre class="example">
['i', 'me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you', "you're", "you've", "you'll", "you'd", 'your', 'yours', 'yourself', 'yourselves', 'he', 'him', 'his', 'himself', 'she', "she's", 'her', 'hers', 'herself', 'it', "it's", 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves', 'what', 'which', 'who', 'whom', 'this', 'that', "that'll", 'these', 'those', 'am', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing', 'a', 'an', 'the', 'and', 'but', 'if', 'or', 'because', 'as', 'until', 'while', 'of', 'at', 'by', 'for', 'with', 'about', 'against', 'between', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'to', 'from', 'up', 'down', 'in', 'out', 'on', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when', 'where', 'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 's', 't', 'can', 'will', 'just', 'don', "don't", 'should', "should've", 'now', 'd', 'll', 'm', 'o', 're', 've', 'y', 'ain', 'aren', "aren't", 'couldn', "couldn't", 'didn', "didn't", 'doesn', "doesn't", 'hadn', "hadn't", 'hasn', "hasn't", 'haven', "haven't", 'isn', "isn't", 'ma', 'mightn', "mightn't", 'mustn', "mustn't", 'needn', "needn't", 'shan', "shan't", 'shouldn', "shouldn't", 'wasn', "wasn't", 'weren', "weren't", 'won', "won't", 'wouldn', "wouldn't"]
!"#$%&amp;'()*+,-./:;&lt;=&gt;?@[\]^_`{|}~
</pre>
<p>Not as many stopwords as I would have thought.</p>
<div class="highlight">
<pre><span></span><span class="n">cleaned</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">english_stopwords</span> <span class="ow">and</span>
                                       <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
</pre></div>
<pre class="example">
['beautiful', 'sunflowers', 'sunny', 'friday', 'morning', ':)', 'sunflowers', 'favourites', 'happy', 'friday', '…']
</pre></div>
</div>
<div class="outline-4" id="outline-container-org09f6b1b">
<h4 id="org09f6b1b">Stemming</h4>
<div class="outline-text-4" id="text-org09f6b1b">
<p>We're going to use the <a href="https://www.nltk.org/_modules/nltk/stem/porter.html">Porter Stemmer</a> from NLTK to stem the words (<a href="https://tartarus.org/martin/PorterStemmer/">this</a> is the official Porter Stemmer algorithm page).</p>
<div class="highlight">
<pre><span></span><span class="n">stemmer</span> <span class="o">=</span> <span class="n">PorterStemmer</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">stemmed</span> <span class="o">=</span> <span class="p">[</span><span class="n">stemmer</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">cleaned</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stemmed</span><span class="p">)</span>
</pre></div>
<pre class="example">
['beauti', 'sunflow', 'sunni', 'friday', 'morn', ':)', 'sunflow', 'favourit', 'happi', 'friday', '…']
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org00d0539">
<h2 id="org00d0539">End</h2>
<div class="outline-text-2" id="text-org00d0539">
<p>So now we've seen the basic steps that we're going to need to preprocess our tweets for <a href="https://www.wikiwand.com/en/Sentiment_analysis">Sentiment Analysis</a>.</p>
<p>Things to check out:</p>
<ul class="org-ul">
<li>The book <a href="https://www-nlp.stanford.edu/IR-book/">Introduction to Information Retrieval</a> by Christopher D. Manning, Prabhakar Raghavan, and Hinrich Schütze has some useful information about tokenizing, stop words, and stemming, among other things (and is available to read online).</li>
<li><a href="https://github.com/s/preprocessor">preprocessor</a> - (called <a href="https://pypi.org/project/tweet-preprocessor/">tweet-preprocessor</a> on pypi) has some of this baked in. The hashtag cleaning removes the word and the pound sign and it doesn't use the NLTK twitter tokenizer but looks like it might be useful (unfortunately not everything is documented so you have to look at the code to figure some things out).</li>
</ul>
<p>Finally I'm going to re-write what we did as a class to re-use it later as well as save the testing and training data.</p>
</div>
<div class="outline-3" id="outline-container-orgccb6e5d">
<h3 id="orgccb6e5d">Tests</h3>
<div class="outline-text-3" id="text-orgccb6e5d">
<p>I'm going to use <a href="https://github.com/pytest-dev/pytest-bdd">pytest-bdd</a> to run the tests for the pre-processor but I'm also going to take advantage of org-babel and keep the scenario definitions and the test functions grouped by what they do, even though they will exist in two different files (<code>tweet_preprocessing.feature</code> and <code>test_preprocessing.py</code>) when tangled out of this file.</p>
</div>
<div class="outline-4" id="outline-container-orgc4d760a">
<h4 id="orgc4d760a">The Tangles</h4>
<div class="outline-text-4" id="text-orgc4d760a">
<div class="highlight">
<pre><span></span>Feature: Tweet pre-processor

&lt;&lt;stock-processing&gt;&gt;

&lt;&lt;re-tweet-processing&gt;&gt;

&lt;&lt;hyperlink-processing&gt;&gt;

&lt;&lt;hash-processing&gt;&gt;

&lt;&lt;tokenization-preprocessing&gt;&gt;

&lt;&lt;stop-word-preprocessing&gt;&gt;

&lt;&lt;stem-preprocessing&gt;&gt;

&lt;&lt;whole-shebang-preprocessing&gt;&gt;
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># software under test</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>

<span class="k">class</span> <span class="nc">Katamari</span><span class="p">:</span>
    <span class="sd">"""Something to stick values into"""</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">katamari</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Katamari</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">processor</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">contain_exactly</span><span class="p">,</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">given</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">,</span>
    <span class="n">then</span><span class="p">,</span>
    <span class="n">when</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">And</span> <span class="o">=</span> <span class="n">when</span>


<span class="c1"># fixtures</span>
<span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span>

<span class="n">scenarios</span><span class="p">(</span><span class="s2">"../../features/twitter/tweet_preprocessing.feature"</span><span class="p">)</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">stock</span><span class="o">-</span><span class="n">symbol</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">re</span><span class="o">-</span><span class="n">tweet</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">hyperlinks</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">hashtags</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">tokenization</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">unstopping</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">stem</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">call</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>Now on to the sections that go into the tangles.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgce80a55">
<h4 id="orgce80a55">Stock Symbols</h4>
<div class="outline-text-4" id="text-orgce80a55">
<p>Twitter has a special symbol for stocks which is a dollar sign followed by the stock ticker name (e.g. <code>$HOG</code> for Harley Davidson) that I'll remove. This is going to assume anything with a dollar sign immediately followed by a letter, number, or underscore is a stock symbol.</p>
<div class="highlight">
<pre><span></span>Scenario: A tweet with a stock symbol is cleaned
  Given a tweet with a stock symbol in it
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1">#Scenario: A tweet with a stock symbol is cleaned</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet with a stock symbol in it"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_stock_symbol</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">(),</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> "</span>
                         <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">tail</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># the cleaner ignores spaces so there's going to be two spaces between</span>
    <span class="c1"># the head and tail after the symbol is removed</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">tail</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span>

<span class="c1">#   When the tweet is cleaned</span>
<span class="c1">#   Then it has the text removed</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5ab566a">
<h4 id="org5ab566a">The Re-tweets</h4>
<div class="outline-text-4" id="text-org5ab566a">
<p>This tests that we can remove the RT tag.</p>
<div class="highlight">
<pre><span></span>Scenario: A re-tweet is cleaned.

  Given a tweet that has been re-tweeted
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: A re-tweet is cleaned.</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet that has been re-tweeted"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_re_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">spaces</span> <span class="o">=</span> <span class="s2">" "</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"RT</span><span class="si">{</span><span class="n">spaces</span><span class="si">}{</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the tweet is cleaned"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it has the text removed"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_cleaned_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga1d4c47">
<h4 id="orga1d4c47">Hyperlinks</h4>
<div class="outline-text-4" id="text-orga1d4c47">
<p>Now test that we can remove hyperlinks.</p>
<div class="highlight">
<pre><span></span>Scenario: The tweet has a hyperlink
  Given a tweet with a hyperlink
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The tweet has a hyperlink</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet with a hyperlink"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_hyperlink</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s2">" :)"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">faker</span><span class="o">.</span><span class="n">uri</span><span class="p">()</span> <span class="o">+</span> <span class="s2">" :)"</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org90166f9">
<h4 id="org90166f9">Hash Symbols</h4>
<div class="outline-text-4" id="text-org90166f9">
<p>Test that we can remove the pound symbol.</p>
<div class="highlight">
<pre><span></span>Scenario: A tweet has hash symbols in it.
  Given a tweet with hash symbols
  When the tweet is cleaned
  Then it has the text removed
</pre></div>
<div class="highlight">
<pre><span></span><span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet with hash symbols"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_hash_symbols</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">expected_tokens</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">faker</span><span class="o">.</span><span class="n">word</span><span class="p">()</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"#</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
        <span class="n">expected_tokens</span> <span class="o">=</span> <span class="n">expected_tokens</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+</span> <span class="n">expected_tokens</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">to_clean</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expected_tokens</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1c772da">
<h4 id="org1c772da">Tokenization</h4>
<div class="outline-text-4" id="text-org1c772da">
<p>This is being done by NLTK, so it might not really make sense to test it, but I figured adding a test would make it more likely that I'd slow down enough to understand what it's doing.</p>
<div class="highlight">
<pre><span></span>Scenario: The text is tokenized
  Given a string of text
  When the text is tokenized
  Then it is the expected list of strings
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The text is tokenized</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a string of text"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">"Time flies like an Arrow, fruit flies like a BANANAAAA!"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"time flies like an arrow , "</span>
                         <span class="s2">"fruit flies like a bananaaa !"</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the text is tokenized"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it is the expected list of strings"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_tokens</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5367189">
<h4 id="org5367189">Stop Word Removal</h4>
<div class="outline-text-4" id="text-org5367189">
<p>Check that we're removing stop-words and punctuation.</p>
<div class="highlight">
<pre><span></span>Scenario: The user removes stop words and punctuation
  Given a tokenized string
  When the string is un-stopped
  Then it is the expected list of strings
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1">#Scenario: The user removes stop words and punctuation</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tokenized string"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_tokenized_string</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"now is the winter of our discontent , "</span>
                       <span class="s2">"made glorious summer by this son of york ;"</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"winter discontent made glorious "</span>
                         <span class="s2">"summer son york"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the string is un-stopped"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">un_stop</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">remove_useless_tokens</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span>
<span class="c1">#  Then it is the expected list of strings</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgfb04330">
<h4 id="orgfb04330">Stemming</h4>
<div class="outline-text-4" id="text-orgfb04330">
<p>This is kind of a fake test. I guessed incorrectly what the stemming would do the first time so I had to go back and match the test values to what it output. I don't think I'll take the time to learn how the stemming is working, though, so it'll have to do.</p>
<div class="highlight">
<pre><span></span>Scenario: The user stems the tokens
  Given a tokenized string
  When the string is un-stopped
  And tokens are stemmed
  Then it is the expected list of strings
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user stems the tokens</span>
<span class="c1">#  Given a tokenized string</span>
<span class="c1">#  When the string is un-stopped</span>


<span class="nd">@And</span><span class="p">(</span><span class="s2">"tokens are stemmed"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stem_tokens</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="s2">"winter discont made gloriou summer son york"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span>


<span class="c1">#  Then it is the expected list of strings</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge6466ad">
<h4 id="orge6466ad">The Whole Shebang</h4>
<div class="outline-text-4" id="text-orge6466ad">
<p>I made some of the steps separate just for illustration and testing, but I'll make the processor callable so they don't have to be done separately.</p>
<div class="highlight">
<pre><span></span>Scenario: The user calls the processor
  Given a tweet
  When the processor is called with the tweet
  Then it returns the cleaned, tokenized, and stemmed list
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user calls the processor</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a tweet"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">words</span> <span class="o">=</span> <span class="s2">"#FollowFriday @France_Inte @PKuchly57 @Milipol_Paris for being top engaged members in my community this week :)"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweet</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"RT </span><span class="si">{</span><span class="n">katamari</span><span class="o">.</span><span class="n">words</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">faker</span><span class="o">.</span><span class="n">uri</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">'followfriday'</span><span class="p">,</span> <span class="s1">'top'</span><span class="p">,</span> <span class="s1">'engag'</span><span class="p">,</span> <span class="s1">'member'</span><span class="p">,</span> <span class="s1">'commun'</span><span class="p">,</span> <span class="s1">'week'</span><span class="p">,</span> <span class="s1">':)'</span><span class="p">]</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the processor is called with the tweet"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it returns the cleaned, tokenized, and stemmed list"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_processed_tweet</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org7386fd7">
<h3 id="org7386fd7">Implementation</h3>
<div class="outline-text-3" id="text-org7386fd7"></div>
<div class="outline-4" id="outline-container-orgc2405da">
<h4 id="orgc2405da">A Regular Expression Helper</h4>
<div class="outline-text-4" id="text-orgc2405da">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">WheatBran</span><span class="p">:</span>
    <span class="sd">"""This is a holder for the regular expressions"""</span>
    <span class="n">START_OF_LINE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"^"</span>
    <span class="n">END_OF_LINE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"$"</span>
    <span class="n">OPTIONAL</span> <span class="o">=</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">?"</span>
    <span class="n">ANYTHING</span> <span class="o">=</span> <span class="s2">"."</span>
    <span class="n">ZERO_OR_MORE</span> <span class="o">=</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">*"</span>
    <span class="n">ONE_OR_MORE</span> <span class="o">=</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">+"</span>
    <span class="n">ONE_OF_THESE</span> <span class="o">=</span> <span class="s2">"[</span><span class="si">{}</span><span class="s2">]"</span>
    <span class="n">FOLLOWED_BY</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"(?=</span><span class="si">{}</span><span class="s2">)"</span>
    <span class="n">PRECEDED_BY</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"(?&lt;=</span><span class="si">{}</span><span class="s2">)"</span>
    <span class="n">OR</span> <span class="o">=</span> <span class="s2">"|"</span>

    <span class="n">NOT</span> <span class="o">=</span> <span class="s2">"^"</span>
    <span class="n">SPACE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\s"</span>
    <span class="n">SPACES</span> <span class="o">=</span> <span class="n">ONE_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SPACE</span><span class="p">)</span>
    <span class="n">PART_OF_A_WORD</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\w"</span>
    <span class="n">EVERYTHING_OR_NOTHING</span> <span class="o">=</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ANYTHING</span><span class="p">)</span>
    <span class="n">EVERYTHING_BUT_SPACES</span> <span class="o">=</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">ONE_OF_THESE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NOT</span> <span class="o">+</span> <span class="n">SPACE</span><span class="p">))</span>

    <span class="n">ERASE</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">FORWARD_SLASHES</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\/\/"</span>
    <span class="n">NEWLINES</span> <span class="o">=</span> <span class="n">ONE_OF_THESE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\r\n"</span><span class="p">)</span>
    <span class="c1"># a dollar is a special regular expression character meaning end of line</span>
    <span class="c1"># so escape it</span>
    <span class="n">DOLLAR_SIGN</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\$"</span>

    <span class="c1"># to remove</span>
    <span class="n">STOCK_SYMBOL</span> <span class="o">=</span> <span class="n">DOLLAR_SIGN</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PART_OF_A_WORD</span><span class="p">)</span>
    <span class="n">RE_TWEET</span> <span class="o">=</span> <span class="n">START_OF_LINE</span> <span class="o">+</span> <span class="s2">"RT"</span> <span class="o">+</span> <span class="n">SPACES</span>
    <span class="n">HYPERLINKS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"http"</span> <span class="o">+</span> <span class="n">OPTIONAL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"s"</span><span class="p">)</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="n">FORWARD_SLASHES</span>
                  <span class="o">+</span> <span class="n">EVERYTHING_BUT_SPACES</span> <span class="o">+</span> <span class="n">ZERO_OR_MORE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NEWLINES</span><span class="p">))</span>
    <span class="n">HASH</span> <span class="o">=</span> <span class="s2">"#"</span>

    <span class="n">EYES</span> <span class="o">=</span> <span class="s2">":"</span>
    <span class="n">FROWN</span> <span class="o">=</span> <span class="s2">"\("</span>
    <span class="n">SMILE</span> <span class="o">=</span> <span class="s2">"\)"</span>

    <span class="n">SPACEY_EMOTICON</span> <span class="o">=</span> <span class="p">(</span><span class="n">FOLLOWED_BY</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">START_OF_LINE</span> <span class="o">+</span> <span class="n">OR</span> <span class="o">+</span> <span class="n">PRECEDED_BY</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SPACE</span><span class="p">))</span>
                       <span class="o">+</span> <span class="n">EYES</span> <span class="o">+</span> <span class="n">SPACE</span> <span class="o">+</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">"</span> <span class="o">+</span>
                       <span class="n">FOLLOWED_BY</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SPACE</span> <span class="o">+</span> <span class="n">OR</span> <span class="o">+</span> <span class="n">END_OF_LINE</span><span class="p">))</span>
    <span class="n">SPACEY_FROWN</span> <span class="o">=</span> <span class="n">SPACEY_EMOTICON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FROWN</span><span class="p">)</span>
    <span class="n">SPACEY_SMILE</span> <span class="o">=</span> <span class="n">SPACEY_EMOTICON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SMILE</span><span class="p">)</span>

    <span class="n">spacey_fixed_emoticons</span> <span class="o">=</span> <span class="p">[</span><span class="s2">":("</span><span class="p">,</span> <span class="s2">":)"</span><span class="p">]</span>
    <span class="n">spacey_emoticons</span> <span class="o">=</span> <span class="p">[</span><span class="n">SPACEY_FROWN</span><span class="p">,</span> <span class="n">SPACEY_SMILE</span><span class="p">]</span>

    <span class="n">remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">STOCK_SYMBOL</span><span class="p">,</span> <span class="n">RE_TWEET</span><span class="p">,</span> <span class="n">HYPERLINKS</span><span class="p">,</span> <span class="n">HASH</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org926a411">
<h4 id="org926a411">The Processor</h4>
<div class="outline-text-4" id="text-org926a411">
<p>Here's the class-based implementation to pre-process tweets.</p>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">nltk.stem</span> <span class="kn">import</span> <span class="n">PorterStemmer</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">TweetTokenizer</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">nltk</span>

<span class="o">&lt;&lt;</span><span class="n">regular</span><span class="o">-</span><span class="n">expressions</span><span class="o">&gt;&gt;</span>


<span class="nd">@attr</span><span class="o">.</span><span class="n">s</span>
<span class="k">class</span> <span class="nc">TwitterProcessor</span><span class="p">:</span>
    <span class="sd">"""processor for tweets"""</span>
    <span class="n">_tokenizer</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">_stopwords</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">_stemmer</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">clean</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">tokenizer</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">un</span><span class="o">-</span><span class="n">stop</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">stopwords</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">stemmer</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">stem</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">call</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">processor</span><span class="o">-</span><span class="n">emoticon</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge6b162c">
<h4 id="orge6b162c">The Clean Method</h4>
<div class="outline-text-4" id="text-orge6b162c">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Removes sub-strings from the tweet</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: string tweet</span>

<span class="sd">    Returns:</span>
<span class="sd">     tweet with certain sub-strings removed</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">WheatBran</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
        <span class="n">tweet</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">WheatBran</span><span class="o">.</span><span class="n">ERASE</span><span class="p">,</span> <span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tweet</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org37f7879">
<h4 id="org37f7879">Emoticon Fixer</h4>
<div class="outline-text-4" id="text-org37f7879">
<p>This tries to handle emoticons with spaces in them.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">unspace_emoticons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span>  <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Tries to  remove spaces from emoticons</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: message to check</span>

<span class="sd">    Returns:</span>
<span class="sd">     tweet with things that looks like emoticons with spaces un-spaced</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">expression</span><span class="p">,</span> <span class="n">fix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">WheatBran</span><span class="o">.</span><span class="n">spacey_emoticons</span><span class="p">,</span> <span class="n">WheatBran</span><span class="o">.</span><span class="n">spacey_fixed_emoticons</span><span class="p">):</span>
        <span class="n">tweet</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">fix</span><span class="p">,</span> <span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tweet</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5338b95">
<h4 id="org5338b95">The Tokenizer</h4>
<div class="outline-text-4" id="text-org5338b95">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TweetTokenizer</span><span class="p">:</span>
    <span class="sd">"""The NLTK Tweet Tokenizer</span>

<span class="sd">    It will:</span>
<span class="sd">     - tokenize a string</span>
<span class="sd">     - remove twitter handles</span>
<span class="sd">     - remove repeated characters after the first three</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span> <span class="o">=</span> <span class="n">TweetTokenizer</span><span class="p">(</span><span class="n">preserve_case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">strip_handles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">reduce_len</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgde98c28">
<h4 id="orgde98c28">Stopwords</h4>
<div class="outline-text-4" id="text-orgde98c28">
<p>This might make more sense to be done at the module level, but I'll see how it goes.</p>
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">stopwords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""NLTK English stopwords</span>

<span class="sd">    Warning:</span>
<span class="sd">     if the stopwords haven't been downloaded this also tries too download them</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopwords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'stopwords'</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopwords</span> <span class="o">=</span>  <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s2">"english"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopwords</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgda5317a">
<h4 id="orgda5317a">Un-Stop the Tokens</h4>
<div class="outline-text-4" id="text-orgda5317a">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">remove_useless_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Remove stopwords and punctuation</span>

<span class="sd">    Args:</span>
<span class="sd">     tokens: list of strings</span>

<span class="sd">    Returns:</span>
<span class="sd">     tokens with unuseful tokens removed</span>
<span class="sd">    """</span>    
    <span class="k">return</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopwords</span> <span class="ow">and</span>
                                        <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2b9e68f">
<h4 id="org2b9e68f">Stem the Tokens</h4>
<div class="outline-text-4" id="text-org2b9e68f">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">stemmer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PorterStemmer</span><span class="p">:</span>
    <span class="sd">"""Porter Stemmer for the tokens"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stemmer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stemmer</span> <span class="o">=</span> <span class="n">PorterStemmer</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stemmer</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">stem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""stem the tokens"""</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stemmer</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7c0b551">
<h4 id="org7c0b551">Call Me</h4>
<div class="outline-text-4" id="text-org7c0b551">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""does all the processing in one step</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: string to process</span>

<span class="sd">    Returns:</span>
<span class="sd">     the tweet as a pre-processed list of strings</span>
<span class="sd">    """</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unspace_emoticons</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1"># the stopwords are un-stemmed so this has to come before stemming</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_useless_tokens</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cleaned</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org642d365">
<h3 id="org642d365">Save Things</h3>
<div class="outline-text-3" id="text-org642d365">
<p>Rather than create the training and test sets over and over I'll save them as <a href="https://blog.rstudio.com/2016/03/29/feather/">feather</a> files. I tried saving them as CSVs but I think since the tweets have commas in them it messes it up (or something does anyway). I don't use the un-processed tweets later, but maybe it's a good idea to keep things around.</p>
<p>It occurred to me that I could just pickle the data-frame, but I've never used feather before so it'll give me a chance to try it out. According to that post I linked to about feather it's meant to be fast rather than stable (the format might change) so this is both overkill and impractical, but, oh, well.</p>
</div>
<div class="outline-4" id="outline-container-org7f7015b">
<h4 id="org7f7015b">Data</h4>
<div class="outline-text-4" id="text-org7f7015b">
<p>First I'll process the tweets so I won't have to do this later.</p>
<div class="highlight">
<pre><span></span><span class="n">process</span> <span class="o">=</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
<span class="n">training_processed</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">training_processed</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">"tweet"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">x_train</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">training_processed</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
<pre class="example">
                                      tweet  label
0  off to the park to get some sunlight : )      1
                       tweet  label
0  [park, get, sunlight, :)]      1
</pre>
<p>Now to save it</p>
<div class="highlight">
<pre><span></span><span class="n">processed_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_PROCESSED"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">raw_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>

<span class="n">training_processed</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">processed_path</span><span class="p">)</span>
<span class="n">training</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">processed_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_PROCESSED"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">raw_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>

<span class="n">testing</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">tweet</span><span class="o">=</span><span class="n">x_test</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_test</span><span class="p">))</span>
<span class="n">testing_processed</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">testing_processed</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">"tweet"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">x_test</span><span class="p">]</span>

<span class="n">testing_processed</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">processed_path</span><span class="p">)</span>
<span class="n">testing</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org33b404e">
<h4 id="org33b404e">Pickles</h4>
<div class="outline-text-4" id="text-org33b404e">
<p>I'm spreading this over several posts so I'm going to save some python objects to hold constant values that they share.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_SENTIMENT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Sentiment</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</pre></div>
<p>Next in the series: <a href="posts/nlp/twitter-word-frequencies/">Twitter Word Frequencies</a></p>
<p><b>Note:</b> This series is a re-write of an exercise taken from Coursera's <a href="https://www.deeplearning.ai/natural-language-processing-specialization/">Natural Language Processing</a> specialization. I changed some of the way it works, though, so it won't match their solution 100% (but it's close).</p>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/keras/flask-tensorflow-and-mnist/">Flask, TensorFlow, Streamlit and the MNIST Dataset</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/keras/flask-tensorflow-and-mnist/" rel="bookmark"><time class="published dt-published" datetime="2020-06-18T15:43:56-07:00" itemprop="datePublished" title="2020-06-18 15:43">2020-06-18 15:43</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#orga0cf289">Beginning</a>
<ul>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org87050f5">Set Up</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org16f348b">The Environment</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org8d0a82f">Plotting</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org8565141">The Random Seed</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org5d742aa">The Data</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#orgf079c21">A Note On the Tangling</a></li>
</ul>
</li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org688132c">Middle</a>
<ul>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#orgf8ed624">The Data</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#org2782468">The Neural Network Model</a></li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#orga330501">The Web Page</a></li>
</ul>
</li>
<li><a href="posts/keras/flask-tensorflow-and-mnist/#orgdf52e38">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orga0cf289">
<h2 id="orga0cf289">Beginning</h2>
<div class="outline-text-2" id="text-orga0cf289">
<p>This is a re-working of Coursera's <a href="https://www.coursera.org/learn/neural-network-visualizer/home/welcome">Neural Network Vizualizer Web App With Python</a> course. What we'll do is use <a href="https://www.tensorflow.org/">tensorflow</a> to build a model to classify images of handwritten digits from the <a href="http://yann.lecun.com/exdb/mnist/">MNIST Database of Handwritten Digits</a> which tensoflow provides as one of their pre-built datasets. MNIST (according to <a href="https://www.wikiwand.com/en/MNIST_database">wikipedia</a>) stands for <i>Modified <a href="https://www.wikiwand.com/en/National_Institute_of_Standards_and_Technology">National Institute of Standards and Technology</a></i> (so we're using the Modified NIST Database).</p>
<p>Once we have the model we'll use <a href="https://palletsprojects.com/p/flask/">Flask</a> to serve up the model and <a href="https://www.streamlit.io/">Streamlit</a> to build a web page to view the results.</p>
</div>
<div class="outline-3" id="outline-container-org87050f5">
<h3 id="org87050f5">Set Up</h3>
<div class="outline-text-3" id="text-org87050f5"></div>
<div class="outline-4" id="outline-container-org0749101">
<h4 id="org0749101">Parts</h4>
<div class="outline-text-4" id="text-org0749101">
<p>These are the libraries that we will use.</p>
</div>
<ul class="org-ul">
<li><a id="orga988162"></a>Python<br>
<div class="outline-text-5" id="text-orga988162">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</li>
<li><a id="org48d836b"></a>PyPi<br>
<div class="outline-text-5" id="text-org48d836b">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">HoverTool</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">tensorflow</span>
</pre></div>
</div>
</li>
<li><a id="org55663b4"></a>My Stuff<br>
<div class="outline-text-5" id="text-org55663b4">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org16f348b">
<h3 id="org16f348b">The Environment</h3>
<div class="outline-text-3" id="text-org16f348b">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">".env"</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org8d0a82f">
<h3 id="org8d0a82f">Plotting</h3>
<div class="outline-text-3" id="text-org8d0a82f">
<p>There won't be a lot of plotting, but we'll use matplotlib with seaborn to look at some images to see what they look like and <a href="https://hvplot.holoviz.org/">HVplot</a> to do other visualizations.</p>
<div class="highlight">
<pre><span></span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<p>This is for the nikola posts. If you run the jupyter kernel on a remote machine there's going to be two behaviors for the plot-files. If you create the file in the code block (like I do for the HVPlot plots) then the file will show up on the remote machine. If you use the <code>:file</code> argument in the org-mode header (like I do for matplotlib) it will create the file on the machine where you're running emacs. Given this behavior it might make more sense to edit the emacs file on the remote machine so all the files are created there… next time.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"flask-tensorflow-and-mnist"</span>
<span class="n">OUTPUT</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/keras/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org8565141">
<h3 id="org8565141">The Random Seed</h3>
<div class="outline-text-3" id="text-org8565141">
<p>Since I'm commenting on the outcomes I'll set the random seed to try and make things more consistent.</p>
<div class="highlight">
<pre><span></span><span class="n">tensorflow</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">2020</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org5d742aa">
<h3 id="org5d742aa">The Data</h3>
<div class="outline-text-3" id="text-org5d742aa">
<p>Like I mentioned, tensorflow includes the MNIST data set that we can grab with the <a href="https://www.tensorflow.org/api_docs/python/tf/keras/datasets/mnist/load_data">load_data</a> function. It returns two tuples of numpy arrays.</p>
<div class="highlight">
<pre><span></span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
<p>Let's see how much data we have.</p>
<div class="highlight">
<pre><span></span><span class="n">rows</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training:</span><span class="se">\t</span><span class="si">{</span><span class="n">rows</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> images</span><span class="se">\t</span><span class="s2">image = </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">rows</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Testing:</span><span class="se">\t</span><span class="si">{</span><span class="n">rows</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> images</span><span class="se">\t</span><span class="s2">image = </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training:       60,000 images   image = 28 x 28
Testing:        10,000 images   image = 28 x 28
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgf079c21">
<h3 id="orgf079c21">A Note On the Tangling</h3>
<div class="outline-text-3" id="text-orgf079c21">
<p>I'm going to do this as a <a href="https://www.wikiwand.com/en/Literate_programming">literate programming</a> document with the tangle going into a temporary folder. I was creating the temporary folder using python but I'm running the code on a different machine from where I'm editing this document so running python executes on the remote machine but tangling out the files happens on my local machine. Maybe next time it will make more sense to edit the document on the remote machine (note to future self). Although that also introduces problems because then I'd have to run the tests headless… Every solution has a problem.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org688132c">
<h2 id="org688132c">Middle</h2>
<div class="outline-text-2" id="text-org688132c"></div>
<div class="outline-3" id="outline-container-orgf8ed624">
<h3 id="orgf8ed624">The Data</h3>
<div class="outline-text-3" id="text-orgf8ed624"></div>
<div class="outline-4" id="outline-container-org5747ba0">
<h4 id="org5747ba0">The Distribution</h4>
<div class="outline-text-4" id="text-org5747ba0">
<p>First, we can look at the distribution of the digits to see if they are equally represented.</p>
<div class="highlight">
<pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
          <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
          <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"index"</span><span class="p">:</span> <span class="s2">"Digit"</span><span class="p">,</span>
                           <span class="mi">0</span><span class="p">:</span> <span class="s2">"Count"</span><span class="p">}))</span>
<span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span>
    <span class="n">tooltips</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">"Digit"</span><span class="p">,</span> <span class="s2">"@Digit"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Count"</span><span class="p">,</span> <span class="s2">"@Count{0,0}"</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Digit"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Digit Counts"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"digit_distribution"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">output</span><span class="p">()</span>
</pre></div>
<object data="posts/keras/flask-tensorflow-and-mnist/digit_distribution.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>If you look at the values for the counts you can see that there is a pretty significant difference between 1 and 5.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Count</span> <span class="o">-</span> <span class="n">labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
1,321
</pre>
<p>But we're doing this as an exercise to get a web-page up more so than build a real model so let's not worry about that for now.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org05ffae3">
<h4 id="org05ffae3">Some Example Digits</h4>
<div class="outline-text-4" id="text-org05ffae3">
<p>We'll make a 4 x 4 grid of the first 16 images to see what they look like. Note that our array uses 0-based indexing but matplotlib uses 1-based indexing so we have to make sure that the reference to the cell in the subplot is one ahead of the index for the array.</p>
<div class="highlight">
<pre><span></span><span class="n">IMAGES</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">ROWS</span> <span class="o">=</span> <span class="n">COLUMNS</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IMAGES</span><span class="p">):</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">ROWS</span><span class="p">,</span> <span class="n">COLUMNS</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'binary'</span><span class="p">)</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
<div class="figure">
<p><img alt="sample_digits.png" src="posts/keras/flask-tensorflow-and-mnist/sample_digits.png"></p>
</div>
<p>So the digits (at least the first 16) seem to be pretty clear.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgb52bbfe">
<h4 id="orgb52bbfe">Normalizing the Data</h4>
<div class="outline-text-4" id="text-orgb52bbfe">
<p>One problem we have, though, is that images use values from 0 to 255 to indicate the brightness of a pixel, but neural networks tend to work better with values from 0 to 1, so we'l have to scale the data back. The images are also 28 x 28 squares, but we need to transform them to flat vectors. We can change the shape of the input data using the <a href="https://numpy.org/doc/1.18/reference/generated/numpy.reshape.html">numpy.reshape</a> function, which takes the original data and the shape you want to change it to. In our case we want the same number of rows that there were originally and we want to reduce the images from 2-dimensional images to 1-dimensional images which we can do by passing in the number of total number of pixels in each image as a single number instead of width and height.</p>
<p>Since we have to do this for both the training and testing data I'll make a helper function.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">"""reshapes the data and scales the values"""</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">pixels</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">pixels</span><span class="p">)</span>

    <span class="n">MAX_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">MAX_BRIGHTNESS</span>

    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">x_train</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org2782468">
<h3 id="org2782468">The Neural Network Model</h3>
<div class="outline-text-3" id="text-org2782468"></div>
<div class="outline-4" id="outline-container-org6cae185">
<h4 id="org6cae185">Build and Train It</h4>
<div class="outline-text-4" id="text-org6cae185">
<p>Now we'll build the model. It's going to be a simple fully-connected network with three layers (input, hidden, output). To make the visualization simpler we'll use the <a href="https://www.tensorflow.org/api_docs/python/tf/keras/activations/sigmoid">sigmoid activation</a> function.</p>
<p>Besides the shallowness of the model it's also going to be relatively simple, with only 32 nodes in the hidden layer.</p>
<p>First we'll build it as a <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Sequential">Sequential</a> (linear stack) model.</p>
<div class="highlight">
<pre><span></span><span class="n">rows</span><span class="p">,</span> <span class="n">pixels</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span>
<span class="n">HIDDEN_NODES</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">CATEGORIES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">ACTIVATION</span> <span class="o">=</span> <span class="s2">"sigmoid"</span>
<span class="n">OUTPUT_ACTIVATION</span> <span class="o">=</span> <span class="s2">"softmax"</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">HIDDEN_NODES</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="n">ACTIVATION</span><span class="p">,</span>
                                  <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">pixels</span><span class="p">,)),</span>
    <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">HIDDEN_NODES</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="n">ACTIVATION</span><span class="p">),</span>
    <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">CATEGORIES</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="n">OUTPUT_ACTIVATION</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
<p>Now we can <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Model#compile">compile</a> the model using a <a href="https://www.tensorflow.org/api_docs/python/tf/keras/losses/SparseCategoricalCrossentropy">sparse categorical cross-entropy loss function</a>, which is for the case where you have more than one category (non-binary) and the <a href="https://www.tensorflow.org/api_docs/python/tf/keras/optimizers/Adam">Adam</a> optimizer.</p>
<div class="highlight">
<pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">'sparse_categorical_crossentropy'</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="s1">'adam'</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">'accuracy'</span><span class="p">])</span>
</pre></div>
<p>And next we'll train the model by calling its <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Model#fit">fit</a> method.</p>
<div class="highlight">
<pre><span></span><span class="n">NO_OUTPUT</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">2048</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="n">NO_OUTPUT</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org845fd90">
<h4 id="org845fd90">Plot the Training History</h4>
<div class="outline-text-4" id="text-org845fd90">
<div class="highlight">
<pre><span></span><span class="n">history</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"loss"</span><span class="p">:</span> <span class="s2">"Training Loss"</span><span class="p">,</span>
        <span class="s2">"accuracy"</span><span class="p">:</span> <span class="s2">"Training Accuracy"</span><span class="p">,</span>
        <span class="s2">"val_loss"</span><span class="p">:</span> <span class="s2">"Validation Loss"</span><span class="p">,</span>
        <span class="s2">"val_accuracy"</span><span class="p">:</span> <span class="s2">"Validation Accuracy"</span><span class="p">,</span>
    <span class="p">})</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span>
    <span class="n">tooltips</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">"Metric"</span><span class="p">,</span> <span class="s2">"$name"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Epoch"</span><span class="p">,</span> <span class="s2">"$x"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Value"</span><span class="p">,</span> <span class="s2">"$y"</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">hvplot</span><span class="p">()</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Training History"</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"training_history"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">output</span><span class="p">()</span>
</pre></div>
<object data="posts/keras/flask-tensorflow-and-mnist/training_history.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">lowest</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">highest</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">) Min=</span><span class="si">{</span><span class="n">lowest</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Max=</span><span class="si">{</span><span class="n">highest</span><span class="si">:</span><span class="s2"> 0.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
(Training Loss) Min=0.20 Max= 2.26
(Training Accuracy) Min=0.22 Max= 0.95
(Validation Loss) Min=0.21 Max= 2.14
(Validation Accuracy) Min=0.38 Max= 0.94
</pre>
<p>So our validation accuracy goes from 38 % to 94%, which isn't bad, especially when you consider what a simple model we have.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgc098849">
<h4 id="orgc098849">Save It</h4>
<div class="outline-text-4" id="text-orgc098849">
<p>Now we can save the model to use in our flask application.</p>
<p><b>Note To Self:</b> Since this is being run on a remote machine, both the <code>.env</code> file and the directory to save the models refers to the remote machine, not the local machine where this file is being edited so you have to copy it to the local machine later on to use it with flask.</p>
<p>Also note that the you can't see the name since I put it in a <code>.env</code> file but it has <code>.h5</code> as the extension. According to the TensorFlow page on <a href="https://www.tensorflow.org/guide/keras/save_and_serialize">saving and loading a model</a>, H5 is the older format, they've switched to the <a href="https://www.tensorflow.org/guide/saved_model">SavedModel</a> format, you lose some information that would help you resume training, but we're not going to do that anyway, and the H5 format should be a little smaller.</p>
<p>Most of the next blob is to make sure the folder for the model exists. I put it in the environment variable mostly because I keep changing my mind as to where to put it and what to call it.</p>
<div class="highlight">
<pre><span></span><span class="n">base</span> <span class="o">=</span> <span class="s2">"flask_tensorflow_mnist"</span>
<span class="n">MODELS</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">base</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_model"</span><span class="p">]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">MODELS</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
<span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="n">MODELS</span><span class="o">/</span><span class="n">MODEL_NAME</span>
<span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">MODEL_PATH</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orga330501">
<h3 id="orga330501">The Web Page</h3>
<div class="outline-text-3" id="text-orga330501"></div>
<ul class="org-ul">
<li><a id="org0022143"></a>Back-End (The Model Server)<br>
<ul class="org-ul">
<li><a id="org1657b0e"></a>Tests<br>
<ul class="org-ul">
<li><a id="org528e804"></a>Fixtures<br>
<div class="outline-text-7" id="text-org528e804">
<p>These are the pytest fixtures to make it easier to create objects.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>

 <span class="c1"># from pypi</span>

 <span class="kn">import</span> <span class="nn">pytest</span>
 <span class="kn">import</span> <span class="nn">tensorflow</span>

 <span class="c1"># software under test</span>
 <span class="kn">from</span> <span class="nn">ml_server</span> <span class="kn">import</span> <span class="n">app</span>


 <span class="k">class</span> <span class="nc">Katamari</span><span class="p">:</span>
     <span class="sd">"""Something to stick things into"""</span>


 <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
 <span class="k">def</span> <span class="nf">katamari</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Katamari</span><span class="p">:</span>
     <span class="k">return</span> <span class="n">Katamari</span><span class="p">()</span>


 <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
 <span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
     <span class="sd">"""generates the flask client for testing"""</span>
     <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"TESTING"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
     <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
         <span class="k">yield</span> <span class="n">client</span>
     <span class="k">return</span>


 <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
 <span class="k">def</span> <span class="nf">mnist</span><span class="p">():</span>
     <span class="sd">"""Gets the test labels"""</span>
     <span class="n">MAX_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>
     <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
     <span class="k">return</span> <span class="n">Namespace</span><span class="p">(</span>
         <span class="n">x_test</span><span class="o">=</span><span class="n">x_test</span><span class="o">/</span><span class="n">MAX_BRIGHTNESS</span><span class="p">,</span>
         <span class="n">y_test</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span>
     <span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="org5d252ce"></a>Features<br>
<div class="outline-text-7" id="text-org5d252ce">
<p>These are the feature files.</p>
<div class="highlight">
<pre><span></span> Feature: A Prediction Getter

 Scenario: The root page is retrieved
   Given a connection to the flask client
   When the root page is retrieved
   Then it has the expected text

 Scenario: A prediction is retrieved
   Given the get_prediction function
   When a prediction is retrieved
   Then it has the correct tuple

 Scenario: The API end-point is retrieved
   Given a connection to the flask client
   When the API end-point is retrieved
   Then the response has the expected JSON
</pre></div>
</div>
</li>
<li><a id="orge1a3f93"></a>The Tests<br>
<div class="outline-text-7" id="text-orge1a3f93">
<p>These are the actual test functions.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>

 <span class="kn">import</span> <span class="nn">random</span>

 <span class="c1"># pypi</span>
 <span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">be</span><span class="p">,</span>
     <span class="n">be_true</span><span class="p">,</span>
     <span class="n">contain</span><span class="p">,</span>
     <span class="n">equal</span><span class="p">,</span>
     <span class="n">expect</span><span class="p">,</span>
 <span class="p">)</span>

 <span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">given</span><span class="p">,</span>
     <span class="n">when</span><span class="p">,</span>
     <span class="n">then</span><span class="p">,</span>
     <span class="n">scenario</span><span class="p">,</span>
     <span class="n">scenarios</span><span class="p">,</span>
 <span class="p">)</span>

 <span class="kn">import</span> <span class="nn">numpy</span>

 <span class="c1"># for testing</span>
 <span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">client</span><span class="p">,</span> <span class="n">katamari</span><span class="p">,</span> <span class="n">mnist</span>

 <span class="c1"># software under test</span>
 <span class="kn">from</span> <span class="nn">ml_server</span> <span class="kn">import</span> <span class="n">get_prediction</span><span class="p">,</span> <span class="n">PATHS</span>

 <span class="n">scenarios</span><span class="p">(</span><span class="s2">"get_predictions.feature"</span><span class="p">)</span>

 <span class="c1"># ***** Get Root Page ***** #</span>
 <span class="c1"># Scenario: The root page is retrieved</span>


 <span class="nd">@given</span><span class="p">(</span><span class="s2">"a connection to the flask client"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">setup_client</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
     <span class="c1"># this is a no-op since I made a fixture to build the client instead</span>
     <span class="k">return</span>


 <span class="nd">@when</span><span class="p">(</span><span class="s2">"the root page is retrieved"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">get_root_page</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
     <span class="n">katamari</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">))</span>
     <span class="k">return</span>

 <span class="nd">@then</span><span class="p">(</span><span class="s2">"it has the expected text"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_root_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
         <span class="n">contain</span><span class="p">(</span><span class="sa">b</span><span class="s2">"This is the Neural Network Visualizer"</span><span class="p">))</span>
     <span class="k">return</span>

 <span class="c1"># ***** get predictions ***** #</span>
 <span class="c1"># *** Call the function *** #</span>
 <span class="c1"># Scenario: A prediction is retrieved</span>

 <span class="nd">@given</span><span class="p">(</span><span class="s2">"the get_prediction function"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_get_prediction</span><span class="p">():</span>
     <span class="sd">"""Another no-op"""</span>
     <span class="k">return</span>

 <span class="nd">@when</span><span class="p">(</span><span class="s2">"a prediction is retrieved"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">call_get_prediction</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
     <span class="n">choice_mock</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
     <span class="n">katamari</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">6</span>
     <span class="n">choice_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">index</span>
     <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">"ml_server.numpy.random.choice"</span><span class="p">,</span> <span class="n">choice_mock</span><span class="p">)</span>
     <span class="n">katamari</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">get_prediction</span><span class="p">()</span>
     <span class="k">return</span>


 <span class="nd">@then</span><span class="p">(</span><span class="s2">"it has the correct tuple"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_predictions</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mnist</span><span class="p">):</span>
     <span class="c1"># Our model emits a list with one array for each layer of the model</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

     <span class="c1"># the last layer is the prediction layer</span>
     <span class="n">predictions</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

     <span class="n">predicted</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">y_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>

     <span class="c1"># now check the image</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">x_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="c1"># expect(katamari.output[1].shape).to(equal((28, 28)))</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
     <span class="k">return</span>

 <span class="c1"># *** API Call *** #</span>
 <span class="c1">#Scenario: the API end-point is retrieved</span>
 <span class="c1">#  Given a connection to the flask client</span>


 <span class="nd">@when</span><span class="p">(</span><span class="s2">"the API end-point is retrieved"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">get_predictions</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
     <span class="c1"># set up the mock so we can control which of the images it tries to predict</span>
     <span class="n">choice_mock</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>

     <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">"ml_server.numpy.random.choice"</span><span class="p">,</span> <span class="n">choice_mock</span><span class="p">)</span>

     <span class="n">katamari</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
     <span class="n">choice_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">index</span>

     <span class="n">katamari</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">api</span><span class="p">)</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">))</span>
     <span class="k">return</span>


 <span class="nd">@then</span><span class="p">(</span><span class="s2">"the response has the expected JSON"</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">check_response</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mnist</span><span class="p">):</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">is_json</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
     <span class="n">data</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">json</span>
     <span class="n">layers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"prediction"</span><span class="p">]</span>

     <span class="c1"># the prediction should be the three outputs of our model</span>
     <span class="c1"># except with lists instead of numpy arrays</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
     <span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
     <span class="n">prediction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

     <span class="c1"># now check that it made the expected prediction</span>
     <span class="n">predicted</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">y_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>

     <span class="c1"># and that it gave us the right image</span>
     <span class="n">expected</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">x_test</span><span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
     <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">"image"</span><span class="p">]),</span> <span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
     <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><a id="orgf0ea8d1"></a>The Implementation<br>
<div class="outline-text-6" id="text-orgf0ea8d1">
<p>This is where we tangle out a file to run a flask server that will serve up our model's predictions.</p>
<div class="highlight">
<pre><span></span> <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="n">app</span><span class="o">&gt;&gt;</span>


 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">model</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">feature</span><span class="o">-</span><span class="n">model</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">data</span><span class="o">&gt;&gt;</span>


 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">get</span><span class="o">-</span><span class="n">prediction</span><span class="o">&gt;&gt;</span>


 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">index</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">api</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">ml</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">main</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>First up is our imports. Other than Flask there really isn't anything new here.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
 <span class="kn">import</span> <span class="nn">json</span>
 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">import</span> <span class="nn">random</span>
 <span class="kn">import</span> <span class="nn">string</span>

 <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

 <span class="c1"># pypi</span>
 <span class="kn">import</span> <span class="nn">numpy</span>
 <span class="kn">import</span> <span class="nn">tensorflow</span>

 <span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
 <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
</pre></div>
<p>Now we create the flask app and something to hold the paths.</p>
<div class="highlight">
<pre><span></span> <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

 <span class="n">PATHS</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
     <span class="n">root</span> <span class="o">=</span> <span class="s2">"/"</span><span class="p">,</span>
     <span class="n">api</span> <span class="o">=</span> <span class="s2">"/api"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
<p>Next we'll load the saved model. I'm going to break this up a little bit just because I wasn't clear about what was going on originally.</p>
<div class="highlight">
<pre><span></span> <span class="n">load_dotenv</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

 <span class="n">base</span> <span class="o">=</span> <span class="s2">"flask_tensorflow_mnist"</span>
 <span class="n">MODELS</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">base</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
 <span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_model"</span><span class="p">]</span>
 <span class="k">assert</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
 <span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="n">MODELS</span><span class="o">/</span><span class="n">MODEL_NAME</span>
 <span class="k">assert</span> <span class="n">MODEL_PATH</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>

 <span class="n">model</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">)</span>
</pre></div>
<p>At this point we should have a re-loaded version of our trained model (minus some information as noted above because it was saved using the <code>H5</code> format). Our model has one output layer - the softmax prediction layer - which gives the probabilities that an input image is one of the ten digits, but since we want to see what each layer is doing, we'll create a new model with the output from each layer added to the outputs - so since we have three layers in the model we'll now have three outputs.</p>
<div class="highlight">
<pre><span></span> <span class="n">feature_model</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
     <span class="n">inputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
     <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">output</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">])</span>
</pre></div>
<p>Next let's load and normalize the data. We don't use the training data or the labels here.</p>
<div class="highlight">
<pre><span></span> <span class="n">MAX_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>

 <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
 <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">/</span><span class="n">MAX_BRIGHTNESS</span>
</pre></div>
<p>Now we create the function to get the prediction for an image. It also returns the image so that we can see what it was.</p>
<div class="highlight">
<pre><span></span> <span class="n">ROWS</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">,</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span>
 <span class="n">PIXELS</span> <span class="o">=</span> <span class="n">HEIGHT</span> <span class="o">*</span> <span class="n">WIDTH</span>

 <span class="k">def</span> <span class="nf">get_prediction</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
     <span class="sd">"""Gets a random image and prediction</span>

<span class="sd">     The 'prediction' isn't so much the value (e.g. it's a 5) but rather the</span>
<span class="sd">     outputs of each layer so that they can be visualised. So the first value</span>
<span class="sd">     of the tuple will be a list of arrays whose length will be the number of </span>
<span class="sd">     layers in the model. Each array will be the outputs for that layer.</span>

<span class="sd">     This always pulls the image from =x_test=.</span>

<span class="sd">     Returns:</span>
<span class="sd">      What our model predicts for a random image and the image</span>
<span class="sd">     """</span>
     <span class="n">index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ROWS</span><span class="p">)</span>
     <span class="n">image</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[</span><span class="n">index</span><span class="p">,:,:]</span>
     <span class="n">image_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">PIXELS</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">feature_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image_array</span><span class="p">),</span> <span class="n">image</span>
</pre></div>
<p>Next we create the handler for the REST calls. If you make a GET request from the root you'll get an HTML page back.</p>
<div class="highlight">
<pre><span></span> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
 <span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
     <span class="sd">"""The home page view"""</span>
     <span class="k">return</span> <span class="s2">"This is the Neural Network Visualizer (use /api for the API)"</span>
</pre></div>
<p>If you return a dict flask will automatically identify it as JSON.</p>
<div class="highlight">
<pre><span></span> <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">PATHS</span><span class="o">.</span><span class="n">api</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"GET"</span><span class="p">])</span>
 <span class="k">def</span> <span class="nf">api</span><span class="p">():</span>
     <span class="sd">"""the JSON view</span>

<span class="sd">     Returns:</span>
<span class="sd">       JSON with prediction layers and image</span>
<span class="sd">     """</span>
     <span class="n">predictions</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">get_prediction</span><span class="p">()</span>

     <span class="c1"># JSON needs lists, not numpy arrays</span>
     <span class="n">final_predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">prediction</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">]</span>
     <span class="k">return</span> <span class="p">{</span><span class="s2">"prediction"</span><span class="p">:</span> <span class="n">final_predictions</span><span class="p">,</span>
             <span class="s1">'image'</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
</pre></div>
<p>And now we make the "main" entry point.</p>
<div class="highlight">
<pre><span></span> <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
     <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
<p>To run this you would enter the same directory as the <code>ml_server.py</code> file and execute:</p>
<div class="highlight">
<pre><span></span> python ml_server.py
</pre></div>
<p>Or better, use the <a href="https://flask.palletsprojects.com/en/1.1.x/server/">development server</a>.</p>
<div class="highlight">
<pre><span></span>set -X FLASK_APP ml_server
set -X FLASK_ENV development

flask run
</pre></div>
<p>This will automatically re-load if you make changes to the code. The first two lines in the code block above tell flask which one of the modules has the flask-app and also that it should run in development mode. I'm using the <a href="https://fishshell.com/">Fish Shell</a>, so if you are using bash or a similar shell instead the lines would be this instead.</p>
<div class="highlight">
<pre><span></span>export FLASK_APP=ml_server
export FLASK_ENV=development

flask run
</pre></div>
</div>
</li>
</ul>
</li>
<li><a id="orgf2b9652"></a>Front-End<br>
<ul class="org-ul">
<li><a id="org379f01f"></a>Tests<br>
<div class="outline-text-6" id="text-org379f01f">
<div class="highlight">
<pre><span></span>&lt;&lt;front-end-feature-title&gt;&gt;

&lt;&lt;front-end-click&gt;&gt;
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">browser</span><span class="p">():</span>
    <span class="sd">"""Creates the selenium webdriver session"""</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">browser</span>
    <span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>


<span class="n">CSSSelectors</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">main_title</span> <span class="o">=</span> <span class="s2">".main h1"</span><span class="p">,</span>
    <span class="n">main_button</span> <span class="o">=</span> <span class="s2">".main button"</span><span class="p">,</span>
    <span class="n">sidebar_title</span> <span class="o">=</span> <span class="s2">".sidebar h1"</span><span class="p">,</span>
    <span class="n">sidebar_image</span> <span class="o">=</span> <span class="s2">".sidebar-content img"</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">HomePage</span><span class="p">:</span>
    <span class="sd">"""A page-class for testing</span>

<span class="sd">    Args:</span>
<span class="sd">     address: the address of the streamlit server</span>
<span class="sd">     wait: seconds to implicitly wait for page-objects</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"http://localhost:8501"</span><span class="p">,</span>
                 <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">wait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">browser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">:</span>
        <span class="sd">"""The browser opened to the home page"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">main_title</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""The object with the main title"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
                <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">main_title</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">main_button</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""The man button"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
                <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">main_button</span>
            <span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sidebar_title</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""The sidebar title element"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
                <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">sidebar_title</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sidebar_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">firefox</span><span class="o">.</span><span class="n">webelement</span><span class="o">.</span><span class="n">FirefoxWebElement</span><span class="p">:</span>
        <span class="sd">"""This tries to get the sidebar image element</span>
<span class="sd">       """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
            <span class="n">CSSSelectors</span><span class="o">.</span><span class="n">sidebar_image</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Finalizer that closes the browser"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">home_page</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">HomePage</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span> <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">front</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">front</span><span class="o">-</span><span class="n">text</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">front</span><span class="o">-</span><span class="n">click</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
</li>
<li><a id="org4d3a643"></a>The Features<br>
<div class="outline-text-6" id="text-org4d3a643">
<p>We can start with the imports and basic set up.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># pypi</span>
 <span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">be_true</span><span class="p">,</span>
     <span class="n">equal</span><span class="p">,</span>
     <span class="n">expect</span>
 <span class="p">)</span>

 <span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">given</span><span class="p">,</span>
     <span class="n">scenarios</span><span class="p">,</span>
     <span class="n">then</span><span class="p">,</span>
     <span class="n">when</span><span class="p">,</span>
 <span class="p">)</span>

 <span class="c1"># fixtures</span>
 <span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span>

 <span class="kn">from</span> <span class="nn">front_end_fixtures</span> <span class="kn">import</span> <span class="n">home_page</span>

 <span class="n">and_also</span> <span class="o">=</span> <span class="n">then</span>
 <span class="n">scenarios</span><span class="p">(</span><span class="s2">"front_end.feature"</span><span class="p">)</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgcc136b2"></a>The Initial Text<br>
<div class="outline-text-7" id="text-orgcc136b2">
<div class="highlight">
<pre><span></span> Feature: The GUI web page to view the model

 Scenario: The user goes to the home page and checks it out
   Given a browser on the home page
   When the user checks out the titles and button
   Then they have the expected text
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># ***** The Text ***** #</span>
<span class="c1"># Scenario: The user goes to the home page and checks it out</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a browser on the home page"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_browser</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">home_page</span><span class="p">):</span>
    <span class="c1"># katamari.home_page = home_page</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks out the titles and button"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">home_page</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">main_title</span> <span class="o">=</span> <span class="n">home_page</span><span class="o">.</span><span class="n">main_title</span><span class="o">.</span><span class="n">text</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">button_text</span> <span class="o">=</span> <span class="n">home_page</span><span class="o">.</span><span class="n">main_button</span><span class="o">.</span><span class="n">text</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">sidebar_title</span> <span class="o">=</span> <span class="n">home_page</span><span class="o">.</span><span class="n">sidebar_title</span><span class="o">.</span><span class="n">text</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"they have the expected text"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_text</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">main_title</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="s2">"Neural Network Visualizer"</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">button_text</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="s2">"Get Random Prediction"</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">sidebar_title</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="s2">"Input Image"</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="orgb48ff3b"></a>Click the Button<br>
<div class="outline-text-7" id="text-orgb48ff3b">
<div class="highlight">
<pre><span></span>Scenario: The user gets a random prediction
  Given a browser on the home page
  When the user clicks on the button
  Then the sidebar displays the input image
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># ***** The button click ****** #</span>
<span class="c1"># Scenario: The user gets a random prediction</span>
<span class="c1">#  Given a browser on the home page</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user clicks on the button"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">click_get_image_button</span><span class="p">(</span><span class="n">home_page</span><span class="p">):</span>
    <span class="n">home_page</span><span class="o">.</span><span class="n">main_button</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"the sidebar displays the input image"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_sidebar_sections</span><span class="p">(</span><span class="n">home_page</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">home_page</span><span class="o">.</span><span class="n">sidebar_image</span><span class="o">.</span><span class="n">is_displayed</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><a id="org63935f8"></a>Streamlit<br>
<div class="outline-text-6" id="text-org63935f8">
<p>For the front-end we'll use Streamlit, a python library to make creating web-pages for certain types of applications more easily (I think, I'll need to check it out more later).</p>
<div class="highlight">
<pre><span></span> <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">url</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">title</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">sidebar</span><span class="o">&gt;&gt;</span>

 <span class="o">&lt;&lt;</span><span class="n">streamlit</span><span class="o">-</span><span class="n">control</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>First the imports.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># python</span>
 <span class="kn">import</span> <span class="nn">json</span>
 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

 <span class="c1"># pypi</span>
 <span class="kn">import</span> <span class="nn">requests</span>
 <span class="kn">import</span> <span class="nn">numpy</span>
 <span class="kn">import</span> <span class="nn">streamlit</span>
 <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>

 <span class="c1"># this code</span>
 <span class="kn">from</span> <span class="nn">ml_server</span> <span class="kn">import</span> <span class="n">PATHS</span>
</pre></div>
<p>Now we'll setup the URL for our flask backend - as you can see we're expecting to run this on the <code>localhost</code> address, you'd have to change this for make it available outside the host PC.</p>
<div class="highlight">
<pre><span></span> <span class="n">URI</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="s2">"http://127.0.0.1:5000/"</span><span class="p">,</span> <span class="n">PATHS</span><span class="o">.</span><span class="n">api</span><span class="p">)</span>
</pre></div>
<p>Next we'll set the title for the page - this can be a little confusing, although it's called the title, it isn't the HTML title but rather the main heading for the page.</p>
<div class="highlight">
<pre><span></span> <span class="n">streamlit</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Neural Network Visualizer'</span><span class="p">)</span>
</pre></div>
<p>Now we'll add a collapsible sidebar where we'll eventually put our image output and add a headline for it (<code>Input Image</code>).</p>
<div class="highlight">
<pre><span></span> <span class="n">streamlit</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s1">'# Input Image'</span><span class="p">)</span>
</pre></div>
<p>Now we'll add some logic. I think this would be the <code>control</code> portion of a more traditional web-server. It's basically where we react to a button press by getting a random image and visualizing how it makes a prediction.</p>
<div class="highlight">
<pre><span></span> <span class="c1"># create a button and wait for someone to press it</span>
 <span class="k">if</span> <span class="n">streamlit</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">"Get Random Prediction"</span><span class="p">):</span>
     <span class="c1"># Someone pressed the button, make an API call to our flask server</span>
     <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URI</span><span class="p">)</span>

     <span class="c1"># convert the response to a dict</span>
     <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

     <span class="c1"># get the prediction array</span>
     <span class="n">predictions</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'prediction'</span><span class="p">)</span>

     <span class="c1"># get the image we were making the prediction for</span>
     <span class="n">image</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'image'</span><span class="p">)</span>

     <span class="c1"># the image </span>
     <span class="c1"># streamlit expects a numpy array or string-like object, not lists</span>
     <span class="n">image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

     <span class="c1"># show the image in the sidebar</span>
     <span class="n">streamlit</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

     <span class="c1"># iterate over the prediction for each layer in the model</span>
     <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
         <span class="c1"># convert the prediction list to an array</span>
         <span class="c1"># and flatten it to a vector</span>
         <span class="n">numbers</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>
         <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
         <span class="n">rows</span> <span class="o">=</span> <span class="mi">1</span>
         <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
             <span class="c1"># this is the output layer so we only want one row</span>
             <span class="c1"># and we want 10 columns (one for each digit)</span>
             <span class="n">columns</span> <span class="o">=</span> <span class="mi">10</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="c1"># this is the input or hidden layer</span>
             <span class="c1"># since our model had 32 hidden nodes it has 32 columns</span>
             <span class="c1"># the original version had 2 rows and 16 columns, but</span>
             <span class="c1"># while that looked nicer, I think it makes more sense for </span>
             <span class="c1"># there to be one layer</span>
             <span class="n">columns</span> <span class="o">=</span> <span class="mi">32</span>
         <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
             <span class="c1"># add a subplot to the figure</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">number</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
                           <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float32'</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'binary'</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
             <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                 <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
             <span class="n">pyplot</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
         <span class="n">streamlit</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s1">'Layer </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
         <span class="n">streamlit</span><span class="o">.</span><span class="n">pyplot</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgdf52e38">
<h2 id="orgdf52e38">End</h2>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/fastai/hand-rolling-a-countvectorizer/">Hand-rolling a CountVectorizer</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/fastai/hand-rolling-a-countvectorizer/" rel="bookmark"><time class="published dt-published" datetime="2020-01-03T17:21:23-08:00" itemprop="datePublished" title="2020-01-03 17:21">2020-01-03 17:21</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#orgaded82d">Beginning</a>
<ul>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#org9afdc38">Imports</a>
<ul>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#org6c48c68">Python</a></li>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#org9497642">PyPi</a></li>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#orgd5bfdad">Others</a></li>
</ul>
</li>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#orgc52c02f">Setup</a>
<ul>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#org2f37b68">Plotting</a></li>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#org4e62692">The Data Set</a></li>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#orgf7c0e77">The Text List</a></li>
</ul>
</li>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#orga3111d3">Creating a Term-Document Matrix</a></li>
</ul>
</li>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#org9505281">End</a>
<ul>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#orgd554307">Reference</a>
<ul>
<li><a href="posts/fastai/hand-rolling-a-countvectorizer/#org80f91c0">The Dataset</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgaded82d">
<h2 id="orgaded82d">Beginning</h2>
<div class="outline-text-2" id="text-orgaded82d">
<p>This is part of lesson 3 from the <a href="https://github.com/fastai/course-nlp">fastai NLP course</a>.</p>
</div>
<div class="outline-3" id="outline-container-org9afdc38">
<h3 id="org9afdc38">Imports</h3>
<div class="outline-text-3" id="text-org9afdc38"></div>
<div class="outline-4" id="outline-container-org6c48c68">
<h4 id="org6c48c68">Python</h4>
<div class="outline-text-4" id="text-org6c48c68">
<div class="highlight">
<pre><span></span>from collections import Counter
from functools import partial
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9497642">
<h4 id="org9497642">PyPi</h4>
<div class="outline-text-4" id="text-org9497642">
<div class="highlight">
<pre><span></span>from fastai.text import (
    URLs,
    untar_data,
    TextList,
    )
import hvplot.pandas
import pandas
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd5bfdad">
<h4 id="orgd5bfdad">Others</h4>
<div class="outline-text-4" id="text-orgd5bfdad">
<div class="highlight">
<pre><span></span>from graeae import CountPercentage, EmbedHoloviews
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc52c02f">
<h3 id="orgc52c02f">Setup</h3>
<div class="outline-text-3" id="text-orgc52c02f"></div>
<div class="outline-4" id="outline-container-org2f37b68">
<h4 id="org2f37b68">Plotting</h4>
<div class="outline-text-4" id="text-org2f37b68">
<div class="highlight">
<pre><span></span>Embed = partial(
    EmbedHoloviews,
    folder_path="../../files/posts/fastai/hand-rolling-a-countvectorizer/")
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4e62692">
<h4 id="org4e62692">The Data Set</h4>
<div class="outline-text-4" id="text-org4e62692">
<p>The data-set is a collection of 50,000 IMDB reviews <a href="https://course.fast.ai/datasets.html">hosted on AWS Open Datasets</a> as part of the fastai datasets collection. We're going to try and create a classifier that can predict the "sentiment" of reviews. The <a href="http://ai.stanford.edu/~amaas/data/sentiment/">original dataset</a> comes from Stanford University.</p>
<p>To make it easier to experiment, we'll initially load a sub-set of the dataset that fastai prepared. The <a href="https://docs.fast.ai/datasets.html#URLs">URLs</a> class contains the URLs for the datasets that fastai has uploaded and the <a href="https://docs.fast.ai/datasets.html#untar_data"><code>untar_data</code></a> function downloads data from the URL given to a given (or in this case default) location.</p>
<div class="highlight">
<pre><span></span>path = untar_data(URLs.IMDB_SAMPLE)
print(path)
</pre></div>
<pre class="example">
/home/athena/.fastai/data/imdb_sample
</pre>
<p>The <code>untar_data</code> function doesn't actually load the data for us, so we'll use pandas to do that.</p>
<div class="highlight">
<pre><span></span>sample_frame = pandas.read_csv(path/"texts.csv")
print(sample_frame.head())
</pre></div>
<pre class="example">
      label                                               text  is_valid
0  negative  Un-bleeping-believable! Meg Ryan doesn't even ...     False
1  positive  This is a extremely well-made film. The acting...     False
2  negative  Every once in a long while a movie will come a...     False
3  positive  Name just says it all. I watched this movie wi...     False
4  negative  This movie succeeds at being one of the most u...     False
</pre>
<p>The <code>is_valid</code> column is kind of interesting here especially since the first examples are all false… but I couldn't find an explanation for it on the data-download page.</p>
<div class="highlight">
<pre><span></span>CountPercentage(sample.label)()
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Value</th>
<th class="org-right" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">negative</td>
<td class="org-right">524</td>
<td class="org-right">52.40</td>
</tr>
<tr>
<td class="org-left">positive</td>
<td class="org-right">476</td>
<td class="org-right">47.60</td>
</tr>
</tbody>
</table>
<p>So it is nearly balanced but with a slight bias toward negative comments.</p>
<div class="highlight">
<pre><span></span>CountPercentage(sample.is_valid)()
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Value</th>
<th class="org-right" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">False</td>
<td class="org-right">800</td>
<td class="org-right">80.00</td>
</tr>
<tr>
<td class="org-left">True</td>
<td class="org-right">200</td>
<td class="org-right">20.00</td>
</tr>
</tbody>
</table>
<p>Well, so exactly 20% are invalid? Curious.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgf7c0e77">
<h4 id="orgf7c0e77">The Text List</h4>
<div class="outline-text-4" id="text-orgf7c0e77">
<p>To actually work with the dataset we'll use fastai's <a href="https://docs.fast.ai/text.data.html#The-TextList-input-classes">TextList</a> instead of pandas' dataframe.</p>
<div class="highlight">
<pre><span></span>sample_list = TextList.from_csv(path, "texts.csv", cols="text")
sample_split = sample_list.split_from_df(col=2)
sample = (sample_split
          .label_from_df(cols=0))
</pre></div>
<p>The original notebook builds the <code>TextList</code> in a single train-wreck, but if you try and find out what those methods do from the fastai documentation… well, good luck to you, it's easier (although still obscure) to inspect the intermediate objects to try and muddle through what's going on. The ultimate outcome seems to be that <code>sample</code> is an object with the somewhat pre-processed. It looks like the text is lower-cased and somewhat tokenized. There's also a lot of strange tokens inserted (<code>xxmaj</code>, <code>xxunk</code>) which, according to the <a href="https://docs.fast.ai/text.transform.html#Introduction">tokenization documentation</a> indicate special tokens - although there's more unknown tokens than I would have expected.</p>
<div class="highlight">
<pre><span></span>print(sample.train.x[0])
</pre></div>
<pre class="example">
xxbos xxmaj un - xxunk - believable ! xxmaj meg xxmaj ryan does n't even look her usual xxunk lovable self in this , which normally makes me forgive her shallow xxunk acting xxunk . xxmaj hard to believe she was the producer on this dog . xxmaj plus xxmaj kevin xxmaj kline : what kind of suicide trip has his career been on ? xxmaj xxunk ... xxmaj xxunk ! ! ! xxmaj finally this was directed by the guy who did xxmaj big xxmaj xxunk ? xxmaj must be a replay of xxmaj jonestown - hollywood style . xxmaj xxunk !
</pre>
<div class="highlight">
<pre><span></span>print(sample_frame.text.iloc[0])
</pre></div>
<pre class="example">
Un-bleeping-believable! Meg Ryan doesn't even look her usual pert lovable self in this, which normally makes me forgive her shallow ticky acting schtick. Hard to believe she was the producer on this dog. Plus Kevin Kline: what kind of suicide trip has his career been on? Whoosh... Banzai!!! Finally this was directed by the guy who did Big Chill? Must be a replay of Jonestown - hollywood style. Wooofff!
</pre>
<p>Here's the category fo that review.</p>
<div class="highlight">
<pre><span></span>print(sample.train.y[0])
</pre></div>
<pre class="example">
negative
</pre>
<p>Note that the output looks like a string, but it's actually a fastai "type".</p>
<div class="highlight">
<pre><span></span>print(type(sample.train.y[0]))
</pre></div>
<pre class="example">
&lt;class 'fastai.core.Category'&gt;
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga3111d3">
<h3 id="orga3111d3">Creating a Term-Document Matrix</h3>
<div class="outline-text-3" id="text-orga3111d3">
<p>Here we'll create a matrix that counts the number of times each token appears in each document.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org9505281">
<h2 id="org9505281">End</h2>
<div class="outline-text-2" id="text-org9505281"></div>
<div class="outline-3" id="outline-container-orgd554307">
<h3 id="orgd554307">Reference</h3>
<div class="outline-text-3" id="text-orgd554307"></div>
<div class="outline-4" id="outline-container-org80f91c0">
<h4 id="org80f91c0">The Dataset</h4>
<div class="outline-text-4" id="text-org80f91c0">
<ul class="org-ul">
<li>Andrew L. Maas, Raymond E. Daly, Peter T. Pham, Dan Huang, Andrew Y. Ng, and Christopher Potts. 2011. Learning word vectors for sentiment analysis. In Proceedings of the 49th Annual Meeting of the Association for Computational Linguistics: Human Language Technologies - Volume 1 (HLT ’11). Association for Computational Linguistics, USA, 142–150</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/fastai/topic-modeling-with-matrix-decomposition/">Topic Modeling With Matrix Decomposition</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/fastai/topic-modeling-with-matrix-decomposition/" rel="bookmark"><time class="published dt-published" datetime="2019-12-28T17:11:58-08:00" itemprop="datePublished" title="2019-12-28 17:11">2019-12-28 17:11</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#orgcc42a88">Beginning</a>
<ul>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org017899d">Related Tutorials</a></li>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org2b61937">Imports</a>
<ul>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org8817ff4">Python</a></li>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org6642453">PyPi</a></li>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org80be2ee">Others</a></li>
</ul>
</li>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org4c6e0d1">Set Up</a>
<ul>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org1db3c3d">The Timer</a></li>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#orga3d4b53">Plotting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#orgbe9aa0d">Middle</a>
<ul>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org5983787">The Dataset</a>
<ul>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org37429cf">Vectorizing</a></li>
</ul>
</li>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org102acc5">Singular Value Decomposition (SVD)</a></li>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org1c5bd0f">Looking At Some Topics</a></li>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#orgac1b326">Non-negative Matrix Factorization (NMF)</a></li>
<li><a href="posts/fastai/topic-modeling-with-matrix-decomposition/#org8db11ad">Term-Frequency/Inverse Document Frequency</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgcc42a88">
<h2 id="orgcc42a88">Beginning</h2>
<div class="outline-text-2" id="text-orgcc42a88">
<p>This is part of a walk-through of the <a href="https://github.com/fastai/course-nlp">fastai Code-First Introduction to NLP</a>. In this post I'll be using <a href="https://www.wikiwand.com/en/Singular_value_decomposition">Singular Value Decomposition (SVD)</a> and <a href="https://www.wikiwand.com/en/Non-negative_matrix_factorization">Non-Negative Matrix Factorization (NMF)</a> to group <a href="https://scikit-learn.org/stable/datasets/index.html#newsgroups-dataset">newsgroup posts</a>. Both of these methods are statistical approaches that use the word-counts within documents to decide how similar they are (while ignoring things like word order).</p>
</div>
<div class="outline-3" id="outline-container-org017899d">
<h3 id="org017899d">Related Tutorials</h3>
<div class="outline-text-3" id="text-org017899d">
<ul class="org-ul">
<li><a href="http://scikit-learn.org/stable/auto_examples/applications/plot_out_of_core_classification.html">Out-Of-Core Text Classification with sklearn</a></li>
<li><a href="https://de.dariah.eu/tatom/index.html)">Text Analysis with Topic Models for the Humanities and Social Sciences</a></li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org2b61937">
<h3 id="org2b61937">Imports</h3>
<div class="outline-text-3" id="text-org2b61937"></div>
<div class="outline-4" id="outline-container-org8817ff4">
<h4 id="org8817ff4">Python</h4>
<div class="outline-text-4" id="text-org8817ff4">
<div class="highlight">
<pre><span></span>from functools import partial
import random
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6642453">
<h4 id="org6642453">PyPi</h4>
<div class="outline-text-4" id="text-org6642453">
<div class="highlight">
<pre><span></span>from scipy import linalg
from sklearn import decomposition
from sklearn.datasets import fetch_20newsgroups
from sklearn.feature_extraction.text import CountVectorizer, TfidfVectorizer
import hvplot.pandas
import matplotlib.pyplot as pyplot
import numpy
import pandas
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org80be2ee">
<h4 id="org80be2ee">Others</h4>
<div class="outline-text-4" id="text-org80be2ee">
<div class="highlight">
<pre><span></span>from graeae import EmbedHoloviews, Timer
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org4c6e0d1">
<h3 id="org4c6e0d1">Set Up</h3>
<div class="outline-text-3" id="text-org4c6e0d1"></div>
<div class="outline-4" id="outline-container-org1db3c3d">
<h4 id="org1db3c3d">The Timer</h4>
<div class="outline-text-4" id="text-org1db3c3d">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga3d4b53">
<h4 id="orga3d4b53">Plotting</h4>
<div class="outline-text-4" id="text-orga3d4b53">
<div class="highlight">
<pre><span></span>Embed = partial(
    EmbedHoloviews,
    folder_path="../../files/posts/fastai/topic-modeling-with-matrix-decomposition")
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgbe9aa0d">
<h2 id="orgbe9aa0d">Middle</h2>
<div class="outline-text-2" id="text-orgbe9aa0d"></div>
<div class="outline-3" id="outline-container-org5983787">
<h3 id="org5983787">The Dataset</h3>
<div class="outline-text-3" id="text-org5983787">
<p>The dataset consists of ~18,000 newsgroup posts with 20 topics. To keep the computation down I'll only use a subset of the categories. I'm also going to only use the body of the posts.</p>
<div class="highlight">
<pre><span></span>keep = ("alt.atheism", "comp.graphics", "misc.forsale", "sci.crypt", "talk.politics.guns")
remove = ("headers", "footers", "quotes")
training = fetch_20newsgroups(subset="train", categories=keep, remove=remove)
testing = fetch_20newsgroups(subset="test", categories=keep, remove=remove)
</pre></div>
<p>I've run this more than once so there's no output, but the first time you run the <code>fetch_20newsgroups</code> function it downloads the dataset and you'll see some output mentioning this fact.</p>
<div class="highlight">
<pre><span></span>print(f"{training.filenames.shape[0]:,}")
print(f"{training.target.shape[0]:,}")
</pre></div>
<pre class="example">
2,790
2,790
</pre>
<p>So, although the entire dataset has over 18,000 entries, our sub-set has fewer than 3,000.</p>
<div class="highlight">
<pre><span></span>print(numpy.unique(training.target))
</pre></div>
<pre class="example">
[0 1 2 3 4]
</pre>
<p>So the categories don't seem to be preserved (I'm assuming that the five I kept weren't the first five in the original set) so you have to check anytime you pull a subset out of the data.</p>
<p>Lets see what one of the posts looks like.</p>
<div class="highlight">
<pre><span></span>print(random.choice(training.data))
</pre></div>
<pre class="example">
      Just a question. 
      As a provider of a public BBS service - aren't you bound by law to gurantee
      intelligble access to the data of the users on the BBS, if police comes
      with sufficent authorisation ? I guessed this would be  a basic condition
      for such systems. (I did run a bbs some time ago, but that was in Switzerland)

The US doesn't yet have many laws covering BBSs - they're not common carriers,
they're not phone companies, they're just private machines or services
operated by businesses.  There's no obligation to keep records.
As Perry Metzger points out, if the police come with a search warrant,
you have to let them see what the warrant demands, if it exists,
and they generally can confiscate the equipment as "evidence"
(which is not Constitutionally valid, but we're only beginning to
develop court cases supporting us).  A court MAY be able to compel
you to tell them information you know, such as the encryption password
for the disk - there aren't any definitive cases yet, since it's a new
situation, and there probably aren't laws specifically covering it.
But the court can't force you to *know* the keys, and there are no
laws preventing you from allowing your users to have their own keys
for their own files without giving them to you.

Even in areas that do have established law, there is uncertainty.
There was a guy in Idaho a few years ago who had his business records
subpoenaed as evidence for taxes or some other business-restriction law,
so he gave the court the records.  Which were in Hebrew.
The US doesn't have laws forcing you to keep your records in English,
and these were the originals of the records.  HE didn't speak Hebrew,
and neither did anybody in the court organization.  Don't think they
were able to do much about it.

It might be illegal for your BBS to deny access to potential customers
based on race, religion, national origin, gender, or sexual preference;
it probably hasn't been tested in court, but it seems like a plausible
extension of anti-discrimination laws affecting other businesses.
</pre></div>
<div class="outline-4" id="outline-container-org37429cf">
<h4 id="org37429cf">Vectorizing</h4>
<div class="outline-text-4" id="text-org37429cf">
<p>Here we'll convert the text to a matrix using <a href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.CountVectorizer.html">sklearn's CountVectorizer</a>. Interestingly, the <a href="https://nlp.stanford.edu/IR-book/html/htmledition/dropping-common-terms-stop-words-1.html">Introduction to Information Retrieval</a> book says the the trend has been towards not removing the most common words (<i>stop word</i>) but we'll be dropping them. There's a paper called <a href="https://www.aclweb.org/anthology/W18-2502/">Stop Word Lists in Free Open-source Software Packages</a> which points out some problems with stop-word lists in general, but sklearn's list in particular. I don't know if sklearn has done anything to address their concerns since the paper came out, but the sklearn documentation includes a link to the paper so I would assume the problems are still there. Nonetheless, the fastai examples uses them so I will too.</p>
<div class="highlight">
<pre><span></span>vectorizer = CountVectorizer(stop_words="english")
</pre></div>
<p>The function we'le going to use doesn't accept the sparse matrices that are output by default so we'll make it a dense matrix after it's fit.</p>
<div class="highlight">
<pre><span></span>with TIMER:
    vectors = vectorizer.fit_transform(training.data).todense()
</pre></div>
<pre class="example">
2020-01-01 16:26:48,048 graeae.timers.timer start: Started: 2020-01-01 16:26:48.047927
2020-01-01 16:26:48,466 graeae.timers.timer end: Ended: 2020-01-01 16:26:48.466285
2020-01-01 16:26:48,466 graeae.timers.timer end: Elapsed: 0:00:00.418358
</pre>
<p>That was much quicker than I thought it would be, probably because our dataset is so small.</p>
<div class="highlight">
<pre><span></span>vocabulary = vectorizer.get_feature_names()
print(f"{len(vocabulary):,}")
</pre></div>
<pre class="example">
34,632
</pre>
<p>So our "vocabulary" is around 35,000 tokens.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org102acc5">
<h3 id="org102acc5">Singular Value Decomposition (SVD)</h3>
<div class="outline-text-3" id="text-org102acc5">
<p>Singular Value Decomposition is a linear algebra method to factor a matrix. The math is beyond me at this point, so I'll just try using it as a black box.</p>
<div class="highlight">
<pre><span></span>with TIMER:
    U, s, V = linalg.svd(vectors, full_matrices=False)
</pre></div>
<pre class="example">
2020-01-01 16:26:50,508 graeae.timers.timer start: Started: 2020-01-01 16:26:50.508003
2020-01-01 16:27:23,979 graeae.timers.timer end: Ended: 2020-01-01 16:27:23.978988
2020-01-01 16:27:23,980 graeae.timers.timer end: Elapsed: 0:00:33.470985
</pre>
<div class="highlight">
<pre><span></span>s_frame = pandas.Series(s)
plot = s_frame.hvplot().opts(title="Diagonal Matrix S", width=1000, height=800)
Embed(plot=plot, file_name="s_values")()
</pre></div>
<object data="posts/fastai/topic-modeling-with-matrix-decomposition/s_values.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
<div class="outline-3" id="outline-container-org1c5bd0f">
<h3 id="org1c5bd0f">Looking At Some Topics</h3>
<div class="outline-text-3" id="text-org1c5bd0f">
<div class="highlight">
<pre><span></span>top_words_count = 8

def top_words(token):
    return [vocabulary[index] for index in numpy.argsort(token)[: -top_words_count - 1: -1]]

def show_topics(array):
    topic_words = ([top_words(topic) for topic in array])
    return [' '.join(topic) for topic in topic_words]
</pre></div>
<div class="highlight">
<pre><span></span>topics = show_topics(V[:10])
for index, topic in enumerate(topics):
    print(f"{index}: {topic}")
</pre></div>
<pre class="example">
0: propagandist heliocentric galacticentric surname sandvik 400included wovy imaginative
1: file jpeg image edu pub ftp use graphics
2: file gun congress firearms control mr states rkba
3: privacy internet anonymous pub email information eff mail
4: graphics edu 128 3d ray pub data ftp
5: 00 50 40 appears dos 10 art 25
6: privacy internet 00 jpeg eff pub email electronic
7: key data image encryption des chip available law
8: pub key jesus jpeg eff graphics encryption ripem
9: key encryption edu des anonymous posting chip graphics
</pre>
<p>So what we're showing is the most significant words for the top-ten most strongly grouped "topics". It takes a little bit of interpretation to figure out how to map them to the newsgroups we used, and there probably could have been some clean-up of the texts (entry 5 looks suspect) but it's interesting that this linear algebra decomposition method could find these similar groups without any kind of prompting as to what groups might even exist in the first place (this is an unsupervised method, not a supervised method).</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgac1b326">
<h3 id="orgac1b326">Non-negative Matrix Factorization (NMF)</h3>
<div class="outline-text-3" id="text-orgac1b326">
<div class="highlight">
<pre><span></span>number_of_topics = 5
classifier = decomposition.NMF(n_components=number_of_topics, random_state=1)
weights = classifier.fit_transform(vectors)
classified = classifier.components_
for index, topic in enumerate(show_topics(classified)):
    print(f"{index}: {topic}")
</pre></div>
<pre class="example">
0: db mov bh si cs byte al bl
1: privacy internet anonymous information email eff use pub
2: file gun congress control firearms states mr united
3: jpeg image gif file color images format quality
4: edu graphics pub image data ftp mail available
</pre></div>
</div>
<div class="outline-3" id="outline-container-org8db11ad">
<h3 id="org8db11ad">Term-Frequency/Inverse Document Frequency</h3>
<div class="outline-text-3" id="text-org8db11ad">
<div class="highlight">
<pre><span></span>tfidf_vectorizer = TfidfVectorizer(stop_words="english")
tfidf_vectors = tfidf_vectorizer.fit_transform(training.data)
weights = classifier.fit_transform(tfidf_vectors)
classified = classifier.components_

for index, topic in enumerate(show_topics(classified)):
    print(f"{index}: {topic}")
</pre></div>
<pre class="example">
0: people gun don think just guns right government
1: 00 sale offer shipping new drive price condition
2: key chip encryption clipper keys escrow government algorithm
3: graphics thanks file files image program know windows
4: god atheism believe does atheists belief said exist
</pre></div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/link-collection/">Link-Collection</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/link-collection/" rel="bookmark"><time class="published dt-published" datetime="2019-12-28T16:12:17-08:00" itemprop="datePublished" title="2019-12-28 16:12">2019-12-28 16:12</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/link-collection/#org05319f8">Machine Learning</a>
<ul>
<li><a href="posts/link-collection/#org0cc535d">Blogs</a></li>
</ul>
</li>
<li><a href="posts/link-collection/#org290a5fb">Visualization</a></li>
<li><a href="posts/link-collection/#org41954d1">Natural Language Processing</a>
<ul>
<li><a href="posts/link-collection/#org84ed324">Books</a></li>
<li><a href="posts/link-collection/#orgbcbd6e9">Blogs</a></li>
<li><a href="posts/link-collection/#orgb9e2be6">Code</a>
<ul>
<li><a href="posts/link-collection/#org678818e">FaceBook</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org05319f8">
<h2 id="org05319f8">Machine Learning</h2>
<div class="outline-text-2" id="text-org05319f8"></div>
<div class="outline-3" id="outline-container-org0cc535d">
<h3 id="org0cc535d">Blogs</h3>
<div class="outline-text-3" id="text-org0cc535d">
<ul class="org-ul">
<li><a href="https://smerity.com/">Smerity</a></li>
</ul>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org290a5fb">
<h2 id="org290a5fb">Visualization</h2>
<div class="outline-text-2" id="text-org290a5fb">
<ul class="org-ul">
<li><a href="https://jalammar.github.io/">Jay Alamar</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org41954d1">
<h2 id="org41954d1">Natural Language Processing</h2>
<div class="outline-text-2" id="text-org41954d1"></div>
<div class="outline-3" id="outline-container-org84ed324">
<h3 id="org84ed324">Books</h3>
<div class="outline-text-3" id="text-org84ed324">
<ul class="org-ul">
<li><a href="https://web.stanford.edu/~jurafsky/slp3/">Speech and Language Processing</a> by <a href="https://web.stanford.edu/~jurafsky/">Dan Jurafsky</a> and <a href="https://www.cs.colorado.edu/~martin/">James H. Martin</a></li>
<li><a href="https://nlp.stanford.edu/IR-book/">Introduction to Information Retrieval</a> by Christopher D. Manning, Prabhakar Raghavan & Hinrich Schutze</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgbcbd6e9">
<h3 id="orgbcbd6e9">Blogs</h3>
<div class="outline-text-3" id="text-orgbcbd6e9">
<ul class="org-ul">
<li><a href="https://ruder.io/">Sebastian Ruder</a></li>
<li><a href="http://www.abigailsee.com/">Abigail See</a></li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgb9e2be6">
<h3 id="orgb9e2be6">Code</h3>
<div class="outline-text-3" id="text-orgb9e2be6"></div>
<div class="outline-4" id="outline-container-org678818e">
<h4 id="org678818e">FaceBook</h4>
<div class="outline-text-4" id="text-org678818e">
<ul class="org-ul">
<li><a href="https://github.com/facebookresearch/pytext">pytext</a></li>
<li><a href="https://fasttext.cc/">fastText</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/keras/nlp-classification-exercise/">NLP Classification Exercise</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/keras/nlp-classification-exercise/" rel="bookmark"><time class="published dt-published" datetime="2019-09-29T11:28:06-07:00" itemprop="datePublished" title="2019-09-29 11:28">2019-09-29 11:28</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/keras/nlp-classification-exercise/#orgcc7a40a">Beginning</a>
<ul>
<li><a href="posts/keras/nlp-classification-exercise/#org99aafa9">Imports</a>
<ul>
<li><a href="posts/keras/nlp-classification-exercise/#org90c0e9c">Python</a></li>
<li><a href="posts/keras/nlp-classification-exercise/#orgccaf826">PyPi</a></li>
<li><a href="posts/keras/nlp-classification-exercise/#orged3c701">Others</a></li>
</ul>
</li>
<li><a href="posts/keras/nlp-classification-exercise/#orgf2f1da1">Set Up</a>
<ul>
<li><a href="posts/keras/nlp-classification-exercise/#org3e15f2d">The Timer</a></li>
<li><a href="posts/keras/nlp-classification-exercise/#org6ec6994">The Plotting</a></li>
<li><a href="posts/keras/nlp-classification-exercise/#org0763649">The Dataset</a></li>
<li><a href="posts/keras/nlp-classification-exercise/#orgbaa7960">Some Constants</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/keras/nlp-classification-exercise/#orgebf14ac">Middle</a>
<ul>
<li><a href="posts/keras/nlp-classification-exercise/#orgb798cf2">The Data</a></li>
<li><a href="posts/keras/nlp-classification-exercise/#org49b4ce4">The Tokenizer</a></li>
<li><a href="posts/keras/nlp-classification-exercise/#org5e663e6">GloVe</a></li>
<li><a href="posts/keras/nlp-classification-exercise/#org1326f09">The Models</a>
<ul>
<li><a href="posts/keras/nlp-classification-exercise/#org499416e">A CNN</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/keras/nlp-classification-exercise/#org89b9f5c">End</a>
<ul>
<li><a href="posts/keras/nlp-classification-exercise/#orgbd104fe">Citations</a></li>
</ul>
</li>
<li><a href="posts/keras/nlp-classification-exercise/#org1087fd3">Raw</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgcc7a40a">
<h2 id="orgcc7a40a">Beginning</h2>
<div class="outline-text-2" id="text-orgcc7a40a"></div>
<div class="outline-3" id="outline-container-org99aafa9">
<h3 id="org99aafa9">Imports</h3>
<div class="outline-text-3" id="text-org99aafa9"></div>
<div class="outline-4" id="outline-container-org90c0e9c">
<h4 id="org90c0e9c">Python</h4>
<div class="outline-text-4" id="text-org90c0e9c">
<div class="highlight">
<pre><span></span>from argparse import Namespace
from functools import partial
from pathlib import Path
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgccaf826">
<h4 id="orgccaf826">PyPi</h4>
<div class="outline-text-4" id="text-orgccaf826">
<div class="highlight">
<pre><span></span>from sklearn.model_selection import train_test_split
from tensorflow.keras.preprocessing.sequence import pad_sequences
from tensorflow.keras.preprocessing.text import Tokenizer
import hvplot.pandas
import numpy
import pandas
import tensorflow
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orged3c701">
<h4 id="orged3c701">Others</h4>
<div class="outline-text-4" id="text-orged3c701">
<div class="highlight">
<pre><span></span>from graeae import (CountPercentage,
                    EmbedHoloviews,
                    SubPathLoader,
                    Timer,
                    ZipDownloader)
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf2f1da1">
<h3 id="orgf2f1da1">Set Up</h3>
<div class="outline-text-3" id="text-orgf2f1da1"></div>
<div class="outline-4" id="outline-container-org3e15f2d">
<h4 id="org3e15f2d">The Timer</h4>
<div class="outline-text-4" id="text-org3e15f2d">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6ec6994">
<h4 id="org6ec6994">The Plotting</h4>
<div class="outline-text-4" id="text-org6ec6994">
<div class="highlight">
<pre><span></span>slug = "nlp-classification-exercise"
Embed = partial(EmbedHoloviews, folder_path=f"../../files/posts/keras/{slug}")
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0763649">
<h4 id="org0763649">The Dataset</h4>
<div class="outline-text-4" id="text-org0763649">
<p>It isn't mentioned in the notebook where the data originally came from, but it looks like it's the <a href="http://help.sentiment140.com/home">Sentiment140</a> dataset, which consists of tweets whose sentiment was inferred by emoticons in each tweet.</p>
<div class="highlight">
<pre><span></span>url = "http://cs.stanford.edu/people/alecmgo/trainingandtestdata.zip"
path = Path("~/data/datasets/texts/sentiment140/").expanduser()
download = ZipDownloader(url, path)
download()
</pre></div>
<pre class="example">
Files exist, not downloading
</pre>
<div class="highlight">
<pre><span></span>columns = ["polarity", "tweet_id", "datetime", "query", "user", "text"]
training = pandas.read_csv(path/"training.1600000.processed.noemoticon.csv", 
                           encoding="latin-1", names=columns, header=None)
testing = pandas.read_csv(path/"testdata.manual.2009.06.14.csv", 
                           encoding="latin-1", names=columns, header=None)
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgbaa7960">
<h4 id="orgbaa7960">Some Constants</h4>
<div class="outline-text-4" id="text-orgbaa7960">
<div class="highlight">
<pre><span></span>Text = Namespace(
    embedding_dim = 100,
    max_length = 16,
    trunc_type='post',
    padding_type='post',
    oov_tok = "&lt;OOV&gt;",
    training_size=16000,
)
</pre></div>
<div class="highlight">
<pre><span></span>Data = Namespace(
    batch_size = 64,
    shuffle_buffer_size=100,
)
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgebf14ac">
<h2 id="orgebf14ac">Middle</h2>
<div class="outline-text-2" id="text-orgebf14ac"></div>
<div class="outline-3" id="outline-container-orgb798cf2">
<h3 id="orgb798cf2">The Data</h3>
<div class="outline-text-3" id="text-orgb798cf2">
<div class="highlight">
<pre><span></span>print(training.sample().iloc[0])
</pre></div>
<pre class="example">
polarity                                                    4
tweet_id                                           1468852290
datetime                         Tue Apr 07 04:04:10 PDT 2009
query                                                NO_QUERY
user                                              leawoodward
text        Def off now...unexpected day out tomorrow so s...
Name: 806643, dtype: object
</pre>
<div class="highlight">
<pre><span></span>CountPercentage(training.polarity)()
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-left">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">Value</th>
<th class="org-left" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">4</td>
<td class="org-left">800,000</td>
<td class="org-right">50.00</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-left">800,000</td>
<td class="org-right">50.00</td>
</tr>
</tbody>
</table>
<p>The <code>polarity</code> is what might also be called the "sentiment" of the tweet - <i>0</i> means a negative tweet and <i>4</i> means a positive tweet.</p>
<p>But, for our purposes, we would be better off if the positive polarity was <code>1</code>, not <code>4</code>, so let's convert it.</p>
<div class="highlight">
<pre><span></span>training.loc[training.polarity==4, "polarity"] = 1
counts = CountPercentage(training.polarity)()
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-left">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">Value</th>
<th class="org-left" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">800,000</td>
<td class="org-right">50.00</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-left">800,000</td>
<td class="org-right">50.00</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="outline-3" id="outline-container-org49b4ce4">
<h3 id="org49b4ce4">The Tokenizer</h3>
<div class="outline-text-3" id="text-org49b4ce4">
<p>As you can see from the sample, the data is still in text form so we need to convert it to a numeric form with a Tokenizer.</p>
<p>First I'll Lower-case it.</p>
<div class="highlight">
<pre><span></span>training.loc[:, "text"] = training.text.str.lower()
</pre></div>
<p>Next we'll fit it to our text.</p>
<div class="highlight">
<pre><span></span>tokenizer = Tokenizer()
with TIMER:
    tokenizer.fit_on_texts(training.text.values)
</pre></div>
<pre class="example">
2019-10-10 07:25:09,065 graeae.timers.timer start: Started: 2019-10-10 07:25:09.065039
WARNING: Logging before flag parsing goes to stderr.
I1010 07:25:09.065394 140436771002176 timer.py:70] Started: 2019-10-10 07:25:09.065039
2019-10-10 07:25:45,389 graeae.timers.timer end: Ended: 2019-10-10 07:25:45.389540
I1010 07:25:45.389598 140436771002176 timer.py:77] Ended: 2019-10-10 07:25:45.389540
2019-10-10 07:25:45,391 graeae.timers.timer end: Elapsed: 0:00:36.324501
I1010 07:25:45.391984 140436771002176 timer.py:78] Elapsed: 0:00:36.324501
</pre>
<p>Now, we can store some of it's values in variables for convenience.</p>
<div class="highlight">
<pre><span></span>word_index = tokenizer.word_index
vocabulary_size = len(tokenizer.word_index)
</pre></div>
<p>Now, we'll convert the texts to sequences and pad them so they are all the same length.</p>
<div class="highlight">
<pre><span></span>with TIMER:
    sequences = tokenizer.texts_to_sequences(training.text.values)
    padded = pad_sequences(sequences, maxlen=Text.max_length,
                           truncating=Text.trunc_type)

    splits = train_test_split(
        padded, training.polarity, test_size=.2)

    training_sequences, test_sequences, training_labels, test_labels = splits
</pre></div>
<pre class="example">
2019-10-10 07:25:51,057 graeae.timers.timer start: Started: 2019-10-10 07:25:51.057684
I1010 07:25:51.057712 140436771002176 timer.py:70] Started: 2019-10-10 07:25:51.057684
2019-10-10 07:26:33,530 graeae.timers.timer end: Ended: 2019-10-10 07:26:33.530338
I1010 07:26:33.530381 140436771002176 timer.py:77] Ended: 2019-10-10 07:26:33.530338
2019-10-10 07:26:33,531 graeae.timers.timer end: Elapsed: 0:00:42.472654
I1010 07:26:33.531477 140436771002176 timer.py:78] Elapsed: 0:00:42.472654
</pre>
<p>Now convert them to <a href="https://www.tensorflow.org/tutorials/load_data/numpy">datasets</a>.</p>
<div class="highlight">
<pre><span></span>training_dataset = tensorflow.data.Dataset.from_tensor_slices(
    (training_sequences, training_labels)
)

testing_dataset = tensorflow.data.Dataset.from_tensor_slices(
    (test_sequences, test_labels)
)

training_dataset = training_dataset.shuffle(Data.shuffle_buffer_size).batch(Data.batch_size)
testing_dataset = testing_dataset.shuffle(Data.shuffle_buffer_size).batch(Data.batch_size)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org5e663e6">
<h3 id="org5e663e6">GloVe</h3>
<div class="outline-text-3" id="text-org5e663e6">
<p>GloVe is short for <i>Global Vectors for Word Representation</i>. It is an <i>unsupervised</i> algorithm that creates vector representations for words. They have a <a href="https://nlp.stanford.edu/projects/glove/">site</a> where you can download pre-trained models or get the code and train one yourself. We're going to use one of their pre-trained models.</p>
<div class="highlight">
<pre><span></span>path = Path("~/models/glove/").expanduser()
url = "http://nlp.stanford.edu/data/glove.6B.zip"
ZipDownloader(url, path)()
</pre></div>
<pre class="example">
Files exist, not downloading
</pre>
<p>The GloVe data is stored as a series of space separated lines with the first column being the word that's encoded and the rest of the columns being the values for the vector. To make this work we're going to split the word off from the vector and put each into a dictionary.</p>
<div class="highlight">
<pre><span></span>embeddings = {}
with TIMER:
    with open(path/"glove.6B.100d.txt") as lines:
        for line in lines:
            tokens = line.split()
            embeddings[tokens[0]] = numpy.array(tokens[1:])
</pre></div>
<pre class="example">
2019-10-06 18:55:11,592 graeae.timers.timer start: Started: 2019-10-06 18:55:11.592880
I1006 18:55:11.592908 140055379531584 timer.py:70] Started: 2019-10-06 18:55:11.592880
2019-10-06 18:55:21,542 graeae.timers.timer end: Ended: 2019-10-06 18:55:21.542689
I1006 18:55:21.542738 140055379531584 timer.py:77] Ended: 2019-10-06 18:55:21.542689
2019-10-06 18:55:21,544 graeae.timers.timer end: Elapsed: 0:00:09.949809
I1006 18:55:21.544939 140055379531584 timer.py:78] Elapsed: 0:00:09.949809
</pre>
<div class="highlight">
<pre><span></span>print(f"{len(embeddings):,}")
</pre></div>
<pre class="example">
400,000
</pre>
<p>So, our vocabulary consists of 400,000 "words" (tokens is more accurate, since they also include punctuation). The problem we have to deal with next is that our data set wasn't part of the dataset used to train the embeddings, so there will probably be some tokens in our data set that aren't in the embeddings. To handle this we need to add zeroed embeddings for the extra tokens.</p>
<p>Rather than adding to the dict, we'll create a matrix of zeros with rows for each word in our datasets vocabulary, then we'll iterate over the words in our dataset and if there's a match in the GloVE embeddings we'll insert it into the matrix.</p>
<div class="highlight">
<pre><span></span>with TIMER:
    embeddings_matrix = numpy.zeros((vocabulary_size+1, Text.embedding_dim));
    for word, index in word_index.items():
        embedding_vector = embeddings.get(word);
        if embedding_vector is not None:
            embeddings_matrix[index] = embedding_vector;
</pre></div>
<pre class="example">
2019-10-06 18:55:46,577 graeae.timers.timer start: Started: 2019-10-06 18:55:46.577855
I1006 18:55:46.577886 140055379531584 timer.py:70] Started: 2019-10-06 18:55:46.577855
2019-10-06 18:55:51,374 graeae.timers.timer end: Ended: 2019-10-06 18:55:51.374706
I1006 18:55:51.374763 140055379531584 timer.py:77] Ended: 2019-10-06 18:55:51.374706
2019-10-06 18:55:51,377 graeae.timers.timer end: Elapsed: 0:00:04.796851
I1006 18:55:51.377207 140055379531584 timer.py:78] Elapsed: 0:00:04.796851
</pre>
<div class="highlight">
<pre><span></span>print(f"{len(embeddings_matrix):,}")
</pre></div>
<pre class="example">
690,961
</pre></div>
</div>
<div class="outline-3" id="outline-container-org1326f09">
<h3 id="org1326f09">The Models</h3>
<div class="outline-text-3" id="text-org1326f09"></div>
<div class="outline-4" id="outline-container-org499416e">
<h4 id="org499416e">A CNN</h4>
<div class="outline-text-4" id="text-org499416e"></div>
<ul class="org-ul">
<li><a id="orgb0b3381"></a>Build<br>
<div class="outline-text-5" id="text-orgb0b3381">
<div class="highlight">
<pre><span></span>convoluted_model = tensorflow.keras.Sequential([
    tensorflow.keras.layers.Embedding(
        vocabulary_size + 1,
        Text.embedding_dim,
        input_length=Text.max_length,
        weights=[embeddings_matrix],
        trainable=False),
    tensorflow.keras.layers.Conv1D(filters=128,
                                   kernel_size=5,
    activation='relu'),
    tensorflow.keras.layers.GlobalMaxPooling1D(),
    tensorflow.keras.layers.Dense(24, activation='relu'),
    tensorflow.keras.layers.Dense(1, activation='sigmoid')
])
convoluted_model.compile(loss="binary_crossentropy", optimizer="rmsprop",
                         metrics=["accuracy"])
</pre></div>
<div class="highlight">
<pre><span></span>print(convoluted_model.summary())
</pre></div>
<pre class="example">
Model: "sequential"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
embedding (Embedding)        (None, 16, 100)           69096100  
_________________________________________________________________
conv1d (Conv1D)              (None, 12, 128)           64128     
_________________________________________________________________
global_max_pooling1d (Global (None, 128)               0         
_________________________________________________________________
dense (Dense)                (None, 24)                3096      
_________________________________________________________________
dense_1 (Dense)              (None, 1)                 25        
=================================================================
Total params: 69,163,349
Trainable params: 67,249
Non-trainable params: 69,096,100
_________________________________________________________________
None
</pre></div>
</li>
<li><a id="org727fa38"></a>Train<br>
<div class="outline-text-5" id="text-org727fa38">
<div class="highlight">
<pre><span></span>Training = Namespace(
    size = 0.75,
    epochs = 2,
    verbosity = 2,
    batch_size=128,
    )
</pre></div>
<div class="highlight">
<pre><span></span>with TIMER:
    cnn_history = convoluted_model.fit(training_dataset,
                                       epochs=Training.epochs,
                                       validation_data=testing_dataset,
                                       verbose=Training.verbosity)
</pre></div>
<pre class="example">
2019-10-10 07:27:04,921 graeae.timers.timer start: Started: 2019-10-10 07:27:04.921617
I1010 07:27:04.921657 140436771002176 timer.py:70] Started: 2019-10-10 07:27:04.921617
Epoch 1/2
W1010 07:27:05.154920 140436771002176 deprecation.py:323] From /home/hades/.virtualenvs/In-Too-Deep/lib/python3.7/site-packages/tensorflow_core/python/ops/nn_impl.py:183: where (from tensorflow.python.ops.array_ops) is deprecated and will be removed in a future version.
Instructions for updating:
Use tf.where in 2.0, which has the same broadcast rule as np.where
20000/20000 - 4964s - loss: 0.5091 - accuracy: 0.7454 - val_loss: 0.0000e+00 - val_accuracy: 0.0000e+00
Epoch 2/2
20000/20000 - 4935s - loss: 0.4790 - accuracy: 0.7671 - val_loss: 0.4782 - val_accuracy: 0.7677
2019-10-10 10:12:04,382 graeae.timers.timer end: Ended: 2019-10-10 10:12:04.382359
I1010 10:12:04.382491 140436771002176 timer.py:77] Ended: 2019-10-10 10:12:04.382359
2019-10-10 10:12:04,384 graeae.timers.timer end: Elapsed: 2:44:59.460742
I1010 10:12:04.384716 140436771002176 timer.py:78] Elapsed: 2:44:59.460742
</pre></div>
</li>
<li><a id="org70929a6"></a>Some Plotting<br>
<div class="outline-text-5" id="text-org70929a6">
<div class="highlight">
<pre><span></span>performance = pandas.DataFrame(cnn_history.history)
plot = performance.hvplot().opts(title="CNN Twitter Sentiment Training Performance",
                                 width=1000,
                                 height=800)
Embed(plot=plot, file_name="cnn_training")()
</pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org89b9f5c">
<h2 id="org89b9f5c">End</h2>
<div class="outline-text-2" id="text-org89b9f5c"></div>
<div class="outline-3" id="outline-container-orgbd104fe">
<h3 id="orgbd104fe">Citations</h3>
<div class="outline-text-3" id="text-orgbd104fe">
<ul class="org-ul">
<li>Jeffrey Pennington, Richard Socher, and Christopher D. Manning. 2014. GloVe: Global Vectors for Word Representation.</li>
</ul>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org1087fd3">
<h2 id="org1087fd3">Raw</h2>
<div class="outline-text-2" id="text-org1087fd3"></div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/keras/embeddings-from-scratch/">Embeddings from Scratch</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/keras/embeddings-from-scratch/" rel="bookmark"><time class="published dt-published" datetime="2019-09-25T13:30:12-07:00" itemprop="datePublished" title="2019-09-25 13:30">2019-09-25 13:30</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/keras/embeddings-from-scratch/#org36703a7">Beginning</a>
<ul>
<li><a href="posts/keras/embeddings-from-scratch/#org5e847b9">Imports</a>
<ul>
<li><a href="posts/keras/embeddings-from-scratch/#org6799f24">Python</a></li>
<li><a href="posts/keras/embeddings-from-scratch/#org2a31186">PyPi</a></li>
<li><a href="posts/keras/embeddings-from-scratch/#org549b335">Others</a></li>
</ul>
</li>
<li><a href="posts/keras/embeddings-from-scratch/#org14d6663">Set Up</a>
<ul>
<li><a href="posts/keras/embeddings-from-scratch/#orgc519669">Plotting</a></li>
<li><a href="posts/keras/embeddings-from-scratch/#org7709906">The Timer</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/keras/embeddings-from-scratch/#orgaa4642a">Middle</a>
<ul>
<li><a href="posts/keras/embeddings-from-scratch/#org8dbebf6">Some Constants</a></li>
<li><a href="posts/keras/embeddings-from-scratch/#orga7da17a">The Embeddings Layer</a></li>
<li><a href="posts/keras/embeddings-from-scratch/#orgcb08c95">The Dataset</a>
<ul>
<li><a href="posts/keras/embeddings-from-scratch/#org2d1bce9">Add Padding</a></li>
<li><a href="posts/keras/embeddings-from-scratch/#orgbd10cb3">Checkout a Sample</a></li>
</ul>
</li>
<li><a href="posts/keras/embeddings-from-scratch/#org78e6236">Build a Model</a></li>
<li><a href="posts/keras/embeddings-from-scratch/#orgcbaab4f">Compile and Train</a></li>
</ul>
</li>
<li><a href="posts/keras/embeddings-from-scratch/#org4e23e84">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org36703a7">
<h2 id="org36703a7">Beginning</h2>
<div class="outline-text-2" id="text-org36703a7">
<p>This is a walk-through of the tensorflow <a href="https://www.tensorflow.org/beta/tutorials/text/word_embeddings">Word Embeddings</a> tutorial, just to make sure I can do it.</p>
</div>
<div class="outline-3" id="outline-container-org5e847b9">
<h3 id="org5e847b9">Imports</h3>
<div class="outline-text-3" id="text-org5e847b9"></div>
<div class="outline-4" id="outline-container-org6799f24">
<h4 id="org6799f24">Python</h4>
<div class="outline-text-4" id="text-org6799f24">
<div class="highlight">
<pre><span></span>from argparse import Namespace
from functools import partial
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2a31186">
<h4 id="org2a31186">PyPi</h4>
<div class="outline-text-4" id="text-org2a31186">
<div class="highlight">
<pre><span></span>from tensorflow import keras
from tensorflow.keras import layers
import hvplot.pandas
import pandas
import tensorflow
import tensorflow_datasets
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org549b335">
<h4 id="org549b335">Others</h4>
<div class="outline-text-4" id="text-org549b335">
<div class="highlight">
<pre><span></span>from graeae import EmbedHoloviews, Timer
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org14d6663">
<h3 id="org14d6663">Set Up</h3>
<div class="outline-text-3" id="text-org14d6663"></div>
<div class="outline-4" id="outline-container-orgc519669">
<h4 id="orgc519669">Plotting</h4>
<div class="outline-text-4" id="text-orgc519669">
<div class="highlight">
<pre><span></span>prefix = "../../files/posts/keras/"
slug = "embeddings-from-scratch"

Embed = partial(EmbedHoloviews, folder_path=f"{prefix}{slug}")
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7709906">
<h4 id="org7709906">The Timer</h4>
<div class="outline-text-4" id="text-org7709906">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgaa4642a">
<h2 id="orgaa4642a">Middle</h2>
<div class="outline-text-2" id="text-orgaa4642a"></div>
<div class="outline-3" id="outline-container-org8dbebf6">
<h3 id="org8dbebf6">Some Constants</h3>
<div class="outline-text-3" id="text-org8dbebf6">
<div class="highlight">
<pre><span></span>Text = Namespace(
    vocabulary_size=1000,
    embeddings_size=16,
    max_length=500,
    padding="post",
)

Tokens = Namespace(
    padding = "&lt;PAD&gt;",
    start = "&lt;START&gt;",
    unknown = "&lt;UNKNOWN&gt;",
    unused = "&lt;UNUSED&gt;",
)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga7da17a">
<h3 id="orga7da17a">The Embeddings Layer</h3>
<div class="outline-text-3" id="text-orga7da17a">
<div class="highlight">
<pre><span></span>print(layers.Embedding.__doc__)
</pre></div>
<pre class="example">
Turns positive integers (indexes) into dense vectors of fixed size.

  e.g. `[[4], [20]] -&gt; [[0.25, 0.1], [0.6, -0.2]]`

  This layer can only be used as the first layer in a model.

  Example:

  ```python
  model = Sequential()
  model.add(Embedding(1000, 64, input_length=10))
  # the model will take as input an integer matrix of size (batch,
  # input_length).
  # the largest integer (i.e. word index) in the input should be no larger
  # than 999 (vocabulary size).
  # now model.output_shape == (None, 10, 64), where None is the batch
  # dimension.

  input_array = np.random.randint(1000, size=(32, 10))

  model.compile('rmsprop', 'mse')
  output_array = model.predict(input_array)
  assert output_array.shape == (32, 10, 64)
  ```

  Arguments:
    input_dim: int &gt; 0. Size of the vocabulary,
      i.e. maximum integer index + 1.
    output_dim: int &gt;= 0. Dimension of the dense embedding.
    embeddings_initializer: Initializer for the `embeddings` matrix.
    embeddings_regularizer: Regularizer function applied to
      the `embeddings` matrix.
    embeddings_constraint: Constraint function applied to
      the `embeddings` matrix.
    mask_zero: Whether or not the input value 0 is a special "padding"
      value that should be masked out.
      This is useful when using recurrent layers
      which may take variable length input.
      If this is `True` then all subsequent layers
      in the model need to support masking or an exception will be raised.
      If mask_zero is set to True, as a consequence, index 0 cannot be
      used in the vocabulary (input_dim should equal size of
      vocabulary + 1).
    input_length: Length of input sequences, when it is constant.
      This argument is required if you are going to connect
      `Flatten` then `Dense` layers upstream
      (without it, the shape of the dense outputs cannot be computed).

  Input shape:
    2D tensor with shape: `(batch_size, input_length)`.

  Output shape:
    3D tensor with shape: `(batch_size, input_length, output_dim)`.
  
</pre>
<div class="highlight">
<pre><span></span>embedding_layer = layers.Embedding(Text.vocabulary_size, Text.embeddings_size)
</pre></div>
<p>The first argument is the number of possible words in the vocabulary and the second is the number of dimensions. The Emebdding is a sort of lookup table that maps an integer that represents a word to a vector. In this case we're going to build a vocabulary of 1,000 words represented by vectors with a length of 32. The weights in the vectors are learned when we train the model and will encode the distance between words.</p>
<p>The input to the embeddings layer is a 2D tensor of integers with the shape (<code>number of samples</code>, <code>sequence_length</code>). The sequences are integer-encoded sentences of the same length - so you have to pad the shorter sentences to match the longest one (the <code>sequence_length</code>).</p>
<p>The ouput of the embeddings layer is a 3D tensor with the shape (<code>number of samples</code>, <code>sequence_length</code>, <code>embedding_dimensionality</code>).</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgcb08c95">
<h3 id="orgcb08c95">The Dataset</h3>
<div class="outline-text-3" id="text-orgcb08c95">
<div class="highlight">
<pre><span></span>(train_data, test_data), info = tensorflow_datasets.load(
    "imdb_reviews/subwords8k",
    split=(tensorflow_datasets.Split.TRAIN,
           tensorflow_datasets.Split.TEST),
    with_info=True, as_supervised=True)
</pre></div>
<div class="highlight">
<pre><span></span>encoder = info.features["text"].encoder
print(encoder.subwords[:10])
</pre></div>
<pre class="example">
['the_', ', ', '. ', 'a_', 'and_', 'of_', 'to_', 's_', 'is_', 'br']
</pre></div>
<div class="outline-4" id="outline-container-org2d1bce9">
<h4 id="org2d1bce9">Add Padding</h4>
<div class="outline-text-4" id="text-org2d1bce9">
<div class="highlight">
<pre><span></span>padded_shapes = ([None], ())
train_batches = train_data.shuffle(Text.vocabulary_size).padded_batch(
    10, padded_shapes=padded_shapes)
test_batches = test_data.shuffle(Text.vocabulary_size).padded_batch(
    10, padded_shapes=padded_shapes
)
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgbd10cb3">
<h4 id="orgbd10cb3">Checkout a Sample</h4>
<div class="outline-text-4" id="text-orgbd10cb3">
<div class="highlight">
<pre><span></span>batch, labels = next(iter(train_batches))
print(batch.numpy())
</pre></div>
<pre class="example">
[[  62    9    4 ...    0    0    0]
 [  19 2428    6 ...    0    0    0]
 [ 691    2  594 ... 7961 1457 7975]
 ...
 [6072 5644 8043 ...    0    0    0]
 [ 977   15   57 ...    0    0    0]
 [5646    2    1 ...    0    0    0]]
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org78e6236">
<h3 id="org78e6236">Build a Model</h3>
<div class="outline-text-3" id="text-org78e6236">
<div class="highlight">
<pre><span></span>model = keras.Sequential([
    layers.Embedding(encoder.vocab_size, Text.embeddings_size),
    layers.GlobalAveragePooling1D(),
    layers.Dense(1, activation="sigmoid")
])
</pre></div>
<div class="highlight">
<pre><span></span>print(model.summary())
</pre></div>
<pre class="example">
Model: "sequential"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
embedding_1 (Embedding)      (None, None, 16)          130960    
_________________________________________________________________
global_average_pooling1d (Gl (None, 16)                0         
_________________________________________________________________
dense (Dense)                (None, 1)                 17        
=================================================================
Total params: 130,977
Trainable params: 130,977
Non-trainable params: 0
_________________________________________________________________
None
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgcbaab4f">
<h3 id="orgcbaab4f">Compile and Train</h3>
<div class="outline-text-3" id="text-orgcbaab4f">
<div class="highlight">
<pre><span></span>model.compile(optimizer="adam", loss="binary_crossentropy", metrics=["accuracy"])
ONCE_PER_EPOCH = 2
with TIMER:
    history = model.fit(train_batches, epochs=10,
                        validation_data=test_batches,
                        verbose=ONCE_PER_EPOCH,
                        validation_steps=20)
</pre></div>
<pre class="example">
2019-09-28 17:14:52,764 graeae.timers.timer start: Started: 2019-09-28 17:14:52.764725
I0928 17:14:52.764965 140515023214400 timer.py:70] Started: 2019-09-28 17:14:52.764725
W0928 17:14:52.806057 140515023214400 deprecation.py:323] From /home/hades/.virtualenvs/In-Too-Deep/lib/python3.7/site-packages/tensorflow_core/python/ops/nn_impl.py:183: where (from tensorflow.python.ops.array_ops) is deprecated and will be removed in a future version.
Instructions for updating:
Use tf.where in 2.0, which has the same broadcast rule as np.where
Epoch 1/10
 val_loss: 0.3015 - val_accuracy: 0.8900
2019-09-28 17:17:36,036 graeae.timers.timer end: Ended: 2019-09-28 17:17:36.036090
I0928 17:17:36.036139 140515023214400 timer.py:77] Ended: 2019-09-28 17:17:36.036090
2019-09-28 17:17:36,037 graeae.timers.timer end: Elapsed: 0:02:43.271365
I0928 17:17:36.037808 140515023214400 timer.py:78] Elapsed: 0:02:43.271365
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org4e23e84">
<h2 id="org4e23e84">End</h2>
<div class="outline-text-2" id="text-org4e23e84">
<div class="highlight">
<pre><span></span>data = pandas.DataFrame(history.history)
plot = data.hvplot().opts(title="Training/Validation Performance",
                          width=1000,
                          height=800)
Embed(plot=plot, file_name="training")()
</pre></div>
<object data="posts/keras/embeddings-from-scratch/training.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Amazingly, even with such a simple model, it managed a 92 % validation accuracy.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/keras/imdb-lstm-with-tokenization/">IMDB GRU With Tokenization</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/keras/imdb-lstm-with-tokenization/" rel="bookmark"><time class="published dt-published" datetime="2019-09-23T14:14:04-07:00" itemprop="datePublished" title="2019-09-23 14:14">2019-09-23 14:14</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org00220f3">Beginning</a>
<ul>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org336a4cb">Imports</a>
<ul>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org7fa45f2">Python</a></li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#orgc6aff24">PyPi</a></li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org32a82e7">Other</a></li>
</ul>
</li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#orgb011395">Set Up</a>
<ul>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#orgfc9ef8b">The Timer</a></li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org3912ea2">Plotting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#orged6378f">Middle</a>
<ul>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org7b84880">Set Up the Data</a></li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#orgeae0db2">Building Up the Tokenizer</a>
<ul>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org33c8f9d">Split Up the Sentences and Their Labels</a></li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org695df13">Some Constants</a></li>
</ul>
</li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#orga066bfb">Build the Tokenizer</a></li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#orga0a237f">Decoder Ring</a></li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org0d0dd1d">Build the Model</a></li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#orgedd637a">Train it</a></li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org1d1575f">Plot It</a></li>
</ul>
</li>
<li><a href="posts/keras/imdb-lstm-with-tokenization/#org53150d6">Raw</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org00220f3">
<h2 id="org00220f3">Beginning</h2>
<div class="outline-text-2" id="text-org00220f3">
<p>This is another version of the RNN model to classify the IMDB reviews, but this time we're going to tokenize it ourselves and use a GRU, instead of using the tensorflow-datasets version.</p>
</div>
<div class="outline-3" id="outline-container-org336a4cb">
<h3 id="org336a4cb">Imports</h3>
<div class="outline-text-3" id="text-org336a4cb"></div>
<div class="outline-4" id="outline-container-org7fa45f2">
<h4 id="org7fa45f2">Python</h4>
<div class="outline-text-4" id="text-org7fa45f2">
<div class="highlight">
<pre><span></span>from argparse import Namespace
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc6aff24">
<h4 id="orgc6aff24">PyPi</h4>
<div class="outline-text-4" id="text-orgc6aff24">
<div class="highlight">
<pre><span></span>from tensorflow.keras.preprocessing.text import Tokenizer
from tensorflow.keras.preprocessing.sequence import pad_sequences

import hvplot.pandas
import numpy
import pandas
import tensorflow
import tensorflow_datasets
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org32a82e7">
<h4 id="org32a82e7">Other</h4>
<div class="outline-text-4" id="text-org32a82e7">
<div class="highlight">
<pre><span></span>from graeae import Timer, EmbedHoloviews
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb011395">
<h3 id="orgb011395">Set Up</h3>
<div class="outline-text-3" id="text-orgb011395"></div>
<div class="outline-4" id="outline-container-orgfc9ef8b">
<h4 id="orgfc9ef8b">The Timer</h4>
<div class="outline-text-4" id="text-orgfc9ef8b">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3912ea2">
<h4 id="org3912ea2">Plotting</h4>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orged6378f">
<h2 id="orged6378f">Middle</h2>
<div class="outline-text-2" id="text-orged6378f"></div>
<div class="outline-3" id="outline-container-org7b84880">
<h3 id="org7b84880">Set Up the Data</h3>
<div class="outline-text-3" id="text-org7b84880">
<div class="highlight">
<pre><span></span>imdb, info = tensorflow_datasets.load("imdb_reviews",
                                      with_info=True,
                                      as_supervised=True)
</pre></div>
<pre class="example">
WARNING: Logging before flag parsing goes to stderr.
W0924 21:52:10.158111 139862640383808 dataset_builder.py:439] Warning: Setting shuffle_files=True because split=TRAIN and shuffle_files=None. This behavior will be deprecated on 2019-08-06, at which point shuffle_files=False will be the default for all splits.
</pre>
<div class="highlight">
<pre><span></span>training, testing = imdb["train"], imdb["test"]
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgeae0db2">
<h3 id="orgeae0db2">Building Up the Tokenizer</h3>
<div class="outline-text-3" id="text-orgeae0db2">
<p>Since we didn't pass in a specifier for the configuration we wanted (e.g. <code>imdb/subwords8k</code>) it defaulted to giving us the plain text reviews (and their labels) so we have to build the tokenizer ourselves.</p>
</div>
<div class="outline-4" id="outline-container-org33c8f9d">
<h4 id="org33c8f9d">Split Up the Sentences and Their Labels</h4>
<div class="outline-text-4" id="text-org33c8f9d">
<p>As you might recall, the data set consists of 50,000 IMDB movie reviews categorized as positive or negative. To build the tokenize we first have to split the sentences from their labels</p>
<div class="highlight">
<pre><span></span>training_sentences = []
training_labels = []
testing_sentences = []
testing_labels = []
</pre></div>
<div class="highlight">
<pre><span></span>with TIMER:
    for sentence, label in training:
        training_sentences.append(str(sentence.numpy()))
        training_labels.append(str(label.numpy()))


    for sentence, label in testing:
        testing_sentences.append(str(sentence.numpy))
        testing_labels.append(str(label.numpy()))
</pre></div>
<pre class="example">
2019-09-24 21:52:11,396 graeae.timers.timer start: Started: 2019-09-24 21:52:11.395126
I0924 21:52:11.396310 139862640383808 timer.py:70] Started: 2019-09-24 21:52:11.395126
2019-09-24 21:52:18,667 graeae.timers.timer end: Ended: 2019-09-24 21:52:18.667789
I0924 21:52:18.667830 139862640383808 timer.py:77] Ended: 2019-09-24 21:52:18.667789
2019-09-24 21:52:18,670 graeae.timers.timer end: Elapsed: 0:00:07.272663
I0924 21:52:18.670069 139862640383808 timer.py:78] Elapsed: 0:00:07.272663
</pre>
<div class="highlight">
<pre><span></span>training_labels_final = numpy.array(training_labels)
testing_labels_final = numpy.array(testing_labels)
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org695df13">
<h4 id="org695df13">Some Constants</h4>
<div class="outline-text-4" id="text-org695df13">
<div class="highlight">
<pre><span></span>Text = Namespace(
    vocab_size = 10000,
    embedding_dim = 16,
    max_length = 120,
    trunc_type='post',
    oov_token = "&lt;OOV&gt;",
)
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orga066bfb">
<h3 id="orga066bfb">Build the Tokenizer</h3>
<div class="outline-text-3" id="text-orga066bfb">
<div class="highlight">
<pre><span></span>tokenizer = Tokenizer(num_words=Text.vocab_size, oov_token=Text.oov_token)
with TIMER:
    tokenizer.fit_on_texts(training_sentences)

    word_index = tokenizer.word_index
    sequences = tokenizer.texts_to_sequences(training_sentences)
    padded = pad_sequences(sequences, maxlen=Text.max_length, truncating=Text.trunc_type)

    testing_sequences = tokenizer.texts_to_sequences(testing_sentences)
    testing_padded = pad_sequences(testing_sequences, maxlen=Text.max_length)
</pre></div>
<pre class="example">
2019-09-24 21:52:21,705 graeae.timers.timer start: Started: 2019-09-24 21:52:21.705287
I0924 21:52:21.705317 139862640383808 timer.py:70] Started: 2019-09-24 21:52:21.705287
2019-09-24 21:52:32,152 graeae.timers.timer end: Ended: 2019-09-24 21:52:32.152267
I0924 21:52:32.152314 139862640383808 timer.py:77] Ended: 2019-09-24 21:52:32.152267
2019-09-24 21:52:32,154 graeae.timers.timer end: Elapsed: 0:00:10.446980
I0924 21:52:32.154620 139862640383808 timer.py:78] Elapsed: 0:00:10.446980
</pre></div>
</div>
<div class="outline-3" id="outline-container-orga0a237f">
<h3 id="orga0a237f">Decoder Ring</h3>
<div class="outline-text-3" id="text-orga0a237f">
<div class="highlight">
<pre><span></span>index_to_word = {value: key for key, value in word_index.items()}

def decode_review(text: numpy.array) -&gt; str:
    return " ".join([index_to_word.get(item, "&lt;?&gt;") for item in text])
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org0d0dd1d">
<h3 id="org0d0dd1d">Build the Model</h3>
<div class="outline-text-3" id="text-org0d0dd1d">
<p>This time we're going to build a four-layer model with one Bidirectional layer that uses a <a href="https://www.tensorflow.org/versions/r2.0/api_docs/python/tf/keras/layers/GRU">GRU</a> (<a href="https://www.wikiwand.com/en/Gated_recurrent_unit">Gated Recurrent Unit</a>) instead of a LSTM.</p>
<div class="highlight">
<pre><span></span>model = tensorflow.keras.Sequential([
    tensorflow.keras.layers.Embedding(Text.vocab_size, Text.embedding_dim, input_length=Text.max_length),
    tensorflow.keras.layers.Bidirectional(tensorflow.compat.v2.keras.layers.GRU(32)),
    tensorflow.keras.layers.Dense(6, activation='relu'),
    tensorflow.keras.layers.Dense(1, activation='sigmoid')
])
model.compile(loss="binary_crossentropy", optimizer="adam", metrics=["accuracy"])
</pre></div>
<div class="highlight">
<pre><span></span>print(model.summary())
</pre></div>
<pre class="example">
Model: "sequential"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
embedding (Embedding)        (None, 120, 16)           160000    
_________________________________________________________________
bidirectional (Bidirectional (None, 64)                9600      
_________________________________________________________________
dense (Dense)                (None, 6)                 390       
_________________________________________________________________
dense_1 (Dense)              (None, 1)                 7         
=================================================================
Total params: 169,997
Trainable params: 169,997
Non-trainable params: 0
_________________________________________________________________
None
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgedd637a">
<h3 id="orgedd637a">Train it</h3>
<div class="outline-text-3" id="text-orgedd637a">
<div class="highlight">
<pre><span></span>EPOCHS = 50
ONCE_PER_EPOCH = 2
batch_size = 8
history = model.fit(padded, training_labels_final,
                    epochs=EPOCHS,
                    batch_size=batch_size,
                    validation_data=(testing_padded, testing_labels_final),
                    verbose=ONCE_PER_EPOCH)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1d1575f">
<h3 id="org1d1575f">Plot It</h3>
<div class="outline-text-3" id="text-org1d1575f">
<div class="highlight">
<pre><span></span>data = pandas.DataFrame(history.history)
plot = data.hvplot().opts(title="GRU Training Performance", width=1000, height=800)
Embed(plot=plot, file_name="gru_training")()
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org53150d6">
<h2 id="org53150d6">Raw</h2>
<div class="outline-text-2" id="text-org53150d6"></div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/keras/he-used-sarcasm/">He Used Sarcasm</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/keras/he-used-sarcasm/" rel="bookmark"><time class="published dt-published" datetime="2019-09-21T19:01:16-07:00" itemprop="datePublished" title="2019-09-21 19:01">2019-09-21 19:01</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/keras/he-used-sarcasm/#orgdd2b40d">Beginning</a>
<ul>
<li><a href="posts/keras/he-used-sarcasm/#org47724f2">Imports</a>
<ul>
<li><a href="posts/keras/he-used-sarcasm/#orge9373f6">Python</a></li>
<li><a href="posts/keras/he-used-sarcasm/#orge1fc6c4">PyPi</a></li>
<li><a href="posts/keras/he-used-sarcasm/#orgb294adc">Other</a></li>
</ul>
</li>
<li><a href="posts/keras/he-used-sarcasm/#org29c3e38">Set Up</a>
<ul>
<li><a href="posts/keras/he-used-sarcasm/#org55e57fb">The Timer</a></li>
<li><a href="posts/keras/he-used-sarcasm/#org8cad027">The Plotting</a></li>
<li><a href="posts/keras/he-used-sarcasm/#org11bb5c5">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/keras/he-used-sarcasm/#org5cd5a92">Middle</a>
<ul>
<li><a href="posts/keras/he-used-sarcasm/#org3b05253">Looking At the Data</a></li>
<li><a href="posts/keras/he-used-sarcasm/#orgabeec89">Set Up the Tokenizing and Training Data</a>
<ul>
<li><a href="posts/keras/he-used-sarcasm/#org1709184">The Training and Testing Data</a></li>
<li><a href="posts/keras/he-used-sarcasm/#org7d7e51e">The Tokenizer</a></li>
</ul>
</li>
<li><a href="posts/keras/he-used-sarcasm/#orgf8a7b07">Build The Model</a>
<ul>
<li><a href="posts/keras/he-used-sarcasm/#org9f97d74">It's a Sequence of Layers</a></li>
<li><a href="posts/keras/he-used-sarcasm/#org3cc4424">Start With An Embedding Layer</a></li>
<li><a href="posts/keras/he-used-sarcasm/#org86568e8">The Convolutional Layer</a></li>
<li><a href="posts/keras/he-used-sarcasm/#orga24e689">A Pooling Layer</a></li>
<li><a href="posts/keras/he-used-sarcasm/#org37c0969">The Fully-Connected Layers</a></li>
<li><a href="posts/keras/he-used-sarcasm/#orgce3f98e">Build It</a></li>
<li><a href="posts/keras/he-used-sarcasm/#org90c0e1e">Compile It</a></li>
</ul>
</li>
<li><a href="posts/keras/he-used-sarcasm/#org07774f1">Train It</a></li>
<li><a href="posts/keras/he-used-sarcasm/#org614419c">Plot the Performance</a></li>
</ul>
</li>
<li><a href="posts/keras/he-used-sarcasm/#org1c1493b">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgdd2b40d">
<h2 id="orgdd2b40d">Beginning</h2>
<div class="outline-text-2" id="text-orgdd2b40d">
<p>This is a look at fitting a model to detect sarcasm using a json blob from Laurence Moroney (<a href="https://storage.googleapis.com/laurencemoroney-blog.appspot.com/sarcasm.json">https://storage.googleapis.com/laurencemoroney-blog.appspot.com/sarcasm.json</a>).</p>
</div>
<div class="outline-3" id="outline-container-org47724f2">
<h3 id="org47724f2">Imports</h3>
<div class="outline-text-3" id="text-org47724f2"></div>
<div class="outline-4" id="outline-container-orge9373f6">
<h4 id="orge9373f6">Python</h4>
<div class="outline-text-4" id="text-orge9373f6">
<div class="highlight">
<pre><span></span>from argparse import Namespace
from functools import partial
from pathlib import Path
from pprint import pprint
from urllib.parse import urlparse
import json
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge1fc6c4">
<h4 id="orge1fc6c4">PyPi</h4>
<div class="outline-text-4" id="text-orge1fc6c4">
<div class="highlight">
<pre><span></span>from sklearn.model_selection import train_test_split
from tensorflow.keras.preprocessing.text import Tokenizer
from tensorflow.keras.preprocessing.sequence import pad_sequences
import hvplot.pandas
import pandas
import tensorflow
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb294adc">
<h4 id="orgb294adc">Other</h4>
<div class="outline-text-4" id="text-orgb294adc">
<div class="highlight">
<pre><span></span>from graeae import (
    CountPercentage,
    EmbedHoloviews,
    TextDownloader,
    Timer
)
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org29c3e38">
<h3 id="org29c3e38">Set Up</h3>
<div class="outline-text-3" id="text-org29c3e38"></div>
<div class="outline-4" id="outline-container-org55e57fb">
<h4 id="org55e57fb">The Timer</h4>
<div class="outline-text-4" id="text-org55e57fb">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8cad027">
<h4 id="org8cad027">The Plotting</h4>
<div class="outline-text-4" id="text-org8cad027">
<div class="highlight">
<pre><span></span>SLUG = "he-used-sarcasm"
Embed = partial(EmbedHoloviews, folder_path=f"../../files/posts/keras/{SLUG}")
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org11bb5c5">
<h4 id="org11bb5c5">The Data</h4>
<div class="outline-text-4" id="text-org11bb5c5">
<div class="highlight">
<pre><span></span>URL = "https://storage.googleapis.com/laurencemoroney-blog.appspot.com/sarcasm.json"
path = Path("~/data/datasets/text/sarcasm/sarcasm.json").expanduser()
downloader = TextDownloader(URL, path)
with TIMER:
    data = json.loads(downloader.download)
</pre></div>
<pre class="example">
2019-09-22 15:05:27,302 graeae.timers.timer start: Started: 2019-09-22 15:05:27.301225
WARNING: Logging before flag parsing goes to stderr.
I0922 15:05:27.302001 139873020925760 timer.py:70] Started: 2019-09-22 15:05:27.301225
2019-09-22 15:05:27,306 [1mTextDownloader[0m download: /home/hades/data/datasets/text/sarcasm/sarcasm.json exists, opening it
I0922 15:05:27.306186 139873020925760 downloader.py:51] /home/hades/data/datasets/text/sarcasm/sarcasm.json exists, opening it
2019-09-22 15:05:27,367 graeae.timers.timer end: Ended: 2019-09-22 15:05:27.367036
I0922 15:05:27.367099 139873020925760 timer.py:77] Ended: 2019-09-22 15:05:27.367036
2019-09-22 15:05:27,369 graeae.timers.timer end: Elapsed: 0:00:00.065811
I0922 15:05:27.369417 139873020925760 timer.py:78] Elapsed: 0:00:00.065811
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org5cd5a92">
<h2 id="org5cd5a92">Middle</h2>
<div class="outline-text-2" id="text-org5cd5a92"></div>
<div class="outline-3" id="outline-container-org3b05253">
<h3 id="org3b05253">Looking At the Data</h3>
<div class="outline-text-3" id="text-org3b05253">
<div class="highlight">
<pre><span></span>pprint(data[0])
</pre></div>
<pre class="example">
{'article_link': 'https://www.huffingtonpost.com/entry/versace-black-code_us_5861fbefe4b0de3a08f600d5',
 'headline': "former versace store clerk sues over secret 'black code' for "
             'minority shoppers',
 'is_sarcastic': 0}
</pre>
<p>So our data is a dictionary with three keys - the source of the article, the headline of the article, and whether it's a sarcastic headline or not. There's no citation in the original notebook, but it looks like it might be this one <a href="https://github.com/rishabhmisra/News-Headlines-Dataset-For-Sarcasm-Detection">on GitHub</a>.</p>
<div class="highlight">
<pre><span></span>data = pandas.DataFrame(data)
data.loc[:, "site"] = data.article_link.apply(lambda link: urlparse(link).netloc)
</pre></div>
<div class="highlight">
<pre><span></span>CountPercentage(data.site, value_label="Site")()
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Site</th>
<th class="org-right" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">www.huffingtonpost.com</td>
<td class="org-right">14403</td>
<td class="org-right">53.93</td>
</tr>
<tr>
<td class="org-left">www.theonion.com</td>
<td class="org-right">5811</td>
<td class="org-right">21.76</td>
</tr>
<tr>
<td class="org-left">local.theonion.com</td>
<td class="org-right">2852</td>
<td class="org-right">10.68</td>
</tr>
<tr>
<td class="org-left">politics.theonion.com</td>
<td class="org-right">1767</td>
<td class="org-right">6.62</td>
</tr>
<tr>
<td class="org-left">entertainment.theonion.com</td>
<td class="org-right">1194</td>
<td class="org-right">4.47</td>
</tr>
<tr>
<td class="org-left">www.huffingtonpost.comhttp:</td>
<td class="org-right">503</td>
<td class="org-right">1.88</td>
</tr>
<tr>
<td class="org-left">sports.theonion.com</td>
<td class="org-right">100</td>
<td class="org-right">0.37</td>
</tr>
<tr>
<td class="org-left">www.huffingtonpost.comhttps:</td>
<td class="org-right">79</td>
<td class="org-right">0.30</td>
</tr>
</tbody>
</table>
<p>So, it looks like there's some problems with the URLs. I don't think that's important, but maybe I can clean up a little anyway.</p>
<div class="highlight">
<pre><span></span>print(
    data[
        data.site.str.contains("www.huffingtonpost.comhttp"
                               )].article_link.value_counts())
</pre></div>
<pre class="example">
https://www.huffingtonpost.comhttp://nymag.com/daily/intelligencer/2016/05/hillary-clinton-candidacy.html                                                                                              2
https://www.huffingtonpost.comhttps://www.facebook.com/HuffPostQueerVoices/videos/1153919084666530/                                                                                                    1
https://www.huffingtonpost.comhttp://live.huffingtonpost.com/r/segment/chris-meloni-star-underground/56d8584f99ec6dca3d00000a                                                                          1
https://www.huffingtonpost.comhttp://www.thestreet.com/story/13223501/1/post-retirement-work-may-not-save-your-golden-years.html                                                                       1
https://www.huffingtonpost.comhttps://www.facebook.com/HuffPostEntertainment/                                                                                                                          1
                                                                                                                                                                                                      ..
https://www.huffingtonpost.comhttp://nymag.com/thecut/2015/10/first-legal-abortionists-tell-their-stories.html?mid=twitter_nymag                                                                       1
https://www.huffingtonpost.comhttp://www.tampabay.com/blogs/the-buzz-florida-politics/marco-rubio-warming-up-to-donald-trump/2275308                                                                   1
https://www.huffingtonpost.comhttp://live.huffingtonpost.com/r/segment/porn-to-pay-for-college/55aeadf62b8c2a2f6f000193                                                                                1
https://www.huffingtonpost.comhttps://www.thedodo.com/dog-mouth-taped-shut-facebook-1481874724.html                                                                                                    1
https://www.huffingtonpost.comhttps://www.washingtonpost.com/politics/ben-carson-to-tell-supporters-he-sees-no-path-forward-for-campaign/2016/03/02/d6bef352-d9b3-11e5-891a-4ed04f4213e8_story.html    1
Name: article_link, Length: 581, dtype: int64
</pre>
<p>That's kind of odd, I don't know what that means, maybe the Huffington Post was citing other sites? I went to go check the GitHub dataset I mentioned but it's actually much larger than this one so I don't know if it's really the source or not.</p>
<div class="highlight">
<pre><span></span>prefixes = ("www.huffingtonpost.comhttp:", "www.huffingtonpost.comhttps:")
for prefix in prefixes:
    data.loc[:, "site"] = data.site.str.replace(
        prefix,
        "www.huffingtonpost.com")

prefixes = ("local.theonion.com",
            "politics.theonion.com",
            "entertainment.theonion.com",
            "sports.theonion.com")

for prefix in prefixes:
    data.loc[:, "site"] = data.site.str.replace(prefix,
                                                "www.theonion.com")
</pre></div>
<div class="highlight">
<pre><span></span>counter = CountPercentage(data.site, value_label="Site")
counter()
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Site</th>
<th class="org-right" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">www.huffingtonpost.com</td>
<td class="org-right">14985</td>
<td class="org-right">56.10</td>
</tr>
<tr>
<td class="org-left">www.theonion.com</td>
<td class="org-right">11724</td>
<td class="org-right">43.90</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span>plot = counter.table.hvplot.bar(x="Site", y="Count").opts(
    title="Distribution by Site",
    width=1000,
    height=800)
Embed(plot=plot, file_name="site_distribution")()
</pre></div>
<object data="posts/keras/he-used-sarcasm/site_distribution.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<div class="highlight">
<pre><span></span>counter = CountPercentage(data.is_sarcastic, value_label="Is Sarcastic")
counter()
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-left">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">Is Sarcastic</th>
<th class="org-left" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-left">14,985</td>
<td class="org-right">56.10</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-left">11,724</td>
<td class="org-right">43.90</td>
</tr>
</tbody>
</table>
<p>Given that the counts match I'm assuming anything from the Huffington Post is labeled as not sarcastic and anything from the onion is sarcastic.</p>
<div class="highlight">
<pre><span></span>assert all(data[data.site=="www.onion.com"].is_sarcastic)
assert not any(data[data.site=="www.huffingtonpost.com"].is_sarcastic)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgabeec89">
<h3 id="orgabeec89">Set Up the Tokenizing and Training Data</h3>
<div class="outline-text-3" id="text-orgabeec89">
<div class="highlight">
<pre><span></span>print(f"{len(data):,}")
</pre></div>
<pre class="example">
26,709
</pre>
<div class="highlight">
<pre><span></span>Text = Namespace(
    vocabulary_size = 1000,
    embedding_dim = 16,
    max_length = 120,
    truncating_type='post',
    padding_type='post',
    out_of_vocabulary_tok = "&lt;OOV&gt;",
)

# this is actually the default for train_test_split
Training = Namespace(
    size = 0.75,
    epochs = 50,
    verbosity = 2,
    )
</pre></div>
</div>
<div class="outline-4" id="outline-container-org1709184">
<h4 id="org1709184">The Training and Testing Data</h4>
<div class="outline-text-4" id="text-org1709184">
<div class="highlight">
<pre><span></span>x_train, x_test, y_train, y_test = train_test_split(
    data.headline, data.is_sarcastic, train_size=Training.size,
)
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7d7e51e">
<h4 id="org7d7e51e">The Tokenizer</h4>
<div class="outline-text-4" id="text-org7d7e51e">
<div class="highlight">
<pre><span></span>tokenizer = Tokenizer(num_words=Text.vocabulary_size,
                      oov_token=Text.out_of_vocabulary_tok)
</pre></div>
<div class="highlight">
<pre><span></span>print(tokenizer.__doc__)
</pre></div>
<pre class="example">
Text tokenization utility class.

    This class allows to vectorize a text corpus, by turning each
    text into either a sequence of integers (each integer being the index
    of a token in a dictionary) or into a vector where the coefficient
    for each token could be binary, based on word count, based on tf-idf...

    # Arguments
        num_words: the maximum number of words to keep, based
            on word frequency. Only the most common `num_words-1` words will
            be kept.
        filters: a string where each element is a character that will be
            filtered from the texts. The default is all punctuation, plus
            tabs and line breaks, minus the `'` character.
        lower: boolean. Whether to convert the texts to lowercase.
        split: str. Separator for word splitting.
        char_level: if True, every character will be treated as a token.
        oov_token: if given, it will be added to word_index and used to
            replace out-of-vocabulary words during text_to_sequence calls

    By default, all punctuation is removed, turning the texts into
    space-separated sequences of words
    (words maybe include the `'` character). These sequences are then
    split into lists of tokens. They will then be indexed or vectorized.

    `0` is a reserved index that won't be assigned to any word.
</pre>
<p>Now that we have a tokenizer we can tokenize our training headlines.</p>
<div class="highlight">
<pre><span></span>help(tokenizer.fit_on_texts)
</pre></div>
<pre class="example">
Help on method fit_on_texts in module keras_preprocessing.text:

fit_on_texts(texts) method of keras_preprocessing.text.Tokenizer instance
    Updates internal vocabulary based on a list of texts.
    
    In the case where texts contains lists,
    we assume each entry of the lists to be a token.
    
    Required before using `texts_to_sequences` or `texts_to_matrix`.
    
    # Arguments
        texts: can be a list of strings,
            a generator of strings (for memory-efficiency),
            or a list of list of strings.

</pre>
<div class="highlight">
<pre><span></span>tokenizer.fit_on_texts(x_train)
</pre></div>
<p>Now that we've fit the headlines we can get the word index, a dict mapping words to their index.</p>
<div class="highlight">
<pre><span></span>word_index = tokenizer.word_index
</pre></div>
<p>Note that the tokenizer doesn't remove stop-words.</p>
<div class="highlight">
<pre><span></span>print("the" in word_index)
</pre></div>
<pre class="example">
True
</pre>
<p>Now we'll convert the training headlines to sequences of numbers.</p>
<div class="highlight">
<pre><span></span>help(tokenizer.texts_to_sequences)
</pre></div>
<pre class="example">
Help on method texts_to_sequences in module keras_preprocessing.text:

texts_to_sequences(texts) method of keras_preprocessing.text.Tokenizer instance
    Transforms each text in texts to a sequence of integers.
    
    Only top `num_words-1` most frequent words will be taken into account.
    Only words known by the tokenizer will be taken into account.
    
    # Arguments
        texts: A list of texts (strings).
    
    # Returns
        A list of sequences.

</pre>
<p>We're also going to have to pad them to make them the same length.</p>
<div class="highlight">
<pre><span></span>help(pad_sequences)
</pre></div>
<pre class="example">
Help on function pad_sequences in module keras_preprocessing.sequence:

pad_sequences(sequences, maxlen=None, dtype='int32', padding='pre', truncating='pre', value=0.0)
    Pads sequences to the same length.
    
    This function transforms a list of
    `num_samples` sequences (lists of integers)
    into a 2D Numpy array of shape `(num_samples, num_timesteps)`.
    `num_timesteps` is either the `maxlen` argument if provided,
    or the length of the longest sequence otherwise.
    
    Sequences that are shorter than `num_timesteps`
    are padded with `value` at the end.
    
    Sequences longer than `num_timesteps` are truncated
    so that they fit the desired length.
    The position where padding or truncation happens is determined by
    the arguments `padding` and `truncating`, respectively.
    
    Pre-padding is the default.
    
    # Arguments
        sequences: List of lists, where each element is a sequence.
        maxlen: Int, maximum length of all sequences.
        dtype: Type of the output sequences.
            To pad sequences with variable length strings, you can use `object`.
        padding: String, 'pre' or 'post':
            pad either before or after each sequence.
        truncating: String, 'pre' or 'post':
            remove values from sequences larger than
            `maxlen`, either at the beginning or at the end of the sequences.
        value: Float or String, padding value.
    
    # Returns
        x: Numpy array with shape `(len(sequences), maxlen)`
    
    # Raises
        ValueError: In case of invalid values for `truncating` or `padding`,
            or in case of invalid shape for a `sequences` entry.

</pre>
<div class="highlight">
<pre><span></span>training_sequences = tokenizer.texts_to_sequences(x_train)
training_padded = pad_sequences(training_sequences, maxlen=Text.max_length, padding=Text.padding_type, truncating=Text.truncating_type)

testing_sequences = tokenizer.texts_to_sequences(x_test)
testing_padded = pad_sequences(testing_sequences, maxlen=Text.max_length, padding=Text.padding_type, truncating=Text.truncating_type)
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf8a7b07">
<h3 id="orgf8a7b07">Build The Model</h3>
<div class="outline-text-3" id="text-orgf8a7b07">
<p>We're going to use a convolutional neural network to try and classify our headlines as sarcastic or not-sarcastic.</p>
</div>
<div class="outline-4" id="outline-container-org9f97d74">
<h4 id="org9f97d74">It's a Sequence of Layers</h4>
<div class="outline-text-4" id="text-org9f97d74">
<div class="highlight">
<pre><span></span>print(tensorflow.keras.Sequential.__doc__)
</pre></div>
<pre class="example">
Linear stack of layers.

  Arguments:
      layers: list of layers to add to the model.

  Example:

  ```python
  # Optionally, the first layer can receive an `input_shape` argument:
  model = Sequential()
  model.add(Dense(32, input_shape=(500,)))
  # Afterwards, we do automatic shape inference:
  model.add(Dense(32))

  # This is identical to the following:
  model = Sequential()
  model.add(Dense(32, input_dim=500))

  # And to the following:
  model = Sequential()
  model.add(Dense(32, batch_input_shape=(None, 500)))

  # Note that you can also omit the `input_shape` argument:
  # In that case the model gets built the first time you call `fit` (or other
  # training and evaluation methods).
  model = Sequential()
  model.add(Dense(32))
  model.add(Dense(32))
  model.compile(optimizer=optimizer, loss=loss)
  # This builds the model for the first time:
  model.fit(x, y, batch_size=32, epochs=10)

  # Note that when using this delayed-build pattern (no input shape specified),
  # the model doesn't have any weights until the first call
  # to a training/evaluation method (since it isn't yet built):
  model = Sequential()
  model.add(Dense(32))
  model.add(Dense(32))
  model.weights  # returns []

  # Whereas if you specify the input shape, the model gets built continuously
  # as you are adding layers:
  model = Sequential()
  model.add(Dense(32, input_shape=(500,)))
  model.add(Dense(32))
  model.weights  # returns list of length 4

  # When using the delayed-build pattern (no input shape specified), you can
  # choose to manually build your model by calling `build(batch_input_shape)`:
  model = Sequential()
  model.add(Dense(32))
  model.add(Dense(32))
  model.build((None, 500))
  model.weights  # returns list of length 4
  ```
  
</pre></div>
</div>
<div class="outline-4" id="outline-container-org3cc4424">
<h4 id="org3cc4424">Start With An Embedding Layer</h4>
<div class="outline-text-4" id="text-org3cc4424">
<div class="highlight">
<pre><span></span>print(tensorflow.keras.layers.Embedding.__doc__)
</pre></div>
<pre class="example">
Turns positive integers (indexes) into dense vectors of fixed size.

  e.g. `[[4], [20]] -&gt; [[0.25, 0.1], [0.6, -0.2]]`

  This layer can only be used as the first layer in a model.

  Example:

  ```python
  model = Sequential()
  model.add(Embedding(1000, 64, input_length=10))
  # the model will take as input an integer matrix of size (batch,
  # input_length).
  # the largest integer (i.e. word index) in the input should be no larger
  # than 999 (vocabulary size).
  # now model.output_shape == (None, 10, 64), where None is the batch
  # dimension.

  input_array = np.random.randint(1000, size=(32, 10))

  model.compile('rmsprop', 'mse')
  output_array = model.predict(input_array)
  assert output_array.shape == (32, 10, 64)
  ```

  Arguments:
    input_dim: int &gt; 0. Size of the vocabulary,
      i.e. maximum integer index + 1.
    output_dim: int &gt;= 0. Dimension of the dense embedding.
    embeddings_initializer: Initializer for the `embeddings` matrix.
    embeddings_regularizer: Regularizer function applied to
      the `embeddings` matrix.
    embeddings_constraint: Constraint function applied to
      the `embeddings` matrix.
    mask_zero: Whether or not the input value 0 is a special "padding"
      value that should be masked out.
      This is useful when using recurrent layers
      which may take variable length input.
      If this is `True` then all subsequent layers
      in the model need to support masking or an exception will be raised.
      If mask_zero is set to True, as a consequence, index 0 cannot be
      used in the vocabulary (input_dim should equal size of
      vocabulary + 1).
    input_length: Length of input sequences, when it is constant.
      This argument is required if you are going to connect
      `Flatten` then `Dense` layers upstream
      (without it, the shape of the dense outputs cannot be computed).

  Input shape:
    2D tensor with shape: `(batch_size, input_length)`.

  Output shape:
    3D tensor with shape: `(batch_size, input_length, output_dim)`.
  
</pre></div>
</div>
<div class="outline-4" id="outline-container-org86568e8">
<h4 id="org86568e8">The Convolutional Layer</h4>
<div class="outline-text-4" id="text-org86568e8">
<div class="highlight">
<pre><span></span>print(tensorflow.keras.layers.Conv1D.__doc__)
</pre></div>
<pre class="example">
1D convolution layer (e.g. temporal convolution).

  This layer creates a convolution kernel that is convolved
  with the layer input over a single spatial (or temporal) dimension
  to produce a tensor of outputs.
  If `use_bias` is True, a bias vector is created and added to the outputs.
  Finally, if `activation` is not `None`,
  it is applied to the outputs as well.

  When using this layer as the first layer in a model,
  provide an `input_shape` argument
  (tuple of integers or `None`, e.g.
  `(10, 128)` for sequences of 10 vectors of 128-dimensional vectors,
  or `(None, 128)` for variable-length sequences of 128-dimensional vectors.

  Arguments:
    filters: Integer, the dimensionality of the output space
      (i.e. the number of output filters in the convolution).
    kernel_size: An integer or tuple/list of a single integer,
      specifying the length of the 1D convolution window.
    strides: An integer or tuple/list of a single integer,
      specifying the stride length of the convolution.
      Specifying any stride value != 1 is incompatible with specifying
      any `dilation_rate` value != 1.
    padding: One of `"valid"`, `"causal"` or `"same"` (case-insensitive).
      `"causal"` results in causal (dilated) convolutions, e.g. output[t]
      does not depend on input[t+1:]. Useful when modeling temporal data
      where the model should not violate the temporal order.
      See [WaveNet: A Generative Model for Raw Audio, section
        2.1](https://arxiv.org/abs/1609.03499).
    data_format: A string,
      one of `channels_last` (default) or `channels_first`.
    dilation_rate: an integer or tuple/list of a single integer, specifying
      the dilation rate to use for dilated convolution.
      Currently, specifying any `dilation_rate` value != 1 is
      incompatible with specifying any `strides` value != 1.
    activation: Activation function to use.
      If you don't specify anything, no activation is applied
      (ie. "linear" activation: `a(x) = x`).
    use_bias: Boolean, whether the layer uses a bias vector.
    kernel_initializer: Initializer for the `kernel` weights matrix.
    bias_initializer: Initializer for the bias vector.
    kernel_regularizer: Regularizer function applied to
      the `kernel` weights matrix.
    bias_regularizer: Regularizer function applied to the bias vector.
    activity_regularizer: Regularizer function applied to
      the output of the layer (its "activation")..
    kernel_constraint: Constraint function applied to the kernel matrix.
    bias_constraint: Constraint function applied to the bias vector.

  Examples:
    ```python
    # Small convolutional model for 128-length vectors with 6 timesteps
    # model.input_shape == (None, 6, 128)
    
    model = Sequential()
    model.add(Conv1D(32, 3, 
              activation='relu', 
              input_shape=(6, 128)))
    
    # now: model.output_shape == (None, 4, 32)
    ```

  Input shape:
    3D tensor with shape: `(batch_size, steps, input_dim)`

  Output shape:
    3D tensor with shape: `(batch_size, new_steps, filters)`
      `steps` value might have changed due to padding or strides.
  
</pre></div>
</div>
<div class="outline-4" id="outline-container-orga24e689">
<h4 id="orga24e689">A Pooling Layer</h4>
<div class="outline-text-4" id="text-orga24e689">
<div class="highlight">
<pre><span></span>print(tensorflow.keras.layers.GlobalMaxPooling1D.__doc__)
</pre></div>
<pre class="example">
Global max pooling operation for temporal data.

  Arguments:
    data_format: A string,
      one of `channels_last` (default) or `channels_first`.
      The ordering of the dimensions in the inputs.
      `channels_last` corresponds to inputs with shape
      `(batch, steps, features)` while `channels_first`
      corresponds to inputs with shape
      `(batch, features, steps)`.

  Input shape:
    - If `data_format='channels_last'`:
      3D tensor with shape:
      `(batch_size, steps, features)`
    - If `data_format='channels_first'`:
      3D tensor with shape:
      `(batch_size, features, steps)`

  Output shape:
    2D tensor with shape `(batch_size, features)`.
  
</pre></div>
</div>
<div class="outline-4" id="outline-container-org37c0969">
<h4 id="org37c0969">The Fully-Connected Layers</h4>
<div class="outline-text-4" id="text-org37c0969">
<p>Finally our output layers.</p>
<div class="highlight">
<pre><span></span>print(tensorflow.keras.layers.Dense.__doc__)
</pre></div>
<pre class="example">
Just your regular densely-connected NN layer.

  `Dense` implements the operation:
  `output = activation(dot(input, kernel) + bias)`
  where `activation` is the element-wise activation function
  passed as the `activation` argument, `kernel` is a weights matrix
  created by the layer, and `bias` is a bias vector created by the layer
  (only applicable if `use_bias` is `True`).

  Note: If the input to the layer has a rank greater than 2, then
  it is flattened prior to the initial dot product with `kernel`.

  Example:

  ```python
  # as first layer in a sequential model:
  model = Sequential()
  model.add(Dense(32, input_shape=(16,)))
  # now the model will take as input arrays of shape (*, 16)
  # and output arrays of shape (*, 32)

  # after the first layer, you don't need to specify
  # the size of the input anymore:
  model.add(Dense(32))
  ```

  Arguments:
    units: Positive integer, dimensionality of the output space.
    activation: Activation function to use.
      If you don't specify anything, no activation is applied
      (ie. "linear" activation: `a(x) = x`).
    use_bias: Boolean, whether the layer uses a bias vector.
    kernel_initializer: Initializer for the `kernel` weights matrix.
    bias_initializer: Initializer for the bias vector.
    kernel_regularizer: Regularizer function applied to
      the `kernel` weights matrix.
    bias_regularizer: Regularizer function applied to the bias vector.
    activity_regularizer: Regularizer function applied to
      the output of the layer (its "activation")..
    kernel_constraint: Constraint function applied to
      the `kernel` weights matrix.
    bias_constraint: Constraint function applied to the bias vector.

  Input shape:
    N-D tensor with shape: `(batch_size, ..., input_dim)`.
    The most common situation would be
    a 2D input with shape `(batch_size, input_dim)`.

  Output shape:
    N-D tensor with shape: `(batch_size, ..., units)`.
    For instance, for a 2D input with shape `(batch_size, input_dim)`,
    the output would have shape `(batch_size, units)`.
  
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgce3f98e">
<h4 id="orgce3f98e">Build It</h4>
<div class="outline-text-4" id="text-orgce3f98e">
<p>I originally added the layers using the <code>model.add</code> method, but then when I tried to train it the output said the layers didn't have gradients and it never improved… I'll have to look into that, but in the meantime, passing them all in seems to work.</p>
<div class="highlight">
<pre><span></span>model = tensorflow.keras.Sequential([
    tensorflow.keras.layers.Embedding(
        input_dim=Text.vocabulary_size,
        output_dim=Text.embedding_dim,
        input_length=Text.max_length),
    tensorflow.keras.layers.Conv1D(filters=128,
                                   kernel_size=5,
                                   activation='relu'),
    tensorflow.keras.layers.GlobalMaxPooling1D(),
    tensorflow.keras.layers.Dense(24, activation='relu'),
    tensorflow.keras.layers.Dense(1, activation='sigmoid')
])
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org90c0e1e">
<h4 id="org90c0e1e">Compile It</h4>
<div class="outline-text-4" id="text-org90c0e1e">
<div class="highlight">
<pre><span></span>print(model.compile.__doc__)
</pre></div>
<pre class="example">
Configures the model for training.

    Arguments:
        optimizer: String (name of optimizer) or optimizer instance.
            See `tf.keras.optimizers`.
        loss: String (name of objective function), objective function or
            `tf.losses.Loss` instance. See `tf.losses`. If the model has
            multiple outputs, you can use a different loss on each output by
            passing a dictionary or a list of losses. The loss value that will
            be minimized by the model will then be the sum of all individual
            losses.
        metrics: List of metrics to be evaluated by the model during training
            and testing. Typically you will use `metrics=['accuracy']`.
            To specify different metrics for different outputs of a
            multi-output model, you could also pass a dictionary, such as
            `metrics={'output_a': 'accuracy', 'output_b': ['accuracy', 'mse']}`.
            You can also pass a list (len = len(outputs)) of lists of metrics
            such as `metrics=[['accuracy'], ['accuracy', 'mse']]` or
            `metrics=['accuracy', ['accuracy', 'mse']]`.
        loss_weights: Optional list or dictionary specifying scalar
            coefficients (Python floats) to weight the loss contributions
            of different model outputs.
            The loss value that will be minimized by the model
            will then be the *weighted sum* of all individual losses,
            weighted by the `loss_weights` coefficients.
            If a list, it is expected to have a 1:1 mapping
            to the model's outputs. If a tensor, it is expected to map
            output names (strings) to scalar coefficients.
        sample_weight_mode: If you need to do timestep-wise
            sample weighting (2D weights), set this to `"temporal"`.
            `None` defaults to sample-wise weights (1D).
            If the model has multiple outputs, you can use a different
            `sample_weight_mode` on each output by passing a
            dictionary or a list of modes.
        weighted_metrics: List of metrics to be evaluated and weighted
            by sample_weight or class_weight during training and testing.
        target_tensors: By default, Keras will create placeholders for the
            model's target, which will be fed with the target data during
            training. If instead you would like to use your own
            target tensors (in turn, Keras will not expect external
            Numpy data for these targets at training time), you
            can specify them via the `target_tensors` argument. It can be
            a single tensor (for a single-output model), a list of tensors,
            or a dict mapping output names to target tensors.
        distribute: NOT SUPPORTED IN TF 2.0, please create and compile the
            model under distribution strategy scope instead of passing it to
            compile.
        **kwargs: Any additional arguments.

    Raises:
        ValueError: In case of invalid arguments for
            `optimizer`, `loss`, `metrics` or `sample_weight_mode`.
    
</pre>
<div class="highlight">
<pre><span></span>model.compile(loss='binary_crossentropy', optimizer='adam', metrics=['accuracy'])
print(model.summary())
</pre></div>
<pre class="example">
Model: "sequential_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
embedding_2 (Embedding)      (None, 120, 16)           16000     
_________________________________________________________________
conv1d_1 (Conv1D)            (None, 116, 128)          10368     
_________________________________________________________________
global_max_pooling1d_2 (Glob (None, 128)               0         
_________________________________________________________________
dense_4 (Dense)              (None, 24)                3096      
_________________________________________________________________
dense_5 (Dense)              (None, 1)                 25        
=================================================================
Total params: 29,489
Trainable params: 29,489
Non-trainable params: 0
_________________________________________________________________
None
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org07774f1">
<h3 id="org07774f1">Train It</h3>
<div class="outline-text-3" id="text-org07774f1">
<div class="highlight">
<pre><span></span>print(model.fit.__doc__)
</pre></div>
<pre class="example">
Trains the model for a fixed number of epochs (iterations on a dataset).

    Arguments:
        x: Input data. It could be:
          - A Numpy array (or array-like), or a list of arrays
            (in case the model has multiple inputs).
          - A TensorFlow tensor, or a list of tensors
            (in case the model has multiple inputs).
          - A dict mapping input names to the corresponding array/tensors,
            if the model has named inputs.
          - A `tf.data` dataset. Should return a tuple
            of either `(inputs, targets)` or
            `(inputs, targets, sample_weights)`.
          - A generator or `keras.utils.Sequence` returning `(inputs, targets)`
            or `(inputs, targets, sample weights)`.
        y: Target data. Like the input data `x`,
          it could be either Numpy array(s) or TensorFlow tensor(s).
          It should be consistent with `x` (you cannot have Numpy inputs and
          tensor targets, or inversely). If `x` is a dataset, generator,
          or `keras.utils.Sequence` instance, `y` should
          not be specified (since targets will be obtained from `x`).
        batch_size: Integer or `None`.
            Number of samples per gradient update.
            If unspecified, `batch_size` will default to 32.
            Do not specify the `batch_size` if your data is in the
            form of symbolic tensors, datasets,
            generators, or `keras.utils.Sequence` instances (since they generate
            batches).
        epochs: Integer. Number of epochs to train the model.
            An epoch is an iteration over the entire `x` and `y`
            data provided.
            Note that in conjunction with `initial_epoch`,
            `epochs` is to be understood as "final epoch".
            The model is not trained for a number of iterations
            given by `epochs`, but merely until the epoch
            of index `epochs` is reached.
        verbose: 0, 1, or 2. Verbosity mode.
            0 = silent, 1 = progress bar, 2 = one line per epoch.
            Note that the progress bar is not particularly useful when
            logged to a file, so verbose=2 is recommended when not running
            interactively (eg, in a production environment).
        callbacks: List of `keras.callbacks.Callback` instances.
            List of callbacks to apply during training.
            See `tf.keras.callbacks`.
        validation_split: Float between 0 and 1.
            Fraction of the training data to be used as validation data.
            The model will set apart this fraction of the training data,
            will not train on it, and will evaluate
            the loss and any model metrics
            on this data at the end of each epoch.
            The validation data is selected from the last samples
            in the `x` and `y` data provided, before shuffling. This argument is
            not supported when `x` is a dataset, generator or
           `keras.utils.Sequence` instance.
        validation_data: Data on which to evaluate
            the loss and any model metrics at the end of each epoch.
            The model will not be trained on this data.
            `validation_data` will override `validation_split`.
            `validation_data` could be:
              - tuple `(x_val, y_val)` of Numpy arrays or tensors
              - tuple `(x_val, y_val, val_sample_weights)` of Numpy arrays
              - dataset
            For the first two cases, `batch_size` must be provided.
            For the last case, `validation_steps` must be provided.
        shuffle: Boolean (whether to shuffle the training data
            before each epoch) or str (for 'batch').
            'batch' is a special option for dealing with the
            limitations of HDF5 data; it shuffles in batch-sized chunks.
            Has no effect when `steps_per_epoch` is not `None`.
        class_weight: Optional dictionary mapping class indices (integers)
            to a weight (float) value, used for weighting the loss function
            (during training only).
            This can be useful to tell the model to
            "pay more attention" to samples from
            an under-represented class.
        sample_weight: Optional Numpy array of weights for
            the training samples, used for weighting the loss function
            (during training only). You can either pass a flat (1D)
            Numpy array with the same length as the input samples
            (1:1 mapping between weights and samples),
            or in the case of temporal data,
            you can pass a 2D array with shape
            `(samples, sequence_length)`,
            to apply a different weight to every timestep of every sample.
            In this case you should make sure to specify
            `sample_weight_mode="temporal"` in `compile()`. This argument is not
            supported when `x` is a dataset, generator, or
           `keras.utils.Sequence` instance, instead provide the sample_weights
            as the third element of `x`.
        initial_epoch: Integer.
            Epoch at which to start training
            (useful for resuming a previous training run).
        steps_per_epoch: Integer or `None`.
            Total number of steps (batches of samples)
            before declaring one epoch finished and starting the
            next epoch. When training with input tensors such as
            TensorFlow data tensors, the default `None` is equal to
            the number of samples in your dataset divided by
            the batch size, or 1 if that cannot be determined. If x is a
            `tf.data` dataset, and 'steps_per_epoch'
            is None, the epoch will run until the input dataset is exhausted.
            This argument is not supported with array inputs.
        validation_steps: Only relevant if `validation_data` is provided and
            is a `tf.data` dataset. Total number of steps (batches of
            samples) to draw before stopping when performing validation
            at the end of every epoch. If validation_data is a `tf.data` dataset
            and 'validation_steps' is None, validation
            will run until the `validation_data` dataset is exhausted.
        validation_freq: Only relevant if validation data is provided. Integer
            or `collections_abc.Container` instance (e.g. list, tuple, etc.).
            If an integer, specifies how many training epochs to run before a
            new validation run is performed, e.g. `validation_freq=2` runs
            validation every 2 epochs. If a Container, specifies the epochs on
            which to run validation, e.g. `validation_freq=[1, 2, 10]` runs
            validation at the end of the 1st, 2nd, and 10th epochs.
        max_queue_size: Integer. Used for generator or `keras.utils.Sequence`
            input only. Maximum size for the generator queue.
            If unspecified, `max_queue_size` will default to 10.
        workers: Integer. Used for generator or `keras.utils.Sequence` input
            only. Maximum number of processes to spin up
            when using process-based threading. If unspecified, `workers`
            will default to 1. If 0, will execute the generator on the main
            thread.
        use_multiprocessing: Boolean. Used for generator or
            `keras.utils.Sequence` input only. If `True`, use process-based
            threading. If unspecified, `use_multiprocessing` will default to
            `False`. Note that because this implementation relies on
            multiprocessing, you should not pass non-picklable arguments to
            the generator as they can't be passed easily to children processes.
        **kwargs: Used for backwards compatibility.

    Returns:
        A `History` object. Its `History.history` attribute is
        a record of training loss values and metrics values
        at successive epochs, as well as validation loss values
        and validation metrics values (if applicable).

    Raises:
        RuntimeError: If the model was never compiled.
        ValueError: In case of mismatch between the provided input data
            and what the model expects.
    
</pre>
<div class="highlight">
<pre><span></span>with TIMER:
    history = model.fit(training_padded,
                        y_train.values,
                        epochs=Training.epochs,
                        validation_data=(testing_padded, y_test.values),
                        verbose=Training.verbosity)
</pre></div>
<pre class="example">
2019-09-22 16:30:20,369 graeae.timers.timer start: Started: 2019-09-22 16:30:20.369886
I0922 16:30:20.369913 139873020925760 timer.py:70] Started: 2019-09-22 16:30:20.369886
Train on 20031 samples, validate on 6678 samples
Epoch 1/50
20031/20031 - 5s - loss: 0.4741 - accuracy: 0.7623 - val_loss: 0.4033 - val_accuracy: 0.8146
Epoch 2/50
20031/20031 - 4s - loss: 0.3663 - accuracy: 0.8366 - val_loss: 0.3980 - val_accuracy: 0.8196
Epoch 3/50
20031/20031 - 4s - loss: 0.3306 - accuracy: 0.8554 - val_loss: 0.3909 - val_accuracy: 0.8240
Epoch 4/50
20031/20031 - 4s - loss: 0.2990 - accuracy: 0.8721 - val_loss: 0.4148 - val_accuracy: 0.8179
Epoch 5/50
20031/20031 - 4s - loss: 0.2697 - accuracy: 0.8867 - val_loss: 0.4050 - val_accuracy: 0.8282
Epoch 6/50
20031/20031 - 4s - loss: 0.2406 - accuracy: 0.9003 - val_loss: 0.4291 - val_accuracy: 0.8212
Epoch 7/50
20031/20031 - 4s - loss: 0.2080 - accuracy: 0.9165 - val_loss: 0.4650 - val_accuracy: 0.8181
Epoch 8/50
20031/20031 - 4s - loss: 0.1824 - accuracy: 0.9272 - val_loss: 0.5053 - val_accuracy: 0.8130
Epoch 9/50
20031/20031 - 4s - loss: 0.1559 - accuracy: 0.9393 - val_loss: 0.5389 - val_accuracy: 0.8065
Epoch 10/50
20031/20031 - 4s - loss: 0.1325 - accuracy: 0.9498 - val_loss: 0.6213 - val_accuracy: 0.8044
Epoch 11/50
20031/20031 - 4s - loss: 0.1104 - accuracy: 0.9599 - val_loss: 0.6902 - val_accuracy: 0.8034
Epoch 12/50
20031/20031 - 4s - loss: 0.0966 - accuracy: 0.9646 - val_loss: 0.7437 - val_accuracy: 0.8035
Epoch 13/50
20031/20031 - 4s - loss: 0.0848 - accuracy: 0.9689 - val_loss: 0.8285 - val_accuracy: 0.7954
Epoch 14/50
20031/20031 - 4s - loss: 0.0693 - accuracy: 0.9753 - val_loss: 0.9121 - val_accuracy: 0.7934
Epoch 15/50
20031/20031 - 4s - loss: 0.0608 - accuracy: 0.9777 - val_loss: 1.0783 - val_accuracy: 0.7931
Epoch 16/50
20031/20031 - 4s - loss: 0.0529 - accuracy: 0.9810 - val_loss: 1.0620 - val_accuracy: 0.7889
Epoch 17/50
20031/20031 - 4s - loss: 0.0506 - accuracy: 0.9819 - val_loss: 1.2497 - val_accuracy: 0.7889
Epoch 18/50
20031/20031 - 4s - loss: 0.0471 - accuracy: 0.9821 - val_loss: 1.2518 - val_accuracy: 0.7963
Epoch 19/50
20031/20031 - 4s - loss: 0.0457 - accuracy: 0.9819 - val_loss: 1.3492 - val_accuracy: 0.7917
Epoch 20/50
20031/20031 - 4s - loss: 0.0392 - accuracy: 0.9851 - val_loss: 1.3702 - val_accuracy: 0.7948
Epoch 21/50
20031/20031 - 4s - loss: 0.0357 - accuracy: 0.9860 - val_loss: 1.4300 - val_accuracy: 0.7948
Epoch 22/50
20031/20031 - 4s - loss: 0.0341 - accuracy: 0.9864 - val_loss: 1.5654 - val_accuracy: 0.7889
Epoch 23/50
20031/20031 - 4s - loss: 0.0360 - accuracy: 0.9860 - val_loss: 1.5615 - val_accuracy: 0.7951
Epoch 24/50
20031/20031 - 4s - loss: 0.0307 - accuracy: 0.9872 - val_loss: 1.6964 - val_accuracy: 0.7953
Epoch 25/50
20031/20031 - 4s - loss: 0.0283 - accuracy: 0.9893 - val_loss: 1.6917 - val_accuracy: 0.7920
Epoch 26/50
20031/20031 - 4s - loss: 0.0365 - accuracy: 0.9850 - val_loss: 1.6935 - val_accuracy: 0.7944
Epoch 27/50
20031/20031 - 4s - loss: 0.0342 - accuracy: 0.9851 - val_loss: 1.7912 - val_accuracy: 0.7853
Epoch 28/50
20031/20031 - 4s - loss: 0.0301 - accuracy: 0.9879 - val_loss: 1.8194 - val_accuracy: 0.7887
Epoch 29/50
20031/20031 - 4s - loss: 0.0254 - accuracy: 0.9887 - val_loss: 1.9231 - val_accuracy: 0.7922
Epoch 30/50
20031/20031 - 4s - loss: 0.0216 - accuracy: 0.9910 - val_loss: 1.9480 - val_accuracy: 0.7914
Epoch 31/50
20031/20031 - 4s - loss: 0.0243 - accuracy: 0.9895 - val_loss: 1.9487 - val_accuracy: 0.7847
Epoch 32/50
20031/20031 - 4s - loss: 0.0241 - accuracy: 0.9891 - val_loss: 2.0333 - val_accuracy: 0.7893
Epoch 33/50
20031/20031 - 4s - loss: 0.0334 - accuracy: 0.9863 - val_loss: 1.9498 - val_accuracy: 0.7937
Epoch 34/50
20031/20031 - 4s - loss: 0.0318 - accuracy: 0.9873 - val_loss: 2.0181 - val_accuracy: 0.7942
Epoch 35/50
20031/20031 - 4s - loss: 0.0273 - accuracy: 0.9882 - val_loss: 2.0254 - val_accuracy: 0.7913
Epoch 36/50
20031/20031 - 4s - loss: 0.0236 - accuracy: 0.9897 - val_loss: 2.1159 - val_accuracy: 0.7937
Epoch 37/50
20031/20031 - 4s - loss: 0.0204 - accuracy: 0.9905 - val_loss: 2.1018 - val_accuracy: 0.7950
Epoch 38/50
20031/20031 - 4s - loss: 0.0187 - accuracy: 0.9916 - val_loss: 2.1939 - val_accuracy: 0.7947
Epoch 39/50
20031/20031 - 4s - loss: 0.0253 - accuracy: 0.9888 - val_loss: 2.2090 - val_accuracy: 0.7920
Epoch 40/50
20031/20031 - 4s - loss: 0.0270 - accuracy: 0.9889 - val_loss: 2.2737 - val_accuracy: 0.7862
Epoch 41/50
20031/20031 - 4s - loss: 0.0234 - accuracy: 0.9893 - val_loss: 2.2559 - val_accuracy: 0.7926
Epoch 42/50
20031/20031 - 4s - loss: 0.0223 - accuracy: 0.9902 - val_loss: 2.3223 - val_accuracy: 0.7884
Epoch 43/50
20031/20031 - 4s - loss: 0.0251 - accuracy: 0.9897 - val_loss: 2.2547 - val_accuracy: 0.7863
Epoch 44/50
20031/20031 - 4s - loss: 0.0209 - accuracy: 0.9900 - val_loss: 2.3917 - val_accuracy: 0.7823
Epoch 45/50
20031/20031 - 4s - loss: 0.0245 - accuracy: 0.9889 - val_loss: 2.4222 - val_accuracy: 0.7881
Epoch 46/50
20031/20031 - 4s - loss: 0.0215 - accuracy: 0.9901 - val_loss: 2.4135 - val_accuracy: 0.7869
Epoch 47/50
20031/20031 - 4s - loss: 0.0229 - accuracy: 0.9896 - val_loss: 2.3287 - val_accuracy: 0.7823
Epoch 48/50
20031/20031 - 4s - loss: 0.0191 - accuracy: 0.9918 - val_loss: 2.4639 - val_accuracy: 0.7845
Epoch 49/50
20031/20031 - 4s - loss: 0.0183 - accuracy: 0.9911 - val_loss: 2.6068 - val_accuracy: 0.7811
Epoch 50/50
20031/20031 - 4s - loss: 0.0229 - accuracy: 0.9897 - val_loss: 2.5152 - val_accuracy: 0.7928
2019-09-22 16:33:41,089 graeae.timers.timer end: Ended: 2019-09-22 16:33:41.089405
I0922 16:33:41.089459 139873020925760 timer.py:77] Ended: 2019-09-22 16:33:41.089405
2019-09-22 16:33:41,091 graeae.timers.timer end: Elapsed: 0:03:20.719519
I0922 16:33:41.091247 139873020925760 timer.py:78] Elapsed: 0:03:20.719519
</pre>
<p>Once again it looks like the model is overfitting, I should add a checkpoint or something.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org614419c">
<h3 id="org614419c">Plot the Performance</h3>
<div class="outline-text-3" id="text-org614419c">
<div class="highlight">
<pre><span></span>performance = pandas.DataFrame(history.history)
plot = performance.hvplot().opts(title="CNN Sarcasm Training Performance",
                                 width=1000,
                                 height=800)
Embed(plot=plot, file_name="cnn_training")()
</pre></div>
<object data="posts/keras/he-used-sarcasm/cnn_training.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>There's something very wrong with the validation. I'll have to look into that.</p>
<div class="highlight">
<pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org1c1493b">
<h2 id="org1c1493b">End</h2>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/keras/multi-layer-lstm/">Multi-Layer LSTM</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/keras/multi-layer-lstm/" rel="bookmark"><time class="published dt-published" datetime="2019-09-19T16:07:27-07:00" itemprop="datePublished" title="2019-09-19 16:07">2019-09-19 16:07</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/keras/multi-layer-lstm/#org485ff21">Beginning</a>
<ul>
<li><a href="posts/keras/multi-layer-lstm/#org13450af">Imports</a>
<ul>
<li><a href="posts/keras/multi-layer-lstm/#org6149368">Python</a></li>
<li><a href="posts/keras/multi-layer-lstm/#org92e8116">PyPi</a></li>
<li><a href="posts/keras/multi-layer-lstm/#org05d83e6">Others</a></li>
</ul>
</li>
<li><a href="posts/keras/multi-layer-lstm/#org74ca1ef">Set Up</a>
<ul>
<li><a href="posts/keras/multi-layer-lstm/#org59e7d08">The Timer</a></li>
<li><a href="posts/keras/multi-layer-lstm/#org13b5ba1">Plotting</a></li>
<li><a href="posts/keras/multi-layer-lstm/#org17f93b1">The Dataset</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/keras/multi-layer-lstm/#org37b0680">Middle</a>
<ul>
<li><a href="posts/keras/multi-layer-lstm/#org23cc260">Set Up the Datasets</a></li>
<li><a href="posts/keras/multi-layer-lstm/#org9f4f22b">The Model</a>
<ul>
<li><a href="posts/keras/multi-layer-lstm/#orgcfa9795">Embedding</a></li>
<li><a href="posts/keras/multi-layer-lstm/#orged0566f">Bidirectional</a></li>
<li><a href="posts/keras/multi-layer-lstm/#orgb45fd28">LSTM</a></li>
<li><a href="posts/keras/multi-layer-lstm/#orgc304783">Compile It</a></li>
</ul>
</li>
<li><a href="posts/keras/multi-layer-lstm/#org308a09e">Train the Model</a></li>
<li><a href="posts/keras/multi-layer-lstm/#orge5aabfd">Looking at the Performance</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org485ff21">
<h2 id="org485ff21">Beginning</h2>
<div class="outline-text-2" id="text-org485ff21"></div>
<div class="outline-3" id="outline-container-org13450af">
<h3 id="org13450af">Imports</h3>
<div class="outline-text-3" id="text-org13450af"></div>
<div class="outline-4" id="outline-container-org6149368">
<h4 id="org6149368">Python</h4>
<div class="outline-text-4" id="text-org6149368">
<div class="highlight">
<pre><span></span>from functools import partial
from pathlib import Path
import pickle
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org92e8116">
<h4 id="org92e8116">PyPi</h4>
<div class="outline-text-4" id="text-org92e8116">
<div class="highlight">
<pre><span></span>import holoviews
import hvplot.pandas
import pandas
import tensorflow
import tensorflow_datasets
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org05d83e6">
<h4 id="org05d83e6">Others</h4>
<div class="outline-text-4" id="text-org05d83e6">
<div class="highlight">
<pre><span></span>from graeae import Timer, EmbedHoloviews
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org74ca1ef">
<h3 id="org74ca1ef">Set Up</h3>
<div class="outline-text-3" id="text-org74ca1ef"></div>
<div class="outline-4" id="outline-container-org59e7d08">
<h4 id="org59e7d08">The Timer</h4>
<div class="outline-text-4" id="text-org59e7d08">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org13b5ba1">
<h4 id="org13b5ba1">Plotting</h4>
<div class="outline-text-4" id="text-org13b5ba1">
<div class="highlight">
<pre><span></span>Embed = partial(EmbedHoloviews,
                folder_path="../../files/posts/keras/multi-layer-lstm/")
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org17f93b1">
<h4 id="org17f93b1">The Dataset</h4>
<div class="outline-text-4" id="text-org17f93b1">
<p>This once again uses the <a href="https://www.tensorflow.org/datasets/catalog/imdb_reviews">IMDB dataset</a> with 50,000 reviews. It has already been converted from strings to integers - each word is encoded as its own integer. Adding <code>with_info=True</code> returns an object that contains the dictionary with the word to integer mapping. Passing in <code>imdb_reviews/subwords8k</code> limits the vocabulary to 8,000 words.</p>
<p><b>Note:</b> The first time you run this it will download a fairly large dataset so it might appear to hang, but after the first time it is fairly quick.</p>
<div class="highlight">
<pre><span></span>dataset, info = tensorflow_datasets.load("imdb_reviews/subwords8k",
                                         with_info=True,
                                         as_supervised=True)
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org37b0680">
<h2 id="org37b0680">Middle</h2>
<div class="outline-text-2" id="text-org37b0680"></div>
<div class="outline-3" id="outline-container-org23cc260">
<h3 id="org23cc260">Set Up the Datasets</h3>
<div class="outline-text-3" id="text-org23cc260">
<div class="highlight">
<pre><span></span>train_dataset, test_dataset = dataset["train"], dataset["test"]
tokenizer = info.features['text'].encoder
</pre></div>
<p>Now we're going to shuffle and padd the data. The <code>BUFFER_SIZE</code> argument sets the size of the data to sample from. In this case 10,000 entries in the training set will be selected to be put in the buffer and then the "shuffle" is created by randomly selecting items from the buffer, replacing each item as it's selected until all the data has been through the buffer. The <code>padded_batch</code> method creates batches of consecutive data and pads them so that they are all the same shape.</p>
<p>The BATCH_SIZE needs to be tuned a little. If it's too big the amount of memory needed might keep the GPU from being able to use it (and it might not generalize), and if it's too small, you will take a long time to train, so you have to do a little tuning. If you train it and the GPU process percentage stays at 0, try reducing the Batch Size.</p>
<p>Also note that if you change the batch-size you have to go back to the previous step and re-define <code>train_dataset</code> and <code>test_dataset</code> because we alter them in the next step and re-altering them makes the shape wrong somehow.</p>
<div class="highlight">
<pre><span></span>BUFFER_SIZE = 10000
# if the batch size is too big it will run out of memory on the GPU 
# so you might have to experiment with this
BATCH_SIZE = 32

train_dataset = train_dataset.shuffle(BUFFER_SIZE)
train_dataset = train_dataset.padded_batch(BATCH_SIZE, train_dataset.output_shapes)
test_dataset = test_dataset.padded_batch(BATCH_SIZE, test_dataset.output_shapes)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org9f4f22b">
<h3 id="org9f4f22b">The Model</h3>
<div class="outline-text-3" id="text-org9f4f22b">
<p>The previous model had one Bidirectional layer, this will add a second one.</p>
</div>
<div class="outline-4" id="outline-container-orgcfa9795">
<h4 id="orgcfa9795">Embedding</h4>
<div class="outline-text-4" id="text-orgcfa9795">
<p>The <a href="https://www.tensorflow.org/guide/embedding">Embedding layer</a> converts our inputs of integers and converts them to vectors of real-numbers, which is a better input for a neural network.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orged0566f">
<h4 id="orged0566f">Bidirectional</h4>
<div class="outline-text-4" id="text-orged0566f">
<p>The <a href="https://www.tensorflow.org/api_docs/python/tf/keras/layers/Bidirectional">Bidirectional layer</a> is a wrapper for Recurrent Neural Networks.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgb45fd28">
<h4 id="orgb45fd28">LSTM</h4>
<div class="outline-text-4" id="text-orgb45fd28">
<p>The <a href="https://www.tensorflow.org/versions/r2.0/api_docs/python/tf/keras/layers/LSTM">LSTM layer</a> implements Long-Short-Term Memory. The first argument is the size of the outputs. This is similar to the model that we ran previously on the same data, but it has an extra layer (so it uses more memory).</p>
<div class="highlight">
<pre><span></span>model = tensorflow.keras.Sequential([
    tensorflow.keras.layers.Embedding(tokenizer.vocab_size, 64),
    tensorflow.keras.layers.Bidirectional(
        tensorflow.keras.layers.LSTM(64, return_sequences=True)),
    tensorflow.keras.layers.Bidirectional(
        tensorflow.keras.layers.LSTM(32)),
    tensorflow.keras.layers.Dense(64, activation='relu'),
    tensorflow.keras.layers.Dense(1, activation='sigmoid')
])
</pre></div>
<div class="highlight">
<pre><span></span>print(model.summary())
</pre></div>
<pre class="example">
Model: "sequential"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
embedding (Embedding)        (None, None, 64)          523840    
_________________________________________________________________
bidirectional (Bidirectional (None, None, 128)         66048     
_________________________________________________________________
bidirectional_1 (Bidirection (None, 64)                41216     
_________________________________________________________________
dense (Dense)                (None, 64)                4160      
_________________________________________________________________
dense_1 (Dense)              (None, 1)                 65        
=================================================================
Total params: 635,329
Trainable params: 635,329
Non-trainable params: 0
_________________________________________________________________
None
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgc304783">
<h4 id="orgc304783">Compile It</h4>
<div class="outline-text-4" id="text-orgc304783">
<div class="highlight">
<pre><span></span>model.compile(loss='binary_crossentropy',
              optimizer="adam",
              metrics=['accuracy'])
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org308a09e">
<h3 id="org308a09e">Train the Model</h3>
<div class="outline-text-3" id="text-org308a09e">
<div class="highlight">
<pre><span></span>ONCE_PER_EPOCH = 2
NUM_EPOCHS = 10
with TIMER:
    history = model.fit(train_dataset,
                        epochs=NUM_EPOCHS,
                        validation_data=test_dataset,
                        verbose=ONCE_PER_EPOCH)
</pre></div>
<pre class="example">
2019-09-21 17:26:50,395 graeae.timers.timer start: Started: 2019-09-21 17:26:50.394797
I0921 17:26:50.395130 140275698915136 timer.py:70] Started: 2019-09-21 17:26:50.394797
Epoch 1/10
W0921 17:26:51.400280 140275698915136 deprecation.py:323] From /home/hades/.virtualenvs/In-Too-Deep/lib/python3.7/site-packages/tensorflow_core/python/ops/nn_impl.py:183: where (from tensorflow.python.ops.array_ops) is deprecated and will be removed in a future version.
Instructions for updating:
Use tf.where in 2.0, which has the same broadcast rule as np.where
782/782 - 224s - loss: 0.6486 - accuracy: 0.6039 - val_loss: 0.0000e+00 - val_accuracy: 0.0000e+00
Epoch 2/10
782/782 - 214s - loss: 0.4941 - accuracy: 0.7661 - val_loss: 0.6706 - val_accuracy: 0.6744
Epoch 3/10
782/782 - 216s - loss: 0.4087 - accuracy: 0.8266 - val_loss: 0.4024 - val_accuracy: 0.8222
Epoch 4/10
782/782 - 217s - loss: 0.2855 - accuracy: 0.8865 - val_loss: 0.3343 - val_accuracy: 0.8645
Epoch 5/10
782/782 - 216s - loss: 0.2097 - accuracy: 0.9217 - val_loss: 0.2936 - val_accuracy: 0.8837
Epoch 6/10
782/782 - 217s - loss: 0.1526 - accuracy: 0.9467 - val_loss: 0.3188 - val_accuracy: 0.8771
Epoch 7/10
782/782 - 215s - loss: 0.1048 - accuracy: 0.9657 - val_loss: 0.3750 - val_accuracy: 0.8710
Epoch 8/10
782/782 - 216s - loss: 0.0764 - accuracy: 0.9757 - val_loss: 0.3821 - val_accuracy: 0.8762
Epoch 9/10
782/782 - 216s - loss: 0.0585 - accuracy: 0.9832 - val_loss: 0.4747 - val_accuracy: 0.8683
Epoch 10/10
782/782 - 216s - loss: 0.0438 - accuracy: 0.9883 - val_loss: 0.4441 - val_accuracy: 0.8704
2019-09-21 18:02:56,353 graeae.timers.timer end: Ended: 2019-09-21 18:02:56.353722
I0921 18:02:56.353781 140275698915136 timer.py:77] Ended: 2019-09-21 18:02:56.353722
2019-09-21 18:02:56,356 graeae.timers.timer end: Elapsed: 0:36:05.958925
I0921 18:02:56.356238 140275698915136 timer.py:78] Elapsed: 0:36:05.958925
</pre></div>
</div>
<div class="outline-3" id="outline-container-orge5aabfd">
<h3 id="orge5aabfd">Looking at the Performance</h3>
<div class="outline-text-3" id="text-orge5aabfd">
<p>To get the history I had to pickle it and then copy it over to the machine with this org-notebook, so you can't just run this notebook and make it work unless everything is run on the same machine (which it wasn't).</p>
<div class="highlight">
<pre><span></span>path = Path("~/history.pkl").expanduser()
with path.open("wb") as writer:
    pickle.dump(history.history, writer)
</pre></div>
<div class="highlight">
<pre><span></span>path = Path("~/history.pkl").expanduser()
with path.open("rb") as reader:
    history = pickle.load(reader)
</pre></div>
<div class="highlight">
<pre><span></span>data = pandas.DataFrame(history)
best = data.val_loss.idxmin()
best_line = holoviews.VLine(best)
plot = (data.hvplot() * best_line).opts(
    title="Two-Layer LSTM Model",
    width=1000,
    height=800)
Embed(plot=plot, file_name="lstm_training")()
</pre></div>
<object data="posts/keras/multi-layer-lstm/lstm_training.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>It looks like the best epoch was the fifth one, with a validation loss of 0.29 and a validation accuracy of 0.88, after that it looks like it overfits. It seems that text might be a harder problem than images.</p>
</div>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-11.html" rel="prev">Newer posts</a></li>
<li class="next"><a href="index-9.html" rel="next">Older posts</a></li>
</ul>
<!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
